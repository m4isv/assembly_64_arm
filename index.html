<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
<!--Let browser know website is optimized for mobile-->
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
<link rel="stylesheet" href="base.min.css"/>
<link rel="stylesheet" href="fancy.min.css"/>
<link rel="stylesheet" href="main.css"/>
<script src="compatibility.min.js"></script>
<script src="theViewer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
      

<script>
try{
theViewer.defaultViewer = new theViewer.Viewer({});
}catch(e){}
</script>
<title>Assembly ARM 64 by M4isv</title>
<link rel="icon" type="image/x-icon" href="/tmux.jpg">
<meta name='twitter:description' content='livro de Assembly 64 ARM, So Entrar Pelo Chrome Para Traduzi' />
<meta name='twitter:image' content='https://i.postimg.cc/HW6JVw4L/tmux.jpg'/>


</head>
<body>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="alert.js"></script>

<div id="sidebar">
<div id="outline">
</div>
</div>
<div id="page-container">
<div id="pf1" class="pf w0 h0" data-page-no="1"><div class="pc pc1 w0 h0"><img class="bi x0 y0 w1 h1" alt="" src="bg1.png"/><div class="t m0 x1 h2 y1 ff1 fs0 fc0 sc0 ls0 ws0">TECHNOLOG<span class="_ _0"></span>Y IN AC<span class="_ _0"></span>TION<span class="_ _0"></span><span class="ls1 ws1">™</span></div><div class="t m0 x2 h3 y2 ff2 fs1 fc1 sc0 ls1 ws1">P<span class="_ _1"></span>rogr<span class="_ _1"></span>amming </div><div class="t m0 x2 h3 y3 ff2 fs1 fc1 sc0 ls1 ws1">with 64-Bit </div><div class="t m0 x2 h3 y4 ff2 fs1 fc1 sc0 ls1 ws1">ARM A<span class="_ _0"></span>ssembly </div><div class="t m0 x2 h3 y5 ff2 fs1 fc1 sc0 ls1 ws1">Language</div><div class="t m0 x3 h4 y6 ff3 fs2 fc0 sc0 ls2 ws2">Sing<span class="_ _0"></span>le<span class="_ _0"></span> B<span class="_ _0"></span>o<span class="_ _0"></span>ar<span class="_ _0"></span>d<span class="_ _0"></span> Co<span class="_ _0"></span>mpu<span class="_ _0"></span>ter<span class="_ _0"></span> D<span class="_ _0"></span>e<span class="_ _0"></span>velo<span class="_ _0"></span>pmen<span class="_ _0"></span>t<span class="_ _0"></span> </div><div class="t m0 x3 h4 y7 ff3 fs2 fc0 sc0 ls3 ws1">for Ra<span class="_ _1"></span>sp<span class="_ _1"></span>be<span class="_ _1"></span>r<span class="_ _0"></span>r<span class="_ _2"></span>y Pi a<span class="_ _1"></span>nd M<span class="_ _1"></span>ob<span class="_ _1"></span>i<span class="_ _1"></span>le D<span class="_ _3"></span>evi<span class="_ _1"></span>ces</div><div class="t m0 x3 h4 y8 ff3 fs2 fc0 sc0 ls1 ws1">—</div><div class="t m0 x3 h4 y9 ff3 fs2 fc0 sc0 ls1 ws1">Stephen Smith</div><div class="t m0 x4 h5 ya ff4 fs3 fc2 sc0 ls1 ws1">www.allitebooks.com</div><a class="l" href="http://www.allitebooks.org"><div class="d m1" style="border-style:none;position:absolute;left:167.000000px;bottom:3.000000px;width:105.000000px;height:14.000000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf2" class="pf w2 h6" data-page-no="2"><div class="pc pc2 w2 h6"><img class="bi x5 yb w3 h7" alt="" src="bg2.png"/><div class="t m0 x6 h8 yc ff5 fs4 fc3 sc0 ls1 ws1">Pr<span class="_ _3"></span>ogr<span class="_ _1"></span>amming with </div><div class="t m0 x7 h8 yd ff5 fs4 fc3 sc0 ls1 ws1">64-Bit ARM Assembly </div><div class="t m0 x8 h8 ye ff5 fs4 fc3 sc0 ls1 ws1">Langua<span class="_ _0"></span>ge</div><div class="t m0 x9 h9 yf ff5 fs5 fc4 sc0 ls1 ws1">Single Board Computer </div><div class="t m0 xa h9 y10 ff5 fs5 fc4 sc0 ls1 ws1">De<span class="_ _1"></span>v<span class="_ _1"></span>elopment f<span class="_ _1"></span>orRaspber<span class="_ _2"></span>r<span class="_ _2"></span>y Pi </div><div class="t m0 xb h9 y11 ff5 fs5 fc4 sc0 ls1 ws1">andMobile De<span class="_ _1"></span>vices</div><div class="t m0 xc ha y12 ff5 fs6 fc3 sc0 ls1 ws1">StephenSmith</div><div class="t m0 x4 h5 ya ff4 fs3 fc2 sc0 ls1 ws1">www.allitebooks.com</div><a class="l" href="http://www.allitebooks.org"><div class="d m1" style="border-style:none;position:absolute;left:167.000000px;bottom:3.000000px;width:105.000000px;height:14.000000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf3" class="pf w2 h6" data-page-no="3"><div class="pc pc3 w2 h6"><div class="t m0 xd hb y13 ff6 fs7 fc3 sc0 ls1 ws1">Prog<span class="_ _0"></span>ramming with 64-B<span class="_ _3"></span>it ARM Assembly Languag<span class="_ _0"></span>e: Single Board </div><div class="t m0 xd hb y14 ff6 fs7 fc3 sc0 ls1 ws1">Computer D<span class="_ _0"></span>evelopment for R<span class="_ _0"></span>aspberr<span class="_ _0"></span>y Pi and Mobile Devices</div><div class="t m0 xd hc y15 ff7 fs8 fc3 sc0 ls1 ws1">ISBN<span class="_ _1"></span>-13 (pbk): 978-1-4842-5880-4 <span class="_ _4"> </span> <span class="_ _5"> </span>ISBN<span class="_ _1"></span>-13 (electr<span class="_ _3"></span>onic): 978-1-4842-5881-1</div><div class="t m0 xd hc y16 ff7 fs8 fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1</div><div class="t m0 xd hd y17 ff7 fs7 fc3 sc0 ls1 ws1">Copyright © 2020 b<span class="_ _3"></span>y Stephen Smith </div><div class="t m0 xd hc y18 ff7 fs8 fc3 sc0 ls4 ws1">This work is subject to copyright<span class="_ _3"></span>. All rights are r<span class="_ _3"></span>eserved by the Publisher<span class="_ _1"></span>, whether the whole </div><div class="t m0 xd hc y19 ff7 fs8 fc3 sc0 ls4 ws1">or part of the material is concerned, specifically the rights of translation, r<span class="_ _1"></span>epr<span class="_ _0"></span>intin<span class="_ _3"></span>g, reuse of </div><div class="t m0 xd hc y1a ff7 fs8 fc3 sc0 ls4 ws1">illustrations<span class="_ _1"></span>, recitation, broadcasting, r<span class="_ _1"></span>eproduction on microfilms or in any other physical </div><div class="t m0 xd hc y1b ff7 fs8 fc3 sc0 ls4 ws1">way, and transmiss<span class="_ _3"></span>ion or information storage and r<span class="_ _3"></span>etrieval, electronic adaptation, com<span class="_ _3"></span>puter </div><div class="t m0 xd hc y1c ff7 fs8 fc3 sc0 ls4 ws1">software<span class="_ _3"></span>, or by similar or dissimilar methodology now known or her<span class="_ _3"></span>eafter developed.</div><div class="t m0 xd hc y1d ff7 fs8 fc3 sc0 ls1 ws1">Trademark<span class="_ _3"></span>ed names, logos<span class="_ _1"></span>, and images may appear in this book. Rather than use a </div><div class="t m0 xd hc y1e ff7 fs8 fc3 sc0 ls1 ws1">trademark s<span class="_ _3"></span>ymbol with every occur<span class="_ _0"></span>r<span class="_ _3"></span>ence of a trademark<span class="_ _3"></span>ed name, logo<span class="_ _1"></span>, or image we use the </div><div class="t m0 xd hc y1f ff7 fs8 fc3 sc0 ls1 ws1">names, logos<span class="_ _1"></span>, and images only in an editorial fashion and to the benefit of the trademark </div><div class="t m0 xd hc y20 ff7 fs8 fc3 sc0 ls1 ws1">owner<span class="_ _1"></span>, with no inten<span class="_ _3"></span>tion of infringement of the trademark<span class="_ _3"></span>.</div><div class="t m0 xd hc y21 ff7 fs8 fc3 sc0 ls1 ws1">The use in this publication of trade n<span class="_ _3"></span>ames, tr<span class="_ _3"></span>ademarks<span class="_ _3"></span>, service marks, and similar terms, </div><div class="t m0 xd hc y22 ff7 fs8 fc3 sc0 ls1 ws1">even if they are not identified as such<span class="_ _3"></span>, is not to be taken as an expression of opinion as to </div><div class="t m0 xd hc y23 ff7 fs8 fc3 sc0 ls1 ws1">whether or not they are subject to proprietary rights.</div><div class="t m0 xd hc y24 ff7 fs8 fc3 sc0 ls1 ws1">While the advice and information in this book are believed to be true and accurate a<span class="_ _3"></span>t the </div><div class="t m0 xd hc y25 ff7 fs8 fc3 sc0 ls1 ws1">date of publication, neither the a<span class="_ _3"></span>uthors nor the editors nor the publisher can accept any </div><div class="t m0 xd hc y26 ff7 fs8 fc3 sc0 ls1 ws1">legal responsibility for any err<span class="_ _3"></span>ors or omissions that m<span class="_ _3"></span>ay be made<span class="_ _3"></span>. The publisher makes no </div><div class="t m0 xd hc y27 ff7 fs8 fc3 sc0 ls1 ws1">warranty, expr<span class="_ _3"></span>ess or implied, with respect to the material contained her<span class="_ _3"></span>ein.</div><div class="t m0 xc hc y28 ff7 fs8 fc3 sc0 ls1 ws1">Man<span class="_ _3"></span>aging Director<span class="_ _6"></span>, Apr<span class="_ _3"></span>ess Media LLC: Welmoed S<span class="_ _3"></span>pahr</div><div class="t m0 xc hc y29 ff7 fs8 fc3 sc0 ls1 ws1">Acquisitions Editor: Aaron Black</div><div class="t m0 xc hc y2a ff7 fs8 fc3 sc0 ls1 ws1">Development Editor: James M<span class="_ _3"></span>arkham</div><div class="t m0 xc hc y2b ff7 fs8 fc3 sc0 ls1 ws1">Coordina<span class="_ _3"></span>ting Editor<span class="_ _0"></span>: J<span class="_ _3"></span>essica V<span class="_ _6"></span>akili</div><div class="t m0 xd hc y2c ff7 fs8 fc3 sc0 ls1 ws1">Distributed to the book trade worldwide by Springer Science+Business M<span class="_ _3"></span>edia NewY<span class="_ _6"></span>ork, </div><div class="t m0 xd hc y2d ff7 fs8 fc3 sc0 ls1 ws1">233 Spring Str<span class="_ _3"></span>eet, 6th Floor<span class="_ _6"></span>, NewY<span class="_ _6"></span>ork, NY 10013. Phone 1-800-SPRINGER, fax (201) </div><div class="t m0 xd hc y2e ff7 fs8 fc3 sc0 ls1 ws1">348-4505, e-mail orders<span class="_ _3"></span>-ny@springer<span class="_ _1"></span>-sbm.com, or visit www.springer<span class="_ _3"></span>online.com<span class="_ _3"></span>. Apr<span class="_ _3"></span>ess </div><div class="t m0 xd hc y2f ff7 fs8 fc3 sc0 ls1 ws1">Media, LLC is a C<span class="_ _3"></span>alifornia LLC and the sole member (o<span class="_ _3"></span>wner) is Springer Science + Business </div><div class="t m0 xd hc y30 ff7 fs8 fc3 sc0 ls1 ws1">Media Fin<span class="_ _3"></span>ance Inc (SSBM F<span class="_ _3"></span>inance Inc<span class="_ _1"></span>). SSBM Finance Inc is a <span class="ff8 ls5 ws3">Delaware</span> corpora<span class="_ _3"></span>tion.</div><div class="t m0 xd hc y31 ff7 fs8 fc3 sc0 ls6 ws1">For informa<span class="_ _3"></span>tion on translations<span class="_ _3"></span>, please e-mail rights@apr<span class="_ _3"></span>ess.com<span class="_ _3"></span>, or visit http://www.apr<span class="_ _3"></span>ess.</div><div class="t m0 xd hc y32 ff7 fs8 fc3 sc0 ls6 ws4">com/rights-<span class="_ _3"></span>permissions.</div><div class="t m0 xd hc y33 ff7 fs8 fc3 sc0 ls1 ws1">Apr<span class="_ _3"></span>ess titles may be pur<span class="_ _3"></span>chased in bulk for academic, corpor<span class="_ _3"></span>ate, or pr<span class="_ _3"></span>omotional use. eBook </div><div class="t m0 xd hc y34 ff7 fs8 fc3 sc0 ls1 ws1">versions and licenses are also a<span class="_ _3"></span>vailable for most titles<span class="_ _3"></span>. For mor<span class="_ _1"></span>e infor<span class="_ _0"></span>mation, r<span class="_ _1"></span>eference our </div><div class="t m0 xd hc y35 ff7 fs8 fc3 sc0 ls1 ws1">Print and eBook Bulk Sales web page at ht<span class="_ _3"></span>tp://www.apress<span class="_ _1"></span>.com/bulk-<span class="_ _1"></span>sales.</div><div class="t m0 xd hc y36 ff7 fs8 fc3 sc0 ls1 ws1">Any source code or other supplemen<span class="_ _3"></span>tary material referenced by the a<span class="_ _3"></span>uthor in this book is </div><div class="t m0 xd hc y37 ff7 fs8 fc3 sc0 ls1 ws1">availa<span class="_ _3"></span>ble to readers on GitH<span class="_ _1"></span>ub via the book’<span class="_ _1"></span>s product page, located at www.a<span class="_ _3"></span>press<span class="_ _3"></span>.com/ </div><div class="t m0 xd hc y38 ff7 fs8 fc3 sc0 ls1 ws1">978-1-4842-5880-4. For mor<span class="_ _1"></span>e detaile<span class="_ _0"></span>d information, please visit h<span class="_ _3"></span>ttp://www.apress<span class="_ _1"></span>.com/</div><div class="t m0 xd hc y39 ff7 fs8 fc3 sc0 ls1 ws1">source-code<span class="_ _3"></span>.</div><div class="t m0 xd hc y3a ff7 fs8 fc3 sc0 ls1 ws1">Printed on acid-free paper</div><div class="t m0 xd hc y3b ff7 fs8 fc3 sc0 ls1 ws1">StephenSmith</div><div class="t m0 xd hc y3c ff7 fs8 fc3 sc0 ls1 ws1">Gibsons, BC, Canada</div><div class="t m0 x4 h5 ya ff4 fs3 fc2 sc0 ls1 ws1">www.allitebooks.com</div><a class="l" href="https://doi.org/10.1007/978-1-4842-5881-1"><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:518.531000px;width:165.536000px;height:10.044000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="http://www.allitebooks.org"><div class="d m1" style="border-style:none;position:absolute;left:167.000000px;bottom:3.000000px;width:105.000000px;height:14.000000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf4" class="pf w2 h6" data-page-no="4"><div class="pc pc4 w2 h6"><div class="t m0 xe he y3d ff9 fs0 fc3 sc0 ls1 ws1">This book is dedicated to my beloved wife and  </div><div class="t m0 x1 he y3e ff9 fs0 fc3 sc0 ls1 ws1">editor Cathalyn<span class="_ _3"></span>n Labonté-<span class="_ _1"></span>Smith<span class="_ _3"></span>.</div><div class="t m0 x4 h5 ya ff4 fs3 fc2 sc0 ls1 ws1">www.allitebooks.com</div><a class="l" href="http://www.allitebooks.org"><div class="d m1" style="border-style:none;position:absolute;left:167.000000px;bottom:3.000000px;width:105.000000px;height:14.000000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf5" class="pf w2 h6" data-page-no="5"><div class="pc pc5 w2 h6"><div class="t m0 xf hd y3f ff7 fs7 fc3 sc0 ls1 ws1">v</div><div class="t m0 xc hf y40 ffa fs3 fc5 sc0 ls1 ws1">About the Author<span class="ws5"> ������������������������������������������������������������������������������<span class="_ _2"></span></span>xvii</div><div class="t m0 xc hf y41 ffa fs3 fc5 sc0 ls1 ws1">About the T<span class="_ _6"></span>echnical Reviewer<span class="ws6"> �����������������������������������������������������������<span class="_ _2"></span></span>xix</div><div class="t m0 xc hf y42 ffa fs3 fc5 sc0 ls1 ws1">Acknowledgments<span class="ws7"> �����������������������������������������������������������������������������<span class="_ _2"></span></span>xxi</div><div class="t m0 xc hf y43 ffa fs3 fc5 sc0 ls1 ws1">Introduction<span class="ws8"> �������������������������������������������������������������������������������������<span class="_ _2"></span></span>xxiii</div><div class="t m0 xc hf y44 ffa fs3 fc5 sc0 ls1 ws1">Chapter 1:<span class="fc6"> </span>Getting Started<span class="ws8"> ��������������������������������������������������������������������</span>1</div><div class="t m0 xa h10 y45 ffb fs7 fc5 sc0 ls1 ws1">The Surprise Birth of the 64-Bit <span class="_ _1"></span>ARM<span class="ws9"> ��������������������������������������������������������������������<span class="_ _7"></span></span>2</div><div class="t m0 xa h10 y46 ffb fs7 fc5 sc0 ls1 wsa">What Y<span class="_ _1"></span>ou Will <span class="_ _0"></span>Learn<span class="wsb"> ����������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">3</span></span></div><div class="t m0 xa h10 y47 ffb fs7 fc5 sc0 ls1 wsa">Why <span class="_ _0"></span>Use Assembly<span class="wsc"> ������������������������������������������������������������������������������������������������ <span class="ws1">3</span></span></div><div class="t m0 xa h10 y48 ffb fs7 fc5 sc0 ls1 wsa">T<span class="_ _6"></span>ools Y<span class="_ _1"></span>ou <span class="_ _0"></span>Need<span class="wsd"> ������������������������������������������������������������������������������������������������������ <span class="ws1">6</span></span></div><div class="t m0 x10 h10 y49 ffb fs7 fc5 sc0 ls1 ws1">Raspberry Pi 4 or NVidia Jetson Nano<span class="wse"> �������������������������������������������������������������<span class="_ _7"></span></span>6</div><div class="t m0 x10 h10 y4a ffb fs7 fc5 sc0 ls1 ws1">T<span class="_ _6"></span>ext Editor<span class="wsf"> ��������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>7</div><div class="t m0 x10 h10 y4b ffb fs7 fc5 sc0 ls1 ws1">Specialty Programs<span class="ws10"> �����������������������������������������������������������������������������������������<span class="_ _2"></span></span>7</div><div class="t m0 xa h10 y4c ffb fs7 fc5 sc0 ls1 ws1">Computers and Numbers<span class="ws11"> ��������������������������������������������������������������������������������������<span class="_ _2"></span></span>8</div><div class="t m0 xa h10 y4d ffb fs7 fc5 sc0 ls1 wsa">ARM Assembly <span class="_ _0"></span>Instructions<span class="ws12"> ��������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">11</span></span></div><div class="t m0 x10 h10 y4e ffb fs7 fc5 sc0 ls1 ws1">CPU Registers<span class="ws13"> ������������������������������������������������������������������������������������������������ </span>12</div><div class="t m0 x10 h10 y4f ffb fs7 fc5 sc0 ls1 ws1">ARM Instruction Format<span class="ws14"> ���������������������������������������������������������������������������������<span class="_ _2"></span></span>13</div><div class="t m0 x10 h10 y50 ffb fs7 fc5 sc0 ls1 ws1">Computer Memory<span class="ws15"> �����������������������������������������������������������������������������������������<span class="_ _7"></span></span>16</div><div class="t m0 xa h10 y51 ffb fs7 fc5 sc0 ls1 ws1">About the GCC <span class="_ _1"></span>Assembler<span class="ws16"> �����������������������������������������������������������������������������������<span class="_ _7"></span></span>17</div><div class="t m0 xa h10 y52 ffb fs7 fc5 sc0 ls1 wsa">Hello World<span class="ws17"> ���������������������������������������������������������������������������������������������������������� <span class="ws1">18</span></span></div><div class="t m0 x10 h10 y53 ffb fs7 fc5 sc0 ls1 ws1">About Comments<span class="ws18"> �������������������������������������������������������������������������������������������<span class="_ _2"></span></span>20</div><div class="t m0 x10 h10 y54 ffb fs7 fc5 sc0 ls1 ws1">Where to Start<span class="ws19"> �����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>21</div><div class="t m0 xc h11 y55 ff5 fs9 fc3 sc0 ls1 ws1">T<span class="_ _8"></span>able of<span class="_ _9"></span> Contents</div><div class="t m0 x4 h5 ya ff4 fs3 fc2 sc0 ls1 ws1">www.allitebooks.com</div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:391.527000px;width:51.371000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:108.491000px;bottom:391.527000px;width:294.879000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf17" data-dest-detail='[23,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:372.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18" data-dest-detail='[24,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:353.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18" data-dest-detail='[24,"XYZ",53,282,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:334.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1b" data-dest-detail='[27,"XYZ",35,386,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:315.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1b" data-dest-detail='[27,"XYZ",35,212,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:297.910000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1c" data-dest-detail='[28,"XYZ",53,316,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:279.910000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1c" data-dest-detail='[28,"XYZ",53,188,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:261.910000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1d" data-dest-detail='[29,"XYZ",35,450,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:242.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf20" data-dest-detail='[32,"XYZ",53,488,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:223.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf21" data-dest-detail='[33,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:205.910000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf22" data-dest-detail='[34,"XYZ",53,268,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:187.910000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf25" data-dest-detail='[37,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:169.910000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf26" data-dest-detail='[38,"XYZ",53,392,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:150.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf27" data-dest-detail='[39,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:131.910000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf29" data-dest-detail='[41,"XYZ",35,240,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:113.910000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2a" data-dest-detail='[42,"XYZ",53,370,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:95.910400px;width:325.370000px;height:12.836600px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf10" data-dest-detail='[16,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:52.363900px;bottom:492.469000px;width:351.711100px;height:15.709000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11" data-dest-detail='[17,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:52.363900px;bottom:469.778000px;width:354.329100px;height:13.090000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12" data-dest-detail='[18,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:52.363900px;bottom:446.214000px;width:352.583100px;height:14.836000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13" data-dest-detail='[19,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:52.363900px;bottom:426.141000px;width:353.456100px;height:12.218000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="http://www.allitebooks.org"><div class="d m1" style="border-style:none;position:absolute;left:167.000000px;bottom:3.000000px;width:105.000000px;height:14.000000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf6" class="pf w2 h6" data-page-no="6"><div class="pc pc6 w2 h6"><div class="t m0 xd hd y3f ff7 fs7 fc3 sc0 ls1 ws1">vi</div><div class="t m0 x7 h10 y56 ffb fs7 fc5 sc0 ls1 ws1">Assembly Instructions<span class="ws1a"> �����������������������������������������������������������������������������������<span class="_ _2"></span></span>22</div><div class="t m0 x7 h10 y57 ffb fs7 fc5 sc0 ls1 ws1">Data<span class="ws1b"> ���������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>22</div><div class="t m0 x7 h10 y58 ffb fs7 fc5 sc0 ls1 ws1">Calling Linux<span class="ws1c"> ��������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>23</div><div class="t m0 x7 h10 y59 ffb fs7 fc5 sc0 ls1 ws1">Reverse Engineering Our Program<span class="ws1d"> ����������������������������������������������������������������<span class="_ _2"></span></span>24</div><div class="t m0 x11 h10 y5a ffb fs7 fc5 sc0 ls1 ws1">Summary�������������������������������������������������������������������������������������������������������������<span class="_ _2"></span>26</div><div class="t m0 x11 h10 y5b ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>27</div><div class="t m0 xd hf y5c ffa fs3 fc5 sc0 ls1 ws1">Chapter 2:<span class="fc6"> </span>Loading and Adding<span class="ws1f"> ����������������������������������������������������������</span>29</div><div class="t m0 x11 h10 y5d ffb fs7 fc5 sc0 ls1 ws1">Negative Numbers<span class="ws20"> ����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>29</div><div class="t m0 x7 h10 y5e ffb fs7 fc5 sc0 ls1 wsa">About T<span class="_ _6"></span>wo’<span class="_ _1"></span>s <span class="_ _0"></span>Complement<span class="ws21"> ������������������������������������������������������������������������������<span class="_ _7"></span><span class="ws1">29</span></span></div><div class="t m0 x7 h10 y5f ffb fs7 fc5 sc0 ls1 ws1">About Gnome Programmer’<span class="_ _3"></span>s Calculator<span class="ws22"> ��������������������������������������������������������<span class="_ _2"></span></span>31</div><div class="t m0 x7 h10 y60 ffb fs7 fc5 sc0 ls1 ws1">About One’<span class="_ _1"></span>s Complement<span class="ws23"> ������������������������������������������������������������������������������<span class="_ _7"></span></span>32</div><div class="t m0 x11 h10 y61 ffb fs7 fc5 sc0 ls1 ws1">Big vs� Little Endian<span class="ws24"> ��������������������������������������������������������������������������������������������<span class="_ _2"></span></span>33</div><div class="t m0 x7 h10 y62 ffb fs7 fc5 sc0 ls1 ws1">About Bi-endian<span class="wse"> ���������������������������������������������������������������������������������������������<span class="_ _2"></span></span>34</div><div class="t m0 x7 h10 y63 ffb fs7 fc5 sc0 ls1 ws1">Pros of Little Endian<span class="ws25"> ��������������������������������������������������������������������������������������<span class="_ _2"></span></span>34</div><div class="t m0 x11 h10 y64 ffb fs7 fc5 sc0 ls1 ws1">Shifting and Rotating<span class="ws26"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>35</div><div class="t m0 x7 h10 y65 ffb fs7 fc5 sc0 ls1 ws1">About Carry Flag<span class="ws27"> ��������������������������������������������������������������������������������������������<span class="_ _7"></span></span>36</div><div class="t m0 x7 h10 y66 ffb fs7 fc5 sc0 ls1 ws1">About the Barrel Shifter<span class="ws28"> ��������������������������������������������������������������������������������� </span>36</div><div class="t m0 x7 h10 y67 ffb fs7 fc5 sc0 ls1 ws1">Basics of Shifting and Rotating<span class="ws29"> ���������������������������������������������������������������������<span class="_ _2"></span></span>37</div><div class="t m0 x11 h10 y68 ffb fs7 fc5 sc0 ls1 ws1">Loading Registers<span class="ws2a"> �����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>38</div><div class="t m0 x7 h10 y69 ffb fs7 fc5 sc0 ls1 wsa">Instruction Aliases<span class="ws21"> �����������������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">39</span></span></div><div class="t m0 x7 h10 y6a ffb fs7 fc5 sc0 ls1 ws1">MOV/MO<span class="_ _1"></span>VK/MOVN<span class="ws2b"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>40</div><div class="t m0 x7 h10 y6b ffb fs7 fc5 sc0 ls1 ws1">About Operand2<span class="ws2c"> ���������������������������������������������������������������������������������������������<span class="_ _2"></span></span>42</div><div class="t m0 x7 h10 y6c ffb fs7 fc5 sc0 ls1 ws1">MOVN<span class="ws2d"> ������������������������������������������������������������������������������������������������������������� </span>45</div><div class="t m0 x7 h10 y6d ffb fs7 fc5 sc0 ls1 ws1">MOV Examples<span class="ws2e"> ����������������������������������������������������������������������������������������������� </span>46</div><div class="t m0 x11 h10 y6e ffb fs7 fc5 sc0 ls1 ws1">ADD/ADC<span class="ws2f"> �������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>50</div><div class="t m0 x7 h10 y6f ffb fs7 fc5 sc0 ls1 ws1">Add with Carry<span class="ws2e"> �����������������������������������������������������������������������������������������������<span class="_ _7"></span></span>52</div><div class="t m0 x11 h10 y70 ffb fs7 fc5 sc0 ls1 ws1">SUB/SBC��������������������������������������������������������������������������������������������������������������<span class="_ _2"></span>55</div><div class="t m0 xd h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf2b" data-dest-detail='[43,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:577.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2b" data-dest-detail='[43,"XYZ",35,272,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:559.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2c" data-dest-detail='[44,"XYZ",53,526,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:541.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2d" data-dest-detail='[45,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:523.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2f" data-dest-detail='[47,"XYZ",35,392,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:504.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf30" data-dest-detail='[48,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:485.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:461.528000px;width:51.371200px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:90.491100px;bottom:461.528000px;width:294.878900px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,343,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:442.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,165,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:424.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf33" data-dest-detail='[51,"XYZ",53,302,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:406.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf34" data-dest-detail='[52,"XYZ",35,232,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:388.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf35" data-dest-detail='[53,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:369.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf36" data-dest-detail='[54,"XYZ",35,361,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:351.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf36" data-dest-detail='[54,"XYZ",35,233,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:333.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf37" data-dest-detail='[55,"XYZ",53,317,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:314.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf38" data-dest-detail='[56,"XYZ",35,398,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:296.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf38" data-dest-detail='[56,"XYZ",35,222,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:278.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf39" data-dest-detail='[57,"XYZ",53,222,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:260.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf3a" data-dest-detail='[58,"XYZ",35,165,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:241.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf3b" data-dest-detail='[59,"XYZ",53,526,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:223.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf3c" data-dest-detail='[60,"XYZ",35,462,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:205.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf3e" data-dest-detail='[62,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:187.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf41" data-dest-detail='[65,"XYZ",53,414,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:169.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf42" data-dest-detail='[66,"XYZ",35,213,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:151.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf46" data-dest-detail='[70,"XYZ",35,536,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:132.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf48" data-dest-detail='[72,"XYZ",35,510,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:114.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4b" data-dest-detail='[75,"XYZ",53,184,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:95.911800px;width:339.870000px;height:12.837200px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf7" class="pf w2 h6" data-page-no="7"><div class="pc pc7 w2 h6"><div class="t m0 x12 hd y3f ff7 fs7 fc3 sc0 ls1 ws1">vii</div><div class="t m0 xa h10 y56 ffb fs7 fc5 sc0 ls1 ws1">Summary�������������������������������������������������������������������������������������������������������������<span class="_ _2"></span>56</div><div class="t m0 xa h10 y72 ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>56</div><div class="t m0 xc hf y73 ffa fs3 fc5 sc0 ls1 ws1">Chapter 3:<span class="fc6"> </span>T<span class="_ _6"></span>ooling Up��������������������������������������������������������������������������59</div><div class="t m0 xa h10 y74 ffb fs7 fc5 sc0 ls1 ws1">GNU Make<span class="ws30"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>59</div><div class="t m0 x10 h10 y75 ffb fs7 fc5 sc0 ls1 ws1">Rebuilding a File<span class="ws31"> �������������������������������������������������������������������������������������������� </span>60</div><div class="t m0 x10 h10 y76 ffb fs7 fc5 sc0 ls1 ws1">A Rule for Building �s Files�����������������������������������������������������������������������������<span class="_ _2"></span>61</div><div class="t m0 x10 h10 y77 ffb fs7 fc5 sc0 ls1 wsa">Defining Variables<span class="ws32"> ������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">61</span></span></div><div class="t m0 xa h10 y78 ffb fs7 fc5 sc0 ls1 ws1">GDB<span class="ws33"> ���������������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>62</div><div class="t m0 x10 h10 y79 ffb fs7 fc5 sc0 ls1 ws1">Preparing to Debug<span class="ws34"> ����������������������������������������������������������������������������������������<span class="_ _2"></span></span>63</div><div class="t m0 x10 h10 y7a ffb fs7 fc5 sc0 ls1 ws1">Beginning GDB<span class="ws35"> �����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>65</div><div class="t m0 xa h10 y7b ffb fs7 fc5 sc0 ls1 ws1">Cross-Compiling<span class="ws36"> ��������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>70</div><div class="t m0 x10 h10 y7c ffb fs7 fc5 sc0 ls1 ws1">Emulation<span class="ws37"> ������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>72</div><div class="t m0 xa h10 y7d ffb fs7 fc5 sc0 ls1 ws1">Android NDK<span class="ws38"> ��������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>72</div><div class="t m0 xa h10 y7e ffb fs7 fc5 sc0 ls1 ws1">Apple XCode<span class="ws39"> �������������������������������������������������������������������������������������������������������� </span>77</div><div class="t m0 xa h10 y7f ffb fs7 fc5 sc0 ls1 ws1">Source Control and Build Servers<span class="ws3a"> �����������������������������������������������������������������������<span class="_ _2"></span></span>82</div><div class="t m0 x10 h10 y80 ffb fs7 fc5 sc0 ls1 ws1">Git<span class="ws3b"> ������������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>82</div><div class="t m0 x10 h10 y81 ffb fs7 fc5 sc0 ls1 ws1">Jenkins<span class="ws3c"> ����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>83</div><div class="t m0 xa h10 y82 ffb fs7 fc5 sc0 ls1 ws1">Summary�������������������������������������������������������������������������������������������������������������<span class="_ _2"></span>84</div><div class="t m0 xa h10 y83 ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>84</div><div class="t m0 xc hf y84 ffa fs3 fc5 sc0 ls1 ws1">Chapter 4:<span class="fc6"> </span>Controlling Pr<span class="_ _3"></span>ogram Flow<span class="ws3d"> �������������������������������������������������</span>87</div><div class="t m0 xa h10 y85 ffb fs7 fc5 sc0 ls1 ws1">Unconditional Branch<span class="ws28"> ������������������������������������������������������������������������������������������ </span>87</div><div class="t m0 xa h10 y86 ffb fs7 fc5 sc0 ls1 ws1">About Condition Flags<span class="ws3e"> �����������������������������������������������������������������������������������������<span class="_ _2"></span></span>88</div><div class="t m0 xa h10 y87 ffb fs7 fc5 sc0 ls1 ws1">Branch on Condition<span class="ws32"> ��������������������������������������������������������������������������������������������<span class="_ _2"></span></span>90</div><div class="t m0 xa h10 y88 ffb fs7 fc5 sc0 ls1 ws1">About the CMP Instruction<span class="ws3f"> ����������������������������������������������������������������������������������<span class="_ _2"></span></span>90</div><div class="t m0 xa h10 y89 ffb fs7 fc5 sc0 ls1 ws1">Loops<span class="ws40"> ������������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>92</div><div class="t m0 x10 h10 y8a ffb fs7 fc5 sc0 ls1 ws1">FOR Loops<span class="ws41"> �����������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>92</div><div class="t m0 x10 h10 y8b ffb fs7 fc5 sc0 ls1 ws1">While Loops<span class="ws42"> ���������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>93</div><div class="t m0 x13 h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf4c" data-dest-detail='[76,"XYZ",35,504,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:577.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4c" data-dest-detail='[76,"XYZ",35,240,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:558.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:534.528000px;width:51.371000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:108.491000px;bottom:534.528000px;width:294.879000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,353,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:515.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4f" data-dest-detail='[79,"XYZ",35,299,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:497.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf50" data-dest-detail='[80,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:479.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf50" data-dest-detail='[80,"XYZ",53,181,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:461.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf51" data-dest-detail='[81,"XYZ",35,360,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:442.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf52" data-dest-detail='[82,"XYZ",53,502,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:424.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf54" data-dest-detail='[84,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:406.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf59" data-dest-detail='[89,"XYZ",35,306,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:387.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf5b" data-dest-detail='[91,"XYZ",35,510,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:369.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf5b" data-dest-detail='[91,"XYZ",35,200,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:350.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf60" data-dest-detail='[96,"XYZ",53,472,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:331.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf65" data-dest-detail='[101,"XYZ",35,478,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:312.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf65" data-dest-detail='[101,"XYZ",35,332,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:294.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf66" data-dest-detail='[102,"XYZ",53,339,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:276.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf67" data-dest-detail='[103,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:257.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf67" data-dest-detail='[103,"XYZ",35,218,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:238.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:214.528000px;width:51.371000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:108.491000px;bottom:214.528000px;width:294.879000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,176,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:195.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6a" data-dest-detail='[106,"XYZ",35,258,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:176.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6c" data-dest-detail='[108,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:157.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6c" data-dest-detail='[108,"XYZ",35,330,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:138.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6e" data-dest-detail='[110,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:119.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6e" data-dest-detail='[110,"XYZ",35,496,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:101.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6f" data-dest-detail='[111,"XYZ",53,409,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:83.911800px;width:325.370000px;height:12.837100px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf8" class="pf w2 h6" data-page-no="8"><div class="pc pc8 w2 h6"><div class="t m0 xd hd y3f ff7 fs7 fc3 sc0 ls1 ws1">viii</div><div class="t m0 x11 h10 y56 ffb fs7 fc5 sc0 ls1 ws1">If/Then/Else<span class="ws8"> ��������������������������������������������������������������������������������������������������������� </span>94</div><div class="t m0 x11 h10 y72 ffb fs7 fc5 sc0 ls1 ws1">Logical Operators<span class="ws17"> ������������������������������������������������������������������������������������������������ </span>95</div><div class="t m0 x7 h10 y8c ffb fs7 fc5 sc0 ls1 ws1">AND<span class="ws43"> ����������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>96</div><div class="t m0 x7 h10 y8d ffb fs7 fc5 sc0 ls1 ws1">EOR<span class="ws8"> ���������������������������������������������������������������������������������������������������������������� </span>96</div><div class="t m0 x7 h10 y5a ffb fs7 fc5 sc0 ls1 ws1">ORR<span class="wsf"> ����������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>96</div><div class="t m0 x7 h10 y8e ffb fs7 fc5 sc0 ls1 ws1">BIC<span class="ws44"> �����������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>97</div><div class="t m0 x11 h10 y8f ffb fs7 fc5 sc0 ls1 ws1">Design Patterns<span class="ws45"> ���������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>97</div><div class="t m0 x11 h10 y90 ffb fs7 fc5 sc0 ls1 ws1">Converting Integers to <span class="_ _1"></span>ASCII<span class="ws46"> �������������������������������������������������������������������������������<span class="_ _7"></span></span>98</div><div class="t m0 x7 h10 y91 ffb fs7 fc5 sc0 ls1 ws1">Using Expressions in Immediate Constants�������������������������������������������������<span class="_ _2"></span>102</div><div class="t m0 x7 h10 y92 ffb fs7 fc5 sc0 ls1 ws1">Storing a Register to Memory<span class="ws47"> ����������������������������������������������������������������������<span class="_ _7"></span></span>103</div><div class="t m0 x7 h10 y93 ffb fs7 fc5 sc0 ls1 ws1">Why Not Print in Decimal?<span class="ws28"> ��������������������������������������������������������������������������� </span>103</div><div class="t m0 x11 h10 y94 ffb fs7 fc5 sc0 ls1 ws1">Performance of Branch Instructions<span class="ws48"> �����������������������������������������������������������������<span class="_ _2"></span></span>104</div><div class="t m0 x11 h10 y95 ffb fs7 fc5 sc0 ls1 ws1">More Comparison Instructions<span class="ws49"> �������������������������������������������������������������������������� </span>105</div><div class="t m0 x11 h10 y96 ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>106</div><div class="t m0 x11 h10 y97 ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>106</div><div class="t m0 xd hf y98 ffa fs3 fc5 sc0 ls1 ws1">Chapter 5:<span class="fc6"> </span>Thanks for the Memories<span class="ws4a"> ������������������������������������������������</span>109</div><div class="t m0 x11 h10 y99 ffb fs7 fc5 sc0 ls1 ws1">Defining Memory Contents<span class="ws4b"> �������������������������������������������������������������������������������<span class="_ _7"></span></span>110</div><div class="t m0 x7 h10 y9a ffb fs7 fc5 sc0 ls1 ws1">Aligning Data<span class="ws4c"> �����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>114</div><div class="t m0 x11 h10 y9b ffb fs7 fc5 sc0 ls1 ws1">Loading a Register with an <span class="_ _1"></span>Address<span class="ws12"> �����������������������������������������������������������������<span class="_ _2"></span></span>114</div><div class="t m0 x7 h10 y9c ffb fs7 fc5 sc0 ls1 wsa">PC <span class="_ _0"></span>Relative Addressing<span class="ws32"> ��������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">115</span></span></div><div class="t m0 x11 h10 y9d ffb fs7 fc5 sc0 ls1 ws1">Loading Data from Memory<span class="ws4d"> ������������������������������������������������������������������������������<span class="_ _7"></span></span>117</div><div class="t m0 x7 h10 y9e ffb fs7 fc5 sc0 ls1 wsa">Indexing Through <span class="_ _0"></span>Memory<span class="ws4e"> ���������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">119</span></span></div><div class="t m0 x11 h10 y9f ffb fs7 fc5 sc0 ls1 ws1">Storing a Register<span class="ws29"> ���������������������������������������������������������������������������������������������<span class="_ _2"></span></span>131</div><div class="t m0 x11 h10 ya0 ffb fs7 fc5 sc0 ls1 ws1">Double Registers<span class="ws4f"> ����������������������������������������������������������������������������������������������� </span>131</div><div class="t m0 x11 h10 ya1 ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>132</div><div class="t m0 x11 h10 ya2 ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>133</div><div class="t m0 xd h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf70" data-dest-detail='[112,"XYZ",35,505,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:577.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf71" data-dest-detail='[113,"XYZ",53,288,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:558.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf72" data-dest-detail='[114,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:540.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf72" data-dest-detail='[114,"XYZ",35,327,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:522.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf72" data-dest-detail='[114,"XYZ",35,231,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:504.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf73" data-dest-detail='[115,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:486.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf73" data-dest-detail='[115,"XYZ",53,270,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:467.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf74" data-dest-detail='[116,"XYZ",35,383,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:448.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf78" data-dest-detail='[120,"XYZ",35,293,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:430.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf79" data-dest-detail='[121,"XYZ",53,510,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:412.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf79" data-dest-detail='[121,"XYZ",53,310,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:394.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7a" data-dest-detail='[122,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:375.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7b" data-dest-detail='[123,"XYZ",53,456,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:356.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7c" data-dest-detail='[124,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:337.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7c" data-dest-detail='[124,"XYZ",35,394,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:318.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:294.528000px;width:51.371200px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:90.491100px;bottom:294.528000px;width:294.878900px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7f" data-dest-detail='[127,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:275.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf83" data-dest-detail='[131,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:257.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf83" data-dest-detail='[131,"XYZ",35,204,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:238.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf84" data-dest-detail='[132,"XYZ",53,510,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:220.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf86" data-dest-detail='[134,"XYZ",53,172,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:201.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf88" data-dest-detail='[136,"XYZ",53,340,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:183.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf94" data-dest-detail='[148,"XYZ",53,392,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:164.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf94" data-dest-detail='[148,"XYZ",53,192,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:145.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf95" data-dest-detail='[149,"XYZ",35,348,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:126.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf96" data-dest-detail='[150,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:107.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf9" class="pf w2 h6" data-page-no="9"><div class="pc pc9 w2 h6"><div class="t m0 x14 hd y3f ff7 fs7 fc3 sc0 ls1 ws1">ix</div><div class="t m0 xc hf ya3 ffa fs3 fc5 sc0 ls1 ws1">Chapter 6:<span class="fc6"> </span>Functions and the Stack<span class="ws50"> �������������������������������������������������</span>135</div><div class="t m0 xa h10 ya4 ffb fs7 fc5 sc0 ls1 ws1">Stacks on Linux<span class="ws51"> �������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>136</div><div class="t m0 xa h10 ya5 ffb fs7 fc5 sc0 ls1 ws1">Branch with Link<span class="ws52"> �����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>138</div><div class="t m0 xa h10 ya6 ffb fs7 fc5 sc0 ls1 ws1">Nesting Function Calls<span class="ws53"> ��������������������������������������������������������������������������������������<span class="_ _2"></span></span>139</div><div class="t m0 xa h10 ya7 ffb fs7 fc5 sc0 ls1 ws1">Function Parameters and Return <span class="_ _1"></span>Values<span class="ws4e"> �����������������������������������������������������������<span class="_ _2"></span></span>141</div><div class="t m0 xa h10 ya8 ffb fs7 fc5 sc0 ls1 ws1">Managing the Registers<span class="ws54"> ������������������������������������������������������������������������������������<span class="_ _2"></span></span>142</div><div class="t m0 xa h10 ya9 ffb fs7 fc5 sc0 ls1 ws1">Summary of the Function Call Algorithm<span class="ws22"> ����������������������������������������������������������<span class="_ _2"></span></span>143</div><div class="t m0 xa h10 yaa ffb fs7 fc5 sc0 ls1 ws1">Upper<span class="_ _1"></span>-Case Revisited<span class="ws55"> ����������������������������������������������������������������������������������������<span class="_ _2"></span></span>144</div><div class="t m0 xa h10 yab ffb fs7 fc5 sc0 ls1 ws1">Stack Frames<span class="ws52"> ����������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>148</div><div class="t m0 x10 h10 yac ffb fs7 fc5 sc0 ls1 ws1">Stack Frame Example<span class="ws56"> ����������������������������������������������������������������������������������<span class="_ _2"></span></span>150</div><div class="t m0 xa h10 yad ffb fs7 fc5 sc0 ls1 ws1">Macros<span class="ws21"> ��������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>151</div><div class="t m0 x10 h10 yae ffb fs7 fc5 sc0 ls1 ws1">Include Directive<span class="ws57"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>154</div><div class="t m0 x10 h10 yaf ffb fs7 fc5 sc0 ls1 ws1">Macro Definition<span class="ws11"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>155</div><div class="t m0 x10 h10 yb0 ffb fs7 fc5 sc0 ls1 ws1">Labels<span class="ws58"> ����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>155</div><div class="t m0 x10 h10 yb1 ffb fs7 fc5 sc0 ls1 ws1">Why Macros?<span class="ws59"> ����������������������������������������������������������������������������������������������� </span>156</div><div class="t m0 x10 h10 yb2 ffb fs7 fc5 sc0 ls1 ws1">Macros to Improve Code<span class="ws5a"> ������������������������������������������������������������������������������<span class="_ _2"></span></span>157</div><div class="t m0 xa h10 yb3 ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>158</div><div class="t m0 xa h10 yb4 ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>158</div><div class="t m0 xc hf yb5 ffa fs3 fc5 sc0 ls1 ws1">Chapter 7:<span class="fc6"> </span>Linux Operating System Services<span class="ws5b"> �����������������������������������</span>161</div><div class="t m0 xa h10 yb6 ffb fs7 fc5 sc0 ls1 ws1">So Many Services<span class="ws20"> ���������������������������������������������������������������������������������������������<span class="_ _7"></span></span>161</div><div class="t m0 xa h10 yb7 ffb fs7 fc5 sc0 ls1 ws1">Calling Convention<span class="ws29"> ��������������������������������������������������������������������������������������������<span class="_ _2"></span></span>162</div><div class="t m0 x10 h10 yb8 ffb fs7 fc5 sc0 ls1 ws1">Linux System Call Numbers<span class="ws5c"> �������������������������������������������������������������������������<span class="_ _2"></span></span>163</div><div class="t m0 x10 h10 yb9 ffb fs7 fc5 sc0 ls1 ws1">Return Codes<span class="ws5d"> ����������������������������������������������������������������������������������������������� </span>163</div><div class="t m0 x10 h10 yba ffb fs7 fc5 sc0 ls1 ws1">Structures<span class="ws39"> ���������������������������������������������������������������������������������������������������� </span>164</div><div class="t m0 xa h10 ybb ffb fs7 fc5 sc0 ls1 ws1">Wrappers<span class="ws14"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>165</div><div class="t m0 xa h10 ybc ffb fs7 fc5 sc0 ls1 ws1">Converting a File to Upper<span class="_ _1"></span>-Case<span class="ws5e"> �����������������������������������������������������������������������<span class="_ _2"></span></span>166</div><div class="t m0 x13 h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:576.814000px;width:51.371000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:108.491000px;bottom:576.814000px;width:294.879000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf98" data-dest-detail='[152,"XYZ",35,504,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:558.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf9a" data-dest-detail='[154,"XYZ",35,225,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:539.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf9b" data-dest-detail='[155,"XYZ",53,172,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:520.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf9d" data-dest-detail='[157,"XYZ",53,408,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:501.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf9e" data-dest-detail='[158,"XYZ",35,408,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:482.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf9f" data-dest-detail='[159,"XYZ",53,450,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:463.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfa0" data-dest-detail='[160,"XYZ",35,379,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:444.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfa4" data-dest-detail='[164,"XYZ",35,472,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:425.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfa6" data-dest-detail='[166,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:407.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfa7" data-dest-detail='[167,"XYZ",53,320,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:388.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfaa" data-dest-detail='[170,"XYZ",35,302,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:370.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfab" data-dest-detail='[171,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:352.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfab" data-dest-detail='[171,"XYZ",53,338,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:334.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfac" data-dest-detail='[172,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:316.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfad" data-dest-detail='[173,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:298.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfae" data-dest-detail='[174,"XYZ",35,464,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:279.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfae" data-dest-detail='[174,"XYZ",35,248,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:260.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb0" data-dest-detail='[176,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:235.814000px;width:51.371000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb0" data-dest-detail='[176,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:108.491000px;bottom:235.814000px;width:294.879000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb0" data-dest-detail='[176,"XYZ",53,228,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:217.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb1" data-dest-detail='[177,"XYZ",35,424,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:198.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb2" data-dest-detail='[178,"XYZ",53,446,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:180.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb2" data-dest-detail='[178,"XYZ",53,190,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:162.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb3" data-dest-detail='[179,"XYZ",35,366,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:144.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb4" data-dest-detail='[180,"XYZ",53,336,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:125.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb5" data-dest-detail='[181,"XYZ",35,536,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:106.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa" class="pf w2 h6" data-page-no="a"><div class="pc pca w2 h6"><div class="t m0 xd hd y3f ff7 fs7 fc3 sc0 ls1 ws1">x</div><div class="t m0 x7 h10 y56 ffb fs7 fc5 sc0 ls1 ws1">Building �S Files<span class="ws5f"> �������������������������������������������������������������������������������������������<span class="_ _2"></span></span>170</div><div class="t m0 x7 h10 y57 ffb fs7 fc5 sc0 ls1 ws1">Opening a File<span class="ws34"> ����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>172</div><div class="t m0 x7 h10 y58 ffb fs7 fc5 sc0 ls1 ws1">Error Checking<span class="ws9"> ��������������������������������������������������������������������������������������������� </span>172</div><div class="t m0 x7 h10 y59 ffb fs7 fc5 sc0 ls1 ws1">Looping<span class="ws2d"> �������������������������������������������������������������������������������������������������������� </span>174</div><div class="t m0 x11 h10 y5a ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>175</div><div class="t m0 x11 h10 y5b ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>176</div><div class="t m0 xd hf y5c ffa fs3 fc5 sc0 ls1 ws1">Chapter 8:<span class="fc6"> </span>Progr<span class="_ _3"></span>amming GPIO Pins<span class="ws60"> ��������������������������������������������������</span>177</div><div class="t m0 x11 h10 y5d ffb fs7 fc5 sc0 ls1 ws1">GPIO Overview<span class="ws37"> ��������������������������������������������������������������������������������������������������<span class="_ _7"></span></span>177</div><div class="t m0 x11 h10 ybd ffb fs7 fc5 sc0 ls1 ws1">In Linux,<span class="_ _1"></span> Ever<span class="_ _0"></span>ything Is a File<span class="ws30"> �����������������������������������������������������������������������������<span class="_ _2"></span></span>178</div><div class="t m0 x11 h10 ybe ffb fs7 fc5 sc0 ls1 ws1">Flashing LEDs<span class="ws61"> ���������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>179</div><div class="t m0 x11 h10 ybf ffb fs7 fc5 sc0 ls1 ws1">Moving Closer to the Metal<span class="ws62"> �������������������������������������������������������������������������������<span class="_ _2"></span></span>185</div><div class="t m0 x11 h10 yc0 ffb fs7 fc5 sc0 ls1 ws1">Virtual Memory<span class="ws63"> ��������������������������������������������������������������������������������������������������<span class="_ _7"></span></span>185</div><div class="t m0 x11 h10 yc1 ffb fs7 fc5 sc0 ls1 ws1">In Devices,<span class="_ _1"></span> Ever<span class="_ _0"></span>ything Is Memory<span class="ws17"> ��������������������������������������������������������������������� </span>186</div><div class="t m0 x11 h10 yc2 ffb fs7 fc5 sc0 ls1 ws1">Registers in Bits<span class="ws64"> ������������������������������������������������������������������������������������������������ </span>188</div><div class="t m0 x7 h10 yc3 ffb fs7 fc5 sc0 ls1 ws1">GPIO Function Select Registers<span class="ws65"> �������������������������������������������������������������������<span class="_ _2"></span></span>189</div><div class="t m0 x7 h10 yc4 ffb fs7 fc5 sc0 ls1 ws1">GPIO Output Set and Clear Registers<span class="ws66"> �����������������������������������������������������������<span class="_ _2"></span></span>190</div><div class="t m0 x11 h10 yc5 ffb fs7 fc5 sc0 ls1 ws1">More Flashing LEDs<span class="ws67"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>191</div><div class="t m0 x7 h10 yc6 ffb fs7 fc5 sc0 ls1 wsa">Root Access<span class="ws68"> �������������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">197</span></span></div><div class="t m0 x7 h10 yc7 ffb fs7 fc5 sc0 ls1 ws1">T<span class="_ _6"></span>able Driven<span class="ws69"> �������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>197</div><div class="t m0 x7 h10 yc8 ffb fs7 fc5 sc0 ls1 ws1">Setting Pin Direction<span class="ws2e"> ������������������������������������������������������������������������������������ </span>198</div><div class="t m0 x7 h10 yc9 ffb fs7 fc5 sc0 ls1 ws1">Setting and Clearing Pins<span class="ws6a"> ����������������������������������������������������������������������������<span class="_ _2"></span></span>199</div><div class="t m0 x11 h10 yca ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>200</div><div class="t m0 x11 h10 ycb ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>201</div><div class="t m0 xd hf ycc ffa fs3 fc5 sc0 ls1 ws1">Chapter 9:<span class="fc6"> </span>Interacting with C and Python<span class="ws6b"> ����������������������������������������</span>203</div><div class="t m0 x11 h10 ycd ffb fs7 fc5 sc0 ls1 ws1">Calling C Routines<span class="ws6c"> ��������������������������������������������������������������������������������������������� </span>203</div><div class="t m0 x7 h10 yce ffb fs7 fc5 sc0 ls1 ws1">Printing Debug Information<span class="ws6d"> �������������������������������������������������������������������������<span class="_ _2"></span></span>204</div><div class="t m0 x7 h10 ycf ffb fs7 fc5 sc0 ls1 ws1">Adding with Carry Revisited<span class="ws6e"> ������������������������������������������������������������������������<span class="_ _7"></span></span>209</div><div class="t m0 xd h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pfb9" data-dest-detail='[185,"XYZ",35,390,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:577.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbb" data-dest-detail='[187,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:559.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbb" data-dest-detail='[187,"XYZ",35,164,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:541.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbd" data-dest-detail='[189,"XYZ",35,174,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:523.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbe" data-dest-detail='[190,"XYZ",53,342,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:504.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbf" data-dest-detail='[191,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:485.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:461.528000px;width:51.371200px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:90.491100px;bottom:461.528000px;width:294.878900px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,228,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:442.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc1" data-dest-detail='[193,"XYZ",35,284,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:423.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc2" data-dest-detail='[194,"XYZ",53,154,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:404.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc8" data-dest-detail='[200,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:385.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc8" data-dest-detail='[200,"XYZ",53,241,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:366.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc9" data-dest-detail='[201,"XYZ",35,408,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:347.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfcb" data-dest-detail='[203,"XYZ",35,520,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:328.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfcc" data-dest-detail='[204,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:310.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfcd" data-dest-detail='[205,"XYZ",35,245,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:292.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfce" data-dest-detail='[206,"XYZ",53,314,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:273.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd4" data-dest-detail='[212,"XYZ",53,494,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:255.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd4" data-dest-detail='[212,"XYZ",53,158,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:237.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd5" data-dest-detail='[213,"XYZ",35,311,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:219.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd6" data-dest-detail='[214,"XYZ",53,214,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:201.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd7" data-dest-detail='[215,"XYZ",35,216,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:182.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd8" data-dest-detail='[216,"XYZ",53,434,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:163.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:139.528000px;width:51.371200px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:90.491100px;bottom:139.528000px;width:294.878900px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,164,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:120.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfda" data-dest-detail='[218,"XYZ",35,286,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:102.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfdf" data-dest-detail='[223,"XYZ",53,510,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:84.911800px;width:325.370000px;height:12.837100px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb" class="pf w2 h6" data-page-no="b"><div class="pc pcb w2 h6"><div class="t m0 x14 hd y3f ff7 fs7 fc3 sc0 ls7 ws6f">xi</div><div class="t m0 xa h10 y56 ffb fs7 fc5 sc0 ls1 ws1">Calling <span class="_ _1"></span>Assembly Routines from C<span class="ws48"> ��������������������������������������������������������������������<span class="_ _7"></span></span>211</div><div class="t m0 xa h10 y72 ffb fs7 fc5 sc0 ls1 ws1">Packaging Our Code<span class="ws70"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>213</div><div class="t m0 x10 h10 y8c ffb fs7 fc5 sc0 ls1 ws1">Static Library<span class="ws71"> �����������������������������������������������������������������������������������������������<span class="_ _2"></span></span>214</div><div class="t m0 x10 h10 y8d ffb fs7 fc5 sc0 ls1 ws1">Shared Library<span class="ws72"> ��������������������������������������������������������������������������������������������� </span>215</div><div class="t m0 xa h10 yd0 ffb fs7 fc5 sc0 ls1 ws1">Embedding <span class="_ _1"></span>Assembly Code Inside C Code<span class="ws73"> �������������������������������������������������������� </span>218</div><div class="t m0 xa h10 yd1 ffb fs7 fc5 sc0 ls1 ws1">Calling <span class="_ _1"></span>Assembly from Python<span class="ws74"> ��������������������������������������������������������������������������<span class="_ _7"></span></span>221</div><div class="t m0 xa h10 yd2 ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>223</div><div class="t m0 xa h10 yd3 ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>224</div><div class="t m0 xc hf yd4 ffa fs3 fc5 sc0 ls1 ws1">Chapter 10:<span class="fc6"> </span>Interfacing with Kotlin and Swift<span class="ws75"> ����������������������������������</span>225</div><div class="t m0 xa h10 yd5 ffb fs7 fc5 sc0 ls1 ws1">About Kotlin,<span class="_ _1"></span> Swift, and Ja<span class="_ _3"></span>va<span class="ws76"> ����������������������������������������������������������������������������<span class="_ _2"></span></span>225</div><div class="t m0 xa h10 yd6 ffb fs7 fc5 sc0 ls1 wsa">Creating <span class="_ _0"></span>an Android App<span class="ws19"> �����������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">226</span></span></div><div class="t m0 x10 h10 yd7 ffb fs7 fc5 sc0 ls1 ws1">Create the Project<span class="ws5f"> ���������������������������������������������������������������������������������������� </span>227</div><div class="t m0 x10 h10 yd8 ffb fs7 fc5 sc0 ls1 ws1">XML Screen Definition<span class="ws77"> ���������������������������������������������������������������������������������<span class="_ _2"></span></span>230</div><div class="t m0 x10 h10 yd9 ffb fs7 fc5 sc0 ls1 ws1">Kotlin Main Program<span class="ws78"> ������������������������������������������������������������������������������������ </span>233</div><div class="t m0 x10 h10 yda ffb fs7 fc5 sc0 ls1 wsa">The <span class="_ _0"></span>C++ Wrapper<span class="ws79"> ����������������������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">235</span></span></div><div class="t m0 x10 h10 ydb ffb fs7 fc5 sc0 ls1 ws1">Building the Project<span class="ws7a"> �������������������������������������������������������������������������������������<span class="_ _2"></span></span>236</div><div class="t m0 xa h10 ydc ffb fs7 fc5 sc0 ls1 ws1">Creating an iOS <span class="_ _1"></span>App<span class="ws7b"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>239</div><div class="t m0 x10 h10 ydd ffb fs7 fc5 sc0 ls1 ws1">Create the Project<span class="ws5f"> ���������������������������������������������������������������������������������������� </span>240</div><div class="t m0 x10 h10 yde ffb fs7 fc5 sc0 ls1 ws1">Adding Elements to the Main Storyboard<span class="ws7c"> ���������������������������������������������������� </span>240</div><div class="t m0 x10 h10 ydf ffb fs7 fc5 sc0 ls1 ws1">Adding Swift Code<span class="ws7d"> ���������������������������������������������������������������������������������������<span class="_ _2"></span></span>241</div><div class="t m0 x10 h10 ye0 ffb fs7 fc5 sc0 ls1 ws1">Adding our <span class="_ _1"></span>Assembly Language Routine<span class="ws7e"> ����������������������������������������������������� </span>244</div><div class="t m0 x10 h10 ye1 ffb fs7 fc5 sc0 ls1 ws1">Creating the Bridge<span class="ws7f"> ��������������������������������������������������������������������������������������<span class="_ _2"></span></span>245</div><div class="t m0 x10 h10 ye2 ffb fs7 fc5 sc0 ls1 ws1">Building and Running the Project<span class="ws80"> ����������������������������������������������������������������<span class="_ _2"></span></span>246</div><div class="t m0 xa h10 ye3 ffb fs7 fc5 sc0 ls1 ws1">Tips for Optimizing <span class="_ _1"></span>Apps<span class="ws33"> �����������������������������������������������������������������������������������<span class="_ _2"></span></span>247</div><div class="t m0 xa h10 ye4 ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>248</div><div class="t m0 xa h10 ye5 ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>248</div><div class="t m0 x13 h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pfe1" data-dest-detail='[225,"XYZ",53,368,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:577.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe3" data-dest-detail='[227,"XYZ",53,264,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:558.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe4" data-dest-detail='[228,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:540.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe5" data-dest-detail='[229,"XYZ",53,446,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:522.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe8" data-dest-detail='[232,"XYZ",35,504,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:503.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfeb" data-dest-detail='[235,"XYZ",53,312,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:484.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfed" data-dest-detail='[237,"XYZ",53,176,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:465.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfee" data-dest-detail='[238,"XYZ",35,458,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:446.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfef" data-dest-detail='[239,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:422.528000px;width:57.611000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfef" data-dest-detail='[239,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:114.731000px;bottom:422.528000px;width:288.639000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfef" data-dest-detail='[239,"XYZ",53,212,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:403.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff0" data-dest-detail='[240,"XYZ",35,520,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:384.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff1" data-dest-detail='[241,"XYZ",53,286,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:366.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff4" data-dest-detail='[244,"XYZ",35,174,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:348.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff7" data-dest-detail='[247,"XYZ",53,422,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:330.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff9" data-dest-detail='[249,"XYZ",53,414,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:312.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffa" data-dest-detail='[250,"XYZ",35,254,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:294.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffd" data-dest-detail='[253,"XYZ",53,536,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:275.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffe" data-dest-detail='[254,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:257.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffe" data-dest-detail='[254,"XYZ",35,280,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:239.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfff" data-dest-detail='[255,"XYZ",53,322,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:221.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf102" data-dest-detail='[258,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:203.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf103" data-dest-detail='[259,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:185.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf104" data-dest-detail='[260,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:167.912000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf105" data-dest-detail='[261,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:148.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf106" data-dest-detail='[262,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:129.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf106" data-dest-detail='[262,"XYZ",35,330,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:110.912000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc" class="pf w2 h6" data-page-no="c"><div class="pc pcc w2 h6"><div class="t m0 xd hd y3f ff7 fs7 fc3 sc0 ls1 ws1">xii</div><div class="t m0 xd hf ya3 ffa fs3 fc5 sc0 ls1 ws1">Chapter 11:<span class="fc6"> </span>Multiply<span class="_ _1"></span>,<span class="_ _1"></span> Divide,<span class="_ _1"></span> and Accumulate<span class="ws81"> ����������������������������������</span>249</div><div class="t m0 x11 h10 ya4 ffb fs7 fc5 sc0 ls1 ws1">Multiplication<span class="ws2f"> ����������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>249</div><div class="t m0 x7 h10 ye6 ffb fs7 fc5 sc0 ls1 ws1">Examples<span class="ws79"> �����������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>251</div><div class="t m0 x11 h10 ye7 ffb fs7 fc5 sc0 ls1 ws1">Division<span class="ws4d"> �������������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>255</div><div class="t m0 x7 h10 ye8 ffb fs7 fc5 sc0 ls1 ws1">Example<span class="ws82"> ������������������������������������������������������������������������������������������������������� </span>256</div><div class="t m0 x11 h10 ye9 ffb fs7 fc5 sc0 ls1 wsa">Multiply <span class="_ _0"></span>and Accumulate<span class="ws1">�����������������������������������������������������������������������������������<span class="_ _2"></span>258</span></div><div class="t m0 x7 h10 yea ffb fs7 fc5 sc0 ls1 ws1">Vectors and Matrices<span class="ws83"> ����������������������������������������������������������������������������������� </span>258</div><div class="t m0 x7 h10 yeb ffb fs7 fc5 sc0 ls1 ws1">Accumulate Instructions<span class="ws84"> ������������������������������������������������������������������������������<span class="_ _2"></span></span>260</div><div class="t m0 x7 h10 yec ffb fs7 fc5 sc0 ls1 ws1">Example 1<span class="ws82"> ���������������������������������������������������������������������������������������������������� </span>261</div><div class="t m0 x11 h10 yed ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>266</div><div class="t m0 x11 h10 yee ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>267</div><div class="t m0 xd hf yef ffa fs3 fc5 sc0 ls1 ws1">Chapter 12:<span class="fc6"> </span>Floating-P<span class="_ _1"></span>oint Operations<span class="ws85"> ���������������������������������������������</span>269</div><div class="t m0 x11 h10 yf0 ffb fs7 fc5 sc0 ls1 ws1">About Floating-Point Numbers<span class="ws86"> �������������������������������������������������������������������������� </span>269</div><div class="t m0 x7 h10 yf1 ffb fs7 fc5 sc0 ls1 ws1">About Normalization and NaNs<span class="ws87"> ��������������������������������������������������������������������<span class="_ _2"></span></span>271</div><div class="t m0 x7 h10 yf2 ffb fs7 fc5 sc0 ls1 ws1">Recognizing Rounding Errors<span class="ws48"> ����������������������������������������������������������������������<span class="_ _2"></span></span>271</div><div class="t m0 x11 h10 yf3 ffb fs7 fc5 sc0 ls1 ws1">Defining Floating-Point Numbers<span class="ws2d"> ���������������������������������������������������������������������� </span>272</div><div class="t m0 x11 h10 yf4 ffb fs7 fc5 sc0 ls1 ws1">About FPU Registers<span class="wsa"> �����������������������������������������������������������������������������������������<span class="_ _2"></span></span>273</div><div class="t m0 x11 h10 yf5 ffb fs7 fc5 sc0 ls1 ws1">Defining the Function Call Protocol<span class="ws88"> �������������������������������������������������������������������<span class="_ _2"></span></span>274</div><div class="t m0 x11 h10 yf6 ffb fs7 fc5 sc0 ls1 ws1">Loading and Saving FPU Registers<span class="ws16"> �������������������������������������������������������������������<span class="_ _2"></span></span>274</div><div class="t m0 x11 h10 yf7 ffb fs7 fc5 sc0 ls1 wsa">Performing <span class="_ _0"></span>Basic Arithmetic<span class="ws89"> �����������������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">276</span></span></div><div class="t m0 x11 h10 yf8 ffb fs7 fc5 sc0 ls1 ws1">Calculating Distance Between Points<span class="ws8a"> ���������������������������������������������������������������<span class="_ _2"></span></span>277</div><div class="t m0 x11 h10 yf9 ffb fs7 fc5 sc0 ls1 ws1">Performing Floating-Point Conversions<span class="ws8b"> ������������������������������������������������������������<span class="_ _2"></span></span>281</div><div class="t m0 x11 h10 yfa ffb fs7 fc5 sc0 ls1 ws1">Comparing Floating-Point Numbers<span class="ws2c"> ������������������������������������������������������������������<span class="_ _2"></span></span>282</div><div class="t m0 x7 h10 yfb ffb fs7 fc5 sc0 ls1 ws1">Example<span class="ws82"> ������������������������������������������������������������������������������������������������������� </span>283</div><div class="t m0 x11 h10 yfc ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>288</div><div class="t m0 x11 h10 yfd ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>288</div><div class="t m0 xd h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:576.814000px;width:57.611000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:96.731000px;bottom:576.814000px;width:288.639000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",53,292,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:558.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf109" data-dest-detail='[265,"XYZ",53,180,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:540.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf10d" data-dest-detail='[269,"XYZ",53,507,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:521.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf10e" data-dest-detail='[270,"XYZ",35,510,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:503.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf110" data-dest-detail='[272,"XYZ",35,536,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:484.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf110" data-dest-detail='[272,"XYZ",35,294,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:466.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf112" data-dest-detail='[274,"XYZ",35,462,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:448.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf113" data-dest-detail='[275,"XYZ",53,464,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:430.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf118" data-dest-detail='[280,"XYZ",35,213,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:411.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf119" data-dest-detail='[281,"XYZ",53,488,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:392.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:367.814000px;width:57.611000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:96.731000px;bottom:367.814000px;width:288.639000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,212,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:349.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11c" data-dest-detail='[284,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:331.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11c" data-dest-detail='[284,"XYZ",53,214,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:313.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11d" data-dest-detail='[285,"XYZ",35,389,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:294.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11e" data-dest-detail='[286,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:275.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11f" data-dest-detail='[287,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:256.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11f" data-dest-detail='[287,"XYZ",35,184,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:237.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf121" data-dest-detail='[289,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:218.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf122" data-dest-detail='[290,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:199.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf126" data-dest-detail='[294,"XYZ",53,379,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:180.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf127" data-dest-detail='[295,"XYZ",35,294,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:161.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf128" data-dest-detail='[296,"XYZ",53,338,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:143.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12d" data-dest-detail='[301,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:124.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12d" data-dest-detail='[301,"XYZ",35,224,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:105.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd" class="pf w2 h6" data-page-no="d"><div class="pc pcd w2 h6"><div class="t m0 x15 hd y3f ff7 fs7 fc3 sc0 ls1 ws1">xiii</div><div class="t m0 xc hf ya3 ffa fs3 fc5 sc0 ls1 ws1">Chapter 13:<span class="fc6"> </span>Neon Coprocessor<span class="ws8c"> ���������������������������������������������������������</span>291</div><div class="t m0 xa h10 ya4 ffb fs7 fc5 sc0 ls1 ws1">About the NEON Registers<span class="ws4b"> ��������������������������������������������������������������������������������<span class="_ _2"></span></span>291</div><div class="t m0 xa h10 ya5 ffb fs7 fc5 sc0 ls1 ws1">Stay in <span class="_ _1"></span>Y<span class="_ _1"></span>our Lane<span class="ws24"> ����������������������������������������������������������������������������������������������<span class="_ _7"></span></span>292</div><div class="t m0 xa h10 ya6 ffb fs7 fc5 sc0 ls1 wsa">Performing Arithmetic <span class="_ _0"></span>Operations<span class="ws7f"> ���������������������������������������������������������������������<span class="_ _2"></span><span class="ws1">294</span></span></div><div class="t m0 xa h10 ya7 ffb fs7 fc5 sc0 ls1 ws1">Calculating 4D <span class="_ _1"></span>Vector Distance<span class="ws8d"> �������������������������������������������������������������������������<span class="_ _2"></span></span>295</div><div class="t m0 xa h10 ya8 ffb fs7 fc5 sc0 ls1 ws1">Optimizing 3x3 Matrix Multiplication<span class="ws67"> ����������������������������������������������������������������<span class="_ _2"></span></span>300</div><div class="t m0 xa h10 ya9 ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>305</div><div class="t m0 xa h10 yaa ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>306</div><div class="t m0 xc hf yfe ffa fs3 fc5 sc0 ls1 ws1">Chapter 14:<span class="fc6"> </span>Optimizing Code<span class="ws8"> ������������������������������������������������������������</span>307</div><div class="t m0 xa h10 yff ffb fs7 fc5 sc0 ls1 ws1">Optimizing the Upper<span class="_ _1"></span>-Case Routine<span class="ws8e"> ������������������������������������������������������������������<span class="_ _2"></span></span>307</div><div class="t m0 x10 h10 y100 ffb fs7 fc5 sc0 ls1 ws1">Simplifying the Range Comparison<span class="ws8f"> �������������������������������������������������������������<span class="_ _2"></span></span>308</div><div class="t m0 x10 h10 y101 ffb fs7 fc5 sc0 ls1 ws1">Using a Conditional Instruction<span class="ws90"> ��������������������������������������������������������������������<span class="_ _2"></span></span>311</div><div class="t m0 x10 h10 y102 ffb fs7 fc5 sc0 ls1 ws1">Restricting the Problem Domain<span class="ws34"> ������������������������������������������������������������������<span class="_ _2"></span></span>314</div><div class="t m0 x10 h10 y103 ffb fs7 fc5 sc0 ls1 ws1">Using Parallelism with SIMD<span class="wsb"> �����������������������������������������������������������������������<span class="_ _2"></span></span>317</div><div class="t m0 xa h10 y104 ffb fs7 fc5 sc0 ls1 ws1">Tips for Optimizing Code<span class="ws91"> �����������������������������������������������������������������������������������<span class="_ _2"></span></span>321</div><div class="t m0 x10 h10 y105 ffb fs7 fc5 sc0 ls1 ws1">Avoiding Br<span class="_ _3"></span>anch Instructions<span class="ws92"> �����������������������������������������������������������������������<span class="_ _2"></span></span>321</div><div class="t m0 x10 h10 y106 ffb fs7 fc5 sc0 ls1 ws1">Avoiding Expensive Instructions<span class="ws93"> ������������������������������������������������������������������ </span>322</div><div class="t m0 x10 h10 y107 ffb fs7 fc5 sc0 ls1 ws1">Don’t Be <span class="_ _1"></span>Afraid of Macros<span class="ws51"> ����������������������������������������������������������������������������<span class="_ _2"></span></span>323</div><div class="t m0 x10 h10 y108 ffb fs7 fc5 sc0 ls1 ws1">Loop Unrolling<span class="ws94"> ���������������������������������������������������������������������������������������������<span class="_ _2"></span></span>323</div><div class="t m0 x10 h10 y109 ffb fs7 fc5 sc0 ls1 ws1">Keeping Data Small<span class="ws95"> �������������������������������������������������������������������������������������<span class="_ _2"></span></span>323</div><div class="t m0 x10 h10 y10a ffb fs7 fc5 sc0 ls1 ws1">Beware of Overheating<span class="ws96"> ��������������������������������������������������������������������������������<span class="_ _2"></span></span>323</div><div class="t m0 xa h10 y10b ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>324</div><div class="t m0 xa h10 y10c ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>324</div><div class="t m0 x13 h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:576.814000px;width:57.611000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:114.731000px;bottom:576.814000px;width:288.639000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,177,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:558.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf130" data-dest-detail='[304,"XYZ",35,225,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:539.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf132" data-dest-detail='[306,"XYZ",35,443,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:520.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf133" data-dest-detail='[307,"XYZ",53,397,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:501.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf138" data-dest-detail='[312,"XYZ",35,261,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:482.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13d" data-dest-detail='[317,"XYZ",53,313,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:463.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13e" data-dest-detail='[318,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:444.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:419.814000px;width:57.611000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:114.731000px;bottom:419.814000px;width:288.639000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,337,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:401.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf140" data-dest-detail='[320,"XYZ",35,438,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:383.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf143" data-dest-detail='[323,"XYZ",53,528,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:365.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf146" data-dest-detail='[326,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:347.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf149" data-dest-detail='[329,"XYZ",53,526,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:329.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14d" data-dest-detail='[333,"XYZ",53,374,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:310.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14d" data-dest-detail='[333,"XYZ",53,180,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:292.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14e" data-dest-detail='[334,"XYZ",35,284,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:274.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:256.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",53,482,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:238.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",53,354,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:220.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",53,210,null]'><div class="d m1" style="border-style:none;position:absolute;left:78.000000px;bottom:202.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf150" data-dest-detail='[336,"XYZ",35,472,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:183.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf150" data-dest-detail='[336,"XYZ",35,210,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.500000px;bottom:164.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe" class="pf w2 h6" data-page-no="e"><div class="pc pce w2 h6"><div class="t m0 xd hd y3f ff7 fs7 fc3 sc0 ls1 ws1">xiv</div><div class="t m0 xd hf ya3 ffa fs3 fc5 sc0 ls1 ws1">Chapter 15:<span class="fc6"> </span>Reading and Understanding Code<span class="ws97"> ���������������������������������</span>327</div><div class="t m0 x11 h10 ya4 ffb fs7 fc5 sc0 ls1 ws1">Browsing Linux and GCC Code<span class="ws98"> �������������������������������������������������������������������������� </span>328</div><div class="t m0 x7 h10 ye6 ffb fs7 fc5 sc0 ls1 ws1">Copying a Page of Memory<span class="ws45"> ��������������������������������������������������������������������������<span class="_ _2"></span></span>329</div><div class="t m0 x11 h10 ye7 ffb fs7 fc5 sc0 ls1 ws1">Code Created by GCC<span class="ws99"> ����������������������������������������������������������������������������������������<span class="_ _2"></span></span>335</div><div class="t m0 x7 h10 ye8 ffb fs7 fc5 sc0 ls1 ws1">Using the CBNZ and CBZ Instructions<span class="ws9a"> ����������������������������������������������������������<span class="_ _2"></span></span>340</div><div class="t m0 x11 h10 ye9 ffb fs7 fc5 sc0 ls1 ws1">Reverse Engineering and Ghidra<span class="ws9b"> �����������������������������������������������������������������������<span class="_ _2"></span></span>340</div><div class="t m0 x11 h10 y10d ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>345</div><div class="t m0 x11 h10 y10e ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>346</div><div class="t m0 xd hf y10f ffa fs3 fc5 sc0 ls1 ws1">Chapter 16:<span class="fc6"> </span>Hacking Code<span class="ws9c"> ����������������������������������������������������������������</span>347</div><div class="t m0 x11 h10 y110 ffb fs7 fc5 sc0 ls1 ws1">Buffer Overrun Hack<span class="ws37"> �����������������������������������������������������������������������������������������<span class="_ _2"></span></span>347</div><div class="t m0 x11 h10 y111 ffb fs7 fc5 sc0 ls1 ws1">Causes of Buffer Overrun<span class="ws78"> ���������������������������������������������������������������������������������� </span>347</div><div class="t m0 x11 h10 y112 ffb fs7 fc5 sc0 ls1 ws1">Stealing Credit Card Numbers<span class="ws47"> ���������������������������������������������������������������������������<span class="_ _2"></span></span>348</div><div class="t m0 x7 h10 y113 ffb fs7 fc5 sc0 ls1 ws1">Stepping <span class="_ _1"></span>Through the Stack<span class="ws3b"> ������������������������������������������������������������������������<span class="_ _2"></span></span>351</div><div class="t m0 x11 h10 y114 ffb fs7 fc5 sc0 ls1 ws1">Mitigating Buffer Overrun <span class="_ _1"></span>Vulnerabilities<span class="ws79"> ����������������������������������������������������������<span class="_ _2"></span></span>354</div><div class="t m0 x7 h10 y115 ffb fs7 fc5 sc0 ls1 ws1">Don’t Use strcpy<span class="ws9d"> ������������������������������������������������������������������������������������������<span class="_ _2"></span></span>355</div><div class="t m0 x7 h10 y116 ffb fs7 fc5 sc0 ls1 ws1">PIE Is Good<span class="ws56"> ���������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>357</div><div class="t m0 x7 h10 y117 ffb fs7 fc5 sc0 ls1 ws1">Poor Stack Canaries <span class="_ _1"></span>Are the First to Go<span class="ws47"> �������������������������������������������������������<span class="_ _2"></span></span>358</div><div class="t m0 x7 h10 y118 ffb fs7 fc5 sc0 ls1 ws1">Preventing Code Running on the Stack<span class="ws23"> �������������������������������������������������������<span class="_ _2"></span></span>362</div><div class="t m0 x11 h10 y119 ffb fs7 fc5 sc0 ls1 ws1">T<span class="_ _6"></span>rade-offs of Buffer Overflow Mitigation <span class="_ _1"></span>T<span class="_ _1"></span>echniques<span class="ws4f"> ���������������������������������������� </span>362</div><div class="t m0 x11 h10 y11a ffb fs7 fc5 sc0 ls1 ws1">Summary�����������������������������������������������������������������������������������������������������������<span class="_ _2"></span>364</div><div class="t m0 x11 h10 y11b ffb fs7 fc5 sc0 ls1 ws1">Exercises<span class="ws1e"> �����������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>365</div><div class="t m0 xd hf y11c ffa fs3 fc5 sc0 ls1 ws1">Appendix A: The ARM Instruction Set<span class="ws60"> �����������������������������������������������</span>367</div><div class="t m0 x11 h10 y11d ffb fs7 fc5 sc0 ls1 ws1">ARM 64-Bit Core Instructions<span class="ws9e"> ����������������������������������������������������������������������������<span class="_ _2"></span></span>367</div><div class="t m0 x11 h10 y11e ffb fs7 fc5 sc0 ls1 ws1">ARM 64-Bit NEON and FPU Instructions<span class="ws90"> ������������������������������������������������������������<span class="_ _2"></span></span>386</div><div class="t m0 xd h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:576.814000px;width:57.611000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:96.731000px;bottom:576.814000px;width:288.639000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf153" data-dest-detail='[339,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:558.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf154" data-dest-detail='[340,"XYZ",53,542,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:540.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15a" data-dest-detail='[346,"XYZ",53,504,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:521.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15f" data-dest-detail='[351,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:503.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15f" data-dest-detail='[351,"XYZ",35,188,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:484.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf164" data-dest-detail='[356,"XYZ",53,359,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:465.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf165" data-dest-detail='[357,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:446.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:36.000000px;bottom:421.814000px;width:57.611000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:96.731000px;bottom:421.814000px;width:288.639000px;height:14.460000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",53,311,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:403.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",53,183,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:384.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf167" data-dest-detail='[359,"XYZ",35,328,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:365.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16a" data-dest-detail='[362,"XYZ",53,387,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:347.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16d" data-dest-detail='[365,"XYZ",35,218,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:328.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16e" data-dest-detail='[366,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:310.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf170" data-dest-detail='[368,"XYZ",53,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:292.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf171" data-dest-detail='[369,"XYZ",35,232,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:274.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf175" data-dest-detail='[373,"XYZ",35,594,null]'><div class="d m1" style="border-style:none;position:absolute;left:60.000000px;bottom:256.198000px;width:325.370000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf175" data-dest-detail='[373,"XYZ",35,332,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:237.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf177" data-dest-detail='[375,"XYZ",35,344,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:218.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf178" data-dest-detail='[376,"XYZ",53,314,null]'><div class="d m1" style="border-style:none;position:absolute;left:45.500000px;bottom:199.198000px;width:339.870000px;height:12.837000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf17a" data-dest-detail='[378,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:34.036500px;bottom:172.176000px;width:352.583500px;height:16.582000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf17a" data-dest-detail='[378,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:43.636600px;bottom:154.722000px;width:343.856400px;height:13.963000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18d" data-dest-detail='[397,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:43.636600px;bottom:136.394000px;width:345.601400px;height:13.091000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff" class="pf w2 h6" data-page-no="f"><div class="pc pcf w2 h6"><div class="t m0 x16 hd y3f ff7 fs7 fc3 sc0 ls8 ws9f">xv</div><div class="t m0 xc hf ya3 ffa fs3 fc5 sc0 ls1 ws1">Appendix B: Binary Formats<span class="wsa0"> �������������������������������������������������������������</span>401</div><div class="t m0 xa h10 ya4 ffb fs7 fc5 sc0 ls1 ws1">Integers<span class="wsa1"> ������������������������������������������������������������������������������������������������������������� </span>401</div><div class="t m0 xa h10 ya5 ffb fs7 fc5 sc0 ls1 ws1">Floating Point<span class="ws58"> ����������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>402</div><div class="t m0 xa h10 ya6 ffb fs7 fc5 sc0 ls1 ws1">Addresses<span class="wsa2"> ���������������������������������������������������������������������������������������������������������<span class="_ _2"></span></span>403</div><div class="t m0 xc hf y11f ffa fs3 fc5 sc0 ls1 ws1">Appendix C: Assembler Directives<span class="wsa3"> ����������������������������������������������������<span class="_ _3"></span><span class="ws1">405</span></span></div><div class="t m0 xc hf y120 ffa fs3 fc5 sc0 ls1 ws1">Appendix D: ASCII Character Set<span class="wsa4"> ������������������������������������������������������</span>407</div><div class="t m0 xc hf y121 ffa fs3 fc5 sc0 ls1 ws1">Answers to Exer<span class="_ _1"></span>cises<span class="wsa5"> �����������������������������������������������������������������������</span>419</div><div class="t m0 xa h10 y122 ffb fs7 fc5 sc0 ls1 ws1">Chapter 1<span class="ws4b"> ����������������������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="wsa6"> 419</span></span></div><div class="t m0 xa h10 y123 ffb fs7 fc5 sc0 ls1 ws1">Chapter 2<span class="ws4b"> ����������������������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="wsa6"> 419</span></span></div><div class="t m0 xa h10 y124 ffb fs7 fc5 sc0 ls1 ws1">Chapter 5<span class="ws4b"> ����������������������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="wsa6"> 420</span></span></div><div class="t m0 xa h10 y125 ffb fs7 fc5 sc0 ls1 ws1">Chapter 6<span class="ws4b"> ����������������������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="wsa6"> 420</span></span></div><div class="t m0 xa h10 y126 ffb fs7 fc5 sc0 ls1 ws1">Chapter 8<span class="ws4b"> ����������������������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="wsa6"> 420</span></span></div><div class="t m0 xa h10 y127 ffb fs7 fc5 sc0 ls1 ws1">Chapter 14<span class="ws4b"> ��������������������������������������������������������������������������������������������������������<span class="_ _2"></span><span class="wsa6"> 421</span></span></div><div class="t m0 xc hf y128 ffa fs3 fc5 sc0 ls1 ws1">Index<span class="wsa7"> �������������������������������������������������������������������������������������������������</span>423</div><div class="t m0 x13 h12 y71 ffc fsa fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able of ConTenTs<span class="_ _a"></span>T<span class="_ _1"></span>able of ConTenTs</div><a class="l" href="#pf19b" data-dest-detail='[411,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:52.363900px;bottom:576.251000px;width:352.583100px;height:13.963000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19b" data-dest-detail='[411,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.091200px;bottom:557.051000px;width:343.855800px;height:13.091000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19c" data-dest-detail='[412,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.963900px;bottom:537.851000px;width:342.983100px;height:13.091000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19d" data-dest-detail='[413,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.091200px;bottom:521.269000px;width:342.983800px;height:11.345000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19e" data-dest-detail='[414,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:51.491100px;bottom:495.087000px;width:354.328900px;height:13.963000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1a0" data-dest-detail='[416,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:51.491100px;bottom:470.650000px;width:353.455900px;height:13.964000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ac" data-dest-detail='[428,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:51.491100px;bottom:447.959000px;width:354.328900px;height:13.964000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ac" data-dest-detail='[428,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.091200px;bottom:428.759000px;width:344.728800px;height:12.218000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ac" data-dest-detail='[428,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.963900px;bottom:409.559000px;width:342.983100px;height:13.091000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ad" data-dest-detail='[429,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.963900px;bottom:390.359000px;width:342.983100px;height:13.964000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ad" data-dest-detail='[429,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.091200px;bottom:372.032000px;width:343.855800px;height:12.218000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ad" data-dest-detail='[429,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.963900px;bottom:351.959000px;width:342.983100px;height:13.964000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ae" data-dest-detail='[430,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:61.963900px;bottom:332.759000px;width:342.983100px;height:13.091000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1af" data-dest-detail='[431,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:53.236600px;bottom:309.195000px;width:350.838400px;height:13.964000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf10" class="pf w2 h6" data-page-no="10"><div class="pc pc10 w2 h6"><img class="bi xc y129 w4 h13" alt="" src="bg10.png"/><div class="t m0 x17 hd y3f ff7 fs7 fc3 sc0 ls1 ws1">xvii</div><div class="t m0 xc h11 y12a ff5 fs9 fc3 sc0 ls1 ws1">About the A<span class="_ _6"></span>uthor</div><div class="t m0 x18 hd y12b ff8 fs7 fc3 sc0 ls9 ws1">Stephen Smith<span class="ff7">is also the author of the </span></div><div class="t m0 x18 hd y12c ff7 fs7 fc3 sc0 ls9 ws1">Apr<span class="_ _3"></span>ess title <span class="ff9">Raspberr<span class="_ _0"></span>y Pi As<span class="_ _3"></span>sembly Language </span></div><div class="t m0 x18 hd y12d ff9 fs7 fc3 sc0 ls9 wsa8">Programm<span class="_ _3"></span>ing<span class="ff7 ws1">. He is a r<span class="_ _1"></span>etired Software </span></div><div class="t m0 x18 hd y12e ff7 fs7 fc3 sc0 ls9 ws1">Architect, loc<span class="_ _3"></span>ated in Gibsons, BC, Canada<span class="_ _1"></span>. </div><div class="t m0 x18 hd y12f ff7 fs7 fc3 sc0 ls9 ws1">He<span class="_ _3"></span>’<span class="_ _6"></span>s been developing software since high </div><div class="t m0 x18 hd y130 ff7 fs7 fc3 sc0 ls9 ws1">school, or way too many y<span class="_ _3"></span>ears to recor<span class="_ _3"></span>d. He<span class="_ _3"></span> </div><div class="t m0 x18 hd y131 ff7 fs7 fc3 sc0 ls9 ws1">was the Chief Architect for the S<span class="_ _3"></span>age 300 line </div><div class="t m0 x18 hd y132 ff7 fs7 fc3 sc0 ls9 ws1">of accounting pr<span class="_ _3"></span>oducts for 23 years<span class="_ _3"></span>. Since </div><div class="t m0 x18 hd y133 ff7 fs7 fc3 sc0 ls9 ws1">retiring, he h<span class="_ _3"></span>as pursued artificial intelligence,<span class="_ _3"></span> </div><div class="t m0 x18 hd y134 ff7 fs7 fc3 sc0 ls9 wsa9">earned his Advanced HAM Radio License, and<span class="_ _3"></span> </div><div class="t m0 xc hd y135 ff7 fs7 fc3 sc0 ls9 ws1">enjoys mountain bik<span class="_ _3"></span>ing, hiking, and na<span class="_ _3"></span>tur<span class="_ _3"></span>e photograph<span class="_ _3"></span>y. He contin<span class="_ _3"></span>ues </div><div class="t m0 xc hd y136 ff7 fs7 fc3 sc0 ls9 ws1">to write his popular technology blog at smist08.wordpr<span class="_ _3"></span>ess.com and h<span class="_ _3"></span>as </div><div class="t m0 xc hd y137 ff7 fs7 fc3 sc0 ls9 ws1">written two science fiction novels in the <span class="ff9 wsa8">In<span class="_ _3"></span>fluence<span class="ff7 ws1"> series available on<span class="_ _3"></span> </span></span></div><div class="t m0 xc hd y138 ff7 fs7 fc3 sc0 ls9 ws1">Amazon.com<span class="_ _3"></span>.  </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf11" class="pf w2 h6" data-page-no="11"><div class="pc pc11 w2 h6"><img class="bi xc y139 w4 h14" alt="" src="bg11.png"/><div class="t m0 x19 hd y3f ff7 fs7 fc3 sc0 ls1 ws1">xix</div><div class="t m0 xc h11 y12a ff5 fs9 fc3 sc0 ls1 ws1">About the T<span class="_ _b"></span>echnical R<span class="_ _6"></span>e<span class="_ _1"></span>view<span class="_ _1"></span>er</div><div class="t m0 x18 hd y12b ff8 fs7 fc3 sc0 ls1 ws1">Stewart W<span class="_ _1"></span>atkiss<span class="ff7">is a keen m<span class="_ _3"></span>aker and </span></div><div class="t m0 x18 hd y12c ff7 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ammer<span class="_ _6"></span>. He has a m<span class="_ _3"></span>aster’<span class="_ _1"></span>s degree in </div><div class="t m0 x18 hd y12d ff7 fs7 fc3 sc0 ls1 ws1">electronic engineering fr<span class="_ _3"></span>om the University </div><div class="t m0 x18 hd y13a ff7 fs7 fc3 sc0 ls1 ws1">of H<span class="_ _3"></span>ull and a master’<span class="_ _6"></span>s de<span class="_ _0"></span>gr<span class="_ _3"></span>ee in computer </div><div class="t m0 x18 hd y13b ff7 fs7 fc3 sc0 ls1 ws1">science from Georgia Institute of T<span class="_ _6"></span>echnology.</div><div class="t m0 x1a hd y130 ff7 fs7 fc3 sc0 ls1 ws1">He has o<span class="_ _1"></span>ver 20 years of experience in the </div><div class="t m0 x18 hd y131 ff7 fs7 fc3 sc0 ls1 ws1">IT industr<span class="_ _0"></span>y, workin<span class="_ _3"></span>g in computer networking<span class="_ _3"></span>, </div><div class="t m0 x18 hd y132 ff7 fs7 fc3 sc0 ls1 ws1">Linux system administra<span class="_ _3"></span>tion, technical </div><div class="t m0 x18 hd y133 ff7 fs7 fc3 sc0 ls1 ws1">support, and cyber se<span class="_ _0"></span>curity. While working </div><div class="t m0 x18 hd y134 ff7 fs7 fc3 sc0 ls1 ws1">towar<span class="_ _3"></span>d Linux certification, he cr<span class="_ _3"></span>eated the web </div><div class="t m0 xc hd y135 ff7 fs7 fc3 sc0 ls8 ws9f">site <span class="ffd fc5 ls1 ws1">www.penguintutor.com<span class="ff7 fc3">. The web site originally pr<span class="_ _3"></span>ovided information </span></span></div><div class="t m0 xc hd y136 ff7 fs7 fc3 sc0 ls1 ws1">for those studying towar<span class="_ _1"></span>d cer<span class="_ _0"></span>tifica<span class="_ _3"></span>tion but has since added information on </div><div class="t m0 xc hd y137 ff7 fs7 fc3 sc0 ls1 ws1">electronics<span class="_ _3"></span>, projects<span class="_ _1"></span>, and learning computer programmin<span class="_ _3"></span>g.</div><div class="t m0 x1b hd y138 ff7 fs7 fc3 sc0 ls1 ws1">Stewart often gives talks and runs workshops at local R<span class="_ _3"></span>aspberr<span class="_ _0"></span>y Pi </div><div class="t m0 xc hd y13c ff7 fs7 fc3 sc0 ls1 ws1">events<span class="_ _3"></span>. He is also a STEM Ambass<span class="_ _3"></span>ador and Code Club volunteer helping to </div><div class="t m0 xc hd y13d ff7 fs7 fc3 sc0 ls1 ws1">support teachers and children learning pr<span class="_ _1"></span>ogramming. </div><a class="l" href="http://www.penguintutor.com"><div class="d m1" style="border-style:none;position:absolute;left:72.589900px;bottom:332.493000px;width:110.000100px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf12" class="pf w2 h6" data-page-no="12"><div class="pc pc12 w2 h6"><div class="t m0 x15 hd y3f ff7 fs7 fc3 sc0 ls7 ws6f">xxi</div><div class="t m0 xc h11 y12a ff5 fs9 fc3 sc0 ls1 ws1">Acknowledgments</div><div class="t m0 xc hd y12b ff7 fs7 fc3 sc0 ls1 ws1">No book is ever written in isolation. I wan<span class="_ _3"></span>t to especially thank my wife<span class="_ _3"></span>, </div><div class="t m0 xc hd y12c ff7 fs7 fc3 sc0 ls1 ws1">Cath<span class="_ _3"></span>alynn Labonté-<span class="_ _1"></span>Smith, for her support, encouragemen<span class="_ _3"></span>t, and expert </div><div class="t m0 xc hd y12d ff7 fs7 fc3 sc0 ls1 ws1">editing.</div><div class="t m0 x1c hd y12e ff7 fs7 fc3 sc0 ls1 ws1">I want to thank all the good folk at A<span class="_ _1"></span>press who made the whole process </div><div class="t m0 xc hd y12f ff7 fs7 fc3 sc0 ls1 ws1">easy and enjoya<span class="_ _3"></span>ble. A special shout<span class="_ _1"></span>-out to Jessica V<span class="_ _6"></span>akili, my coor<span class="_ _3"></span>dinating </div><div class="t m0 xc hd y130 ff7 fs7 fc3 sc0 ls1 ws1">editor<span class="_ _6"></span>, who kept the whole project mo<span class="_ _3"></span>ving quickly and smoothly. Th<span class="_ _3"></span>anks </div><div class="t m0 xc hd y131 ff7 fs7 fc3 sc0 ls1 ws1">to Aaron B<span class="_ _3"></span>lack, senior editor<span class="_ _6"></span>, who recruited me and got the project started. </div><div class="t m0 xc hd y132 ff7 fs7 fc3 sc0 ls1 ws1">Thanks to S<span class="_ _3"></span>tewart W<span class="_ _1"></span>atkiss, my technical r<span class="_ _1"></span>eviewer<span class="_ _1"></span>, who helped make this a </div><div class="t m0 xc hd y133 ff7 fs7 fc3 sc0 ls1 ws1">far better book.</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf13" class="pf w2 h6" data-page-no="13"><div class="pc pc13 w2 h6"><div class="t m0 x1d hd y3f ff7 fs7 fc3 sc0 ls1 ws1">xxiii</div><div class="t m0 xc h11 y12a ff5 fs9 fc3 sc0 ls1 ws1">Introduction</div><div class="t m0 xc hd y12b ff7 fs7 fc3 sc0 ls1 ws1">Everyone seems to carr<span class="_ _0"></span>y a smartphone and/or a tablet<span class="_ _3"></span>. Nearly all of these </div><div class="t m0 xc hd y12c ff7 fs7 fc3 sc0 ls1 ws1">devices ha<span class="_ _3"></span>ve one thing in common; they use an ARM central pr<span class="_ _1"></span>ocessing </div><div class="t m0 xc hd y12d ff7 fs7 fc3 sc0 ls1 ws1">unit (CPU). All of these devices are computers just like yo<span class="_ _3"></span>ur laptop or </div><div class="t m0 xc hd y12e ff7 fs7 fc3 sc0 ls1 ws1">business desktop<span class="_ _1"></span>. The difference is th<span class="_ _3"></span>at they need to use less power<span class="_ _6"></span>, in </div><div class="t m0 xc hd y12f ff7 fs7 fc3 sc0 ls1 ws1">order to function for a<span class="_ _3"></span>t least a day on one bat<span class="_ _3"></span>tery charge, therefor<span class="_ _1"></span>e the </div><div class="t m0 xc hd y130 ff7 fs7 fc3 sc0 ls1 ws1">popularity of the ARM CPU<span class="_ _1"></span>.</div><div class="t m0 x1c hd y131 ff7 fs7 fc3 sc0 ls1 ws1">At the basic level, ho<span class="_ _3"></span>w are these comput<span class="_ _3"></span>ers progr<span class="_ _3"></span>ammed? What </div><div class="t m0 xc hd y132 ff7 fs7 fc3 sc0 ls1 ws1">pro<span class="_ _3"></span>vides the magical fo<span class="_ _3"></span>undation for all the gr<span class="_ _3"></span>eat applica<span class="_ _3"></span>tions (apps) that </div><div class="t m0 xc hd y133 ff7 fs7 fc3 sc0 ls1 ws1">run on them, yet use far less power than a laptop com<span class="_ _3"></span>puter? This book </div><div class="t m0 xc hd y134 ff7 fs7 fc3 sc0 ls1 wsaa">delves into how these ar<span class="_ _3"></span>e progr<span class="_ _3"></span>ammed at the bar<span class="_ _3"></span>e metal level and pro<span class="_ _1"></span>vides </div><div class="t m0 xc hd y135 ff7 fs7 fc3 sc0 ls1 ws1">insight into their ar<span class="_ _1"></span>chitecture.</div><div class="t m0 x1c hd y136 ff7 fs7 fc3 sc0 ls1 ws1">Assembly Language is the na<span class="_ _3"></span>tive lowest level wa<span class="_ _3"></span>y to progr<span class="_ _3"></span>am a </div><div class="t m0 xc hd y137 ff7 fs7 fc3 sc0 ls1 ws1">computer<span class="_ _6"></span>. Each pr<span class="_ _3"></span>ocessing chip has its own Assembly Lang<span class="_ _3"></span>uage. This </div><div class="t m0 xc hd y138 ff7 fs7 fc3 sc0 ls1 ws1">book covers pr<span class="_ _3"></span>ogramming the ARM 64-bit pr<span class="_ _1"></span>ocess<span class="_ _0"></span>or<span class="_ _6"></span>. If yo<span class="_ _3"></span>u really wan<span class="_ _3"></span>t to </div><div class="t m0 xc hd y13c ff7 fs7 fc3 sc0 ls1 ws1">learn how a computer work<span class="_ _3"></span>s, learning Assem<span class="_ _3"></span>bly Language is a gr<span class="_ _3"></span>eat way t<span class="_ _3"></span>o </div><div class="t m0 xc hd y13d ff7 fs7 fc3 sc0 ls1 ws1">get into the nitty-gritty details. T<span class="_ _3"></span>he popularity and low cost of single boar<span class="_ _3"></span>d </div><div class="t m0 xc hd y13e ff7 fs7 fc3 sc0 ls1 ws1">computers (SBCs) like the Raspberry Pi and NVidia Jetson N<span class="_ _1"></span>ano provide </div><div class="t m0 xc hd y13f ff7 fs7 fc3 sc0 ls1 ws1">ideal platforms to learn advanced concepts in computing.</div><div class="t m0 x1c hd y140 ff7 fs7 fc3 sc0 ls1 ws1">Even tho<span class="_ _3"></span>ugh all these devices are low power<span class="_ _1"></span>ed and compact, they’re </div><div class="t m0 xc hd y141 ff7 fs7 fc3 sc0 ls1 ws1">still sophisticated computers with a multicor<span class="_ _1"></span>e processor<span class="_ _6"></span>, floating-<span class="_ _3"></span>point </div><div class="t m0 xc hd y142 ff7 fs7 fc3 sc0 ls1 ws1">coprocessor<span class="_ _6"></span>, and a NEON parallel pr<span class="_ _1"></span>ocessing unit. What you learn about </div><div class="t m0 xc hd y143 ff7 fs7 fc3 sc0 ls1 ws1">any one of these is directly r<span class="_ _3"></span>elevant to any device with an ARM pr<span class="_ _3"></span>ocessor<span class="_ _6"></span>, </div><div class="t m0 xc hd y144 ff7 fs7 fc3 sc0 ls1 ws1">which by volume is the num<span class="_ _3"></span>ber one processor on the mar<span class="_ _3"></span>ket today.</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf14" class="pf w2 h6" data-page-no="14"><div class="pc pc14 w2 h6"><div class="t m0 xd hd y3f ff7 fs7 fc3 sc0 ls1 ws1">xxiv</div><div class="t m0 xc hd y145 ff7 fs7 fc3 sc0 ls1 ws1">In this book, we cover ho<span class="_ _3"></span>w to progr<span class="_ _3"></span>am all these devices at the lowest </div><div class="t m0 xd hd y146 ff7 fs7 fc3 sc0 ls1 ws1">level, operating as c<span class="_ _3"></span>lose to the hardwar<span class="_ _1"></span>e as possible. Y<span class="_ _6"></span>ou will learn the </div><div class="t m0 xd hd y147 ff7 fs7 fc3 sc0 ls1 ws1">following:</div><div class="t m0 xa hd y148 ff7 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The format of the instructions and how to put them </div><div class="t m0 x1e hd y149 ff7 fs7 fc3 sc0 ls1 ws1">together into progr<span class="_ _1"></span>ams, as well as details on the binar<span class="_ _0"></span>y </div><div class="t m0 x1e hd y14a ff7 fs7 fc3 sc0 ls1 ws1">data formats they opera<span class="_ _3"></span>te on</div><div class="t m0 xa hd y14b ff7 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>How to pr<span class="_ _1"></span>ogram the floating-<span class="_ _3"></span>point pr<span class="_ _3"></span>ocessor<span class="_ _6"></span>, as well as </div><div class="t m0 x1e hd y14c ff7 fs7 fc3 sc0 ls1 ws1">the NEON parallel pr<span class="_ _3"></span>ocessor</div><div class="t m0 xa hd y14d ff7 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>About devices running Google’<span class="_ _6"></span>s Android, Apple<span class="_ _1"></span>’<span class="_ _1"></span>s iOS, </div><div class="t m0 x1e hd y14e ff7 fs7 fc3 sc0 ls1 ws1">and Linux</div><div class="t m0 xa hd y14f ff7 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>How to pr<span class="_ _1"></span>ogram the hardwar<span class="_ _1"></span>e directly using the </div><div class="t m0 x1e hd y150 ff7 fs7 fc3 sc0 ls1 ws1">Raspberr<span class="_ _0"></span>y Pi<span class="_ _3"></span>’<span class="_ _6"></span>s GPIO por<span class="_ _0"></span>ts</div><div class="t m0 xc hd y151 ff7 fs7 fc3 sc0 ls1 ws1">The simplest wa<span class="_ _3"></span>y to learn this is with a Raspberr<span class="_ _0"></span>y Pi running a 64-bit </div><div class="t m0 xd hd y152 ff7 fs7 fc3 sc0 ls1 ws1">flav<span class="_ _3"></span>or of Linux such as Kali Linux. This pro<span class="_ _1"></span>vides all the tools you need to </div><div class="t m0 xd hd y153 ff7 fs7 fc3 sc0 ls1 ws1">learn Assembly progr<span class="_ _3"></span>amming. Ther<span class="_ _1"></span>e’<span class="_ _1"></span>s optional m<span class="_ _3"></span>aterial that r<span class="_ _3"></span>equires an </div><div class="t m0 xd hd y154 ff7 fs7 fc3 sc0 ls1 wsaa">Apple M<span class="_ _1"></span>ac and iPhone or iPad, as well as optional m<span class="_ _3"></span>aterial that r<span class="_ _3"></span>equires an </div><div class="t m0 xd hd y155 ff7 fs7 fc3 sc0 ls1 ws1">Intel-based computer and an Andr<span class="_ _1"></span>oid device.</div><div class="t m0 xc hd y156 ff7 fs7 fc3 sc0 ls1 ws1">This book contains many wor<span class="_ _3"></span>king progr<span class="_ _3"></span>ams that y<span class="_ _3"></span>ou can play with, </div><div class="t m0 xd hd y157 ff7 fs7 fc3 sc0 ls1 ws1">use as a starting point, or study. The only wa<span class="_ _1"></span>y to learn programming is by </div><div class="t m0 xd hd y158 ff7 fs7 fc3 sc0 ls1 ws1">doing, so don’t be afraid to experiment, as it is the only w<span class="_ _3"></span>ay you will learn.</div><div class="t m0 xc hd y159 ff7 fs7 fc3 sc0 ls1 ws1">Even if y<span class="_ _3"></span>ou don’t use Assembly progr<span class="_ _3"></span>amming in your da<span class="_ _3"></span>y-to-day life<span class="_ _1"></span>, </div><div class="t m0 xd hd y15a ff7 fs7 fc3 sc0 ls1 ws1">knowing how the pr<span class="_ _3"></span>ocessor works at the Assembly level and kno<span class="_ _3"></span>wing the </div><div class="t m0 xd hd y15b ff7 fs7 fc3 sc0 ls1 ws1">low-level binary data structures will make y<span class="_ _3"></span>ou a better progr<span class="_ _1"></span>ammer in </div><div class="t m0 xd hd y15c ff7 fs7 fc3 sc0 ls1 ws1">all other areas<span class="_ _1"></span>. Knowing how the processor works will let you write more </div><div class="t m0 xd hd y15d ff7 fs7 fc3 sc0 ls1 ws1">efficient C code and can even help you with your Python progr<span class="_ _1"></span>amming.</div><div class="t m0 xc hd y15e ff7 fs7 fc3 sc0 ls1 ws1">The book is designed to be followed in sequence, but ther<span class="_ _3"></span>e </div><div class="t m0 xd hd y15f ff7 fs7 fc3 sc0 ls1 ws1">are ch<span class="_ _3"></span>apters that c<span class="_ _3"></span>an be skipped or skimmed, for example, if you </div><div class="t m0 xd hd y160 ff7 fs7 fc3 sc0 ls1 ws1">aren’t int<span class="_ _3"></span>erested in interfacing to h<span class="_ _3"></span>ardwar<span class="_ _1"></span>e, you can skip Cha<span class="_ _3"></span>pter <span class="fc5">8</span>, </div><div class="t m0 xd hd y161 ff7 fs7 fc3 sc0 ls1 ws1">“Progr<span class="_ _3"></span>amming GPIO Pins,<span class="_ _8"></span>” or Ch<span class="_ _3"></span>apter <span class="fc5">12</span>, “Floatin<span class="_ _3"></span>g-Point Oper<span class="_ _3"></span>ations<span class="_ _3"></span>,<span class="_ _8"></span>” if </div><div class="t m0 xd hd y162 ff7 fs7 fc3 sc0 ls1 ws1">you will never do numerical computing<span class="ff9">.</span></div><div class="t m0 xd h12 y71 ffc fsa fc3 sc0 ls1 ws1">InTroduCTIon<span class="_ _d"></span>InTroduCTIon</div><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:341.477000px;bottom:115.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:216.673000px;bottom:99.361800px;width:11.000000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf15" class="pf w2 h6" data-page-no="15"><div class="pc pc15 w2 h6"><div class="t m0 x17 hd y3f ff7 fs7 fc3 sc0 ls8 ws9f">xxv</div><div class="t m0 x1c hd y145 ff7 fs7 fc3 sc0 ls1 ws1">I hope you enjoy yo<span class="_ _3"></span>ur introduction to Assem<span class="_ _3"></span>bly Language<span class="_ _3"></span>. Learning </div><div class="t m0 xc hd y146 ff7 fs7 fc3 sc0 ls1 ws1">it for one processor family will help you with any other pr<span class="_ _3"></span>ocessor </div><div class="t m0 xc hd y147 ff7 fs7 fc3 sc0 ls1 ws1">architectur<span class="_ _1"></span>es you encounter through yo<span class="_ _3"></span>ur career<span class="_ _6"></span>.</div><div class="t m0 xc h15 y163 ffe fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Source Code Location</div><div class="t m0 xc hd y164 ff7 fs7 fc3 sc0 ls1 ws1">The source code for the example code in the book is loca<span class="_ _3"></span>ted on the Apr<span class="_ _3"></span>ess </div><div class="t m0 xc hd y165 ff7 fs7 fc3 sc0 ls1 ws1">GitH<span class="_ _3"></span>ub site at the following URL<span class="_ _0"></span>:</div><div class="t m0 x1c h16 y166 ffd fs7 fc5 sc0 ls1 wsab">https://github.com/Apress/Programming-with-64-Bit-ARM- -</div><div class="t m0 xc h16 y167 ffd fs7 fc5 sc0 ls1 ws1">Assembly-Language</div><div class="t m0 x1c hd y168 ff7 fs7 fc3 sc0 ls1 ws1">The code is organized b<span class="_ _3"></span>y chapter and includes some answers to the </div><div class="t m0 xc hd y169 ff7 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming exer<span class="_ _3"></span>cises.</div><div class="t m0 x1f h12 y71 ffc fsa fc3 sc0 ls1 ws1">InTroduCTIon<span class="_ _d"></span>InTroduCTIon</div><a class="l" href="https://github.com/Apress/Programming-with-64-Bit-ARM-Assembly-Language"><div class="d m1" style="border-style:none;position:absolute;left:72.000000px;bottom:441.318000px;width:302.500000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="https://github.com/Apress/Programming-with-64-Bit-ARM-Assembly-Language"><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:425.318000px;width:93.500000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf16" class="pf w2 h6" data-page-no="16"><div class="pc pc16 w2 h6"><div class="t m0 xf hd y16a fff fs7 fc3 sc0 ls1 ws1">1</div><div class="t m0 xc h17 y16b fff fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c fff fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff10">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="fff">,  </span></span></div><div class="t m0 xc h17 y16d fff fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_1</div><div class="t m0 xc ha y16e ff11 fs6 fc3 sc0 ls1 ws1">CHAPTER 1</div><div class="t m0 xc h8 y16f ff12 fs4 fc3 sc0 ls1 ws1">Getting Star<span class="_ _7"></span>ted</div><div class="t m0 xc hd y170 fff fs7 fc3 sc0 ls1 ws1">The ARM processor was origin<span class="_ _3"></span>ally developed by Acorn Comp<span class="_ _3"></span>uters in </div><div class="t m0 xc hd y171 fff fs7 fc3 sc0 ls1 ws1">Grea<span class="_ _3"></span>t Britain, who wanted to build a successor to the BBC M<span class="_ _3"></span>icrocomp<span class="_ _3"></span>uter </div><div class="t m0 xc hd y172 fff fs7 fc3 sc0 ls1 ws1">used for educational purposes<span class="_ _3"></span>. The BBC M<span class="_ _3"></span>icrocomputer used the 6502 </div><div class="t m0 xc hd y173 fff fs7 fc3 sc0 ls1 ws1">processor<span class="_ _6"></span>, which was a simple pr<span class="_ _1"></span>ocessor w<span class="_ _0"></span>ith a simple instruction set. The </div><div class="t m0 xc hd y174 fff fs7 fc3 sc0 ls1 ws1">problem was ther<span class="_ _1"></span>e was no successor to the 6502. The engineers working </div><div class="t m0 xc hd y175 fff fs7 fc3 sc0 ls1 ws1">on the Acorn computer wer<span class="_ _3"></span>en’t happ<span class="_ _3"></span>y with the micropr<span class="_ _3"></span>ocessors availa<span class="_ _3"></span>ble </div><div class="t m0 xc hd y176 fff fs7 fc3 sc0 ls1 ws1">at the time, s<span class="_ _3"></span>ince they were much mor<span class="_ _3"></span>e complicated th<span class="_ _3"></span>an the 6502, and </div><div class="t m0 xc hd y177 fff fs7 fc3 sc0 ls1 ws1">they didn’t want to make j<span class="_ _3"></span>ust another IBM PC clone. They took the bold </div><div class="t m0 xc hd y178 fff fs7 fc3 sc0 ls1 ws1">move to desi<span class="_ _3"></span>gn their own and founded Advanced RISC Machines Ltd. </div><div class="t m0 xc hd y179 fff fs7 fc3 sc0 ls1 ws1">to do it. They developed the Acorn comput<span class="_ _3"></span>er and tried to position it as </div><div class="t m0 xc hd y17a fff fs7 fc3 sc0 ls1 ws1">the successor to the BBC Micr<span class="_ _1"></span>ocomputer<span class="_ _6"></span>. The idea was to use reduced </div><div class="t m0 xc hd y17b fff fs7 fc3 sc0 ls1 ws1">instruction set computer (RISC<span class="_ _0"></span>) technology as opposed to complex </div><div class="t m0 xc hd y17c fff fs7 fc3 sc0 ls1 ws1">instruction set computer (CISC<span class="_ _0"></span>) as cham<span class="_ _3"></span>pioned by In<span class="_ _3"></span>tel and Motor<span class="_ _1"></span>ola.  </div><div class="t m0 xc hd y17d fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will talk at length about what these terms mean later<span class="_ _6"></span>.</div><div class="t m0 x1c hd y17e fff fs7 fc3 sc0 ls1 ws1">Developing silicon chips is costly, and without high volumes<span class="_ _3"></span>, </div><div class="t m0 xc hd y17f fff fs7 fc3 sc0 ls1 ws1">manufacturing them is expensive<span class="_ _1"></span>. The ARM processor probably wouldn’t </div><div class="t m0 xc hd y180 fff fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve gone anywhere ex<span class="_ _3"></span>cept that A<span class="_ _3"></span>pple came calling<span class="_ _3"></span>. They were looking </div><div class="t m0 xc hd y181 fff fs7 fc3 sc0 ls1 ws1">for a processor for a new device under development<span class="_ _1"></span>—the iPod. The key </div><div class="t m0 xc hd y182 fff fs7 fc3 sc0 ls1 ws1">selling point for Apple w<span class="_ _3"></span>as that as the ARM pr<span class="_ _3"></span>ocessor was RISC<span class="_ _0"></span>, it used </div><div class="t m0 xc hd y183 fff fs7 fc3 sc0 ls1 ws1">less silicon than CISC processors and as a res<span class="_ _3"></span>ult used far less power<span class="_ _6"></span>. This </div><div class="t m0 xc hd y184 fff fs7 fc3 sc0 ls1 ws1">meant it was possible to build a device th<span class="_ _3"></span>at ran for a long time on a sin<span class="_ _3"></span>gle </div><div class="t m0 xc hd y185 fff fs7 fc3 sc0 ls8 ws9f">battery charge.</div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf17" class="pf w2 h6" data-page-no="17"><div class="pc pc17 w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">2</div><div class="t m0 xd h15 y186 ff13 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>The Surprise Birth ofthe64-Bit ARM</div><div class="t m0 xd hd y187 fff fs7 fc3 sc0 lsa ws1">The early iPhones and Andr<span class="_ _3"></span>oid phones were all based on 32-bit ARM </div><div class="t m0 xd hd y188 fff fs7 fc3 sc0 lsa ws1">processors<span class="_ _3"></span>. At th<span class="_ _3"></span>at time<span class="_ _3"></span>, even though most server and desktop operating </div><div class="t m0 xd hd y189 fff fs7 fc3 sc0 lsa ws1">systems mov<span class="_ _3"></span>ed to 64 bits, it was believed tha<span class="_ _3"></span>t there w<span class="_ _3"></span>as no need in the mobile<span class="_ _0"></span> </div><div class="t m0 xd hd y18a fff fs7 fc3 sc0 lsa ws1">world for 64 bits. Then in 2013, A<span class="_ _1"></span>pple shocked the ARM world by introducing </div><div class="t m0 xd hd y18b fff fs7 fc3 sc0 lsa ws1">the 64-bit capable A7 chip and started the migr<span class="_ _3"></span>ation of all iOS progr<span class="_ _3"></span>ams to </div><div class="t m0 xd hd y18c fff fs7 fc3 sc0 lsa ws1">64 bits. The performance gains astonished everyone and caugh<span class="_ _3"></span>t all their </div><div class="t m0 xd hd y18d fff fs7 fc3 sc0 lsa ws1">competitors flat footed. N<span class="_ _3"></span>ow, all newer ARM processors support 64-bit </div><div class="t m0 xd hd y18e fff fs7 fc3 sc0 lsa ws1">processing<span class="_ _3"></span>, and all the major ARM oper<span class="_ _3"></span>ating systems h<span class="_ _3"></span>ave mo<span class="_ _1"></span>ved to 64 bits.</div><div class="t m0 xc hd y18f fff fs7 fc3 sc0 ls1 ws1">Two benefits of ARM 64-bit pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>amming are th<span class="_ _3"></span>at ARM cleaned up </div><div class="t m0 xd hd y190 fff fs7 fc3 sc0 ls1 ws1">their instruction set and simplified Assembly Language progr<span class="_ _1"></span>amming. </div><div class="t m0 xd hd y191 fff fs7 fc3 sc0 ls1 ws1">They also adapted the code, so that it will run mor<span class="_ _3"></span>e efficiently on modern </div><div class="t m0 xd hd y192 fff fs7 fc3 sc0 ls1 ws1">processors with larger execution pipelines<span class="_ _3"></span>. There ar<span class="_ _1"></span>e still a lot of details </div><div class="t m0 xd hd y193 fff fs7 fc3 sc0 ls1 ws1">and complexities to master<span class="_ _6"></span>, but if you h<span class="_ _3"></span>av<span class="_ _3"></span>e experience in 32-bit ARM, you </div><div class="t m0 xd hd y194 fff fs7 fc3 sc0 ls1 ws1">will find 64-bit programming s<span class="_ _3"></span>impler and more consisten<span class="_ _3"></span>t.</div><div class="t m0 xc hd y195 fff fs7 fc3 sc0 ls1 ws1">However<span class="_ _6"></span>, ther<span class="_ _1"></span>e is still a nee<span class="_ _0"></span>d for 32-bit pr<span class="_ _3"></span>ocessing, for instance<span class="_ _1"></span>, </div><div class="t m0 xd hd y196 fff fs7 fc3 sc0 ls1 ws1">Raspbian, the default opera<span class="_ _3"></span>ting system for the Raspberry Pi, is 32 bits, </div><div class="t m0 xd hd y197 fff fs7 fc3 sc0 ls1 ws1">along with several real-time and em<span class="_ _3"></span>bedded systems. If yo<span class="_ _3"></span>u ha<span class="_ _3"></span>ve 1GB of </div><div class="t m0 xd hd y198 fff fs7 fc3 sc0 ls1 ws1">memory or less, 32 bits is better<span class="_ _6"></span>, but once you ha<span class="_ _1"></span>ve more than 1GB of RAM, </div><div class="t m0 xd hd y199 fff fs7 fc3 sc0 ls1 ws1">then the benefits of 64-bit progr<span class="_ _3"></span>amming become hard to i<span class="_ _3"></span>gnore<span class="_ _3"></span>.</div><div class="t m0 xc hd y19a fff fs7 fc3 sc0 lsb ws1">Unlike In<span class="_ _3"></span>tel, ARM doesn’t manufactur<span class="_ _1"></span>e chips<span class="_ _0"></span>; it just licenses the </div><div class="t m0 xd hd y19b fff fs7 fc3 sc0 lsb ws1">designs for others to optimize and manufact<span class="_ _3"></span>ure<span class="_ _1"></span>. With Apple onboard, </div><div class="t m0 xd hd y19c fff fs7 fc3 sc0 lsb ws1">suddenly there w<span class="_ _3"></span>as a lot of interes<span class="_ _3"></span>t in ARM, and several big man<span class="_ _3"></span>ufacturers </div><div class="t m0 xd hd y19d fff fs7 fc3 sc0 lsb ws1">started producing chips<span class="_ _3"></span>. With the adven<span class="_ _3"></span>t of smartphones, the ARM chip </div><div class="t m0 xd hd y19e fff fs7 fc3 sc0 lsb ws1">really took off and no<span class="_ _3"></span>w is used in pretty much every phone and tablet. ARM </div><div class="t m0 xd hd y19f fff fs7 fc3 sc0 lsb ws1">processors power some Chr<span class="_ _3"></span>omebooks and even Micr<span class="_ _1"></span>osoft<span class="_ _0"></span>’<span class="_ _6"></span>s Surface Pro X.</div><div class="t m0 xc hd y1a0 fff fs7 fc3 sc0 ls1 ws1">The ARM processor is the num<span class="_ _3"></span>ber one processor in the computer </div><div class="t m0 xd hd y1a1 fff fs7 fc3 sc0 ls1 ws1">market<span class="_ _3"></span>. Each year the ARM pr<span class="_ _3"></span>ocessors powering the leading-edge phones </div><div class="t m0 xd hd y1a2 fff fs7 fc3 sc0 ls1 ws1">become more and mor<span class="_ _3"></span>e powerful. W<span class="_ _1"></span>e are starting to see ARM<span class="_ _1"></span>-bas<span class="_ _0"></span>ed </div><div class="t m0 xd hd y1a3 fff fs7 fc3 sc0 ls1 ws1">ser<span class="_ _0"></span>vers used in datacen<span class="_ _3"></span>ters, includin<span class="_ _3"></span>g Amazon’<span class="_ _6"></span>s A<span class="_ _1"></span>WS.T<span class="_ _3"></span>here ar<span class="_ _1"></span>e s<span class="_ _0"></span>ever<span class="_ _3"></span>al </div><div class="t m0 xd hd y1a4 fff fs7 fc3 sc0 ls1 ws1">ARM<span class="_ _1"></span>-based laptops and desktop computers in the works<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf18" class="pf w2 h6" data-page-no="18"><div class="pc pc18 w2 h6"><div class="t m0 xf hd y3f fff fs7 fc3 sc0 ls1 ws1">3</div><div class="t m0 xc h15 y186 ff13 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>What Y<span class="_ _8"></span>ouWill Learn</div><div class="t m0 xc hd y187 fff fs7 fc3 sc0 lsc ws1">Y<span class="_ _6"></span>ou will learn Ass<span class="_ _0"></span>embly Lan<span class="_ _3"></span>guage progr<span class="_ _1"></span>amming for the ARM r<span class="_ _0"></span>unning in </div><div class="t m0 xc hd y188 fff fs7 fc3 sc0 lsc ws1">64-bit mode. E<span class="_ _1"></span>ver<span class="_ _0"></span>ything you will learn is directly applic<span class="_ _3"></span>able to all ARM </div><div class="t m0 xc hd y189 fff fs7 fc3 sc0 lsc ws1">devices running in 64-bit mode. Learning Assembly Language for one </div><div class="t m0 xc hd y18a fff fs7 fc3 sc0 lsc ws1">processor gives you the t<span class="_ _3"></span>ools to learn it for another processor<span class="_ _6"></span>, perha<span class="_ _3"></span>ps, the </div><div class="t m0 xc hd y18b fff fs7 fc3 sc0 lsc ws1">forthcoming RISC-<span class="_ _1"></span>V<span class="_ _10"></span>, a new open source RISC processor tha<span class="_ _3"></span>t originated from </div><div class="t m0 xc hd y18c fff fs7 fc3 sc0 lsc ws1">Berkeley University. The RISC-<span class="_ _1"></span>V archit<span class="_ _3"></span>ecture pr<span class="_ _3"></span>omises high functionality </div><div class="t m0 xc hd y18d fff fs7 fc3 sc0 lsc ws1">and speed for less power and cost than an equivalent ARM pr<span class="_ _1"></span>o<span class="_ _0"></span>cessor<span class="_ _10"></span>.</div><div class="t m0 x1c hd y18e fff fs7 fc3 sc0 ls1 ws1">In all devices<span class="_ _3"></span>, the ARM processor isn’t just a CPU; it’<span class="_ _6"></span>s a system on </div><div class="t m0 xc hd y18f fff fs7 fc3 sc0 ls1 ws1">a chip<span class="_ _1"></span>. This means that most of the computer is all on one chip<span class="_ _1"></span>. When </div><div class="t m0 xc hd y190 fff fs7 fc3 sc0 ls1 ws1">a company is designing a device<span class="_ _1"></span>, the<span class="_ _0"></span>y can select various modular </div><div class="t m0 xc hd y191 fff fs7 fc3 sc0 ls1 ws1">components to include on their chip<span class="_ _1"></span>. Typically, this con<span class="_ _3"></span>tains an ARM </div><div class="t m0 xc hd y192 fff fs7 fc3 sc0 ls1 ws1">processor with multiple cor<span class="_ _3"></span>es, meanin<span class="_ _3"></span>g that it can pr<span class="_ _1"></span>ocess instr<span class="_ _0"></span>uctions for </div><div class="t m0 xc hd y193 fff fs7 fc3 sc0 ls1 ws1">multiple progr<span class="_ _1"></span>ams r<span class="_ _0"></span>unning at once<span class="_ _1"></span>. It likely contains sever<span class="_ _3"></span>al coprocessors </div><div class="t m0 xc hd y194 fff fs7 fc3 sc0 ls1 ws1">for things like floating-<span class="_ _1"></span>point calculations<span class="_ _3"></span>, a graphics pr<span class="_ _1"></span>ocessing unit </div><div class="t m0 xc hd y195 fff fs7 fc3 sc0 ls1 wsac">(GPU), and specialized multimedia support. There are ex<span class="_ _3"></span>tensions a<span class="_ _3"></span>vailable </div><div class="t m0 xc hd y196 fff fs7 fc3 sc0 ls1 ws1">for cryptography, advanced virtualization, and security monitoring.</div><div class="t m0 xc h15 y1a5 ff13 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Why Use Assembly</div><div class="t m0 xc hd y1a6 fff fs7 fc3 sc0 ls1 ws1">Most pr<span class="_ _3"></span>ogrammers write in a high-level pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>amming language like </div><div class="t m0 xc hd y1a7 fff fs7 fc3 sc0 ls1 ws1">Python, C#, Ja<span class="_ _1"></span>va, J<span class="_ _1"></span>avaScript, Go, J<span class="_ _1"></span>ulia, Scra<span class="_ _3"></span>tch, R<span class="_ _1"></span>uby, Swift, or C.These </div><div class="t m0 xc hd y1a8 fff fs7 fc3 sc0 ls1 ws1">highly productive lan<span class="_ _3"></span>guages are used to write ma<span class="_ _3"></span>jor progr<span class="_ _3"></span>ams from </div><div class="t m0 xc hd y1a9 fff fs7 fc3 sc0 ls1 ws1">the Linux operatin<span class="_ _3"></span>g system to web sites like F<span class="_ _1"></span>acebook, to pr<span class="_ _3"></span>oductivity </div><div class="t m0 xc hd y1aa fff fs7 fc3 sc0 ls1 ws1">software like Libr<span class="_ _1"></span>eOffice. If you learn to be a good programmer in a co<span class="_ _3"></span>uple </div><div class="t m0 xc hd y1ab fff fs7 fc3 sc0 ls1 ws1">of these, you c<span class="_ _3"></span>an find a well-pa<span class="_ _3"></span>ying inter<span class="_ _1"></span>esting job and write s<span class="_ _0"></span>ome gr<span class="_ _3"></span>eat </div><div class="t m0 xc hd y1ac fff fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams. If yo<span class="_ _3"></span>u crea<span class="_ _3"></span>te a progr<span class="_ _3"></span>am in one of these languages<span class="_ _3"></span>, you can </div><div class="t m0 xc hd y1ad fff fs7 fc3 sc0 ls1 ws1">easily get it working on numer<span class="_ _1"></span>ous operating systems on multiple h<span class="_ _3"></span>ardwar<span class="_ _1"></span>e </div><div class="t m0 xc hd y1ae fff fs7 fc3 sc0 ls1 ws1">architectur<span class="_ _1"></span>es. Y<span class="_ _1"></span>ou never ha<span class="_ _1"></span>ve to learn the details of all the bits and bytes<span class="_ _3"></span>, </div><div class="t m0 xc hd y1af fff fs7 fc3 sc0 ls1 ws1">and these can rem<span class="_ _3"></span>ain safely under the covers<span class="_ _1"></span>.</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf19" class="pf w2 h6" data-page-no="19"><div class="pc pc19 w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">4</div><div class="t m0 xc hd y145 fff fs7 fc3 sc0 ls1 ws1">When you progr<span class="_ _1"></span>am in Assembly Language, you ar<span class="_ _1"></span>e tightly coupled to </div><div class="t m0 xd hd y146 fff fs7 fc3 sc0 ls1 ws1">a given CPU<span class="_ _1"></span>, and moving your pr<span class="_ _1"></span>ogram to another requires a com<span class="_ _3"></span>plete </div><div class="t m0 xd hd y147 fff fs7 fc3 sc0 ls1 ws1">rewrite of your pr<span class="_ _1"></span>ogram. Each Assembly Language instruction does only </div><div class="t m0 xd hd y1b0 fff fs7 fc3 sc0 ls1 ws1">a fraction of the amount of wor<span class="_ _3"></span>k, so to do anything takes a lot of Assembly </div><div class="t m0 xd hd y1b1 fff fs7 fc3 sc0 ls1 ws1">statements<span class="_ _1"></span>. Therefore<span class="_ _1"></span>, to do the same w<span class="_ _0"></span>or<span class="_ _3"></span>k as, sa<span class="_ _3"></span>y, a Python program<span class="_ _3"></span>, </div><div class="t m0 xd hd y1b2 fff fs7 fc3 sc0 ls1 ws1">takes an order of m<span class="_ _3"></span>agnitude larger amount of effort<span class="_ _3"></span>, for the progr<span class="_ _3"></span>ammer<span class="_ _6"></span>. </div><div class="t m0 xd hd y1b3 fff fs7 fc3 sc0 ls1 ws1">Writing in Assembly is har<span class="_ _3"></span>der<span class="_ _6"></span>, as you must solve pr<span class="_ _3"></span>oblems with memor<span class="_ _0"></span>y </div><div class="t m0 xd hd y1b4 fff fs7 fc3 sc0 ls1 ws1">addressing and CPU r<span class="_ _1"></span>egisters that is all handled transpar<span class="_ _1"></span>ently by high- </div><div class="t m0 xd hd y1b5 fff fs7 fc3 sc0 ls1 ws1">level languages<span class="_ _3"></span>. So why would you wan<span class="_ _3"></span>t to learn Assembly Language </div><div class="t m0 xd hd y1b6 fff fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming? Her<span class="_ _1"></span>e are ten reasons people learn and use Assembly </div><div class="t m0 xd hd y1b7 fff fs7 fc3 sc0 ls1 ws1">Language:</div><div class="t m0 xc hd y1b8 fff fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o write more efficient code<span class="fff">: Even if you don’t </span></span></div><div class="t m0 x1e hd y1b9 fff fs7 fc3 sc0 ls1 ws1">write Assembly Language code, kno<span class="_ _3"></span>wing how the </div><div class="t m0 x1e hd y1ba fff fs7 fc3 sc0 ls1 ws1">computer works int<span class="_ _3"></span>ernally allows you to write </div><div class="t m0 x1e hd y1bb fff fs7 fc3 sc0 ls1 ws1">more str<span class="_ _1"></span>eamlined co<span class="_ _0"></span>de<span class="_ _3"></span>. Y<span class="_ _6"></span>ou can make your data </div><div class="t m0 x1e hd y1bc fff fs7 fc3 sc0 ls1 ws1">structures easier to access and write code in a </div><div class="t m0 x1e hd y1bd fff fs7 fc3 sc0 ls1 ws1">style that allo<span class="_ _3"></span>ws the compiler to generate mor<span class="_ _1"></span>e </div><div class="t m0 x1e hd y1be fff fs7 fc3 sc0 ls1 ws1">effective code. Y<span class="_ _6"></span>ou can make better use of computer </div><div class="t m0 x1e hd y1bf fff fs7 fc3 sc0 ls1 ws1">resour<span class="_ _1"></span>ces, like coprocessors<span class="_ _3"></span>, and use the given </div><div class="t m0 x1e hd y1c0 fff fs7 fc3 sc0 ls1 ws1">computer to its fullest potential.</div><div class="t m0 xc hd y1c1 fff fs7 fc3 sc0 ls1 wsad"> 2. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o write your own operating system<span class="fff">: The core of </span></span></div><div class="t m0 x1e hd y1c2 fff fs7 fc3 sc0 ls1 ws1">the operating sy<span class="_ _3"></span>stem that initializes the CPU and </div><div class="t m0 x1e hd y1c3 fff fs7 fc3 sc0 ls1 ws1">handles har<span class="_ _3"></span>dwar<span class="_ _3"></span>e security and multithreading/</div><div class="t m0 x1e hd y1c4 fff fs7 fc3 sc0 ls1 ws1">multitasking r<span class="_ _3"></span>equires Assembly code<span class="_ _1"></span>.</div><div class="t m0 xc hd y1c5 fff fs7 fc3 sc0 ls1 wsad"> 3. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o create a new programming language<span class="fff">: If it is </span></span></div><div class="t m0 x1e hd y1c6 fff fs7 fc3 sc0 ls1 ws1">a compiled language<span class="_ _3"></span>, then you need to generate </div><div class="t m0 x1e hd y1c7 fff fs7 fc3 sc0 ls1 ws1">the Assembly code to execute. T<span class="_ _3"></span>he quality and </div><div class="t m0 x1e hd y1c8 fff fs7 fc3 sc0 ls1 ws1">speed of your language is largely dependent on the </div><div class="t m0 x1e hd y1c9 fff fs7 fc3 sc0 ls1 ws1">quality and speed of the Assembly Language code it </div><div class="t m0 x1e hd y1ca fff fs7 fc3 sc0 ls1 ws1">generates<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a" class="pf w2 h6" data-page-no="1a"><div class="pc pc1a w2 h6"><div class="t m0 xf hd y3f fff fs7 fc3 sc0 ls1 ws1">5</div><div class="t m0 x1c hd y145 fff fs7 fc3 sc0 ls1 wsad"> 4. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o mak<span class="_ _3"></span>e your computer run faster<span class="fff">: The best way to </span></span></div><div class="t m0 x9 hd y146 fff fs7 fc3 sc0 ls1 ws1">make Linux faster is to im<span class="_ _3"></span>pro<span class="_ _1"></span>ve the GNU C compiler<span class="_ _6"></span>. </div><div class="t m0 x9 hd y147 fff fs7 fc3 sc0 ls1 ws1">If you impr<span class="_ _3"></span>ove the ARM 64-bit Assembl<span class="_ _3"></span>y code </div><div class="t m0 x9 hd y1b0 fff fs7 fc3 sc0 ls1 ws1">produced by GNU C, then every program compiled </div><div class="t m0 x9 hd y1b1 fff fs7 fc3 sc0 ls1 ws1">by GCC benefits.</div><div class="t m0 x1c hd y14a fff fs7 fc3 sc0 ls1 wsad"> 5. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o interface your computer to a hardware </span></div><div class="t m0 x9 hd y1cb ff15 fs7 fc3 sc0 ls1 ws1">device<span class="fff">: When interfacing your computer through </span></div><div class="t m0 x9 hd y1cc fff fs7 fc3 sc0 ls1 ws1">USB or GPIO ports, the speed of data transfer is </div><div class="t m0 x9 hd y1cd fff fs7 fc3 sc0 ls1 ws1">highly sensitive as to how fast yo<span class="_ _3"></span>ur progr<span class="_ _3"></span>am can </div><div class="t m0 x9 hd y1ce fff fs7 fc3 sc0 ls1 ws1">process the da<span class="_ _3"></span>ta. Per<span class="_ _3"></span>haps<span class="_ _3"></span>, there ar<span class="_ _1"></span>e a lot of bit </div><div class="t m0 x9 hd y1cf fff fs7 fc3 sc0 ls1 ws1">level manipulations th<span class="_ _3"></span>at ar<span class="_ _3"></span>e easier to progr<span class="_ _3"></span>am in </div><div class="t m0 x9 hd y1b8 fff fs7 fc3 sc0 ls1 ws1">Assembly.</div><div class="t m0 x1c hd y1d0 fff fs7 fc3 sc0 ls1 wsad"> 6. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o do faster machine learning or three-</span></div><div class="t m0 x9 hd y1d1 ff15 fs7 fc3 sc0 ls1 ws1">dimensional (3D) graphics programming<span class="fff">: Both </span></div><div class="t m0 x9 hd y1d2 fff fs7 fc3 sc0 ls1 ws1">applications r<span class="_ _1"></span>ely on fast matrix mathematics<span class="_ _1"></span>. If you </div><div class="t m0 x9 hd y1d3 fff fs7 fc3 sc0 ls1 ws1">can make this faster with Assembly and/or using </div><div class="t m0 x9 hd y1d4 fff fs7 fc3 sc0 ls1 ws1">the coprocessors<span class="_ _3"></span>, then you can m<span class="_ _3"></span>ake your AI<span class="_ _1"></span>-based </div><div class="t m0 x9 hd y1d5 fff fs7 fc3 sc0 ls1 ws1">robot or video game th<span class="_ _3"></span>at much better<span class="_ _10"></span>.</div><div class="t m0 x1c hd y1d6 fff fs7 fc3 sc0 ls1 wsad"> 7. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o boo<span class="_ _0"></span>st performance<span class="fff">: Most large pr<span class="_ _3"></span>ograms </span></span></div><div class="t m0 x9 hd y1d7 fff fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve components written in differ<span class="_ _3"></span>ent languages<span class="_ _1"></span>. </div><div class="t m0 x9 hd y1d8 fff fs7 fc3 sc0 ls1 ws1">If your pr<span class="_ _3"></span>ogram is 99% C++, the other 1% could </div><div class="t m0 x9 hd y1d9 fff fs7 fc3 sc0 ls1 ws1">be Assembly, perhaps giving y<span class="_ _3"></span>our progr<span class="_ _3"></span>am a </div><div class="t m0 x9 hd y1da fff fs7 fc3 sc0 ls1 ws1">performance boost or some other competitive </div><div class="t m0 x9 hd y1db fff fs7 fc3 sc0 ls1 ws1">advantage<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1dc fff fs7 fc3 sc0 ls1 wsad"> 8. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o manage single board computer c<span class="_ _0"></span>ompetitors </span></div><div class="t m0 x9 hd y1dd ff15 fs7 fc3 sc0 ls1 ws1">to the Raspberr<span class="_ _0"></span>y Pi<span class="fff">: These boards ha<span class="_ _1"></span>ve some </span></div><div class="t m0 x9 hd y1de fff fs7 fc3 sc0 ls1 ws1">Assembly Language code to man<span class="_ _3"></span>age peripherals </div><div class="t m0 x9 hd y1df fff fs7 fc3 sc0 ls1 ws1">included with the board. This code is usually called </div><div class="t m0 x9 hd y1e0 fff fs7 fc3 sc0 ls1 ws1">a BIOS (basic input/output system).</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1b" class="pf w2 h6" data-page-no="1b"><div class="pc pc1b w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">6</div><div class="t m0 xc hd y145 fff fs7 fc3 sc0 ls1 wsad"> 9. <span class="_ _6"></span><span class="ff15 ws1">T<span class="_ _1"></span>o look for s<span class="_ _0"></span>ecurity vulnerabilities in a program </span></div><div class="t m0 x1e hd y146 ff15 fs7 fc3 sc0 ls1 ws1">or piece of hardware<span class="fff">: Look at the Assembly code to </span></div><div class="t m0 x1e hd y147 fff fs7 fc3 sc0 ls1 ws1">do this<span class="_ _0"></span>; otherwis<span class="_ _0"></span>e you m<span class="_ _3"></span>ay not know wh<span class="_ _3"></span>at is r<span class="_ _3"></span>eally </div><div class="t m0 x1e hd y1b0 fff fs7 fc3 sc0 ls1 ws1">going on and hence where holes migh<span class="_ _3"></span>t exist.</div><div class="t m0 xc hd y149 fff fs7 fc3 sc0 ls1 wsae"> 10. <span class="_ _11"> </span><span class="ff15 ws1">T<span class="_ _6"></span>o lo<span class="_ _0"></span>ok for Easter eggs in programs<span class="fff">: These are </span></span></div><div class="t m0 x1e hd y14a fff fs7 fc3 sc0 ls1 ws1">hidden messages<span class="_ _3"></span>, images<span class="_ _3"></span>, or inside jokes that </div><div class="t m0 x1e hd y1e1 fff fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ammers hide in their progr<span class="_ _3"></span>ams. T<span class="_ _3"></span>hey are </div><div class="t m0 x1e hd y1e2 fff fs7 fc3 sc0 ls1 ws1">usually triggered by findin<span class="_ _3"></span>g a secret keyboar<span class="_ _3"></span>d </div><div class="t m0 x1e hd y1cd fff fs7 fc3 sc0 ls1 ws1">combination to pop them up<span class="_ _1"></span>. Finding them r<span class="_ _1"></span>equires </div><div class="t m0 x1e hd y1ce fff fs7 fc3 sc0 ls1 ws1">reverse engineering the pr<span class="_ _3"></span>ogram and r<span class="_ _3"></span>eading </div><div class="t m0 x1e hd y1cf fff fs7 fc3 sc0 ls1 ws1">Assembly Language<span class="_ _3"></span>.</div><div class="t m0 xd h15 y1e3 ff13 fsb fc3 sc0 ls1 wsaf"> T<span class="_ _8"></span>ools <span class="_ _12"> </span>Y<span class="_ _8"></span>ouNeed</div><div class="t m0 xd hd y1e4 fff fs7 fc3 sc0 ls1 ws1">The best way to learn pr<span class="_ _1"></span>ogramming is by doing. The easies<span class="_ _3"></span>t way to pla<span class="_ _3"></span>y </div><div class="t m0 xd hd y1e5 fff fs7 fc3 sc0 ls1 ws1">with 64-bit ARM Assembly Language is with an inexpensive single board </div><div class="t m0 xd hd y1e6 fff fs7 fc3 sc0 ls1 ws1">computer (SBC) like the Raspberry Pi or NVidia Jetson N<span class="_ _3"></span>ano<span class="_ _1"></span>. W<span class="_ _3"></span>e will  </div><div class="t m0 xd hd y1e7 fff fs7 fc3 sc0 ls1 ws1">cover developin<span class="_ _3"></span>g for Android and iOS<span class="_ _1"></span>, but these s<span class="_ _0"></span>ections ar<span class="_ _3"></span>e optional.  </div><div class="t m0 xd hd y1e8 fff fs7 fc3 sc0 ls1 ws1">In addition to a computer<span class="_ _10"></span>, you will need</div><div class="t m0 xa hd y1e9 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A text editor</div><div class="t m0 xa hd y1ea fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Some optional specialty progr<span class="_ _3"></span>ams</div><div class="t m0 xd ha y1eb ff13 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Raspberr<span class="_ _0"></span>y Pi 4 or NVidia Jetson Nano</div><div class="t m0 xd hd y1ec fff fs7 fc3 sc0 ls1 ws1">The Raspberry Pi 4 w<span class="_ _0"></span>ith 4GB of RAM is an excellent comput<span class="_ _3"></span>er to run 64-bit </div><div class="t m0 xd hd y1ed fff fs7 fc3 sc0 ls1 ws1">Linux. If you use a Raspberr<span class="_ _0"></span>y Pi 4, then you need to download and install </div><div class="t m0 xd hd y1ee fff fs7 fc3 sc0 ls1 ws1">a 64-bit version of Linux. These are a<span class="_ _3"></span>vailable fr<span class="_ _3"></span>om Kali, Ubun<span class="_ _3"></span>tu, Gentoo<span class="_ _1"></span>, </div><div class="t m0 xd hd y1ef fff fs7 fc3 sc0 ls1 ws1">Manj<span class="_ _1"></span>aro<span class="_ _3"></span>, and others<span class="_ _3"></span>. I find Kali Linux works very well and will be using  </div><div class="t m0 xd hd y1f0 fff fs7 fc3 sc0 ls1 ws1">it to test all the progr<span class="_ _3"></span>ams in this book. Y<span class="_ _6"></span>ou can find the Kali Linux </div><div class="t m0 xd h18 y1f1 fff fs7 fc3 sc0 lsd ws1">dow<span class="_ _0"></span>nload<span class="_ _0"></span>s her<span class="_ _3"></span>e: <span class="ff16 fc5 wsb0">www.offensive-security.com/kali-linux-arm-imag<span class="_ _0"></span>es/</span><span class="ls1">. </span></div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="http://www.offensive-security.com/kali-linux-arm-images/"><div class="d m1" style="border-style:none;position:absolute;left:115.342000px;bottom:87.317800px;width:265.804000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1c" class="pf w2 h6" data-page-no="1c"><div class="pc pc1c w2 h6"><div class="t m0 xf hd y3f fff fs7 fc3 sc0 ls1 ws1">7</div><div class="t m0 xc hd y145 fff fs7 fc3 sc0 ls1 ws1">Although you can run 64-bit Linux on a Raspberry Pi 3 or a Raspberr<span class="_ _0"></span>y Pi </div><div class="t m0 xc hd y146 fff fs7 fc3 sc0 ls1 ws1">4 with 1GB of RAM, I find these slow and bog down if you run too many </div><div class="t m0 xc hd y147 fff fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams. I wouldn’t r<span class="_ _1"></span>e<span class="_ _0"></span>commend these<span class="_ _3"></span>, but you can use them in a pinch<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1b0 fff fs7 fc3 sc0 ls1 ws1">The NVidia J<span class="_ _3"></span>etson N<span class="_ _3"></span>ano uses 64-bit Ubuntu Linux. This is an excellent </div><div class="t m0 xc hd y1b1 fff fs7 fc3 sc0 ls1 ws1">platform for learning ARM 64-bit Assembly Language<span class="_ _1"></span>. The Jetson N<span class="_ _3"></span>ano </div><div class="t m0 xc hd y1b2 fff fs7 fc3 sc0 ls1 ws1">also has 128 CUDA graphics pr<span class="_ _1"></span>ocessing cores that yo<span class="_ _3"></span>u can play with.</div><div class="t m0 x1c hd y1b3 fff fs7 fc3 sc0 ls1 ws1">One of the great things a<span class="_ _3"></span>bout the Linux operatin<span class="_ _3"></span>g system is that </div><div class="t m0 xc hd y1b4 fff fs7 fc3 sc0 ls1 ws1">it is intended to be used for programmin<span class="_ _3"></span>g and as a result h<span class="_ _3"></span>as many </div><div class="t m0 xc hd y1b5 fff fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming tools preinstalled, including</div><div class="t m0 x1e hd y1ce fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>GNU Compiler Collection (GCC) that we will use to </div><div class="t m0 x9 hd y1cf fff fs7 fc3 sc0 ls1 ws1">build our Assembly Langua<span class="_ _3"></span>ge programs<span class="_ _1"></span>. W<span class="_ _3"></span>e will use </div><div class="t m0 x9 hd y1b8 fff fs7 fc3 sc0 ls1 ws1">GCC for compiling C programs in l<span class="_ _3"></span>ater chapters<span class="_ _1"></span>.</div><div class="t m0 x1e hd y1d0 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>GNU Mak<span class="_ _3"></span>e to build our progr<span class="_ _1"></span>ams.</div><div class="t m0 x1e hd y1f2 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>GNU Debugger (GDB) to find and solve problems in </div><div class="t m0 x9 hd y1f3 fff fs7 fc3 sc0 ls1 ws1">our progr<span class="_ _3"></span>ams.</div><div class="t m0 xc ha y1f4 ff13 fs6 fc3 sc0 ls1 wsb1"> T<span class="_ _10"></span>e<span class="_ _3"></span>xt <span class="_ _14"> </span>Editor</div><div class="t m0 xc hd y1f5 fff fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou will ne<span class="_ _0"></span>ed a text editor to cr<span class="_ _1"></span>eate the source progr<span class="_ _3"></span>am files. An<span class="_ _3"></span>y text </div><div class="t m0 xc hd y1f6 fff fs7 fc3 sc0 ls1 ws1">editor can be used. Linux usually includes several by defa<span class="_ _3"></span>ult, both </div><div class="t m0 xc hd y1f7 fff fs7 fc3 sc0 ls1 ws1">command line and via the GUI.Usually, y<span class="_ _3"></span>ou learn Assembly Language </div><div class="t m0 xc hd y1f8 fff fs7 fc3 sc0 ls1 ws1">after you’<span class="_ _3"></span>ve alread<span class="_ _3"></span>y master<span class="_ _3"></span>ed a high-level language like C or J<span class="_ _1"></span>ava<span class="_ _1"></span>. S<span class="_ _0"></span>o<span class="_ _1"></span>, </div><div class="t m0 xc hd y1f9 fff fs7 fc3 sc0 ls1 ws1">chances ar<span class="_ _3"></span>e you alread<span class="_ _3"></span>y ha<span class="_ _3"></span>ve a fav<span class="_ _3"></span>orite editor and can continue to use it.</div><div class="t m0 xc ha y1ec ff13 fs6 fc3 sc0 ls1 wsb1"> Specialty <span class="_ _14"> </span>Programs</div><div class="t m0 xc hd y1fa fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will mention other helpful programs thr<span class="_ _3"></span>oughout the book that y<span class="_ _3"></span>ou can </div><div class="t m0 xc hd y1fb fff fs7 fc3 sc0 ls1 ws1">optionally use, b<span class="_ _3"></span>ut aren’t r<span class="_ _3"></span>equired, for example:</div><div class="t m0 x1e hd y1fc fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The Android SDK</div><div class="t m0 x1e hd y1fd fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Apple<span class="_ _3"></span>’<span class="_ _6"></span>s XCode IDE</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1d" class="pf w2 h6" data-page-no="1d"><div class="pc pc1d w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">8</div><div class="t m0 xa hd y145 fff fs7 fc3 sc0 lse wsb2">• <span class="_ _c"> </span><span class="ws1">A better code analysis tool, like Ghidra, which we will </span></div><div class="t m0 x1e hd y146 fff fs7 fc3 sc0 lse ws1">discuss in Chapter <span class="fc5 wsb2">15</span>, “Reading and U<span class="_ _3"></span>nderstanding Code”</div><div class="t m0 xc hd y1fe fff fs7 fc3 sc0 ls1 ws1">All of these are either open sour<span class="_ _3"></span>ce or free<span class="_ _3"></span>, but there m<span class="_ _3"></span>ay be some </div><div class="t m0 xd hd y148 fff fs7 fc3 sc0 ls1 ws1">restrictions on wher<span class="_ _3"></span>e you can install them<span class="_ _3"></span>.</div><div class="t m0 xc hd y149 fff fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we will switch gears to how computers repr<span class="_ _1"></span>es<span class="_ _0"></span>ent n<span class="_ _3"></span>umbers<span class="_ _3"></span>. W<span class="_ _1"></span>e </div><div class="t m0 xd hd y14a fff fs7 fc3 sc0 ls1 ws1">always hear th<span class="_ _3"></span>at computers only deal in zer<span class="_ _1"></span>os and ones<span class="_ _0"></span>; now we’ll look at </div><div class="t m0 xd hd y1e1 fff fs7 fc3 sc0 ls1 ws1">how they put them together to repr<span class="_ _1"></span>esent larger numbers.</div><div class="t m0 xd h15 y1ff ff13 fsb fc3 sc0 ls1 wsaf"> Computers <span class="_ _11"> </span>andNumbers</div><div class="t m0 xd hd y200 fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e typically represen<span class="_ _3"></span>t numbers using base 10. The common theory is we </div><div class="t m0 xd hd y201 fff fs7 fc3 sc0 ls1 ws1">do this, beca<span class="_ _3"></span>use we have ten fin<span class="_ _3"></span>gers to count with. This means a n<span class="_ _3"></span>umber </div><div class="t m0 xd hd y202 fff fs7 fc3 sc0 ls1 ws1">like 387 is really a r<span class="_ _1"></span>epresentation for</div><div class="t m0 xb h18 y203 ff16 fs7 fc3 sc0 ls1 ws1">387 = 3 * 10</div><div class="t m0 x21 h19 y204 ff16 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x22 h18 y205 ff16 fs7 fc3 sc0 ls1 ws1"> + 8 * 10</div><div class="t m0 x23 h19 y204 ff16 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x24 h18 y205 ff16 fs7 fc3 sc0 ls1 ws1"> + 7 * 10</div><div class="t m0 x25 h19 y204 ff16 fsd fc3 sc0 ls1 ws1">0</div><div class="t m0 xb h18 y206 ff16 fs7 fc3 sc0 ls1 ws1">    = 3 * 100 + 8 * 10 + 7</div><div class="t m0 xb h18 y207 ff16 fs7 fc3 sc0 ls1 ws1">    = 300 + 80 + 7</div><div class="t m0 xc hd y208 fff fs7 fc3 sc0 lsf ws1">There is nothin<span class="_ _3"></span>g special about using 10 as our base<span class="_ _3"></span>, and a fun exercise in </div><div class="t m0 xd hd y209 fff fs7 fc3 sc0 lsf ws1">math class is to do arithmetic using other bases<span class="_ _1"></span>. In fact, the Ma<span class="_ _3"></span>yan cultur<span class="_ _3"></span>e </div><div class="t m0 xd hd y20a fff fs7 fc3 sc0 lsf ws1">used base 20, perhaps because we ha<span class="_ _3"></span>ve 20 digits: ten fingers and ten toes.</div><div class="t m0 xc hd y20b fff fs7 fc3 sc0 ls1 ws1">Computers don’t ha<span class="_ _1"></span>ve fingers and toes<span class="_ _0"></span>; rather<span class="_ _10"></span>, ever<span class="_ _0"></span>ything is a switch </div><div class="t m0 xd hd y20c fff fs7 fc3 sc0 ls1 ws1">that is either on or off<span class="_ _3"></span>. As a result<span class="_ _3"></span>, computers ar<span class="_ _3"></span>e progr<span class="_ _3"></span>ammed to use base </div><div class="t m0 xd hd y20d fff fs7 fc3 sc0 ls1 ws1">2 arithmetic. Thus<span class="_ _3"></span>, a computer r<span class="_ _3"></span>ecognizes a number like 1011 as</div><div class="t m0 x26 h18 y20e ff16 fs7 fc3 sc0 ls1 ws1">1011 = 1 * 2</div><div class="t m0 x27 h19 y20f ff16 fsd fc3 sc0 ls1 ws1">3</div><div class="t m0 x28 h18 y210 ff16 fs7 fc3 sc0 ls1 ws1"> + 0 * 2</div><div class="t m0 x29 h19 y20f ff16 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x2a h18 y210 ff16 fs7 fc3 sc0 ls1 ws1"> + 1 * 2</div><div class="t m0 x2b h19 y20f ff16 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x2c h18 y210 ff16 fs7 fc3 sc0 ls1 ws1"> + 1 * 2</div><div class="t m0 x2d h19 y20f ff16 fsd fc3 sc0 ls1 ws1">0</div><div class="t m0 x26 h18 y211 ff16 fs7 fc3 sc0 ls1 ws1">     = 1 * 8 + 0 * 4 + 1 * 2 + 1</div><div class="t m0 x26 h18 y212 ff16 fs7 fc3 sc0 ls1 ws1">     = 8 + 0 + 2 + 1</div><div class="t m0 x26 h18 y213 ff16 fs7 fc3 sc0 ls1 ws1">     = 11 (decimal)</div><div class="t m0 xc hd y214 fff fs7 fc3 sc0 ls1 ws1">This is extr<span class="_ _3"></span>emely efficient for computers<span class="_ _1"></span>, but we are using four digits </div><div class="t m0 xd hd y215 fff fs7 fc3 sc0 ls1 ws1">for the decimal number 11 r<span class="_ _3"></span>ather than two digits<span class="_ _1"></span>. The big disadvantage for </div><div class="t m0 xd hd y216 fff fs7 fc3 sc0 ls1 ws1">humans is tha<span class="_ _3"></span>t writing, or even keyboardin<span class="_ _3"></span>g, binary numbers is tiring.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:167.108000px;bottom:561.362000px;width:10.560000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1e" class="pf w2 h6" data-page-no="1e"><div class="pc pc1e w2 h6"><img class="bi x2e y217 w5 h1a" alt="" src="bg1e.png"/><div class="t m0 xf hd y3f fff fs7 fc3 sc0 ls1 ws1">9</div><div class="t m0 x1c hd y145 fff fs7 fc3 sc0 ls1 ws1">Computers ar<span class="_ _3"></span>e incredibly structur<span class="_ _3"></span>ed, with their numbers being the </div><div class="t m0 xc hd y146 fff fs7 fc3 sc0 ls1 ws1">same size in stora<span class="_ _3"></span>ge used. When designing computers<span class="_ _3"></span>, it doesn’t make </div><div class="t m0 xc hd y147 fff fs7 fc3 sc0 ls1 ws1">sense to have differ<span class="_ _1"></span>ent sized numbers, so a few common sizes h<span class="_ _3"></span>av<span class="_ _3"></span>e taken </div><div class="t m0 xc hd y1b0 fff fs7 fc3 sc0 ls1 ws1">hold and become standard.</div><div class="t m0 x1c hd y1b1 fff fs7 fc3 sc0 ls1 ws1">A byte is 8 binary bits or digits. I<span class="_ _3"></span>n our preceding exam<span class="_ _3"></span>ple with 4 bits, </div><div class="t m0 xc hd y218 fff fs7 fc3 sc0 ls1 ws1">there ar<span class="_ _3"></span>e 16 possible combina<span class="_ _3"></span>tions of 0s and 1s. This me<span class="_ _3"></span>ans 4 bits can </div><div class="t m0 xc hd y219 fff fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esent the numbers 0 to 15. T<span class="_ _3"></span>his means it can be repr<span class="_ _1"></span>es<span class="_ _0"></span>en<span class="_ _3"></span>ted by one </div><div class="t m0 xc hd y1b4 fff fs7 fc3 sc0 ls1 ws1">base 16 digit. Base 16 digits ar<span class="_ _3"></span>e repr<span class="_ _1"></span>esented by the numbers 0–9 and then </div><div class="t m0 xc hd y1b5 fff fs7 fc3 sc0 ls1 ws1">the letters A<span class="_ _1"></span>–F for 10–15. W<span class="_ _1"></span>e can then represen<span class="_ _3"></span>t a byte (8 bits) as two base </div><div class="t m0 xc hd y1b6 fff fs7 fc3 sc0 ls1 ws1">16 digits. W<span class="_ _1"></span>e r<span class="_ _3"></span>efer to base 16 numbers as hexadecimal (F<span class="_ _3"></span>igur<span class="_ _3"></span>e<span class="fc5">1-1</span>).</div><div class="t m0 x1c hd y21a fff fs7 fc3 sc0 ls1 ws1">Since a byte holds 8 bits<span class="_ _1"></span>, it can represent 2</div><div class="t m0 x2c h1b y21b fff fsd fc3 sc0 ls1 ws1">8</div><div class="t m0 x2f hd y21c fff fs7 fc3 sc0 ls1 ws1"> (256) numbers<span class="_ _3"></span>. Thus<span class="_ _1"></span>, the </div><div class="t m0 xc hd y21d fff fs7 fc3 sc0 ls1 ws1">byte e6 r<span class="_ _3"></span>epresents</div><div class="t m0 x27 h18 y21e ff16 fs7 fc3 sc0 ls1 ws1">e6 = e * 16</div><div class="t m0 x30 h19 y21f ff16 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x31 h18 y220 ff16 fs7 fc3 sc0 ls1 ws1"> + 6 * 16</div><div class="t m0 x32 h19 y21f ff16 fsd fc3 sc0 ls1 ws1">0</div><div class="t m0 x33 h18 y221 ff16 fs7 fc3 sc0 ls1 ws1">   = 14 * 16 + 6</div><div class="t m0 x33 h18 y222 ff16 fs7 fc3 sc0 ls1 ws1">   = 230 (decimal)</div><div class="t m0 x33 h18 y223 ff16 fs7 fc3 sc0 ls1 ws1">   = 1110 0110 (binary)</div><div class="t m0 x1c hd y224 fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e call a 32-bit quantity a word and it is r<span class="_ _3"></span>epresented b<span class="_ _3"></span>y 4 bytes<span class="_ _1"></span>. Y<span class="_ _1"></span>ou </div><div class="t m0 xc hd y225 fff fs7 fc3 sc0 ls1 ws1">might see a string like B6 A4 44 04 as a r<span class="_ _3"></span>epresenta<span class="_ _3"></span>tion of 32 bits of memory, </div><div class="t m0 xc hd y226 fff fs7 fc3 sc0 ls1 ws1">or one word of memory, or the contents of one register<span class="_ _10"></span>. Even though we </div><div class="t m0 xc hd y227 fff fs7 fc3 sc0 ls1 ws1">are running 64 bits<span class="_ _3"></span>, the ARM refer<span class="_ _1"></span>ence documentation refers to a wor<span class="_ _3"></span>d as </div><div class="t m0 xc hd y228 fff fs7 fc3 sc0 ls1 ws1">32 bits, a h<span class="_ _3"></span>alfword is 16 bits<span class="_ _3"></span>, and a doubleword is 64 bits<span class="_ _1"></span>. We will see this </div><div class="t m0 xc hd y229 fff fs7 fc3 sc0 ls1 ws1">terminology throughout this book and the ARM documentation.</div><div class="t m0 x1c hd y22a fff fs7 fc3 sc0 ls1 ws1">If this is confusing or scary, don’t wor<span class="_ _0"></span>ry. The tools will do all the </div><div class="t m0 xc hd y22b fff fs7 fc3 sc0 ls1 ws1">conversions for yo<span class="_ _3"></span>u. It’<span class="_ _6"></span>s just a matter of unders<span class="_ _3"></span>tanding what is pr<span class="_ _1"></span>es<span class="_ _0"></span>ented to </div><div class="t m0 xc hd y22c fff fs7 fc3 sc0 ls1 ws1">you on screen. Also<span class="_ _1"></span>, if you need to specify an exact binary number<span class="_ _6"></span>, usually </div><div class="t m0 xc hd y22d fff fs7 fc3 sc0 ls1 ws1">you do so in hexadecimal, although all the tools accept all the formats<span class="_ _1"></span>.</div><div class="t m0 xc h1c y22e ff17 fs3 fc3 sc0 ls1 ws1">Figure 1-1. <span class="_ _15"> </span><span class="ff10">Representin<span class="_ _3"></span>g hexadecimal digits</span></div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf1e" data-dest-detail='[30,"XYZ",53,420,null]'><div class="d m1" style="border-style:none;position:absolute;left:342.713000px;bottom:433.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1f" class="pf w2 h6" data-page-no="1f"><div class="pc pc1f w2 h6"><img class="bi x2 y22f w6 h1d" alt="" src="bg1f.png"/><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">10</div><div class="t m0 xc hd y145 fff fs7 fc3 sc0 ls1 ws1">A handy tool is the Linux Gnome calculat<span class="_ _3"></span>or (Figur<span class="_ _1"></span>e<span class="fc5">1-2</span>). The Gnome </div><div class="t m0 xd hd y146 fff fs7 fc3 sc0 ls1 ws1">calculator has a nice pr<span class="_ _1"></span>ogramming mode which shows a number’<span class="_ _6"></span>s </div><div class="t m0 xd hd y147 fff fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esentation in multiple b<span class="_ _3"></span>ases at once. This c<span class="_ _3"></span>alculator is installed in </div><div class="t m0 xd hd y1b0 fff fs7 fc3 sc0 ls1 ws1">Ubuntu Linux, if you are running the Gnome desk<span class="_ _1"></span>top. H<span class="_ _3"></span>owever<span class="_ _10"></span>, if you </div><div class="t m0 xd hd y1b1 fff fs7 fc3 sc0 ls1 ws1">don’t ha<span class="_ _3"></span>ve it, it is easy to add. If yo<span class="_ _3"></span>u are running a Debian-derived Linux </div><div class="t m0 xd hd y218 fff fs7 fc3 sc0 ls1 ws1">like Ubuntu or K<span class="_ _1"></span>ali, to install it, use the command line:</div><div class="t m0 xd h18 y230 ff16 fs7 fc3 sc0 ls1 ws1">sudo apt-get install gnome-calculator</div><div class="t m0 xc hd y231 fff fs7 fc3 sc0 ls1 ws1">Run it fr<span class="_ _1"></span>om the Accessories menu. If you put it in “Programmer M<span class="_ _1"></span>ode,<span class="_ _8"></span>” </div><div class="t m0 xd hd y232 fff fs7 fc3 sc0 ls1 ws1">you can do the con<span class="_ _3"></span>versions, and it sho<span class="_ _3"></span>ws you num<span class="_ _3"></span>bers in several formats </div><div class="t m0 xd hd y233 fff fs7 fc3 sc0 ls1 ws1">at once.</div><div class="t m0 xd h1c y234 ff17 fs3 fc3 sc0 ls1 ws1">Figure 1-2. <span class="_ _15"> </span><span class="ff10">The Gnome calculator</span></div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf1f" data-dest-detail='[31,"XYZ",35,402,null]'><div class="d m1" style="border-style:none;position:absolute;left:294.325000px;bottom:577.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf20" class="pf w2 h6" data-page-no="20"><div class="pc pc20 w2 h6"><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">11</div><div class="t m0 x1c hd y145 fff fs7 fc3 sc0 ls1 ws1">This is how we repr<span class="_ _1"></span>esent computer memor<span class="_ _0"></span>y. Ther<span class="_ _1"></span>e is a bit more </div><div class="t m0 xc hd y146 fff fs7 fc3 sc0 ls1 ws1">complexity in how signed integers ar<span class="_ _3"></span>e repr<span class="_ _3"></span>esented and how arithmetic </div><div class="t m0 xc hd y147 fff fs7 fc3 sc0 ls1 ws1">works<span class="_ _3"></span>. W<span class="_ _1"></span>e’ll cover this in Ch<span class="_ _3"></span>apter <span class="fc5">2</span>, “Loading and Adding.<span class="_ _8"></span>”</div><div class="t m0 x1c hd y1b0 fff fs7 fc3 sc0 ls1 ws1">In the Assembler we r<span class="_ _3"></span>epresent hexadecimal n<span class="_ _3"></span>umbers (hex for short) </div><div class="t m0 xc hd y1b1 fff fs7 fc3 sc0 ls1 ws1">with a 0x in front, so 0x1B is ho<span class="_ _3"></span>w to specify the hex number 1B.</div><div class="t m0 xc h15 y235 ff13 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>ARM Assembly Instructions</div><div class="t m0 xc hd y236 fff fs7 fc3 sc0 ls1 ws1">In this section, we introduce some basic ar<span class="_ _1"></span>chitectural elements of the ARM </div><div class="t m0 xc hd y237 fff fs7 fc3 sc0 ls1 ws1">processor and start to look at the form of its machine code instructions<span class="_ _3"></span>. </div><div class="t m0 xc hd y238 fff fs7 fc3 sc0 ls1 ws1">The ARM is what is c<span class="_ _3"></span>alled a RISC computer<span class="_ _6"></span>, which theoretically will make </div><div class="t m0 xc hd y239 fff fs7 fc3 sc0 ls1 ws1">learning Assembly easier<span class="_ _10"></span>. There are fewer instructions and each one is </div><div class="t m0 xc hd y23a fff fs7 fc3 sc0 ls1 ws1">simple, so the pr<span class="_ _1"></span>o<span class="_ _0"></span>cessor can execute eac<span class="_ _3"></span>h instruction quickly.</div><div class="t m0 x1c hd y23b fff fs7 fc3 sc0 ls1 ws1">In the first few cha<span class="_ _3"></span>pters of this book, we will cover the 64-bit standar<span class="_ _3"></span>d </div><div class="t m0 xc hd y23c fff fs7 fc3 sc0 ls1 ws1">ARM Assembly instructions. This means th<span class="_ _3"></span>at the following topics ar<span class="_ _1"></span>e </div><div class="t m0 xc hd y23d fff fs7 fc3 sc0 ls1 ws1">deferred to later ch<span class="_ _3"></span>apters where they can be co<span class="_ _1"></span>vered in detail without </div><div class="t m0 xc hd y23e fff fs7 fc3 sc0 ls1 ws1">introducin<span class="_ _3"></span>g too much confusion:</div><div class="t m0 x1e hd y23f fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Inter<span class="_ _3"></span>acting with other progr<span class="_ _3"></span>amming languages</div><div class="t m0 x1e hd y240 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Accessing h<span class="_ _3"></span>ardwar<span class="_ _1"></span>e devices</div><div class="t m0 x1e hd y241 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Instructions for the floating-<span class="_ _1"></span>point processor</div><div class="t m0 x1e hd y242 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Instructions for the NEON processor</div><div class="t m0 x1c hd y243 fff fs7 fc3 sc0 ls1 ws1">In technical computer t<span class="_ _3"></span>opics, ther<span class="_ _1"></span>e are often chicken and egg </div><div class="t m0 xc hd y244 fff fs7 fc3 sc0 ls1 ws1">problems in pr<span class="_ _3"></span>esenting the ma<span class="_ _3"></span>terial. The purpose of this section is </div><div class="t m0 xc hd y245 fff fs7 fc3 sc0 ls1 ws1">to intr<span class="_ _3"></span>oduce all the terms and ideas we will us<span class="_ _0"></span>e la<span class="_ _3"></span>ter<span class="_ _6"></span>. Hopefully, this </div><div class="t m0 xc hd y246 fff fs7 fc3 sc0 ls1 ws1">introduces all the terms<span class="_ _1"></span>, s<span class="_ _0"></span>o they ar<span class="_ _3"></span>e familiar when we cover them in full </div><div class="t m0 xc hd y247 fff fs7 fc3 sc0 ls1 ws1">detail.</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:211.838000px;bottom:545.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf21" class="pf w2 h6" data-page-no="21"><div class="pc pc21 w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">12</div><div class="t m0 xd ha y248 ff13 fs6 fc3 sc0 ls1 wsb1"> CPU <span class="_ _14"> </span>Registers</div><div class="t m0 xd hd y249 fff fs7 fc3 sc0 ls1 ws1">In all computers<span class="_ _1"></span>, data is not operated in the computer’<span class="_ _6"></span>s memor<span class="_ _0"></span>y; instead </div><div class="t m0 xd hd y24a fff fs7 fc3 sc0 ls1 ws1">it’<span class="_ _1"></span>s loaded into a CPU r<span class="_ _3"></span>egister<span class="_ _6"></span>, then the data pr<span class="_ _3"></span>ocessing or arithmetic </div><div class="t m0 xd hd y24b fff fs7 fc3 sc0 ls1 ws1">operation is performed in the registers<span class="_ _1"></span>. The registers are part of the </div><div class="t m0 xd hd y24c fff fs7 fc3 sc0 ls1 ws1">CPU circuitry allowing instant access<span class="_ _3"></span>, whereas memory is a separate </div><div class="t m0 xd hd y24d fff fs7 fc3 sc0 ls1 ws1">component and ther<span class="_ _3"></span>e is a transfer time for the CPU to access it.</div><div class="t m0 xc hd y24e fff fs7 fc3 sc0 ls1 ws1">The ARM processor is based on a load-<span class="_ _1"></span>store architectur<span class="_ _3"></span>e where ther<span class="_ _1"></span>e </div><div class="t m0 xd hd y24f fff fs7 fc3 sc0 ls1 ws1">are two basic types of instructions<span class="_ _0"></span>:</div><div class="t m0 xc hd y250 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Instructions that either load memory into registers </div><div class="t m0 x1e hd y251 fff fs7 fc3 sc0 ls1 ws1">or instructions that stor<span class="_ _3"></span>e data fr<span class="_ _3"></span>om registers in<span class="_ _3"></span>to </div><div class="t m0 x1e hd y252 fff fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc hd y253 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Instructions that perform arithmetical or logical </div><div class="t m0 x1e hd y254 fff fs7 fc3 sc0 ls1 ws1">operations between two registers</div><div class="t m0 xc hd y255 fff fs7 fc3 sc0 ls1 ws1">If you want to add two num<span class="_ _3"></span>bers, yo<span class="_ _3"></span>u might do the following:</div><div class="t m0 xc hd y256 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Load one into one register and the other into </div><div class="t m0 x1e hd y257 fff fs7 fc3 sc0 ls1 ws1">another register<span class="_ _10"></span>.</div><div class="t m0 xc hd y258 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Perform the add operation putting the r<span class="_ _1"></span>esult into a </div><div class="t m0 x1e hd y259 fff fs7 fc3 sc0 ls1 ws1">third r<span class="_ _1"></span>e<span class="_ _0"></span>gister<span class="_ _10"></span>.</div><div class="t m0 xc hd y25a fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Copy the answer from the r<span class="_ _1"></span>esults register into </div><div class="t m0 x1e hd y25b fff fs7 fc3 sc0 ls1 ws1">memory.</div><div class="t m0 xc hd y25c fff fs7 fc3 sc0 ls1 ws1">As you can see, it tak<span class="_ _3"></span>es quite a few instructions to perform simple </div><div class="t m0 xd hd y25d fff fs7 fc3 sc0 ls1 ws1">operations<span class="_ _1"></span>.</div><div class="t m0 xc hd y25e fff fs7 fc3 sc0 ls1 ws1">A 64-bit progr<span class="_ _3"></span>am on an ARM processor in user mode has access to 31 </div><div class="t m0 xd hd y25f fff fs7 fc3 sc0 ls1 ws1">general-<span class="_ _1"></span>purpose registers, a pr<span class="_ _3"></span>ogram coun<span class="_ _3"></span>ter (PC), and a combination </div><div class="t m0 xd hd y260 fff fs7 fc3 sc0 ls1 ws1">zero r<span class="_ _1"></span>egister/stack pointer<span class="_ _0"></span>:</div><div class="t m0 xa hd y261 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff15">X0</span>–<span class="ff15">X30</span>: These 31 registers ar<span class="_ _1"></span>e general purpose; you </div><div class="t m0 x1e hd y262 fff fs7 fc3 sc0 ls1 ws1">can use them for anything you lik<span class="_ _3"></span>e, though some ha<span class="_ _1"></span>ve </div><div class="t m0 x1e hd y263 fff fs7 fc3 sc0 ls1 ws1">standard agr<span class="_ _1"></span>eed-up<span class="_ _0"></span>on usage th<span class="_ _3"></span>at we will cover lat<span class="_ _3"></span>er<span class="_ _6"></span>.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf22" class="pf w2 h6" data-page-no="22"><div class="pc pc22 w2 h6"><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">13</div><div class="t m0 x1e hd y145 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff15">SP<span class="_ _10"></span>, X<span class="_ _0"></span>ZR<span class="fff">: The stack pointer or zero r<span class="_ _1"></span>egister depending </span></span></div><div class="t m0 x9 hd y146 fff fs7 fc3 sc0 ls1 ws1">on the context.</div><div class="t m0 x1e hd y1fe fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff15">X30, LR</span>: The link register<span class="_ _10"></span>. If you call a function, this </div><div class="t m0 x9 hd y148 fff fs7 fc3 sc0 ls1 ws1">register will be used to hold the return addr<span class="_ _1"></span>ess. As this </div><div class="t m0 x9 hd y149 fff fs7 fc3 sc0 ls1 ws1">is a common operation, yo<span class="_ _3"></span>u should av<span class="_ _3"></span>oid using this </div><div class="t m0 x9 hd y14a fff fs7 fc3 sc0 ls1 ws1">register for other things<span class="_ _1"></span>.</div><div class="t m0 x1e hd y14b fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff15 ls10 ws37">PC</span>: The pr<span class="_ _1"></span>ogram counter<span class="_ _6"></span>. The memory address of the </div><div class="t m0 x9 hd y14c fff fs7 fc3 sc0 ls1 ws1">currently executin<span class="_ _3"></span>g instruction.</div><div class="t m0 x1c hd y14d fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e don’t always need the full 64 bits of data in a register<span class="_ _10"></span>. Often 32 bits </div><div class="t m0 xc hd y14e fff fs7 fc3 sc0 ls1 ws1">is fine. All the <span class="ff15">X</span> r<span class="_ _1"></span>e<span class="_ _0"></span>gisters c<span class="_ _3"></span>an be operated on as 32-bit r<span class="_ _3"></span>egisters by r<span class="_ _3"></span>eferring </div><div class="t m0 xc hd y264 fff fs7 fc3 sc0 ls1 ws1">to them as <span class="ff15">W0</span>–<span class="ff15">W30</span> and <span class="ff15 ls7 ws6f">WZR</span>. When we do this, the instruction will use </div><div class="t m0 xc hd y265 fff fs7 fc3 sc0 ls1 ws1">the lower 32 bits of the register and set the upper 32 bits to zer<span class="_ _1"></span>o. Us<span class="_ _3"></span>ing 32 </div><div class="t m0 xc hd y266 fff fs7 fc3 sc0 ls1 ws1">bits sav<span class="_ _3"></span>es memory, since you only use 4 bytes rather than 8 b<span class="_ _1"></span>ytes for each </div><div class="t m0 xc hd y1f2 fff fs7 fc3 sc0 ls1 ws1">quantity sa<span class="_ _3"></span>ved. Most loop coun<span class="_ _3"></span>ters and other common variables used in </div><div class="t m0 xc hd y267 fff fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming easily fit in 4 bytes<span class="_ _1"></span>, so this is made easy by the processor<span class="_ _10"></span>.</div><div class="t m0 x1c hd y268 fff fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e a large set of registers for the coprocessors<span class="_ _3"></span>, but we’ll co<span class="_ _3"></span>ver </div><div class="t m0 xc hd y269 fff fs7 fc3 sc0 ls1 ws1">these when we get to programming these copr<span class="_ _1"></span>o<span class="_ _0"></span>cessors in Cha<span class="_ _3"></span>pter <span class="fc5">12</span>, </div><div class="t m0 xc hd y26a fff fs7 fc3 sc0 ls1 ws1">“Floating-P<span class="_ _3"></span>oint Opera<span class="_ _3"></span>tions,<span class="_ _8"></span>” and Ch<span class="_ _3"></span>apter <span class="fc5">13</span>, “Neon Copr<span class="_ _1"></span>o<span class="_ _0"></span>cessor<span class="_ _10"></span>.<span class="_ _8"></span>”</div><div class="t m0 xc ha y26b ff13 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>ARM Instruction Format</div><div class="t m0 xc hd y26c fff fs7 fc3 sc0 ls1 ws1">Each ARM binary instruction is 32 bits long. Fitting all the information </div><div class="t m0 xc hd y26d fff fs7 fc3 sc0 ls1 ws1">for an instruction into 32 bits is quite an accomplishment r<span class="_ _1"></span>e<span class="_ _0"></span>quiring using </div><div class="t m0 xc hd y26e fff fs7 fc3 sc0 ls1 ws1">every bit to tell the processor what to do<span class="_ _1"></span>. There ar<span class="_ _3"></span>e quite a few instruction </div><div class="t m0 xc hd y26f fff fs7 fc3 sc0 ls1 ws1">formats<span class="_ _3"></span>, and it can be helpful to know how the bits for each instruction ar<span class="_ _3"></span>e </div><div class="t m0 xc hd y270 fff fs7 fc3 sc0 ls1 ws1">packed into 32 bits<span class="_ _1"></span>. Since there are 32 r<span class="_ _1"></span>e<span class="_ _0"></span>gisters (the 31 gener<span class="_ _3"></span>al-<span class="_ _3"></span>purpose </div><div class="t m0 xc hd y271 fff fs7 fc3 sc0 ls1 ws1">registers plus the stac<span class="_ _3"></span>k pointer (<span class="ff15">SP</span>)/zer<span class="_ _3"></span>o register (<span class="ff15 ls7 ws6f">XZR</span>)), it takes 5 bits to </div><div class="t m0 xc hd y272 fff fs7 fc3 sc0 ls1 ws1">specify a register<span class="_ _10"></span>. Thus, if you need thr<span class="_ _3"></span>ee registers<span class="_ _1"></span>, then 15 bits is taken up </div><div class="t m0 xc hd y273 fff fs7 fc3 sc0 ls1 ws1">specifying these.</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:363.558000px;bottom:303.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:249.270000px;bottom:287.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf23" class="pf w2 h6" data-page-no="23"><div class="pc pc23 w2 h6"><img class="bi xd y274 w7 h1e" alt="" src="bg23.png"/><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">14</div><div class="t m0 xc hd y275 fff fs7 fc3 sc0 ls1 ws1">Ha<span class="_ _1"></span>ving small fixed length instructions allows the ARM processor to </div><div class="t m0 xd hd y276 fff fs7 fc3 sc0 ls1 ws1">load multiple instructions quickly. I<span class="_ _3"></span>t doesn’t need to start decoding an </div><div class="t m0 xd hd y277 fff fs7 fc3 sc0 ls1 ws1">instruction to know how long it is and hence wher<span class="_ _3"></span>e the next instruction </div><div class="t m0 xd hd y278 fff fs7 fc3 sc0 ls1 ws1">starts. This is a key fea<span class="_ _3"></span>ture to allo<span class="_ _3"></span>wing processing par<span class="_ _1"></span>allelism and </div><div class="t m0 xd hd y279 fff fs7 fc3 sc0 ls1 ws1">efficiency.</div><div class="t m0 xc hd y27a fff fs7 fc3 sc0 ls1 ws1">Each instruction that takes r<span class="_ _1"></span>e<span class="_ _0"></span>gisters c<span class="_ _3"></span>an either use the 32-bit <span class="ff15">W</span> version </div><div class="t m0 xd hd y27b fff fs7 fc3 sc0 ls1 ws1">or the 64-bit <span class="ff15">Z</span> version. T<span class="_ _6"></span>o specify which is the case, the high bit of each </div><div class="t m0 xd hd y27c fff fs7 fc3 sc0 ls1 ws1">instruction specifies how we are viewing the regist<span class="_ _3"></span>ers.</div><div class="t m0 x34 h1f y27d ff13 fse fc3 sc0 ls1 ws1">Note<span class="ff14"> <span class="_ _17"> </span>All the registers in a single instruction need to be the same—</span></div><div class="t m0 x34 h1f y27e ff14 fse fc3 sc0 ls1 ws1">you can’t mix <span class="ff13">W</span> and <span class="ff13">Z</span> registers.</div><div class="t m0 xc hd y27f fff fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o give you an idea for data pr<span class="_ _3"></span>ocessing instructions, let’<span class="_ _6"></span>s consider the </div><div class="t m0 xd hd y280 fff fs7 fc3 sc0 ls1 ws1">format for a common class of instructions that we<span class="_ _3"></span>’ll deal with early on. </div><div class="t m0 xd hd y281 fff fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure<span class="fc5">1-3</span> shows the forma<span class="_ _3"></span>t of the instruction and what the bits specify.</div><div class="t m0 xc hd y282 fff fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at each of these fields<span class="_ _0"></span>:</div><div class="t m0 xa hd y283 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Bits: If this bit is zero<span class="_ _1"></span>, then any registers are in<span class="_ _3"></span>terpreted </div><div class="t m0 x1e hd y284 fff fs7 fc3 sc0 ls1 ws1">as the 32-bit <span class="ff15">W</span> version. If this bit is one, then they ar<span class="_ _1"></span>e </div><div class="t m0 x1e hd y285 fff fs7 fc3 sc0 ls1 ws1">the full 64-bit <span class="ff15">X</span> version of the register<span class="_ _10"></span>.</div><div class="t m0 xa hd y286 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Opcode: Which instruction are we performing, like </div><div class="t m0 x1e hd y287 fff fs7 fc3 sc0 ls1 ws1">ADD or MUL<span class="_ _0"></span>.</div><div class="t m0 xa hd y288 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Shift<span class="_ _0"></span>: These two bits specify shifting operations that </div><div class="t m0 x1e hd y289 fff fs7 fc3 sc0 ls1 ws1">could be applied to the data<span class="_ _3"></span>.</div><div class="t m0 xd h1c y28a ff17 fs3 fc3 sc0 ls1 ws1">Figure 1-3. <span class="_ _15"> </span><span class="ff10">Ins<span class="_ _3"></span>truction format for d<span class="_ _0"></span>ata pr<span class="_ _3"></span>ocessing instructions</span></div><div class="t m0 xd h12 y28b ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf23" data-dest-detail='[35,"XYZ",35,330,null]'><div class="d m1" style="border-style:none;position:absolute;left:68.031500px;bottom:344.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf24" class="pf w2 h6" data-page-no="24"><div class="pc pc24 w2 h6"><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">15</div><div class="t m0 x1e hd y145 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Set condition code: This is a single bit indicating if </div><div class="t m0 x9 hd y146 fff fs7 fc3 sc0 ls1 ws1">this instruction should update any condition flags<span class="_ _1"></span>. If </div><div class="t m0 x9 hd y147 fff fs7 fc3 sc0 ls1 ws1">we don’t want the res<span class="_ _3"></span>ult of this instruction to affect </div><div class="t m0 x9 hd y1b0 fff fs7 fc3 sc0 ls1 ws1">following branch instructions<span class="_ _3"></span>, we would set it to 0.</div><div class="t m0 x1e hd y149 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Rm, Rn: Oper<span class="_ _3"></span>and registers to use as input<span class="_ _3"></span>.</div><div class="t m0 x1e hd y28c fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Rd (<span class="_ _1"></span>destination register): Wher<span class="_ _3"></span>e to put the res<span class="_ _3"></span>ult of </div><div class="t m0 x9 hd y14b fff fs7 fc3 sc0 ls1 ws1">whatever this instruction does<span class="_ _3"></span>.</div><div class="t m0 x1e hd y28d fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Imm6: An immediate operand which is usually a </div><div class="t m0 x9 hd y28e fff fs7 fc3 sc0 ls1 ws1">small bit of data tha<span class="_ _3"></span>t you can specify dir<span class="_ _3"></span>ectly in the </div><div class="t m0 x9 hd y28f fff fs7 fc3 sc0 ls1 ws1">instruction. So<span class="_ _3"></span>, if you want to add 1 to a r<span class="_ _1"></span>egister<span class="_ _6"></span>, you </div><div class="t m0 x9 hd y264 fff fs7 fc3 sc0 ls1 ws1">could ha<span class="_ _1"></span>ve this as 1, rather than putting 1in another </div><div class="t m0 x9 hd y265 fff fs7 fc3 sc0 ls1 ws1">register and adding the two r<span class="_ _1"></span>e<span class="_ _0"></span>gisters<span class="_ _1"></span>. These are usually </div><div class="t m0 x9 hd y266 fff fs7 fc3 sc0 ls1 ws1">the bits left over after everything else is specified.</div><div class="t m0 x1c hd y290 fff fs7 fc3 sc0 ls1 ws1">When things are running well, each instruction executes in one clock </div><div class="t m0 xc hd y291 fff fs7 fc3 sc0 ls1 ws1">cycle. An instruction in isolation takes thr<span class="_ _3"></span>ee clock cycles, namely, one to </div><div class="t m0 xc hd y292 fff fs7 fc3 sc0 ls1 ws1">load the instruction from memory, one to decode the instruction, and </div><div class="t m0 xc hd y293 fff fs7 fc3 sc0 ls1 ws1">then one to execute the instruction. The ARM is smart and works on thr<span class="_ _3"></span>ee </div><div class="t m0 xc hd y294 fff fs7 fc3 sc0 ls1 ws1">instructions at a time, each a<span class="_ _3"></span>t a differen<span class="_ _3"></span>t step in the process<span class="_ _1"></span>, called the </div><div class="t m0 xc hd y295 fff fs7 fc3 sc0 ls1 ws1">instruction pipeline. If you h<span class="_ _3"></span>ave a linear bloc<span class="_ _3"></span>k of instructions, they all </div><div class="t m0 xc hd y296 fff fs7 fc3 sc0 ls1 ws1">execute on av<span class="_ _3"></span>erage taking one clock cycle<span class="_ _3"></span>.</div><div class="t m0 x1c hd y297 fff fs7 fc3 sc0 ls1 ws1">In modern ARM processors<span class="_ _1"></span>, the execution pipeline is much more </div><div class="t m0 xc hd y298 fff fs7 fc3 sc0 ls1 ws1">sophisticated and can be working on mor<span class="_ _1"></span>e than three instructions at </div><div class="t m0 xc hd y299 fff fs7 fc3 sc0 ls1 ws1">a time. Some instructions like integer division take lon<span class="_ _3"></span>ger<span class="_ _6"></span>, and if the </div><div class="t m0 xc hd y29a fff fs7 fc3 sc0 ls1 ws1">following instructions don’t rely on the r<span class="_ _1"></span>esult, then these instructions can </div><div class="t m0 xc hd y1dc fff fs7 fc3 sc0 ls1 ws1">execute in parallel to the division pr<span class="_ _1"></span>ocess. Other instructions might stall, </div><div class="t m0 xc hd y1dd fff fs7 fc3 sc0 ls1 ws1">for instance, when waitin<span class="_ _3"></span>g for memory to be loade<span class="_ _0"></span>d, ag<span class="_ _3"></span>ain the process </div><div class="t m0 xc hd y1de fff fs7 fc3 sc0 ls1 ws1">can perform other instructions that don’t depend on the result while </div><div class="t m0 xc hd y1df fff fs7 fc3 sc0 ls1 ws1">the memory controller fetches the memory—this is called out-of<span class="_ _3"></span>-order </div><div class="t m0 xc hd y1e0 fff fs7 fc3 sc0 ls1 ws1">execution.</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf25" class="pf w2 h6" data-page-no="25"><div class="pc pc25 w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">16</div><div class="t m0 xd ha y248 ff13 fs6 fc3 sc0 ls1 wsb1"> Computer <span class="_ _14"> </span>Memor<span class="_ _0"></span>y</div><div class="t m0 xd hd y249 fff fs7 fc3 sc0 ls1 ws1">Progr<span class="_ _3"></span>ams are loaded fr<span class="_ _3"></span>om the computer’<span class="_ _6"></span>s disk dr<span class="_ _0"></span>ive device into memory </div><div class="t m0 xd hd y24a fff fs7 fc3 sc0 ls1 ws1">and executed. The memory holds the program, alon<span class="_ _3"></span>g with any data or </div><div class="t m0 xd hd y24b fff fs7 fc3 sc0 ls1 ws1">variables associated with it. This memory isn’t as fast as the CPU registers<span class="_ _3"></span>, </div><div class="t m0 xd hd y24c fff fs7 fc3 sc0 ls1 ws1">but it’<span class="_ _6"></span>s much faster than accessing data stor<span class="_ _1"></span>e<span class="_ _0"></span>d on an SSD drive or CF car<span class="_ _3"></span>d.</div><div class="t m0 xc hd y24d fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve talk<span class="_ _3"></span>ed a lot about 64-bit mode, b<span class="_ _3"></span>ut what is it? Wha<span class="_ _3"></span>t 64-bit mode </div><div class="t m0 xd hd y24e fff fs7 fc3 sc0 ls1 ws1">really means is</div><div class="t m0 xa hd y29b fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Memory addresses are specified using 64 bits<span class="_ _1"></span>.</div><div class="t m0 xa hd y29c fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The CPU registers ar<span class="_ _1"></span>e each 64 bits w<span class="_ _0"></span>ide and perform </div><div class="t m0 x1e hd y29d fff fs7 fc3 sc0 ls1 ws1">64-bit integer arithmetic.</div><div class="t m0 xc hd y29e fff fs7 fc3 sc0 ls1 ws1">Instructions are 32 bits in siz<span class="_ _3"></span>e. The in<span class="_ _3"></span>tent is to keep these as small as </div><div class="t m0 xd hd y29f fff fs7 fc3 sc0 ls1 ws1">possible, so the ARM pr<span class="_ _3"></span>ocessor can execute them quickly and efficiently. </div><div class="t m0 xd hd y2a0 fff fs7 fc3 sc0 ls1 ws1">This is true when the ARM processor runs in either 32-bit or 64-bit mode.</div><div class="t m0 xc hd y255 fff fs7 fc3 sc0 ls1 ws1">If we want to load a r<span class="_ _3"></span>egister from a kno<span class="_ _3"></span>wn 64-bit memor<span class="_ _0"></span>y addr<span class="_ _3"></span>ess, </div><div class="t m0 xd hd y2a1 fff fs7 fc3 sc0 ls1 ws1">for example, a v<span class="_ _3"></span>ariable we will use in a computation, how do we do this? </div><div class="t m0 xd hd y2a2 fff fs7 fc3 sc0 ls1 ws1">The instruction is only 32 bits in size, and we<span class="_ _3"></span>’<span class="_ _3"></span>ve already used 8 bits for the </div><div class="t m0 xd hd y2a3 fff fs7 fc3 sc0 ls1 ws1">opcode. W<span class="_ _1"></span>e need 5 bits to specify one register<span class="_ _10"></span>, s<span class="_ _0"></span>o we ha<span class="_ _1"></span>ve left 19 bits for the </div><div class="t m0 xd hd y2a4 fff fs7 fc3 sc0 ls1 ws1">memory address (14 bits if we needed to list two registers).</div><div class="t m0 xc hd y2a5 fff fs7 fc3 sc0 ls1 ws1">This is a problem th<span class="_ _3"></span>at we’ll come bac<span class="_ _3"></span>k to several times<span class="_ _3"></span>, since there ar<span class="_ _1"></span>e </div><div class="t m0 xd hd y2a6 fff fs7 fc3 sc0 ls1 ws1">multiple ways t<span class="_ _3"></span>o address it. I<span class="_ _1"></span>n a CIS<span class="_ _0"></span>C computer<span class="_ _10"></span>, this isn’t a problem since </div><div class="t m0 xd hd y2a7 fff fs7 fc3 sc0 ls1 ws1">instructions are typically quite large and v<span class="_ _3"></span>ariable in length.</div><div class="t m0 xc hd y2a8 fff fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou can load from memory by using a register to specify the addr<span class="_ _1"></span>ess to </div><div class="t m0 xd hd y2a9 fff fs7 fc3 sc0 ls1 ws1">load. This is called indirect memory access. B<span class="_ _3"></span>ut all we’<span class="_ _3"></span>ve done is mov<span class="_ _3"></span>e the </div><div class="t m0 xd hd y2aa fff fs7 fc3 sc0 ls1 ws1">problem<span class="_ _3"></span>, since we don’t ha<span class="_ _3"></span>ve a way to put the v<span class="_ _3"></span>alue into tha<span class="_ _3"></span>t register (in a </div><div class="t m0 xd hd y2ab fff fs7 fc3 sc0 ls1 ws1">single instruction).</div><div class="t m0 xc hd y2ac fff fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou could load several registers<span class="_ _1"></span>, each w<span class="_ _0"></span>ith part of the addr<span class="_ _3"></span>ess, </div><div class="t m0 xd hd y2ad fff fs7 fc3 sc0 ls1 ws1">then shift the parts around, and then add them together<span class="_ _10"></span>. This is a lot of </div><div class="t m0 xd hd y2ae fff fs7 fc3 sc0 ls1 ws1">instructions to load an address<span class="_ _1"></span>, which s<span class="_ _0"></span>eems ra<span class="_ _3"></span>ther inefficient.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf26" class="pf w2 h6" data-page-no="26"><div class="pc pc26 w2 h6"><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">17</div><div class="t m0 x1c hd y145 fff fs7 fc3 sc0 ls1 ws1">The quick wa<span class="_ _3"></span>y to load memory that isn’t too far away fr<span class="_ _1"></span>om the program </div><div class="t m0 xc hd y146 fff fs7 fc3 sc0 ls1 ws1">counter (PC) register is to use the load instruction via the PC, since it </div><div class="t m0 xc hd y147 fff fs7 fc3 sc0 ls1 ws1">allows a 12-bit offset from the r<span class="_ _1"></span>egister<span class="_ _6"></span>. This looks like you can efficiently </div><div class="t m0 xc hd y1b0 fff fs7 fc3 sc0 ls1 ws1">access memory w<span class="_ _0"></span>ithin 4096 wor<span class="_ _3"></span>ds of the <span class="ff15 ls10 ws37">PC</span>. Y<span class="_ _1"></span>uck, how would y<span class="_ _3"></span>ou write </div><div class="t m0 xc hd y1b1 fff fs7 fc3 sc0 ls1 ws1">such code? This is where the GNU Assembler comes in. I<span class="_ _1"></span>t lets you specify </div><div class="t m0 xc hd y218 fff fs7 fc3 sc0 ls1 ws1">the location symbolically and will figur<span class="_ _1"></span>e out the offset for you.</div><div class="t m0 x1c hd y219 fff fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">2</span>, “Loading and A<span class="_ _3"></span>dding,<span class="_ _8"></span>” we will look at the immediate </div><div class="t m0 xc hd y1b4 fff fs7 fc3 sc0 ls1 ws1">operand in mor<span class="_ _3"></span>e detail. W<span class="_ _1"></span>e will cover many mor<span class="_ _3"></span>e ways to specify memory </div><div class="t m0 xc hd y1b5 fff fs7 fc3 sc0 ls1 ws1">addresses in futur<span class="_ _1"></span>e chapters, like asking Lin<span class="_ _3"></span>ux to give us a block of </div><div class="t m0 xc hd y1b6 fff fs7 fc3 sc0 ls1 ws1">memory, returning the address in a r<span class="_ _1"></span>egister for us. For no<span class="_ _3"></span>w, using the <span class="ff15 ls10 ws37">PC</span> </div><div class="t m0 xc hd y1b7 fff fs7 fc3 sc0 ls1 ws1">with an offset meets our needs.</div><div class="t m0 xc h15 y2af ff13 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>About theGCC Assembler</div><div class="t m0 xc hd y2b0 fff fs7 fc3 sc0 lsd ws1">Writing Assembler code in binary as 32-bit instructions w<span class="_ _0"></span>ould be painfully </div><div class="t m0 xc hd y2b1 fff fs7 fc3 sc0 lsd ws1">tedious. E<span class="_ _3"></span>nter GNU Assembler which gives you the po<span class="_ _3"></span>wer to specify </div><div class="t m0 xc hd y2b2 fff fs7 fc3 sc0 lsd ws1">everything that the ARM CPU can do but takes car<span class="_ _3"></span>e of getting all the bits in </div><div class="t m0 xc hd y2b3 fff fs7 fc3 sc0 lsd ws1">the right place for you. The gener<span class="_ _3"></span>al way yo<span class="_ _3"></span>u specify Assembly instructions is</div><div class="t m0 xc h18 y2b4 ff16 fs7 fc3 sc0 ls1 ws1">label:     opcode    operands</div><div class="t m0 x1c hd y2b5 fff fs7 fc3 sc0 ls1 ws1">The label: part is optional and only r<span class="_ _3"></span>equired if you wan<span class="_ _3"></span>t the instruction </div><div class="t m0 xc hd y2b6 fff fs7 fc3 sc0 ls1 ws1">to be the target of a branch instruction.</div><div class="t m0 x1c hd y2b7 fff fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e quite a few opcodes<span class="_ _0"></span>; each one is a short mnemonic that is </div><div class="t m0 xc hd y2b8 fff fs7 fc3 sc0 ls1 ws1">human r<span class="_ _3"></span>eadable and easy for the Assembler to pr<span class="_ _1"></span>ocess. They include</div><div class="t m0 x1e hd y2b9 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff15">ADD</span> for addition</div><div class="t m0 x1e hd y2ba fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff15">LDR</span> for load a register</div><div class="t m0 x1e hd y2bb fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff15">B</span> for branch</div><div class="t m0 x1c hd y2bc fff fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e quite a few different formats for the operands<span class="_ _1"></span>. W<span class="_ _3"></span>e will cover </div><div class="t m0 xc hd y2bd fff fs7 fc3 sc0 ls1 ws1">those as we cover the instructions that use them<span class="_ _3"></span>.</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.503000px;bottom:481.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf27" class="pf w2 h6" data-page-no="27"><div class="pc pc27 w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">18</div><div class="t m0 xd h15 y186 ff13 fsb fc3 sc0 ls1 wsaf"> Hello <span class="_ _11"> </span>World</div><div class="t m0 xd hd y187 fff fs7 fc3 sc0 ls11 ws1">In almost every programming book, the firs<span class="_ _3"></span>t progr<span class="_ _3"></span>am is a simple progr<span class="_ _3"></span>am </div><div class="t m0 xd hd y188 fff fs7 fc3 sc0 ls11 ws1">to output the string “Hello W<span class="_ _1"></span>orld.<span class="_ _8"></span>” W<span class="_ _1"></span>e will do the same w<span class="_ _0"></span>ith Assembly to </div><div class="t m0 xd hd y2be fff fs7 fc3 sc0 ls11 ws1">demonstrate some of the concepts we<span class="_ _3"></span>’v<span class="_ _3"></span>e been talking about. In o<span class="_ _3"></span>ur fav<span class="_ _3"></span>orite </div><div class="t m0 xd hd y18a fff fs7 fc3 sc0 ls11 ws1">text editor<span class="_ _6"></span>, let’<span class="_ _6"></span>s create a file “HelloW<span class="_ _1"></span>orld.s<span class="_ _3"></span>” containing the code in Listing <span class="fc5 wsb3">1-1</span><span class="ls1">.</span></div><div class="t m0 xd h20 y2bf ff17 fs3 fc3 sc0 ls1 ws1">Listing 1-1. <span class="_ _15"> </span><span class="fff">The Hello W<span class="_ _1"></span>orld pr<span class="_ _3"></span>ogram</span></div><div class="t m0 xd h18 y2c0 ff16 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y2c1 ff16 fs7 fc3 sc0 ls1 ws1">// Assembler program to print &quot;Hello World!&quot;</div><div class="t m0 xd h18 y2c2 ff16 fs7 fc3 sc0 ls1 ws1">// to stdout.</div><div class="t m0 xd h18 y2c3 ff16 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y2c4 ff16 fs7 fc3 sc0 ls1 ws1">// X0-X2 - parameters to Linux function services</div><div class="t m0 xd h18 y2c5 ff16 fs7 fc3 sc0 ls1 ws1">// X8 - Linux function number</div><div class="t m0 xd h18 y2c6 ff16 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y2c7 ff16 fs7 fc3 sc0 ls1 ws1">.global _start // Provide program starting address</div><div class="t m0 xd h18 y2c8 ff16 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print hello world</div><div class="t m0 xd h18 y2c9 ff16 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y2ca ff16 fs7 fc3 sc0 ls1 ws1">_start: mov     X0, #1     // 1 = StdOut</div><div class="t m0 xd h18 y2cb ff16 fs7 fc3 sc0 ls1 ws1">     ldr   X1, =helloworld // string to print</div><div class="t m0 xd h18 y2cc ff16 fs7 fc3 sc0 ls1 ws1">     mov   X2, #13         // length of our string</div><div class="t m0 xd h18 y2cd ff16 fs7 fc3 sc0 ls1 ws1">     mov   X8, #64         // Linux write system call</div><div class="t m0 xd h18 y2ce ff16 fs7 fc3 sc0 ls1 ws1">     svc   0               // Call Linux to output the string</div><div class="t m0 xd h18 y2cf ff16 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xd h18 y2d0 ff16 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y2d1 ff16 fs7 fc3 sc0 ls1 ws1">     mov     X0, #0    // Use 0 return code</div><div class="t m0 xd h18 y2d2 ff16 fs7 fc3 sc0 ls1 ws1">     mov     X8, #93   // Service code 93 terminates</div><div class="t m0 xd h18 y2d3 ff16 fs7 fc3 sc0 ls1 ws1">     svc     0         // Call Linux to terminate</div><div class="t m0 xd h18 y2d4 ff16 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y2d5 ff16 fs7 fc3 sc0 ls1 ws1">helloworld:      .ascii  &quot;Hello World!\n&quot;</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf27" data-dest-detail='[39,"XYZ",35,485,null]'><div class="d m1" style="border-style:none;position:absolute;left:366.260000px;bottom:499.090000px;width:14.619000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf28" class="pf w2 h6" data-page-no="28"><div class="pc pc28 w2 h6"><img class="bi x2e y2d6 w8 h21" alt="" src="bg28.png"/><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">19</div><div class="t m0 x1c hd y145 fff fs7 fc3 sc0 ls12 ws1">This is our first look at a complete As<span class="_ _3"></span>sembly Language pr<span class="_ _3"></span>ogram, so ther<span class="_ _1"></span>e<span class="_ _0"></span> </div><div class="t m0 xc hd y146 fff fs7 fc3 sc0 ls12 ws1">are a few things to talk a<span class="_ _3"></span>bout. But<span class="_ _3"></span>, first, let’<span class="_ _6"></span>s compile and run this program.</div><div class="t m0 x1c hd y147 fff fs7 fc3 sc0 ls1 ws1">In our text editor<span class="_ _10"></span>, create a file called “build<span class="_ _3"></span>” that con<span class="_ _3"></span>tains</div><div class="t m0 xc h18 y2d7 ff16 fs7 fc3 sc0 ls1 ws1">as -o HelloWorld.o HelloWorld.s</div><div class="t m0 xc h18 y2d8 ff16 fs7 fc3 sc0 ls1 ws1">ld -o HelloWorld HelloWorld.o</div><div class="t m0 x1c hd y2d9 fff fs7 fc3 sc0 ls1 ws1">These are the commands t<span class="_ _3"></span>o compile our progr<span class="_ _1"></span>am. First, we must m<span class="_ _3"></span>ake </div><div class="t m0 xc hd y2da fff fs7 fc3 sc0 ls1 ws1">this file executable using the terminal command:</div><div class="t m0 xc h18 y2db ff16 fs7 fc3 sc0 ls1 ws1">chmod +x build</div><div class="t m0 x1c hd y2dc fff fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w, we can run it by typing <span class="ff15">./build</span>. If the files are corr<span class="_ _1"></span>e<span class="_ _0"></span>ct, we can </div><div class="t m0 xc hd y2dd fff fs7 fc3 sc0 ls1 ws1">execute our progr<span class="_ _1"></span>am by typing <span class="ff15">./HelloW<span class="_ _1"></span>orld<span class="fff">. In Fi<span class="_ _3"></span>gure<span class="fc5">1-4</span>, I used <span class="ff15">bash -<span class="_ _1"></span>x<span class="fff"> </span></span></span></span></div><div class="t m0 xc hd y2de fff fs7 fc3 sc0 ls1 ws1">(<span class="_ _3"></span>debug mode), so you can see the commands being ex<span class="_ _3"></span>ecuted.</div><div class="t m0 xc h1c y2df ff17 fs3 fc3 sc0 ls1 ws1">Figure 1-4. <span class="_ _15"> </span><span class="ff10">Building and executing H<span class="_ _1"></span>elloW<span class="_ _3"></span>orld</span></div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf28" data-dest-detail='[40,"XYZ",53,373,null]'><div class="d m1" style="border-style:none;position:absolute;left:312.574000px;bottom:401.175000px;width:15.047000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf29" class="pf w2 h6" data-page-no="29"><div class="pc pc29 w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">20</div><div class="t m0 xc hd y145 fff fs7 fc3 sc0 ls1 ws1">If we run “ls -l”<span class="_ _18"></span>, then the output is</div><div class="t m0 xd h18 y2e0 ff16 fs7 fc3 sc0 ls1 ws1">-rw-r--r-- 1 smist08 smist08   62 qad 18 17:31 build</div><div class="t m0 xd h18 y2e1 ff16 fs7 fc3 sc0 ls1 ws1">-rwxr-xr-x 1 smist08 smist08 1104 kax 10 16:49 HelloWorld</div><div class="t m0 xd h18 y2d7 ff16 fs7 fc3 sc0 ls1 ws1">-rw-r--r-- 1 smist08 smist08  936 kax 10 16:49 HelloWorld.o</div><div class="t m0 xd h18 y2e2 ff16 fs7 fc3 sc0 ls1 ws1">-rw-r--r-- 1 smist08 smist08  826 kax  5 22:32 HelloWorld.s</div><div class="t m0 xc hd y2d9 fff fs7 fc3 sc0 lsf ws1">Notice ho<span class="_ _3"></span>w small these files are<span class="_ _1"></span>. The executable is only 1104 bytes, a<span class="_ _3"></span>bout </div><div class="t m0 xd hd y2da fff fs7 fc3 sc0 lsf ws1">1 kilobyte<span class="_ _3"></span>. This is because ther<span class="_ _3"></span>e is no runtime, or any other libr<span class="_ _1"></span>ar<span class="_ _0"></span>ies r<span class="_ _3"></span>equired </div><div class="t m0 xd hd y231 fff fs7 fc3 sc0 lsf ws1">to run this program; it is entirely complete in itself. If y<span class="_ _3"></span>ou want to cr<span class="_ _1"></span>eate ver<span class="_ _0"></span>y </div><div class="t m0 xd hd y2e3 fff fs7 fc3 sc0 lsf ws1">small executables<span class="_ _1"></span>, Ass<span class="_ _0"></span>embly Lan<span class="_ _3"></span>guage progr<span class="_ _1"></span>amming is the way to go<span class="_ _3"></span>.</div><div class="t m0 xc hd y2e4 fff fs7 fc3 sc0 ls1 ws1">The format for this pr<span class="_ _3"></span>ogram is a common con<span class="_ _3"></span>vention for Assembly </div><div class="t m0 xd hd y2e5 fff fs7 fc3 sc0 ls1 ws1">Language pr<span class="_ _3"></span>ograms wher<span class="_ _3"></span>e each line is divided into these four columns:</div><div class="t m0 xa hd y2e6 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Optional statemen<span class="_ _3"></span>t label</div><div class="t m0 xa hd y2e7 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Opcode</div><div class="t m0 xa hd y2e8 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Operands</div><div class="t m0 xa hd y23e fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Comment</div><div class="t m0 xc hd y23f fff fs7 fc3 sc0 ls1 ws1">These are all separ<span class="_ _3"></span>ated by tabs<span class="_ _1"></span>, so the<span class="_ _0"></span>y line up nicely.</div><div class="t m0 xc hd y2e9 fff fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ay, our first working Assembl<span class="_ _3"></span>y Language progr<span class="_ _1"></span>am. Now, let’<span class="_ _6"></span>s talk </div><div class="t m0 xd hd y2ea fff fs7 fc3 sc0 ls1 ws1">about all the parts.</div><div class="t m0 xd ha y2eb ff13 fs6 fc3 sc0 ls1 wsb1"> About <span class="_ _14"> </span>Comments</div><div class="t m0 xd hd y2ec fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e start the program with a comment that s<span class="_ _3"></span>tates what it does<span class="_ _1"></span>. W<span class="_ _3"></span>e also </div><div class="t m0 xd hd y2ed fff fs7 fc3 sc0 ls1 ws1">document the register<span class="_ _3"></span>s used. Keeping trac<span class="_ _3"></span>k of which registers ar<span class="_ _1"></span>e doing </div><div class="t m0 xd hd y2ee fff fs7 fc3 sc0 ls1 ws1">what becomes important as our pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>ams get bigger<span class="_ _6"></span>.</div><div class="t m0 xa hd y2ef fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Whenever you see double slashes //, then everything </div><div class="t m0 x1e hd y2f0 fff fs7 fc3 sc0 ls1 ws1">after the “//” is a comment. Th<span class="_ _3"></span>at means it is ther<span class="_ _3"></span>e for </div><div class="t m0 x1e hd y2f1 fff fs7 fc3 sc0 ls1 wsac">documentation and is discar<span class="_ _3"></span>ded by the GNU Assembler </div><div class="t m0 x1e hd y2f2 fff fs7 fc3 sc0 ls1 ws1">when it processes the file<span class="_ _3"></span>.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf2a" class="pf w2 h6" data-page-no="2a"><div class="pc pc2a w2 h6"><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">21</div><div class="t m0 x1e hd y145 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Assembly Language is cryptic, so it’<span class="_ _1"></span>s important to </div><div class="t m0 x9 hd y146 fff fs7 fc3 sc0 ls1 ws1">document what y<span class="_ _3"></span>ou are doing<span class="_ _3"></span>. Otherw<span class="_ _0"></span>ise, y<span class="_ _3"></span>ou will </div><div class="t m0 x9 hd y147 fff fs7 fc3 sc0 ls1 ws1">return to the pr<span class="_ _1"></span>ogram after a couple of weeks and have </div><div class="t m0 x9 hd y1b0 fff fs7 fc3 sc0 ls1 ws1">no idea what the pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>am does.</div><div class="t m0 x1e hd y149 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Each section of the program h<span class="_ _3"></span>as a comment stating </div><div class="t m0 x9 hd y14a fff fs7 fc3 sc0 ls1 ws1">what it does and then each line of the pr<span class="_ _3"></span>ogram has a </div><div class="t m0 x9 hd y1cb fff fs7 fc3 sc0 ls1 ws1">comment at the end sta<span class="_ _3"></span>ting what it does<span class="_ _1"></span>. Everything </div><div class="t m0 x9 hd y1cc fff fs7 fc3 sc0 ls1 ws1">between a /<span class="ff18">∗</span> and <span class="ff18">∗</span>/ is also a comment and will be </div><div class="t m0 x9 hd y1cd fff fs7 fc3 sc0 ls1 ws1">ignored.</div><div class="t m0 x1e hd y2f3 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>This is the same as comments in C/C++ code<span class="_ _3"></span>. This </div><div class="t m0 x9 hd y2f4 fff fs7 fc3 sc0 ls1 ws1">allows us to shar<span class="_ _1"></span>e s<span class="_ _0"></span>ome tools between C and Assembly </div><div class="t m0 x9 hd y2f5 fff fs7 fc3 sc0 ls1 ws1">Language<span class="_ _3"></span>.</div><div class="t m0 xc ha y2f6 ff13 fs6 fc3 sc0 ls1 wsb1"> Where <span class="_ _14"> </span>toStart</div><div class="t m0 xc hd y2f7 fff fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we specify the starting point of our progr<span class="_ _1"></span>am<span class="_ _0"></span>:</div><div class="t m0 x1e hd y2f8 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>W<span class="_ _1"></span>e need to define this as a global symbol, so that the </div><div class="t m0 x9 hd y2f9 fff fs7 fc3 sc0 ls1 ws1">linker (the ld command in our build file) h<span class="_ _3"></span>as access </div><div class="t m0 x9 hd y2fa fff fs7 fc3 sc0 ls1 ws1">to it. The Assembler mar<span class="_ _1"></span>ks the statement containing </div><div class="t m0 x9 hd y2fb ff15 fs7 fc3 sc0 ls1 ws1">_start<span class="fff"> as the progr<span class="_ _1"></span>am entr<span class="_ _0"></span>y point<span class="_ _0"></span>; then the linker can </span></div><div class="t m0 x9 hd y2fc fff fs7 fc3 sc0 ls1 ws1">find it because it has been defined as a global variable. </div><div class="t m0 x9 hd y2fd fff fs7 fc3 sc0 ls1 ws1">All our progr<span class="_ _3"></span>ams will contain this somewhere<span class="_ _1"></span>.</div><div class="t m0 x1e hd y2fe fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Our progr<span class="_ _1"></span>am can consist of multiple <span class="ff15">.s</span> files, but only </div><div class="t m0 x9 hd y2ff fff fs7 fc3 sc0 ls1 ws1">one file can contain <span class="ff15">_start</span>.</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf2b" class="pf w2 h6" data-page-no="2b"><div class="pc pc2b w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">22</div><div class="t m0 xd ha y248 ff13 fs6 fc3 sc0 ls1 wsb1"> Assembly <span class="_ _14"> </span>Instructions</div><div class="t m0 xd hd y249 fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e only use three different Assembly Lan<span class="_ _3"></span>guage statemen<span class="_ _3"></span>ts in this </div><div class="t m0 xd hd y24a fff fs7 fc3 sc0 ls1 ws1">example:</div><div class="t m0 xc hd y300 fff fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ff15 lsb wsb4">MOV<span class="fff ls1 ws1">, which moves data into a r<span class="_ _1"></span>e<span class="_ _0"></span>gister<span class="_ _10"></span>. In this case </span></span></div><div class="t m0 x1e hd y301 fff fs7 fc3 sc0 ls1 ws1">we use an immediate operand, which starts with </div><div class="t m0 x1e hd y302 fff fs7 fc3 sc0 ls1 ws1">the “#” sign. So “MOV X2, #13” means mo<span class="_ _3"></span>ve the </div><div class="t m0 x1e hd y303 fff fs7 fc3 sc0 ls1 ws1">number 13 into <span class="ff15">X2</span>. I<span class="_ _3"></span>n this case, the 13 is part of </div><div class="t m0 x1e hd y29b fff fs7 fc3 sc0 ls1 ws1">the instruction and not stored somewhere else in </div><div class="t m0 x1e hd y250 fff fs7 fc3 sc0 ls1 ws1">memory. In the source file, the oper<span class="_ _3"></span>ands can be </div><div class="t m0 x1e hd y251 fff fs7 fc3 sc0 ls1 ws1">upper<span class="_ _1"></span>- or lower<span class="_ _3"></span>-case. I tend to pr<span class="_ _1"></span>efer lower<span class="_ _3"></span>- <span class="_ _b"></span>case in </div><div class="t m0 x1e hd y252 fff fs7 fc3 sc0 ls1 ws1">my pr<span class="_ _3"></span>ogram listings<span class="_ _1"></span>.</div><div class="t m0 xc hd y253 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>“LDR X1, =helloworld” statement th<span class="_ _3"></span>at loads r<span class="_ _3"></span>egister </div><div class="t m0 x1e hd y254 ff15 fs7 fc3 sc0 ls1 ws1">X1<span class="fff"> with the address of the string we want to print<span class="_ _3"></span>.</span></div><div class="t m0 xc hd y255 fff fs7 fc3 sc0 lsa wsb5"> 3. <span class="_ _10"></span><span class="ff15 ls13 wsb6">SVC 0<span class="fff lsa ws1"> command that executes software in<span class="_ _3"></span>terrupt<span class="_ _0"></span> </span></span></div><div class="t m0 x1e hd y2a1 fff fs7 fc3 sc0 lsa ws1">number 0. This br<span class="_ _3"></span>anches to the interrupt handler in </div><div class="t m0 x1e hd y2a2 fff fs7 fc3 sc0 lsa ws1">the Linux kernel, which interpr<span class="_ _1"></span>ets the parameters<span class="_ _0"></span> </div><div class="t m0 x1e hd y2a3 fff fs7 fc3 sc0 lsa ws1">we’<span class="_ _3"></span>ve set in various registers and does the actual wor<span class="_ _3"></span>k.</div><div class="t m0 xd ha y304 ff13 fs6 fc3 sc0 ls1 wsb1"> Data</div><div class="t m0 xd hd y305 fff fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we ha<span class="_ _3"></span>ve <span class="ff15">.data</span> tha<span class="_ _3"></span>t indicates the following instructions in the data </div><div class="t m0 xd hd y306 fff fs7 fc3 sc0 ls1 ws1">section of the program:</div><div class="t m0 xa hd y307 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>In this we ha<span class="_ _1"></span>ve a label “helloworld” followed by an </div><div class="t m0 x1e hd y308 ff15 fs7 fc3 sc0 ls1 ws1">.asci<span class="_ _0"></span>i<span class="fff"> stat<span class="_ _3"></span>ement, then the string we want to print<span class="_ _3"></span>.</span></div><div class="t m0 xa hd y309 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The <span class="ff15">.ascii</span> statement tells the Assembler just to put </div><div class="t m0 x1e hd y30a fff fs7 fc3 sc0 ls1 ws1">our string in the data section; then we can access it </div><div class="t m0 x1e hd y30b fff fs7 fc3 sc0 ls1 ws1">via the label as we do in the <span class="ff15">LDR</span> statement. W<span class="_ _1"></span>e’ll talk </div><div class="t m0 x1e hd y30c fff fs7 fc3 sc0 ls1 ws1">later about ho<span class="_ _3"></span>w text is repr<span class="_ _1"></span>esented as numbers, the </div><div class="t m0 x1e hd y30d fff fs7 fc3 sc0 ls1 ws1">encoding scheme here being called ASCII.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf2c" class="pf w2 h6" data-page-no="2c"><div class="pc pc2c w2 h6"><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">23</div><div class="t m0 x1e hd y145 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The last “\n” char<span class="_ _3"></span>acter is how we repr<span class="_ _1"></span>esent a new line. </div><div class="t m0 x9 hd y146 fff fs7 fc3 sc0 ls1 ws1">If we don’t include this, you m<span class="_ _3"></span>ust pres<span class="_ _3"></span>s Return to see </div><div class="t m0 x9 hd y147 fff fs7 fc3 sc0 ls1 ws1">the text in the terminal window.</div><div class="t m0 xc ha y30e ff13 fs6 fc3 sc0 ls1 wsb1"> Calling <span class="_ _14"> </span>Linux</div><div class="t m0 xc hd y30f fff fs7 fc3 sc0 ls1 ws1">This progr<span class="_ _3"></span>am makes two Linux system c<span class="_ _3"></span>alls to do its work. The first is the </div><div class="t m0 xc hd y310 fff fs7 fc3 sc0 ls1 ws1">Linux write to file command (#64). Normall<span class="_ _3"></span>y, we would hav<span class="_ _3"></span>e to open a file </div><div class="t m0 xc hd y311 fff fs7 fc3 sc0 ls1 ws1">first before using this comm<span class="_ _3"></span>and, but when Linux runs a progr<span class="_ _3"></span>am, it opens </div><div class="t m0 xc hd y312 fff fs7 fc3 sc0 ls1 ws1">three files for it<span class="_ _0"></span>:</div><div class="t m0 x1c hd y313 fff fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ff15 ws1">stdout<span class="fff"> (outp<span class="_ _3"></span>ut to the screen)</span></span></div><div class="t m0 x1c hd y314 fff fs7 fc3 sc0 ls1 wsad"> 2. <span class="_ _6"></span><span class="ff15 ws1">stdin<span class="fff"> (input from the keyboar<span class="_ _3"></span>d)</span></span></div><div class="t m0 x1c hd y315 fff fs7 fc3 sc0 ls1 wsad"> 3. <span class="_ _6"></span><span class="ff15 ws1">stderr<span class="fff"> (also output to the screen)</span></span></div><div class="t m0 x1c hd y316 fff fs7 fc3 sc0 ls1 ws1">The Linux shell will redir<span class="_ _3"></span>ect these when you use &gt;, &lt;, and | in your </div><div class="t m0 xc hd y317 fff fs7 fc3 sc0 ls1 ws1">commands<span class="_ _3"></span>. For an<span class="_ _3"></span>y Linux system call, yo<span class="_ _3"></span>u put the parameters in r<span class="_ _1"></span>egisters </div><div class="t m0 xc hd y318 ff15 fs7 fc3 sc0 ls1 ws1">X0<span class="fff">–</span>X7<span class="fff"> depending on how many par<span class="_ _1"></span>ameters are needed. Then a return </span></div><div class="t m0 xc hd y319 fff fs7 fc3 sc0 ls1 ws1">code is placed in <span class="ff15">X0</span> (we should check this to see if an error occurred, but </div><div class="t m0 xc hd y31a fff fs7 fc3 sc0 ls1 ws1">we are bad and don’t do any err<span class="_ _3"></span>or checking). Each system call is specified </div><div class="t m0 xc hd y31b fff fs7 fc3 sc0 ls1 ws1">by putting its function n<span class="_ _3"></span>umber in <span class="ff15">X8</span>.</div><div class="t m0 x1c hd y31c fff fs7 fc3 sc0 ls1 ws1">The reason we do a softwar<span class="_ _3"></span>e interrupt rather than a br<span class="_ _1"></span>anch or </div><div class="t m0 xc hd y31d fff fs7 fc3 sc0 ls1 ws1">subroutine c<span class="_ _3"></span>all is so we can call Linux without needing to know wher<span class="_ _3"></span>e this </div><div class="t m0 xc hd y31e fff fs7 fc3 sc0 ls1 ws1">routine is in memory. This is rather clev<span class="_ _3"></span>er and means we don’t need to </div><div class="t m0 xc hd y31f fff fs7 fc3 sc0 ls1 ws1">change any addr<span class="_ _3"></span>esses in our progr<span class="_ _1"></span>am as L<span class="_ _0"></span>inux is upda<span class="_ _3"></span>ted and its routines </div><div class="t m0 xc hd y320 fff fs7 fc3 sc0 ls1 ws1">move ar<span class="_ _1"></span>ound in memor<span class="_ _0"></span>y. The software in<span class="_ _3"></span>terrupt has another benefit of </div><div class="t m0 xc hd y321 fff fs7 fc3 sc0 ls1 ws1">pro<span class="_ _3"></span>viding a standar<span class="_ _3"></span>d mechanism to switch privilege levels. W<span class="_ _1"></span>e’ll discuss </div><div class="t m0 xc hd y322 fff fs7 fc3 sc0 ls1 ws1">Linux system calls lat<span class="_ _3"></span>er in Chapter <span class="fc5">7</span>, “Linux Opera<span class="_ _3"></span>ting System Services.<span class="_ _8"></span>”</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pfb0" data-dest-detail='[176,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:216.501000px;bottom:153.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf2d" class="pf w2 h6" data-page-no="2d"><div class="pc pc2d w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">24</div><div class="t m0 xd ha y248 ff13 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Reverse Engineering Our Program</div><div class="t m0 xd hd y249 fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e talked about how each Assembly instruction is compiled into a 32-bit </div><div class="t m0 xd hd y24a fff fs7 fc3 sc0 ls1 ws1">word. The Assembler did this for us<span class="_ _1"></span>, but can we see what it did? One way is </div><div class="t m0 xd hd y24b fff fs7 fc3 sc0 ls1 ws1">to use the <span class="ff15">objdump</span> command line progr<span class="_ _3"></span>am<span class="_ _0"></span>:</div><div class="t m0 xd h18 y323 ff16 fs7 fc3 sc0 ls1 ws1">objdump -s -d HellowWorld.o</div><div class="t m0 xc hd y324 fff fs7 fc3 sc0 ls1 ws1">which produces Listing <span class="fc5">1-2</span>.</div><div class="t m0 xd h20 y325 ff17 fs3 fc3 sc0 ls1 ws1">Listing 1-2. <span class="_ _15"> </span><span class="fff">Disassembly of Hello W<span class="_ _1"></span>orld</span></div><div class="t m0 xd h18 y326 ff16 fs7 fc3 sc0 ls1 ws1">HelloWorld.o:     file format elf64-littleaarch64</div><div class="t m0 xd h18 y327 ff16 fs7 fc3 sc0 ls1 ws1">Contents of section .text:</div><div class="t m0 xd h18 y328 ff16 fs7 fc3 sc0 ls1 ws1"> 0000 200080d2 e1000058 a20180d2 080880d2   ......X........</div><div class="t m0 xd h18 y329 ff16 fs7 fc3 sc0 ls1 ws1"> 0010 010000d4 000080d2 a80b80d2 010000d4  ................</div><div class="t m0 xd h18 y32a ff16 fs7 fc3 sc0 ls1 ws1"> 0020 00000000 00000000                    ........</div><div class="t m0 xd h18 y32b ff16 fs7 fc3 sc0 ls1 ws1">Contents of section .data:</div><div class="t m0 xd h18 y32c ff16 fs7 fc3 sc0 ls1 ws1"> 0000 48656c6c 6f20576f 726c6421 0a        Hello World!.</div><div class="t m0 xd h18 y32d ff16 fs7 fc3 sc0 ls1 ws1">Disassembly of section .text:</div><div class="t m0 xd h18 y32e ff16 fs7 fc3 sc0 ls1 ws1">0000000000000000 &lt;_start&gt;:</div><div class="t m0 xd h18 y32f ff16 fs7 fc3 sc0 ls1 ws1">   0:  d2800020     mov   x0, #0x1                   // #1</div><div class="t m0 xd h18 y330 ff16 fs7 fc3 sc0 ls1 ws1">   4:  580000e1     ldr   x1, 20 &lt;_start+0x20&gt;</div><div class="t m0 xd h18 y331 ff16 fs7 fc3 sc0 ls1 ws1">   8:  d28001a2     mov   x2, #0xd                   // #13</div><div class="t m0 xd h18 y332 ff16 fs7 fc3 sc0 ls1 ws1">   c:  d2800808     mov   x8, #0x40                  // #64</div><div class="t m0 xd h18 y333 ff16 fs7 fc3 sc0 ls1 ws1">  10:  d4000001     svc   #0x0</div><div class="t m0 xd h18 y334 ff16 fs7 fc3 sc0 ls1 ws1">  14:  d2800000     mov   x0, #0x0                   // #0</div><div class="t m0 xd h18 y335 ff16 fs7 fc3 sc0 ls1 ws1">  18:  d2800ba8     mov   x8, #0x5d                  // #93</div><div class="t m0 xd h18 y336 ff16 fs7 fc3 sc0 ls1 ws1">  1c:  d4000001     svc   #0x0</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf2d" data-dest-detail='[45,"XYZ",35,455,null]'><div class="d m1" style="border-style:none;position:absolute;left:165.109000px;bottom:468.518000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf2e" class="pf w2 h6" data-page-no="2e"><div class="pc pc2e w2 h6"><img class="bi x2e y337 w5 h22" alt="" src="bg2e.png"/><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">25</div><div class="t m0 x1c hd y145 fff fs7 fc3 sc0 ls1 ws1">The top part of the output shows the r<span class="_ _3"></span>aw da<span class="_ _3"></span>ta in the file including our </div><div class="t m0 xc hd y146 fff fs7 fc3 sc0 ls1 ws1">eight instructions<span class="_ _3"></span>, then our string to print in the .data section. The second </div><div class="t m0 xc hd y147 fff fs7 fc3 sc0 ls1 ws1">part is a disassembly of the executable .text section.</div><div class="t m0 x1c hd y1b0 fff fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at the first <span class="ff15 lsb wsb4">MOV</span> instruction which compiled to 0xd2800020 </div><div class="t m0 xc hd y1b1 fff fs7 fc3 sc0 ls1 ws1">(Fig<span class="_ _3"></span>ure<span class="fc5">1-5</span>).</div><div class="t m0 x1e hd y338 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The first bit is 1, meaning use the 64-bit version of the </div><div class="t m0 x9 hd y339 fff fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>, in this case <span class="ff15">X0</span> rather than <span class="ff15">W0</span>.</div><div class="t m0 x1e hd y33a fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The third bit is 0, which means th<span class="_ _3"></span>at this instruction </div><div class="t m0 x9 hd y33b fff fs7 fc3 sc0 ls1 ws1">doesn’t set any flags that would affect condition<span class="_ _3"></span>al </div><div class="t m0 x9 hd y33c fff fs7 fc3 sc0 ls1 ws1">instructions.</div><div class="t m0 x1e hd y33d fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The second bit combined with the fourth to ninth bits </div><div class="t m0 x9 hd y33e fff fs7 fc3 sc0 ls1 ws1">make up the opcode for this MOV ins<span class="_ _3"></span>truction. This is </div><div class="t m0 x9 hd y33f fff fs7 fc3 sc0 ls1 ws1">move wide immediate<span class="_ _1"></span>, meaning it contains a 16-bit </div><div class="t m0 x9 hd y340 fff fs7 fc3 sc0 ls1 ws1">immediate value<span class="_ _3"></span>.</div><div class="t m0 x1e hd y341 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The next 2 bits of 0 indicate ther<span class="_ _1"></span>e is no shift operation </div><div class="t m0 x9 hd y342 fff fs7 fc3 sc0 ls1 ws1">involved.</div><div class="t m0 x1e hd y343 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The next 16 bits ar<span class="_ _3"></span>e the immediate value which is 1.</div><div class="t m0 x1e hd y344 fff fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The last 5 bits are the r<span class="_ _1"></span>egister to load. These are 0 since </div><div class="t m0 x9 hd y345 fff fs7 fc3 sc0 ls1 ws1">we are loading r<span class="_ _1"></span>e<span class="_ _0"></span>gister <span class="ff15">X0</span>.</div><div class="t m0 x1c hd y346 fff fs7 fc3 sc0 ls1 ws1">Look at the <span class="ff15">LDR</span> instruction; it changed from</div><div class="t m0 xc h18 y347 ff16 fs7 fc3 sc0 ls1 ws1">ldr   X1, =helloworld</div><div class="t m0 xc hd y348 fff fs7 fc3 sc0 ls8 ws9f">to</div><div class="t m0 xc h18 y349 ff16 fs7 fc3 sc0 ls1 ws1">ldr   x1, 20 &lt;_start+0x20&gt;</div><div class="t m0 xc h1c y34a ff17 fs3 fc3 sc0 ls1 ws1">Figure 1-5. <span class="_ _15"> </span><span class="ff10">Binary representation of the firs<span class="_ _3"></span>t MOV instruction</span></div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf2e" data-dest-detail='[46,"XYZ",53,497,null]'><div class="d m1" style="border-style:none;position:absolute;left:89.958500px;bottom:513.362000px;width:15.047500px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf2f" class="pf w2 h6" data-page-no="2f"><div class="pc pc2f w2 h6"><div class="t m0 xd hd y3f fff fs7 fc3 sc0 ls1 ws1">26</div><div class="t m0 xc hd y145 fff fs7 fc3 sc0 ls1 ws1">This is the Assembler helping you with the ARM pr<span class="_ _3"></span>ocessor’<span class="_ _1"></span>s obscure </div><div class="t m0 xd hd y146 fff fs7 fc3 sc0 ls1 ws1">mechanism of address<span class="_ _3"></span>ing memory. It lets you specify a symbolic addr<span class="_ _3"></span>ess, </div><div class="t m0 xd hd y147 fff fs7 fc3 sc0 ls1 ws1">namely, “helloworld,<span class="_ _8"></span>” and transla<span class="_ _3"></span>te that in<span class="_ _3"></span>to an offset from the pr<span class="_ _3"></span>ogram </div><div class="t m0 xd hd y1b0 fff fs7 fc3 sc0 ls1 ws1">counter<span class="_ _10"></span>. Here the disassembler is trying to be helpful to indicate which </div><div class="t m0 xd hd y1b1 fff fs7 fc3 sc0 ls1 ws1">memory address will be loaded, rather than the exact Assembly code<span class="_ _3"></span>. </div><div class="t m0 xd hd y218 fff fs7 fc3 sc0 ls1 ws1">The details are a bit mor<span class="_ _1"></span>e complicated, and we’ll cover them in detail in </div><div class="t m0 xd hd y219 fff fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">5</span>, “Thanks for the Memories<span class="_ _3"></span>.<span class="_ _8"></span>”</div><div class="t m0 xc hd y1b4 fff fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou might notice that the ra<span class="_ _1"></span>w instructions in the top par<span class="_ _0"></span>t of the output </div><div class="t m0 xd hd y1b5 fff fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve their bytes r<span class="_ _1"></span>everse<span class="_ _0"></span>d, compar<span class="_ _1"></span>ed to thos<span class="_ _0"></span>e listed in the disassembly </div><div class="t m0 xd hd y1b6 fff fs7 fc3 sc0 ls1 ws1">listing. This is because we ar<span class="_ _3"></span>e using a little-endian encoding, which we will </div><div class="t m0 xd hd y1b7 fff fs7 fc3 sc0 ls1 ws1">cover in the next c<span class="_ _3"></span>hapter<span class="_ _10"></span>.</div><div class="t m0 xd h15 y2af ff13 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y2b0 fff fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we introduced the ARM processor and Assembly Lan<span class="_ _3"></span>guage </div><div class="t m0 xd hd y2b1 fff fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming along with why we want to use Assembly. W<span class="_ _1"></span>e cov<span class="_ _3"></span>ered the </div><div class="t m0 xd hd y2b2 fff fs7 fc3 sc0 ls1 ws1">tools we will be using. W<span class="_ _1"></span>e also saw how computers r<span class="_ _3"></span>epresent positiv<span class="_ _3"></span>e </div><div class="t m0 xd hd y2b3 fff fs7 fc3 sc0 ls8 ws9f">integers.</div><div class="t m0 xc hd y34b fff fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e then looked at in more detail how the ARM CPU r<span class="_ _3"></span>epresents </div><div class="t m0 xd hd y34c fff fs7 fc3 sc0 ls1 ws1">Assembly instructions along with the registers it contains for pr<span class="_ _1"></span>ocessing </div><div class="t m0 xd hd y34d fff fs7 fc3 sc0 ls1 ws1">data. W<span class="_ _1"></span>e intr<span class="_ _3"></span>oduced both the computer’<span class="_ _1"></span>s memory and the GNU Ass<span class="_ _0"></span>embler </div><div class="t m0 xd hd y34e fff fs7 fc3 sc0 ls1 ws1">that will assist us in writing our Assembly Lang<span class="_ _3"></span>uage progr<span class="_ _3"></span>ams.</div><div class="t m0 xc hd y34f fff fs7 fc3 sc0 ls1 ws1">Fin<span class="_ _3"></span>ally, we created a simple com<span class="_ _3"></span>plete progr<span class="_ _3"></span>am to print “Hello W<span class="_ _1"></span>orld!” </div><div class="t m0 xd hd y350 fff fs7 fc3 sc0 ls1 ws1">in our terminal window.</div><div class="t m0 xc hd y351 fff fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">2</span>, “Loading and A<span class="_ _3"></span>dding,<span class="_ _8"></span>” we will look at loading data into </div><div class="t m0 xd hd y352 fff fs7 fc3 sc0 ls1 ws1">the CPU registers and performing basic addition. W<span class="_ _1"></span>e’ll see how negative </div><div class="t m0 xd hd y353 fff fs7 fc3 sc0 ls1 ws1">numbers ar<span class="_ _3"></span>e repr<span class="_ _1"></span>es<span class="_ _0"></span>ented and learn new techniques for m<span class="_ _3"></span>anipulating </div><div class="t m0 xd hd y354 fff fs7 fc3 sc0 ls1 ws1">binary bits.</div><div class="t m0 xd h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:76.259700px;bottom:481.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:185.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf30" class="pf w2 h6" data-page-no="30"><div class="pc pc30 w2 h6"><div class="t m0 x12 hd y3f fff fs7 fc3 sc0 ls1 ws1">27</div><div class="t m0 xc h15 y186 ff13 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 x1c hd y355 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Convert the decimal number 1234 to both bin<span class="_ _3"></span>ary </div><div class="t m0 x9 hd y356 fff fs7 fc3 sc0 ls1 ws1">and hexadecimal.</div><div class="t m0 x1c hd y357 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Download the source code for this book from the </div><div class="t m0 x9 hd y358 fff fs7 fc3 sc0 ls1 ws1">GitH<span class="_ _3"></span>ub site and compile the H<span class="_ _3"></span>elloW<span class="_ _1"></span>orld program </div><div class="t m0 x9 hd y359 fff fs7 fc3 sc0 ls1 ws1">on your ARM system<span class="_ _3"></span>.</div><div class="t m0 x1c hd y35a fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Change the string in HelloW<span class="_ _1"></span>orld, but r<span class="_ _3"></span>emember to </div><div class="t m0 x9 hd y35b fff fs7 fc3 sc0 ls1 ws1">change the length loaded into <span class="ff15">X2</span>.</div><div class="t m0 x1c hd y35c fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>In the HelloW<span class="_ _1"></span>orld progr<span class="_ _3"></span>am, ch<span class="_ _3"></span>ange the return code </div><div class="t m0 x9 hd y35d fff fs7 fc3 sc0 ls1 ws1">loaded into <span class="ff15">X0</span> before the second <span class="ff15 ls14 wsb6">SVC</span> call and see </div><div class="t m0 x9 hd y35e fff fs7 fc3 sc0 ls1 ws1">what ha<span class="_ _3"></span>ppens.</div><div class="t m0 x1c hd y35f fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Since HelloW<span class="_ _1"></span>orld is a standard Linux pr<span class="_ _1"></span>ogram  </div><div class="t m0 x9 hd y360 fff fs7 fc3 sc0 ls1 ws1">using standar<span class="_ _3"></span>d Linux conven<span class="_ _3"></span>tions, yo<span class="_ _3"></span>u can use it </div><div class="t m0 x9 hd y361 fff fs7 fc3 sc0 ls1 ws1">with other shell commands. Try redir<span class="_ _3"></span>ecting the </div><div class="t m0 x9 hd y362 fff fs7 fc3 sc0 ls1 ws1">output to a file with “<span class="_ _b"></span>./HelloW<span class="_ _1"></span>orld &gt; myfile.txt” and </div><div class="t m0 x9 hd y363 fff fs7 fc3 sc0 ls1 ws1">piping the output to another Linux comm<span class="_ _3"></span>and such </div><div class="t m0 x9 hd y364 fff fs7 fc3 sc0 ls1 ws1">as “<span class="_ _b"></span>./HelloW<span class="_ _1"></span>orld | grep -I wor”<span class="_ _18"></span>.</div><div class="t m0 x1c hd y365 fff fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>6. <span class="_ _f"> </span>Estimate how m<span class="_ _3"></span>any Assembly Language comm<span class="_ _3"></span>ands </div><div class="t m0 x9 hd y366 fff fs7 fc3 sc0 ls1 ws1">are in a 32K executable<span class="_ _1"></span>. The Linux kernel is about </div><div class="t m0 x9 hd y367 fff fs7 fc3 sc0 ls1 ws1">5.1MB in size. If the Linux k<span class="_ _3"></span>ernel was written in </div><div class="t m0 x9 hd y368 fff fs7 fc3 sc0 ls1 ws1">Assembly Language<span class="_ _3"></span>, how many ins<span class="_ _3"></span>tructions would </div><div class="t m0 x9 hd y369 fff fs7 fc3 sc0 ls1 ws1">that be?</div><div class="t m0 x20 h12 y71 ff14 fsa fc3 sc0 ls1 ws1">CHAPTER 1 <span class="_ _f"> </span> GETTING ST<span class="_ _1"></span>ARTED</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf31" class="pf w2 h6" data-page-no="31"><div class="pc pc31 w2 h6"><div class="t m0 x12 hd y16a ff19 fs7 fc3 sc0 ls1 ws1">29</div><div class="t m0 xc h17 y16b ff19 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff19 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff1a">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff19">,  </span></span></div><div class="t m0 xc h17 y16d ff19 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_2</div><div class="t m0 xc ha y16e ff1b fs6 fc3 sc0 ls1 ws1">CHAPTER 2</div><div class="t m0 xc h23 y16f ff1c fs4 fc3 sc0 ls1 ws1">Loading andAd<span class="_ _0"></span>ding</div><div class="t m0 xc hd y170 ff19 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we will go slowly through the <span class="ff1d lsb wsb4">MOV</span> and <span class="ff1d">ADD</span> instructions </div><div class="t m0 xc hd y171 ff19 fs7 fc3 sc0 ls1 ws1">to lay the gr<span class="_ _3"></span>oundwork on how they work, es<span class="_ _3"></span>pecially in the way they handle </div><div class="t m0 xc hd y172 ff19 fs7 fc3 sc0 ls1 ws1">parameters (<span class="_ _1"></span>operands), so that, in the following ch<span class="_ _3"></span>apters<span class="_ _3"></span>, we can proceed </div><div class="t m0 xc hd y173 ff19 fs7 fc3 sc0 ls1 ws1">at a faster pace as we encounter the r<span class="_ _1"></span>est of the ARM instruction s<span class="_ _0"></span>et.</div><div class="t m0 x1c hd y174 ff19 fs7 fc3 sc0 ls1 ws1">Before getting in<span class="_ _3"></span>to the <span class="ff1d lsb wsb4">MOV</span> and <span class="ff1d">ADD</span> instructions, we will discuss </div><div class="t m0 xc hd y175 ff19 fs7 fc3 sc0 ls1 ws1">the repr<span class="_ _3"></span>esentation of <span class="ff1d">negative numbers</span> and the concepts of <span class="ff1d">shifting</span> and </div><div class="t m0 xc hd y176 ff1d fs7 fc3 sc0 ls1 ws1">rotating<span class="ff19"> bits<span class="_ _3"></span>.</span></div><div class="t m0 xc h15 y36a ff1e fsb fc3 sc0 ls1 wsaf"> Negative <span class="_ _11"> </span>Numbers</div><div class="t m0 xc hd y36b ff19 fs7 fc3 sc0 ls1 ws1">In the pr<span class="_ _3"></span>evious chapter<span class="_ _10"></span>, we discusse<span class="_ _0"></span>d how com<span class="_ _3"></span>puters repr<span class="_ _1"></span>esent positive </div><div class="t m0 xc hd y36c ff19 fs7 fc3 sc0 ls1 ws1">integers as binary numbers, c<span class="_ _3"></span>alled unsigned integers, but wh<span class="_ _3"></span>at about </div><div class="t m0 xc hd y36d ff19 fs7 fc3 sc0 ls1 ws1">negative num<span class="_ _3"></span>bers? Our first thought mi<span class="_ _3"></span>ght be to make one bit r<span class="_ _1"></span>epresent </div><div class="t m0 xc hd y36e ff19 fs7 fc3 sc0 ls1 ws1">whether the number is positive or nega<span class="_ _3"></span>tive. This is sim<span class="_ _3"></span>ple, but it t<span class="_ _3"></span>urns out </div><div class="t m0 xc hd y36f ff19 fs7 fc3 sc0 ls1 ws1">it requir<span class="_ _3"></span>es extra logic to implemen<span class="_ _3"></span>t, since now the CPU m<span class="_ _3"></span>ust look at the </div><div class="t m0 xc hd y370 ff19 fs7 fc3 sc0 ls1 ws1">sign bits, then decide whether to add or subtr<span class="_ _1"></span>act and in which order<span class="_ _6"></span>.</div><div class="t m0 x1c hd y371 ff19 fs7 fc3 sc0 lsa ws1">It turns o<span class="_ _3"></span>ut there is a simple r<span class="_ _1"></span>epresentation of negativ<span class="_ _3"></span>e numbers tha<span class="_ _3"></span>t </div><div class="t m0 xc hd y372 ff19 fs7 fc3 sc0 lsa ws1">works without any special cases or special logic; it is called two<span class="_ _1"></span>’<span class="_ _1"></span>s complement<span class="_ _3"></span>.</div><div class="t m0 xc ha y373 ff1e fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>About T<span class="_ _10"></span>wo’<span class="_ _6"></span>s Complement</div><div class="t m0 xc hd y374 ff19 fs7 fc3 sc0 ls1 ws1">The grea<span class="_ _3"></span>t mathem<span class="_ _3"></span>atician J<span class="_ _3"></span>ohn von Neum<span class="_ _3"></span>ann, of the Manh<span class="_ _3"></span>attan Pr<span class="_ _3"></span>oject, </div><div class="t m0 xc hd y375 ff19 fs7 fc3 sc0 ls1 ws1">came up with the idea of the <span class="ff1d">two’<span class="_ _3"></span>s complement<span class="ff19"> represen<span class="_ _3"></span>tation for </span></span></div><div class="t m0 xc hd y376 ff19 fs7 fc3 sc0 ls1 ws1">negative num<span class="_ _3"></span>bers, in 1945, when wor<span class="_ _3"></span>king on the Electronic Discr<span class="_ _3"></span>ete </div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf32" class="pf w2 h6" data-page-no="32"><div class="pc pc32 w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">30</div><div class="t m0 xd hd y145 ff19 fs7 fc3 sc0 ls1 ws1">V<span class="_ _6"></span>ar<span class="_ _0"></span>iable A<span class="_ _1"></span>utomatic Computer (EDV<span class="_ _6"></span>AC) computer<span class="_ _1"></span>—one of the earliest </div><div class="t m0 xd hd y146 ff19 fs7 fc3 sc0 ls1 ws1">electronic computers<span class="_ _1"></span>.</div><div class="t m0 xc hd y147 ff19 fs7 fc3 sc0 ls1 ws1">Two<span class="_ _1"></span>’<span class="_ _6"></span>s complement came about b<span class="_ _3"></span>y obser<span class="_ _0"></span>ving ho<span class="_ _3"></span>w addition overflows<span class="_ _1"></span>. </div><div class="t m0 xd hd y1b0 ff19 fs7 fc3 sc0 ls1 ws1">Consider a 1-byte hexadecimal n<span class="_ _3"></span>umber like 01. If we add</div><div class="t m0 xd h18 y2e2 ff1f fs7 fc3 sc0 ls1 ws1">0x01 + 0xFF = 0x100</div><div class="t m0 xd hd y2d9 ff19 fs7 fc3 sc0 ls1 ws1">(all binary ones) we get 0x100.</div><div class="t m0 xc hd y2da ff19 fs7 fc3 sc0 ls1 ws1">However<span class="_ _10"></span>, if we are limited to 1-byte num<span class="_ _3"></span>bers, then the 1 is lost and we </div><div class="t m0 xd hd y231 ff19 fs7 fc3 sc0 ls1 ws1">are left with 00:</div><div class="t m0 xd h18 y377 ff1f fs7 fc3 sc0 ls1 ws1">0x01 + 0xFF = 0x00</div><div class="t m0 xc hd y2dd ff19 fs7 fc3 sc0 ls1 ws1">The mathem<span class="_ _3"></span>atical definition of a num<span class="_ _3"></span>ber’<span class="_ _1"></span>s negative is a number th<span class="_ _3"></span>at </div><div class="t m0 xd hd y378 ff19 fs7 fc3 sc0 ls1 ws1">when added to it makes zer<span class="_ _3"></span>o; therefor<span class="_ _1"></span>e, mathema<span class="_ _3"></span>tically, FF is -1. Y<span class="_ _6"></span>ou can </div><div class="t m0 xd hd y379 ff19 fs7 fc3 sc0 ls1 ws1">get the two<span class="_ _1"></span>’<span class="_ _1"></span>s complement form for any number b<span class="_ _3"></span>y taking</div><div class="t m0 xd h18 y290 ff1f fs7 fc3 sc0 ls1 ws1">2</div><div class="t m0 x35 h19 y37a ff1f fsd fc3 sc0 ls1 ws1">N</div><div class="t m0 x11 h18 y2b0 ff1f fs7 fc3 sc0 ls1 ws1"> - number</div><div class="t m0 xd hd y37b ff19 fs7 fc3 sc0 ls1 ws1">where N is the num<span class="_ _3"></span>ber of bits in our integer<span class="_ _10"></span>. In our example, the two<span class="_ _1"></span>’<span class="_ _6"></span>s </div><div class="t m0 xd hd y37c ff19 fs7 fc3 sc0 ls1 ws1">complement of 1 is</div><div class="t m0 xd h18 y37d ff1f fs7 fc3 sc0 ls1 ws1">2</div><div class="t m0 x35 h19 y37e ff1f fsd fc3 sc0 ls1 ws1">8</div><div class="t m0 x11 h18 y37f ff1f fs7 fc3 sc0 ls1 ws1"> - 1 = 256 - 1 = 255 = 0xFF</div><div class="t m0 xc hd y380 ff19 fs7 fc3 sc0 ls1 ws1">This is why it’<span class="_ _6"></span>s called two<span class="_ _3"></span>’<span class="_ _6"></span>s complement. An easier way t<span class="_ _3"></span>o calculate the </div><div class="t m0 xd hd y381 ff19 fs7 fc3 sc0 ls1 ws1">two<span class="_ _1"></span>’<span class="_ _1"></span>s complement is to chan<span class="_ _3"></span>ge all the 1s to 0s and all the 0s to 1s and then </div><div class="t m0 xd hd y382 ff19 fs7 fc3 sc0 ls1 ws1">add 1. If we do that to 1, we get</div><div class="t m0 xd h18 y383 ff1f fs7 fc3 sc0 ls1 ws1">0xFE + 1 = 0xFF</div><div class="t m0 xc hd y384 ff19 fs7 fc3 sc0 ls1 ws1">Two<span class="_ _1"></span>’<span class="_ _6"></span>s complement is an inter<span class="_ _3"></span>esting mathem<span class="_ _3"></span>atical oddity for integers<span class="_ _1"></span>, </div><div class="t m0 xd hd y385 ff19 fs7 fc3 sc0 ls1 ws1">which are limited to ha<span class="_ _1"></span>ving a maximum value of one less than a power of </div><div class="t m0 xd hd y386 ff19 fs7 fc3 sc0 ls1 ws1">two (which is all computer repr<span class="_ _1"></span>esentations of integers).</div><div class="t m0 xc hd y387 ff19 fs7 fc3 sc0 ls1 ws1">Why would we want to r<span class="_ _1"></span>epresent negative integers this wa<span class="_ _1"></span>y on </div><div class="t m0 xd hd y388 ff19 fs7 fc3 sc0 ls1 ws1">computers? As it turns out<span class="_ _3"></span>, this makes addition simple for the comp<span class="_ _3"></span>uter </div><div class="t m0 xd hd y389 ff19 fs7 fc3 sc0 ls1 ws1">to execute. A<span class="_ _3"></span>dding signed integers is the same as adding unsi<span class="_ _3"></span>gned </div><div class="t m0 xd hd y38a ff19 fs7 fc3 sc0 ls1 ws1">integers. T<span class="_ _3"></span>here ar<span class="_ _1"></span>e no spe<span class="_ _0"></span>cial cases<span class="_ _1"></span>, all you do is discard the overflow, and </div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf33" class="pf w2 h6" data-page-no="33"><div class="pc pc33 w2 h6"><img class="bi xc y38b w7 h24" alt="" src="bg33.png"/><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">31</div><div class="t m0 xc hd y38c ff19 fs7 fc3 sc0 ls1 ws1">everything works out. This means less cir<span class="_ _3"></span>cuitry is required to perform the </div><div class="t m0 xc hd y38d ff19 fs7 fc3 sc0 ls1 ws1">addition, and as a result<span class="_ _3"></span>, it can be performed faster<span class="_ _6"></span>. Consider</div><div class="t m0 xc h18 y38e ff1f fs7 fc3 sc0 ls1 ws1">5 + -3</div><div class="t m0 xc hd y38f ff19 fs7 fc3 sc0 ls1 ws1">3in 1 byte is 0x03 or 0000 0011.</div><div class="t m0 x1c hd y390 ff19 fs7 fc3 sc0 ls1 ws1">Inv<span class="_ _3"></span>erting the bits is</div><div class="t m0 xc h18 y391 ff1f fs7 fc3 sc0 ls1 ws1">1111 1100</div><div class="t m0 x1c hd y392 ff19 fs7 fc3 sc0 ls1 ws1">Add 1 to get</div><div class="t m0 xc h18 y393 ff1f fs7 fc3 sc0 ls1 ws1">1111 1101 = 0xFD</div><div class="t m0 x1c hd y394 ff19 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w add</div><div class="t m0 xc h18 y395 ff1f fs7 fc3 sc0 ls1 ws1">5 + 0xFD = 0x102 = 2</div><div class="t m0 xc hd y396 ff19 fs7 fc3 sc0 ls1 ws1">since we are limited to 1 byt<span class="_ _3"></span>e or 8 bits.</div><div class="t m0 x1c hd y397 ff19 fs7 fc3 sc0 ls1 ws1">Performing these computations by h<span class="_ _3"></span>and is educational, b<span class="_ _3"></span>ut practically </div><div class="t m0 xc hd y398 ff19 fs7 fc3 sc0 ls1 ws1">a tool to do this would be handy.</div><div class="t m0 xc ha y37f ff1e fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>About Gnome Programmer’<span class="_ _1"></span>s Calculator</div><div class="t m0 xc hd y399 ff19 fs7 fc3 sc0 ls15 ws1">Fortun<span class="_ _3"></span>ately, we ha<span class="_ _1"></span>ve computers to do the conversions and arithmetic for </div><div class="t m0 xc hd y39a ff19 fs7 fc3 sc0 ls15 ws1">us, but when we see signed numbers in memory, we need to recognize </div><div class="t m0 xc hd y39b ff19 fs7 fc3 sc0 ls15 ws1">what they ar<span class="_ _3"></span>e. The <span class="ff1d">Gnome programmer<span class="_ _0"></span>’<span class="_ _3"></span>s calculator<span class="ff19"> can calculate<span class="_ _1"></span> </span></span></div><div class="t m0 xc hd y39c ff19 fs7 fc3 sc0 ls15 ws1">two<span class="_ _1"></span>’<span class="_ _1"></span>s complement for you. F<span class="_ _1"></span>igure<span class="fc5 wsb8">2-1</span> shows the Gnome calcula<span class="_ _3"></span>tor </div><div class="t m0 xc hd y39d ff19 fs7 fc3 sc0 ls15 ws1">repr<span class="_ _3"></span>esenting -3.</div><div class="t m0 x36 h1f y39e ff1e fse fc3 sc0 ls1 ws1">Note<span class="ff20"> <span class="_ _17"> </span>The Gnome programmer’<span class="_ _6"></span>s calcula<span class="_ _0"></span>tor uses 64-bit </span></div><div class="t m0 x36 h1f y39f ff20 fse fc3 sc0 ls1 ws1">representations.</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf34" data-dest-detail='[52,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:215.137000px;bottom:209.362000px;width:15.345000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf34" class="pf w2 h6" data-page-no="34"><div class="pc pc34 w2 h6"><img class="bi x2 y3a0 w6 h25" alt="" src="bg34.png"/><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">32</div><div class="t m0 xc hd y3a1 ff19 fs7 fc3 sc0 ls1 ws1">Two<span class="_ _1"></span>’<span class="_ _6"></span>s complement is the standard r<span class="_ _1"></span>epresentation of negative in<span class="_ _3"></span>tegers<span class="_ _0"></span>; </div><div class="t m0 xd hd y3a2 ff19 fs7 fc3 sc0 ls1 ws1">however<span class="_ _6"></span>, just r<span class="_ _3"></span>eversing all the bits does ha<span class="_ _1"></span>ve its uses.</div><div class="t m0 xd ha y3a3 ff1e fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>About One’<span class="_ _1"></span>s Complement</div><div class="t m0 xd hd y3a4 ff19 fs7 fc3 sc0 ls1 ws1">If we don’t add 1, and just change all the 1s to 0s and vice versa<span class="_ _1"></span>, then this is </div><div class="t m0 xd hd y3a5 ff19 fs7 fc3 sc0 ls1 ws1">called <span class="ff1d">one’<span class="_ _3"></span>s complement<span class="ff19">. There ar<span class="_ _3"></span>e uses for the one’<span class="_ _6"></span>s complement form, </span></span></div><div class="t m0 xd hd y3a6 ff19 fs7 fc3 sc0 ls1 ws1">and we will encounter it in how some instructions process their oper<span class="_ _3"></span>ands.</div><div class="t m0 xc hd y3a7 ff19 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w let’<span class="_ _1"></span>s r<span class="_ _3"></span>eturn to the order the b<span class="_ _3"></span>ytes that m<span class="_ _3"></span>ake up an integer ar<span class="_ _3"></span>e </div><div class="t m0 xd hd y3a8 ff19 fs7 fc3 sc0 ls1 ws1">stored in memory.</div><div class="t m0 xd h26 y3a9 ff21 fs3 fc3 sc0 ls1 ws1">Figure 2-1. <span class="_ _15"> </span><span class="ff1a">The Gnome programmer’<span class="_ _6"></span>s calculator calculating the </span></div><div class="t m0 xd h26 y3aa ff1a fs3 fc3 sc0 ls1 ws1">two<span class="_ _1"></span>’<span class="_ _1"></span>s complement of 3</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf35" class="pf w2 h6" data-page-no="35"><div class="pc pc35 w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">33</div><div class="t m0 xc h15 y186 ff1e fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Big vs.<span class="_ _6"></span> Little Endian</div><div class="t m0 xc hd y187 ff19 fs7 fc3 sc0 ls1 ws1">At the end of Ch<span class="_ _3"></span>apter <span class="fc5">1</span>, “<span class="_ _1"></span>G<span class="_ _0"></span>etting S<span class="_ _3"></span>tarted,<span class="_ _8"></span>” we saw that the wor<span class="_ _3"></span>ds of our </div><div class="t m0 xc hd y188 ff19 fs7 fc3 sc0 ls1 ws1">compiled progr<span class="_ _3"></span>am had their bytes st<span class="_ _3"></span>ored in the r<span class="_ _3"></span>everse order to wh<span class="_ _3"></span>at </div><div class="t m0 xc hd y2be ff19 fs7 fc3 sc0 ls1 ws1">we might expect they should be stored as<span class="_ _1"></span>. In fact, if we look at a 32-bit </div><div class="t m0 xc hd y18a ff19 fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esentation of 1 stor<span class="_ _1"></span>ed in memor<span class="_ _0"></span>y, it is</div><div class="t m0 xc h18 y3ab ff1f fs7 fc3 sc0 ls1 ws1">01 00 00 00</div><div class="t m0 xc hd y3ac ff19 fs7 fc3 sc0 ls1 ws1">rather th<span class="_ _3"></span>an</div><div class="t m0 xc h18 y3ad ff1f fs7 fc3 sc0 ls1 ws1">00 00 00 01</div><div class="t m0 x1c hd y3ae ff19 fs7 fc3 sc0 ls1 ws1">Most pr<span class="_ _3"></span>ocessors pick one format, or the other to s<span class="_ _3"></span>tore num<span class="_ _3"></span>bers. </div><div class="t m0 xc hd y3af ff19 fs7 fc3 sc0 ls1 ws1">Motor<span class="_ _3"></span>ola and IBM mainfr<span class="_ _3"></span>ames use what is called big endian, wher<span class="_ _1"></span>e </div><div class="t m0 xc hd y3b0 ff19 fs7 fc3 sc0 ls1 ws1">numbers ar<span class="_ _3"></span>e stored in the or<span class="_ _1"></span>der of most significant digit to least significant </div><div class="t m0 xc hd y3b1 ff19 fs7 fc3 sc0 ls1 ws1">digit, in this case</div><div class="t m0 xc h18 y3b2 ff1f fs7 fc3 sc0 ls1 ws1">00 00 00 01</div><div class="t m0 x1c hd y3b3 ff19 fs7 fc3 sc0 ls1 ws1">Intel pr<span class="_ _1"></span>ocess<span class="_ _0"></span>ors use little-endian format and s<span class="_ _3"></span>tore the num<span class="_ _3"></span>bers in </div><div class="t m0 xc hd y3b4 ff19 fs7 fc3 sc0 ls1 ws1">reverse or<span class="_ _3"></span>der with the least significant digit first<span class="_ _3"></span>, namely:</div><div class="t m0 xc h18 y3b5 ff1f fs7 fc3 sc0 ls1 ws1">01 00 00 00</div><div class="t m0 x1c hd y3b6 ff19 fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">2-2</span> shows ho<span class="_ _3"></span>w the bytes in in<span class="_ _3"></span>tegers are copied into memory </div><div class="t m0 xc hd y3b7 ff19 fs7 fc3 sc0 ls1 ws1">in both little- and big-endian formats<span class="_ _3"></span>. Notice ho<span class="_ _3"></span>w the bytes end up in the </div><div class="t m0 xc hd y3b8 ff19 fs7 fc3 sc0 ls1 ws1">reverse or<span class="_ _3"></span>der to each other<span class="_ _10"></span>.</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:155.859000px;bottom:547.090000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf36" data-dest-detail='[54,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:104.032000px;bottom:243.090000px;width:15.047000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf36" class="pf w2 h6" data-page-no="36"><div class="pc pc36 w2 h6"><img class="bi x37 y3b9 w9 h27" alt="" src="bg36.png"/><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">34</div><div class="t m0 xc hd y3ba ff19 fs7 fc3 sc0 ls1 ws1">The designers of the ARM pr<span class="_ _3"></span>ocessor didn’t want to take sides in the </div><div class="t m0 xd hd y3bb ff19 fs7 fc3 sc0 ls1 ws1">little- vs. bi<span class="_ _3"></span>g-endian debate<span class="_ _3"></span>, so they made the ARM processor support </div><div class="t m0 xd hd y3bc ff19 fs7 fc3 sc0 ls1 ws1">both.</div><div class="t m0 xd ha y3bd ff1e fs6 fc3 sc0 ls1 wsb1"> About <span class="_ _14"> </span>Bi-endian</div><div class="t m0 xd hd y3be ff19 fs7 fc3 sc0 ls1 ws1">The ARM CPU is called <span class="ff1d">bi-endian</span>, because it can do either<span class="_ _6"></span>. Most ARM<span class="_ _1"></span>- </div><div class="t m0 xd hd y3bf ff19 fs7 fc3 sc0 ls1 ws1">based computers use little-endian format. This inc<span class="_ _3"></span>ludes all the systems </div><div class="t m0 xd hd y3c0 ff19 fs7 fc3 sc0 ls1 ws1">we’ll co<span class="_ _3"></span>ver in this book.</div><div class="t m0 xc hd y3c1 ff19 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w let’<span class="_ _1"></span>s look at wh<span class="_ _3"></span>y most ARM<span class="_ _1"></span>-based computers use little vs. big </div><div class="t m0 xd hd y3c2 ff19 fs7 fc3 sc0 ls1 ws1">endian.</div><div class="t m0 xd ha y3c3 ff1e fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Pros ofLittle Endian</div><div class="t m0 xd hd y3c4 ff19 fs7 fc3 sc0 ls1 ws1">The advantage of little-endian forma<span class="_ _3"></span>t is that it m<span class="_ _3"></span>akes it easy to change </div><div class="t m0 xd hd y3c5 ff19 fs7 fc3 sc0 ls1 ws1">the size of integers<span class="_ _3"></span>, without requiring any addr<span class="_ _3"></span>ess arithmetic. If you want </div><div class="t m0 xd hd y3c6 ff19 fs7 fc3 sc0 ls1 ws1">to convert a 4-byte in<span class="_ _3"></span>teger to a 1-byte integer<span class="_ _10"></span>, you take the first byte<span class="_ _1"></span>. </div><div class="t m0 xd hd y3c7 ff19 fs7 fc3 sc0 ls1 ws1">Assuming the integer is in the r<span class="_ _3"></span>ange of 0–255, and the other three b<span class="_ _3"></span>ytes are </div><div class="t m0 xd hd y3c8 ff19 fs7 fc3 sc0 ls1 ws1">zero<span class="_ _1"></span>. For exam<span class="_ _3"></span>ple, if memory contains the 4 bytes or wor<span class="_ _3"></span>d for 1, in little </div><div class="t m0 xd hd y3c9 ff19 fs7 fc3 sc0 ls1 ws1">endian, the memory contains</div><div class="t m0 xd h18 y3ca ff1f fs7 fc3 sc0 ls1 ws1">01 00 00 00</div><div class="t m0 xd h26 y3cb ff21 fs3 fc3 sc0 ls1 ws1">Figure 2-2. <span class="_ _15"> </span><span class="ff1a">Ho<span class="_ _3"></span>w integers are stor<span class="_ _3"></span>ed in memor<span class="_ _0"></span>y in little- vs<span class="_ _1"></span>. big- </span></div><div class="t m0 xd h26 y3cc ff1a fs3 fc3 sc0 ls1 ws1">endian format</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf37" class="pf w2 h6" data-page-no="37"><div class="pc pc37 w2 h6"><img class="bi xc y3cd w7 h28" alt="" src="bg37.png"/><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">35</div><div class="t m0 x1c hd y3ce ff19 fs7 fc3 sc0 ls1 ws1">If we want the 1-byte r<span class="_ _1"></span>epresentation of this number<span class="_ _10"></span>, we take the first </div><div class="t m0 xc hd y3cf ff19 fs7 fc3 sc0 ls1 ws1">byte; for the 16-bit r<span class="_ _3"></span>epresenta<span class="_ _3"></span>tion, we take the first two bytes<span class="_ _1"></span>. The key </div><div class="t m0 xc hd y3d0 ff19 fs7 fc3 sc0 ls1 ws1">point is that the memory address we use is the same in all cases<span class="_ _3"></span>, sa<span class="_ _3"></span>ving us </div><div class="t m0 xc hd y3d1 ff19 fs7 fc3 sc0 ls1 ws1">an instruction cycle adjusting it.</div><div class="t m0 x1c hd y3d2 ff19 fs7 fc3 sc0 ls1 ws1">When we are in the debugger<span class="_ _10"></span>, we will s<span class="_ _0"></span>ee mor<span class="_ _3"></span>e repr<span class="_ _1"></span>es<span class="_ _0"></span>enta<span class="_ _3"></span>tions, and </div><div class="t m0 xc hd y3d3 ff19 fs7 fc3 sc0 ls1 ws1">these will be pointed out again as we run into them.</div><div class="t m0 x36 h1f y3d4 ff1e fse fc3 sc0 ls1 ws1">Note<span class="ff20"> <span class="_ _19"> </span>Even though Linux uses little endian,<span class="_ _1"></span> many protocols </span></div><div class="t m0 x36 h1f y3d5 ff20 fse fc3 sc0 ls1 ws1">like <span class="_ _1"></span>TCP/IP used on the Internet use big endian and so require a </div><div class="t m0 x36 h1f y3d6 ff20 fse fc3 sc0 ls1 ws1">transformation when moving da<span class="_ _0"></span>ta from the computer to the outside </div><div class="t m0 x36 h1f y3d7 ff20 fse fc3 sc0 ls1 ws1">world.</div><div class="t m0 x1c hd y3d8 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve look<span class="_ _3"></span>ed at how integers ar<span class="_ _1"></span>e represented and how addition work<span class="_ _3"></span>s. </div><div class="t m0 xc hd y3d9 ff19 fs7 fc3 sc0 ls1 ws1">It turns o<span class="_ _3"></span>ut that another useful simple manip<span class="_ _3"></span>ulation is shifting the bits </div><div class="t m0 xc hd y3da ff19 fs7 fc3 sc0 ls1 ws1">right or left and rota<span class="_ _3"></span>ting them aro<span class="_ _3"></span>und inside a register<span class="_ _10"></span>.</div><div class="t m0 xc h15 y3db ff1e fsb fc3 sc0 ls1 wsaf"> Shifting <span class="_ _11"> </span>andRotating</div><div class="t m0 xc hd y3dc ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e have 31 64-bit r<span class="_ _1"></span>e<span class="_ _0"></span>gisters and m<span class="_ _3"></span>uch of progr<span class="_ _3"></span>amming consists of </div><div class="t m0 xc hd y3dd ff19 fs7 fc3 sc0 ls1 ws1">manipulatin<span class="_ _3"></span>g the bits in these registers<span class="_ _3"></span>. T<span class="_ _3"></span>wo extremely useful bit </div><div class="t m0 xc hd y3de ff19 fs7 fc3 sc0 ls1 ws1">manipulations ar<span class="_ _1"></span>e shifting and rotating. M<span class="_ _1"></span>athematically shifting all the </div><div class="t m0 xc hd y3df ff19 fs7 fc3 sc0 ls1 ws1">bits left one spot is the same as multiplying b<span class="_ _3"></span>y 2, and generally shifting n </div><div class="t m0 xc hd y3e0 ff19 fs7 fc3 sc0 ls1 ws1">bits is equivalent to multiplying b<span class="_ _1"></span>y 2</div><div class="t m0 x2a h1b y3e1 ff19 fsd fc3 sc0 ls1 ws1">n</div><div class="t m0 x38 hd y3e2 ff19 fs7 fc3 sc0 ls1 ws1">. Conversely, shifting bits to the righ<span class="_ _3"></span>t </div><div class="t m0 xc hd y3e3 ff19 fs7 fc3 sc0 ls1 ws1">by n bits is equivalent to dividin<span class="_ _3"></span>g by 2</div><div class="t m0 x39 h1b y3e4 ff19 fsd fc3 sc0 ls1 ws1">n</div><div class="t m0 x3a hd y3e5 ff19 fs7 fc3 sc0 ls1 ws1">. For exam<span class="_ _3"></span>ple, consider shifting the </div><div class="t m0 xc hd y3e6 ff19 fs7 fc3 sc0 ls1 ws1">number 3 left by 4 bits:</div><div class="t m0 xc h18 y3e7 ff1f fs7 fc3 sc0 ls1 ws1">0000 0011   (the binary representation of the number 3)</div><div class="t m0 x2b h12 y3e8 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf38" class="pf w2 h6" data-page-no="38"><div class="pc pc38 w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">36</div><div class="t m0 xc hd y145 ff19 fs7 fc3 sc0 ls1 ws1">Shift the bits left by 4 bits and we get</div><div class="t m0 xd h18 y2e0 ff1f fs7 fc3 sc0 ls1 ws1">0011 0000</div><div class="t m0 xd hd y3e9 ff19 fs7 fc3 sc0 ls1 ws1">which is</div><div class="t m0 xd h18 y3ea ff1f fs7 fc3 sc0 ls1 ws1">0x30 = 3 * 16 = 3 * 2</div><div class="t m0 x8 h19 y3eb ff1f fsd fc3 sc0 ls1 ws1">4</div><div class="t m0 xc hd y30f ff19 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w if we shift 0x30 right by 4 bits<span class="_ _3"></span>, we undo what we just did and see </div><div class="t m0 xd hd y3ec ff19 fs7 fc3 sc0 ls1 ws1">how it is equivalent to dividing b<span class="_ _1"></span>y 16.</div><div class="t m0 xc hd y3ed ff19 fs7 fc3 sc0 ls1 ws1">When we shift and rotate<span class="_ _1"></span>, it turns out to be useful to include the carr<span class="_ _0"></span>y </div><div class="t m0 xd hd y312 ff19 fs7 fc3 sc0 ls1 ws1">flag. This means we can do a conditional logic based on the last bit shifted </div><div class="t m0 xd hd y3ee ff19 fs7 fc3 sc0 ls1 ws1">out of the register<span class="_ _10"></span>.</div><div class="t m0 xd ha y3ef ff1e fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>About Carr<span class="_ _0"></span>y Flag</div><div class="t m0 xd hd y3f0 ff19 fs7 fc3 sc0 ls1 ws1">When instructions execute, they can optionally set some flags th<span class="_ _3"></span>at contain </div><div class="t m0 xd hd y3f1 ff19 fs7 fc3 sc0 ls1 ws1">useful information on what h<span class="_ _3"></span>appened. Then other instructions can test </div><div class="t m0 xd hd y3f2 ff19 fs7 fc3 sc0 ls1 ws1">these flags and process accor<span class="_ _1"></span>dingly. O<span class="_ _0"></span>ne of these is the <span class="ff1d">carry flag</span>. This is </div><div class="t m0 xd hd y3f3 ff19 fs7 fc3 sc0 ls1 ws1">normally used when performing addition of larger numbers. If you add </div><div class="t m0 xd hd y3f4 ff19 fs7 fc3 sc0 ls1 ws1">two 64-bit numbers and the res<span class="_ _3"></span>ult is larger than 64 bits<span class="_ _3"></span>, the carry flag is </div><div class="t m0 xd hd y3f5 ff19 fs7 fc3 sc0 ls1 ws1">set. W<span class="_ _1"></span>e’ll see how to use this when we look at addition in detail later in this </div><div class="t m0 xd hd y3f6 ff19 fs7 fc3 sc0 ls8 ws9f">chapter<span class="_ _10"></span>.</div><div class="t m0 xc hd y3f7 ff19 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at how shifting is implemen<span class="_ _3"></span>ted in an ARM processor<span class="_ _10"></span>.</div><div class="t m0 xd ha y3f8 ff1e fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>About theBarrel Shifter</div><div class="t m0 xd hd y3f9 ff19 fs7 fc3 sc0 ls1 ws1">The ARM processor has cir<span class="_ _1"></span>cuitr<span class="_ _0"></span>y for shifting, called a <span class="ff1d">barrel shifter</span>. T<span class="_ _3"></span>here </div><div class="t m0 xd hd y3fa ff19 fs7 fc3 sc0 ls1 ws1">are instructions to access this dir<span class="_ _3"></span>ectly, which we will cover<span class="_ _10"></span>. But more </div><div class="t m0 xd hd y3fb ff19 fs7 fc3 sc0 ls1 ws1">often shifting can be incorpora<span class="_ _3"></span>ted into other instructions like the <span class="ff1d ls16 wsb9">MOVK<span class="_ _0"></span></span> </div><div class="t m0 xd hd y3fc ff19 fs7 fc3 sc0 ls1 ws1">instruction. The reason for this is tha<span class="_ _3"></span>t the barrel shifter is outside the </div><div class="t m0 xd hd y3fd ff19 fs7 fc3 sc0 ls1 ws1">arithmetic logic unit (<span class="ff1d ls17 wsba">A<span class="_ _0"></span>LU</span>); instead it<span class="_ _0"></span>’<span class="_ _6"></span>s part of the circuitry that loads the </div><div class="t m0 xd hd y3fe ff19 fs7 fc3 sc0 ls1 ws1">second operand to an instruction. W<span class="_ _1"></span>e’ll see this in action when we cover </div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf39" class="pf w2 h6" data-page-no="39"><div class="pc pc39 w2 h6"><img class="bi x3b y3ff wa h29" alt="" src="bg39.png"/><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">37</div><div class="t m0 xc hd y145 ff1d fs7 fc3 sc0 ls1 ws1">Operand2<span class="ff19"> for the </span><span class="lsb wsb4">MOV</span><span class="ff19"> instr<span class="_ _0"></span>uction. F<span class="_ _1"></span>igure<span class="fc5">2-3</span> shows the location of the </span></div><div class="t m0 xc hd y146 ff19 fs7 fc3 sc0 ls1 ws1">barrel shifter in r<span class="_ _3"></span>elation to the AL<span class="_ _3"></span>U<span class="_ _1"></span>.</div><div class="t m0 x1c hd y400 ff19 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s get into the details of shifting and rota<span class="_ _3"></span>ting.</div><div class="t m0 xc ha y401 ff1e fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Basics ofShifting andRotating</div><div class="t m0 xc hd y402 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e have four c<span class="_ _3"></span>ases to cover<span class="_ _10"></span>, as follows<span class="_ _0"></span>:</div><div class="t m0 x1e hd y403 ff19 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Logical shift left</div><div class="t m0 x1e hd y404 ff19 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Logical shift right</div><div class="t m0 x1e hd y405 ff19 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Arithmetic shift right</div><div class="t m0 x1e hd y406 ff19 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Rotate right</div><div class="t m0 xc h26 y407 ff21 fs3 fc3 sc0 ls1 ws1">Figure 2-3. <span class="_ _15"> </span><span class="ff1a">The location of the barrel shifter to perf<span class="_ _0"></span>orm shifts as part </span></div><div class="t m0 xc h26 y408 ff1a fs3 fc3 sc0 ls1 ws1">of loading Operand2</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf39" data-dest-detail='[57,"XYZ",53,544,null]'><div class="d m1" style="border-style:none;position:absolute;left:254.373000px;bottom:577.175000px;width:15.048000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf3a" class="pf w2 h6" data-page-no="3a"><div class="pc pc3a w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">38</div><div class="t m0 xd h2a y409 ff1e fsf fc3 sc0 ls1 ws1"> <span class="_ _1a"></span>Logical Shift Left</div><div class="t m0 xd hd y40a ff19 fs7 fc3 sc0 ls1 ws1">This is quite straigh<span class="_ _3"></span>tforward; as we shift the bits left by the indicated </div><div class="t m0 xd hd y40b ff19 fs7 fc3 sc0 ls1 ws1">number of places<span class="_ _3"></span>, zeros come in fr<span class="_ _1"></span>om the r<span class="_ _0"></span>igh<span class="_ _3"></span>t. The last bit shifted out </div><div class="t m0 xd hd y40c ff19 fs7 fc3 sc0 ls1 ws1">ends up in the carr<span class="_ _0"></span>y flag<span class="_ _3"></span>.</div><div class="t m0 xd h2a y40d ff1e fsf fc3 sc0 ls1 ws1"> <span class="_ _1a"></span>Logical Shift Right</div><div class="t m0 xd hd y40e ff19 fs7 fc3 sc0 ls1 ws1">Equally easy as logical shift left, her<span class="_ _1"></span>e w<span class="_ _0"></span>e shift the bits right<span class="_ _3"></span>, then zeros </div><div class="t m0 xd hd y40f ff19 fs7 fc3 sc0 ls1 ws1">come in from the left, and the l<span class="_ _3"></span>ast bit shifted out ends up in the carry flag.</div><div class="t m0 xd h2a y410 ff1e fsf fc3 sc0 ls1 ws1"> <span class="_ _1a"></span>Arithmetic Shift Right</div><div class="t m0 xd hd y411 ff19 fs7 fc3 sc0 ls1 ws1">The problem with logical shift right is if it’<span class="_ _6"></span>s a negative num<span class="_ _3"></span>ber<span class="_ _6"></span>, havin<span class="_ _3"></span>g a </div><div class="t m0 xd hd y412 ff19 fs7 fc3 sc0 ls1 ws1">zero come in fr<span class="_ _1"></span>om the left suddenly turns the number positive. If we want </div><div class="t m0 xd hd y413 ff19 fs7 fc3 sc0 ls1 ws1">to preserve the sign bit, use arithmetic shift right. Her<span class="_ _1"></span>e a 1 comes in from </div><div class="t m0 xd hd y414 ff19 fs7 fc3 sc0 ls1 ws1">the left, if the number is nega<span class="_ _3"></span>tive, and a 0 if it is positiv<span class="_ _3"></span>e. This is then the </div><div class="t m0 xd hd y415 ff19 fs7 fc3 sc0 ls1 ws1">correct form if you are shiftin<span class="_ _3"></span>g signed integers.</div><div class="t m0 xd h2a y416 ff1e fsf fc3 sc0 ls1 wsbb"> Rotate <span class="_ _1b"> </span>Right</div><div class="t m0 xd hd y417 ff19 fs7 fc3 sc0 ls1 ws1">Rotating is like shiftin<span class="_ _3"></span>g, except the bits don’t go off the end; instead they </div><div class="t m0 xd hd y418 ff19 fs7 fc3 sc0 ls1 ws1">wrap ar<span class="_ _3"></span>ound and r<span class="_ _3"></span>eappear from the other side<span class="_ _1"></span>. S<span class="_ _0"></span>o<span class="_ _1"></span>, rotate righ<span class="_ _3"></span>t shifts right, </div><div class="t m0 xd hd y419 ff19 fs7 fc3 sc0 ls1 ws1">but the bits that lea<span class="_ _1"></span>ve on the right reappear on the left.</div><div class="t m0 xc hd y41a ff19 fs7 fc3 sc0 ls1 ws1">That concludes the theory part of the chapter<span class="_ _0"></span>; now we r<span class="_ _3"></span>eturn to writing </div><div class="t m0 xd hd y41b ff19 fs7 fc3 sc0 ls1 ws1">Assembly Language code by goin<span class="_ _3"></span>g into the details of loading values in<span class="_ _3"></span>to </div><div class="t m0 xd hd y41c ff19 fs7 fc3 sc0 ls1 ws1">the registers<span class="_ _1"></span>.</div><div class="t m0 xd h15 y41d ff1e fsb fc3 sc0 ls1 wsaf"> Loading <span class="_ _11"> </span>Registers</div><div class="t m0 xd hd y41e ff19 fs7 fc3 sc0 ls1 ws1">In this section, we look at various ways to load r<span class="_ _1"></span>egisters with values </div><div class="t m0 xd hd y41f ff19 fs7 fc3 sc0 ls1 ws1">contained in instructions or other registers<span class="_ _1"></span>. We<span class="_ _1"></span>’ll look at loading registers </div><div class="t m0 xd hd y420 ff19 fs7 fc3 sc0 ls1 ws1">from memory in Chapter <span class="fc5">5</span>, “Thanks for the Memories<span class="_ _3"></span>.<span class="_ _8"></span>”</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:155.018000px;bottom:85.945900px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf3b" class="pf w2 h6" data-page-no="3b"><div class="pc pc3b w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">39</div><div class="t m0 x1c hd y145 ff19 fs7 fc3 sc0 ls1 ws1">First<span class="_ _3"></span>, the ARM engineers worked har<span class="_ _1"></span>d to minimize the number of </div><div class="t m0 xc hd y146 ff19 fs7 fc3 sc0 ls1 ws1">instructions required, and we<span class="_ _3"></span>’ll look at another technique they used to </div><div class="t m0 xc hd y147 ff19 fs7 fc3 sc0 ls1 ws1">accomplish this.</div><div class="t m0 xc ha y30e ff1e fs6 fc3 sc0 ls1 wsb1"> Instruction <span class="_ _14"> </span>Aliases</div><div class="t m0 xc hd y30f ff19 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>Getting Started,<span class="_ _8"></span>” in our Hello W<span class="_ _1"></span>orld sample progr<span class="_ _3"></span>am, we </div><div class="t m0 xc hd y310 ff19 fs7 fc3 sc0 ls1 ws1">used the <span class="ff1d lsb wsb4">MOV</span> instruction to load the values we nee<span class="_ _0"></span>ded into r<span class="_ _1"></span>egisters. </div><div class="t m0 xc hd y311 ff19 fs7 fc3 sc0 ls1 ws1">However<span class="_ _10"></span>, <span class="ff1d lsb wsb4">MOV</span> isn’t an ARM Assembly instruction; it<span class="_ _0"></span>’<span class="_ _6"></span>s an alias. Y<span class="_ _6"></span>ou’re </div><div class="t m0 xc hd y312 ff19 fs7 fc3 sc0 ls1 ws1">telling the Assembler what y<span class="_ _3"></span>ou want to do; then the Assembler finds a r<span class="_ _1"></span>eal </div><div class="t m0 xc hd y3ee ff19 fs7 fc3 sc0 ls1 ws1">ARM instruction to do the job<span class="_ _3"></span>. If it can’t find an instruction to do what y<span class="_ _3"></span>ou </div><div class="t m0 xc hd y421 ff19 fs7 fc3 sc0 ls1 ws1">specified, then you get an error<span class="_ _10"></span>.</div><div class="t m0 x1c hd y422 ff19 fs7 fc3 sc0 ls1 ws1">Consider</div><div class="t m0 xc h18 y423 ff1f fs7 fc3 sc0 ls1 ws1">ADD X0, XZR, X1</div><div class="t m0 x1c hd y424 ff19 fs7 fc3 sc0 ls1 ws1">This instruction adds the contents of r<span class="_ _3"></span>egister <span class="ff1d">X1</span> to the zer<span class="_ _3"></span>o register </div><div class="t m0 xc hd y425 ff19 fs7 fc3 sc0 ls1 ws1">and puts the result in <span class="ff1d">X0</span>. T<span class="_ _3"></span>his essentially mov<span class="_ _3"></span>es <span class="ff1d">X1</span><span class="ls8 ws9f"> to </span><span class="ff1d">X0</span>. Thus<span class="_ _3"></span>, we don’t </div><div class="t m0 xc hd y426 ff19 fs7 fc3 sc0 ls1 ws1">need an instruction:</div><div class="t m0 xc h18 y427 ff1f fs7 fc3 sc0 ls1 ws1">MOV X0, X1</div><div class="t m0 x1c hd y428 ff19 fs7 fc3 sc0 ls1 ws1">(MOV X0, X1 actually tr<span class="_ _3"></span>anslates to ORR X0, XZR, X1, and we’ll talk </div><div class="t m0 xc hd y429 ff19 fs7 fc3 sc0 ls1 ws1">about the ORR instruction in Chapter <span class="fc5">4</span>, “<span class="_ _1"></span>Controlling Pr<span class="_ _1"></span>ogram Flow,<span class="_ _8"></span>” but </div><div class="t m0 xc hd y42a ff19 fs7 fc3 sc0 ls1 ws1">the idea is the same.)</div><div class="t m0 x1c hd y42b ff19 fs7 fc3 sc0 ls1 ws1">Remember that with ARM instructions being only 32 bits<span class="_ _1"></span>, w<span class="_ _0"></span>e can’t </div><div class="t m0 xc hd y42c ff19 fs7 fc3 sc0 ls1 ws1">waste any of them<span class="_ _3"></span>. Hence the ARM designers wer<span class="_ _3"></span>e careful to a<span class="_ _1"></span>void </div><div class="t m0 xc hd y42d ff19 fs7 fc3 sc0 ls1 ws1">redundancy. It would<span class="_ _3"></span>’ve been a was<span class="_ _3"></span>te of valuable bits to ha<span class="_ _1"></span>ve such a <span class="ff1d lsb wsb4">MOV</span> </div><div class="t m0 xc hd y42e ff19 fs7 fc3 sc0 ls1 ws1">instruction.</div><div class="t m0 x1c hd y42f ff19 fs7 fc3 sc0 ls1 ws1">Knowing all these tricks would make pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>ams unreada<span class="_ _3"></span>ble and put </div><div class="t m0 xc hd y430 ff19 fs7 fc3 sc0 ls1 ws1">a lot of pressur<span class="_ _1"></span>e on programmers to know all the clever tricks<span class="_ _1"></span>, the ARM </div><div class="t m0 xc hd y431 ff19 fs7 fc3 sc0 ls1 ws1">designers used to reduce the number of r<span class="_ _1"></span>eal instructions in the processor<span class="_ _6"></span>. </div><div class="t m0 xc hd y432 ff19 fs7 fc3 sc0 ls1 ws1">The solution is to ha<span class="_ _3"></span>ve the GNU Assembler know all these tricks and do the </div><div class="t m0 xc hd y433 ff19 fs7 fc3 sc0 ls1 ws1">translations for y<span class="_ _3"></span>ou.</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:481.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:230.680000px;bottom:241.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf3c" class="pf w2 h6" data-page-no="3c"><div class="pc pc3c w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">40</div><div class="t m0 xc hd y145 ff19 fs7 fc3 sc0 ls1 ws1">In this book, we use instruction aliases to make our pr<span class="_ _3"></span>ograms r<span class="_ _3"></span>eadable, </div><div class="t m0 xd hd y146 ff19 fs7 fc3 sc0 ls1 ws1">but point out when they’r<span class="_ _3"></span>e used to help understand what’<span class="_ _6"></span>s going on. If you </div><div class="t m0 xd hd y147 ff19 fs7 fc3 sc0 ls1 ws1">use objdump<span class="_ _1"></span>, it might show the same alias you used, another alternate </div><div class="t m0 xd hd y1b0 ff19 fs7 fc3 sc0 ls1 ws1">alias, or the r<span class="_ _1"></span>eal instr<span class="_ _0"></span>uction. Ther<span class="_ _1"></span>e is a “-M no-aliases” option for objdump </div><div class="t m0 xd hd y1b1 ff19 fs7 fc3 sc0 ls1 ws1">where yo<span class="_ _3"></span>u can see the true underlying instruction.</div><div class="t m0 xc hd y1b2 ff19 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s get into the details and forms of the <span class="ff1d lsb wsb4">MOV</span> instruction to load the </div><div class="t m0 xd hd y1b3 ff19 fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>.</div><div class="t m0 xd ha y236 ff1e fs6 fc3 sc0 ls1 wsb1"> MOV/MOVK/MOVN</div><div class="t m0 xd hd y434 ff19 fs7 fc3 sc0 ls1 ws1">In this section, we look at several forms of the MOV instruction:</div><div class="t m0 xc hd y435 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>MOVK XD<span class="_ _3"></span>, #imm16{, LSL #shift}</div><div class="t m0 xc hd y436 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>MOV XD<span class="_ _3"></span>, #imm16{, LSL #shift}</div><div class="t m0 xc hd y437 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>MOV XD<span class="_ _3"></span>, XS</div><div class="t m0 xc hd y438 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>MOV XD<span class="_ _3"></span>, operand2</div><div class="t m0 xc hd y439 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>MOVN XD<span class="_ _3"></span>, operand2</div><div class="t m0 xc hd y43a ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve seen examples of <span class="ff1d lsb wsb4">MOV</span>, when putting a sm<span class="_ _3"></span>all number int<span class="_ _3"></span>o a </div><div class="t m0 xd hd y43b ff19 fs7 fc3 sc0 ls1 ws1">register<span class="_ _10"></span>. Here the immediate v<span class="_ _3"></span>alue can be any 16-bit quantity, and it will be </div><div class="t m0 xd hd y43c ff19 fs7 fc3 sc0 ls1 ws1">placed in the lower 16 bits of the specified register unless an optional shift </div><div class="t m0 xd hd y43d ff19 fs7 fc3 sc0 ls1 ws1">component is included. The shift values can only be the fo<span class="_ _3"></span>ur values<span class="_ _0"></span>: 0, 16, </div><div class="t m0 xd hd y43e ff19 fs7 fc3 sc0 ls1 ws1">32, and 48. The shift value allows to put o<span class="_ _3"></span>ur 16-bit value in each of the four </div><div class="t m0 xd hd y43f ff19 fs7 fc3 sc0 ls1 ws1">quarters of the 64-bit register<span class="_ _10"></span>.</div><div class="t m0 xc hd y440 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve lis<span class="_ _3"></span>ted the registers as <span class="ff1d">X</span> 64-bit r<span class="_ _3"></span>egisters here<span class="_ _1"></span>. But all these </div><div class="t m0 xd hd y441 ff19 fs7 fc3 sc0 ls1 ws1">instructions can take <span class="ff1d">W</span> 32-bit registers<span class="_ _1"></span>. Remember that these are the same </div><div class="t m0 xd hd y442 ff19 fs7 fc3 sc0 ls1 ws1">registers; you are just dealin<span class="_ _3"></span>g with half of the register r<span class="_ _3"></span>ather than the full </div><div class="t m0 xd hd y443 ff19 fs7 fc3 sc0 ls1 ws1">register<span class="_ _10"></span>.</div><div class="t m0 xc hd y444 ff19 fs7 fc3 sc0 ls1 ws1">The first form is the <span class="ff1d">move keep</span> (<span class="ff1d ls16 wsb9">MO<span class="_ _0"></span>VK</span>) instruction.</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf3d" class="pf w2 h6" data-page-no="3d"><div class="pc pc3d w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">41</div><div class="t m0 xc h2a y409 ff1e fsf fc3 sc0 ls1 wsbb"> About <span class="_ _1b"> </span>MOVK</div><div class="t m0 xc hd y40a ff19 fs7 fc3 sc0 ls1 ws1">The <span class="ff1d ls16 wsb9">MOVK<span class="_ _0"></span></span> instruction answers our question of how to load the full 64 bits </div><div class="t m0 xc hd y40b ff19 fs7 fc3 sc0 ls1 ws1">of a register<span class="_ _10"></span>. <span class="ff1d ls16 wsb9">M<span class="_ _0"></span>OVK<span class="_ _0"></span>,</span> the move keep instruction, loads the 16-bit immediate </div><div class="t m0 xc hd y40c ff19 fs7 fc3 sc0 ls1 ws1">operand into one of four positions in the r<span class="_ _1"></span>egister w<span class="_ _0"></span>ithout dist<span class="_ _3"></span>urbing the </div><div class="t m0 xc hd y445 ff19 fs7 fc3 sc0 ls1 ws1">other 48 bits. S<span class="_ _3"></span>uppose we want to load register <span class="ff1d">X2</span> with the 64-bit hex value </div><div class="t m0 xc hd y446 ff19 fs7 fc3 sc0 ls1 ws1">0x1234FEDC4F5D6E3A<span class="_ _0"></span>.W<span class="_ _1"></span>e could use</div><div class="t m0 xc h18 y447 ff1f fs7 fc3 sc0 ls1 ws1">MOV    X2, #0x6E3A</div><div class="t m0 xc h18 y448 ff1f fs7 fc3 sc0 ls1 ws1">MOVK   X2, #0x4F5D, LSL #16</div><div class="t m0 xc h18 y449 ff1f fs7 fc3 sc0 ls1 ws1">MOVK   X2, #0xFEDC, LSL #32</div><div class="t m0 xc h18 y44a ff1f fs7 fc3 sc0 ls1 ws1">MOVK   X2, #0x1234, LSL #48</div><div class="t m0 x1c hd y44b ff19 fs7 fc3 sc0 ls1 ws1">Only four instructions are requir<span class="_ _1"></span>ed, s<span class="_ _0"></span>o not too painful, but a bit </div><div class="t m0 xc hd y44c ff19 fs7 fc3 sc0 ls1 ws1">annoying.</div><div class="t m0 x1c hd y44d ff19 fs7 fc3 sc0 ls1 ws1">This is our first example of adding a shift oper<span class="_ _3"></span>ator to the second </div><div class="t m0 xc hd y44e ff19 fs7 fc3 sc0 ls1 ws1">operand. This sa<span class="_ _1"></span>ves us valuable instructions, since we don’t need to load </div><div class="t m0 xc hd y44f ff19 fs7 fc3 sc0 ls1 ws1">the value and then shift it in a separate ins<span class="_ _3"></span>truction and then combine it </div><div class="t m0 xc hd y450 ff19 fs7 fc3 sc0 ls1 ws1">with the desired register in a thir<span class="_ _1"></span>d instruction.</div><div class="t m0 x1c hd y451 ff19 fs7 fc3 sc0 ls1 ws1">The first <span class="ff1d lsb wsb4">MOV</span> instruction is an alias and assembled as a <span class="ff1d lsb wsb4">MOV<span class="_ _0"></span>Z</span> </div><div class="t m0 xc hd y452 ff19 fs7 fc3 sc0 ls1 ws1">instruction, identical to the <span class="ff1d ls16 wsb9">MOVK<span class="_ _0"></span></span> instruction, except it zer<span class="_ _3"></span>os the other  </div><div class="t m0 xc hd y453 ff19 fs7 fc3 sc0 ls1 ws1">48 bits rather th<span class="_ _3"></span>an keeping them. W<span class="_ _1"></span>e could’<span class="_ _1"></span>ve used four <span class="ff1d ls16 wsb9">M<span class="_ _0"></span>OVK</span> </div><div class="t m0 xc hd y454 ff19 fs7 fc3 sc0 ls1 ws1">instructions, but I like to s<span class="_ _3"></span>tart with a <span class="ff1d lsb wsb4">MOV</span> instr<span class="_ _0"></span>uction to guar<span class="_ _3"></span>antee we’<span class="_ _1"></span>ve </div><div class="t m0 xc hd y455 ff19 fs7 fc3 sc0 ls1 ws1">initialized all the bits.</div><div class="t m0 xc h2a y456 ff1e fsf fc3 sc0 ls1 ws1"> <span class="_ _1a"></span>Register toRegister MOV</div><div class="t m0 xc hd y457 ff19 fs7 fc3 sc0 ls1 ws1">In the thir<span class="_ _3"></span>d form of the <span class="ff1d lsb wsb4">MOV</span> instruction, w<span class="_ _0"></span>e ha<span class="_ _1"></span>ve a version that mo<span class="_ _3"></span>ves one </div><div class="t m0 xc hd y458 ff19 fs7 fc3 sc0 ls1 ws1">register in<span class="_ _3"></span>to another<span class="_ _6"></span>. For exam<span class="_ _3"></span>ple:</div><div class="t m0 xc h18 y459 ff1f fs7 fc3 sc0 ls1 ws1">MOV   X1, X2</div><div class="t m0 xc hd y45a ff19 fs7 fc3 sc0 ls1 ws1">copies register <span class="ff1d">X2</span> in<span class="_ _3"></span>to register <span class="ff1d">X1</span>.</div><div class="t m0 x1c hd y45b ff19 fs7 fc3 sc0 ls1 ws1">For the r<span class="_ _1"></span>emaining two forms of the <span class="ff1d lsb wsb4">MOV<span class="_ _0"></span></span> instruction, we need to study </div><div class="t m0 xc hd y45c ff19 fs7 fc3 sc0 ls1 ws1">what is allowed as the second operand.</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf3e" class="pf w2 h6" data-page-no="3e"><div class="pc pc3e w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">42</div><div class="t m0 xd ha y248 ff1e fs6 fc3 sc0 ls1 wsb1"> About <span class="_ _14"> </span>Operand2</div><div class="t m0 xd hd y249 ff19 fs7 fc3 sc0 ls1 ws1">All the ARM’<span class="_ _6"></span>s data processing ins<span class="_ _3"></span>tructions have the option of takin<span class="_ _3"></span>g a </div><div class="t m0 xd hd y24a ff19 fs7 fc3 sc0 ls1 ws1">flexible Operand2 as one of their parameters<span class="_ _1"></span>. At this point, it won’t be </div><div class="t m0 xd hd y24b ff19 fs7 fc3 sc0 ls1 ws1">clear why you w<span class="_ _3"></span>ant some of this functionality, but as we encounter mor<span class="_ _1"></span>e </div><div class="t m0 xd hd y24c ff19 fs7 fc3 sc0 ls1 ws1">instructions, and start to build small pr<span class="_ _1"></span>ograms, we’ll see how they help </div><div class="t m0 xd hd y24d ff19 fs7 fc3 sc0 ls1 ws1">us. A<span class="_ _1"></span>t the bit level, there is a lot of complexity here<span class="_ _3"></span>, but the people who </div><div class="t m0 xd hd y24e ff19 fs7 fc3 sc0 ls1 ws1">designed the Assembler did a good job of pro<span class="_ _3"></span>viding syntax to hide a lot of </div><div class="t m0 xd hd y24f ff19 fs7 fc3 sc0 ls1 ws1">this from us<span class="_ _1"></span>. Still, when doing Assembly programmin<span class="_ _3"></span>g, it’<span class="_ _6"></span>s goo<span class="_ _0"></span>d to alwa<span class="_ _3"></span>ys </div><div class="t m0 xd hd y45d ff19 fs7 fc3 sc0 ls1 ws1">know what is goin<span class="_ _3"></span>g on under the covers<span class="_ _1"></span>.</div><div class="t m0 xc hd y45e ff19 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e three formats for Operand2:</div><div class="t m0 xc hd y252 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>A register and a shift</div><div class="t m0 xc hd y253 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>A register and an extension oper<span class="_ _3"></span>ation</div><div class="t m0 xc hd y2a0 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>A small number and a shift</div><div class="t m0 xc hd y45f ff19 fs7 fc3 sc0 ls18 ws1">Due to the low num<span class="_ _3"></span>ber of bits for each instruction, the size of each </div><div class="t m0 xd hd y256 ff19 fs7 fc3 sc0 ls18 ws1">component can differ<span class="_ _10"></span>. In the preceding <span class="ff1d ls19 wsbc">MOVK<span class="_ _0"></span></span> case<span class="_ _3"></span>, the immediate is 16 bits </div><div class="t m0 xd hd y257 ff19 fs7 fc3 sc0 ls18 ws1">and the shift is 2 bits. Ra<span class="_ _3"></span>ther than make the shift be 0, 1, 2, or 3 positions<span class="_ _1"></span>,<span class="_ _0"></span> </div><div class="t m0 xd hd y460 ff19 fs7 fc3 sc0 ls18 ws1">instead these four values map to 0, 16, 32, or 48 bits<span class="_ _1"></span>. The possible values </div><div class="t m0 xd hd y461 ff19 fs7 fc3 sc0 ls18 ws1">repr<span class="_ _3"></span>esent what the ARM des<span class="_ _3"></span>igners felt were the most common use cases<span class="_ _3"></span>.</div><div class="t m0 xd h2a y462 ff1e fsf fc3 sc0 ls1 wsbb"> Register <span class="_ _1b"> </span>andShift</div><div class="t m0 xd hd y463 ff19 fs7 fc3 sc0 ls1 ws1">First of all, y<span class="_ _3"></span>ou can specify a register and a shift<span class="_ _3"></span>. F<span class="_ _3"></span>or this, y<span class="_ _3"></span>ou specify a </div><div class="t m0 xd hd y464 ff19 fs7 fc3 sc0 ls1 ws1">register th<span class="_ _3"></span>at takes 5 bits and then a shift tha<span class="_ _3"></span>t is 6 bits (for a total of a full  </div><div class="t m0 xd hd y465 ff19 fs7 fc3 sc0 ls1 ws1">64- <span class="_ _b"></span>bit shift). For example:</div><div class="t m0 xd h18 y466 ff1f fs7 fc3 sc0 ls1 ws1">MOV   X1, X2, LSL #1    // Logical shift left</div><div class="t m0 xd hd y467 ff19 fs7 fc3 sc0 ls1a ws1">is how we specify take <span class="ff1d wsbd">X2</span>, logically shift it left by 1 bit<span class="_ _3"></span>, and put the res<span class="_ _3"></span>ult in <span class="ff1d wsbd">X1</span><span class="ls1">. <span class="_ _b"></span> </span></div><div class="t m0 xd hd y468 ff19 fs7 fc3 sc0 ls1a ws1">W<span class="_ _1"></span>e can then handle the other shift and rotate scen<span class="_ _3"></span>arios we mentioned </div><div class="t m0 xd hd y469 ff19 fs7 fc3 sc0 ls1a ws1">previously with</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf3f" class="pf w2 h6" data-page-no="3f"><div class="pc pc3f w2 h6"><img class="bi xb y46a wb h2b" alt="" src="bg3f.png"/><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">43</div><div class="t m0 xc h18 y46b ff1f fs7 fc3 sc0 ls1 ws1">MOV   X1, X2, LSR #1    // Logical shift right</div><div class="t m0 xc h18 y46c ff1f fs7 fc3 sc0 ls1 ws1">MOV   X1, X2, ASR #1    // Arithmetic shift right</div><div class="t m0 xc h18 y46d ff1f fs7 fc3 sc0 ls1 ws1">MOV   X1, X2, ROR #1    // Rotate right</div><div class="t m0 x1c hd y46e ff19 fs7 fc3 sc0 ls1 ws1">Since shifting and r<span class="_ _3"></span>otating ar<span class="_ _3"></span>e quite common, the Assembler pro<span class="_ _1"></span>vides </div><div class="t m0 xc hd y46f ff19 fs7 fc3 sc0 ls1 ws1">mnemonics (aliases) for these, so you can specify</div><div class="t m0 xc h18 y470 ff1f fs7 fc3 sc0 ls1 ws1">LSL   X1, X2, #1    // Logical shift left</div><div class="t m0 xc h18 y471 ff1f fs7 fc3 sc0 ls1 ws1">LSR   X1, X2, #1    // Logical shift right</div><div class="t m0 xc h18 y472 ff1f fs7 fc3 sc0 ls1 ws1">ASR   X1, X2, #1    // Arithmetic shift right</div><div class="t m0 xc h18 y473 ff1f fs7 fc3 sc0 ls1 ws1">ROR   X1, X2, #1    // Rotate right</div><div class="t m0 x1c hd y474 ff19 fs7 fc3 sc0 ls1 ws1">These assemble to the same byte code<span class="_ _1"></span>. The intent is that it mak<span class="_ _3"></span>es the </div><div class="t m0 xc hd y475 ff19 fs7 fc3 sc0 ls1 ws1">code a little more r<span class="_ _1"></span>eadable, since it is clear you’r<span class="_ _3"></span>e doing a shift or rota<span class="_ _3"></span>te </div><div class="t m0 xc hd y476 ff19 fs7 fc3 sc0 ls1 ws1">operation and not j<span class="_ _3"></span>ust loading a register<span class="_ _10"></span>.</div><div class="t m0 xc h2a y477 ff1e fsf fc3 sc0 ls1 wsbb"> Register <span class="_ _1b"> </span>andExtension</div><div class="t m0 xc hd y478 ff19 fs7 fc3 sc0 ls1 ws1">The extension opera<span class="_ _3"></span>tions let us extract a b<span class="_ _3"></span>yte, h<span class="_ _3"></span>alfword, or word fr<span class="_ _1"></span>om </div><div class="t m0 xc hd y479 ff19 fs7 fc3 sc0 ls1 ws1">the second register<span class="_ _10"></span>. Y<span class="_ _1"></span>ou can then either zero ex<span class="_ _3"></span>tend or sign extend the </div><div class="t m0 xc hd y47a ff19 fs7 fc3 sc0 ls1 ws1">extracted value<span class="_ _1"></span>. Further you can shift this value left by 0–4 bits befor<span class="_ _1"></span>e it is </div><div class="t m0 xc hd y47b ff19 fs7 fc3 sc0 ls1 ws1">used. The extension operations ar<span class="_ _1"></span>e listed in T<span class="_ _6"></span>able<span class="fc5">2-1</span>.</div><div class="t m0 xb h26 y47c ff21 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 2-1. <span class="_ _15"> </span><span class="ff1a">Extension operators</span></div><div class="t m0 xb h10 y47d ff1e fs7 fc3 sc0 ls1 ws1">Extension Operator<span class="_ _c"> </span>Description</div><div class="t m0 xb h10 y47e ff20 fs7 fc3 sc0 ls1 ws1">uxtb<span class="_ _1c"> </span>Unsigned extend byte</div><div class="t m0 xb h10 y47f ff20 fs7 fc3 sc0 ls1 ws1">uxth<span class="_ _1c"> </span>Unsigned extend halfword</div><div class="t m0 xb h10 y480 ff20 fs7 fc3 sc0 ls1 ws1">uxtw<span class="_ _1d"> </span>Unsigned extend word</div><div class="t m0 xb h10 y481 ff20 fs7 fc3 sc0 ls1 ws1">sxtb<span class="_ _1e"> </span>Sign-extend byte</div><div class="t m0 xb h10 y482 ff20 fs7 fc3 sc0 ls1 ws1">sxth<span class="_ _1e"> </span>Sign-extend halfword</div><div class="t m0 xb h10 y483 ff20 fs7 fc3 sc0 ls1 ws1">sxtw<span class="_ _1f"> </span>Sign-extend word</div><div class="t m0 x2b h12 y484 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf3f" data-dest-detail='[63,"XYZ",122,261,null]'><div class="d m1" style="border-style:none;position:absolute;left:286.614000px;bottom:273.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf40" class="pf w2 h6" data-page-no="40"><div class="pc pc40 w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">44</div><div class="t m0 xc hd y145 ff19 fs7 fc3 sc0 ls1 ws1">If you ar<span class="_ _3"></span>e using the 32-bit W registers<span class="_ _1"></span>, then you would only use the byte </div><div class="t m0 xd hd y146 ff19 fs7 fc3 sc0 ls1 ws1">and halfword variants of this<span class="_ _1"></span>.</div><div class="t m0 xc hd y147 ff19 fs7 fc3 sc0 ls1 ws1">The extension opera<span class="_ _3"></span>tors aren’t a<span class="_ _1"></span>vailable for the <span class="ff1d lsb wsb4">MOV</span> instruction, but </div><div class="t m0 xd hd y1b0 ff19 fs7 fc3 sc0 ls1 ws1">we’ll see them shortly with the <span class="ff1d">ADD</span> instruction.</div><div class="t m0 xd h2a y163 ff1e fsf fc3 sc0 ls1 ws1"> <span class="_ _1a"></span>Small Number andShift</div><div class="t m0 xd hd y164 ff19 fs7 fc3 sc0 ls1 ws1">The other form of operand2 consists of a small n<span class="_ _3"></span>umber and an optional </div><div class="t m0 xd hd y485 ff19 fs7 fc3 sc0 ls1 ws1">shift amount. W<span class="_ _1"></span>e saw this used with the pr<span class="_ _3"></span>eceding <span class="ff1d ls16 wsb9">MO<span class="_ _0"></span>VK</span> instruction. The </div><div class="t m0 xd hd y486 ff19 fs7 fc3 sc0 ls1 ws1">size of this small num<span class="_ _3"></span>ber varies by instruction, and if a shift is allowed, </div><div class="t m0 xd hd y167 ff19 fs7 fc3 sc0 ls1 ws1">there will be limited values<span class="_ _3"></span>. Y<span class="_ _6"></span>ou can check the ARM Instruction Reference </div><div class="t m0 xd hd y168 ff19 fs7 fc3 sc0 ls1 ws1">manual for the valid v<span class="_ _3"></span>alues for each instruction.</div><div class="t m0 xc hd y169 ff19 fs7 fc3 sc0 ls1 ws1">Fortun<span class="_ _3"></span>ately, we don’t need to figure this all o<span class="_ _3"></span>ut. W<span class="_ _1"></span>e just specify a </div><div class="t m0 xd hd y487 ff19 fs7 fc3 sc0 ls1 ws1">number and the Assembler figur<span class="_ _1"></span>es out how to repr<span class="_ _3"></span>esent it. Since ther<span class="_ _1"></span>e </div><div class="t m0 xd hd y488 ff19 fs7 fc3 sc0 ls1 ws1">are only limited bits<span class="_ _1"></span>, not all 64-bit numbers can be represen<span class="_ _3"></span>ted, so if you </div><div class="t m0 xd hd y489 ff19 fs7 fc3 sc0 ls1 ws1">specify something that can’t be dealt with, then the Assembler giv<span class="_ _3"></span>es you </div><div class="t m0 xd hd y48a ff19 fs7 fc3 sc0 ls1 ws1">an error message<span class="_ _3"></span>. Y<span class="_ _6"></span>ou then need to use <span class="ff1d ls16 wsb9">M<span class="_ _0"></span>OVK</span> instr<span class="_ _0"></span>uctions as outlined </div><div class="t m0 xd hd y48b ff19 fs7 fc3 sc0 ls1 ws1">previously.</div><div class="t m0 xc hd y48c ff1d fs7 fc3 sc0 lsb wsb4">MOV<span class="ff19 ls1 ws1"> has the advantage tha<span class="_ _3"></span>t it can take an <span class="ff1d">#imm16</span> operand, which </span></div><div class="t m0 xd hd y48d ff19 fs7 fc3 sc0 ls1 ws1">can usually get us out of tr<span class="_ _3"></span>ouble. H<span class="_ _1"></span>owever<span class="_ _6"></span>, other instructions that must </div><div class="t m0 xd hd y48e ff19 fs7 fc3 sc0 ls1 ws1">specify a third r<span class="_ _3"></span>egister<span class="_ _6"></span>, like the <span class="ff1d">ADD</span> instruction, don’t ha<span class="_ _3"></span>ve this luxury.</div><div class="t m0 xc hd y48f ff19 fs7 fc3 sc0 ls1 ws1">Frequently, pr<span class="_ _1"></span>ogrammers deal with small integers like loop indexes<span class="_ _3"></span>, </div><div class="t m0 xd hd y490 ff19 fs7 fc3 sc0 ls1 ws1">say to loop fr<span class="_ _3"></span>om 1 to 10. These simple cases ar<span class="_ _3"></span>e handled easily, and we </div><div class="t m0 xd hd y491 ff19 fs7 fc3 sc0 ls1 ws1">don’t need to be concerned.</div><div class="t m0 xd h18 y492 ff1f fs7 fc3 sc0 ls1 ws1">// Too big for #imm16</div><div class="t m0 xd h18 y493 ff1f fs7 fc3 sc0 ls1 ws1">     MOV    X1, #0xAB000000</div><div class="t m0 xc hd y494 ff19 fs7 fc3 sc0 ls1 ws1">will be translated by the Assem<span class="_ _3"></span>bler to</div><div class="t m0 xd h18 y495 ff1f fs7 fc3 sc0 ls1 ws1">MOV   x1, #0xAB00, LSL #16</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf41" class="pf w2 h6" data-page-no="41"><div class="pc pc41 w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">45</div><div class="t m0 x1c hd y145 ff19 fs7 fc3 sc0 ls1 ws1">for us, sa<span class="_ _1"></span>ving us figuring out the instruction complexities.</div><div class="t m0 xc h18 y2e0 ff1f fs7 fc3 sc0 ls1 ws1">// Too big for #imm16 and can&apos;t be represented.</div><div class="t m0 xc h18 y2e1 ff1f fs7 fc3 sc0 ls1 ws1">     MOV    X1, #0xABCDEF11</div><div class="t m0 x1c hd y496 ff19 fs7 fc3 sc0 ls1 ws1">This instruction gives the error</div><div class="t m0 xc h18 y497 ff1f fs7 fc3 sc0 ls1 ws1">Error: immediate cannot be moved by a single instruction</div><div class="t m0 x1c hd y498 ff19 fs7 fc3 sc0 ls1 ws1">when you run your pr<span class="_ _3"></span>ogram thr<span class="_ _3"></span>ough the Assembler<span class="_ _10"></span>. This means the </div><div class="t m0 xc hd y499 ff19 fs7 fc3 sc0 ls1 ws1">Assembler tried all its tricks and failed to represen<span class="_ _3"></span>t the number<span class="_ _10"></span>. T<span class="_ _1"></span>o load </div><div class="t m0 xc hd y49a ff19 fs7 fc3 sc0 ls1 ws1">this, yo<span class="_ _3"></span>u need to use multiple <span class="ff1d lsb wsb4">MOV</span>/<span class="ff1d ls16 wsb9">M<span class="_ _0"></span>OVK</span> instructions.</div><div class="t m0 xc ha y49b ff1e fs6 fc3 sc0 ls1 wsb1"> MOVN</div><div class="t m0 xc hd y2af ff19 fs7 fc3 sc0 ls1 ws1">This is the <span class="ff1d">Move Not</span> instruction. I<span class="_ _3"></span>t works just like <span class="ff1d lsb wsb4">MOV</span>, except it r<span class="_ _1"></span>everses </div><div class="t m0 xc hd y49c ff19 fs7 fc3 sc0 ls1 ws1">all the 1s and 0s as it loads the register<span class="_ _10"></span>. This means it loads the register with </div><div class="t m0 xc hd y49d ff19 fs7 fc3 sc0 ls1 ws1">the one’<span class="_ _6"></span>s complement form of what yo<span class="_ _3"></span>u specified. Another way to say it </div><div class="t m0 xc hd y49e ff19 fs7 fc3 sc0 ls1 ws1">is that it applies a <span class="ff1d">logical NOT</span> operation to each bit in the wor<span class="_ _3"></span>d you ar<span class="_ _3"></span>e </div><div class="t m0 xc hd y49f ff19 fs7 fc3 sc0 ls1 ws1">loading into the r<span class="_ _3"></span>egister<span class="_ _6"></span>.</div><div class="t m0 x1c hd y4a0 ff1d fs7 fc3 sc0 ls16 wsb9">MO<span class="_ _0"></span>VN<span class="ff19 ls1 ws1"> is a distinct opcode, and not an alias for another instruction </span></div><div class="t m0 xc hd y4a1 ff19 fs7 fc3 sc0 ls1 ws1">with cr<span class="_ _0"></span>yptic paramet<span class="_ _3"></span>ers. The ARM 64-bit ins<span class="_ _3"></span>truction set has a limited </div><div class="t m0 xc hd y4a2 ff19 fs7 fc3 sc0 ls1 ws1">number of opcodes<span class="_ _3"></span>, so this is an important instruction with three main </div><div class="t m0 xc hd y4a3 ff19 fs7 fc3 sc0 ls1 ws1">uses<span class="_ _0"></span>:</div><div class="t m0 x1c hd y4a4 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>T<span class="_ _6"></span>o calculate the one’<span class="_ _6"></span>s complement of something for </div><div class="t m0 x9 hd y4a5 ff19 fs7 fc3 sc0 ls1 ws1">you. This has its uses<span class="_ _1"></span>, but does it warrant its own </div><div class="t m0 x9 hd y4a6 ff19 fs7 fc3 sc0 ls1 ws1">opcode?</div><div class="t m0 x1c hd y4a7 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>M<span class="_ _3"></span>ultiply by -1. W<span class="_ _1"></span>e saw tha<span class="_ _3"></span>t with the shift operations<span class="_ _1"></span>, </div><div class="t m0 x9 hd y4a8 ff19 fs7 fc3 sc0 ls1 ws1">we can multiply or divide by po<span class="_ _3"></span>wers of 2. This </div><div class="t m0 x9 hd y4a9 ff19 fs7 fc3 sc0 ls1 ws1">instruction gets us halfway to multiplyin<span class="_ _3"></span>g by -1. </div><div class="t m0 x9 hd y4aa ff19 fs7 fc3 sc0 ls1 ws1">Remember that the neg<span class="_ _3"></span>ative of a num<span class="_ _3"></span>ber is the </div><div class="t m0 x9 hd y4ab ff19 fs7 fc3 sc0 ls1 ws1">two<span class="_ _1"></span>’<span class="_ _1"></span>s complement of the num<span class="_ _3"></span>ber<span class="_ _6"></span>, or the one’<span class="_ _6"></span>s </div><div class="t m0 x9 hd y4ac ff19 fs7 fc3 sc0 ls1 ws1">complement plus one<span class="_ _3"></span>. This means we can multiply </div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf42" class="pf w2 h6" data-page-no="42"><div class="pc pc42 w2 h6"><img class="bi xd y4ad w7 h24" alt="" src="bg42.png"/><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">46</div><div class="t m0 x1e hd y38c ff19 fs7 fc3 sc0 ls1 ws1">by -1 by doin<span class="_ _3"></span>g this instruction, then add one. Why </div><div class="t m0 x1e hd y38d ff19 fs7 fc3 sc0 ls1 ws1">would we do this rather than use the <span class="ff1d">multiply </span></div><div class="t m0 x1e hd y4ae ff1d fs7 fc3 sc0 ls1 ws1">(MUL)<span class="ff19"> instruction? The same applies for shifting, </span></div><div class="t m0 x1e hd y4af ff19 fs7 fc3 sc0 ls1 ws1">why do tha<span class="_ _3"></span>t rather th<span class="_ _3"></span>an using <span class="ff1d">MUL</span>? The answer is </div><div class="t m0 x1e hd y4b0 ff19 fs7 fc3 sc0 ls1 ws1">that the <span class="ff1d">MUL</span> instruction is quite slow and c<span class="_ _3"></span>an take </div><div class="t m0 x1e hd y4b1 ff19 fs7 fc3 sc0 ls1 ws1">quite a few clock cycles to do its work. Shifting only </div><div class="t m0 x1e hd y4b2 ff19 fs7 fc3 sc0 ls1 ws1">takes one cycle and using <span class="ff1d ls16 wsb9">MO<span class="_ _0"></span>VN</span> and <span class="ff1d">ADD</span>, we can </div><div class="t m0 x1e hd y4b3 ff19 fs7 fc3 sc0 ls1 ws1">multiply by -1in only two clock cycles<span class="_ _3"></span>. M<span class="_ _3"></span>ultiplying </div><div class="t m0 x1e hd y4b4 ff19 fs7 fc3 sc0 ls1 ws1">by -1 is very common and now we can do it quickly.</div><div class="t m0 xc hd y4b5 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Y<span class="_ _1"></span>ou get twice the number of values due to the ex<span class="_ _3"></span>tra </div><div class="t m0 x1e hd y4b6 ff19 fs7 fc3 sc0 ls1 ws1">bit<span class="_ _3"></span>—17 vs. 16. I<span class="_ _1"></span>t turns out that all the numbers </div><div class="t m0 x1e hd y4b7 ff19 fs7 fc3 sc0 ls1 ws1">obtained by using a b<span class="_ _3"></span>yte value and even shift are </div><div class="t m0 x1e hd y4b8 ff19 fs7 fc3 sc0 ls1 ws1">different for <span class="ff1d ls16 wsb9">MOVN</span> and <span class="ff1d lsb wsb4">MOV<span class="_ _0"></span></span>. This means th<span class="_ _3"></span>at if the </div><div class="t m0 x1e hd y4b9 ff19 fs7 fc3 sc0 ls1 ws1">Assembler sees that the number y<span class="_ _3"></span>ou specified can’t </div><div class="t m0 x1e hd y4ba ff19 fs7 fc3 sc0 ls1 ws1">be repr<span class="_ _3"></span>esented in a <span class="ff1d lsb wsb4">MOV</span> instruction, then it tries </div><div class="t m0 x1e hd y4bb ff19 fs7 fc3 sc0 ls1 ws1">to change it to an <span class="ff1d ls16 wsb9">MOVN<span class="_ _0"></span></span> instruction and vice versa<span class="_ _3"></span>. </div><div class="t m0 x1e hd y4bc ff19 fs7 fc3 sc0 ls1 ws1">So<span class="_ _3"></span>, you r<span class="_ _3"></span>eally ha<span class="_ _3"></span>ve 17 bits of immediate data<span class="_ _1"></span>, rather </div><div class="t m0 x1e hd y4bd ff19 fs7 fc3 sc0 ls1 ws1">than 16. </div><div class="t m0 x34 h1f y4be ff1e fse fc3 sc0 ls1 ws1">Note<span class="ff20"> <span class="_ _19"> </span>It still might not be able to represent your number<span class="_ _6"></span>,<span class="_ _1"></span> and you </span></div><div class="t m0 x34 h1f y4bf ff20 fse fc3 sc0 ls1 ws1">may still need to use multiple <span class="ff1e">MOVK</span> instructions.</div><div class="t m0 xd ha y4c0 ff1e fs6 fc3 sc0 ls1 wsb1"> MOV <span class="_ _14"> </span>Examples</div><div class="t m0 xd hd y4c1 ff19 fs7 fc3 sc0 ls1 ws1">In this section, we will write a short program to exer<span class="_ _3"></span>cise a selection of the </div><div class="t m0 xd hd y4c2 ff1d fs7 fc3 sc0 lsb wsb4">MOV<span class="ff19 ls1 ws1"> instructions. Crea<span class="_ _3"></span>te a file called</span></div><div class="t m0 xd h18 y4c3 ff1f fs7 fc3 sc0 ls1 ws1">movexamps.s</div><div class="t m0 xc hd y4c4 ff19 fs7 fc3 sc0 ls1 ws1">containing Listing <span class="fc5">2-1</span>.</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf43" data-dest-detail='[67,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:140.877000px;bottom:103.862000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf43" class="pf w2 h6" data-page-no="43"><div class="pc pc43 w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">47</div><div class="t m0 xc h20 y4c5 ff21 fs3 fc3 sc0 ls1 ws1">Listing 2-1. <span class="_ _15"> </span><span class="ff19">MOV examples</span></div><div class="t m0 xc h18 y4c6 ff1f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y4c7 ff1f fs7 fc3 sc0 ls1 ws1">// Examples of the MOV instruction.</div><div class="t m0 xc h18 y4c8 ff1f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y4c9 ff1f fs7 fc3 sc0 ls1 ws1">.global _start    // Provide program starting address</div><div class="t m0 xc h18 y4ca ff1f fs7 fc3 sc0 ls1 ws1">// Load X2 with 0x1234FEDC4F5D6E3A first using MOV and MOVK</div><div class="t m0 xc h18 y4cb ff1f fs7 fc3 sc0 ls1 ws1">_start: MOV     X2, #0x6E3A</div><div class="t m0 xc h18 y4cc ff1f fs7 fc3 sc0 ls1 ws1">     MOVK  X2, #0x4F5D, LSL #16</div><div class="t m0 xc h18 y4cd ff1f fs7 fc3 sc0 ls1 ws1">     MOVK  X2, #0xFEDC, LSL #32</div><div class="t m0 xc h18 y4ce ff1f fs7 fc3 sc0 ls1 ws1">     MOVK  X2, #0x1234, LSL #48</div><div class="t m0 xc h18 y4cf ff1f fs7 fc3 sc0 ls1 ws1">// Just move W2 into W1</div><div class="t m0 xc h18 y4d0 ff1f fs7 fc3 sc0 ls1 ws1">     MOVW1, W2</div><div class="t m0 xc h18 y4d1 ff1f fs7 fc3 sc0 ls1 ws1">// Now lets see all the shift versions of MOV</div><div class="t m0 xc h18 y4d2 ff1f fs7 fc3 sc0 ls1 ws1">     MOV   X1, X2, LSL #1   // Logical shift left</div><div class="t m0 xc h18 y4d3 ff1f fs7 fc3 sc0 ls1 ws1">     MOV   X1, X2, LSR #1   // Logical shift right</div><div class="t m0 xc h18 y4d4 ff1f fs7 fc3 sc0 ls1 ws1">     MOV   X1, X2, ASR #1   // Arithmetic shift right</div><div class="t m0 xc h18 y4d5 ff1f fs7 fc3 sc0 ls1 ws1">     MOV   X1, X2, ROR #1   // Rotate right</div><div class="t m0 xc h18 y4d6 ff1f fs7 fc3 sc0 ls1 ws1">// Repeat the above shifts using mnemonics.</div><div class="t m0 xc h18 y4d7 ff1f fs7 fc3 sc0 ls1 ws1">     LSL   X1, X2, #1   // Logical shift left</div><div class="t m0 xc h18 y4d8 ff1f fs7 fc3 sc0 ls1 ws1">     LSR   X1, X2, #1   // Logical shift right</div><div class="t m0 xc h18 y4d9 ff1f fs7 fc3 sc0 ls1 ws1">     ASR   X1, X2, #1   //Arithmetic shift right</div><div class="t m0 xc h18 y4da ff1f fs7 fc3 sc0 ls1 ws1">     ROR   X1, X2, #1   // Rotate right</div><div class="t m0 xc h18 y4db ff1f fs7 fc3 sc0 ls1 ws1">// Example that works with 8 bit immediate and shift</div><div class="t m0 xc h18 y4dc ff1f fs7 fc3 sc0 ls1 ws1">     MOV   X1, #0xAB000000  // Too big for #imm16</div><div class="t m0 xc h18 y4dd ff1f fs7 fc3 sc0 ls1 ws1">// Example that can&apos;t be represented and results in an error</div><div class="t m0 xc h18 y4de ff1f fs7 fc3 sc0 ls1 ws1">// Uncomment the instruction if you want to see the error</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf44" class="pf w2 h6" data-page-no="44"><div class="pc pc44 w2 h6"><img class="bi xd y4df w7 h24" alt="" src="bg44.png"/><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">48</div><div class="t m0 xd h18 y4e0 ff1f fs7 fc3 sc0 ls1 ws1">//   MOV   X1, #0xABCDEF11    //  <span class="_ _20"></span>Too big for #imm16 and can&apos;t </div><div class="t m0 x29 h18 y4e1 ff1f fs7 fc3 sc0 ls1 ws1">be represented.</div><div class="t m0 xd h18 y4e2 ff1f fs7 fc3 sc0 ls1 ws1">// Example of MOVN</div><div class="t m0 xd h18 y4e3 ff1f fs7 fc3 sc0 ls1 ws1">     MOVN  W1, #45</div><div class="t m0 xd h18 y4e4 ff1f fs7 fc3 sc0 ls1 ws1">// Example of a MOV that the Assembler will change to MOVN</div><div class="t m0 xd h18 y4e5 ff1f fs7 fc3 sc0 ls1 ws1">     MOV  W1, #0xFFFFFFFE   // (-2)</div><div class="t m0 xd h18 y4e6 ff1f fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xd h18 y4e7 ff1f fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y4e8 ff1f fs7 fc3 sc0 ls1 ws1">      MOV     X0, #0   // Use 0 return code</div><div class="t m0 xd h18 y4e9 ff1f fs7 fc3 sc0 ls1 ws1">      MOV     X8, #93  // Serv command code 93 terms</div><div class="t m0 xd h18 y4ea ff1f fs7 fc3 sc0 ls1 ws1">      SVC     0        // Call linux to terminate</div><div class="t m0 xc hd y4eb ff19 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou can compile this program with the build file:</div><div class="t m0 xd h18 y4ec ff1f fs7 fc3 sc0 ls1 ws1">as -o movexamps.o movexamps.s</div><div class="t m0 xd h18 y4ed ff1f fs7 fc3 sc0 ls1 ws1">ld -o movexamps movexamps.o</div><div class="t m0 xc hd y4ee ff19 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou can run the program after building it<span class="_ _3"></span>.</div><div class="t m0 x34 h1f y4ef ff1e fse fc3 sc0 ls1 ws1">Note<span class="ff20"> <span class="_ _17"> </span>This program doesn’t do anything besides move various </span></div><div class="t m0 x34 h1f y4f0 ff20 fse fc3 sc0 ls1 ws1">numbers into registers.</div><div class="t m0 xc hd y4f1 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will look at how to see what is going on in Chapter <span class="fc5">3</span>, “T<span class="_ _6"></span>ooling Up<span class="_ _1"></span>,<span class="_ _8"></span>” </div><div class="t m0 xd hd y4f2 ff19 fs7 fc3 sc0 ls1 ws1">when we cover the GNU Debugger (GDB).</div><div class="t m0 xc hd y4f3 ff19 fs7 fc3 sc0 ls1 ws1">If we disassemble the progr<span class="_ _3"></span>am using</div><div class="t m0 xd h18 y4f4 ff1f fs7 fc3 sc0 ls1 ws1">objdump -s -d -M no-aliases movexamps.o</div><div class="t m0 xc hd y4f5 ff19 fs7 fc3 sc0 ls1 ws1">we get Listing <span class="fc5">2-2</span>.</div><div class="t m0 xd h12 y28b ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:305.919000px;bottom:216.186000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf45" data-dest-detail='[69,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:120.175000px;bottom:136.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf45" class="pf w2 h6" data-page-no="45"><div class="pc pc45 w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">49</div><div class="t m0 xc h20 y4c5 ff21 fs3 fc3 sc0 ls1 ws1">Listing 2-2. <span class="_ _15"> </span><span class="ff19">Disassembly of the MOV exam<span class="_ _3"></span>ples</span></div><div class="t m0 xc h18 y4c6 ff1f fs7 fc3 sc0 ls1 ws1">Disassembly of section .text:</div><div class="t m0 xc h18 y4f6 ff1f fs7 fc3 sc0 ls1 ws1">0000000000000000 &lt;_start&gt;:</div><div class="t m0 xc h18 y4f7 ff1f fs7 fc3 sc0 ls1 ws1">   0: d28dc742   movz   x2, #0x6e3a</div><div class="t m0 xc h18 y4f8 ff1f fs7 fc3 sc0 ls1 ws1">   4: f2a9eba2   movk   x2, #0x4f5d, lsl #16</div><div class="t m0 xc h18 y4ca ff1f fs7 fc3 sc0 ls1 ws1">   8: f2dfdb82   movk   x2, #0xfedc, lsl #32</div><div class="t m0 xc h18 y4cb ff1f fs7 fc3 sc0 ls1 ws1">   c: f2e24682   movk   x2, #0x1234, lsl #48</div><div class="t m0 xc h18 y4cc ff1f fs7 fc3 sc0 ls1 ws1">  10: 2a0203e1   orr    w1, wzr, w2</div><div class="t m0 xc h18 y4cd ff1f fs7 fc3 sc0 ls1 ws1">  14: aa0207e1   orr    x1, xzr, x2, lsl #1</div><div class="t m0 xc h18 y4ce ff1f fs7 fc3 sc0 ls1 ws1">  18: aa4207e1   orr    x1, xzr, x2, lsr #1</div><div class="t m0 xc h18 y4f9 ff1f fs7 fc3 sc0 ls1 ws1">  1c: aa8207e1   orr    x1, xzr, x2, asr #1</div><div class="t m0 xc h18 y4fa ff1f fs7 fc3 sc0 ls1 ws1">  20: aac207e1   orr    x1, xzr, x2, ror #1</div><div class="t m0 xc h18 y4fb ff1f fs7 fc3 sc0 ls1 ws1">  24: d37ff841   ubfm   x1, x2, #63, #62</div><div class="t m0 xc h18 y4fc ff1f fs7 fc3 sc0 ls1 ws1">  28: d341fc41   ubfm   x1, x2, #1, #63</div><div class="t m0 xc h18 y4fd ff1f fs7 fc3 sc0 ls1 ws1">  2c: 9341fc41   sbfm   x1, x2, #1, #63</div><div class="t m0 xc h18 y4fe ff1f fs7 fc3 sc0 ls1 ws1">  30: 93c20441   extr   x1, x2, x2, #1</div><div class="t m0 xc h18 y4ff ff1f fs7 fc3 sc0 ls1 ws1">  34: d2b56001   movz   x1, #0xab00, lsl #16</div><div class="t m0 xc h18 y500 ff1f fs7 fc3 sc0 ls1 ws1">  38: 128005a1   movn   w1, #0x2d</div><div class="t m0 xc h18 y501 ff1f fs7 fc3 sc0 ls1 ws1">  3c: 12800021   movn   w1, #0x1</div><div class="t m0 xc h18 y502 ff1f fs7 fc3 sc0 ls1 ws1">  40: d2800000   movz   x0, #0x0</div><div class="t m0 xc h18 y503 ff1f fs7 fc3 sc0 ls1 ws1">  44: d2800ba8   movz   x8, #0x5d</div><div class="t m0 xc h18 y504 ff1f fs7 fc3 sc0 ls1 ws1">  48: d4000001   svc    #0x0</div><div class="t m0 x1c hd y505 ff19 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e we can see the true ARM 64-bit instructions that are pr<span class="_ _3"></span>oduced </div><div class="t m0 xc hd y506 ff19 fs7 fc3 sc0 ls1 ws1">by the Assembler<span class="_ _10"></span>. W<span class="_ _3"></span>e’<span class="_ _1"></span>ve talked about how <span class="ff1d lsb wsb4">MOV</span> instructions can be </div><div class="t m0 xc hd y507 ff19 fs7 fc3 sc0 ls1 ws1">converted into <span class="ff1d">ORR</span> or <span class="ff1d lsb wsb4">MOVZ</span> instructions.</div><div class="t m0 x1c hd y508 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e see the shift instr<span class="_ _0"></span>uctions wer<span class="_ _3"></span>e converted into <span class="ff1d">UBFM</span>, <span class="ff1d">SBFM</span>, and </div><div class="t m0 xc hd y509 ff1d fs7 fc3 sc0 ls1 ws1">EXTR<span class="ff19"> instr<span class="_ _0"></span>uctions<span class="_ _1"></span>. These are the underlying shift and rotate ins<span class="_ _3"></span>tructions. </span></div><div class="t m0 xc hd y50a ff19 fs7 fc3 sc0 ls1 ws1">These instructions hav<span class="_ _3"></span>e more functionality th<span class="_ _3"></span>an the aliases we are using, </div><div class="t m0 xc hd y50b ff19 fs7 fc3 sc0 ls1 ws1">but we won’t need that advanced functionality and will stick with the </div><div class="t m0 xc hd y50c ff19 fs7 fc3 sc0 ls1 ws1">straigh<span class="_ _3"></span>tfor<span class="_ _0"></span>war<span class="_ _1"></span>d alias versions.</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf46" class="pf w2 h6" data-page-no="46"><div class="pc pc46 w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">50</div><div class="t m0 xc hd y145 ff19 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w that we’<span class="_ _1"></span>ve loaded numbers into our r<span class="_ _3"></span>egisters, let’<span class="_ _6"></span>s perform some </div><div class="t m0 xd hd y146 ff19 fs7 fc3 sc0 ls1 ws1">arithmetic on them.</div><div class="t m0 xd h15 y50d ff1e fsb fc3 sc0 ls1 wsaf"> ADD/ADC</div><div class="t m0 xd hd y50e ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can now put any value we like in a r<span class="_ _3"></span>egister<span class="_ _10"></span>, s<span class="_ _0"></span>o let’<span class="_ _6"></span>s start doing some </div><div class="t m0 xd hd y50f ff19 fs7 fc3 sc0 ls1 ws1">computing. Let’<span class="_ _6"></span>s star<span class="_ _0"></span>t with addition. The instructions we will cover ar<span class="_ _3"></span>e</div><div class="t m0 xc hd y510 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>ADD{S} Xd, Xs, Operand2</div><div class="t m0 xc hd y511 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>ADC{S} Xd, Xs, Operand2</div><div class="t m0 xc hd y512 ff19 fs7 fc3 sc0 ls1 ws1">These instructions all add their second and third parameters and put </div><div class="t m0 xd hd y513 ff19 fs7 fc3 sc0 ls1 ws1">the result in their first par<span class="_ _1"></span>ameter <span class="ff1d">re<span class="_ _0"></span>gister destination (Rd).</span> W<span class="_ _1"></span>e already </div><div class="t m0 xd hd y514 ff19 fs7 fc3 sc0 ls1 ws1">know about oper<span class="_ _3"></span>and2. The registers R<span class="_ _3"></span>d and <span class="ff1d">source re<span class="_ _0"></span>gister (Rs)</span> can be </div><div class="t m0 xd hd y515 ff19 fs7 fc3 sc0 ls1 ws1">the same. Let’<span class="_ _6"></span>s look at some examples of the forms of operand2:</div><div class="t m0 xd h18 y516 ff1f fs7 fc3 sc0 ls1 ws1">// the immediate value can be 12-bits, so 0-4095</div><div class="t m0 xd h18 y517 ff1f fs7 fc3 sc0 ls1 ws1">// X2 = X1 + 4000</div><div class="t m0 xd h18 y518 ff1f fs7 fc3 sc0 ls1 ws1">   ADD   X2, X1, #4000</div><div class="t m0 xd h18 y519 ff1f fs7 fc3 sc0 ls1 ws1">// the shift on an immediate can be 0 or 12</div><div class="t m0 xd h18 y51a ff1f fs7 fc3 sc0 ls1 ws1">// X2 = X1 + 0x20000</div><div class="t m0 xd h18 y51b ff1f fs7 fc3 sc0 ls1 ws1">   ADD   X2, X1, #0x20, LSL 12</div><div class="t m0 xd h18 y51c ff1f fs7 fc3 sc0 ls1 ws1">// simple addition of two registers</div><div class="t m0 xd h18 y51d ff1f fs7 fc3 sc0 ls1 ws1">// X2 = X1 + X0</div><div class="t m0 xd h18 y51e ff1f fs7 fc3 sc0 ls1 ws1">   ADD   X2, X1, X0</div><div class="t m0 xd h18 y51f ff1f fs7 fc3 sc0 ls1 ws1">// addition of a register with a shifted register</div><div class="t m0 xd h18 y520 ff1f fs7 fc3 sc0 ls1 ws1">// X2 = X1 + (X0 * 4)</div><div class="t m0 xd h18 y521 ff1f fs7 fc3 sc0 ls1 ws1">   ADD   X2, X1, X0, LSL 2</div><div class="t m0 xd h18 y522 ff1f fs7 fc3 sc0 ls1 ws1">// With register extension options</div><div class="t m0 xd h18 y523 ff1f fs7 fc3 sc0 ls1 ws1">// X2 = X1 + signed extended byte(X0)</div><div class="t m0 xd h18 y524 ff1f fs7 fc3 sc0 ls1 ws1">   ADD   X2, X1, X0, SXTB</div><div class="t m0 xd h18 y525 ff1f fs7 fc3 sc0 ls1 ws1">// X2 = X1 + zero extended halfword(X0) * 4</div><div class="t m0 xd h18 y526 ff1f fs7 fc3 sc0 ls1 ws1">   ADD   X2, X1, X0, UXTH 2</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf47" class="pf w2 h6" data-page-no="47"><div class="pc pc47 w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">51</div><div class="t m0 x1c hd y145 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e haven’t developed the code to print out a n<span class="_ _3"></span>umber yet, as we must </div><div class="t m0 xc hd y146 ff19 fs7 fc3 sc0 ls1 ws1">first convert the num<span class="_ _3"></span>ber to an ASCII string. W<span class="_ _3"></span>e will get to this after we </div><div class="t m0 xc hd y147 ff19 fs7 fc3 sc0 ls1 ws1">cover <span class="ff1d">loops</span> and <span class="ff1d">conditional statements</span>. In the meantime, we c<span class="_ _3"></span>an get one </div><div class="t m0 xc hd y1b0 ff19 fs7 fc3 sc0 ls1 ws1">number fr<span class="_ _3"></span>om our progr<span class="_ _3"></span>am via the progr<span class="_ _1"></span>am<span class="_ _1"></span>’<span class="_ _1"></span>s return code<span class="_ _3"></span>. This is a 1-byte </div><div class="t m0 xc hd y1b1 ff19 fs7 fc3 sc0 ls1 ws1">unsigned integer<span class="_ _6"></span>. Let’<span class="_ _1"></span>s look at an example of multiplying a n<span class="_ _3"></span>umber by -1 </div><div class="t m0 xc hd y218 ff19 fs7 fc3 sc0 ls1 ws1">and see the output. Listing <span class="fc5">2-3</span> is the code to do this<span class="_ _3"></span>.</div><div class="t m0 xc h20 y527 ff21 fs3 fc3 sc0 ls1 ws1">Listing 2-3. <span class="_ _15"> </span><span class="ff19">An example of MOVN and ADD</span></div><div class="t m0 xc h18 y528 ff1f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y529 ff1f fs7 fc3 sc0 ls1 ws1">// Examples of the ADD/MOVN instructions.</div><div class="t m0 xc h18 y52a ff1f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y52b ff1f fs7 fc3 sc0 ls1 ws1">.global _start   // Provide program starting address</div><div class="t m0 xc h18 y52c ff1f fs7 fc3 sc0 ls1 ws1">// Multiply 2 by -1 by using MOVN and then adding 1</div><div class="t m0 xc h18 y52d ff1f fs7 fc3 sc0 ls1 ws1">_start:    MOVN  W0, #2</div><div class="t m0 xc h18 y52e ff1f fs7 fc3 sc0 ls1 ws1">           ADD   W0, W0, #1</div><div class="t m0 xc h18 y52f ff1f fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xc h18 y530 ff1f fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 y531 ff1f fs7 fc3 sc0 ls1 ws1">// W0 is the return code and will be what we</div><div class="t m0 xc h18 y532 ff1f fs7 fc3 sc0 ls1 ws1">// calculated above.</div><div class="t m0 xc h18 y533 ff1f fs7 fc3 sc0 ls1 ws1">        MOV     X8, #93   // Service command code 93</div><div class="t m0 xc h18 y534 ff1f fs7 fc3 sc0 ls1 ws1">        SVC     0         // Call linux to terminate</div><div class="t m0 x1c hd y535 ff19 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e we use the <span class="ff1d ls16 wsb9">MO<span class="_ _0"></span>VN</span> instruction to calculate the one’<span class="_ _6"></span>s complement </div><div class="t m0 xc hd y536 ff19 fs7 fc3 sc0 ls1 ws1">of our number<span class="_ _10"></span>, in this case 2; then we add 1 to get the tw<span class="_ _0"></span>o<span class="_ _1"></span>’<span class="_ _6"></span>s complement </div><div class="t m0 xc hd y537 ff19 fs7 fc3 sc0 ls1 ws1">form. W<span class="_ _1"></span>e use <span class="ff1d">W0</span> since this will be the return code returned via the Linux </div><div class="t m0 xc hd y538 ff19 fs7 fc3 sc0 ls1 ws1">terminate command. T<span class="_ _10"></span>o s<span class="_ _0"></span>ee the r<span class="_ _3"></span>eturn code, type</div><div class="t m0 xc h18 y539 ff1f fs7 fc3 sc0 ls1 ws1">echo $?</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf47" data-dest-detail='[71,"XYZ",53,484,null]'><div class="d m1" style="border-style:none;position:absolute;left:180.014000px;bottom:497.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf48" class="pf w2 h6" data-page-no="48"><div class="pc pc48 w2 h6"><img class="bi xd y53a w7 h2c" alt="" src="bg48.png"/><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">52</div><div class="t m0 xc hd y38c ff19 fs7 fc3 sc0 ls1 ws1">After running the progr<span class="_ _3"></span>am, it prints out 254. If you examine the bits<span class="_ _1"></span>, </div><div class="t m0 xd hd y38d ff19 fs7 fc3 sc0 ls1 ws1">you will see this is the two<span class="_ _1"></span>’<span class="_ _1"></span>s complement form for -2in 1 byte<span class="_ _3"></span>.</div><div class="t m0 xc hd y4ae ff19 fs7 fc3 sc0 ls1 ws1">With the ARM pr<span class="_ _3"></span>ocessor<span class="_ _6"></span>, we can combine multiple <span class="ff1d">ADD</span> instructions </div><div class="t m0 xd hd y4af ff19 fs7 fc3 sc0 ls1 ws1">to add arbitrarily large integers<span class="_ _1"></span>. The key to this is the carr<span class="_ _0"></span>y flag.</div><div class="t m0 xd ha y50e ff1e fs6 fc3 sc0 ls1 wsb1"> Add <span class="_ _14"> </span>withCarr<span class="_ _0"></span>y</div><div class="t m0 xd hd y235 ff19 fs7 fc3 sc0 ls1 ws1">The new concepts in this section are wha<span class="_ _3"></span>t the {<span class="ff1d">S</span>} after the instruction </div><div class="t m0 xd hd y53b ff19 fs7 fc3 sc0 ls1 ws1">means along with why we ha<span class="_ _3"></span>ve both <span class="ff1d">ADD</span> and <span class="ff1d">ADC</span>. This will be our first </div><div class="t m0 xd hd y53c ff19 fs7 fc3 sc0 ls1 ws1">use of a condition flag.</div><div class="t m0 xc hd y53d ff19 fs7 fc3 sc0 ls1 ws1">Think back to how we learned to add num<span class="_ _3"></span>bers<span class="_ _0"></span>:</div><div class="t m0 x1e h18 y53e ff1f fs7 fc3 sc0 ls1 ws1"> 17</div><div class="t m0 x1e h18 y53f ff1f fs7 fc3 sc0 ls1 ws1">+78</div><div class="t m0 x1e h18 y540 ff1f fs7 fc3 sc0 ls1 ws1"> 95</div><div class="t m0 xc hd y541 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>W<span class="_ _1"></span>e first add 7 + 8 and get 15.</div><div class="t m0 xc hd y542 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>W<span class="_ _1"></span>e put 5in our sum and carr<span class="_ _0"></span>y the 1 to the tens </div><div class="t m0 x1e hd y543 ff19 fs7 fc3 sc0 ls1 ws1">column.</div><div class="t m0 xc hd y544 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Now we add 1 + 7 + the carry from the ones column, </div><div class="t m0 x1e hd y545 ff19 fs7 fc3 sc0 ls1 ws1">so we add 1+7+1 and get 9 for the tens column.</div><div class="t m0 xc hd y546 ff19 fs7 fc3 sc0 ls1 ws1">This is the idea behind the carry flag. When an addition overflows<span class="_ _3"></span>, it </div><div class="t m0 xd hd y547 ff19 fs7 fc3 sc0 ls1 ws1">sets the carr<span class="_ _0"></span>y flag, so we can include th<span class="_ _3"></span>at in the sum of the next part. </div><div class="t m0 x34 h1f y548 ff1e fse fc3 sc0 ls1 ws1">Note<span class="ff20"> <span class="_ _17"> </span>A carry is al<span class="_ _0"></span>ways 0 or 1,<span class="_ _1"></span> so we only need a 1-bit flag for this.</span></div><div class="t m0 xc hd y549 ff19 fs7 fc3 sc0 ls1 ws1">The ARM processor adds 64 bits at a time<span class="_ _1"></span>, so w<span class="_ _0"></span>e only need the carry </div><div class="t m0 xd hd y54a ff19 fs7 fc3 sc0 ls1 ws1">flag if we are dealing with num<span class="_ _3"></span>bers larger than wha<span class="_ _3"></span>t will fit into 64 bits. </div><div class="t m0 xd hd y54b ff19 fs7 fc3 sc0 ls1 ws1">This means we can easily add 128-bit or even larger int<span class="_ _3"></span>egers.</div><div class="t m0 xc hd y54c ff19 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>Getting Started,<span class="_ _8"></span>” we quickly mentioned that bit 29in the </div><div class="t m0 xd hd y54d ff19 fs7 fc3 sc0 ls1 ws1">instruction format specifies whether an instruction alters the condition </div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:99.361800px;width:5.500000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf49" class="pf w2 h6" data-page-no="49"><div class="pc pc49 w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">53</div><div class="t m0 xc hd y145 ff19 fs7 fc3 sc0 ls1 ws1">flags. So far<span class="_ _10"></span>, we haven’t set that bit<span class="_ _3"></span>, so none of the instructions we’<span class="_ _3"></span>ve </div><div class="t m0 xc hd y146 ff19 fs7 fc3 sc0 ls1 ws1">written so far will alter any condition flags. If we want an ins<span class="_ _3"></span>truction </div><div class="t m0 xc hd y147 ff19 fs7 fc3 sc0 ls1 ws1">to alter them, then we place an “<span class="ff1d">S</span>” on the end of the opcode, and the </div><div class="t m0 xc hd y1b0 ff19 fs7 fc3 sc0 ls1 ws1">Assembler will set bit 29 when it builds binary version of the instruction. </div><div class="t m0 xc hd y1b1 ff19 fs7 fc3 sc0 ls1 ws1">This applies to all instructions, includin<span class="_ _3"></span>g the <span class="ff1d lsb wsb4">MOV</span> instructions we just </div><div class="t m0 xc hd y218 ff19 fs7 fc3 sc0 ls1 ws1">looked at.</div><div class="t m0 xc h18 y230 ff1f fs7 fc3 sc0 ls1 ws1">ADDS    X0, X0, #1</div><div class="t m0 x1c hd y231 ff19 fs7 fc3 sc0 ls1 ws1">is just like</div><div class="t m0 xc h18 y377 ff1f fs7 fc3 sc0 ls1 ws1">ADD X0, X0, #1</div><div class="t m0 x1c hd y2dd ff19 fs7 fc3 sc0 ls14 ws1">except that it sets various condition flags<span class="_ _1"></span>. W<span class="_ _3"></span>e’ll co<span class="_ _3"></span>ver all the flags when </div><div class="t m0 xc hd y2de ff19 fs7 fc3 sc0 ls14 ws1">we cover <span class="ff1d">conditional statements</span> in Chapter <span class="fc5 ls1">4<span class="_ _3"></span><span class="fc3 ls14">, “<span class="_ _3"></span>Contr<span class="_ _3"></span>olling Progr<span class="_ _1"></span>am Flow.<span class="_ _8"></span>” </span></span></div><div class="t m0 xc hd y54e ff19 fs7 fc3 sc0 ls14 ws1">For no<span class="_ _3"></span>w, we are int<span class="_ _3"></span>erested in the carry flag that is designa<span class="_ _3"></span>ted <span class="ff1d ls1">C</span>. If the res<span class="_ _3"></span>ult </div><div class="t m0 xc hd y54f ff19 fs7 fc3 sc0 ls14 ws1">of an addition is too large, then the <span class="ff1d ls1">C<span class="_ _3"></span><span class="ff19 ls14"> flag is set to 1; otherw<span class="_ _0"></span>ise it is set to 0.</span></span></div><div class="t m0 x1c hd y550 ff19 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o add two 128-bit integers, we use two registers to hold each n<span class="_ _3"></span>umber<span class="_ _6"></span>. </div><div class="t m0 xc hd y551 ff19 fs7 fc3 sc0 ls1 ws1">In our example<span class="_ _1"></span>, w<span class="_ _0"></span>e<span class="_ _3"></span>’ll use registers <span class="ff1d">X2</span> and <span class="ff1d">X3</span> for the first n<span class="_ _3"></span>umber<span class="_ _6"></span>, <span class="ff1d">X4</span> and </div><div class="t m0 xc hd y552 ff1d fs7 fc3 sc0 ls1 ws1">X5<span class="ff19"> for the second, and then </span>X0<span class="ff19"> and </span>X1<span class="ff19"> for the result. The code would then </span></div><div class="t m0 xc hd y553 ff19 fs7 fc3 sc0 ls1b wsa9">be</div><div class="t m0 xc h18 y295 ff1f fs7 fc3 sc0 ls1 ws1">ADDS   X1, X3, X5    // Lower order 64-bits</div><div class="t m0 xc h18 y296 ff1f fs7 fc3 sc0 ls1 ws1">ADC    X0, X2, X4    // Higher order 64-bits</div><div class="t m0 x1c hd y554 ff19 fs7 fc3 sc0 ls1 ws1">The first <span class="ff1d">ADDS</span> adds the lower order 64 bits and sets the carry flag, </div><div class="t m0 xc hd y555 ff19 fs7 fc3 sc0 ls1 ws1">if needed. It might set other flags<span class="_ _1"></span>, but we’ll worr<span class="_ _0"></span>y about those later<span class="_ _10"></span>. The </div><div class="t m0 xc hd y556 ff19 fs7 fc3 sc0 ls1 ws1">second instruction, <span class="ff1d">ADD<span class="_ _0"></span>C</span>, adds the higher<span class="_ _1"></span>-order wor<span class="_ _3"></span>ds, plus the carry </div><div class="t m0 xc hd y557 ff19 fs7 fc3 sc0 lsb wsb4">flag.</div><div class="t m0 x1c hd y558 ff19 fs7 fc3 sc0 ls1 ws1">The nice thing her<span class="_ _3"></span>e is that in 64-bit mode<span class="_ _3"></span>, we can do a 128-bit  </div><div class="t m0 xc hd y559 ff19 fs7 fc3 sc0 ls1 ws1">addition in only two clock cycles. Let’<span class="_ _1"></span>s look at a simple complete example </div><div class="t m0 xc hd y55a ff19 fs7 fc3 sc0 ls1 ws1">in Listing <span class="fc5">2-4</span>.</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:261.941000px;bottom:385.175000px;width:5.434000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4a" data-dest-detail='[74,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:99.759200px;bottom:129.362000px;width:15.047800px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf4a" class="pf w2 h6" data-page-no="4a"><div class="pc pc4a w2 h6"><img class="bi xd y55b wc h2d" alt="" src="bg4a.png"/><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">54</div><div class="t m0 xd h20 y4c5 ff21 fs3 fc3 sc0 ls1 ws1">Listing 2-4. <span class="_ _15"> </span><span class="ff19">Example of 128-bit addition with ADD and AD<span class="_ _0"></span>C</span></div><div class="t m0 xd h18 y4c6 ff1f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4c7 ff1f fs7 fc3 sc0 ls1 ws1">// Example of 128-Bit addition with the ADD/ADC instructions.</div><div class="t m0 xd h18 y4c8 ff1f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4c9 ff1f fs7 fc3 sc0 ls1 ws1">.global _start    // Provide program starting address</div><div class="t m0 xd h18 y4ca ff1f fs7 fc3 sc0 ls1 ws1">// Load the registers with some data</div><div class="t m0 xd h18 y4cb ff1f fs7 fc3 sc0 ls1 ws1">// First 64-bit number is 0x0000000000000003FFFFFFFFFFFFFFFF</div><div class="t m0 xd h18 y4cc ff1f fs7 fc3 sc0 ls1 ws1">_start: MOV  X2, #0x0000000000000003</div><div class="t m0 xd h18 y4cd ff1f fs7 fc3 sc0 ls14 wsb6">        MOV  X<span class="_ _0"></span>3, #0xFFFFFFFFFFFFFFFF //Assem will change to MOVN</div><div class="t m0 xd h18 y4ce ff1f fs7 fc3 sc0 ls1 ws1">// Second 64-bit number is 0x00000000000000050000000000000001</div><div class="t m0 xd h18 y4f9 ff1f fs7 fc3 sc0 ls1 ws1">        MOV  X4, #0x0000000000000005</div><div class="t m0 xd h18 y4fa ff1f fs7 fc3 sc0 ls1 ws1">        MOV  X5, #0x0000000000000001</div><div class="t m0 xd h18 y55c ff1f fs7 fc3 sc0 ls1 ws1">        ADDS X1, X3, X5 // Lower order 64-bits</div><div class="t m0 xd h18 y55d ff1f fs7 fc3 sc0 ls1 ws1">        ADC  X0, X2, X4 // Higher order 64-bits</div><div class="t m0 xd h18 y4d3 ff1f fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xd h18 y4d4 ff1f fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y4d5 ff1f fs7 fc3 sc0 ls1 ws1">// W0 is the return code and will be what we</div><div class="t m0 xd h18 y55e ff1f fs7 fc3 sc0 ls1 ws1">// calculated above.</div><div class="t m0 xd h18 y55f ff1f fs7 fc3 sc0 ls1 ws1">        MOV     X8, #93    //  <span class="_ _20"></span>Service command code 93 </div><div class="t m0 x3c h18 y560 ff1f fs7 fc3 sc0 ls1 ws1">terminates</div><div class="t m0 xd h18 y561 ff1f fs7 fc3 sc0 ls1 ws1">        SVC     0          //  <span class="_ _20"></span>Call linux to terminate the </div><div class="t m0 x3c h18 y562 ff1f fs7 fc3 sc0 ls1 ws1">program</div><div class="t m0 xc hd y563 ff19 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e we are adding</div><div class="t m0 xd h18 y564 ff1f fs7 fc3 sc0 ls1 ws1">0000000000000003 FFFFFFFFFFFFFFFF</div><div class="t m0 xd h18 y565 ff1f fs7 fc3 sc0 ls1 ws1">0000000000000005 0000000000000001</div><div class="t m0 xd h18 y566 ff1f fs7 fc3 sc0 ls1 ws1">0000000000000009 0000000000000000</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf4b" class="pf w2 h6" data-page-no="4b"><div class="pc pc4b w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">55</div><div class="t m0 x1c hd y145 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve rigged this example to demonstr<span class="_ _1"></span>ate the carr<span class="_ _0"></span>y flag, and to </div><div class="t m0 xc hd y146 ff19 fs7 fc3 sc0 ls1 ws1">produce an answer we can see in the ret<span class="_ _3"></span>urn code. The largest 64-bit </div><div class="t m0 xc hd y147 ff19 fs7 fc3 sc0 ls1 ws1">unsigned integer is</div><div class="t m0 xc h18 y2d7 ff1f fs7 fc3 sc0 ls1 ws1">0xFFFFFFFFFFFFFFFF</div><div class="t m0 x1c hd y567 ff19 fs7 fc3 sc0 ls1 ws1">and adding 1 results in</div><div class="t m0 xc h18 y568 ff1f fs7 fc3 sc0 ls1 ws1">0x10000000000000000</div><div class="t m0 x1c hd y499 ff19 fs7 fc3 sc0 ls1 ws1">which doesn’t fit in 64 bits, so we get</div><div class="t m0 xc h18 y569 ff1f fs7 fc3 sc0 ls1 ws1">0x0000000000000000</div><div class="t m0 x1c hd y56a ff19 fs7 fc3 sc0 ls1 ws1">with a carr<span class="_ _0"></span>y. The high-or<span class="_ _1"></span>der w<span class="_ _0"></span>or<span class="_ _3"></span>ds add 3 + 5 + carry to yield 9. The  </div><div class="t m0 xc hd y56b ff19 fs7 fc3 sc0 ls1 ws1">high-order wor<span class="_ _1"></span>d is in X0, s<span class="_ _0"></span>o it is the r<span class="_ _3"></span>eturn code when the progr<span class="_ _3"></span>am exits.  </div><div class="t m0 xc hd y56c ff19 fs7 fc3 sc0 ls1 ws1">If we type</div><div class="t m0 xc h18 y56d ff1f fs7 fc3 sc0 ls1 ws1">echo $?</div><div class="t m0 x1c hd y56e ff19 fs7 fc3 sc0 ls1 ws1">we get 9 as expected.</div><div class="t m0 x1c hd y56f ff19 fs7 fc3 sc0 ls1 ws1">Learning about <span class="ff1d lsb wsb4">MOV</span> was difficult, because this was the first time we </div><div class="t m0 xc hd y570 ff19 fs7 fc3 sc0 ls1 ws1">encounter<span class="_ _3"></span>ed both shifting and Operand2. With these behind us<span class="_ _1"></span>, learning </div><div class="t m0 xc hd y571 ff19 fs7 fc3 sc0 ls1 ws1">about <span class="ff1d">ADD</span> was much easier<span class="_ _10"></span>. W<span class="_ _1"></span>e still have some complica<span class="_ _3"></span>ted topics to </div><div class="t m0 xc hd y572 ff19 fs7 fc3 sc0 ls1 ws1">cover<span class="_ _10"></span>, but as we become more experienced with how to manipulate bits </div><div class="t m0 xc hd y573 ff19 fs7 fc3 sc0 ls1 ws1">and bytes<span class="_ _3"></span>, the learning should become easier<span class="_ _10"></span>.</div><div class="t m0 x1c hd y574 ff19 fs7 fc3 sc0 ls1 ws1">Covering addition wouldn’t be complete without co<span class="_ _3"></span>vering its inverse: </div><div class="t m0 xc hd y575 ff19 fs7 fc3 sc0 ls1 ws1">subtraction.</div><div class="t m0 xc h15 y576 ff1e fsb fc3 sc0 ls1 wsaf"> SUB/SBC</div><div class="t m0 xc hd y577 ff19 fs7 fc3 sc0 ls1 ws1">Subtraction is the in<span class="_ _1"></span>verse of addition. We h<span class="_ _3"></span>ave</div><div class="t m0 x1c hd y578 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>SUB{S} Xd, Xs, Oper<span class="_ _3"></span>and2</div><div class="t m0 x1c hd y579 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>SBC{S} Xd, Xs, Operand2</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf4c" class="pf w2 h6" data-page-no="4c"><div class="pc pc4c w2 h6"><div class="t m0 xd hd y3f ff19 fs7 fc3 sc0 ls1 ws1">56</div><div class="t m0 xc hd y145 ff19 fs7 fc3 sc0 ls1 ws1">The operands ar<span class="_ _3"></span>e the same as those for addition, only now we are </div><div class="t m0 xd hd y146 ff19 fs7 fc3 sc0 ls1 wsbe">calculating Xs– Oper<span class="_ _3"></span>and2. The carry flag is used to indicate when a borrow </div><div class="t m0 xd hd y147 ff19 fs7 fc3 sc0 ls1 ws1">is necessary. SUBS w<span class="_ _0"></span>ill clear the carry flag if the result is nega<span class="_ _3"></span>tive and set it </div><div class="t m0 xd hd y1b0 ff19 fs7 fc3 sc0 ls1 ws1">if positive; SBC then subtracts one if the carry flag is clear<span class="_ _6"></span>.</div><div class="t m0 xd h15 y30f ff1e fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y57a ff19 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we learned how negative integers ar<span class="_ _3"></span>e repr<span class="_ _1"></span>esented in a </div><div class="t m0 xd hd y57b ff19 fs7 fc3 sc0 ls1 ws1">computer<span class="_ _10"></span>. We wen<span class="_ _3"></span>t on to discuss big- vs. lit<span class="_ _3"></span>tle-endian byte or<span class="_ _3"></span>dering. W<span class="_ _1"></span>e </div><div class="t m0 xd hd y57c ff19 fs7 fc3 sc0 ls1 ws1">then looked at the concept of shifting and r<span class="_ _3"></span>otating the bits in a r<span class="_ _3"></span>egister<span class="_ _6"></span>.</div><div class="t m0 xc hd y57d ff19 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we looked in detail at the <span class="ff1d lsb wsb4">MOV</span> instruction that allows us to </div><div class="t m0 xd hd y57e ff19 fs7 fc3 sc0 ls1 ws1">move da<span class="_ _3"></span>ta around the CPU r<span class="_ _1"></span>e<span class="_ _0"></span>gisters or load constan<span class="_ _3"></span>ts from the <span class="ff1d lsb wsb4">MOV</span> </div><div class="t m0 xd hd y57f ff19 fs7 fc3 sc0 ls1 ws1">instruction into a register<span class="_ _10"></span>. W<span class="_ _1"></span>e dis<span class="_ _0"></span>co<span class="_ _3"></span>vered the tricks of oper<span class="_ _3"></span>and2 on how </div><div class="t m0 xd hd y580 ff19 fs7 fc3 sc0 ls1 ws1">ARM repr<span class="_ _3"></span>esents a large r<span class="_ _3"></span>ange of values<span class="_ _3"></span>, given the limited number of bits it </div><div class="t m0 xd hd y581 ff19 fs7 fc3 sc0 ls1 ws1">has at its disposal.</div><div class="t m0 xc hd y582 ff19 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e covered the <span class="ff1d">ADD</span> and <span class="ff1d">ADC</span> instructions and discussed how to add </div><div class="t m0 xd hd y583 ff19 fs7 fc3 sc0 ls1 ws1">both 64- and 128-bit numbers<span class="_ _3"></span>. Fin<span class="_ _3"></span>ally, we quickly cover<span class="_ _1"></span>ed the <span class="ff1d ls1c wsbf">SU<span class="_ _0"></span>B</span> and </div><div class="t m0 xd hd y584 ff1d fs7 fc3 sc0 ls1 ws1">SBC<span class="ff19"> instr<span class="_ _0"></span>uctions<span class="_ _1"></span>.</span></div><div class="t m0 xc hd y585 ff19 fs7 fc3 sc0 ls14 ws1">In Chapter <span class="fc5 ls1">3<span class="_ _3"></span><span class="fc3 ls14">, “T<span class="_ _6"></span>o<span class="_ _0"></span>oling U<span class="_ _3"></span>p<span class="_ _1"></span>,<span class="_ _8"></span>” w<span class="_ _0"></span>e will look at better wa<span class="_ _3"></span>ys to build our </span></span></div><div class="t m0 xd hd y586 ff19 fs7 fc3 sc0 ls14 ws1">progr<span class="_ _3"></span>ams and start debugging our pr<span class="_ _3"></span>ograms with the GNU Debugger (<span class="ff1d wsb6">gdb<span class="ff19">).</span></span></div><div class="t m0 xd h15 y587 ff1e fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y210 ff19 fs7 fc3 sc0 ls1d ws1"> <span class="_ _16"> </span>1. <span class="_ _21"> </span>Compute the 8-bit two<span class="_ _1"></span>’<span class="_ _1"></span>s complement for -79 and -23.</div><div class="t m0 xc hd y588 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>What ar<span class="_ _3"></span>e the negative decimal n<span class="_ _3"></span>umbers repr<span class="_ _1"></span>es<span class="_ _0"></span>ent<span class="_ _3"></span>ed </div><div class="t m0 x1e hd y589 ff19 fs7 fc3 sc0 ls1 ws1">by the byt<span class="_ _3"></span>es 0xF2 and 0x83?</div><div class="t m0 xc hd y1fb ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Write out the bytes in the little-endian </div><div class="t m0 x1e hd y58a ff19 fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esentation of 0x12345678.</div><div class="t m0 xc hd y58b ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Write out the bytes for 0x23 shifted left by 3 bits<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:105.777000px;bottom:281.362000px;width:5.434000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf4d" class="pf w2 h6" data-page-no="4d"><div class="pc pc4d w2 h6"><div class="t m0 x12 hd y3f ff19 fs7 fc3 sc0 ls1 ws1">57</div><div class="t m0 x1c hd y145 ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Write out the bytes for 0x4300 shifted right by 5 bits<span class="_ _1"></span>.</div><div class="t m0 x1c hd y58c ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>6. <span class="_ _f"> </span>Write a program to add two 192-bit numbers<span class="_ _1"></span>. </div><div class="t m0 x9 hd y1fe ff19 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou will ne<span class="_ _0"></span>ed to use the <span class="ff1d">ADCS</span> instr<span class="_ _0"></span>uction for </div><div class="t m0 x9 hd y148 ff19 fs7 fc3 sc0 ls1 ws1">this. Remem<span class="_ _3"></span>ber you can set the flags fr<span class="_ _3"></span>om any </div><div class="t m0 x9 hd y149 ff19 fs7 fc3 sc0 ls1 ws1">instruction.</div><div class="t m0 x1c hd y28c ff19 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>7. <span class="_ _f"> </span>Write a program tha<span class="_ _3"></span>t performs 128-bit subtraction. </div><div class="t m0 x9 hd y14b ff19 fs7 fc3 sc0 ls1 ws1">Convince yourself th<span class="_ _3"></span>at the way it sets and </div><div class="t m0 x9 hd y58d ff19 fs7 fc3 sc0 ls1 ws1">interpr<span class="_ _3"></span>ets the carr<span class="_ _0"></span>y flag is wh<span class="_ _3"></span>at you need in this </div><div class="t m0 x9 hd y58e ff19 fs7 fc3 sc0 ls1 ws1">situation. Use it to r<span class="_ _1"></span>everse the op<span class="_ _0"></span>er<span class="_ _3"></span>ations fr<span class="_ _3"></span>om the </div><div class="t m0 x9 hd y2f3 ff19 fs7 fc3 sc0 ls1 ws1">preceding 128-bit example<span class="_ _1"></span>.</div><div class="t m0 x2b h12 y71 ff20 fsa fc3 sc0 ls1 ws1">CHAPTER 2 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>LOADING ANDADDING</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf4e" class="pf w2 h6" data-page-no="4e"><div class="pc pc4e w2 h6"><div class="t m0 x12 hd y16a ff22 fs7 fc3 sc0 ls1 ws1">59</div><div class="t m0 xc h17 y16b ff22 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff22 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff23">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff22">,  </span></span></div><div class="t m0 xc h17 y16d ff22 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_3</div><div class="t m0 xc ha y16e ff24 fs6 fc3 sc0 ls1 ws1">CHAPTER 3</div><div class="t m0 xc h23 y16f ff25 fs4 fc3 sc0 ls1 ws1">T<span class="_ _22"></span>ooling Up</div><div class="t m0 xc hd y170 ff22 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we will learn a better way to build our pr<span class="_ _3"></span>ograms using </div><div class="t m0 xc hd y171 ff26 fs7 fc3 sc0 ls1a wsbd">GN<span class="_ _0"></span>U Make<span class="_ _0"></span><span class="ff22 ls1 ws1">. With the <span class="ff26">GNU Debugger</span> (<span class="ff26">GDB</span>), we will debug our progr<span class="_ _3"></span>ams. </span></div><div class="t m0 xc hd y172 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll look at the tools requir<span class="_ _1"></span>e<span class="_ _0"></span>d to cr<span class="_ _1"></span>oss-compile for ARM from an Intel </div><div class="t m0 xc hd y173 ff22 fs7 fc3 sc0 ls1 ws1">computer<span class="_ _10"></span>, develop Assembly Language for Google Android, and add </div><div class="t m0 xc hd y174 ff22 fs7 fc3 sc0 ls1 ws1">Assembly Language to A<span class="_ _3"></span>pple iOS apps. Also<span class="_ _1"></span>, we will quickly introduce the </div><div class="t m0 xc hd y175 ff22 fs7 fc3 sc0 ls1 ws1">source contr<span class="_ _1"></span>ol system <span class="ff26">G<span class="_ _0"></span>it</span> and the build server <span class="ff26">Jenk<span class="_ _3"></span>ins<span class="ff22">.</span></span></div><div class="t m0 xc h15 y58f ff27 fsb fc3 sc0 ls1 wsaf"> GNU <span class="_ _11"> </span>Make</div><div class="t m0 xc hd y590 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e built our programs usin<span class="_ _3"></span>g a simple shell script to run the <span class="ff26 ls18 wsc0">G<span class="_ _0"></span>NU </span></div><div class="t m0 xc hd y591 ff26 fs7 fc3 sc0 ls1 ws1">Assembler<span class="ff22"> and then the </span>Linux linker/loader<span class="ff22">. As we move forward, </span></div><div class="t m0 xc hd y592 ff22 fs7 fc3 sc0 ls1 ws1">we want a more sophistic<span class="_ _3"></span>ated tool to build our pr<span class="_ _3"></span>ograms<span class="_ _1"></span>. <span class="ff26 ls1a wsbd">G<span class="_ _0"></span>NU<span class="_ _0"></span> Make</span> is </div><div class="t m0 xc hd y593 ff22 fs7 fc3 sc0 ls1 ws1">the standard Linux utility to do this<span class="_ _1"></span>, and it comes preinstalled on many </div><div class="t m0 xc hd y594 ff22 fs7 fc3 sc0 ls1 ws1">versions of Linux. GNU Make</div><div class="t m0 x1c hd y595 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Specifies the rules on how to build one thing fr<span class="_ _3"></span>om </div><div class="t m0 x9 hd y596 ff22 fs7 fc3 sc0 ls1 ws1">another</div><div class="t m0 x1c hd y597 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Lists the targets you want built and the files they </div><div class="t m0 x9 hd y598 ff22 fs7 fc3 sc0 ls1 ws1">depend on</div><div class="t m0 x1c hd y599 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Examines the file date/times to determine what </div><div class="t m0 x9 hd y59a ff22 fs7 fc3 sc0 ls1 ws1">needs to be built</div><div class="t m0 x1c hd y59b ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Issues the commands to b<span class="_ _3"></span>uild the components</div><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf4f" class="pf w2 h6" data-page-no="4f"><div class="pc pc4f w2 h6"><img class="bi xd y59c w7 h24" alt="" src="bg4f.png"/><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">60</div><div class="t m0 xc hd y275 ff22 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at how to build our H<span class="_ _1"></span>elloWorld pr<span class="_ _1"></span>ogram from Chapter <span class="fc5">1</span>, </div><div class="t m0 xd hd y276 ff22 fs7 fc3 sc0 ls1 ws1">“<span class="_ _3"></span>Getting Started,<span class="_ _8"></span>” using <span class="ff26 ls1a wsbd">ma<span class="_ _0"></span>ke</span>. First of all, cr<span class="_ _1"></span>eate a text file named <span class="ff26">makefile</span> </div><div class="t m0 xd hd y277 ff22 fs7 fc3 sc0 ls1 ws1">containing the code in Listing <span class="fc5">3-1</span>.</div><div class="t m0 xd h20 y59d ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-1. <span class="_ _15"> </span><span class="ff22">Simple mak<span class="_ _3"></span>efile for HelloW<span class="_ _1"></span>orld</span></div><div class="t m0 xd h18 y59e ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld: HelloWorld.o</div><div class="t m0 xd h18 y59f ff29 fs7 fc3 sc0 ls1 ws1">     ld -o HelloWorld HelloWorld.o</div><div class="t m0 xd h18 y5a0 ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld.o: HelloWorld.s</div><div class="t m0 xd h18 y5a1 ff29 fs7 fc3 sc0 ls1 ws1">     as -o HelloWorld.o HelloWorld.s</div><div class="t m0 x34 h1f y5a2 ff27 fse fc3 sc0 ls1 ws1">Note<span class="ff2a"> <span class="_ _17"> </span>The command make is particular<span class="_ _6"></span>,<span class="_ _1"></span> and the indented lines must </span></div><div class="t m0 x34 h1f y5a3 ff2a fse fc3 sc0 ls1 ws1">start with a tab not spaces,<span class="_ _1"></span> or you will get an error<span class="_ _6"></span>.</div><div class="t m0 xc hd y5a4 ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o build our file, type</div><div class="t m0 xd h18 y5a5 ff29 fs7 fc3 sc0 ls1 ws1">make</div><div class="t m0 xd ha y5a6 ff27 fs6 fc3 sc0 ls1 wsb1"> Rebuilding <span class="_ _14"> </span>aFile</div><div class="t m0 xd hd y5a7 ff22 fs7 fc3 sc0 ls1 ws1">If we already built the pr<span class="_ _1"></span>ogram, then this won’t do anything, since make </div><div class="t m0 xd hd y5a8 ff22 fs7 fc3 sc0 ls1 ws1">sees that the executable is older than the <span class="ff26">.o</span> file and th<span class="_ _3"></span>at the <span class="ff26">.o</span> file is older </div><div class="t m0 xd hd y5a9 ff22 fs7 fc3 sc0 ls1 ws1">than the <span class="ff26">.s</span> file. W<span class="_ _1"></span>e can for<span class="_ _3"></span>ce a re<span class="_ _3"></span>build by typing</div><div class="t m0 xd h18 y5aa ff29 fs7 fc3 sc0 ls1 ws1">make -B</div><div class="t m0 xc hd y5ab ff22 fs7 fc3 sc0 ls1 ws1">Rather than specify each file separ<span class="_ _3"></span>ately along with the command to </div><div class="t m0 xd hd y5ac ff22 fs7 fc3 sc0 ls1 ws1">build it, we can define a build rule for<span class="_ _10"></span>, say, building a <span class="ff26">.o</span> file from an <span class="ff26">.s</span> file<span class="_ _1"></span>.</div><div class="t m0 xd h12 y28b ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:355.496000px;bottom:577.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4f" data-dest-detail='[79,"XYZ",35,532,null]'><div class="d m1" style="border-style:none;position:absolute;left:177.029000px;bottom:545.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf50" class="pf w2 h6" data-page-no="50"><div class="pc pc50 w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">61</div><div class="t m0 xc ha y248 ff27 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>A Rule forBuilding .s Files</div><div class="t m0 xc hd y249 ff22 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">3-2</span> shows a mor<span class="_ _3"></span>e advanced version, where we define a rule for </div><div class="t m0 xc hd y24a ff22 fs7 fc3 sc0 ls1 ws1">building an <span class="ff26">.o</span> file fr<span class="_ _3"></span>om an <span class="ff26">.s</span> file. W<span class="_ _1"></span>e still need to specify the dependenc<span class="_ _0"></span>y, </div><div class="t m0 xc hd y24b ff22 fs7 fc3 sc0 ls1 ws1">but we no longer need the compile rule. As we get more sophistica<span class="_ _3"></span>ted and </div><div class="t m0 xc hd y5ad ff22 fs7 fc3 sc0 ls1 ws1">add command line parameters to the <span class="ff26">as</span> comm<span class="_ _3"></span>and, we’<span class="_ _1"></span>ve now centralized </div><div class="t m0 xc hd y5ae ff22 fs7 fc3 sc0 ls1 ws1">the location to do this<span class="_ _3"></span>.</div><div class="t m0 xc h20 y5af ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-2. <span class="_ _15"> </span><span class="ff22">Hello W<span class="_ _1"></span>orld makefile with a rule</span></div><div class="t m0 xc h18 y5b0 ff29 fs7 fc3 sc0 ls1 ws1"> %.o : %.s</div><div class="t m0 xc h18 y5b1 ff29 fs7 fc3 sc0 ls1 ws1">     as $&lt; -o $@</div><div class="t m0 xc h18 y5b2 ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld: HelloWorld.o</div><div class="t m0 xc h18 y5b3 ff29 fs7 fc3 sc0 ls1 ws1">     ld -o HelloWorld HelloWorld.o</div><div class="t m0 x1c hd y5b4 ff22 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w make knows ho<span class="_ _3"></span>w to crea<span class="_ _3"></span>te a <span class="ff26">.o</span> file from a <span class="ff26">.s</span> file<span class="_ _1"></span>. We<span class="_ _1"></span>’ve told make </div><div class="t m0 xc hd y5b5 ff22 fs7 fc3 sc0 ls1 ws1">to build <span class="ff26">HelloW<span class="_ _1"></span>orld<span class="ff22"> from </span>H<span class="_ _1"></span>elloWor<span class="_ _3"></span>ld.o<span class="ff22">, and make can look at its lis<span class="_ _3"></span>t of </span></span></div><div class="t m0 xc hd y5b6 ff22 fs7 fc3 sc0 ls1 ws1">rules to figure out ho<span class="_ _3"></span>w to build <span class="ff26">HelloW<span class="_ _1"></span>orld.o<span class="ff22">. Ther<span class="_ _3"></span>e are some str<span class="_ _3"></span>ange </span></span></div><div class="t m0 xc hd y5b7 ff22 fs7 fc3 sc0 ls1 ws1">symbols in this file and their meaning is as follows:</div><div class="t m0 x1e hd y5b8 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">%.s</span> is like a wildcard meanin<span class="_ _3"></span>g any <span class="ff26">.s</span> file.</div><div class="t m0 x1e hd y5b9 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">$&lt;</span> is a symbol for the source file<span class="_ _1"></span>.</div><div class="t m0 x1e hd y5ba ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">$@</span> is a symbol for the output file<span class="_ _3"></span>.</div><div class="t m0 x1c hd y5bb ff22 fs7 fc3 sc0 ls1 ws1">There<span class="_ _1"></span>’<span class="_ _1"></span>s a lot of good documentation on <span class="ff26 ls1a wsbd">ma<span class="_ _0"></span>ke</span>, so we aren’t going to go </div><div class="t m0 xc hd y5bc ff22 fs7 fc3 sc0 ls1 ws1">into a lot of detail her<span class="_ _3"></span>e.</div><div class="t m0 xc ha y5bd ff27 fs6 fc3 sc0 ls1 wsb1"> Defining <span class="_ _14"> </span>V<span class="_ _3"></span>ariables</div><div class="t m0 xc hd y5be ff22 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">3-3</span> shows how to define variables<span class="_ _1"></span>. Here we’ll do it to cen<span class="_ _3"></span>tralize the </div><div class="t m0 xc hd y5bf ff22 fs7 fc3 sc0 ls1 ws1">list of files we want to assemble<span class="_ _3"></span>.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf50" data-dest-detail='[80,"XYZ",53,471,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:548.518000px;width:15.047600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf51" data-dest-detail='[81,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:136.018000px;width:15.047600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf51" class="pf w2 h6" data-page-no="51"><div class="pc pc51 w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">62</div><div class="t m0 xd h20 y4c5 ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-3. <span class="_ _15"> </span><span class="ff22">Adding a variable to the H<span class="_ _1"></span>ello Wor<span class="_ _3"></span>ld makefile</span></div><div class="t m0 xd h18 y4c6 ff29 fs7 fc3 sc0 ls1 ws1"> OBJS = HelloWorld.o</div><div class="t m0 xd h18 y4f6 ff29 fs7 fc3 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xd h18 y4f7 ff29 fs7 fc3 sc0 ls1 ws1">     as $&lt; -o $@</div><div class="t m0 xd h18 y5c0 ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld: $(OBJS)</div><div class="t m0 xd h18 y5c1 ff29 fs7 fc3 sc0 ls1 ws1">     ld -o HelloWorld $(OBJS)</div><div class="t m0 xc hd y5c2 ff22 fs7 fc3 sc0 ls1 ws1">With this code<span class="_ _3"></span>, as we add source files<span class="_ _3"></span>, we just add the new file to the </div><div class="t m0 xd hd y5c3 ff26 fs7 fc3 sc0 ls1 ws1">OBJS= line<span class="ff22"> and </span><span class="ls1a wsbd">ma<span class="_ _0"></span>ke</span><span class="ff22"> takes care of the r<span class="_ _3"></span>est.</span></div><div class="t m0 xc hd y5c4 ff22 fs7 fc3 sc0 ls1 ws1">This is just an intr<span class="_ _1"></span>oduction to GNU Make—there is a lot mor<span class="_ _1"></span>e to this </div><div class="t m0 xd hd y5c5 ff22 fs7 fc3 sc0 ls1 ws1">powerful tool. As we go further into the book, we w<span class="_ _0"></span>ill intr<span class="_ _1"></span>oduce new </div><div class="t m0 xd hd y5c6 ff22 fs7 fc3 sc0 ls1 ws1">elements to our <span class="ff26">mak<span class="_ _1"></span>efile<span class="_ _0"></span>s<span class="ff22"> as needed.</span></span></div><div class="t m0 xd h15 y5c7 ff27 fsb fc3 sc0 ls1 wsaf"> GDB</div><div class="t m0 xd hd y5c8 ff22 fs7 fc3 sc0 ls1 ws1">Most high-level lan<span class="_ _3"></span>guages come with tools to easily output any strings or </div><div class="t m0 xd hd y5c9 ff22 fs7 fc3 sc0 ls1 ws1">numbers to the console<span class="_ _3"></span>, a window, or a web page. Often when usin<span class="_ _3"></span>g these </div><div class="t m0 xd hd y5ca ff22 fs7 fc3 sc0 ls1 ws1">languages<span class="_ _3"></span>, progr<span class="_ _3"></span>ammers don’t bother using the debugger<span class="_ _10"></span>, instead relying </div><div class="t m0 xd hd y5cb ff22 fs7 fc3 sc0 ls1 ws1">on libraries that ar<span class="_ _1"></span>e par<span class="_ _0"></span>t of the langua<span class="_ _3"></span>ge.</div><div class="t m0 xc hd y5cc ff22 fs7 fc3 sc0 ls1 ws1">Later<span class="_ _10"></span>, w<span class="_ _0"></span>e<span class="_ _3"></span>’ll look at how to lever<span class="_ _3"></span>age the libraries tha<span class="_ _3"></span>t are part of other </div><div class="t m0 xd hd y5cd ff22 fs7 fc3 sc0 ls1 ws1">languages<span class="_ _3"></span>, but calling these takes a bit of work<span class="_ _3"></span>. W<span class="_ _1"></span>e’ll also develop a helpful </div><div class="t m0 xd hd y5ce ff22 fs7 fc3 sc0 ls1 ws1">library to convert numbers to strings<span class="_ _3"></span>, so we can use the techniques used in </div><div class="t m0 xd hd y5cf ff22 fs7 fc3 sc0 ls1 ws1">the HelloW<span class="_ _1"></span>orld progr<span class="_ _3"></span>am in Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>Getting Started,<span class="_ _8"></span>” to pr<span class="_ _0"></span>int o<span class="_ _3"></span>ur work.</div><div class="t m0 xc hd y5d0 ff22 fs7 fc3 sc0 ls1 ws1">When progr<span class="_ _3"></span>amming with Assembly Language<span class="_ _3"></span>, being proficien<span class="_ _3"></span>t </div><div class="t m0 xd hd y5d1 ff22 fs7 fc3 sc0 ls1 ws1">with the debugger is critical to success. N<span class="_ _1"></span>ot only will this help w<span class="_ _0"></span>ith your </div><div class="t m0 xd hd y5d2 ff22 fs7 fc3 sc0 ls1 ws1">Assembly Language pr<span class="_ _3"></span>ogramming, b<span class="_ _3"></span>ut also it is a great tool for y<span class="_ _3"></span>ou to use </div><div class="t m0 xd hd y5d3 ff22 fs7 fc3 sc0 ls1 ws1">with your high-level language pr<span class="_ _1"></span>ogramming.</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:204.507000px;bottom:200.634000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf52" class="pf w2 h6" data-page-no="52"><div class="pc pc52 w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">63</div><div class="t m0 x1c hd y145 ff22 fs7 fc3 sc0 ls1 ws1">GDB comes preinstalled on most Linux distributions<span class="_ _1"></span>, but if it is </div><div class="t m0 xc hd y146 ff22 fs7 fc3 sc0 ls1 ws1">missing from y<span class="_ _3"></span>our version and you’r<span class="_ _1"></span>e r<span class="_ _0"></span>unning one based on Debian, like </div><div class="t m0 xc hd y147 ff22 fs7 fc3 sc0 ls1 ws1">Kali, then you c<span class="_ _3"></span>an install it via</div><div class="t m0 xc h18 y2d7 ff29 fs7 fc3 sc0 ls1 ws1">sudo apt-get install gdb</div><div class="t m0 xc ha y30f ff27 fs6 fc3 sc0 ls1 wsb1"> Preparing <span class="_ _14"> </span>toDebug</div><div class="t m0 xc hd y57a ff22 fs7 fc3 sc0 ls1 ws1">The GNU Debugger (GDB) can debug yo<span class="_ _3"></span>ur progr<span class="_ _3"></span>am as it is, but this is<span class="_ _3"></span>n’t </div><div class="t m0 xc hd y57b ff22 fs7 fc3 sc0 ls1 ws1">the most convenien<span class="_ _3"></span>t way to go<span class="_ _1"></span>. For instance<span class="_ _1"></span>, in our HelloW<span class="_ _1"></span>orld program, </div><div class="t m0 xc hd y57c ff22 fs7 fc3 sc0 ls1 ws1">we hav<span class="_ _3"></span>e the label <span class="ff26">helloworld</span>. If we debug the progr<span class="_ _3"></span>am as is, the de<span class="_ _3"></span>bugger </div><div class="t m0 xc hd y57d ff22 fs7 fc3 sc0 ls1 ws1">won’t know anything about this la<span class="_ _3"></span>bel, since the Assembler changed it </div><div class="t m0 xc hd y57e ff22 fs7 fc3 sc0 ls1 ws1">into an addr<span class="_ _3"></span>ess in a .data section. There is a comm<span class="_ _3"></span>and line option for the </div><div class="t m0 xc hd y57f ff22 fs7 fc3 sc0 ls1 ws1">Assembler that includes a ta<span class="_ _3"></span>ble of all our source code labels and sym<span class="_ _3"></span>bols, </div><div class="t m0 xc hd y580 ff22 fs7 fc3 sc0 ls1 ws1">so we can use them in the debugger<span class="_ _6"></span>. This makes our pr<span class="_ _1"></span>ogram executable a </div><div class="t m0 xc hd y581 ff22 fs7 fc3 sc0 ls1 ws1">bit larger<span class="_ _6"></span>.</div><div class="t m0 x1c hd y582 ff22 fs7 fc3 sc0 ls1 ws1">Often, we set a debug flag while we are developin<span class="_ _3"></span>g the progr<span class="_ _3"></span>am, then </div><div class="t m0 xc hd y583 ff22 fs7 fc3 sc0 ls1 ws1">remo<span class="_ _3"></span>ve the debug flag befor<span class="_ _1"></span>e releasing the progr<span class="_ _3"></span>am. Unlik<span class="_ _3"></span>e some high- </div><div class="t m0 xc hd y584 ff22 fs7 fc3 sc0 ls1 ws1">level progr<span class="_ _3"></span>amming languages<span class="_ _1"></span>, the debug flag doesn’t affect the machine </div><div class="t m0 xc hd y585 ff22 fs7 fc3 sc0 ls1 ws1">code generated, so the pr<span class="_ _3"></span>ogram beha<span class="_ _1"></span>ves exactly the same in both debug </div><div class="t m0 xc hd y586 ff22 fs7 fc3 sc0 ls1 ws1">and non-debug mode.</div><div class="t m0 x1c hd y5d4 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e don’t want to leave the de<span class="_ _3"></span>bug information in our pr<span class="_ _1"></span>ogram for </div><div class="t m0 xc hd y5d5 ff22 fs7 fc3 sc0 ls1 ws1">release<span class="_ _3"></span>, because besides making the pr<span class="_ _1"></span>ogram executable larger<span class="_ _6"></span>, it is a </div><div class="t m0 xc hd y5d6 ff22 fs7 fc3 sc0 ls1 ws1">wealth of information for hackers t<span class="_ _3"></span>o help them reverse engineer your </div><div class="t m0 xc hd y5d7 ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am. Ther<span class="_ _1"></span>e are several cases where h<span class="_ _3"></span>ackers ca<span class="_ _3"></span>used mischief because </div><div class="t m0 xc hd y5d8 ff22 fs7 fc3 sc0 ls1 ws1">the progr<span class="_ _3"></span>am still had debugging informa<span class="_ _3"></span>tion presen<span class="_ _3"></span>t.</div><div class="t m0 x1c hd y5d9 ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o add debug information to our pr<span class="_ _3"></span>ogram<span class="_ _3"></span>, we must Assemble it with </div><div class="t m0 xc hd y5da ff22 fs7 fc3 sc0 ls1 ws1">the <span class="ff26">-g</span> flag. In Listing <span class="fc5">3-4</span>, we add a deb<span class="_ _3"></span>ug flag to our <span class="ff26">mak<span class="_ _3"></span>efile<span class="ff22">. F<span class="_ _3"></span>or the first </span></span></div><div class="t m0 xc hd y5db ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am we’ll debug, let’<span class="_ _6"></span>s use our examples of the <span class="ff26 lsb wsb4">MOV</span> statements<span class="_ _3"></span>, since </div><div class="t m0 xc hd y5dc ff22 fs7 fc3 sc0 ls1 ws1">we didn’t see the operations working on the various r<span class="_ _1"></span>e<span class="_ _0"></span>gisters<span class="_ _1"></span>.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf53" data-dest-detail='[83,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:151.502000px;bottom:153.175000px;width:15.048000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf53" class="pf w2 h6" data-page-no="53"><div class="pc pc53 w2 h6"><img class="bi xd y5dd w7 h24" alt="" src="bg53.png"/><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">64</div><div class="t m0 xd h20 y4c5 ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-4. <span class="_ _15"> </span><span class="ff22">Mak<span class="_ _3"></span>efile with a debug flag</span></div><div class="t m0 xd h18 y4c6 ff29 fs7 fc3 sc0 ls1 ws1"> OBJS = movexamps.o</div><div class="t m0 xd h18 y4c7 ff29 fs7 fc3 sc0 ls1 ws1">ifdef DEBUG</div><div class="t m0 xd h18 y4c8 ff29 fs7 fc3 sc0 ls1 ws1">DEBUGFLGS = -g</div><div class="t m0 xd h18 y4c9 ff29 fs7 fc3 sc0 ls1 ws1">else</div><div class="t m0 xd h18 y5de ff29 fs7 fc3 sc0 ls1 ws1">DEBUGFLGS =</div><div class="t m0 xd h18 y5df ff29 fs7 fc3 sc0 ls1 ws1">endif</div><div class="t m0 xd h18 y4cc ff29 fs7 fc3 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xd h18 y4cd ff29 fs7 fc3 sc0 ls1 ws1">     as $(DEBUGFLGS) $&lt; -o $@</div><div class="t m0 xd h18 y5e0 ff29 fs7 fc3 sc0 ls1 ws1">movexamps: $(OBJS)</div><div class="t m0 xd h18 y4cf ff29 fs7 fc3 sc0 ls1 ws1">     ld -o movexamps $(OBJS)</div><div class="t m0 xc hd y5e1 ff22 fs7 fc3 sc0 ls1 ws1">This <span class="ff26">mak<span class="_ _3"></span>efile<span class="ff22"> sets the debug flag if the variable DEBUG is defined. W<span class="_ _1"></span>e </span></span></div><div class="t m0 xd hd y4d1 ff22 fs7 fc3 sc0 ls1 ws1">can define it on the command line for <span class="ff26 ls1a wsbd">make<span class="_ _0"></span></span> with</div><div class="t m0 xd h18 y5e2 ff29 fs7 fc3 sc0 ls1 ws1">make DEBUG=1</div><div class="t m0 xc hd y5e3 ff22 fs7 fc3 sc0 ls1 ws1">or<span class="_ _6"></span>, from the command line<span class="_ _1"></span>, define an environment v<span class="_ _3"></span>ariable with</div><div class="t m0 xd h18 y5e4 ff29 fs7 fc3 sc0 ls1 ws1">export DEBUG=1</div><div class="t m0 xc hd y5e5 ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o clear the environmen<span class="_ _3"></span>t variable, en<span class="_ _3"></span>ter</div><div class="t m0 xd h18 y5e6 ff29 fs7 fc3 sc0 ls1 ws1">export DEBUG=</div><div class="t m0 xc hd y5e7 ff22 fs7 fc3 sc0 ls1 ws1">When switching between <span class="ff26 ls7 ws6f">DEBUG</span> and <span class="ff26">non-DEBUG</span>, run make with </div><div class="t m0 xd hd y5e8 ff22 fs7 fc3 sc0 ls1 ws1">the <span class="ff26">-B</span> switch to build everything.</div><div class="t m0 x34 h1f y5e9 ff27 fse fc3 sc0 ls1e wsc1">Tip<span class="_ _0"></span><span class="ff2a ls1 ws1"> <span class="_ _19"> </span>Create shell scripts <span class="ff27">buildd</span> and <span class="ff27">buildr</span> to call make with and </span></div><div class="t m0 x34 h1f y5ea ff2a fse fc3 sc0 ls1 ws1">without <span class="ff27">DEBUG</span> defined.</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf54" class="pf w2 h6" data-page-no="54"><div class="pc pc54 w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">65</div><div class="t m0 xc ha y248 ff27 fs6 fc3 sc0 ls1 wsb1"> Beginning <span class="_ _14"> </span>GDB</div><div class="t m0 xc hd y249 ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o start debugging our <span class="ff26">movexamps</span> program, en<span class="_ _3"></span>ter the command</div><div class="t m0 xc h18 y5eb ff29 fs7 fc3 sc0 ls1 ws1">gdb moveexamps</div><div class="t m0 x1c hd y5ec ff22 fs7 fc3 sc0 ls1 ws1">This yields the abbr<span class="_ _3"></span>eviated output<span class="_ _0"></span>:</div><div class="t m0 xc h18 y5ed ff29 fs7 fc3 sc0 ls1 ws1">GNU gdb (Debian 8.3.1-1) 8.3.1</div><div class="t m0 xc h18 y5ee ff29 fs7 fc3 sc0 ls1 ws1">Copyright (C) 2019 Free Software Foundation, Inc.</div><div class="t m0 xc h18 y5ef ff29 fs7 fc3 sc0 ls1 ws1">...</div><div class="t m0 xc h18 y5f0 ff29 fs7 fc3 sc0 ls1 ws1">Reading symbols from movexamps...</div><div class="t m0 xc h18 y5f1 ff29 fs7 fc3 sc0 ls1 ws1">(gdb)</div><div class="t m0 x1e hd y5f2 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">gdb</span> is a command line progr<span class="_ _3"></span>am.</div><div class="t m0 x1e hd y5f3 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">(gdb)</span> is the command prompt wher<span class="_ _1"></span>e you type </div><div class="t m0 x9 hd y5f4 ff22 fs7 fc3 sc0 ls1 ws1">commands<span class="_ _3"></span>.</div><div class="t m0 x1e hd y5f5 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">(hit tab)</span> for command completion. E<span class="_ _3"></span>nter the first letter </div><div class="t m0 x9 hd y5f6 ff22 fs7 fc3 sc0 ls1 ws1">or two of a command as a shortcut.</div><div class="t m0 x1c hd y5f7 ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o run the program, type</div><div class="t m0 xc h18 y5f8 ff29 fs7 fc3 sc0 ls1 ws1">run</div><div class="t m0 x1c hd y5f9 ff22 fs7 fc3 sc0 ls1 ws1">(<span class="_ _3"></span>or r).</div><div class="t m0 x1c hd y5fa ff22 fs7 fc3 sc0 ls1 ws1">The progr<span class="_ _3"></span>am runs to completion, as if it ran normally fr<span class="_ _3"></span>om the </div><div class="t m0 xc hd y5fb ff22 fs7 fc3 sc0 ls1 ws1">command line.</div><div class="t m0 x1c hd y5fc ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o list our progr<span class="_ _3"></span>am, type</div><div class="t m0 xc h18 y5fd ff29 fs7 fc3 sc0 ls1 ws1">list</div><div class="t m0 x1c hd y5fe ff22 fs7 fc3 sc0 ls1 ws1">(<span class="_ _3"></span>or l).</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf55" class="pf w2 h6" data-page-no="55"><div class="pc pc55 w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">66</div><div class="t m0 xc hd y145 ff22 fs7 fc3 sc0 ls1 ws1">This lists ten lines<span class="_ _3"></span>. Type</div><div class="t m0 xd h18 y2e0 ff29 fs7 fc3 sc0 ls1 ws1">l</div><div class="t m0 xc hd y3e9 ff22 fs7 fc3 sc0 ls1 ws1">for the next ten lines<span class="_ _3"></span>. Type</div><div class="t m0 xd h18 y3ea ff29 fs7 fc3 sc0 ls1 ws1">list 1,1000</div><div class="t m0 xc hd y5ff ff22 fs7 fc3 sc0 ls1 ws1">to list our entir<span class="_ _3"></span>e progr<span class="_ _3"></span>am.</div><div class="t m0 xc hd y498 ff22 fs7 fc3 sc0 ls1 ws1">Notice th<span class="_ _3"></span>at list gives us the sour<span class="_ _3"></span>ce code for our progr<span class="_ _3"></span>am, including </div><div class="t m0 xd hd y499 ff22 fs7 fc3 sc0 ls1 ws1">comments<span class="_ _3"></span>. This is a handy wa<span class="_ _3"></span>y to find line numbers for other commands<span class="_ _1"></span>. </div><div class="t m0 xd hd y49a ff22 fs7 fc3 sc0 ls1 ws1">If we want to see the ra<span class="_ _3"></span>w machine code<span class="_ _3"></span>, we can ha<span class="_ _3"></span>ve gdb disassemble our </div><div class="t m0 xd hd y600 ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am with</div><div class="t m0 xd h18 y601 ff29 fs7 fc3 sc0 ls1 ws1">disassemble _start</div><div class="t m0 xc hd y56c ff22 fs7 fc3 sc0 ls1 ws1">This shows the actual code pr<span class="_ _3"></span>oduced by the Assembler with no </div><div class="t m0 xd hd y602 ff22 fs7 fc3 sc0 ls1 ws1">comments<span class="_ _3"></span>. W<span class="_ _1"></span>e can see whether MOV or MVN were used among other </div><div class="t m0 xd hd y603 ff22 fs7 fc3 sc0 ls1 ws1">commands this way.</div><div class="t m0 xc hd y604 ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o stop the program<span class="_ _1"></span>, w<span class="_ _0"></span>e set a br<span class="_ _3"></span>eakpoint. I<span class="_ _3"></span>n this case, we wan<span class="_ _3"></span>t to stop </div><div class="t m0 xd hd y605 ff22 fs7 fc3 sc0 ls1 ws1">the progr<span class="_ _3"></span>am at the beginning to single step thr<span class="_ _1"></span>ough, examining registers as </div><div class="t m0 xd hd y606 ff22 fs7 fc3 sc0 ls1 ws1">we go<span class="_ _3"></span>. T<span class="_ _6"></span>o set a breakpoint<span class="_ _3"></span>, use the <span class="ff26">break<span class="_ _3"></span>point<span class="ff22"> command (<span class="_ _3"></span>or <span class="ff26">b</span>):</span></span></div><div class="t m0 xd h18 y607 ff29 fs7 fc3 sc0 ls1 ws1">b _start</div><div class="t m0 xc hd y573 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can specify a line number<span class="_ _6"></span>, or a symbol for our br<span class="_ _3"></span>eakpoint, as in this </div><div class="t m0 xd hd y574 ff22 fs7 fc3 sc0 ls1 ws1">example; now if we run the progr<span class="_ _3"></span>am, it stops at the br<span class="_ _1"></span>eakpoint<span class="_ _0"></span>:</div><div class="t m0 xd h18 y608 ff29 fs7 fc3 sc0 ls1 ws1">(gdb) b _start</div><div class="t m0 xd h18 y609 ff29 fs7 fc3 sc0 ls1 ws1">Breakpoint 1 at 0x400078: file movexamps.s, line 7.</div><div class="t m0 xd h18 y60a ff29 fs7 fc3 sc0 ls1 ws1">(gdb) r</div><div class="t m0 xd h18 y60b ff29 fs7 fc3 sc0 ls1 ws1">Starting program: /home/smist08/asm64/Chapter 2/movexamps</div><div class="t m0 xd h18 y60c ff29 fs7 fc3 sc0 ls1 ws1">Breakpoint 1, _start () at movexamps.s:7</div><div class="t m0 xd h18 y60d ff29 fs7 fc3 sc0 ls1 ws1">7       _start: MOV     X2, #0x6E3A</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf56" class="pf w2 h6" data-page-no="56"><div class="pc pc56 w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">67</div><div class="t m0 x1c hd y145 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can now step through the pr<span class="_ _1"></span>ogram with the <span class="ff26">step</span> command (or <span class="ff26">s</span>). </div><div class="t m0 xc hd y146 ff22 fs7 fc3 sc0 ls1 ws1">As we go<span class="_ _3"></span>, we want to see the values of the r<span class="_ _3"></span>egisters. W<span class="_ _1"></span>e get these with <span class="ff26">info </span></div><div class="t m0 xc hd y147 ff26 fs7 fc3 sc0 ls1 ws1">registers<span class="ff22"> (or </span>i r<span class="ff22">):</span></div><div class="t m0 xc h18 y2d7 ff29 fs7 fc3 sc0 ls1 ws1">(gdb) s</div><div class="t m0 xc h18 y2e2 ff29 fs7 fc3 sc0 ls1 ws1">8               MOVK    X2, #0x4F5D, LSL #16</div><div class="t m0 xc h18 y60e ff29 fs7 fc3 sc0 ls1 ws1">(gdb) i r</div><div class="t m0 xc h18 y230 ff29 fs7 fc3 sc0 ls1 ws1">x0             0x0                 0</div><div class="t m0 xc h18 y60f ff29 fs7 fc3 sc0 ls1 ws1">x1             0x0                 0</div><div class="t m0 xc h18 y610 ff29 fs7 fc3 sc0 ls1 ws1">x2             0x6e3a              28218</div><div class="t m0 xc h18 y611 ff29 fs7 fc3 sc0 ls1 ws1">x3             0x0                 0</div><div class="t m0 xc h18 y612 ff29 fs7 fc3 sc0 ls1 ws1">x4             0x0                 0</div><div class="t m0 xc h18 y613 ff29 fs7 fc3 sc0 ls1 ws1">x5             0x0                 0</div><div class="t m0 xc h18 y614 ff29 fs7 fc3 sc0 ls1 ws1">...</div><div class="t m0 xc h18 y615 ff29 fs7 fc3 sc0 ls1 ws1">x29            0x0                 0</div><div class="t m0 xc h18 y616 ff29 fs7 fc3 sc0 ls1 ws1">x30            0x0                 0</div><div class="t m0 xc h18 y617 ff29 fs7 fc3 sc0 ls1 ws1">sp             0x7ffffff230        0x7ffffff230</div><div class="t m0 xc h18 y618 ff29 fs7 fc3 sc0 ls1 ws1">pc             0x40007c            0x40007c &lt;_start+4&gt;</div><div class="t m0 xc h18 y619 ff29 fs7 fc3 sc0 ls1 ws1">cpsr           0x200000            [ EL=0 SS ]</div><div class="t m0 xc h18 y61a ff29 fs7 fc3 sc0 ls1 ws1">fpsr           0x0                 0</div><div class="t m0 xc h18 y61b ff29 fs7 fc3 sc0 ls1 ws1">fpcr           0x0                 0</div><div class="t m0 xc h18 y61c ff29 fs7 fc3 sc0 ls1 ws1">(gdb)</div><div class="t m0 x1c hd y61d ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e see <span class="ff26">0x6E3A</span> put in <span class="ff26">X2</span> as expected.</div><div class="t m0 x1c hd y61e ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can continue stepping or enter <span class="ff26">continue</span> (<span class="_ _1"></span>or <span class="ff26">c</span>), to continue to </div><div class="t m0 xc hd y61f ff22 fs7 fc3 sc0 ls1 ws1">the next <span class="ff26">break<span class="_ _1"></span>p<span class="_ _0"></span>oint<span class="ff22"> or to the end of the pr<span class="_ _3"></span>ogram<span class="_ _3"></span>. W<span class="_ _1"></span>e can set as many </span></span></div><div class="t m0 xc hd y620 ff22 fs7 fc3 sc0 ls1 ws1">breakpoin<span class="_ _3"></span>ts as we like. W<span class="_ _1"></span>e can see them all with the <span class="ff26">info break<span class="_ _3"></span>points<span class="ff22">  </span></span></div><div class="t m0 xc hd y621 ff22 fs7 fc3 sc0 ls1 ws1">(<span class="_ _3"></span>or <span class="ff26">i b</span>) command. W<span class="_ _1"></span>e can delete a break<span class="_ _3"></span>point with the <span class="ff26">delete</span> command, </div><div class="t m0 xc hd y622 ff22 fs7 fc3 sc0 ls1 ws1">specifying the break<span class="_ _3"></span>point number to delete<span class="_ _1"></span>.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf57" class="pf w2 h6" data-page-no="57"><div class="pc pc57 w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">68</div><div class="t m0 xd h18 y46b ff29 fs7 fc3 sc0 ls1 ws1">(gdb) i b</div><div class="t m0 xd h18 y46c ff29 fs7 fc3 sc0 ls1 ws1">Num     Type           Disp Enb Address            What</div><div class="t m0 xd h18 y46d ff29 fs7 fc3 sc0 ls1 ws1">1       breakpoint     keep y   0x0000000000400078 </div><div class="t m0 xd h18 y623 ff29 fs7 fc3 sc0 ls1 ws1">movexamps.s:7</div><div class="t m0 xd h18 y624 ff29 fs7 fc3 sc0 ls1 ws1">        breakpoint already hit 1 time</div><div class="t m0 xd h18 y625 ff29 fs7 fc3 sc0 ls1 ws1">(gdb) delete 1</div><div class="t m0 xd h18 y626 ff29 fs7 fc3 sc0 ls1 ws1">(gdb) i b</div><div class="t m0 xd h18 y627 ff29 fs7 fc3 sc0 ls1 ws1">No breakpoints or watchpoints.</div><div class="t m0 xd h18 y628 ff29 fs7 fc3 sc0 ls1 ws1">(gdb)</div><div class="t m0 xc hd y629 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e haven’t dealt with memory much, but <span class="ff26">gdb</span> has good mechanisms </div><div class="t m0 xd hd y62a ff22 fs7 fc3 sc0 ls1 ws1">to display memory in different formats<span class="_ _1"></span>, the main command being x. It has </div><div class="t m0 xd hd y62b ff22 fs7 fc3 sc0 ls1 ws1">the following format<span class="_ _0"></span>:</div><div class="t m0 xd h18 y62c ff29 fs7 fc3 sc0 ls1 ws1">x /Nfu addr</div><div class="t m0 xd hd y62d ff22 fs7 fc3 sc0 ls1 ws1">where</div><div class="t m0 xa hd y62e ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">N</span> is the number of objects to display</div><div class="t m0 xa hd y62f ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">f</span> is the display format wher<span class="_ _1"></span>e some common ones are</div><div class="t m0 x1e hd y630 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>t for binary</div><div class="t m0 x1e hd y631 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>x for hexadecimal</div><div class="t m0 x1e hd y632 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>d for decimal</div><div class="t m0 x1e hd y633 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>i for instruction</div><div class="t m0 x1e hd y634 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>s for string</div><div class="t m0 xa hd y635 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff26">u</span> is unit size and is any of</div><div class="t m0 x1e hd y636 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>b for bytes</div><div class="t m0 x1e hd y637 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>h for halfwords (16 bits)</div><div class="t m0 x1e hd y638 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>w for words (32 bits)</div><div class="t m0 x1e hd y639 ff22 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>g for giant words (64 bits)</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf58" class="pf w2 h6" data-page-no="58"><div class="pc pc58 w2 h6"><img class="bi xa y63a wd h2e" alt="" src="bg58.png"/><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">69</div><div class="t m0 x1c hd y145 ff22 fs7 fc3 sc0 ls1 ws1">Some examples using our code stor<span class="_ _3"></span>ed at memory location _start, or </div><div class="t m0 xc hd y146 ff22 fs7 fc3 sc0 ls1 ws1">0x10054:</div><div class="t m0 xc h18 y2e1 ff29 fs7 fc3 sc0 ls1 ws1">(gdb) x /4ubft _start</div><div class="t m0 xc h18 y2d7 ff29 fs7 fc3 sc0 ls1 ws1">0x400078 &lt;_start&gt;:    01000010   11000111   10001101   11010010</div><div class="t m0 xc h18 y2d8 ff29 fs7 fc3 sc0 ls1 ws1">(gdb) x /4ubfi _start</div><div class="t m0 xc h18 y60e ff29 fs7 fc3 sc0 ls1 ws1">   0x400078 &lt;_start&gt;:   mov     x2, #0x6e3a          // #28218</div><div class="t m0 xc h18 y230 ff29 fs7 fc3 sc0 ls1 ws1">=&gt; 0x40007c &lt;_start+4&gt;: movk    x2, #0x4f5d, lsl #16</div><div class="t m0 xc h18 y60f ff29 fs7 fc3 sc0 ls1 ws1">   0x400080 &lt;_start+8&gt;: movk    x2, #0xfedc, lsl #32</div><div class="t m0 xc h18 y610 ff29 fs7 fc3 sc0 ls1 ws1">   0x400084 &lt;_start+12&gt;: movk    x2, #0x1234, lsl #48</div><div class="t m0 xc h18 y63b ff29 fs7 fc3 sc0 ls1 ws1">(gdb) x /4ubfx _start</div><div class="t m0 xc h18 y63c ff29 fs7 fc3 sc0 ls1 ws1">0x400078 &lt;_start&gt;:      0x42    0xc7    0x8d    0xd2</div><div class="t m0 xc h18 y63d ff29 fs7 fc3 sc0 ls1 ws1">(gdb) x /4ubfd _start</div><div class="t m0 xc h18 y614 ff29 fs7 fc3 sc0 ls1 ws1">0x400078 &lt;_start&gt;:      66      -57     -115    -46</div><div class="t m0 x1c hd y63e ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o exit <span class="ff26">gdb</span>, t<span class="_ _0"></span>ype <span class="ff26">q</span> (for <span class="ff26">quit</span> or type <span class="ff26">control-d</span>).</div><div class="t m0 x1c hd y63f ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>able <span class="fc5">3-1</span> pro<span class="_ _1"></span>vides a quick reference to the GDB comm<span class="_ _3"></span>ands we </div><div class="t m0 xc hd y640 ff22 fs7 fc3 sc0 ls1 ws1">introduced in this ch<span class="_ _3"></span>apter<span class="_ _6"></span>. As we learn new things<span class="_ _3"></span>, we’ll need to add to our </div><div class="t m0 xc hd y641 ff22 fs7 fc3 sc0 ls1 ws1">knowledge of <span class="ff26">gdb</span>. It is a po<span class="_ _3"></span>werful tool to help us develop our programs<span class="_ _1"></span>. </div><div class="t m0 xc hd y642 ff22 fs7 fc3 sc0 ls1 ws1">Assembly Language pr<span class="_ _3"></span>ograms ar<span class="_ _3"></span>e complex and subtle<span class="_ _3"></span>, and <span class="ff26">gdb</span> is great a<span class="_ _3"></span>t </div><div class="t m0 xc hd y643 ff22 fs7 fc3 sc0 ls1 ws1">showing us what is going on with all the bits and b<span class="_ _3"></span>ytes.</div><div class="t m0 xa h26 y644 ff28 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 3-1. <span class="_ _15"> </span><span class="ff23">Summary of useful GDB commands</span></div><div class="t m0 xa h10 y645 ff27 fs7 fc3 sc0 ls1 ws1">Command (Short Form)<span class="_ _23"> </span>Description</div><div class="t m0 xa h10 y646 ff2a fs7 fc3 sc0 ls1 ws1">break (b) line<span class="_ _24"> </span>Set breakpoint at line</div><div class="t m0 xa h10 y647 ff2a fs7 fc3 sc0 ls1 ws1">run (r)<span class="_ _25"> </span>Run the program</div><div class="t m0 xa h10 y648 ff2a fs7 fc3 sc0 ls1 ws1">step (s)<span class="_ _26"> </span>Single step program</div><div class="t m0 xa h10 y649 ff2a fs7 fc3 sc0 ls1 ws1">continue (c)<span class="_ _27"> </span>Continue running the program</div><div class="t m0 xa h10 y64a ff2a fs7 fc3 sc0 ls1 ws1">quit (q or control-d)<span class="_ _1c"> </span>Exit gdb</div><div class="t m0 xa h10 y64b ff2a fs7 fc3 sc0 ls1 ws1">control-c<span class="_ _28"> </span>Interrupt the running program</div><div class="t m0 x3e hd y64c ff22 fs7 fc3 sc0 ls1 ws1">(<span class="ff23">continued</span>)</div><div class="t m0 x3d h12 y484 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf58" data-dest-detail='[88,"XYZ",63,260,null]'><div class="d m1" style="border-style:none;position:absolute;left:99.730600px;bottom:337.362000px;width:15.048400px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf59" class="pf w2 h6" data-page-no="59"><div class="pc pc59 w2 h6"><img class="bi x11 y64d wd h2f" alt="" src="bg59.png"/><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">70</div><div class="t m0 xc hd y64e ff22 fs7 fc3 sc0 ls1 ws1">It’<span class="_ _6"></span>s worthwhile single stepping thr<span class="_ _3"></span>ough our thr<span class="_ _3"></span>ee sample progr<span class="_ _3"></span>ams and </div><div class="t m0 xd hd y64f ff22 fs7 fc3 sc0 ls1 ws1">examining the registers a<span class="_ _3"></span>t each step to ensur<span class="_ _3"></span>e you understand wha<span class="_ _3"></span>t each </div><div class="t m0 xd hd y650 ff22 fs7 fc3 sc0 ls1 ws1">instruction is doing.</div><div class="t m0 xc hd y651 ff22 fs7 fc3 sc0 ls1 ws1">Even if y<span class="_ _3"></span>ou don’t know of a bug, m<span class="_ _3"></span>any progr<span class="_ _1"></span>ammers like to single step </div><div class="t m0 xd hd y652 ff22 fs7 fc3 sc0 ls1 ws1">through their code to look for pr<span class="_ _1"></span>oblems and to convince themselves that </div><div class="t m0 xd hd y653 ff22 fs7 fc3 sc0 ls1 ws1">their code is good. Often two programmers do this together as part of the </div><div class="t m0 xd hd y654 ff22 fs7 fc3 sc0 ls1 ws1">pair progr<span class="_ _3"></span>amming agile methodology.</div><div class="t m0 xd h15 y655 ff27 fsb fc3 sc0 ls1 wsaf"> Cross-Compiling</div><div class="t m0 xd hd y656 ff22 fs7 fc3 sc0 ls1 ws1">So far<span class="_ _6"></span>, we’v<span class="_ _3"></span>e been compiling and running our progr<span class="_ _3"></span>ams on an ARM<span class="_ _1"></span>-based </div><div class="t m0 xd hd y657 ff22 fs7 fc3 sc0 ls1 ws1">computer like the Raspberry Pi or NVidia Jetson N<span class="_ _1"></span>ano; however<span class="_ _6"></span>, we can </div><div class="t m0 xd hd y658 ff22 fs7 fc3 sc0 ls1 ws1">also compile and run our programs on an I<span class="_ _1"></span>ntel-based computer<span class="_ _6"></span>. In this </div><div class="t m0 xd hd y659 ff22 fs7 fc3 sc0 ls1 ws1">section, we’ll see how to compile and run the Hello W<span class="_ _1"></span>orld progr<span class="_ _3"></span>am from </div><div class="t m0 xd hd y65a ff22 fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>G<span class="_ _0"></span>ettin<span class="_ _3"></span>g Started,<span class="_ _8"></span>” on Ubuntu Linux running on an In<span class="_ _3"></span>tel-based </div><div class="t m0 xd hd y65b ff22 fs7 fc3 sc0 ls8 ws9f">laptop<span class="_ _1"></span>.</div><div class="t m0 xc hd y65c ff22 fs7 fc3 sc0 ls1 ws1">The GNU Assembler and the Linux linker/loader ar<span class="_ _3"></span>e both open source </div><div class="t m0 xd hd y65d ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams and can be compiled to run on any system. T<span class="_ _3"></span>he GNU Assembler </div><div class="t m0 xd hd y65e ff22 fs7 fc3 sc0 ls1 ws1">source code contains s<span class="_ _3"></span>upport for many CPU architectur<span class="_ _1"></span>es, and the code </div><div class="t m0 xd hd y65f ff22 fs7 fc3 sc0 ls1 ws1">it is written in compiles on all sorts of systems. Ubun<span class="_ _3"></span>tu Linux on Int<span class="_ _3"></span>el </div><div class="t m0 xd hd y660 ff22 fs7 fc3 sc0 ls1 ws1">comes with all the GNU tools installed, but they compile Intel Assembly </div><div class="t m0 xd hd y661 ff22 fs7 fc3 sc0 ls1 ws1">Language code instead of ARM.I<span class="_ _3"></span>t would be nice if the GNU Assembler had </div><div class="t m0 x11 h10 y662 ff27 fs7 fc3 sc0 ls1 ws1">Command (Short Form)<span class="_ _23"> </span>Description</div><div class="t m0 x11 h10 y663 ff2a fs7 fc3 sc0 ls1 ws1">info registers (i r)<span class="_ _29"> </span>Print out the registers</div><div class="t m0 x11 h10 y664 ff2a fs7 fc3 sc0 ls1 ws1">info break<span class="_ _2a"> </span>Print out the breakpoints</div><div class="t m0 x11 h10 y665 ff2a fs7 fc3 sc0 ls1 ws1">delete n<span class="_ _2b"> </span>Delete breakpoint n</div><div class="t m0 x11 h10 y666 ff2a fs7 fc3 sc0 ls1 ws1">x /Nuf expression<span class="_ _2c"> </span>Show contents of memor<span class="_ _0"></span>y</div><div class="t m0 x11 h20 y667 ff28 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 3-1. <span class="_ _15"> </span><span class="ff22">(<span class="ff23">continued</span>)</span></div><div class="t m0 xd h12 y668 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:76.259700px;bottom:195.141000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf5a" class="pf w2 h6" data-page-no="5a"><div class="pc pc5a w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">71</div><div class="t m0 xc hd y145 ff22 fs7 fc3 sc0 ls1 ws1">a command line switch to tell it to compile ARM code<span class="_ _3"></span>, but that isn’t ho<span class="_ _3"></span>w it </div><div class="t m0 xc hd y146 ff22 fs7 fc3 sc0 ls1 ws1">works<span class="_ _3"></span>. Y<span class="_ _6"></span>ou need to spe<span class="_ _0"></span>cify the type of Assembly code to pr<span class="_ _3"></span>ocess at compile </div><div class="t m0 xc hd y147 ff22 fs7 fc3 sc0 ls1 ws1">time.</div><div class="t m0 x1c hd y1b0 ff22 fs7 fc3 sc0 ls1 ws1">The solution is to obtain all the necessary GNU and L<span class="_ _0"></span>inux tools to </div><div class="t m0 xc hd y1b1 ff22 fs7 fc3 sc0 ls1 ws1">compile for ARM, but run on Intel and then install them in a differ<span class="_ _1"></span>ent </div><div class="t m0 xc hd y218 ff22 fs7 fc3 sc0 ls1 ws1">location. W<span class="_ _1"></span>e can add them to our Ubuntu Lin<span class="_ _3"></span>ux with the command</div><div class="t m0 xc h18 y230 ff29 fs7 fc3 sc0 lsd ws1">sud<span class="_ _0"></span>o apt<span class="_ _0"></span>-get install gcc-aarch64-linux-gnu g++-aarch64-linux- <span class="_ _20"></span>gnu</div><div class="t m0 x1c hd y231 ff22 fs7 fc3 sc0 ls1 ws1">This will install them to /usr/aarc<span class="_ _3"></span>h64-linux<span class="_ _1"></span>-gnu/bin. W<span class="_ _1"></span>e don’t want </div><div class="t m0 xc hd y232 ff22 fs7 fc3 sc0 ls1 ws1">to add this to our P<span class="_ _6"></span>A<span class="_ _1"></span>TH variable because we won’t know whether the In<span class="_ _3"></span>tel </div><div class="t m0 xc hd y233 ff22 fs7 fc3 sc0 ls1 ws1">or ARM version will be run. Instead we add this path in our makefile<span class="_ _1"></span>. O<span class="_ _0"></span>ne </div><div class="t m0 xc hd y2e5 ff22 fs7 fc3 sc0 ls1 ws1">way to do this is in Listing <span class="fc5">3-5</span>.</div><div class="t m0 xc h20 y669 ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-5. <span class="_ _15"> </span><span class="ff22">Mak<span class="_ _3"></span>efile to build Hello W<span class="_ _6"></span>orld on an Intel CPU</span></div><div class="t m0 xc h18 y66a ff29 fs7 fc3 sc0 ls1 ws1">TOOLPATH = /usr/aarch64-linux-gnu/bin</div><div class="t m0 xc h18 y66b ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld: HelloWorld.o</div><div class="t m0 xc h18 y66c ff29 fs7 fc3 sc0 ls1 ws1">     $(TOOLPATH)/ld -o HelloWorld HelloWorld.o</div><div class="t m0 xc h18 y66d ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld.o: HelloWorld.s</div><div class="t m0 xc h18 y66e ff29 fs7 fc3 sc0 ls1 ws1">     $(TOOLPATH)/as -o HelloWorld.o HelloWorld.s</div><div class="t m0 x1c hd y66f ff22 fs7 fc3 sc0 ls1 ws1">If we then run this, we see</div><div class="t m0 xc h18 y670 ff29 fs7 fc3 sc0 ls1 ws1">stephen@stephenubuntu:~/asm64/Chapter 3$ make</div><div class="t m0 xc h18 y671 ff29 fs7 fc3 sc0 ls1 ws1">/usr/aarch64-linux-gnu/bin/as -o HelloWorld.o HelloWorld.s</div><div class="t m0 xc h18 y672 ff29 fs7 fc3 sc0 ls1 ws1">/usr/aarch64-linux-gnu/bin/ld -o HelloWorld HelloWorld.o</div><div class="t m0 x1c hd y673 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve no<span class="_ _3"></span>w built our H<span class="_ _3"></span>ello W<span class="_ _1"></span>orld program for ARM on an In<span class="_ _3"></span>tel </div><div class="t m0 xc hd y674 ff22 fs7 fc3 sc0 ls1 ws1">CPU<span class="_ _1"></span>.This is called cross-compilin<span class="_ _3"></span>g. This is most used when progr<span class="_ _3"></span>amming </div><div class="t m0 xc hd y675 ff22 fs7 fc3 sc0 ls1 ws1">embedded ARM processors tha<span class="_ _3"></span>t don’t run a full Linux kernel and hence </div><div class="t m0 xc hd y676 ff22 fs7 fc3 sc0 ls1 ws1">don’t ha<span class="_ _3"></span>ve all the development tools a<span class="_ _1"></span>vailable. The workflow is to </div><div class="t m0 xc hd y677 ff22 fs7 fc3 sc0 ls1 ws1">build the progr<span class="_ _3"></span>am on a full development system and then tr<span class="_ _1"></span>ansfer the </div><div class="t m0 xc hd y678 ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am to the target processor using a USB ca<span class="_ _3"></span>ble, serial cable<span class="_ _3"></span>, or via </div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf5a" data-dest-detail='[90,"XYZ",53,388,null]'><div class="d m1" style="border-style:none;position:absolute;left:175.966000px;bottom:401.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf5b" class="pf w2 h6" data-page-no="5b"><div class="pc pc5b w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">72</div><div class="t m0 xd hd y145 ff22 fs7 fc3 sc0 ls1 ws1">Ethernet. Y<span class="_ _6"></span>ou can copy the r<span class="_ _1"></span>esulting program to a Raspberry Pi or NVidia </div><div class="t m0 xd hd y146 ff22 fs7 fc3 sc0 ls1 ws1">Jetson computer to run it. E<span class="_ _1"></span>ven if your target platform supports all the </div><div class="t m0 xd hd y147 ff22 fs7 fc3 sc0 ls1 ws1">development tools<span class="_ _3"></span>, it can be faster to do your builds on a mor<span class="_ _1"></span>e power<span class="_ _0"></span>ful </div><div class="t m0 xd hd y1b0 ff22 fs7 fc3 sc0 ls1 ws1">laptop or desktop<span class="_ _1"></span>.</div><div class="t m0 xd ha y50e ff27 fs6 fc3 sc0 ls1 wsb1"> Emulation</div><div class="t m0 xd hd y235 ff22 fs7 fc3 sc0 ls1 ws1">Even if y<span class="_ _3"></span>ou don’t ha<span class="_ _1"></span>ve an ARM-based comp<span class="_ _3"></span>uter<span class="_ _6"></span>, you can still run most of </div><div class="t m0 xd hd y53b ff22 fs7 fc3 sc0 ls1 ws1">the progr<span class="_ _3"></span>ams in this book using an ARM CPU emulator<span class="_ _10"></span>. The emulator will </div><div class="t m0 xd hd y53c ff22 fs7 fc3 sc0 ls1 ws1">interpr<span class="_ _3"></span>et the ARM machine code and simulate it usin<span class="_ _3"></span>g the local processor<span class="_ _10"></span>. </div><div class="t m0 xd hd y53d ff22 fs7 fc3 sc0 ls1 ws1">Again, we are usin<span class="_ _3"></span>g Ubuntu Linux running on an In<span class="_ _3"></span>tel CPU<span class="_ _1"></span>.There ar<span class="_ _1"></span>e </div><div class="t m0 xd hd y679 ff22 fs7 fc3 sc0 ls1 ws1">quite a few differen<span class="_ _3"></span>t emulators a<span class="_ _1"></span>vailable; here we’ll walk thr<span class="_ _1"></span>ough setting </div><div class="t m0 xd hd y67a ff22 fs7 fc3 sc0 ls1 ws1">up and using the QEMU emulator<span class="_ _10"></span>. T<span class="_ _6"></span>o install it, type</div><div class="t m0 xd h18 y540 ff29 fs7 fc3 sc0 ls1 ws1">sudo apt-get install qemu qemu-user</div><div class="t m0 xc hd y541 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can now execute the Hello W<span class="_ _1"></span>orld progr<span class="_ _3"></span>am we compiled in the </div><div class="t m0 xd hd y67b ff22 fs7 fc3 sc0 ls1 ws1">previous section:</div><div class="t m0 xd h18 y67c ff29 fs7 fc3 sc0 ls1 ws1">stephen@stephenubuntu:~/asm64/Chapter 3$ qemu-aarch64 </div><div class="t m0 xd h18 y67d ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld</div><div class="t m0 xd h18 y67e ff29 fs7 fc3 sc0 ls1 ws1">Hello World!</div><div class="t m0 xc hd y67f ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e have no<span class="_ _3"></span>w successfully compiled and run our ARM 64-bit Assembly </div><div class="t m0 xd hd y680 ff22 fs7 fc3 sc0 ls1 ws1">Language pr<span class="_ _3"></span>ogram on an In<span class="_ _3"></span>tel PC.</div><div class="t m0 xd h15 y3f9 ff27 fsb fc3 sc0 ls1 wsaf"> Android <span class="_ _11"> </span>NDK</div><div class="t m0 xd hd y681 ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o run our HelloW<span class="_ _1"></span>orld program fr<span class="_ _3"></span>om Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>Getting Started,<span class="_ _8"></span>” is </div><div class="t m0 xd hd y682 ff22 fs7 fc3 sc0 ls1 ws1">surprisingly easy. This is because Andr<span class="_ _3"></span>oid is based on Linux, and as time </div><div class="t m0 xd hd y683 ff22 fs7 fc3 sc0 ls1 ws1">has gone by, Google has mov<span class="_ _3"></span>ed Android closer and closer to standar<span class="_ _3"></span>d </div><div class="t m0 xd hd y684 ff22 fs7 fc3 sc0 ls1 ws1">Linux. The main thing we need to do is install the official tools, compile </div><div class="t m0 xd hd y685 ff22 fs7 fc3 sc0 ls1 ws1">our progr<span class="_ _3"></span>am, and cop<span class="_ _3"></span>y it over to an Andr<span class="_ _1"></span>oid device to r<span class="_ _0"></span>un. Y<span class="_ _6"></span>ou can’t </div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:251.784000px;bottom:153.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf5c" class="pf w2 h6" data-page-no="5c"><div class="pc pc5c w2 h6"><img class="bi xc y686 w7 h30" alt="" src="bg5c.png"/><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">73</div><div class="t m0 xc hd y38c ff22 fs7 fc3 sc0 ls1 ws1">develop for Android on an ARM<span class="_ _1"></span>-based system like a Raspberry Pi or an </div><div class="t m0 xc hd y38d ff22 fs7 fc3 sc0 ls1 ws1">Android-based laptop; yo<span class="_ _3"></span>u must develop on an In<span class="_ _3"></span>tel system under either </div><div class="t m0 xc hd y4ae ff22 fs7 fc3 sc0 ls1 ws1">Linux, MacOS<span class="_ _3"></span>, or Windows<span class="_ _1"></span>.</div><div class="t m0 x36 h1f y687 ff27 fse fc3 sc0 ls1 ws1">Note<span class="ff2a"> <span class="_ _19"> </span>Not all <span class="_ _1"></span>Android devices are based on <span class="_ _1"></span>ARM CPUs.<span class="_ _3"></span> Ensure  </span></div><div class="t m0 x36 h1f y688 ff2a fse fc3 sc0 ls1 ws1">your <span class="_ _1"></span>Android device contains an <span class="_ _1"></span>ARM CPU and tha<span class="_ _0"></span>t you are running  </div><div class="t m0 x36 h1f y689 ff2a fse fc3 sc0 ls1 ws1">a 64- <span class="_ _2d"></span>bit version of <span class="_ _1"></span>Android.</div><div class="t m0 x1c hd y68a ff22 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou must install Android St<span class="_ _3"></span>udio<span class="_ _1"></span>, the Integrated Development </div><div class="t m0 xc hd y68b ff22 fs7 fc3 sc0 ls1 ws1">Envir<span class="_ _1"></span>onment for Android development. Once you ha<span class="_ _1"></span>ve this installed, </div><div class="t m0 xc hd y68c ff22 fs7 fc3 sc0 ls1 ws1">you need to install the NDK; this is the N<span class="_ _1"></span>ative Code Development Kit for </div><div class="t m0 xc hd y68d ff22 fs7 fc3 sc0 ls1 ws1">Android. Andr<span class="_ _3"></span>oid Studio b<span class="_ _3"></span>y default cr<span class="_ _3"></span>eates applica<span class="_ _3"></span>tions that can run on </div><div class="t m0 xc hd y68e ff22 fs7 fc3 sc0 ls1 ws1">any Android device<span class="_ _1"></span>, no matter what type of CPU they contain. With the </div><div class="t m0 xc hd y68f ff22 fs7 fc3 sc0 ls1 ws1">NDK<span class="_ _0"></span>, you c<span class="_ _3"></span>an write processor<span class="_ _1"></span>-specific code like the Assembly Lan<span class="_ _3"></span>guage </div><div class="t m0 xc hd y690 ff22 fs7 fc3 sc0 ls1 ws1">we want to run. T<span class="_ _6"></span>o install the NDK<span class="_ _0"></span>, go to the “<span class="_ _3"></span>Settings<span class="_ _1"></span>” menu in Android </div><div class="t m0 xc hd y691 ff22 fs7 fc3 sc0 ls1 ws1">Studio<span class="_ _1"></span>, select “System Settin<span class="_ _3"></span>gs,<span class="_ _8"></span>” and select the NDK as shown in Fi<span class="_ _3"></span>gure<span class="fc5">3-1</span>.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf5d" data-dest-detail='[93,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:385.492000px;bottom:327.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf5d" class="pf w2 h6" data-page-no="5d"><div class="pc pc5d w2 h6"><img class="bi x2 y692 w6 h31" alt="" src="bg5d.png"/><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">74</div><div class="t m0 xc hd y693 ff22 fs7 fc3 sc0 ls1 ws1">The NDK installs special Android ver<span class="_ _3"></span>sions of the GNU Assembler and </div><div class="t m0 xd hd y694 ff22 fs7 fc3 sc0 ls1 ws1">the Linux linker/loader<span class="_ _10"></span>. O<span class="_ _0"></span>n my Ub<span class="_ _3"></span>untu Linux laptop<span class="_ _1"></span>, these were installed </div><div class="t m0 xd hd y695 ff22 fs7 fc3 sc0 ls8 ws9f">to</div><div class="t m0 xd h18 y696 ff29 fs7 fc3 sc0 ls1 ws1">/home/stephen/Android/Sdk/ndk/20.1.5948944/toolchains/aarch64- </div><div class="t m0 xd h18 y697 ff29 fs7 fc3 sc0 ls1 wsab">linux- android-4.9/prebuilt/linux-x86_64/bin</div><div class="t m0 xc hd y698 ff22 fs7 fc3 sc0 ls1 ws1">As you can see, these will mo<span class="_ _3"></span>ve as the NDK or Android is upda<span class="_ _3"></span>ted to </div><div class="t m0 xd hd y699 ff22 fs7 fc3 sc0 ls1 ws1">new version. This is like wha<span class="_ _3"></span>t we did when cross-com<span class="_ _3"></span>piling; only the tools </div><div class="t m0 xd hd y69a ff22 fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve separate n<span class="_ _3"></span>ames, n<span class="_ _3"></span>amely, <span class="ff26">aarch64-linux<span class="_ _1"></span>-android-as<span class="ff22"> and </span>aarch64- </span></div><div class="t m0 xd hd y69b ff26 fs7 fc3 sc0 ls1 ws57">linux<span class="_ _1"></span>- android-ld<span class="ff22 ws1">. Since the commands ha<span class="_ _1"></span>ve unique names, we can </span></div><div class="t m0 xd hd y69c ff22 fs7 fc3 sc0 ls1 ws1">add the preceding path to o<span class="_ _3"></span>ur system P<span class="_ _6"></span>A<span class="_ _1"></span>TH in our .bashr<span class="_ _3"></span>c file without </div><div class="t m0 xd hd y69d ff22 fs7 fc3 sc0 ls1 ws1">conflicting with our system<span class="_ _1"></span>’<span class="_ _6"></span>s default applications<span class="_ _1"></span>.</div><div class="t m0 xc hd y69e ff22 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">3-6</span> shows how to cr<span class="_ _1"></span>eate a makefile to add an option to build </div><div class="t m0 xd hd y69f ff22 fs7 fc3 sc0 ls1 ws1">HelloW<span class="_ _1"></span>orld for Android.</div><div class="t m0 xd h26 y6a0 ff28 fs3 fc3 sc0 ls1 ws1">Figure 3-1. <span class="_ _15"> </span><span class="ff23">Andr<span class="_ _3"></span>oid Studio<span class="_ _1"></span>’<span class="_ _6"></span>s System Settings showing the NDK </span></div><div class="t m0 xd h26 y6a1 ff23 fs3 fc3 sc0 ls1 ws1">installed</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf5e" data-dest-detail='[94,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:98.232200px;width:15.047600px;height:12.275800px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf5e" class="pf w2 h6" data-page-no="5e"><div class="pc pc5e w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">75</div><div class="t m0 xc h20 y4c5 ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-6. <span class="_ _15"> </span><span class="ff22">Mak<span class="_ _3"></span>efile to build HelloW<span class="_ _6"></span>orld for Android</span></div><div class="t m0 xc h18 y4c6 ff29 fs7 fc3 sc0 ls1 ws1">ifdef ANDROID</div><div class="t m0 xc h18 y4c7 ff29 fs7 fc3 sc0 ls1 ws1">AS = aarch64-linux-android-as</div><div class="t m0 xc h18 y4c8 ff29 fs7 fc3 sc0 ls1 ws1">LD = aarch64-linux-android-ld</div><div class="t m0 xc h18 y4c9 ff29 fs7 fc3 sc0 ls1 ws1">else</div><div class="t m0 xc h18 y5de ff29 fs7 fc3 sc0 ls1 ws1">AS = as</div><div class="t m0 xc h18 y5df ff29 fs7 fc3 sc0 ls1 ws1">LD = ld</div><div class="t m0 xc h18 y6a2 ff29 fs7 fc3 sc0 ls1 ws1">endif</div><div class="t m0 xc h18 y4cd ff29 fs7 fc3 sc0 ls1 ws1">OBJS = HelloWorld.o</div><div class="t m0 xc h18 y5e0 ff29 fs7 fc3 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xc h18 y4cf ff29 fs7 fc3 sc0 ls1 ws1">     $(AS) $&lt; -o $@</div><div class="t m0 xc h18 y4d0 ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld: $(OBJS)</div><div class="t m0 xc h18 y55c ff29 fs7 fc3 sc0 ls1 ws1">     $(LD) -o HelloWorld $(OBJS)</div><div class="t m0 x1c hd y4d2 ff22 fs7 fc3 sc0 ls1 ws1">If we save this in m<span class="_ _3"></span>akefile2, then we need to run</div><div class="t m0 xc h18 y6a3 ff29 fs7 fc3 sc0 ls1 ws1">make -f makefile2 ANDROID=y</div><div class="t m0 x1c hd y6a4 ff22 fs7 fc3 sc0 ls1 ws1">to build our pr<span class="_ _3"></span>ogram for Andr<span class="_ _3"></span>oid.</div><div class="t m0 x1c hd y6a5 ff22 fs7 fc3 sc0 ls1f ws1">W<span class="_ _1"></span>e now hav<span class="_ _3"></span>e our HelloW<span class="_ _1"></span>orld progr<span class="_ _3"></span>am built for Android b<span class="_ _3"></span>ut sitting on </div><div class="t m0 xc hd y6a6 ff22 fs7 fc3 sc0 ls1f wsc2">our Intel-based laptop<span class="_ _1"></span>. How do we cop<span class="_ _3"></span>y it to our device and run it? Android </div><div class="t m0 xc hd y4d7 ff22 fs7 fc3 sc0 ls1f ws1">is a locked down version of Linux and expects people to only run progr<span class="_ _3"></span>ams </div><div class="t m0 xc hd y4d8 ff22 fs7 fc3 sc0 ls1f ws1">downloaded from the Google Play S<span class="_ _3"></span>tore<span class="_ _3"></span>. T<span class="_ _6"></span>o run our programs<span class="_ _1"></span>, we ne<span class="_ _0"></span>ed to </div><div class="t m0 xc hd y4d9 ff22 fs7 fc3 sc0 ls1f ws1">put the Android device in<span class="_ _3"></span>to developer mode. This is usually accom<span class="_ _3"></span>plished </div><div class="t m0 xc hd y4da ff22 fs7 fc3 sc0 ls1f ws1">by tapping on the b<span class="_ _3"></span>uild number in the settings menu m<span class="_ _3"></span>ultiple times. </div><div class="t m0 xc hd y6a7 ff22 fs7 fc3 sc0 ls1f ws1">Once the device is in developer mode, a developer menu will be added to </div><div class="t m0 xc hd y564 ff22 fs7 fc3 sc0 ls1f ws1">the settings menu; fr<span class="_ _3"></span>om here<span class="_ _1"></span>, w<span class="_ _0"></span>e need to enable USB debuggin<span class="_ _3"></span>g. I find it </div><div class="t m0 xc hd y565 ff22 fs7 fc3 sc0 ls1f ws1">convenient t<span class="_ _3"></span>o disable sleep mode while charging as well.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf5f" class="pf w2 h6" data-page-no="5f"><div class="pc pc5f w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">76</div><div class="t m0 xc hd y145 ff22 fs7 fc3 sc0 ls20 ws1">Next<span class="_ _3"></span>, we need to install the Android Debug Bridge (<span class="ff26 wsc3">adb</span>). W<span class="_ _1"></span>e do this with</div><div class="t m0 xd h18 y2e0 ff29 fs7 fc3 sc0 ls1 ws1">sudo apt-get install adb</div><div class="t m0 xc hd y3e9 ff22 fs7 fc3 sc0 ls1 ws1">With this all done and our Andr<span class="_ _1"></span>oid de<span class="_ _0"></span>vice connected to our laptop<span class="_ _1"></span>, we </div><div class="t m0 xd hd y496 ff22 fs7 fc3 sc0 ls1 ws1">can copy o<span class="_ _1"></span>ver the program and run it. T<span class="_ _6"></span>o copy the pr<span class="_ _3"></span>ogram, use</div><div class="t m0 xd h18 y497 ff29 fs7 fc3 sc0 ls1 ws1">adb push HelloWorld /data/local/tmp/HelloWorld</div><div class="t m0 xc hd y498 ff22 fs7 fc3 sc0 ls1 ws1">This copies HelloW<span class="_ _1"></span>orld to the indicated folder on the Andr<span class="_ _1"></span>oid de<span class="_ _0"></span>vice<span class="_ _1"></span>. </div><div class="t m0 xd hd y499 ff22 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we can use adb to open a remote command pr<span class="_ _1"></span>ompt to the Android </div><div class="t m0 xd hd y49a ff22 fs7 fc3 sc0 ls1 ws1">device, mak<span class="_ _3"></span>e the file executable<span class="_ _3"></span>, and run it<span class="_ _2"></span>:</div><div class="t m0 xd h18 y6a8 ff29 fs7 fc3 sc0 ls1 ws1">adb shell</div><div class="t m0 xd h18 y601 ff29 fs7 fc3 sc0 ls1 ws1">cd /data/local/tmp</div><div class="t m0 xd h18 y150 ff29 fs7 fc3 sc0 ls1 ws1">chmod +x HelloWorld</div><div class="t m0 xd h18 y6a9 ff29 fs7 fc3 sc0 ls1 ws1">./HelloWorld</div><div class="t m0 xc hd y603 ff22 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e is the whole build, copy, and run pr<span class="_ _3"></span>ocedure with the various </div><div class="t m0 xd hd y604 ff22 fs7 fc3 sc0 ls1 ws1">prompts and r<span class="_ _1"></span>esponses<span class="_ _0"></span>:</div><div class="t m0 xd h18 y6aa ff29 fs7 fc3 sc0 ls1 ws1">stephen@stephenubuntu:~/asm64/Chapter 3$ make -B -f makefile2 </div><div class="t m0 xd h18 y6ab ff29 fs7 fc3 sc0 ls1 ws1">ANDROID=y</div><div class="t m0 xd h18 y607 ff29 fs7 fc3 sc0 ls1 ws1">aarch64-linux-android-as HelloWorld.s -o HelloWorld.o</div><div class="t m0 xd h18 y6ac ff29 fs7 fc3 sc0 ls1 ws1">aarch64-linux-android-ld -o HelloWorld HelloWorld.o</div><div class="t m0 xd h18 y6ad ff29 fs7 fc3 sc0 ls1 ws1">stephen@stephenubuntu:~/asm64/Chapter 3$ adb push HelloWorld /</div><div class="t m0 xd h18 y6ae ff29 fs7 fc3 sc0 ls1 ws1">data/local/tmp/HelloWorld</div><div class="t m0 xd h18 y6af ff29 fs7 fc3 sc0 ls1 ws1">HelloWorld: 1 file pushed. 0.2 MB/s (1104 bytes in 0.007s)</div><div class="t m0 xd h18 y6b0 ff29 fs7 fc3 sc0 ls1 ws1">stephen@stephenubuntu:~/asm64/Chapter 3$ adb shell</div><div class="t m0 xd h18 y6b1 ff29 fs7 fc3 sc0 ls1 ws1">T7:/ $ cd /data/local/tmp</div><div class="t m0 xd h18 y6b2 ff29 fs7 fc3 sc0 ls1 ws1">T7:/data/local/tmp $ chmod +x HelloWorld</div><div class="t m0 xd h18 y6b3 ff29 fs7 fc3 sc0 ls1 ws1">T7:/data/local/tmp $ ./HelloWorld</div><div class="t m0 xd h18 y6b4 ff29 fs7 fc3 sc0 ls1 ws1">Hello World!</div><div class="t m0 xd h18 y6b5 ff29 fs7 fc3 sc0 ls1 ws1">T7:/data/local/tmp $ ^D</div><div class="t m0 xd h18 y6b6 ff29 fs7 fc3 sc0 ls1 ws1">stephen@stephenubuntu:~/asm64/Chapter 3$</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf60" class="pf w2 h6" data-page-no="60"><div class="pc pc60 w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">77</div><div class="t m0 x1c hd y145 ff22 fs7 fc3 sc0 ls1 ws1">This demonstra<span class="_ _3"></span>tes how learning Assembly Lang<span class="_ _3"></span>uage for Linux can </div><div class="t m0 xc hd y146 ff22 fs7 fc3 sc0 ls1 ws1">be directly lever<span class="_ _3"></span>aged to incorporate Assembly Lan<span class="_ _3"></span>guage into an Andr<span class="_ _3"></span>oid </div><div class="t m0 xc hd y147 ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am. Andr<span class="_ _3"></span>oid developers develop apps and not command line </div><div class="t m0 xc hd y1b0 ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams<span class="_ _0"></span>; in Chapter <span class="fc5">9</span>, “I<span class="_ _3"></span>nter<span class="_ _3"></span>acting with C and Python,<span class="_ _10"></span>” we<span class="_ _3"></span>’ll crea<span class="_ _3"></span>te </div><div class="t m0 xc hd y1b1 ff22 fs7 fc3 sc0 ls1 ws1">a true Android app and mak<span class="_ _3"></span>e an Assembly Language r<span class="_ _3"></span>outine do some </div><div class="t m0 xc hd y218 ff22 fs7 fc3 sc0 ls1 ws1">processing<span class="_ _3"></span>.</div><div class="t m0 xc h15 y6b7 ff27 fsb fc3 sc0 ls1 wsaf"> Apple <span class="_ _11"> </span>XCode</div><div class="t m0 xc hd y6b8 ff22 fs7 fc3 sc0 ls1 ws1">All up-to-date A<span class="_ _3"></span>pple iPhones and iP<span class="_ _1"></span>ads r<span class="_ _0"></span>un a 64-bit version of iOS and </div><div class="t m0 xc hd y6b9 ff22 fs7 fc3 sc0 ls1 ws1">utilize an ARM processor<span class="_ _10"></span>. All iOS apps are written in Objective-C or Swift<span class="_ _0"></span>; </div><div class="t m0 xc hd y6ba ff22 fs7 fc3 sc0 ls1 ws1">however<span class="_ _6"></span>, Apple<span class="_ _1"></span>’<span class="_ _1"></span>s XCode developmen<span class="_ _3"></span>t envir<span class="_ _3"></span>onment does ha<span class="_ _1"></span>ve support </div><div class="t m0 xc hd y6bb ff22 fs7 fc3 sc0 ls1 ws1">for incorporating Assem<span class="_ _3"></span>bly Language code. I<span class="_ _1"></span>n this s<span class="_ _0"></span>ection, we’ll look a<span class="_ _3"></span>t </div><div class="t m0 xc hd y6bc ff22 fs7 fc3 sc0 ls1 ws1">how to run our Hello W<span class="_ _1"></span>orld progr<span class="_ _1"></span>am from Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>G<span class="_ _0"></span>etting S<span class="_ _3"></span>tarted,<span class="_ _8"></span>” on </div><div class="t m0 xc hd y6bd ff22 fs7 fc3 sc0 ls1 ws1">either an iPhone or iP<span class="_ _1"></span>ad.</div><div class="t m0 x1c hd y6be ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o run the program in this section, you ar<span class="_ _3"></span>e requir<span class="_ _3"></span>ed to ha<span class="_ _3"></span>ve a M<span class="_ _3"></span>ac </div><div class="t m0 xc hd y6bf ff22 fs7 fc3 sc0 ls1 ws1">laptop or desktop running an up-to-da<span class="_ _3"></span>te version of M<span class="_ _3"></span>acOS<span class="_ _3"></span>.However<span class="_ _10"></span>, if </div><div class="t m0 xc hd y6c0 ff22 fs7 fc3 sc0 ls1 ws1">you ar<span class="_ _3"></span>en’t interes<span class="_ _3"></span>ted in developing for iOS<span class="_ _3"></span>, you can skip this section. Y<span class="_ _6"></span>ou </div><div class="t m0 xc hd y6c1 ff22 fs7 fc3 sc0 ls1 ws1">also will need an iPhone or iPad to run the pr<span class="_ _3"></span>ogram on.</div><div class="t m0 x1c hd y6c2 ff22 fs7 fc3 sc0 ls1 ws1">iOS is based on NeXTSTEP which is based on Berkeley Unix (BSD), not </div><div class="t m0 xc hd y6c3 ff22 fs7 fc3 sc0 ls1 ws1">Linux, so things w<span class="_ _0"></span>ill be differ<span class="_ _3"></span>ent than wh<span class="_ _3"></span>at we’<span class="_ _1"></span>ve seen s<span class="_ _0"></span>o far<span class="_ _10"></span>. However<span class="_ _6"></span>, iOS </div><div class="t m0 xc hd y6c4 ff22 fs7 fc3 sc0 ls1 ws1">does incorporate the POSIX Unix standard which Lin<span class="_ _3"></span>ux also supports. The </div><div class="t m0 xc hd y6c5 ff22 fs7 fc3 sc0 ls1 ws1">result is th<span class="_ _3"></span>at the changes r<span class="_ _1"></span>e<span class="_ _0"></span>quir<span class="_ _1"></span>e<span class="_ _0"></span>d to mak<span class="_ _3"></span>e our Hello W<span class="_ _1"></span>orld progr<span class="_ _1"></span>am w<span class="_ _0"></span>ork </div><div class="t m0 xc hd y6c6 ff22 fs7 fc3 sc0 ls1 ws1">on an iOS device are surprisingly minor<span class="_ _10"></span>.</div><div class="t m0 x1c hd y6c7 ff22 fs7 fc3 sc0 ls1 ws1">iOS is a regulated en<span class="_ _1"></span>vironment, so we can’t just open a terminal </div><div class="t m0 xc hd y6c8 ff22 fs7 fc3 sc0 ls1 ws1">window and run our programs fr<span class="_ _1"></span>om the command line. W<span class="_ _1"></span>e need to create </div><div class="t m0 xc hd y6c9 ff22 fs7 fc3 sc0 ls1 ws1">an “<span class="_ _6"></span>official” iOS app<span class="_ _3"></span>, code sign it, and then download it fr<span class="_ _3"></span>om our M<span class="_ _3"></span>ac to </div><div class="t m0 xc hd y6ca ff22 fs7 fc3 sc0 ls1 ws1">our iOS device. W<span class="_ _1"></span>e’ll cr<span class="_ _3"></span>eate an empty Objective-C pr<span class="_ _3"></span>oject, add our Hello </div><div class="t m0 xc hd y6cb ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>orld file, and pass contr<span class="_ _3"></span>ol to our pr<span class="_ _3"></span>ogram.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:156.321000px;bottom:529.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:292.268000px;bottom:361.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf61" class="pf w2 h6" data-page-no="61"><div class="pc pc61 w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">78</div><div class="t m0 xc hd y145 ff22 fs7 fc3 sc0 ls1 ws1">Run X<span class="_ _1"></span>Code and create a new pr<span class="_ _3"></span>oject. Select Objective-C as the </div><div class="t m0 xd hd y146 ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming language and choose a single view app<span class="_ _1"></span>. XCode will go ahead </div><div class="t m0 xd hd y147 ff22 fs7 fc3 sc0 ls1 ws1">and crea<span class="_ _3"></span>te the source code for a simple empty a<span class="_ _3"></span>pp<span class="_ _1"></span>. Next, cr<span class="_ _3"></span>eate a file in the </div><div class="t m0 xd hd y1b0 ff22 fs7 fc3 sc0 ls1 ws1">project folder called H<span class="_ _3"></span>elloW<span class="_ _1"></span>orld.s containing the contents of Listing <span class="fc5">3-7</span>.</div><div class="t m0 xd h20 y6cc ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-7. <span class="_ _15"> </span><span class="ff22">Apple iOS H<span class="_ _3"></span>elloW<span class="_ _1"></span>orld.s</span></div><div class="t m0 xd h18 y6cd ff29 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y6ce ff29 fs7 fc3 sc0 ls1 ws1">// Assembler program to print &quot;Hello World!&quot;</div><div class="t m0 xd h18 y6cf ff29 fs7 fc3 sc0 ls1 ws1">// to stdout.</div><div class="t m0 xd h18 y6d0 ff29 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y6d1 ff29 fs7 fc3 sc0 ls1 ws1">// X0-X2 - parameters to iOS function services</div><div class="t m0 xd h18 y6d2 ff29 fs7 fc3 sc0 ls1 ws1">// X16 - iOS function number</div><div class="t m0 xd h18 y6d3 ff29 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y6d4 ff29 fs7 fc3 sc0 ls1 ws1">.global _start        // Provide program entry point</div><div class="t m0 xd h18 y6d5 ff29 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print hello world</div><div class="t m0 xd h18 y6d6 ff29 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y6d7 ff29 fs7 fc3 sc0 ls1 ws1">_start: mov     X0, #1      // 1 = StdOut</div><div class="t m0 xd h18 y6d8 ff29 fs7 fc3 sc0 ls1 ws1">     adr   X1, helloworld   // string to print</div><div class="t m0 xd h18 y6d9 ff29 fs7 fc3 sc0 ls1 ws1">     mov   X2, #13          // length of our string</div><div class="t m0 xd h18 y6da ff29 fs7 fc3 sc0 ls1 ws1">     mov   X16, #4          // iOS write system call</div><div class="t m0 xd h18 y6db ff29 fs7 fc3 sc0 ls1 ws1">     svc   #0x80            // Call iOS to output the string</div><div class="t m0 xd h18 y6dc ff29 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xd h18 y6dd ff29 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y6de ff29 fs7 fc3 sc0 ls1 ws1">     mov     X0, #0     // Use 0 return code</div><div class="t m0 xd h18 y6df ff29 fs7 fc3 sc0 ls1 ws1">     mov     X16, #1    // Service code 1 terminates</div><div class="t m0 xd h18 y6e0 ff29 fs7 fc3 sc0 ls1 ws1">     svc     #0x80      // Call iOS to terminate</div><div class="t m0 xd h18 y6e1 ff29 fs7 fc3 sc0 ls1 ws1">helloworld:      .ascii  &quot;Hello World!\n&quot;</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf61" data-dest-detail='[97,"XYZ",35,516,null]'><div class="d m1" style="border-style:none;position:absolute;left:353.874000px;bottom:529.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf62" class="pf w2 h6" data-page-no="62"><div class="pc pc62 w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">79</div><div class="t m0 x1c hd y145 ff22 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s examine the differences between the iOS and Linux versions of </div><div class="t m0 xc hd y146 ff22 fs7 fc3 sc0 ls1 ws1">Hello W<span class="_ _1"></span>orld:</div><div class="t m0 x1c hd y1fe ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>The operating sys<span class="_ _3"></span>tem function number is placed in </div><div class="t m0 x9 hd y148 ff22 fs7 fc3 sc0 ls1 ws1">register <span class="ff26">X16</span> r<span class="_ _3"></span>ather than <span class="ff26">X8</span>.</div><div class="t m0 x1c hd y6e2 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>iOS uses software interrupt 0x80 rather than 0 to </div><div class="t m0 x9 hd y28c ff22 fs7 fc3 sc0 ls1 ws1">make the opera<span class="_ _3"></span>ting system call.</div><div class="t m0 x1c hd y6e3 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>The function numbers ar<span class="_ _3"></span>e different<span class="_ _3"></span>. These are the </div><div class="t m0 x9 hd y28d ff22 fs7 fc3 sc0 ls1 ws1">same function numbers used in 32-bit Linux. When </div><div class="t m0 x9 hd y14d ff22 fs7 fc3 sc0 ls1 ws1">iOS went from 32 to 64 bits<span class="_ _1"></span>, Apple kept the operating </div><div class="t m0 x9 hd y14e ff22 fs7 fc3 sc0 ls1 ws1">system function numbers the same<span class="_ _1"></span>, whereas Linux </div><div class="t m0 x9 hd y264 ff22 fs7 fc3 sc0 ls1 ws1">rearran<span class="_ _3"></span>ged them completely.</div><div class="t m0 x1c hd y150 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>W<span class="_ _1"></span>e use “<span class="_ _1"></span>adr X1, helloworld” ra<span class="_ _3"></span>ther than “ldr </div><div class="t m0 x9 hd y6a9 ff22 fs7 fc3 sc0 ls1 ws1">X1,=helloworld” to load the addr<span class="_ _1"></span>ess of our string </div><div class="t m0 x9 hd y290 ff22 fs7 fc3 sc0 ls1 ws1">(also note we don’t have a .d<span class="_ _3"></span>ata section). W<span class="_ _1"></span>e’ll </div><div class="t m0 x9 hd y291 ff22 fs7 fc3 sc0 ls1 ws1">discuss the difference between these in Chapter <span class="fc5">5</span>, </div><div class="t m0 x9 hd y6e4 ff22 fs7 fc3 sc0 ls1 ws1">“Thanks for the Memories<span class="_ _3"></span>”; for now, it is just two </div><div class="t m0 x9 hd y6e5 ff22 fs7 fc3 sc0 ls1 ws1">different w<span class="_ _3"></span>ays to get the addr<span class="_ _3"></span>ess of our string loaded </div><div class="t m0 x9 hd y294 ff22 fs7 fc3 sc0 ls1 ws1">into r<span class="_ _3"></span>egister <span class="ff26">X1</span>. W<span class="_ _1"></span>e had to make this switch since </div><div class="t m0 x9 hd y295 ff22 fs7 fc3 sc0 ls1 ws1">iOS prohibits the pr<span class="_ _3"></span>evious method.</div><div class="t m0 x1c hd y158 ff22 fs7 fc3 sc0 ls1 ws1">Other<span class="_ _0"></span>wise, this sho<span class="_ _3"></span>uld all look very familiar<span class="_ _6"></span>.</div><div class="t m0 x1c hd y159 ff22 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we must cause this code to execute<span class="_ _3"></span>. iOS doesn’t run the _start </div><div class="t m0 xc hd y15a ff22 fs7 fc3 sc0 ls1 ws1">label; rather ther<span class="_ _1"></span>e is a more complicated fr<span class="_ _3"></span>amework to run things. T<span class="_ _3"></span>his is </div><div class="t m0 xc hd y15b ff22 fs7 fc3 sc0 ls1 ws1">why we crea<span class="_ _3"></span>ted a simple Objective-C progr<span class="_ _3"></span>am. T<span class="_ _10"></span>o execute our code, we </div><div class="t m0 xc hd y15c ff22 fs7 fc3 sc0 ls1 ws1">need to edit one of the Objective-C files, in our case ViewCon<span class="_ _3"></span>troller<span class="_ _10"></span>.m. </div><div class="t m0 xc hd y15d ff22 fs7 fc3 sc0 ls1 ws1">Near the beginning of the file<span class="_ _1"></span>, add</div><div class="t m0 xc h18 y6e6 ff29 fs7 fc3 sc0 ls1 ws1">extern void start( void );</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:326.015000px;bottom:329.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf63" class="pf w2 h6" data-page-no="63"><div class="pc pc63 w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">80</div><div class="t m0 xc hd y145 ff22 fs7 fc3 sc0 ls1 ws1">Then at the end of the viewDidLoad method, add</div><div class="t m0 xd h18 y2e0 ff29 fs7 fc3 sc0 ls1 ws1">start();</div><div class="t m0 xc hd y6e7 ff22 fs7 fc3 sc0 ls1 ws1">which should res<span class="_ _3"></span>ult in Listing <span class="fc5">3-8</span>.</div><div class="t m0 xd h20 y6cc ff28 fs3 fc3 sc0 ls1 ws1">Listing 3-8. <span class="_ _15"> </span><span class="ff22">ViewContr<span class="_ _1"></span>oller<span class="_ _6"></span>.m</span></div><div class="t m0 xd h18 y6cd ff29 fs7 fc3 sc0 ls1 ws1">#import &quot;ViewController.h&quot;</div><div class="t m0 xd h18 y6e8 ff29 fs7 fc3 sc0 ls1 ws1">extern void start( void );</div><div class="t m0 xd h18 y6e9 ff29 fs7 fc3 sc0 ls1 ws1">@interface ViewController ()</div><div class="t m0 xd h18 y6ea ff29 fs7 fc3 sc0 ls1 ws1">@end</div><div class="t m0 xd h18 y6eb ff29 fs7 fc3 sc0 ls1 ws1">@implementation ViewController</div><div class="t m0 xd h18 y6ec ff29 fs7 fc3 sc0 ls1 ws1">- (void)viewDidLoad {</div><div class="t m0 xd h18 y6ed ff29 fs7 fc3 sc0 ls1 ws1">    [super viewDidLoad];</div><div class="t m0 xd h18 y6ee ff29 fs7 fc3 sc0 ls1 ws1">   // Do any additional setup after loading the view.</div><div class="t m0 xd h18 y6ef ff29 fs7 fc3 sc0 ls1 ws1">    start();</div><div class="t m0 xd h18 y6f0 ff29 fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 xd h18 y6f1 ff29 fs7 fc3 sc0 ls1 ws1">@end</div><div class="t m0 xc hd y6f2 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e call start(), rather than _start(), because the Objective-C compiler </div><div class="t m0 xd hd y6f3 ff22 fs7 fc3 sc0 ls1 ws1">will “<span class="_ _1"></span>decora<span class="_ _3"></span>te” the function name addin<span class="_ _3"></span>g the “_”<span class="_ _18"></span>. No<span class="_ _3"></span>w we are r<span class="_ _3"></span>eady to run.</div><div class="t m0 xc hd y6f4 ff22 fs7 fc3 sc0 ls1 ws1">If we just select project build at this poin<span class="_ _3"></span>t, we will get a large number </div><div class="t m0 xd hd y6f5 ff22 fs7 fc3 sc0 ls1 ws1">of cryptic er<span class="_ _0"></span>r<span class="_ _3"></span>or messages from the As<span class="_ _3"></span>sembler<span class="_ _6"></span>. This is because by defa<span class="_ _3"></span>ult, </div><div class="t m0 xd hd y6f6 ff22 fs7 fc3 sc0 ls1 ws1">XCode will try to run our program in one of the iOS simula<span class="_ _3"></span>tors on the M<span class="_ _3"></span>ac. </div><div class="t m0 xd hd y6f7 ff22 fs7 fc3 sc0 ls1 ws1">Normally this is fine<span class="_ _1"></span>, but it won’t w<span class="_ _0"></span>or<span class="_ _3"></span>k for any app containing Assembl<span class="_ _3"></span>y </div><div class="t m0 xd hd y6f8 ff22 fs7 fc3 sc0 ls1 ws1">Language code. T<span class="_ _3"></span>his is because the M<span class="_ _3"></span>ac uses an Intel pr<span class="_ _3"></span>ocessor<span class="_ _6"></span>, and to </div><div class="t m0 xd hd y6f9 ff22 fs7 fc3 sc0 ls1 ws1">compile for the simulator<span class="_ _10"></span>, XCode will try to interpret our H<span class="_ _3"></span>elloW<span class="_ _1"></span>orld.s file </div><div class="t m0 xd hd y6fa ff22 fs7 fc3 sc0 ls1 ws1">as Intel Assembly lan<span class="_ _3"></span>guage, which it is<span class="_ _3"></span>n’t.</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf63" data-dest-detail='[99,"XYZ",35,516,null]'><div class="d m1" style="border-style:none;position:absolute;left:194.094000px;bottom:529.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf64" class="pf w2 h6" data-page-no="64"><div class="pc pc64 w2 h6"><img class="bi xc y6fb w7 h32" alt="" src="bg64.png"/><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">81</div><div class="t m0 x1c hd y3ce ff22 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o compile and run our program<span class="_ _3"></span>, we need to physically connect our </div><div class="t m0 xc hd y3cf ff22 fs7 fc3 sc0 ls1 ws1">iP<span class="_ _3"></span>ad or iPhone to our M<span class="_ _1"></span>ac using a USB cable. With this done<span class="_ _3"></span>, we can select </div><div class="t m0 xc hd y3d0 ff22 fs7 fc3 sc0 ls1 ws1">the iOS device as our destination. Once we do that<span class="_ _3"></span>, then we can compile </div><div class="t m0 xc hd y3d1 ff22 fs7 fc3 sc0 ls1 ws1">the progr<span class="_ _3"></span>am. When we run it, it will download to the iPhone or iP<span class="_ _1"></span>ad and </div><div class="t m0 xc hd y3d2 ff22 fs7 fc3 sc0 ls1 ws1">our Hello W<span class="_ _1"></span>orld progr<span class="_ _3"></span>am will appear in the output window in X<span class="_ _3"></span>Code as </div><div class="t m0 xc hd y3d3 ff22 fs7 fc3 sc0 ls1 ws1">shown in Fig<span class="_ _3"></span>ure<span class="fc5">3-2</span>.</div><div class="t m0 x1c hd y6fc ff22 fs7 fc3 sc0 ls1 ws1">I left out any steps to initialize yo<span class="_ _3"></span>ur device or set up your developer id </div><div class="t m0 xc hd y6fd ff22 fs7 fc3 sc0 ls1 ws1">with Apple. T<span class="_ _3"></span>hese are all necessary, but if you are doin<span class="_ _3"></span>g iOS development, </div><div class="t m0 xc hd y6fe ff22 fs7 fc3 sc0 ls1 ws1">these should already h<span class="_ _3"></span>ave been completed.</div><div class="t m0 x36 h1f y6ff ff27 fse fc3 sc0 ls1 ws1">Note<span class="ff2a"> <span class="_ _19"> </span>Be careful with <span class="_ _1"></span>Assembly Language programming on iOS as if </span></div><div class="t m0 x36 h1f y700 ff2a fse fc3 sc0 ls1 ws1">you do something that <span class="_ _1"></span>A<span class="_ _0"></span>pple doesn’t like,<span class="_ _1"></span> they will remove you from </div><div class="t m0 x36 h1f y701 ff2a fse fc3 sc0 ls1 wsc4">the App <span class="_ _0"></span>Store.</div><div class="t m0 xc h26 y702 ff28 fs3 fc3 sc0 ls1 ws1">Figure 3-2. <span class="_ _15"> </span><span class="ff23">XCode after running our pr<span class="_ _3"></span>ogram</span></div><div class="t m0 x3d h12 y3e8 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf64" data-dest-detail='[100,"XYZ",53,483,null]'><div class="d m1" style="border-style:none;position:absolute;left:131.197000px;bottom:497.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf65" class="pf w2 h6" data-page-no="65"><div class="pc pc65 w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">82</div><div class="t m0 xc hd y145 ff22 fs7 fc3 sc0 ls1 ws1">This section was just to give you an ide<span class="_ _3"></span>a of how to add Assembly </div><div class="t m0 xd hd y146 ff22 fs7 fc3 sc0 ls1 ws1">Language to an iOS app<span class="_ _1"></span>. It isn’t a r<span class="_ _3"></span>ealistic example<span class="_ _3"></span>, especially since it </div><div class="t m0 xd hd y147 ff22 fs7 fc3 sc0 ls1 ws1">terminates the pr<span class="_ _3"></span>ogram. T<span class="_ _1"></span>ypically, you write Assembly Language to </div><div class="t m0 xd hd y1b0 ff22 fs7 fc3 sc0 ls1 ws1">implement fast functions called fr<span class="_ _1"></span>om the high-level language. W<span class="_ _1"></span>e’ll cov<span class="_ _3"></span>er </div><div class="t m0 xd hd y1b1 ff22 fs7 fc3 sc0 ls1 ws1">how to implement functions<span class="_ _1"></span>, including taking parameters and ret<span class="_ _3"></span>urning </div><div class="t m0 xd hd y218 ff22 fs7 fc3 sc0 ls1 ws1">values in Chapter <span class="fc5">9</span>, “I<span class="_ _3"></span>nteractin<span class="_ _3"></span>g with C and Python.<span class="_ _10"></span>”</div><div class="t m0 xd h15 y703 ff27 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Source Control andBuild Ser<span class="_ _0"></span>vers</div><div class="t m0 xd hd y704 ff22 fs7 fc3 sc0 ls1 ws1">Although make is fine for our p<span class="_ _3"></span>urposes in this book, there are m<span class="_ _3"></span>uch </div><div class="t m0 xd hd y705 ff22 fs7 fc3 sc0 ls1 ws1">more sophistica<span class="_ _3"></span>ted build systems<span class="_ _3"></span>. As your pr<span class="_ _3"></span>ograms get larger<span class="_ _10"></span>, managing </div><div class="t m0 xd hd y706 ff22 fs7 fc3 sc0 ls1 ws1">changes and versions becomes mor<span class="_ _3"></span>e challenging; to help with this<span class="_ _3"></span>, there </div><div class="t m0 xd hd y707 ff22 fs7 fc3 sc0 ls1 ws1">are version con<span class="_ _3"></span>trol syst<span class="_ _3"></span>ems like Git. The sour<span class="_ _1"></span>ce co<span class="_ _0"></span>de for this book is hosted </div><div class="t m0 xd hd y708 ff22 fs7 fc3 sc0 ls1 ws1">on a cloud version of Git, c<span class="_ _3"></span>alled GitH<span class="_ _3"></span>ub<span class="_ _1"></span>. Y<span class="_ _1"></span>ou can get a link to this book’<span class="_ _6"></span>s </div><div class="t m0 xd hd y709 ff22 fs7 fc3 sc0 ls1 ws1">source code fr<span class="_ _3"></span>om this book’<span class="_ _1"></span>s web page on <span class="fc5">A<span class="_ _3"></span>press<span class="_ _1"></span>.com<span class="fc3">.</span></span></div><div class="t m0 xd ha y70a ff27 fs6 fc3 sc0 ls1 wsb1"> Git</div><div class="t m0 xd hd y70b ff22 fs7 fc3 sc0 ls1 ws1">As your pr<span class="_ _3"></span>ogram gets larger<span class="_ _10"></span>, consider using a source contr<span class="_ _3"></span>ol system to </div><div class="t m0 xd hd y70c ff22 fs7 fc3 sc0 ls1 ws1">manage sour<span class="_ _1"></span>ce files. Source contr<span class="_ _1"></span>ol systems keep all the versions of your </div><div class="t m0 xd hd y70d ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am. With sour<span class="_ _1"></span>ce control, it’<span class="_ _6"></span>s easy to retrieve the files that make up </div><div class="t m0 xd hd y70e ff22 fs7 fc3 sc0 ls1 ws1">version 1.15 of your pr<span class="_ _3"></span>ogram; you can have m<span class="_ _3"></span>ultiple branches<span class="_ _1"></span>, s<span class="_ _0"></span>o you </div><div class="t m0 xd hd y70f ff22 fs7 fc3 sc0 ls1 ws1">can work on both version 1.16 while also working on ver<span class="_ _3"></span>sion 2.1 and keep </div><div class="t m0 xd hd y710 ff22 fs7 fc3 sc0 ls1 ws1">everything straight.</div><div class="t m0 xc hd y711 ff22 fs7 fc3 sc0 ls1 ws1">Once you ha<span class="_ _3"></span>ve a team of progr<span class="_ _1"></span>ammers w<span class="_ _0"></span>ork<span class="_ _3"></span>ing on your pr<span class="_ _3"></span>oject, you </div><div class="t m0 xd hd y712 ff22 fs7 fc3 sc0 ls1 ws1">need to regulate who is editing wh<span class="_ _3"></span>at, so people don’t ov<span class="_ _3"></span>erwr<span class="_ _0"></span>ite each </div><div class="t m0 xd hd y713 ff22 fs7 fc3 sc0 ls1 ws1">other’<span class="_ _1"></span>s work. <span class="ff26">Git</span> takes this to a new level, where two people can edit the </div><div class="t m0 xd hd y714 ff22 fs7 fc3 sc0 ls1 ws1">same file; then Git can merge the chan<span class="_ _3"></span>ges to keep both people’<span class="_ _6"></span>s work. </div><div class="t m0 xd hd y715 ff22 fs7 fc3 sc0 ls1 ws1">Git is a grea<span class="_ _3"></span>t progr<span class="_ _3"></span>am for doing this. G<span class="_ _3"></span>it was developed by Linus T<span class="_ _10"></span>or<span class="_ _0"></span>valds </div><div class="t m0 xd hd y716 ff22 fs7 fc3 sc0 ls1 ws1">as the source contr<span class="_ _1"></span>ol system for all Linux development. Ther<span class="_ _3"></span>e are clo<span class="_ _3"></span>ud </div><div class="t m0 xd hd y717 ff22 fs7 fc3 sc0 ls1 ws1">versions, lik<span class="_ _3"></span>e GitH<span class="_ _1"></span>ub, tha<span class="_ _3"></span>t keep your files in the Cloud, and as a r<span class="_ _3"></span>esult, you </div><div class="t m0 xd hd y718 ff22 fs7 fc3 sc0 ls1 ws1">don’t need to worr<span class="_ _0"></span>y about backing them up<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:120.039000px;bottom:497.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="http://apress.com"><div class="d m1" style="border-style:none;position:absolute;left:232.699000px;bottom:351.362000px;width:54.494000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf66" class="pf w2 h6" data-page-no="66"><div class="pc pc66 w2 h6"><img class="bi xc y719 w7 h33" alt="" src="bg66.png"/><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">83</div><div class="t m0 x36 h1f y71a ff27 fse fc3 sc0 ls1 ws1">Note<span class="ff2a"> <span class="_ _17"> </span>The SD Cards,<span class="_ _1"></span> the Raspberr<span class="_ _0"></span>y Pi,<span class="_ _1"></span> and NVidia Jetson use </span></div><div class="t m0 x36 h1f y71b ff2a fse fc3 sc0 ls1 ws1">instead of hard drives or SSDs are not as reliable.<span class="_ _1"></span> <span class="_ _1"></span>They can fail,<span class="_ _3"></span> so </div><div class="t m0 x36 h1f y71c ff2a fse fc3 sc0 ls1 ws1">you should always ha<span class="_ _0"></span>ve a backup of your work.<span class="_ _1"></span> If you don’t back </div><div class="t m0 x36 h1f y71d ff2a fse fc3 sc0 ls1 ws1">up to the Cloud with a service like GitHub,<span class="_ _3"></span> back up with one of the </div><div class="t m0 x36 h1f y71e ff2a fse fc3 sc0 ls1 ws1">following:</div><div class="t m0 x1e h1f y71f ff2a fse fc3 sc0 ls1 ws1">• <span class="_ _16"> </span>Copy your files to Google Drive.</div><div class="t m0 x1e h1f y720 ff2a fse fc3 sc0 ls1 ws1">• <span class="_ _16"> </span>E-mail your files to yourself.</div><div class="t m0 x1e h1f y721 ff2a fse fc3 sc0 ls1 ws1">• <span class="_ _16"> </span>Copy them to a USB hard drive.<span class="_ _6"></span> </div><div class="t m0 x36 h1f y722 ff2a fse fc3 sc0 ls1 ws1">Don’t trust the SD Card,<span class="_ _1"></span> as it will fail at some point.</div><div class="t m0 x1c hd y723 ff22 fs7 fc3 sc0 ls1 ws1">Git is a sophisticated system beyond the scope of this book, but worth </div><div class="t m0 xc hd y724 ff22 fs7 fc3 sc0 ls1 ws1">checking out.</div><div class="t m0 xc ha y725 ff27 fs6 fc3 sc0 ls1 wsb1"> Jenkins</div><div class="t m0 xc hd y726 ff22 fs7 fc3 sc0 ls1 ws1">Once you are using GNU M<span class="_ _1"></span>ake and Git, you might consider checkin<span class="_ _3"></span>g out </div><div class="t m0 xc hd y727 ff26 fs7 fc3 sc0 ls1 ws1">Jenk<span class="_ _1"></span>ins<span class="ff22">. Jenkins is a build ser<span class="_ _0"></span>ver th<span class="_ _3"></span>at monitors Git, and every time you </span></div><div class="t m0 xc hd y728 ff22 fs7 fc3 sc0 ls1 ws1">check in a new version of a pr<span class="_ _3"></span>ogram file<span class="_ _3"></span>, it kicks off a build. This is part of a </div><div class="t m0 xc hd y729 ff22 fs7 fc3 sc0 ls1 ws1">continuous developmen<span class="_ _3"></span>t system that c<span class="_ _3"></span>an even deploy yo<span class="_ _3"></span>ur progr<span class="_ _3"></span>am.</div><div class="t m0 x1c hd y72a ff22 fs7 fc3 sc0 ls1 ws1">This is especially helpful if you ha<span class="_ _1"></span>ve a team of programmers<span class="_ _1"></span>, where </div><div class="t m0 xc hd y72b ff22 fs7 fc3 sc0 ls1 ws1">the build takes a long time<span class="_ _3"></span>, or you need the res<span class="_ _3"></span>ult to automatic<span class="_ _3"></span>ally be </div><div class="t m0 xc hd y72c ff22 fs7 fc3 sc0 ls1 ws1">deployed, sa<span class="_ _3"></span>y, to a web ser<span class="_ _0"></span>ver<span class="_ _10"></span>.</div><div class="t m0 x1c hd y72d ff22 fs7 fc3 sc0 ls1 ws1">If you ha<span class="_ _1"></span>ve a set of automated tests, these ar<span class="_ _1"></span>e r<span class="_ _0"></span>un after each build. </div><div class="t m0 xc hd y72e ff22 fs7 fc3 sc0 ls1 ws1">Ha<span class="_ _1"></span>ving the automated tests run frequen<span class="_ _3"></span>tly helps you detect when your </div><div class="t m0 xc hd y72f ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am is broken. T<span class="_ _3"></span>he cost of fixing a bug tends to be proportional to the </div><div class="t m0 xc hd y730 ff22 fs7 fc3 sc0 ls1 ws1">time that the bug exists in the code<span class="_ _3"></span>, so finding and fixing bugs quickly is a </div><div class="t m0 xc hd y731 ff22 fs7 fc3 sc0 ls1 ws1">huge productivity g<span class="_ _3"></span>ain.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf67" class="pf w2 h6" data-page-no="67"><div class="pc pc67 w2 h6"><div class="t m0 xd hd y3f ff22 fs7 fc3 sc0 ls1 ws1">84</div><div class="t m0 xd h15 y186 ff27 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y187 ff22 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we introduced the GNU M<span class="_ _3"></span>ake progr<span class="_ _1"></span>am that we will us<span class="_ _0"></span>e to </div><div class="t m0 xd hd y188 ff22 fs7 fc3 sc0 ls1 ws1">build our pr<span class="_ _3"></span>ograms<span class="_ _3"></span>. This is a powerful tool used to handle all the rules for </div><div class="t m0 xd hd y2be ff22 fs7 fc3 sc0 ls1 ws1">the various compilers and linkers we need.</div><div class="t m0 xc hd y18a ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e then introduced the GNU Debugger that will allow us to </div><div class="t m0 xd hd y18b ff22 fs7 fc3 sc0 ls1 ws1">troubleshoot our pr<span class="_ _1"></span>ograms. Unfortuna<span class="_ _3"></span>tely, progr<span class="_ _3"></span>ams ha<span class="_ _3"></span>ve bugs and we </div><div class="t m0 xd hd y732 ff22 fs7 fc3 sc0 ls1 ws1">need a way to single step thr<span class="_ _1"></span>ough them and examine all the registers and </div><div class="t m0 xd hd y733 ff22 fs7 fc3 sc0 ls1 ws1">memory as w<span class="_ _0"></span>e do so<span class="_ _1"></span>. GDB is a technical tool, but it’<span class="_ _1"></span>s indispensable in </div><div class="t m0 xd hd y734 ff22 fs7 fc3 sc0 ls1 ws1">figuring out what o<span class="_ _3"></span>ur progr<span class="_ _3"></span>ams are doing<span class="_ _3"></span>.</div><div class="t m0 xc hd y735 ff22 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e covered ho<span class="_ _3"></span>w to cross-com<span class="_ _3"></span>pile our code on Intel-based comput<span class="_ _3"></span>ers </div><div class="t m0 xd hd y736 ff22 fs7 fc3 sc0 ls1 ws1">and how to run our ARM progr<span class="_ _1"></span>ams in an emulator<span class="_ _6"></span>. W<span class="_ _1"></span>e then covered </div><div class="t m0 xd hd y737 ff22 fs7 fc3 sc0 ls1 ws1">how to set up an Android developmen<span class="_ _3"></span>t envir<span class="_ _1"></span>onment for Assembler </div><div class="t m0 xd hd y192 ff22 fs7 fc3 sc0 ls1 ws1">development and run our HelloW<span class="_ _1"></span>orld progr<span class="_ _1"></span>am on an Android device. W<span class="_ _1"></span>e </div><div class="t m0 xd hd y738 ff22 fs7 fc3 sc0 ls1 ws1">then cover<span class="_ _1"></span>e<span class="_ _0"></span>d how t<span class="_ _3"></span>o create an A<span class="_ _1"></span>pple iOS app and r<span class="_ _0"></span>un a modified version </div><div class="t m0 xd hd y739 ff22 fs7 fc3 sc0 ls1 ws1">of our HelloW<span class="_ _1"></span>orld progr<span class="_ _3"></span>am on an iP<span class="_ _3"></span>ad or iPhone<span class="_ _3"></span>.</div><div class="t m0 xc hd y73a ff22 fs7 fc3 sc0 ls1 ws1">Lastly, we mentioned the source con<span class="_ _3"></span>trol system G<span class="_ _3"></span>it and the build </div><div class="t m0 xd hd y73b ff22 fs7 fc3 sc0 ls1 ws1">ser<span class="_ _0"></span>ver J<span class="_ _1"></span>enkins. W<span class="_ _1"></span>e won’t be using these in this b<span class="_ _0"></span>ook, but as y<span class="_ _3"></span>our needs get </div><div class="t m0 xd hd y73c ff22 fs7 fc3 sc0 ls1 ws1">more sophistica<span class="_ _3"></span>ted, you should check these out.</div><div class="t m0 xc hd y73d ff22 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">4</span>, “<span class="_ _1"></span>Controllin<span class="_ _3"></span>g Progr<span class="_ _3"></span>am Flow,<span class="_ _8"></span>” we will look at conditionally </div><div class="t m0 xd hd y73e ff22 fs7 fc3 sc0 ls1 ws1">executing code, br<span class="_ _3"></span>anching, and looping—the cor<span class="_ _1"></span>e building blocks of </div><div class="t m0 xd hd y73f ff22 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming logic.</div><div class="t m0 xd h15 y740 ff27 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y741 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Create a m<span class="_ _3"></span>akefile for one of the small pr<span class="_ _3"></span>ograms in </div><div class="t m0 x1e hd y742 ff22 fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">2</span>, “Loading and Adding.<span class="_ _8"></span>”</div><div class="t m0 xc hd y743 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Step thro<span class="_ _3"></span>ugh the small progr<span class="_ _1"></span>am from Chapter <span class="fc5">2</span>, </div><div class="t m0 x1e hd y744 ff22 fs7 fc3 sc0 ls1 ws1">“Loading and Adding,<span class="_ _8"></span>” to ensure y<span class="_ _3"></span>ou understand </div><div class="t m0 x1e hd y745 ff22 fs7 fc3 sc0 ls1 ws1">the changes each instruction makes to the r<span class="_ _1"></span>egisters.</div><div class="t m0 xd h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:275.090000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:123.031000px;bottom:149.090000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:298.424000px;bottom:127.090000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf68" class="pf w2 h6" data-page-no="68"><div class="pc pc68 w2 h6"><div class="t m0 x12 hd y3f ff22 fs7 fc3 sc0 ls1 ws1">85</div><div class="t m0 x1c hd y145 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>If you ha<span class="_ _3"></span>ve a computer with an In<span class="_ _3"></span>tel processor<span class="_ _10"></span>, </div><div class="t m0 x9 hd y146 ff22 fs7 fc3 sc0 ls1 ws1">set it up to cross- <span class="_ _b"></span>compile for ARM and com<span class="_ _3"></span>pile </div><div class="t m0 x9 hd y147 ff22 fs7 fc3 sc0 ls1 ws1">HelloW<span class="_ _1"></span>orld. Install the emula<span class="_ _3"></span>tor and run it on the </div><div class="t m0 x9 hd y1b0 ff22 fs7 fc3 sc0 ls1 ws1">Intel comp<span class="_ _3"></span>uter<span class="_ _6"></span>.</div><div class="t m0 x1c hd y149 ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>If you ha<span class="_ _3"></span>ve an ARM<span class="_ _1"></span>-based Android 64-bit device </div><div class="t m0 x9 hd y14a ff22 fs7 fc3 sc0 ls1 ws1">and an Intel comp<span class="_ _3"></span>uter<span class="_ _6"></span>, set it up for Android </div><div class="t m0 x9 hd y1cb ff22 fs7 fc3 sc0 ls1 ws1">Assembly development and run HelloW<span class="_ _1"></span>orld.</div><div class="t m0 x1c hd y58d ff22 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>If you ha<span class="_ _3"></span>ve a M<span class="_ _3"></span>ac and iP<span class="_ _3"></span>ad or iPhone<span class="_ _3"></span>, install X<span class="_ _3"></span>Code </div><div class="t m0 x9 hd y58e ff22 fs7 fc3 sc0 ls1 ws1">and compile and run HelloW<span class="_ _1"></span>orld as indicated.</div><div class="t m0 x3d h12 y71 ff2a fsa fc3 sc0 ls1 ws1">CHAPTER 3 <span class="_ _f"> </span><span class="wsb7"> TOOLING <span class="_ _0"></span>UP</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf69" class="pf w2 h6" data-page-no="69"><div class="pc pc69 w2 h6"><img class="bi xc y746 w7 h28" alt="" src="bg69.png"/><div class="t m0 x12 hd y16a ff2b fs7 fc3 sc0 ls1 ws1">87</div><div class="t m0 xc h17 y16b ff2b fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff2b fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff2c">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff2b">,  </span></span></div><div class="t m0 xc h17 y16d ff2b fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_4</div><div class="t m0 xc ha y16e ff2d fs6 fc3 sc0 ls1 ws1">CHAPTER 4</div><div class="t m0 xc h8 y16f ff2e fs4 fc3 sc0 ls1 ws1">Contr<span class="_ _3"></span>olling Pr<span class="_ _1"></span>ogram </div><div class="t m0 xc h8 y747 ff2e fs4 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>low</div><div class="t m0 xc hd y748 ff2b fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we know a handful of Assembly Langua<span class="_ _3"></span>ge instructions and can </div><div class="t m0 xc hd y749 ff2b fs7 fc3 sc0 ls1 ws1">execute them linearly one after the other<span class="_ _10"></span>. We learned ho<span class="_ _3"></span>w to start and </div><div class="t m0 xc hd y74a ff2b fs7 fc3 sc0 ls1 ws1">terminate a pr<span class="_ _3"></span>ogram. W<span class="_ _1"></span>e built pr<span class="_ _3"></span>ograms and debugged them<span class="_ _3"></span>.</div><div class="t m0 x1c hd y74b ff2b fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we’ll make our pr<span class="_ _1"></span>ograms more inter<span class="_ _3"></span>esting by usin<span class="_ _3"></span>g </div><div class="t m0 xc hd y74c ff2b fs7 fc3 sc0 ls1 ws1">conditional logic<span class="_ _3"></span>—<span class="ff2f">if/then/else</span> statements, fr<span class="_ _3"></span>om high-level languages<span class="_ _1"></span>. </div><div class="t m0 xc hd y74d ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will als<span class="_ _0"></span>o intr<span class="_ _1"></span>oduce loops—<span class="ff2f">for</span> and <span class="ff2f">while</span> statements, fr<span class="_ _1"></span>om high-level </div><div class="t m0 xc hd y74e ff2b fs7 fc3 sc0 ls1 ws1">languages<span class="_ _3"></span>. With these instructions in hand, we will ha<span class="_ _3"></span>ve all the basics for </div><div class="t m0 xc hd y74f ff2b fs7 fc3 sc0 ls1 ws1">coding progr<span class="_ _3"></span>am logic.</div><div class="t m0 x36 h1f y750 ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _17"> </span>We’ll start using small code snippets to demonstrate the </span></div><div class="t m0 x36 h1f y751 ff31 fse fc3 sc0 ls1 ws1">concepts.<span class="_ _1"></span> <span class="_ _1"></span>These snippets won’t work on their o<span class="_ _0"></span>wn,<span class="_ _1"></span> but in the source </div><div class="t m0 x36 h1f y752 ff31 fse fc3 sc0 ls1 ws1">code for this book,<span class="_ _1"></span> there is a codesnippets.s file that puts them all </div><div class="t m0 x36 h1f y753 ff31 fse fc3 sc0 ls1 ws1">together in a program you can run and step through in <span class="ff30">gdb</span>.</div><div class="t m0 xc h15 y353 ff30 fsb fc3 sc0 ls1 wsaf"> Unconditional <span class="_ _11"> </span>Branch</div><div class="t m0 xc hd y754 ff2b fs7 fc3 sc0 ls1 ws1">The simplest branc<span class="_ _3"></span>h instruction is</div><div class="t m0 xc h18 y755 ff32 fs7 fc3 sc0 ls1 ws1">B label</div><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf6a" class="pf w2 h6" data-page-no="6a"><div class="pc pc6a w2 h6"><img class="bi xd y756 w7 h34" alt="" src="bg6a.png"/><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">88</div><div class="t m0 xc hd y3ce ff2b fs7 fc3 sc0 ls1 ws1">which is an unconditional branch to a la<span class="_ _3"></span>bel. The label is interpr<span class="_ _1"></span>ete<span class="_ _0"></span>d </div><div class="t m0 xd hd y3cf ff2b fs7 fc3 sc0 ls1 ws1">as an offset from the curren<span class="_ _3"></span>t <span class="ff2f ls10 ws37">PC</span> r<span class="_ _1"></span>e<span class="_ _0"></span>gister and h<span class="_ _3"></span>as 26 bits in the instruction </div><div class="t m0 xd hd y3d0 ff2b fs7 fc3 sc0 ls1 ws1">allowing a range of 32 mega-wor<span class="_ _1"></span>ds in either direction or a jump of up to </div><div class="t m0 xd hd y3d1 ff2b fs7 fc3 sc0 ls1 ws1">128 megabytes in either dir<span class="_ _1"></span>ection. This instruction is like a goto statement </div><div class="t m0 xd hd y3d2 ff2b fs7 fc3 sc0 ls1 ws1">in some high-level languages<span class="_ _3"></span>.</div><div class="t m0 x34 h1f y757 ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _17"> </span>The imm26 operand is a signed integer<span class="_ _6"></span>,<span class="_ _1"></span> and the units of a </span></div><div class="t m0 x34 h1f y758 ff31 fse fc3 sc0 ls1 ws1">branch instruction are in words,<span class="_ _1"></span> because each instruction is 32 bits </div><div class="t m0 x34 h1f y759 ff31 fse fc3 sc0 ls1 ws1">in size and must be word aligned (its address must be divisible by 4).<span class="_ _1"></span> </div><div class="t m0 x34 h1f y75a ff31 fse fc3 sc0 ls1 ws1">This allows grea<span class="_ _0"></span>ter processor efficienc<span class="_ _1"></span>y accessing instructions and </div><div class="t m0 x34 h1f y75b ff31 fse fc3 sc0 ls1 ws1">greater range in branch type instructions.</div><div class="t m0 xc hd y75c ff2b fs7 fc3 sc0 ls1 ws1">If we encode Listing <span class="fc5">4-1</span><span class="ff2c">,</span> the program is in a closed loop and han<span class="_ _3"></span>gs our </div><div class="t m0 xd hd y75d ff2b fs7 fc3 sc0 ls1 ws1">terminal window until we press <span class="ff2f">Ctr<span class="_ _3"></span>l+C<span class="ff2b">.</span></span></div><div class="t m0 xd h20 y75e ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-1. <span class="_ _15"> </span><span class="ff2b">A closed loop branch instruction</span></div><div class="t m0 xd h18 y75f ff32 fs7 fc3 sc0 ls1 ws1"> _start:   MOV X1, #1</div><div class="t m0 xd h18 y760 ff32 fs7 fc3 sc0 ls1 ws1">           B _start</div><div class="t m0 xd h15 y761 ff30 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>About Condition Flags</div><div class="t m0 xd hd y762 ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve men<span class="_ _3"></span>tioned the condition flags several times without r<span class="_ _3"></span>eally looking </div><div class="t m0 xd hd y763 ff2b fs7 fc3 sc0 ls1 ws1">at what they ar<span class="_ _1"></span>e. W<span class="_ _1"></span>e talked about the carr<span class="_ _0"></span>y flag when we looked at the </div><div class="t m0 xd hd y764 ff2f fs7 fc3 sc0 ls1 ws1">ADDS<span class="ff2b">/</span>AD<span class="_ _0"></span>C<span class="ff2b"> instructions<span class="_ _3"></span>. In this section, we will look at the rest of these </span></div><div class="t m0 xd hd y765 ff2b fs7 fc3 sc0 ls1 ws1">flags.</div><div class="t m0 xc hd y766 ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll start by listing all the flags<span class="_ _1"></span>. The condition flags are</div><div class="t m0 xa hd y767 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">N</span>egative: N is 1 if the signed value is neg<span class="_ _3"></span>ative and </div><div class="t m0 x1e hd y768 ff2b fs7 fc3 sc0 ls1 ws1">cleared if the r<span class="_ _3"></span>esult is positive or 0.</div><div class="t m0 xd h12 y3e8 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf6a" data-dest-detail='[106,"XYZ",35,338,null]'><div class="d m1" style="border-style:none;position:absolute;left:149.621000px;bottom:367.362000px;width:15.048000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf6b" class="pf w2 h6" data-page-no="6b"><div class="pc pc6b w2 h6"><img class="bi xc y769 w7 h35" alt="" src="bg6b.png"/><div class="t m0 x12 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">89</div><div class="t m0 x1e hd y76a ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">Z</span>ero: I<span class="_ _3"></span>s set if the result is 0; this usually denot<span class="_ _3"></span>es an </div><div class="t m0 x9 hd y76b ff2b fs7 fc3 sc0 ls1 ws1">equal result fr<span class="_ _1"></span>om a compar<span class="_ _0"></span>ison. If the r<span class="_ _3"></span>esult is nonzero<span class="_ _1"></span>, </div><div class="t m0 x9 hd y76c ff2b fs7 fc3 sc0 ls1 ws1">this flag is cleared.</div><div class="t m0 x1e hd y76d ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">C</span>arr<span class="_ _0"></span>y: F<span class="_ _1"></span>or addition typ<span class="_ _0"></span>e oper<span class="_ _3"></span>ations<span class="_ _3"></span>, this flag is set if </div><div class="t m0 x9 hd y76e ff2b fs7 fc3 sc0 ls1 ws1">the result pr<span class="_ _1"></span>oduces an overflow. For subtr<span class="_ _1"></span>action typ<span class="_ _0"></span>e </div><div class="t m0 x9 hd y76f ff2b fs7 fc3 sc0 ls1 ws1">operation, this flag is set if the r<span class="_ _1"></span>esult does not require a </div><div class="t m0 x9 hd y770 ff2b fs7 fc3 sc0 ls1 ws1">borrow. Also<span class="_ _1"></span>, it’<span class="_ _1"></span>s used in shifting to hold the last bit that </div><div class="t m0 x9 hd y771 ff2b fs7 fc3 sc0 ls1 ws1">is shifted out.</div><div class="t m0 x1e hd y772 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>O<span class="ff2f">V</span>erflow: For addition and s<span class="_ _3"></span>ubtraction, this flag is set </div><div class="t m0 x9 hd y773 ff2b fs7 fc3 sc0 ls1 ws1">if a signed overflow occurr<span class="_ _3"></span>ed. Overflow occurs if the </div><div class="t m0 x9 hd y774 ff2b fs7 fc3 sc0 ls1 ws1">result is gr<span class="_ _1"></span>eater than or equal to 2</div><div class="t m0 x3f h1b y775 ff2b fsd fc3 sc0 ls1 ws1">31</div><div class="t m0 x40 hd y776 ff2b fs7 fc3 sc0 ls1 ws1">, or less than -2</div><div class="t m0 x41 h1b y775 ff2b fsd fc3 sc0 ls1 ws1">31</div><div class="t m0 x3e hd y776 ff2b fs7 fc3 sc0 ls1 ws1">.</div><div class="t m0 x36 h1f y777 ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _19"> </span>Some instructions may specifically set oVerflow to flag an </span></div><div class="t m0 x36 h1f y778 ff31 fse fc3 sc0 ls1 ws1">error condition.</div><div class="t m0 x1c hd y779 ff2b fs7 fc3 sc0 ls1 ws1">These flags are st<span class="_ _3"></span>ored in the <span class="ff2f ls21 wsbe">NZCV</span> system r<span class="_ _3"></span>egister<span class="_ _6"></span>. This register c<span class="_ _3"></span>an </div><div class="t m0 xc hd y77a ff2b fs7 fc3 sc0 ls1 ws1">only be accessed from opera<span class="_ _3"></span>ting system privileged instructions, so the </div><div class="t m0 xc hd y77b ff2b fs7 fc3 sc0 ls1 ws1">operating sy<span class="_ _3"></span>stem can preserve these when performing multitasking or </div><div class="t m0 xc hd y77c ff2b fs7 fc3 sc0 ls1 ws1">handling interrupts. As r<span class="_ _1"></span>egular user mode programs, o<span class="_ _3"></span>ur instructions </div><div class="t m0 xc hd y77d ff2b fs7 fc3 sc0 ls1 ws1">access the individual flags with no refer<span class="_ _1"></span>ence to this register<span class="_ _6"></span>.</div><div class="t m0 x36 h1f y77e ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _19"> </span>Remember these flags are only set if you a<span class="_ _0"></span>ppend an <span class="_ _1"></span>“<span class="ff30">S</span>”<span class="_ _1"></span> to </span></div><div class="t m0 x36 h1f y77f ff31 fse fc3 sc0 ls1 ws1">the end of the instruction’<span class="_ _6"></span>s opcode.<span class="_ _3"></span> Otherwise the flags will remain </div><div class="t m0 x36 h1f y780 ff31 fse fc3 sc0 ls1 ws1">unmodified.<span class="_ _1"></span> <span class="_ _1"></span>The only exceptions are the comparison instructions </div><div class="t m0 x36 h1f y781 ff31 fse fc3 sc0 ls1 ws1">described in the following.</div><div class="t m0 x30 h12 y484 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf6c" class="pf w2 h6" data-page-no="6c"><div class="pc pc6c w2 h6"><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">90</div><div class="t m0 xd h15 y186 ff30 fsb fc3 sc0 ls1 wsaf"> Branch <span class="_ _11"> </span>onCondition</div><div class="t m0 xd hd y187 ff2b fs7 fc3 sc0 ls1 ws1">The branch instruction, at the beginning of this ch<span class="_ _3"></span>apter<span class="_ _10"></span>, can take a </div><div class="t m0 xd hd y188 ff2b fs7 fc3 sc0 ls1 ws1">modifier that instructs it to only branch if a certain condition flags ar<span class="_ _1"></span>e s<span class="_ _0"></span>et </div><div class="t m0 xd hd y2be ff2b fs7 fc3 sc0 ls1 ws1">or clear<span class="_ _6"></span>.</div><div class="t m0 xc hd y18a ff2b fs7 fc3 sc0 ls1 ws1">The general form of the branch instructions is</div><div class="t m0 xd h18 y3ab ff32 fs7 fc3 sc0 ls1 ws1">B.{condition} label</div><div class="t m0 xc hd y3ac ff2b fs7 fc3 sc0 ls1 ws1">where {<span class="_ _1"></span>condition} is taken from T<span class="_ _10"></span>able<span class="fc5">4-1</span>.</div><div class="t m0 xc hd y782 ff2b fs7 fc3 sc0 ls1 ws1">For exam<span class="_ _3"></span>ple:</div><div class="t m0 xd h18 y783 ff32 fs7 fc3 sc0 ls1 ws1">B.EQ _start</div><div class="t m0 xc hd y3af ff2b fs7 fc3 sc0 ls1 ws1">will branch to _start if the Z flag is set. This seems a bit stran<span class="_ _3"></span>ge. Why </div><div class="t m0 xd hd y3b0 ff2b fs7 fc3 sc0 ls1 ws1">isn’t the instruction B.Z for branch on zer<span class="_ _3"></span>o? What is equal her<span class="_ _3"></span>e? T<span class="_ _6"></span>o answer </div><div class="t m0 xd hd y3b1 ff2b fs7 fc3 sc0 ls1 ws1">these questions, we need to look at the <span class="ff2f">CMP</span> instruction.</div><div class="t m0 xd h15 y784 ff30 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>About theCMP Instruction</div><div class="t m0 xd hd y785 ff2b fs7 fc3 sc0 ls1 ws1">The format of the <span class="ff2f">CMP</span> instruction is</div><div class="t m0 xd h18 y786 ff32 fs7 fc3 sc0 ls1 ws1">CMP Xn, Operand2</div><div class="t m0 xc hd y787 ff2b fs7 fc3 sc0 ls1 ws1">This instruction compares the con<span class="_ _3"></span>tents of r<span class="_ _3"></span>egister <span class="ff2f lsb wsb4">Xn</span> with <span class="ff2f">Op<span class="_ _0"></span>erand2</span>, </div><div class="t m0 xd hd y788 ff2b fs7 fc3 sc0 ls1 ws1">by subtr<span class="_ _3"></span>acting Operand2 fr<span class="_ _3"></span>om Rn and updating the sta<span class="_ _3"></span>tus flags </div><div class="t m0 xd hd y789 ff2b fs7 fc3 sc0 ls1 ws1">accordingly. T<span class="_ _3"></span>his instruction is equivalent to</div><div class="t m0 xd h18 y78a ff32 fs7 fc3 sc0 ls1 ws1">SUBS XZR, Xn, Operand2</div><div class="t m0 xc hd y78b ff2b fs7 fc3 sc0 ls1 ws1">For exam<span class="_ _3"></span>ple, to do a br<span class="_ _3"></span>anch only if register <span class="ff2f">W4</span> is 45, we migh<span class="_ _3"></span>t code</div><div class="t m0 xd h18 y78c ff32 fs7 fc3 sc0 ls1 ws1">CMP W4, #45</div><div class="t m0 xd h18 y78d ff32 fs7 fc3 sc0 ls1 ws1">B.EQ _start</div><div class="t m0 xd h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf6d" data-dest-detail='[109,"XYZ",53,514,null]'><div class="d m1" style="border-style:none;position:absolute;left:230.844000px;bottom:451.090000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf6d" class="pf w2 h6" data-page-no="6d"><div class="pc pc6d w2 h6"><img class="bi xc y78e we h36" alt="" src="bg6d.png"/><div class="t m0 x12 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">91</div><div class="t m0 x1c hd y145 ff2b fs7 fc3 sc0 ls1 ws1">In this context<span class="_ _3"></span>, we see how the mnemonic <span class="ff2f">B.EQ</span> makes sense, since </div><div class="t m0 xc hd y146 ff2f fs7 fc3 sc0 ls1 ws1">CMP<span class="ff2b"> subtracts 45 fr<span class="_ _3"></span>om <span class="ff2f">W4</span>; the result is z<span class="_ _3"></span>ero if they ar<span class="_ _3"></span>e equal and the <span class="ff2f">Z</span> flag </span></div><div class="t m0 xc hd y147 ff2b fs7 fc3 sc0 ls1 ws1">will be set. If you go back to T<span class="_ _10"></span>able<span class="fc5">4-1</span> and consider the condition codes in </div><div class="t m0 xc hd y1b0 ff2b fs7 fc3 sc0 ls1 ws1">this context, then they m<span class="_ _3"></span>ake sense.</div><div class="t m0 xc h37 y78f ff33 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 4-1. <span class="_ _15"> </span><span class="ff2c">Condition codes for the branch instruction</span></div><div class="t m0 xc h10 y790 ff30 fs7 fc3 sc0 ls1 ws1">{condition}<span class="_ _2e"> </span>Flags<span class="_ _2f"> </span>Meaning</div><div class="t m0 xc h10 y791 ff30 fs7 fc3 sc0 ls1 ws1">EQ<span class="_ _30"> </span><span class="ff31">Z set<span class="_ _31"> </span>Equal</span></div><div class="t m0 xc h10 y792 ff30 fs7 fc3 sc0 ls1 ws1">NE<span class="_ _30"> </span><span class="ff31">Z c<span class="_ _1"></span>lear<span class="_ _32"> </span>Not equal</span></div><div class="t m0 xc h10 y793 ff30 fs7 fc3 sc0 ls1 ws1">CS or HS<span class="_ _33"> </span><span class="ff31">C set<span class="_ _34"> </span>Higher or same (unsigned &gt;=)</span></div><div class="t m0 xc h10 y794 ff30 fs7 fc3 sc0 ls1 ws1">CC or LO<span class="_ _35"> </span><span class="ff31">C clear<span class="_ _36"> </span>Lower (unsigned &lt;)</span></div><div class="t m0 xc h10 y795 ff30 fs7 fc3 sc0 ls1 ws1">MI<span class="_ _37"> </span><span class="ff31">N set<span class="_ _38"> </span>Negative</span></div><div class="t m0 xc h10 y796 ff30 fs7 fc3 sc0 ls1 ws1">PL<span class="_ _37"> </span><span class="ff31">N clear<span class="_ _36"> </span>P<span class="_ _1"></span>ositive or zero</span></div><div class="t m0 xc h10 y797 ff30 fs7 fc3 sc0 ls1 ws1">VS<span class="_ _30"> </span><span class="ff31">V set<span class="_ _31"> </span>Overflow</span></div><div class="t m0 xc h10 y798 ff30 fs7 fc3 sc0 ls1 ws1">VC<span class="_ _30"> </span><span class="ff31">V c<span class="_ _1"></span>lear<span class="_ _32"> </span>No overflow</span></div><div class="t m0 xc h10 y799 ff30 fs7 fc3 sc0 ls1 ws1">HI<span class="_ _39"> </span><span class="ff31">C set and Z clear<span class="_ _3a"> </span>Higher (unsigned &gt;)</span></div><div class="t m0 xc h10 y79a ff30 fs7 fc3 sc0 ls1 ws1">LS<span class="_ _37"> </span><span class="ff31">C clear and Z set<span class="_ _3a"> </span>Lo<span class="_ _0"></span>wer or same (unsigned &lt;=)</span></div><div class="t m0 xc h10 y79b ff30 fs7 fc3 sc0 ls1 ws1">GE<span class="_ _30"> </span><span class="ff31">N and <span class="_ _1"></span>V the same<span class="_ _3b"> </span>Signed &gt;=</span></div><div class="t m0 xc h10 y79c ff30 fs7 fc3 sc0 ls22 wsc5">LT<span class="_ _39"> </span><span class="ff31 ls1 ws1">N and V differ<span class="_ _3c"> </span>Signed &lt;</span></div><div class="t m0 xc h10 y79d ff30 fs7 fc3 sc0 ls1 ws1">GT<span class="_ _30"> </span><span class="ff31">Z clear<span class="_ _10"></span>, N and <span class="_ _1"></span>V the same<span class="_ _3d"> </span>Signed &gt;</span></div><div class="t m0 xc h10 y79e ff30 fs7 fc3 sc0 ls1 ws1">LE<span class="_ _3e"> </span><span class="ff31">Z set,<span class="_ _1"></span> N and V differ<span class="_ _3f"> </span>Signed &lt;=</span></div><div class="t m0 xc h10 y79f ff30 fs7 fc3 sc0 ls1 ws1">AL<span class="_ _30"> </span><span class="ff31">An<span class="_ _0"></span>y<span class="_ _40"> </span>Always (same as no suffix)</span></div><div class="t m0 x30 h12 y7a0 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf6d" data-dest-detail='[109,"XYZ",53,514,null]'><div class="d m1" style="border-style:none;position:absolute;left:211.562000px;bottom:545.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf6e" class="pf w2 h6" data-page-no="6e"><div class="pc pc6e w2 h6"><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">92</div><div class="t m0 xd h15 y186 ff30 fsb fc3 sc0 ls1 wsaf"> Loops</div><div class="t m0 xd hd y187 ff2b fs7 fc3 sc0 ls1 ws1">With branc<span class="_ _3"></span>h and comparison instructions in hand, let’<span class="_ _1"></span>s look at </div><div class="t m0 xd hd y188 ff2b fs7 fc3 sc0 ls1 ws1">constructing some loops modeled on what we find in high-level </div><div class="t m0 xd hd y2be ff2b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming languages<span class="_ _1"></span>.</div><div class="t m0 xd ha y7a1 ff30 fs6 fc3 sc0 ls1 wsb1"> FOR <span class="_ _14"> </span>Loops</div><div class="t m0 xd hd y7a2 ff2b fs7 fc3 sc0 ls1 ws1">Suppose we want to do the basic for loop:</div><div class="t m0 xd h18 y7a3 ff32 fs7 fc3 sc0 ls1 ws1">FOR I = 1 to 10</div><div class="t m0 xd h18 y7a4 ff32 fs7 fc3 sc0 ls1 ws1">     ... some statements...</div><div class="t m0 xd h18 y7a5 ff32 fs7 fc3 sc0 ls1 ws1">NEXT I</div><div class="t m0 xc hd y7a6 ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can implement this as shown in Listing <span class="fc5">4-2</span>.</div><div class="t m0 xd h20 y7a7 ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-2. <span class="_ _15"> </span><span class="ff2b">Basic for loop</span></div><div class="t m0 xd h18 y7a8 ff32 fs7 fc3 sc0 ls1 ws1">      MOV W2, #1     // W2 holds I</div><div class="t m0 xd h18 y7a9 ff32 fs7 fc3 sc0 ls1 ws1">loop: // body of the loop goes here.</div><div class="t m0 xd h18 y7aa ff32 fs7 fc3 sc0 ls1 ws1">      // Most of the logic is at the end</div><div class="t m0 xd h18 y7ab ff32 fs7 fc3 sc0 ls1 ws1">      ADD W2, W2, #1 // I = I + 1</div><div class="t m0 xd h18 y7ac ff32 fs7 fc3 sc0 ls1 ws1">      CMP W2, #10</div><div class="t m0 xd h18 y7ad ff32 fs7 fc3 sc0 ls1 ws1">      B.LE loop      // IF I &lt;= 10 goto loop</div><div class="t m0 xc hd y7ae ff2b fs7 fc3 sc0 ls1 ws1">If we did this by counting do<span class="_ _3"></span>wn</div><div class="t m0 xd h18 y7af ff32 fs7 fc3 sc0 ls1 ws1">FOR I = 10 TO 1 STEP -1</div><div class="t m0 xd h18 y7b0 ff32 fs7 fc3 sc0 ls1 ws1">     ... some statements...</div><div class="t m0 xd h18 y7b1 ff32 fs7 fc3 sc0 ls1 ws1">NEXT I</div><div class="t m0 xc hd y7b2 ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can implement this as shown in Listing <span class="fc5">4-3</span>.</div><div class="t m0 xd h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf6e" data-dest-detail='[110,"XYZ",35,357,null]'><div class="d m1" style="border-style:none;position:absolute;left:255.462000px;bottom:371.090000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6f" data-dest-detail='[111,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:255.462000px;bottom:126.590000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf6f" class="pf w2 h6" data-page-no="6f"><div class="pc pc6f w2 h6"><img class="bi xc y7b3 w7 h28" alt="" src="bg6f.png"/><div class="t m0 x12 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">93</div><div class="t m0 xc h20 y4c5 ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-3. <span class="_ _15"> </span><span class="ff2b">Reverse for loop</span></div><div class="t m0 xc h18 y4c6 ff32 fs7 fc3 sc0 ls1 ws1">      MOV W2, #10     // R2 holds I</div><div class="t m0 xc h18 y4c7 ff32 fs7 fc3 sc0 ls1 ws1">loop: // body of the loop goes here.</div><div class="t m0 xc h18 y7b4 ff32 fs7 fc3 sc0 ls1 ws1">      // The CMP is redundant since we</div><div class="t m0 xc h18 y7b5 ff32 fs7 fc3 sc0 ls1 ws1">      // are doing SUBS.</div><div class="t m0 xc h18 y7b6 ff32 fs7 fc3 sc0 ls1 ws1">      SUBS W2, W2, #1 // I = I - 1</div><div class="t m0 xc h18 y7b7 ff32 fs7 fc3 sc0 ls1 ws1">      B.NE loop       // branch until I = 0</div><div class="t m0 x1c hd y7b8 ff2b fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e we save an ins<span class="_ _3"></span>truction, since with the <span class="ff2f ls1c wsbf">SUB<span class="_ _0"></span>S</span> instruction, we don’t </div><div class="t m0 xc hd y7b9 ff2b fs7 fc3 sc0 ls1 ws1">need the <span class="ff2f">CMP</span> instruction.</div><div class="t m0 xc ha y7ba ff30 fs6 fc3 sc0 ls1 wsb1"> While <span class="_ _14"> </span>Loops</div><div class="t m0 xc hd y7bb ff2b fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s code</div><div class="t m0 xc h18 y7bc ff32 fs7 fc3 sc0 ls1 ws1">WHILE X &lt; 5</div><div class="t m0 xc h18 y7bd ff32 fs7 fc3 sc0 ls1 ws1">     ... other statements ....</div><div class="t m0 xc h18 y7be ff32 fs7 fc3 sc0 ls1 ws1">END WHILE</div><div class="t m0 x36 h1f y7bf ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _19"> </span>Initializing the variables and changing the variables aren’t part </span></div><div class="t m0 x36 h1f y7c0 ff31 fse fc3 sc0 ls1 ws1">of the <span class="ff30">while</span> statement.<span class="_ _1"></span> <span class="_ _3"></span>These are separate sta<span class="_ _0"></span>tements that appear </div><div class="t m0 x36 h1f y7c1 ff31 fse fc3 sc0 ls1 ws1">before and in the body of the loop.<span class="_ _1"></span> In <span class="_ _3"></span>Assembly<span class="_ _6"></span>, we might code as </div><div class="t m0 x36 h1f y7c2 ff31 fse fc3 sc0 ls1 ws1">shown in Listing <span class="fc5">4-4</span>.</div><div class="t m0 xc h20 y7c3 ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-4. <span class="_ _15"> </span><span class="ff2b">While loop</span></div><div class="t m0 xc h18 y7c4 ff32 fs7 fc3 sc0 ls1 ws1">// W4 is X and has been initialized</div><div class="t m0 xc h18 y7c5 ff32 fs7 fc3 sc0 ls1 ws1">loop: CMP  W4, #5</div><div class="t m0 xc h18 y7c6 ff32 fs7 fc3 sc0 ls1 ws1">      B.GE loopdone</div><div class="t m0 xc h18 y7c7 ff32 fs7 fc3 sc0 ls1 ws1">      // ... other statements in the loop body ...</div><div class="t m0 xc h18 y7c8 ff32 fs7 fc3 sc0 ls1 ws1">      B    loop</div><div class="t m0 xc h18 y7c9 ff32 fs7 fc3 sc0 ls1 ws1">loopdone: // program continues</div><div class="t m0 x30 h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf6f" data-dest-detail='[111,"XYZ",53,194,null]'><div class="d m1" style="border-style:none;position:absolute;left:142.543000px;bottom:219.150000px;width:17.056000px;height:14.872000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf70" class="pf w2 h6" data-page-no="70"><div class="pc pc70 w2 h6"><img class="bi xd y7ca w7 h24" alt="" src="bg70.png"/><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">94</div><div class="t m0 x34 h1f y7cb ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _17"> </span>A while loop only executes if the statement is initially true,<span class="_ _1"></span> so </span></div><div class="t m0 x34 h1f y7cc ff31 fse fc3 sc0 ls1 ws1">there is no guarantee that the loop bod<span class="_ _0"></span>y will ever be executed.</div><div class="t m0 xd h15 y7cd ff30 fsb fc3 sc0 ls1 wsaf"> If/Then/Else</div><div class="t m0 xd hd y7ce ff2b fs7 fc3 sc0 ls1 ws1">In this section, we’ll look at coding</div><div class="t m0 xd h18 y7cf ff32 fs7 fc3 sc0 ls1 ws1">IF &lt;expression&gt; THEN</div><div class="t m0 xd h18 y7d0 ff32 fs7 fc3 sc0 ls1 ws1">     ... statements ...</div><div class="t m0 xd h18 y7d1 ff32 fs7 fc3 sc0 ls1 ws1">ELSE</div><div class="t m0 xd h18 y7d2 ff32 fs7 fc3 sc0 ls1 ws1">     ... statements ...</div><div class="t m0 xd h18 y7d3 ff32 fs7 fc3 sc0 ls1 ws1">END IF</div><div class="t m0 xc hd y7d4 ff2b fs7 fc3 sc0 ls1 ws1">In Assembly, we need to evaluate &lt;expr<span class="_ _1"></span>ession&gt; and have the r<span class="_ _3"></span>esult </div><div class="t m0 xd hd y7d5 ff2b fs7 fc3 sc0 ls1 ws1">end up in a register th<span class="_ _3"></span>at we can compar<span class="_ _3"></span>e. F<span class="_ _1"></span>or now, we’ll assume that </div><div class="t m0 xd hd y7d6 ff2b fs7 fc3 sc0 ls1 ws1">&lt;expression&gt; is sim<span class="_ _3"></span>ply of the form</div><div class="t m0 xd h18 y7d7 ff32 fs7 fc3 sc0 ls1 ws1">register comparison immediate-constant</div><div class="t m0 xc hd y7d8 ff2b fs7 fc3 sc0 ls1 ws1">In this wa<span class="_ _3"></span>y, we can evaluate it with a single <span class="ff2f">CMP</span> instruction. F<span class="_ _3"></span>or </div><div class="t m0 xd hd y7d9 ff2b fs7 fc3 sc0 ls1 ws1">example, suppose we wan<span class="_ _3"></span>t to code</div><div class="t m0 xd h18 y7da ff32 fs7 fc3 sc0 ls1 ws1">IF W5 &lt; 10 THEN</div><div class="t m0 xd h18 y7db ff32 fs7 fc3 sc0 ls1 ws1">     .... if statements ...</div><div class="t m0 xd h18 y7dc ff32 fs7 fc3 sc0 ls1 ws1">ELSE</div><div class="t m0 xd h18 y7dd ff32 fs7 fc3 sc0 ls1 ws1">     ... else statements ...</div><div class="t m0 xd h18 y7de ff32 fs7 fc3 sc0 ls1 ws1">END IF</div><div class="t m0 xc hd y7df ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can code this as Listing <span class="fc5">4-5</span>.</div><div class="t m0 xd h12 y28b ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf71" data-dest-detail='[113,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:181.235000px;bottom:137.770000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf71" class="pf w2 h6" data-page-no="71"><div class="pc pc71 w2 h6"><img class="bi xc y7e0 w7 h38" alt="" src="bg71.png"/><div class="t m0 x12 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">95</div><div class="t m0 xc h20 y7e1 ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-5. <span class="_ _15"> </span><span class="ff2b">If/then/else statement</span></div><div class="t m0 xc h18 y7e2 ff32 fs7 fc3 sc0 ls1 ws1">     CMP W5, #10</div><div class="t m0 xc h18 y7e3 ff32 fs7 fc3 sc0 ls1 ws1">     B.GE elseclause</div><div class="t m0 xc h18 y7e4 ff32 fs7 fc3 sc0 ls1 ws1">     ... if statements ...</div><div class="t m0 xc h18 y7e5 ff32 fs7 fc3 sc0 ls1 ws1">     B endif</div><div class="t m0 xc h18 y7e6 ff32 fs7 fc3 sc0 ls1 ws1">elseclause:</div><div class="t m0 xc h18 y7e7 ff32 fs7 fc3 sc0 ls1 ws1">     ... else statements ...</div><div class="t m0 xc h18 y7e8 ff32 fs7 fc3 sc0 ls1 ws1">endif:     // continue on after the /then/else ...</div><div class="t m0 x1c hd y7e9 ff2b fs7 fc3 sc0 ls1 ws1">This is simple<span class="_ _3"></span>, but it is still worth putting in comments to be clear </div><div class="t m0 xc hd y7ea ff2b fs7 fc3 sc0 ls1 ws1">which statements ar<span class="_ _1"></span>e par<span class="_ _0"></span>t of the if/then/else and which statemen<span class="_ _3"></span>ts are in </div><div class="t m0 xc hd y7eb ff2b fs7 fc3 sc0 ls1 ws1">the body of the if or else blocks.</div><div class="t m0 x36 h1f y7ec ff30 fse fc3 sc0 ls1e wsc1">Tip<span class="_ _0"></span><span class="ff31 ls1 ws1"> <span class="_ _17"> </span>Adding a blank line can make the code much more readable.</span></div><div class="t m0 xc h15 y7ed ff30 fsb fc3 sc0 ls1 wsaf"> Logical <span class="_ _11"> </span>Operators</div><div class="t m0 xc hd y7ee ff2b fs7 fc3 sc0 ls1 ws1">For o<span class="_ _3"></span>ur upcoming sample pr<span class="_ _3"></span>ogram, we need to start manipula<span class="_ _3"></span>ting the bits </div><div class="t m0 xc hd y7ef ff2b fs7 fc3 sc0 ls1 ws1">in the registers<span class="_ _1"></span>. The ARM’<span class="_ _6"></span>s logical operators pro<span class="_ _1"></span>vide s<span class="_ _0"></span>ever<span class="_ _3"></span>al tools for us to </div><div class="t m0 xc hd y7f0 ff2b fs7 fc3 sc0 ls1 ws1">do this, as follo<span class="_ _3"></span>ws<span class="_ _0"></span>:</div><div class="t m0 xc h18 y7f1 ff32 fs7 fc3 sc0 ls1 ws1">AND{S}    Xd, Xs, Operand2</div><div class="t m0 xc h18 y7f2 ff32 fs7 fc3 sc0 ls1 ws1">EOR{S}    Xd, Xs, Operand2</div><div class="t m0 xc h18 y7f3 ff32 fs7 fc3 sc0 ls1 ws1">ORR{S}    Xd, Xs, Operand2</div><div class="t m0 xc h18 y7f4 ff32 fs7 fc3 sc0 ls1 ws1">BIC{S}    Xd, Xs, Operand2</div><div class="t m0 x1c hd y7f5 ff2b fs7 fc3 sc0 ls1 ws1">These operate on each bit of the r<span class="_ _1"></span>egisters separately.</div><div class="t m0 x30 h12 y28b ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf72" class="pf w2 h6" data-page-no="72"><div class="pc pc72 w2 h6"><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">96</div><div class="t m0 xd ha y248 ff30 fs6 fc3 sc0 ls1 wsb1"> AND</div><div class="t m0 xd hd y249 ff2f fs7 fc3 sc0 ls1 ws1">AND<span class="ff2b"> performs a bitw<span class="_ _0"></span>ise logical and oper<span class="_ _3"></span>ation between each bit in <span class="ff2f ls23 wsc6">Xs</span> and </span></div><div class="t m0 xd hd y24a ff2f fs7 fc3 sc0 ls1 ws1">Operand2<span class="ff2b">, putting the result in </span><span class="ls1f wsc7">Xd</span><span class="ff2b">. Remem<span class="_ _3"></span>ber that logical AND is true (1) </span></div><div class="t m0 xd hd y24b ff2b fs7 fc3 sc0 ls1 ws1">if both arguments ar<span class="_ _3"></span>e true (1) and false (0) other<span class="_ _0"></span>wise, for example:</div><div class="t m0 xc hd y5ad ff2b fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s use <span class="ff2f">AND</span> to mask off a byte of information. S<span class="_ _3"></span>uppose we only want </div><div class="t m0 xd hd y5ae ff2b fs7 fc3 sc0 ls1 ws1">the high-order b<span class="_ _3"></span>yte of a register<span class="_ _10"></span>. Listing <span class="fc5">4-6</span> does this for the 32-bit version </div><div class="t m0 xd hd y7f6 ff2b fs7 fc3 sc0 ls1 ws1">register <span class="ff2f">W6</span>.</div><div class="t m0 xd h20 y325 ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-6. <span class="_ _15"> </span><span class="ff2b">Using AND to m<span class="_ _3"></span>ask a byte of information</span></div><div class="t m0 xd h18 y326 ff32 fs7 fc3 sc0 ls1 ws1">// mask off the high order byte</div><div class="t m0 xd h18 y7f7 ff32 fs7 fc3 sc0 ls1 ws1">     AND   W6, W6, #0xFF000000</div><div class="t m0 xd h18 y328 ff32 fs7 fc3 sc0 ls1 ws1">     // shift the byte down to the</div><div class="t m0 xd h18 y329 ff32 fs7 fc3 sc0 ls1 ws1">     // low order position.</div><div class="t m0 xd h18 y32a ff32 fs7 fc3 sc0 ls1 ws1">     LSR   W6, W6, #24</div><div class="t m0 xd ha y7f8 ff30 fs6 fc3 sc0 ls1 wsb1"> EOR</div><div class="t m0 xd hd y7f9 ff2f fs7 fc3 sc0 ls1 ws1">EOR<span class="ff2b"> perfor<span class="_ _0"></span>ms a bitwise exclusive or opera<span class="_ _3"></span>tion between each bit in <span class="ff2f ls23 wsc6">Xs</span> and </span></div><div class="t m0 xd hd y7fa ff2f fs7 fc3 sc0 ls1 ws1">Operand2<span class="ff2b">, putting the result in </span><span class="ls1f wsc7">Xd</span><span class="ff2b">. Remem<span class="_ _3"></span>ber that exclusive OR is true (1) </span></div><div class="t m0 xd hd y7fb ff2b fs7 fc3 sc0 ls1 ws1">if exactly one argument is true (1) and false (0) otherw<span class="_ _0"></span>ise<span class="_ _3"></span>.</div><div class="t m0 xd ha y7fc ff30 fs6 fc3 sc0 ls1 wsb1"> ORR</div><div class="t m0 xd hd y7fd ff2f fs7 fc3 sc0 ls1 ws1">ORR<span class="ff2b"> performs a bitw<span class="_ _0"></span>ise logical or oper<span class="_ _3"></span>ation between each bit in <span class="ff2f ls23 wsc6">Xs</span> and </span></div><div class="t m0 xd hd y7fe ff2f fs7 fc3 sc0 ls1 ws1">Operand2<span class="ff2b">, putting the result in </span><span class="ls1f wsc7">Xd</span><span class="ff2b">. Remem<span class="_ _3"></span>ber that logical OR is true (1) if </span></div><div class="t m0 xd hd y7ff ff2b fs7 fc3 sc0 ls1 ws1">one or both arguments ar<span class="_ _3"></span>e true (1) and false (0) if both arguments are false </div><div class="t m0 xd hd y800 ff2b fs7 fc3 sc0 ls1 ws1">(0), for example:</div><div class="t m0 xd h18 y801 ff32 fs7 fc3 sc0 ls1 ws1">ORR   X6, X6, #0xFF</div><div class="t m0 xc hd y802 ff2b fs7 fc3 sc0 ls1 ws1">This sets the low-order b<span class="_ _1"></span>yte of <span class="ff2f">X6</span> to all 1 bits (0xFF<span class="_ _0"></span>) while lea<span class="_ _3"></span>ving the </div><div class="t m0 xd hd y803 ff2b fs7 fc3 sc0 ls1 ws1">seven other bytes unaffected.</div><div class="t m0 xd h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf72" data-dest-detail='[114,"XYZ",35,455,null]'><div class="d m1" style="border-style:none;position:absolute;left:220.973000px;bottom:484.518000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf73" class="pf w2 h6" data-page-no="73"><div class="pc pc73 w2 h6"><img class="bi x2e y804 w5 h39" alt="" src="bg73.png"/><div class="t m0 x12 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">97</div><div class="t m0 xc ha y248 ff30 fs6 fc3 sc0 ls1 wsb1"> BIC</div><div class="t m0 xc hd y249 ff2f fs7 fc3 sc0 ls1f wsc7">BIC<span class="ff2b ls1 ws1"> (bit clear) per<span class="_ _0"></span>forms </span><span class="ls23 wsc6">Xs<span class="ff2b ls1 ws1"> AND NOT Oper<span class="_ _1"></span>and2. The reason this is called </span></span></div><div class="t m0 xc hd y24a ff2b fs7 fc3 sc0 ls1 ws1">bit clear is that if the bit in <span class="ff2f">Operand2</span> is 1, then the resultin<span class="_ _3"></span>g bit will be 0. If </div><div class="t m0 xc hd y24b ff2b fs7 fc3 sc0 ls1 ws1">the bit in <span class="ff2f">Operand2</span> is 0, then the corresponding bit in <span class="ff2f ls23 wsc6">Xs</span> will be put in the </div><div class="t m0 xc hd y5ad ff2b fs7 fc3 sc0 ls1 ws1">result <span class="ff2f ls1f wsc7">Xd</span>.</div><div class="t m0 x1c hd y5ae ff2b fs7 fc3 sc0 ls1 ws1">Sometimes the Assembler substitutes this instruction to encode an </div><div class="t m0 xc hd y7f6 ff2b fs7 fc3 sc0 ls1 ws1">Operand2 tha<span class="_ _3"></span>t doesn’t work with AND, similar to MO<span class="_ _1"></span>V and MVN, for </div><div class="t m0 xc hd y805 ff2b fs7 fc3 sc0 ls1 ws1">example:</div><div class="t m0 xc h18 y806 ff32 fs7 fc3 sc0 ls1 ws1">BIC   X6, X6, #0xFF</div><div class="t m0 x1c hd y807 ff2b fs7 fc3 sc0 ls1 ws1">This clears the low-or<span class="_ _3"></span>der byte of X6, while lea<span class="_ _1"></span>ving the other seven </div><div class="t m0 xc hd y808 ff2b fs7 fc3 sc0 ls1 ws1">bytes unaffected (F<span class="_ _1"></span>igure<span class="fc5">4-1</span>).</div><div class="t m0 xc h15 y809 ff30 fsb fc3 sc0 ls1 wsaf"> Design <span class="_ _11"> </span>P<span class="_ _1"></span>atterns</div><div class="t m0 xc hd y80a ff2b fs7 fc3 sc0 ls1 ws1">When writing Assembly Language code, ther<span class="_ _1"></span>e is a great temptation to be </div><div class="t m0 xc hd y80b ff2b fs7 fc3 sc0 ls1 ws1">crea<span class="_ _3"></span>tive. F<span class="_ _1"></span>or instance, we could do a loop ten times by setting the ten<span class="_ _3"></span>th bit </div><div class="t m0 xc hd y80c ff2b fs7 fc3 sc0 ls1 ws1">in a register<span class="_ _10"></span>, then shifting it right until the register is zer<span class="_ _1"></span>o. This wor<span class="_ _3"></span>ks, b<span class="_ _3"></span>ut it </div><div class="t m0 xc hd y80d ff2b fs7 fc3 sc0 ls1 ws1">makes r<span class="_ _3"></span>eading your pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>am difficult. If you lea<span class="_ _1"></span>ve your program and come </div><div class="t m0 xc hd y80e ff2b fs7 fc3 sc0 ls1 ws1">to it next month<span class="_ _3"></span>, you will be scratching yo<span class="_ _3"></span>ur head as to what the pr<span class="_ _1"></span>ogram </div><div class="t m0 xc hd y80f ff2b fs7 fc3 sc0 ls1 ws1">does.</div><div class="t m0 x1c hd y810 ff2b fs7 fc3 sc0 ls1 ws1">Design patterns ar<span class="_ _3"></span>e typical solutions to common progr<span class="_ _3"></span>amming </div><div class="t m0 xc hd y811 ff2b fs7 fc3 sc0 ls1 ws1">patterns<span class="_ _3"></span>. If you adopt a few standar<span class="_ _1"></span>d design patterns for how to perform </div><div class="t m0 xc hd y812 ff2b fs7 fc3 sc0 ls1 ws1">loops and other progr<span class="_ _3"></span>amming constructs, it will make r<span class="_ _1"></span>eading your </div><div class="t m0 xc hd y813 ff2b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams much easier<span class="_ _10"></span>.</div><div class="t m0 xc h37 y814 ff33 fs3 fc3 sc0 ls1 ws1">Figure 4-1. <span class="_ _15"> </span><span class="ff2c">What each logical operator does w<span class="_ _0"></span>ith each pair of bits</span></div><div class="t m0 x30 h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf73" data-dest-detail='[115,"XYZ",53,374,null]'><div class="d m1" style="border-style:none;position:absolute;left:169.080000px;bottom:388.518000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf74" class="pf w2 h6" data-page-no="74"><div class="pc pc74 w2 h6"><img class="bi xd y815 w7 h24" alt="" src="bg74.png"/><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">98</div><div class="t m0 xc hd y275 ff2b fs7 fc3 sc0 ls1 ws1">Design patterns make y<span class="_ _3"></span>our progr<span class="_ _1"></span>amming more productive<span class="_ _3"></span>, since you </div><div class="t m0 xd hd y276 ff2b fs7 fc3 sc0 ls1 ws1">can just use an example fr<span class="_ _3"></span>om a collection of tried and true patterns for </div><div class="t m0 xd hd y277 ff2b fs7 fc3 sc0 ls1 ws1">most situations<span class="_ _3"></span>.</div><div class="t m0 x34 h1f y816 ff30 fse fc3 sc0 ls1e wsc1">Tip<span class="_ _0"></span><span class="ff31 ls1 ws1"> <span class="_ _19"> </span>In <span class="_ _1"></span>Assembly<span class="_ _1"></span>,<span class="_ _1"></span> make sure you document which design pattern </span></div><div class="t m0 x34 h1f y817 ff31 fse fc3 sc0 ls1 ws1">you are using,<span class="_ _1"></span> along with documenting the registers used.</div><div class="t m0 xc hd y818 ff2b fs7 fc3 sc0 ls1 ws1">Therefor<span class="_ _1"></span>e, we implemented loops and if/then/else in the pattern of a </div><div class="t m0 xd hd y819 ff2b fs7 fc3 sc0 ls1 ws1">high-level language<span class="_ _1"></span>. If w<span class="_ _0"></span>e do this<span class="_ _3"></span>, it makes our pr<span class="_ _1"></span>ograms more r<span class="_ _3"></span>eliable and </div><div class="t m0 xd hd y81a ff2b fs7 fc3 sc0 ls1 ws1">quicker to write. I<span class="_ _3"></span>n Chapter <span class="fc5">6</span>, “F<span class="_ _1"></span>unctions and the Stack,<span class="_ _8"></span>” we’ll look at how </div><div class="t m0 xd hd y81b ff2b fs7 fc3 sc0 ls1 ws1">to use the macro facility in the Assembler to help with this<span class="_ _1"></span>.</div><div class="t m0 xd h15 y81c ff30 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Converting Integers toASCII</div><div class="t m0 xd hd y81d ff2b fs7 fc3 sc0 ls1 ws1">As a first example of a loop<span class="_ _1"></span>, let’<span class="_ _1"></span>s convert a 64-bit register to ASCII, so we </div><div class="t m0 xd hd y81e ff2b fs7 fc3 sc0 ls1 ws1">can display the con<span class="_ _3"></span>tents on the console. I<span class="_ _3"></span>n our HelloW<span class="_ _1"></span>orld pr<span class="_ _3"></span>ogram in </div><div class="t m0 xd hd y81f ff2b fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>G<span class="_ _0"></span>ettin<span class="_ _3"></span>g Started,<span class="_ _8"></span>” we used Linux system call number 64 to </div><div class="t m0 xd hd y820 ff2b fs7 fc3 sc0 ls1 ws1">output our “Hello W<span class="_ _1"></span>orld!” string. In this pr<span class="_ _1"></span>ogram, we will to convert the </div><div class="t m0 xd hd y821 ff2b fs7 fc3 sc0 ls1 ws1">hex digits in the register to ASCII char<span class="_ _3"></span>acters, di<span class="_ _3"></span>git by digit. ASCII is one </div><div class="t m0 xd hd y822 ff2b fs7 fc3 sc0 ls1 ws1">way tha<span class="_ _3"></span>t computers r<span class="_ _3"></span>epresent all the let<span class="_ _3"></span>ters, n<span class="_ _3"></span>umbers<span class="_ _3"></span>, and symbols that we </div><div class="t m0 xd hd y823 ff2b fs7 fc3 sc0 ls1 ws1">read, as n<span class="_ _3"></span>umbers that a comp<span class="_ _3"></span>uter can process<span class="_ _1"></span>. For instance:</div><div class="t m0 xa hd y824 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">A</span> is repr<span class="_ _1"></span>es<span class="_ _0"></span>ented b<span class="_ _3"></span>y 65.</div><div class="t m0 xa hd y825 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">B</span> by 66.</div><div class="t m0 xa hd y826 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">0</span> by 48.</div><div class="t m0 xa hd y827 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">1</span> by 49, and so on.</div><div class="t m0 xc hd y828 ff2b fs7 fc3 sc0 ls1 ws1">The key point is tha<span class="_ _3"></span>t the letters A to Z are con<span class="_ _3"></span>tiguous as ar<span class="_ _3"></span>e the </div><div class="t m0 xd hd y829 ff2b fs7 fc3 sc0 ls1 ws1">numbers 0 to 9. See Appendix D<span class="_ _1"></span>, “<span class="_ _10"></span>ASCII Character Set,<span class="_ _8"></span>” for all 255 </div><div class="t m0 xd hd y82a ff2b fs7 fc3 sc0 ls1 ws1">characters<span class="_ _1"></span>.</div><div class="t m0 xd h12 y28b ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:166.591000px;bottom:424.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:76.259700px;bottom:304.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf75" class="pf w2 h6" data-page-no="75"><div class="pc pc75 w2 h6"><img class="bi xc y82b w7 h30" alt="" src="bg75.png"/><div class="t m0 x12 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">99</div><div class="t m0 x36 h1f y82c ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _19"> </span>F<span class="_ _3"></span>or a single <span class="_ _1"></span>ASCII character that fits in one byte, enc<span class="_ _1"></span>lose it in </span></div><div class="t m0 x36 h1f y82d ff31 fse fc3 sc0 ls1 ws1">single quotes,<span class="_ _1"></span> for example,<span class="_ _1"></span> <span class="_ _3"></span>‘A<span class="_ _6"></span>’.<span class="_ _3"></span> If the <span class="_ _1"></span>ASCII characters are going to </div><div class="t m0 x36 h1f y82e ff31 fse fc3 sc0 ls1 ws1">comprise a string,<span class="_ _1"></span> use double quotes,<span class="_ _1"></span> for example,<span class="_ _3"></span> <span class="_ _1"></span>“Hello <span class="_ _1"></span>World!”.</div><div class="t m0 x1c hd y82f ff2b fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">4-7</span> is some high-level language pseudo-code for what we will </div><div class="t m0 xc hd y830 ff2b fs7 fc3 sc0 ls1 ws1">implement in Assembly Langua<span class="_ _3"></span>ge.</div><div class="t m0 xc h20 y831 ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-7. <span class="_ _15"> </span><span class="ff2b">Pseudo-code to print a r<span class="_ _3"></span>egister</span></div><div class="t m0 xc h18 y832 ff32 fs7 fc3 sc0 ls1 ws1">outstr = memory where we want the string + 9</div><div class="t m0 xc h18 y833 ff32 fs7 fc3 sc0 ls1 ws1">// (string is form 0x123456789ABCDEF0 and we want</div><div class="t m0 xc h18 y834 ff32 fs7 fc3 sc0 ls1 ws1">// the last character)</div><div class="t m0 xc h18 y835 ff32 fs7 fc3 sc0 ls1 ws1">FOR W5 = 16 TO 1 STEP -1</div><div class="t m0 xc h18 y836 ff32 fs7 fc3 sc0 ls1 ws1">      digit = X4 AND 0xf</div><div class="t m0 xc h18 y837 ff32 fs7 fc3 sc0 ls1 ws1">      IF digit &lt; 10 THEN</div><div class="t m0 xc h18 y838 ff32 fs7 fc3 sc0 ls1 ws1">           asciichar = digit + &apos;0&apos;</div><div class="t m0 xc h18 y839 ff32 fs7 fc3 sc0 ls1 ws1">      ELSE</div><div class="t m0 xc h18 y83a ff32 fs7 fc3 sc0 ls1 ws1">           asciichar = digit + &apos;A&apos; - 10</div><div class="t m0 xc h18 y83b ff32 fs7 fc3 sc0 ls1 ws1">      END IF</div><div class="t m0 xc h18 y83c ff32 fs7 fc3 sc0 ls1 ws1">      *outstr = asciichar</div><div class="t m0 xc h18 y83d ff32 fs7 fc3 sc0 ls1 ws1">      outstr = outstr - 1</div><div class="t m0 xc h18 y83e ff32 fs7 fc3 sc0 ls1 ws1">NEXT W5</div><div class="t m0 x1c hd y83f ff2b fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">4-8</span> is the Assembly Language pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>am to implement this<span class="_ _1"></span>. It </div><div class="t m0 xc hd y840 ff2b fs7 fc3 sc0 ls1 ws1">uses what we learned about loops<span class="_ _3"></span>, if/else, and logical sta<span class="_ _3"></span>tements<span class="_ _3"></span>. The file </div><div class="t m0 xc hd y841 ff2b fs7 fc3 sc0 ls1 ws1">should be printdword.s<span class="_ _1"></span>.</div><div class="t m0 xc h20 y842 ff33 fs3 fc3 sc0 ls1 ws1">Listing 4-8. <span class="_ _15"> </span><span class="ff2b">Printing a register in ASCII</span></div><div class="t m0 xc h18 y843 ff32 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y844 ff32 fs7 fc3 sc0 ls1 ws1">// Assembler program to print a register in hex</div><div class="t m0 xc h18 y845 ff32 fs7 fc3 sc0 ls1 ws1">// to stdout.</div><div class="t m0 xc h18 y846 ff32 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 x30 h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf75" data-dest-detail='[117,"XYZ",53,467,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:496.770000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf75" data-dest-detail='[117,"XYZ",53,166,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:212.270000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf76" class="pf w2 h6" data-page-no="76"><div class="pc pc76 w2 h6"><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">100</div><div class="t m0 xd h18 y46b ff32 fs7 fc3 sc0 ls1 ws1">// X0-X2 - parameters to linux function services</div><div class="t m0 xd h18 y46c ff32 fs7 fc3 sc0 ls1 ws1">// X1 - is also address of byte we are writing</div><div class="t m0 xd h18 y46d ff32 fs7 fc3 sc0 ls1 ws1">// X4 - register to print</div><div class="t m0 xd h18 y623 ff32 fs7 fc3 sc0 ls1 ws1">// W5 - loop index</div><div class="t m0 xd h18 y624 ff32 fs7 fc3 sc0 ls1 ws1">// W6 - current character</div><div class="t m0 xd h18 y625 ff32 fs7 fc3 sc0 ls1 ws1">// X8 - linux function number</div><div class="t m0 xd h18 y626 ff32 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y847 ff32 fs7 fc3 sc0 ls1 ws1">.global _start      // Provide program starting address</div><div class="t m0 xd h18 y848 ff32 fs7 fc3 sc0 ls1 ws1">_start: MOV       X4, #0x6E3A</div><div class="t m0 xd h18 y849 ff32 fs7 fc3 sc0 ls1 ws1">     MOVK   X4, #0x4F5D, LSL #16</div><div class="t m0 xd h18 y84a ff32 fs7 fc3 sc0 ls1 ws1">     MOVK   X4, #0xFEDC, LSL #32</div><div class="t m0 xd h18 y84b ff32 fs7 fc3 sc0 ls1 ws1">     MOVK   X4, #0x1234, LSL #48</div><div class="t m0 xd h18 y84c ff32 fs7 fc3 sc0 ls1 ws1">     LDR    X1, =hexstr // start of string</div><div class="t m0 xd h18 y62d ff32 fs7 fc3 sc0 ls1 ws1">     ADD    X1, X1, #17 // start at least sig digit</div><div class="t m0 xd h18 y84d ff32 fs7 fc3 sc0 ls1 ws1">// The loop is FOR W5 = 16 TO 1 STEP -1</div><div class="t m0 xd h18 y84e ff32 fs7 fc3 sc0 ls1 ws1">     MOV    W5, #16     // 16 digits to print</div><div class="t m0 xd h18 y84f ff32 fs7 fc3 sc0 ls1 ws1">loop:AND    W6, W4, #0xf // mask of least sig digit</div><div class="t m0 xd h18 y850 ff32 fs7 fc3 sc0 ls1 ws1">// If W6 &gt;= 10 then goto letter</div><div class="t m0 xd h18 y851 ff32 fs7 fc3 sc0 ls1 ws1">      CMP  W6, #10        // is 0-9 or A-F</div><div class="t m0 xd h18 y852 ff32 fs7 fc3 sc0 ls1 ws1">      B.GE letter</div><div class="t m0 xd h18 y853 ff32 fs7 fc3 sc0 ls1 ws1">// Else its a number so convert to an ASCII digit</div><div class="t m0 xd h18 y854 ff32 fs7 fc3 sc0 ls1 ws1">     ADD   W6, W6, #&apos;0&apos;</div><div class="t m0 xd h18 y855 ff32 fs7 fc3 sc0 ls1 ws1">     B     cont  // goto to end if</div><div class="t m0 xd h18 y856 ff32 fs7 fc3 sc0 ls1 ws1">letter: // handle the digits A to F</div><div class="t m0 xd h18 y857 ff32 fs7 fc3 sc0 ls1 ws1">     ADD   W6, W6, #(&apos;A&apos;-10)</div><div class="t m0 xd h18 y858 ff32 fs7 fc3 sc0 ls1 ws1">cont:// end if</div><div class="t m0 xd h18 y859 ff32 fs7 fc3 sc0 ls1 ws1">     STRB  W6, [X1]       // store ascii digit</div><div class="t m0 xd h18 y85a ff32 fs7 fc3 sc0 ls1 ws1">     SUB   X1, X1, #1     // decrement address for next digit</div><div class="t m0 xd h18 y85b ff32 fs7 fc3 sc0 ls1 ws1">     LSR   X4, X4, #4     // shift off the digit</div><div class="t m0 xd h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf77" class="pf w2 h6" data-page-no="77"><div class="pc pc77 w2 h6"><div class="t m0 x17 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">101</div><div class="t m0 xc h18 y46b ff32 fs7 fc3 sc0 ls1 ws1">     // next W5</div><div class="t m0 xc h18 y46c ff32 fs7 fc3 sc0 ls1 ws1">     SUBS   W5, W5, #1    // step W5 by -1</div><div class="t m0 xc h18 y46d ff32 fs7 fc3 sc0 ls1 ws1">     B.NE   loop          // another for loop if not done</div><div class="t m0 xc h18 y85c ff32 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print our hex number</div><div class="t m0 xc h18 y46f ff32 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 y85d ff32 fs7 fc3 sc0 ls1 ws1">     mov     X0, #1       // 1 = StdOut</div><div class="t m0 xc h18 y85e ff32 fs7 fc3 sc0 ls1 ws1">     ldr     X1, =hexstr  // string to print</div><div class="t m0 xc h18 y847 ff32 fs7 fc3 sc0 ls1 ws1">     mov     X2, #19      // length of our string</div><div class="t m0 xc h18 y85f ff32 fs7 fc3 sc0 ls1 ws1">     mov     X8, #64      // linux write system call</div><div class="t m0 xc h18 y629 ff32 fs7 fc3 sc0 ls1 ws1">     svc     0            // Call linux to output the string</div><div class="t m0 xc h18 y84a ff32 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xc h18 y84b ff32 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 y62c ff32 fs7 fc3 sc0 ls1 ws1">     mov     X0, #0      // Use 0 return code</div><div class="t m0 xc h18 y860 ff32 fs7 fc3 sc0 ls1 ws1">     mov     X8, #93     // Service code 93 terminates</div><div class="t m0 xc h18 y861 ff32 fs7 fc3 sc0 ls1 ws1">     svc     0           // Call linux to terminate</div><div class="t m0 xc h18 y84e ff32 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xc h18 y84f ff32 fs7 fc3 sc0 ls1 ws1">hexstr:      .ascii  &quot;0x123456789ABCDEFG\n&quot;</div><div class="t m0 x1c hd y862 ff2b fs7 fc3 sc0 ls1 ws1">If we compile and execute the progr<span class="_ _3"></span>am, we see</div><div class="t m0 xc h18 y863 ff32 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 4$ make</div><div class="t m0 xc h18 y864 ff32 fs7 fc3 sc0 ls1 ws1">as  printdword.s -o printdword.o</div><div class="t m0 xc h18 y865 ff32 fs7 fc3 sc0 ls1 ws1">ld -o printdword printdword.o</div><div class="t m0 xc h18 y866 ff32 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 4$ ./printdword</div><div class="t m0 xc h18 y867 ff32 fs7 fc3 sc0 ls1 ws1">0x1234FEDC4F5D6E3A</div><div class="t m0 xc h18 y868 ff32 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 4$</div><div class="t m0 x1c hd y869 ff2b fs7 fc3 sc0 ls1 ws1">as we would expect. The best way to understand this pr<span class="_ _1"></span>ogram is to </div><div class="t m0 xc hd y86a ff2b fs7 fc3 sc0 ls1 ws1">single step thr<span class="_ _3"></span>ough it in <span class="ff2f">gdb</span> and watch how it is using the r<span class="_ _1"></span>egisters and </div><div class="t m0 xc hd y86b ff2b fs7 fc3 sc0 ls1 ws1">updating memory.</div><div class="t m0 x30 h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf78" class="pf w2 h6" data-page-no="78"><div class="pc pc78 w2 h6"><img class="bi xd y86c w7 h24" alt="" src="bg78.png"/><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">102</div><div class="t m0 xc hd y275 ff2b fs7 fc3 sc0 ls1 ws1">Mak<span class="_ _3"></span>e sure y<span class="_ _3"></span>ou understand why</div><div class="t m0 xd h18 y86d ff32 fs7 fc3 sc0 ls1 ws1">AND   W6, W4, #0xf</div><div class="t m0 xc hd y86e ff2b fs7 fc3 sc0 lsc ws1">masks off the low-or<span class="_ _1"></span>der digit. Since <span class="ff2f wsc8">AND</span> requires both oper<span class="_ _3"></span>ands to be </div><div class="t m0 xd hd y86f ff2b fs7 fc3 sc0 lsc ws1">1in order to r<span class="_ _1"></span>esult in 1, and’ing something with 1s (like 0xf<span class="_ _7"></span>) keeps the other </div><div class="t m0 xd hd y870 ff2b fs7 fc3 sc0 lsc ws1">operator as is<span class="_ _1"></span>, whereas and’ing something with 0s always m<span class="_ _3"></span>akes the res<span class="_ _3"></span>ult 0.</div><div class="t m0 xc hd y871 ff2b fs7 fc3 sc0 ls1 ws1">In our loop<span class="_ _1"></span>, we shift <span class="ff2f">X4</span>, 4 bits right with</div><div class="t m0 xd h18 y872 ff32 fs7 fc3 sc0 ls1 ws1">LSR   X4, X4, #4</div><div class="t m0 xc hd y873 ff2b fs7 fc3 sc0 ls1 ws1">This shifts the next digit into position for pr<span class="_ _1"></span>ocessing in the next </div><div class="t m0 xd hd y874 ff2b fs7 fc3 sc0 ls1 ws1">iteration.</div><div class="t m0 x34 h1f y875 ff30 fse fc3 sc0 ls1 ws1">Note<span class="ff31"> <span class="_ _17"> </span>This is destructive to </span>X4<span class="ff31"> and you will lose your original </span></div><div class="t m0 x34 h1f y876 ff31 fse fc3 sc0 ls1 ws1">number during this algorithm.</div><div class="t m0 xc hd y877 ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve alr<span class="_ _1"></span>eady discussed most of the elements present in this progr<span class="_ _1"></span>am, </div><div class="t m0 xd hd y878 ff2b fs7 fc3 sc0 ls1 ws1">but there ar<span class="_ _1"></span>e a couple of new elements. They ar<span class="_ _3"></span>e as follows<span class="_ _3"></span>.</div><div class="t m0 xd ha y879 ff30 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Using Expressions inImmediate Constants</div><div class="t m0 xd h18 y87a ff32 fs7 fc3 sc0 ls1 ws1">ADD   W6, W6, #(&apos;A&apos;-10)</div><div class="t m0 xc hd y87b ff2b fs7 fc3 sc0 ls1 ws1">This demonstra<span class="_ _3"></span>tes a couple of new tricks from the GNU Assembler:</div><div class="t m0 xc hd y87c ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>W<span class="_ _1"></span>e can include AS<span class="_ _0"></span>CII char<span class="_ _1"></span>acters in imme<span class="_ _0"></span>dia<span class="_ _3"></span>te </div><div class="t m0 x1e hd y87d ff2b fs7 fc3 sc0 ls1 ws1">operands by p<span class="_ _3"></span>utting them in single quotes<span class="_ _3"></span>.</div><div class="t m0 xc hd y87e ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>W<span class="_ _1"></span>e can place simple expressions in the immediate </div><div class="t m0 x1e hd y87f ff2b fs7 fc3 sc0 ls1 ws1">operands<span class="_ _3"></span>. The preceding GNU Assembler tr<span class="_ _3"></span>anslates </div><div class="t m0 x1e hd y880 ff2b fs7 fc3 sc0 ls1 ws1">‘<span class="_ _10"></span>A<span class="_ _10"></span>’ to 65 and subtracts 10 to get 55, and we can use </div><div class="t m0 x1e hd y881 ff2b fs7 fc3 sc0 ls1 ws1">that as Oper<span class="_ _3"></span>and2.</div><div class="t m0 xd h12 y28b ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf79" class="pf w2 h6" data-page-no="79"><div class="pc pc79 w2 h6"><div class="t m0 x17 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">103</div><div class="t m0 x1c hd y145 ff2b fs7 fc3 sc0 ls1 ws1">This makes the pr<span class="_ _1"></span>ogram more reada<span class="_ _3"></span>ble, since we can see our int<span class="_ _3"></span>ent, </div><div class="t m0 xc hd y146 ff2b fs7 fc3 sc0 ls1 wsbe">rather th<span class="_ _3"></span>an if we had just coded 55 here<span class="_ _1"></span>. There is no penalty to the pr<span class="_ _3"></span>ogram </div><div class="t m0 xc hd y147 ff2b fs7 fc3 sc0 ls1 ws1">in doing this, since the wor<span class="_ _3"></span>k is done when we assemble the progr<span class="_ _3"></span>am, not </div><div class="t m0 xc hd y1b0 ff2b fs7 fc3 sc0 ls1 ws1">when we run it.</div><div class="t m0 xc ha y50e ff30 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Storing aRegister toMemor<span class="_ _0"></span>y</div><div class="t m0 xc h18 y235 ff32 fs7 fc3 sc0 ls1 ws1">STRB   W6, [X1]</div><div class="t m0 x1c hd y882 ff2b fs7 fc3 sc0 ls1 ws1">The <span class="ff2f">store byte (STRB)</span> instruction sa<span class="_ _3"></span>ves the low-or<span class="_ _3"></span>der byte of the first </div><div class="t m0 xc hd y883 ff2b fs7 fc3 sc0 ls1 ws1">register in<span class="_ _3"></span>to the memory lo<span class="_ _0"></span>ca<span class="_ _3"></span>tion contained in <span class="ff2f">X1</span>. The syntax <span class="ff2f">[X1]</span> is to </div><div class="t m0 xc hd y884 ff2b fs7 fc3 sc0 ls1 ws1">make clear tha<span class="_ _3"></span>t we are using memory indirection, and not just p<span class="_ _3"></span>utting the </div><div class="t m0 xc hd y53e ff2b fs7 fc3 sc0 ls1 ws1">byte into r<span class="_ _1"></span>egister <span class="ff2f">X1</span>. This is to make the progr<span class="_ _3"></span>am more r<span class="_ _1"></span>eadable, so we </div><div class="t m0 xc hd y53f ff2b fs7 fc3 sc0 ls1 ws1">don’t confuse this operation with a corresponding <span class="ff2f lsb wsb4">MOV</span> instruction.</div><div class="t m0 x1c hd y540 ff2b fs7 fc3 sc0 ls1 ws1">Accessing da<span class="_ _3"></span>ta in memory is the topic of Chapter <span class="fc5">5</span>, “<span class="_ _0"></span>Th<span class="_ _3"></span>anks for the </div><div class="t m0 xc hd y885 ff2b fs7 fc3 sc0 ls1 ws1">Memories,<span class="_ _8"></span>” wher<span class="_ _1"></span>e w<span class="_ _0"></span>e will go into far gr<span class="_ _3"></span>eater detail. The wa<span class="_ _3"></span>y we are storing </div><div class="t m0 xc hd y886 ff2b fs7 fc3 sc0 ls1 ws1">the byte could be made mor<span class="_ _1"></span>e efficient and we’ll look at that then.</div><div class="t m0 xc ha y887 ff30 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Why Not Print inDecimal?</div><div class="t m0 xc hd y888 ff2b fs7 fc3 sc0 ls1 ws1">In this example pr<span class="_ _3"></span>ogram<span class="_ _3"></span>, we easily convert to a hex string because using </div><div class="t m0 xc hd y889 ff2f fs7 fc3 sc0 ls1 ws1">AND<span class="ff2b"> 0xf is equivalent to getting the r<span class="_ _1"></span>emainder when dividing by 16. </span></div><div class="t m0 xc hd y88a ff2b fs7 fc3 sc0 ls1 ws1">Similarly shifting the r<span class="_ _3"></span>egister right 4 bits is equivalent to dividing b<span class="_ _1"></span>y 16. If </div><div class="t m0 xc hd y88b ff2b fs7 fc3 sc0 ls1 ws1">we wanted to convert to a decimal, base 10, string, then we would need to </div><div class="t m0 xc hd y88c ff2b fs7 fc3 sc0 ls1 ws1">be able to get the rem<span class="_ _3"></span>ainder from dividing b<span class="_ _3"></span>y 10 and later divide b<span class="_ _3"></span>y 10.</div><div class="t m0 x1c hd y88d ff2b fs7 fc3 sc0 ls1 ws1">So far<span class="_ _6"></span>, we haven’t seen a divide instruction. This places con<span class="_ _3"></span>verting </div><div class="t m0 xc hd y88e ff2b fs7 fc3 sc0 ls1 ws1">to decimal beyond the scope of this chapter<span class="_ _10"></span>, and we w<span class="_ _0"></span>ill defer division </div><div class="t m0 xc hd y88f ff2b fs7 fc3 sc0 ls1 ws1">until <span class="ff2c">Chapter</span> <span class="fc5">11</span><span class="ff2c">, “M<span class="_ _1"></span>ultiply, Div<span class="_ _0"></span>ide<span class="_ _3"></span>, and Accum<span class="_ _3"></span>ulate.<span class="ff2b">” Generally, the hex </span></span></div><div class="t m0 xc hd y890 ff2b fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esentation of r<span class="_ _1"></span>e<span class="_ _0"></span>gisters is mor<span class="_ _1"></span>e us<span class="_ _0"></span>eful to pr<span class="_ _1"></span>ogrammers anyway, and you </div><div class="t m0 xc hd y891 ff2b fs7 fc3 sc0 ls1 ws1">can always con<span class="_ _1"></span>ver<span class="_ _0"></span>t it to any forma<span class="_ _3"></span>t you like with the Gnome calculator<span class="_ _10"></span>.</div><div class="t m0 x30 h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:302.238000px;bottom:361.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:118.173000px;bottom:153.362000px;width:11.000000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf7a" class="pf w2 h6" data-page-no="7a"><div class="pc pc7a w2 h6"><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">104</div><div class="t m0 xd h15 y186 ff30 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>P<span class="_ _1"></span>erformance ofBranch Instructions</div><div class="t m0 xd hd y187 ff2b fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>Getting Started,<span class="_ _8"></span>” we mentioned that the ARM 64-bit </div><div class="t m0 xd hd y188 ff2b fs7 fc3 sc0 ls1 ws1">instruction set is executed in an instruction pipeline. Individually, an </div><div class="t m0 xd hd y2be ff2b fs7 fc3 sc0 ls1 ws1">instruction requires thr<span class="_ _1"></span>ee clock c<span class="_ _0"></span>ycles to execute<span class="_ _1"></span>, one for each of the </div><div class="t m0 xd hd y18a ff2b fs7 fc3 sc0 ls1 ws1">following:</div><div class="t m0 xc hd y892 ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Load the instruction from memor<span class="_ _0"></span>y to the CPU<span class="_ _1"></span>.</div><div class="t m0 xc hd y893 ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Decode the instruction.</div><div class="t m0 xc hd y894 ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Execute the instruction.</div><div class="t m0 xc hd y895 ff2b fs7 fc3 sc0 ls1 ws1">However<span class="_ _10"></span>, the CPU works on three instructions at once, each a<span class="_ _3"></span>t a </div><div class="t m0 xd hd y896 ff2b fs7 fc3 sc0 ls1 ws1">different s<span class="_ _3"></span>tep<span class="_ _1"></span>, so on average we execute one instruction every clock c<span class="_ _0"></span>ycle<span class="_ _1"></span>. </div><div class="t m0 xd hd y897 ff2b fs7 fc3 sc0 ls1 ws1">But what h<span class="_ _3"></span>appens when we branch?</div><div class="t m0 xc hd y898 ff2b fs7 fc3 sc0 ls1 ws1">When we execute the branch, we<span class="_ _3"></span>’<span class="_ _3"></span>ve already decoded the next </div><div class="t m0 xd hd y899 ff2b fs7 fc3 sc0 ls1 ws1">instruction and loaded the instruction two ahead. When we branch, we </div><div class="t m0 xd hd y3b2 ff2b fs7 fc3 sc0 ls1 ws1">throw this wor<span class="_ _3"></span>k awa<span class="_ _1"></span>y and star<span class="_ _0"></span>t o<span class="_ _3"></span>ver<span class="_ _6"></span>. This means tha<span class="_ _3"></span>t the instruction after </div><div class="t m0 xd hd y89a ff2b fs7 fc3 sc0 ls1 ws1">the branch will take thr<span class="_ _3"></span>ee clock cycles to execute. N<span class="_ _3"></span>ewer ARM processors </div><div class="t m0 xd hd y89b ff2b fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve more sophistica<span class="_ _3"></span>ted, longer pipelines and can sometimes continue b<span class="_ _3"></span>y </div><div class="t m0 xd hd y89c ff2b fs7 fc3 sc0 ls1 ws1">guessing which branc<span class="_ _3"></span>h will be taken, but ultimately you c<span class="_ _3"></span>an overload these </div><div class="t m0 xd hd y89d ff2b fs7 fc3 sc0 ls1 ws1">mechanisms and cause a pipeline stall.</div><div class="t m0 xc hd y89e ff2b fs7 fc3 sc0 ls1 ws1">If you put a lot of br<span class="_ _3"></span>anches in your code, y<span class="_ _3"></span>ou suffer a performance </div><div class="t m0 xd hd y89f ff2b fs7 fc3 sc0 ls1 ws1">penalty, perhaps slo<span class="_ _3"></span>wing your progr<span class="_ _1"></span>am by a factor of three. Another </div><div class="t m0 xd hd y8a0 ff2b fs7 fc3 sc0 ls1 ws1">problem is tha<span class="_ _3"></span>t if you pr<span class="_ _3"></span>ogram with a lot of branches<span class="_ _1"></span>, this leads to </div><div class="t m0 xd hd y8a1 ff2f fs7 fc3 sc0 ls1 ws1">spaghetti code<span class="ff2b">—meaning all the lines of code are tangled together like a </span></div><div class="t m0 xd hd y8a2 ff2b fs7 fc3 sc0 ls1 ws1">pot of spaghetti, understandably quite h<span class="_ _3"></span>ard to m<span class="_ _3"></span>aintain.</div><div class="t m0 xc hd y8a3 ff2b fs7 fc3 sc0 ls1 ws1">When I first learned to progr<span class="_ _3"></span>am in high school and my undergr<span class="_ _3"></span>aduate </div><div class="t m0 xd hd y8a4 ff2b fs7 fc3 sc0 ls1 ws1">years before structur<span class="_ _1"></span>e<span class="_ _0"></span>d pr<span class="_ _3"></span>ogramming w<span class="_ _3"></span>as av<span class="_ _3"></span>ailable, I used the Basic and </div><div class="t m0 xd hd y8a5 ff2b fs7 fc3 sc0 ls1 ws1">Fortr<span class="_ _3"></span>an progr<span class="_ _3"></span>amming languages to write complex code<span class="_ _3"></span>. I know firsthand </div><div class="t m0 xd hd y8a6 ff2b fs7 fc3 sc0 ls1 ws1">that deciphering pr<span class="_ _3"></span>ograms full of branches is a ch<span class="_ _3"></span>allenge.</div><div class="t m0 xd h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.502600px;bottom:547.090000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf7b" class="pf w2 h6" data-page-no="7b"><div class="pc pc7b w2 h6"><div class="t m0 x17 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">105</div><div class="t m0 x1c hd y145 ff2b fs7 fc3 sc0 ls1 ws1">Early high-level pr<span class="_ _3"></span>ogramming langua<span class="_ _3"></span>ges relied on the <span class="ff2f ls8 ws9f">goto</span> </div><div class="t m0 xc hd y146 ff2b fs7 fc3 sc0 ls1 ws1">statement th<span class="_ _3"></span>at led to har<span class="_ _3"></span>d to understand code; this led to the structured </div><div class="t m0 xc hd y147 ff2b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming we see in modern high-level languages that don’t need a </div><div class="t m0 xc hd y1b0 ff2b fs7 fc3 sc0 ls1 ws1">goto statement<span class="_ _3"></span>. W<span class="_ _1"></span>e can’t entirely do a<span class="_ _3"></span>way with branc<span class="_ _3"></span>hes, since ARM 64 </div><div class="t m0 xc hd y1b1 ff2b fs7 fc3 sc0 ls1 ws1">doesn’t ha<span class="_ _3"></span>ve structured pr<span class="_ _3"></span>ogramming constructs<span class="_ _1"></span>, but we ne<span class="_ _0"></span>ed to structur<span class="_ _3"></span>e </div><div class="t m0 xc hd y1b2 ff2b fs7 fc3 sc0 ls1 ws1">our code along these lines to make it both mor<span class="_ _3"></span>e efficient and easier to </div><div class="t m0 xc hd y1b3 ff2b fs7 fc3 sc0 ls1 ws1">read—another gr<span class="_ _1"></span>eat use for a few goo<span class="_ _0"></span>d design pa<span class="_ _3"></span>tterns.</div><div class="t m0 xc h15 y8a7 ff30 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>More Comparison Instructions</div><div class="t m0 xc hd y8a8 ff2b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e looked at the <span class="ff2f">CMP</span> instruction, which is the main comparison </div><div class="t m0 xc hd y8a9 ff2b fs7 fc3 sc0 ls1 ws1">instruction; however<span class="_ _6"></span>, there ar<span class="_ _1"></span>e t<span class="_ _0"></span>wo mor<span class="_ _3"></span>e:</div><div class="t m0 x1e hd y8aa ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>CMN Xn, Operand2</div><div class="t m0 x1e hd y8ab ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>TST Xn, Operand2</div><div class="t m0 x1c hd y8ac ff2b fs7 fc3 sc0 ls1 ws1">Remember that the <span class="ff2f">CMP</span> ins<span class="_ _3"></span>truction subtracted Operand2 fr<span class="_ _3"></span>om <span class="ff2f lsb wsb4">Xn</span> </div><div class="t m0 xc hd y8ad ff2b fs7 fc3 sc0 ls1 ws1">and set the condition flags accordingly. T<span class="_ _3"></span>he result of the subtr<span class="_ _1"></span>action is </div><div class="t m0 xc hd y8ae ff2b fs7 fc3 sc0 ls1 ws1">discarded. These thr<span class="_ _3"></span>ee instructions work the same way, except they use an </div><div class="t m0 xc hd y8af ff2b fs7 fc3 sc0 ls1 ws1">operation differ<span class="_ _1"></span>ent from subtraction.</div><div class="t m0 x1c hd y8b0 ff2b fs7 fc3 sc0 ls1 ws1">The Assembler has the ability to switch between the three comp<span class="_ _3"></span>arison </div><div class="t m0 xc hd y8b1 ff2b fs7 fc3 sc0 ls1 ws1">instructions to finesse some extra values for Operand2, which otherwise </div><div class="t m0 xc hd y8b2 ff2b fs7 fc3 sc0 ls1 ws1">would be impossible. I<span class="_ _3"></span>n this book, we’ll just use <span class="ff2f">CMP</span>, but y<span class="_ _3"></span>ou can use </div><div class="t m0 xc hd y8b3 ff2b fs7 fc3 sc0 ls1 ws1">these if you find an application, plus it’<span class="_ _6"></span>s worth being aware of these in case </div><div class="t m0 xc hd y8b4 ff2b fs7 fc3 sc0 ls1 ws1">the Assembler does a substitution. The other two ar<span class="_ _3"></span>e</div><div class="t m0 x1e hd y8b5 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f">CMN</span>: Uses addition instead of subtr<span class="_ _3"></span>action. The N </div><div class="t m0 x9 hd y8b6 ff2b fs7 fc3 sc0 ls1 ws1">indicates it’<span class="_ _6"></span>s the negative (<span class="_ _3"></span>opposite) of CMP<span class="_ _8"></span>.</div><div class="t m0 x1e hd y8b7 ff2b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff2f ls1c wsbf">TST</span>: Performs a bitw<span class="_ _0"></span>ise AND operation between Xn </div><div class="t m0 x9 hd y8b8 ff2b fs7 fc3 sc0 ls1 ws1">and Operand2. I<span class="_ _3"></span>t updates the flags based on the r<span class="_ _3"></span>esult.</div><div class="t m0 x30 h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf7c" class="pf w2 h6" data-page-no="7c"><div class="pc pc7c w2 h6"><div class="t m0 xd hd y3f ff2b fs7 fc3 sc0 ls1 ws1">106</div><div class="t m0 xd h15 y186 ff30 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y187 ff2b fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we studied the key instructions for perfor<span class="_ _0"></span>ming pr<span class="_ _3"></span>ogram </div><div class="t m0 xd hd y188 ff2b fs7 fc3 sc0 ls1 ws1">logic with loops and if statements<span class="_ _3"></span>. These included the instructions for </div><div class="t m0 xd hd y2be ff2b fs7 fc3 sc0 ls1 ws1">comparisons and conditional branching. W<span class="_ _1"></span>e discussed several design </div><div class="t m0 xd hd y18a ff2b fs7 fc3 sc0 ls1 ws1">patterns to code the common constructs from hi<span class="_ _3"></span>gh-level progr<span class="_ _3"></span>amming </div><div class="t m0 xd hd y18b ff2b fs7 fc3 sc0 ls1 ws1">languages in Assembly. W<span class="_ _1"></span>e looked at the statemen<span class="_ _3"></span>ts for logically working </div><div class="t m0 xd hd y732 ff2b fs7 fc3 sc0 ls1 ws1">with the bits in a register<span class="_ _10"></span>. We examined ho<span class="_ _3"></span>w we could output the conten<span class="_ _3"></span>ts </div><div class="t m0 xd hd y733 ff2b fs7 fc3 sc0 ls1 ws1">of a register in hexadecimal forma<span class="_ _3"></span>t.</div><div class="t m0 xc hd y734 ff2b fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">5</span>, “Thanks for the M<span class="_ _3"></span>emories,<span class="_ _8"></span>” we’ll look at the details of </div><div class="t m0 xd hd y735 ff2b fs7 fc3 sc0 ls1 ws1">how to load data to and fr<span class="_ _1"></span>om memor<span class="_ _0"></span>y.</div><div class="t m0 xd h15 y8b9 ff30 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y8ba ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Go through T<span class="_ _6"></span>able<span class="fc5">4-1</span> of condition codes and ensur<span class="_ _3"></span>e </div><div class="t m0 x1e hd y8bb ff2b fs7 fc3 sc0 ls1 ws1">you understand why eac<span class="_ _3"></span>h one is named the way it is<span class="_ _1"></span>.</div><div class="t m0 xc hd y8bc ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Create an Assembl<span class="_ _3"></span>y Language framewor<span class="_ _3"></span>k to </div><div class="t m0 x1e hd y8bd ff2b fs7 fc3 sc0 ls1 ws1">implement a SELECT/CASE construct. The format is</div><div class="t m0 x1e h18 y8be ff32 fs7 fc3 sc0 ls1 ws1">SELECT number</div><div class="t m0 x1e h18 y8bf ff32 fs7 fc3 sc0 ls1 ws1">   CASE 1:</div><div class="t m0 x1e h18 y8c0 ff32 fs7 fc3 sc0 ls1 ws1">        &lt;&lt; statements if number is 1 &gt;&gt;</div><div class="t m0 x1e h18 y8c1 ff32 fs7 fc3 sc0 ls1 ws1">   CASE 2:</div><div class="t m0 x1e h18 y8c2 ff32 fs7 fc3 sc0 ls1 ws1">        &lt;&lt; statements if number is 2&gt;&gt;</div><div class="t m0 x1e h18 y8c3 ff32 fs7 fc3 sc0 ls1 ws1">   CASE ELSE:</div><div class="t m0 x1e h18 y8c4 ff32 fs7 fc3 sc0 ls1 ws1">        &lt;&lt; statements if not any other case &gt;&gt;</div><div class="t m0 x1e h18 y8c5 ff32 fs7 fc3 sc0 ls1 ws1">END SELECT</div><div class="t m0 xd h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:435.090000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6d" data-dest-detail='[109,"XYZ",53,514,null]'><div class="d m1" style="border-style:none;position:absolute;left:166.569000px;bottom:341.090000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf7d" class="pf w2 h6" data-page-no="7d"><div class="pc pc7d w2 h6"><div class="t m0 x17 hd y3f ff2b fs7 fc3 sc0 ls1 ws1">107</div><div class="t m0 x1c hd y145 ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Construct a D<span class="_ _0"></span>O/WHILE statemen<span class="_ _3"></span>t in Assembly </div><div class="t m0 x9 hd y146 ff2b fs7 fc3 sc0 ls1 ws1">Language<span class="_ _3"></span>. In this case<span class="_ _3"></span>, the loop always executes </div><div class="t m0 x9 hd y147 ff2b fs7 fc3 sc0 ls1 ws1">once before the condition is tested:</div><div class="t m0 x9 h18 y2d7 ff32 fs7 fc3 sc0 ls1 ws1">DO</div><div class="t m0 x9 h18 y2e2 ff32 fs7 fc3 sc0 ls1 ws1">   &lt;&lt; statements in the loop &gt;&gt;</div><div class="t m0 x9 h18 y60e ff32 fs7 fc3 sc0 ls1 ws1">UNTIL condition</div><div class="t m0 x1c hd y2da ff2b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Modify the preceding printdwor<span class="_ _1"></span>d program to print </div><div class="t m0 x9 hd y231 ff2b fs7 fc3 sc0 ls1 ws1">the hex repr<span class="_ _1"></span>es<span class="_ _0"></span>enta<span class="_ _3"></span>tion of a 32-bit <span class="ff2f">W</span> register<span class="_ _10"></span>.</div><div class="t m0 x30 h12 y71 ff31 fsa fc3 sc0 ls1 ws1">CHAPTER 4 <span class="_ _f"> </span> CONTROLLING PROGRAM FLOW</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf7e" class="pf w2 h6" data-page-no="7e"><div class="pc pc7e w2 h6"><div class="t m0 x17 hd y16a ff34 fs7 fc3 sc0 ls1 ws1">109</div><div class="t m0 xc h17 y16b ff34 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff34 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff35">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff34">,  </span></span></div><div class="t m0 xc h17 y16d ff34 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_5</div><div class="t m0 xc ha y16e ff36 fs6 fc3 sc0 ls1 ws1">CHAPTER 5</div><div class="t m0 xc h8 y16f ff37 fs4 fc3 sc0 ls1 ws1">Thanks f<span class="_ _1"></span>orthe </div><div class="t m0 xc h8 y747 ff37 fs4 fc3 sc0 ls1 ws1">Memories</div><div class="t m0 xc hd y748 ff34 fs7 fc3 sc0 ls12 ws1">In this chapter<span class="_ _10"></span>, we discuss the ARM<span class="_ _3"></span>-based computer’<span class="_ _1"></span>s memory. So far<span class="_ _6"></span>, w<span class="_ _0"></span>e<span class="_ _3"></span>’ve </div><div class="t m0 xc hd y749 ff34 fs7 fc3 sc0 ls12 ws1">used memor<span class="_ _0"></span>y to hold our Assembly instructions; now we will look in detail<span class="_ _0"></span> </div><div class="t m0 xc hd y74a ff34 fs7 fc3 sc0 ls12 ws1">at how to define da<span class="_ _3"></span>ta in memory, then how to load memor<span class="_ _0"></span>y into r<span class="_ _3"></span>egisters for </div><div class="t m0 xc hd y74b ff34 fs7 fc3 sc0 ls12 ws1">processing<span class="_ _3"></span>, and, finally, how to write the r<span class="_ _3"></span>esults back to memory.</div><div class="t m0 x1c hd y74c ff34 fs7 fc3 sc0 ls24 ws1">The ARM processor uses wha<span class="_ _3"></span>t is called a <span class="ff38">load-store architecture</span><span class="ls1">. </span></div><div class="t m0 xc hd y74d ff34 fs7 fc3 sc0 ls24 ws1">This means that the instruction set is divided into two cat<span class="_ _3"></span>egories<span class="_ _0"></span>: one </div><div class="t m0 xc hd y74e ff34 fs7 fc3 sc0 ls24 ws1">to load and store v<span class="_ _3"></span>alues from and to memory and the other to perform </div><div class="t m0 xc hd y74f ff34 fs7 fc3 sc0 ls24 ws1">arithmetic and logical operations between the registers<span class="_ _1"></span>. W<span class="_ _3"></span>e’<span class="_ _1"></span>ve spent most </div><div class="t m0 xc hd y8c6 ff34 fs7 fc3 sc0 ls24 ws1">of our time looking at the arithmetic and logical opera<span class="_ _3"></span>tions. N<span class="_ _1"></span>ow we will </div><div class="t m0 xc hd y8c7 ff34 fs7 fc3 sc0 ls24 ws1">look at the other category.</div><div class="t m0 x1c hd y8c8 ff34 fs7 fc3 sc0 ls1 ws1">Memory addresses are 64 bits while instructions ar<span class="_ _3"></span>e 32 bits, so we </div><div class="t m0 xc hd y8c9 ff34 fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve the same problems th<span class="_ _3"></span>at we experienced in Chapter <span class="fc5">2</span>, “Loading and </div><div class="t m0 xc hd y8ca ff34 fs7 fc3 sc0 ls1 ws1">Adding,<span class="_ _8"></span>” wher<span class="_ _3"></span>e we used all sorts of tr<span class="_ _0"></span>icks to load 64 bits in<span class="_ _3"></span>to a register </div><div class="t m0 xc hd y8cb ff34 fs7 fc3 sc0 ls1 ws1">using a 32-bit instruction. In this chapter<span class="_ _10"></span>, we’ll use these same tricks for </div><div class="t m0 xc hd y8cc ff34 fs7 fc3 sc0 ls1 ws1">loading addresses<span class="_ _1"></span>, along with a few new ones, the goal being to load a  </div><div class="t m0 xc hd y8cd ff34 fs7 fc3 sc0 ls1 ws1">64- <span class="_ _b"></span>bit address in one instruction in as many c<span class="_ _3"></span>ases as we can.</div><div class="t m0 x1c hd y8ce ff34 fs7 fc3 sc0 ls1 ws1">The ARM instruction set has some powerful instructions to access </div><div class="t m0 xc hd y8cf ff34 fs7 fc3 sc0 ls1 ws1">memory, including several techniques to access arrays of data structur<span class="_ _1"></span>es </div><div class="t m0 xc hd y8d0 ff34 fs7 fc3 sc0 ls1 ws1">and to incremen<span class="_ _3"></span>t pointers in loops while loading or storing data<span class="_ _3"></span>.</div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:318.447000px;bottom:236.802000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf7f" class="pf w2 h6" data-page-no="7f"><div class="pc pc7f w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">110</div><div class="t m0 xd h15 y186 ff39 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Defining Memor<span class="_ _0"></span>y Contents</div><div class="t m0 xd hd y187 ff34 fs7 fc3 sc0 ls1 ws1">Before loading and storing memory, first we need to define some memor<span class="_ _0"></span>y </div><div class="t m0 xd hd y188 ff34 fs7 fc3 sc0 ls1 ws1">to operate on. The GNU Assembler con<span class="_ _3"></span>tains several dir<span class="_ _3"></span>ectives to help you </div><div class="t m0 xd hd y2be ff34 fs7 fc3 sc0 ls1 ws1">define memory to us<span class="_ _0"></span>e in your pr<span class="_ _1"></span>ogram. These appear in a .data section </div><div class="t m0 xd hd y18a ff34 fs7 fc3 sc0 ls1 ws1">of your pr<span class="_ _3"></span>ogram. W<span class="_ _1"></span>e’ll look a<span class="_ _3"></span>t some examples and then summarize in </div><div class="t m0 xd hd y18b ff34 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>able<span class="fc5">5-1</span>. Listing <span class="fc5">5-1</span> starts us off by sho<span class="_ _3"></span>wing us how to define b<span class="_ _3"></span>ytes, wor<span class="_ _1"></span>ds, </div><div class="t m0 xd hd y732 ff34 fs7 fc3 sc0 ls1 ws1">64-bit integers, and ASCII strings<span class="_ _3"></span>.</div><div class="t m0 xd h20 y8d1 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-1. <span class="_ _15"> </span><span class="ff34">Some sample memor<span class="_ _0"></span>y dir<span class="_ _1"></span>e<span class="_ _0"></span>ctives</span></div><div class="t m0 xd h18 y8d2 ff3b fs7 fc3 sc0 ls1 ws1">label: .byte 74, 0112, 0b00101010, 0x4A, 0X4a, &apos;J&apos;, &apos;H&apos; + 2</div><div class="t m0 xd h18 y8d3 ff3b fs7 fc3 sc0 ls1 ws1">       .word 0x1234ABCD, -1434</div><div class="t m0 xd h18 y8d4 ff3b fs7 fc3 sc0 ls1 ws1">       .quad 0x123456789ABCDEF0</div><div class="t m0 xd h18 y8d5 ff3b fs7 fc3 sc0 ls1 ws1">       .ascii      &quot;Hello World\n&quot;</div><div class="t m0 xc hd y8d6 ff34 fs7 fc3 sc0 ls1 ws1">The first line defines 7 bytes all with the same value<span class="_ _1"></span>. We c<span class="_ _3"></span>an define our </div><div class="t m0 xd hd y8d7 ff34 fs7 fc3 sc0 ls1 ws1">bytes in decimal, octal (base 8), binary, hex<span class="_ _0"></span>, or ASCII.Anywhere we define </div><div class="t m0 xd hd y8d8 ff34 fs7 fc3 sc0 ls1 ws1">numbers<span class="_ _3"></span>, we can use expressions th<span class="_ _3"></span>at the Assembler will evaluate when it </div><div class="t m0 xd hd y8d9 ff34 fs7 fc3 sc0 ls1 ws1">compiles our pr<span class="_ _3"></span>ogram.</div><div class="t m0 xc hd y8da ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e start most memor<span class="_ _0"></span>y directives with a label, so we can access it fr<span class="_ _3"></span>om </div><div class="t m0 xd hd y8db ff34 fs7 fc3 sc0 ls1 ws1">the code. The only exception is if we ar<span class="_ _1"></span>e defining a larger array of numbers </div><div class="t m0 xd hd y8dc ff34 fs7 fc3 sc0 ls1 ws1">that extends o<span class="_ _1"></span>ver several lines.</div><div class="t m0 xc hd y8dd ff34 fs7 fc3 sc0 ls1 ws1">The .byte sta<span class="_ _3"></span>tement defines 1 or mor<span class="_ _3"></span>e bytes of memory. Listing <span class="fc5">5-1</span> </div><div class="t m0 xd hd y8de ff34 fs7 fc3 sc0 ls1 ws1">shows the various formats we can use for the conten<span class="_ _3"></span>ts of each byte<span class="_ _1"></span>, as </div><div class="t m0 xd hd y8df ff34 fs7 fc3 sc0 ls1 ws1">follows<span class="_ _0"></span>:</div><div class="t m0 xa hd y8e0 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A decimal integer starts with a nonzero digit and </div><div class="t m0 x1e hd y8e1 ff34 fs7 fc3 sc0 ls1 ws1">contains decimal digits 0–9.</div><div class="t m0 xa hd y8e2 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>An octal integer starts with zero and contains octal </div><div class="t m0 x1e hd y8e3 ff34 fs7 fc3 sc0 ls1 ws1">digits 0–7.</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf81" data-dest-detail='[129,"XYZ",55,592,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.724800px;bottom:483.090000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7f" data-dest-detail='[127,"XYZ",35,453,null]'><div class="d m1" style="border-style:none;position:absolute;left:117.833000px;bottom:483.090000px;width:15.047000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7f" data-dest-detail='[127,"XYZ",35,453,null]'><div class="d m1" style="border-style:none;position:absolute;left:349.280000px;bottom:230.590000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf80" class="pf w2 h6" data-page-no="80"><div class="pc pc80 w2 h6"><img class="bi xc y8e4 w7 h24" alt="" src="bg80.png"/><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">111</div><div class="t m0 x1e hd y275 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A binary integer starts with 0b or 0B and contains </div><div class="t m0 x9 hd y276 ff34 fs7 fc3 sc0 ls1 ws1">binary digits 0–1.</div><div class="t m0 x1e hd y8e5 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A hex integer starts with 0x or 0X and contains hex </div><div class="t m0 x9 hd y8e6 ff34 fs7 fc3 sc0 ls1 ws1">digits 0–F<span class="_ _8"></span>.</div><div class="t m0 x1e hd y8e7 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A floating-<span class="_ _1"></span>point number starts with 0f or 0e followed by </div><div class="t m0 x9 hd y8e8 ff34 fs7 fc3 sc0 ls1 ws1">a floating-<span class="_ _1"></span>point number<span class="_ _6"></span>.</div><div class="t m0 x36 h1f y8e9 ff39 fse fc3 sc0 ls1 ws1">Note<span class="ff3c"> <span class="_ _19"> </span>Be careful not to start decimal numbers with zero (0),<span class="_ _1"></span> since </span></div><div class="t m0 x36 h1f y8ea ff3c fse fc3 sc0 ls1 ws1">this indicates the constant is an octal (base 8) number<span class="_ _6"></span>.</div><div class="t m0 x1c hd y8eb ff34 fs7 fc3 sc0 ls1 ws1">The example then shows how t<span class="_ _3"></span>o define a word, a quad (64-bit integer), </div><div class="t m0 xc hd y8ec ff34 fs7 fc3 sc0 ls1 ws1">and an ASCII string, as we saw in our HelloW<span class="_ _1"></span>orld progr<span class="_ _1"></span>am in Chapter <span class="fc5">1</span>, </div><div class="t m0 xc hd y8ed ff34 fs7 fc3 sc0 ls1 ws1">“<span class="_ _3"></span>Getting Started.<span class="_ _8"></span>” There ar<span class="_ _3"></span>e two prefix oper<span class="_ _3"></span>ators we can place in fr<span class="_ _3"></span>ont of an </div><div class="t m0 xc hd y8ee ff34 fs7 fc3 sc0 ls1 ws1">integer<span class="_ _0"></span>:</div><div class="t m0 x1e hd y8ef ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Nega<span class="_ _3"></span>tive (-) will take the two<span class="_ _1"></span>’<span class="_ _1"></span>s complement of the </div><div class="t m0 x9 hd y8f0 ff34 fs7 fc3 sc0 ls1 ws1">integer<span class="_ _6"></span>.</div><div class="t m0 x1e hd y8f1 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Complement (~) will take the one<span class="_ _3"></span>’<span class="_ _6"></span>s complement of the </div><div class="t m0 x9 hd y8f2 ff34 fs7 fc3 sc0 ls1 ws1">integer<span class="_ _6"></span>.</div><div class="t m0 x1c hd y8f3 ff34 fs7 fc3 sc0 ls1 ws1">For exam<span class="_ _3"></span>ple:</div><div class="t m0 xc h18 y8f4 ff3b fs7 fc3 sc0 ls1 ws1">.byte -0x45, -33, ~0b00111001</div><div class="t m0 x1c hd y8f5 ff34 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>able <span class="fc5">5-1</span> lists the various data types we can define this wa<span class="_ _1"></span>y.</div><div class="t m0 x42 h12 y28b ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:379.221000px;bottom:380.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf81" data-dest-detail='[129,"XYZ",55,592,null]'><div class="d m1" style="border-style:none;position:absolute;left:99.730600px;bottom:202.362000px;width:15.048400px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf81" class="pf w2 h6" data-page-no="81"><div class="pc pc81 w2 h6"><img class="bi x43 y8f6 wf h3a" alt="" src="bg81.png"/><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">112</div><div class="t m0 xc hd y8f7 ff34 fs7 fc3 sc0 ls1 ws1">If we want to define a larger set of memory, there are a couple of </div><div class="t m0 xd hd y8f8 ff34 fs7 fc3 sc0 ls1 ws1">mechanisms to do this without ha<span class="_ _3"></span>ving to list and count them all, s<span class="_ _3"></span>uch as</div><div class="t m0 xd h18 y8f9 ff3b fs7 fc3 sc0 ls1 ws1">.fill    repeat, size, value</div><div class="t m0 xc hd y8fa ff34 fs7 fc3 sc0 ls1 ws1">This repea<span class="_ _3"></span>ts a value of a given size<span class="_ _3"></span>, repea<span class="_ _3"></span>t times, for example:</div><div class="t m0 xd h18 y8fb ff3b fs7 fc3 sc0 ls1 ws1">zeros:    .fill    10, 4, 0</div><div class="t m0 xc hd y8fc ff34 fs7 fc3 sc0 ls1 ws1">crea<span class="_ _3"></span>tes a block of memory w<span class="_ _0"></span>ith 10 4-b<span class="_ _3"></span>yte words all with a value of zer<span class="_ _3"></span>o<span class="_ _1"></span>. </div><div class="t m0 xd hd y8fd ff34 fs7 fc3 sc0 ls1 ws1">The following code</div><div class="t m0 xd h18 y8fe ff3b fs7 fc3 sc0 ls1 ws1">.rept count</div><div class="t m0 xd h18 y8ff ff3b fs7 fc3 sc0 ls1 ws1">...</div><div class="t m0 xd h18 y900 ff3b fs7 fc3 sc0 ls1 ws1">.endr</div><div class="t m0 xc hd y901 ff34 fs7 fc3 sc0 ls1 ws1">repeats the s<span class="_ _3"></span>tatements between .rept and .endr<span class="_ _10"></span>, count times. This c<span class="_ _3"></span>an </div><div class="t m0 xd hd y902 ff34 fs7 fc3 sc0 ls1 ws1">surround any code in yo<span class="_ _3"></span>ur Assembly, for instance<span class="_ _3"></span>, you can mak<span class="_ _3"></span>e a loop by </div><div class="t m0 xd hd y903 ff34 fs7 fc3 sc0 ls1 ws1">repeatin<span class="_ _3"></span>g your code count times<span class="_ _1"></span>, for example:</div><div class="t m0 x43 h3b y904 ff3a fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 5-1. <span class="_ _15"> </span><span class="ff35">The list of memory definition Assembler directives</span></div><div class="t m0 x43 h10 y905 ff39 fs7 fc3 sc0 ls1 ws1">Directive<span class="_ _41"> </span>Description</div><div class="t m0 x43 h10 y906 ff39 fs7 fc3 sc0 ls1 ws1">.ascii<span class="_ _42"> </span><span class="ff3c">A string contained in double quotes</span></div><div class="t m0 x43 h10 y907 ff39 fs7 fc3 sc0 ls1 ws1">.asciz<span class="_ _43"> </span><span class="ff3c">A 0-byte terminated ascii string</span></div><div class="t m0 x43 h10 y908 ff39 fs7 fc3 sc0 ls1 ws1">.byte<span class="_ _44"> </span><span class="ff3c">1-byte integers</span></div><div class="t m0 x43 h10 y909 ff39 fs7 fc3 sc0 ls1 ws1">.double<span class="_ _45"> </span><span class="ff3c">Double-precision floating-point values</span></div><div class="t m0 x43 h10 y90a ff39 fs7 fc3 sc0 ls1 ws1">.float<span class="_ _46"> </span><span class="ff3c">Floating-point values</span></div><div class="t m0 x43 h10 y90b ff39 fs7 fc3 sc0 ls1 ws1">.octa<span class="_ _44"> </span><span class="ff3c">16-byte integers</span></div><div class="t m0 x43 h10 y90c ff39 fs7 fc3 sc0 ls1 ws1">.quad<span class="_ _47"> </span><span class="ff3c">8-byte integers</span></div><div class="t m0 x43 h10 y90d ff39 fs7 fc3 sc0 ls1 ws1">.short<span class="_ _43"> </span><span class="ff3c">2-byte integers</span></div><div class="t m0 x43 h10 y90e ff39 fs7 fc3 sc0 ls1 ws1">.word<span class="_ _48"> </span><span class="ff3c">4-byte integers</span></div><div class="t m0 xd h12 y668 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf82" class="pf w2 h6" data-page-no="82"><div class="pc pc82 w2 h6"><img class="bi xc y90f w10 h3c" alt="" src="bg82.png"/><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">113</div><div class="t m0 xc h18 y46b ff3b fs7 fc3 sc0 ls1 ws1">rpn: .rept 3</div><div class="t m0 xc h18 y46c ff3b fs7 fc3 sc0 ls1 ws1">     .byte    0, 1, 2</div><div class="t m0 xc h18 y46d ff3b fs7 fc3 sc0 ls1 ws1">     .endr</div><div class="t m0 x1c hd y46e ff34 fs7 fc3 sc0 ls1 ws1">is translated to</div><div class="t m0 xc h18 y910 ff3b fs7 fc3 sc0 ls1 ws1">.byte    0, 1, 2</div><div class="t m0 xc h18 y470 ff3b fs7 fc3 sc0 ls1 ws1">.byte    0, 1, 2</div><div class="t m0 xc h18 y471 ff3b fs7 fc3 sc0 ls1 ws1">.byte    0, 1, 2</div><div class="t m0 x1c hd y911 ff34 fs7 fc3 sc0 ls1 ws1">In ASCII strings, we’<span class="_ _1"></span>ve seen the special character “\n” for new line. </div><div class="t m0 xc hd y912 ff34 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e a few more for common unprintable char<span class="_ _3"></span>acters as well as to give </div><div class="t m0 xc hd y474 ff34 fs7 fc3 sc0 ls1 ws1">us an ability to put double quotes in our strings<span class="_ _1"></span>. The “\” is called an escape </div><div class="t m0 xc hd y475 ff34 fs7 fc3 sc0 ls1 ws1">character<span class="_ _10"></span>, which is a metacharacter to define special cases<span class="_ _3"></span>. T<span class="_ _10"></span>able<span class="fc5">5-2</span> lists </div><div class="t m0 xc hd y476 ff34 fs7 fc3 sc0 ls1 ws1">the escape charact<span class="_ _3"></span>er sequences supported by the GNU Assembler<span class="_ _6"></span>.</div><div class="t m0 xc h3b y913 ff3a fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 5-2. <span class="_ _15"> </span><span class="ff35">ASCII escape character sequence codes</span></div><div class="t m0 xc h10 y914 ff39 fs7 fc3 sc0 ls1 ws1">Escape Character Sequence<span class="_ _49"> </span>Description</div><div class="t m0 xc h10 y915 ff39 fs7 fc3 sc0 ls1 ws1">\b<span class="_ _4a"> </span><span class="ff3c">Backspace (ASCII code 8)</span></div><div class="t m0 xc h10 y916 ff39 fs7 fc3 sc0 ls1 ws1">\f<span class="_ _4b"> </span><span class="ff3c">Form feed (ASCII code 12)</span></div><div class="t m0 xc h10 y917 ff39 fs7 fc3 sc0 ls1 ws1">\n<span class="_ _4a"> </span><span class="ff3c">New line (ASCII code 10)</span></div><div class="t m0 xc h10 y918 ff39 fs7 fc3 sc0 ls1 ws1">\r<span class="_ _4c"> </span><span class="ff3c">Return (ASCII code 13)</span></div><div class="t m0 xc h10 y919 ff39 fs7 fc3 sc0 ls1 ws1">\t<span class="_ _4b"> </span><span class="ff3c">T<span class="_ _6"></span>ab (ASCII code 9)</span></div><div class="t m0 xc h10 y91a ff39 fs7 fc3 sc0 ls1 ws1">\ddd<span class="_ _4d"> </span><span class="ff3c">An octal <span class="_ _1"></span>ASCII code (ex \123)</span></div><div class="t m0 xc h10 y91b ff39 fs7 fc3 sc0 ls1 ws1">\xdd<span class="_ _4e"> </span><span class="ff3c">A hex <span class="_ _1"></span>ASCII code (ex \x4F)</span></div><div class="t m0 xc h10 y91c ff39 fs7 fc3 sc0 ls1 ws1">\\<span class="_ _4c"> </span><span class="ff3c wsa">The “\”<span class="_ _1"></span> <span class="_ _0"></span>character</span></div><div class="t m0 xc h10 y91d ff39 fs7 fc3 sc0 ls1 ws1">\”<span class="_ _4f"> </span><span class="ff3c">The double quote character</span></div><div class="t m0 xc h10 y91e ff39 fs7 fc3 sc0 ls1 ws1">\anything-else<span class="_ _50"> </span><span class="ff3c">Anything-else</span></div><div class="t m0 x42 h12 y668 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf82" data-dest-detail='[130,"XYZ",53,354,null]'><div class="d m1" style="border-style:none;position:absolute;left:357.508000px;bottom:393.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf83" class="pf w2 h6" data-page-no="83"><div class="pc pc83 w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">114</div><div class="t m0 xd ha y248 ff39 fs6 fc3 sc0 ls1 wsb1"> Aligning <span class="_ _14"> </span>Data</div><div class="t m0 xd hd y249 ff34 fs7 fc3 sc0 ls1 ws1">These data dir<span class="_ _3"></span>ectives put the data in memory contiguously byte b<span class="_ _1"></span>y byte. </div><div class="t m0 xd hd y24a ff34 fs7 fc3 sc0 ls1 ws1">However<span class="_ _10"></span>, the ARM processor often requir<span class="_ _3"></span>es data to be aligned on word </div><div class="t m0 xd hd y24b ff34 fs7 fc3 sc0 ls1 ws1">boundaries, or some other measur<span class="_ _3"></span>e. W<span class="_ _1"></span>e can instruct the Assembler to </div><div class="t m0 xd hd y24c ff34 fs7 fc3 sc0 ls1 ws1">align the next piece of data with an .align directive<span class="_ _1"></span>. For instance<span class="_ _3"></span>, consider</div><div class="t m0 xd h18 y91f ff3b fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y920 ff3b fs7 fc3 sc0 ls1 ws1">     .byte    0x3F</div><div class="t m0 xd h18 y921 ff3b fs7 fc3 sc0 ls1 ws1">     .align   4</div><div class="t m0 xd h18 y922 ff3b fs7 fc3 sc0 ls1 ws1">     .word    0x12345678</div><div class="t m0 xc hd y923 ff34 fs7 fc3 sc0 ls1 ws1">The first byte is wor<span class="_ _1"></span>d aligne<span class="_ _0"></span>d, but beca<span class="_ _3"></span>use it is only 1 byte<span class="_ _3"></span>, the next </div><div class="t m0 xd hd y924 ff34 fs7 fc3 sc0 ls1 ws1">word of data will not be aligned. If we need it to be word aligned, then we </div><div class="t m0 xd hd y925 ff34 fs7 fc3 sc0 ls1 ws1">can add the “<span class="_ _b"></span>.align 4” directive to mak<span class="_ _3"></span>e it word aligned. This will res<span class="_ _3"></span>ult in </div><div class="t m0 xd hd y926 ff34 fs7 fc3 sc0 ls1 ws1">three wasted b<span class="_ _3"></span>ytes, b<span class="_ _3"></span>ut with gigabyte of memory, this shouldn’t be too </div><div class="t m0 xd hd y927 ff34 fs7 fc3 sc0 ls1 ws1">much of a worr<span class="_ _0"></span>y.</div><div class="t m0 xc hd y928 ff34 fs7 fc3 sc0 ls1 ws1">ARM Assembly instructions must be word aligned, so if we insert data </div><div class="t m0 xd hd y929 ff34 fs7 fc3 sc0 ls1 ws1">in the middle of some instructions, then we need an .align directive befor<span class="_ _3"></span>e </div><div class="t m0 xd hd y92a ff34 fs7 fc3 sc0 ls1 ws1">the instructions continue<span class="_ _3"></span>, or our progr<span class="_ _3"></span>am will crash when we run it. In the </div><div class="t m0 xd hd y92b ff34 fs7 fc3 sc0 ls1 ws1">next section, we’ll see that when we load data with <span class="ff38 ls10 ws37">PC<span class="_ _3"></span><span class="ff34 ls1 ws1"> rela<span class="_ _3"></span>tive addressin<span class="_ _3"></span>g, </span></span></div><div class="t m0 xd hd y92c ff34 fs7 fc3 sc0 ls1 ws1">these addresses must also be wor<span class="_ _3"></span>d aligned. Usually the Assembler will </div><div class="t m0 xd hd y92d ff34 fs7 fc3 sc0 ls1 ws1">give you an error when ali<span class="_ _3"></span>gnment is requir<span class="_ _1"></span>e<span class="_ _0"></span>d, and thr<span class="_ _3"></span>owing in an “<span class="_ _b"></span>.align 4” </div><div class="t m0 xd hd y92e ff34 fs7 fc3 sc0 ls1 ws1">directive is a quick fix.</div><div class="t m0 xd h15 y92f ff39 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Loading aRegister withanAddress</div><div class="t m0 xd hd y930 ff34 fs7 fc3 sc0 ls1 ws1">In this section, we will look at the <span class="ff38">LDR</span> instruction and its variations to load </div><div class="t m0 xd hd y931 ff34 fs7 fc3 sc0 ls1 ws1">a memory address into a register<span class="_ _10"></span>. Once we have an addr<span class="_ _3"></span>ess into a r<span class="_ _3"></span>egister<span class="_ _6"></span>, </div><div class="t m0 xd hd y932 ff34 fs7 fc3 sc0 ls1 ws1">we’ll go on to look at all the wa<span class="_ _3"></span>ys we can use it to load and store da<span class="_ _3"></span>ta.</div><div class="t m0 xc hd y933 ff34 fs7 fc3 sc0 ls1 ws1">It’<span class="_ _6"></span>s a bit confusing that we use the <span class="ff38">LDR</span> instruction to both load an </div><div class="t m0 xd hd y934 ff34 fs7 fc3 sc0 ls1 ws1">address in<span class="_ _3"></span>to a register and then to use tha<span class="_ _3"></span>t address to load act<span class="_ _3"></span>ual data </div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf84" class="pf w2 h6" data-page-no="84"><div class="pc pc84 w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">115</div><div class="t m0 xc hd y145 ff34 fs7 fc3 sc0 ls1 ws1">into a r<span class="_ _3"></span>egister<span class="_ _6"></span>. The two operations ar<span class="_ _3"></span>e distinct, and it’<span class="_ _6"></span>s almost worth </div><div class="t m0 xc hd y146 ff34 fs7 fc3 sc0 ls1 ws1">considering <span class="ff38">LDR</span> as two separate instructions, one wher<span class="_ _1"></span>e w<span class="_ _0"></span>e ar<span class="_ _3"></span>e using </div><div class="t m0 xc hd y147 ff38 fs7 fc3 sc0 ls10 ws37">PC<span class="ff34 ls1 ws1"> r<span class="_ _3"></span>elative addr<span class="_ _3"></span>essing to load an addr<span class="_ _3"></span>ess and then the other being all the </span></div><div class="t m0 xc hd y1b0 ff34 fs7 fc3 sc0 ls1 ws1">forms of <span class="ff38">LDR</span> where we are loading da<span class="_ _3"></span>ta.</div><div class="t m0 xc ha y50e ff39 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>PC Relative Addressing</div><div class="t m0 xc hd y235 ff34 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>Getting Started,<span class="_ _8"></span>” we introduced the <span class="ff38">LDR</span> instruction to load </div><div class="t m0 xc hd y53b ff34 fs7 fc3 sc0 ls1 ws1">the address of our “H<span class="_ _1"></span>ello World!” string. W<span class="_ _1"></span>e needed to do this to pass the </div><div class="t m0 xc hd y53c ff34 fs7 fc3 sc0 ls1 ws1">address of wh<span class="_ _3"></span>at to print to the Linux <span class="ff38">write</span> command. T<span class="_ _3"></span>his is a simple </div><div class="t m0 xc hd y53d ff34 fs7 fc3 sc0 ls1 ws1">example of <span class="ff38 ls10 ws37">PC</span> r<span class="_ _1"></span>elative addressing. I<span class="_ _1"></span>t is convenient, since it doesn’t inv<span class="_ _3"></span>olve </div><div class="t m0 xc hd y679 ff34 fs7 fc3 sc0 ls1 ws1">any other registers<span class="_ _1"></span>. If you keep your data close to your code<span class="_ _1"></span>, it is painless. </div><div class="t m0 xc hd y67a ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e just needed to code</div><div class="t m0 xc h18 y540 ff3b fs7 fc3 sc0 ls1 ws1">LDR   X1, =helloworld</div><div class="t m0 x1c hd y541 ff34 fs7 fc3 sc0 lse ws1">to load the address of o<span class="_ _3"></span>ur helloworld string into <span class="ff38 wsb2">X1</span>. The Assembler kno<span class="_ _3"></span>ws </div><div class="t m0 xc hd y67b ff34 fs7 fc3 sc0 lse ws1">the value of the progr<span class="_ _3"></span>am counter a<span class="_ _3"></span>t this point, so it can pr<span class="_ _3"></span>ovide an offset to the </div><div class="t m0 xc hd y935 ff34 fs7 fc3 sc0 lse ws1">correct memory address. Ther<span class="_ _1"></span>efore, it’<span class="_ _6"></span>s called <span class="ff38 ls18 wsc0">PC</span> rela<span class="_ _3"></span>tive addres<span class="_ _3"></span>sing. Ther<span class="_ _3"></span>e is </div><div class="t m0 xc hd y936 ff34 fs7 fc3 sc0 lse ws1">a bit more complexity to this<span class="_ _3"></span>, which we’ll get to in a minute<span class="_ _1"></span>.</div><div class="t m0 x1c hd y937 ff34 fs7 fc3 sc0 ls1 ws1">The offset from the <span class="ff38 ls10 ws37">PC<span class="_ _3"></span><span class="ff34 ls1 ws1"> has 19 bits in the instruction, which gives a </span></span></div><div class="t m0 xc hd y938 ff34 fs7 fc3 sc0 ls1 ws1">range of +/-1MB.The offset addr<span class="_ _3"></span>ess is in words<span class="_ _1"></span>.</div><div class="t m0 x1c hd y939 ff38 fs7 fc3 sc0 ls10 ws37">PC<span class="ff34 ls1 ws1"> r<span class="_ _3"></span>elative addr<span class="_ _3"></span>essing has one mor<span class="_ _1"></span>e tr<span class="_ _0"></span>ick up its sleeve; it gives us a </span></div><div class="t m0 xc hd y93a ff34 fs7 fc3 sc0 ls1 ws1">way to load any 64-bit quan<span class="_ _3"></span>tity into a r<span class="_ _3"></span>egister in only one instruction, for </div><div class="t m0 xc hd y93b ff34 fs7 fc3 sc0 ls1 ws1">example, consider</div><div class="t m0 xc h18 y93c ff3b fs7 fc3 sc0 ls1 ws1">LDR   X1, =0x1234ABCD1234ABCD</div><div class="t m0 x1c hd y93d ff34 fs7 fc3 sc0 ls1 ws1">This assembles into</div><div class="t m0 xc h18 y93e ff3b fs7 fc3 sc0 ls1 ws1">ldr   X1, #8</div><div class="t m0 xc h18 y93f ff3b fs7 fc3 sc0 ls1 ws1">.quad 0x1234abcd1234abcd</div><div class="t m0 x1c hd y940 ff34 fs7 fc3 sc0 ls1 ws1">The GNU Assembler is helping us out b<span class="_ _3"></span>y putting the constant we wan<span class="_ _3"></span>t </div><div class="t m0 xc hd y941 ff34 fs7 fc3 sc0 ls1 ws1">into memory, then creating a <span class="ff38 ls10 ws37">PC<span class="_ _3"></span><span class="ff34 ls1 ws1"> rela<span class="_ _3"></span>tive instruction to load it.</span></span></div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:465.175000px;width:5.500000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf85" class="pf w2 h6" data-page-no="85"><div class="pc pc85 w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">116</div><div class="t m0 xc hd y145 ff34 fs7 fc3 sc0 ls1 ws1">The <span class="ff38 ls10 ws37">PC</span> h<span class="_ _3"></span>as become more of an abstr<span class="_ _3"></span>act register in the modern 64- </div><div class="t m0 xd hd y146 ff34 fs7 fc3 sc0 ls1 ws1">bit world. The ARM processor can execute m<span class="_ _3"></span>ultiple instructions at once </div><div class="t m0 xd hd y147 ff34 fs7 fc3 sc0 ls1 ws1">and even execute them out of or<span class="_ _3"></span>der<span class="_ _6"></span>. In the 32-bit world, the <span class="ff38 ls10 ws37">PC</span> was a </div><div class="t m0 xd hd y1b0 ff34 fs7 fc3 sc0 ls1 ws1">real r<span class="_ _1"></span>e<span class="_ _0"></span>gister th<span class="_ _3"></span>at you could load, add to<span class="_ _1"></span>, and manipulate lik<span class="_ _3"></span>e any general- </div><div class="t m0 xd hd y1b1 ff34 fs7 fc3 sc0 ls1 ws1">purpose register<span class="_ _10"></span>. This caused hav<span class="_ _3"></span>oc for hardw<span class="_ _3"></span>are engineers trying to </div><div class="t m0 xd hd y218 ff34 fs7 fc3 sc0 ls1 ws1">design efficient instruction pipelines, so in 64 bits<span class="_ _1"></span>, instr<span class="_ _0"></span>uctions can’t </div><div class="t m0 xd hd y219 ff34 fs7 fc3 sc0 ls1 ws1">manipulate the PC dir<span class="_ _3"></span>ectly. For PC r<span class="_ _3"></span>elative addr<span class="_ _3"></span>essing, it r<span class="_ _1"></span>eally be<span class="_ _0"></span>comes </div><div class="t m0 xd hd y1b4 ff34 fs7 fc3 sc0 ls1 ws1">addressing r<span class="_ _1"></span>elative to the current instruction. In the pr<span class="_ _1"></span>e<span class="_ _0"></span>ceding example<span class="_ _1"></span>, </div><div class="t m0 xd hd y1b5 ff34 fs7 fc3 sc0 ls1 ws1">“ldr X1, #8” means 8 words fr<span class="_ _3"></span>om the current instruction.</div><div class="t m0 xc hd y1b6 ff34 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">2</span>, “Loading and A<span class="_ _3"></span>dding,<span class="_ _8"></span>” we performed this w<span class="_ _0"></span>ith a MOV/</div><div class="t m0 xd hd y1b7 ff34 fs7 fc3 sc0 ls1 ws1">MOVT pair<span class="_ _6"></span>. Here we are doin<span class="_ _3"></span>g the same thing in one instruction. Both take </div><div class="t m0 xd hd y942 ff34 fs7 fc3 sc0 ls1 ws1">the same memory, either tw<span class="_ _0"></span>o 32-bit instruction or one 32-bit instruction, </div><div class="t m0 xd hd y943 ff34 fs7 fc3 sc0 ls1 ws1">and one 32-bit memory lo<span class="_ _0"></span>ca<span class="_ _3"></span>tion.</div><div class="t m0 xc hd y944 ff34 fs7 fc3 sc0 ls1 ws1">In fact, this is ho<span class="_ _3"></span>w the Assembler handles all data labels<span class="_ _1"></span>. When we </div><div class="t m0 xd hd y945 ff34 fs7 fc3 sc0 ls1 ws1">specified</div><div class="t m0 xd h18 y617 ff3b fs7 fc3 sc0 ls1 ws1">LDR   X1, =helloworld</div><div class="t m0 xc hd y641 ff34 fs7 fc3 sc0 lsc ws1">the Assembler did the same thing; it cr<span class="_ _3"></span>eated the address of the </div><div class="t m0 xd hd y642 ff34 fs7 fc3 sc0 lsc ws1">hellostring in memory and then loade<span class="_ _0"></span>d the conten<span class="_ _3"></span>ts of that memory </div><div class="t m0 xd hd y643 ff34 fs7 fc3 sc0 lsc ws1">location, not the helloworld string. W<span class="_ _1"></span>e’ll look car<span class="_ _1"></span>efully at this process when </div><div class="t m0 xd hd y946 ff34 fs7 fc3 sc0 lsc ws1">we discuss our progr<span class="_ _3"></span>am to convert strings to upper<span class="_ _1"></span>-case later in this chapter<span class="_ _10"></span>.</div><div class="t m0 xc hd y947 ff34 fs7 fc3 sc0 ls1 ws1">These constants the Assembler cr<span class="_ _3"></span>eates ar<span class="_ _3"></span>e placed at the end of the </div><div class="t m0 xd hd y61d ff38 fs7 fc3 sc0 ls1 ws1">.text<span class="ff34"> section which is where the As<span class="_ _3"></span>sembly instructions go<span class="_ _3"></span>, not in the <span class="ff38">.data</span> </span></div><div class="t m0 xd hd y948 ff34 fs7 fc3 sc0 ls1 ws1">section. This makes them r<span class="_ _3"></span>ead-only in normal circumstances<span class="_ _1"></span>, so the<span class="_ _0"></span>y can’t </div><div class="t m0 xd hd y949 ff34 fs7 fc3 sc0 ls1 ws1">be modified. Any data that y<span class="_ _3"></span>ou want to modify should go in a <span class="ff38">.data</span> section.</div><div class="t m0 xc hd y620 ff34 fs7 fc3 sc0 ls1 ws1">Why would the Assembler do this? Why not j<span class="_ _3"></span>ust point the <span class="ff38 ls10 ws37">PC<span class="_ _3"></span><span class="ff34 ls1 ws1"> relativ<span class="_ _3"></span>e </span></span></div><div class="t m0 xd hd y94a ff34 fs7 fc3 sc0 ls1 ws1">index directly at the da<span class="_ _3"></span>ta? There ar<span class="_ _1"></span>e several reasons for this<span class="_ _3"></span>, not all of them </div><div class="t m0 xd hd y622 ff34 fs7 fc3 sc0 ls1 ws1">specific to the ARM instruction set<span class="_ _2"></span>:</div><div class="t m0 xc hd y94b ff34 fs7 fc3 sc0 ls18 ws1"> <span class="_ _16"> </span>1. <span class="_ _21"> </span>An <span class="_ _0"></span>offset of 1MB looks large, but only addr<span class="_ _3"></span>esses a </div><div class="t m0 x1e hd y94c ff34 fs7 fc3 sc0 ls18 ws1">fraction of the memory in a modern computer<span class="_ _6"></span>. This way </div><div class="t m0 x1e hd y94d ff34 fs7 fc3 sc0 ls18 ws1">we can access 1MB objects rather th<span class="_ _3"></span>an 1MB words<span class="_ _3"></span>. This </div><div class="t m0 x1e hd y94e ff34 fs7 fc3 sc0 ls18 ws1">helps keep our progr<span class="_ _1"></span>am e<span class="_ _0"></span>qually efficient as it gets lar<span class="_ _3"></span>ger<span class="_ _6"></span>.</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:433.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf86" class="pf w2 h6" data-page-no="86"><div class="pc pc86 w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">117</div><div class="t m0 x1c hd y145 ff34 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>All the labels we define go into the object file’<span class="_ _6"></span>s </div><div class="t m0 x9 hd y146 ff34 fs7 fc3 sc0 ls1 ws1">symbol table<span class="_ _3"></span>, making this arra<span class="_ _3"></span>y of addresses<span class="_ _1"></span>, </div><div class="t m0 x9 hd y147 ff34 fs7 fc3 sc0 ls1 ws1">essentially our symbol table<span class="_ _1"></span>. This way it’<span class="_ _1"></span>s easy </div><div class="t m0 x9 hd y1b0 ff34 fs7 fc3 sc0 ls1 ws1">for the linker/loader and operatin<span class="_ _3"></span>g system to </div><div class="t m0 x9 hd y1b1 ff34 fs7 fc3 sc0 ls1 ws1">change memory addresses without you needing to </div><div class="t m0 x9 hd y218 ff34 fs7 fc3 sc0 ls1 ws1">recompile yo<span class="_ _3"></span>ur progr<span class="_ _3"></span>am.</div><div class="t m0 x1c hd y1e1 ff34 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>If you need any of these variables to be global, you </div><div class="t m0 x9 hd y1e2 ff34 fs7 fc3 sc0 ls1 ws1">can just mak<span class="_ _3"></span>e them global (accessible to other files), </div><div class="t m0 x9 hd y1cd ff34 fs7 fc3 sc0 ls1 ws1">without changing your pr<span class="_ _1"></span>ogram. If we didn’t ha<span class="_ _3"></span>ve </div><div class="t m0 x9 hd y1ce ff34 fs7 fc3 sc0 ls1 ws1">this level of indirection, makin<span class="_ _3"></span>g a variable global </div><div class="t m0 x9 hd y1cf ff34 fs7 fc3 sc0 ls1 ws1">would requir<span class="_ _3"></span>e adjustments to the instructions tha<span class="_ _3"></span>t </div><div class="t m0 x9 hd y1b8 ff34 fs7 fc3 sc0 ls1 ws1">load and sav<span class="_ _3"></span>e it.</div><div class="t m0 x1c hd y1d0 ff34 fs7 fc3 sc0 ls1 ws1">This is another example of the tools helping us<span class="_ _3"></span>, though at first it m<span class="_ _3"></span>ay </div><div class="t m0 xc hd y94f ff34 fs7 fc3 sc0 ls1 ws1">not seem so<span class="_ _3"></span>. In our simple one-line examples<span class="_ _1"></span>, it appears to add a layer of </div><div class="t m0 xc hd y950 ff34 fs7 fc3 sc0 ls1 ws1">complexity, but in a real pr<span class="_ _1"></span>ogram, this is the design pattern tha<span class="_ _3"></span>t works<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1d3 ff34 fs7 fc3 sc0 ls1 ws1">If you do want to a<span class="_ _1"></span>void this extra indirection, yo<span class="_ _3"></span>u can use the <span class="ff38">ADR</span> </div><div class="t m0 xc hd y1d4 ff34 fs7 fc3 sc0 ls1 ws1">instruction. W<span class="_ _1"></span>e saw this in our iOS example in Chapter <span class="fc5">3</span>, “T<span class="_ _6"></span>ooling Up<span class="_ _1"></span>.<span class="_ _8"></span>” </div><div class="t m0 xc hd y1d5 ff38 fs7 fc3 sc0 ls1 ws1">ADR<span class="ff34"> is like </span>LDR<span class="ff34">, only it doesn’t perform the extra indirection. If we do</span></div><div class="t m0 xc h18 y951 ff3b fs7 fc3 sc0 ls1 ws1">ADR   X1, helloworld</div><div class="t m0 x1c hd y952 ff34 fs7 fc3 sc0 ls1 ws1">then the helloworld string has to be in the .text section. iOS doesn’t </div><div class="t m0 xc hd y953 ff34 fs7 fc3 sc0 ls1 ws1">like the other form since the loader has to fix up the addr<span class="_ _3"></span>esses to where </div><div class="t m0 xc hd y954 ff34 fs7 fc3 sc0 ls1 ws1">the progr<span class="_ _3"></span>am is loaded in memory, and Apple considers this a worthwhile </div><div class="t m0 xc hd y955 ff34 fs7 fc3 sc0 ls1 ws1">optimization.</div><div class="t m0 xc h15 y956 ff39 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Loading Data fromMemor<span class="_ _0"></span>y</div><div class="t m0 x1c hd y957 ff34 fs7 fc3 sc0 ls1 ws1">In our H<span class="_ _3"></span>elloW<span class="_ _1"></span>orld program<span class="_ _3"></span>, we only needed the address to pass on to </div><div class="t m0 xc hd y958 ff34 fs7 fc3 sc0 ls1 ws1">Linux, which then used it to pr<span class="_ _0"></span>int our s<span class="_ _3"></span>tring. Generally, we like to use these </div><div class="t m0 xc hd y959 ff34 fs7 fc3 sc0 ls1 ws1">addresses to load da<span class="_ _3"></span>ta into a register<span class="_ _10"></span>.</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:310.868000px;bottom:309.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf87" class="pf w2 h6" data-page-no="87"><div class="pc pc87 w2 h6"><img class="bi x44 y95a w11 h3d" alt="" src="bg87.png"/><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">118</div><div class="t m0 xc hd y145 ff34 fs7 fc3 sc0 ls1 ws1">The simple form of LDR to load data given an addr<span class="_ _3"></span>ess is</div><div class="t m0 xd h18 y2e0 ff3b fs7 fc3 sc0 ls1 ws1">LDR{type}   Xt, [Xa]</div><div class="t m0 xc hd y6e7 ff34 fs7 fc3 sc0 ls1 ws1">where type is one of the types listed in T<span class="_ _10"></span>able<span class="fc5">5-3</span>.</div><div class="t m0 xc hd y95b ff34 fs7 fc3 sc0 ls1 ws1">The signed version will extend the sign acr<span class="_ _3"></span>oss the rest of the r<span class="_ _1"></span>egister </div><div class="t m0 xd hd y95c ff34 fs7 fc3 sc0 ls1 ws1">when we load the data. W<span class="_ _1"></span>e don’t need unsigned word, since we just use a </div><div class="t m0 xd hd y95d ff38 fs7 fc3 sc0 ls1 ws1">W<span class="ff34"> register in this case<span class="_ _1"></span>.</span></div><div class="t m0 xc hd y95e ff34 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">5-2</span> shows the typical usage wher<span class="_ _1"></span>e w<span class="_ _0"></span>e load an addr<span class="_ _3"></span>ess into a </div><div class="t m0 xd hd y95f ff34 fs7 fc3 sc0 ls1 ws1">register and then use tha<span class="_ _3"></span>t address to load the da<span class="_ _3"></span>ta we want.</div><div class="t m0 xd h20 y960 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-2. <span class="_ _15"> </span><span class="ff34">Loading an address and then the value</span></div><div class="t m0 xd h18 y961 ff3b fs7 fc3 sc0 ls1 ws1">// load the address of mynumber into X1</div><div class="t m0 xd h18 y962 ff3b fs7 fc3 sc0 ls1 ws1">      LDR   X1, =mynumber</div><div class="t m0 xd h18 y963 ff3b fs7 fc3 sc0 ls1 ws1">// load the word stored at mynumber into X2</div><div class="t m0 xd h18 y964 ff3b fs7 fc3 sc0 ls1 ws1">      LDR   X2, [X1]</div><div class="t m0 xd h18 y965 ff3b fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y966 ff3b fs7 fc3 sc0 ls1 ws1">mynumber:   .QUAD 0x123456789ABCDEF0</div><div class="t m0 x44 h3b y967 ff3a fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 5-3. <span class="_ _15"> </span><span class="ff35">The data types f<span class="_ _0"></span>or the load/store instructions</span></div><div class="t m0 x44 h10 y968 ff39 fs7 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>ype<span class="_ _51"> </span>Meaning</div><div class="t m0 x44 h10 y969 ff39 fs7 fc3 sc0 ls1 ws1">B<span class="_ _52"> </span><span class="ff3c">Unsigned byte</span></div><div class="t m0 x44 h10 y96a ff39 fs7 fc3 sc0 ls1 ws1">SB<span class="_ _53"> </span><span class="ff3c">Signed byte</span></div><div class="t m0 x44 h10 y96b ff39 fs7 fc3 sc0 ls1 ws1">H<span class="_ _52"> </span><span class="ff3c">Unsigned halfword (16 bits)</span></div><div class="t m0 x44 h10 y96c ff39 fs7 fc3 sc0 ls1 ws1">SH<span class="_ _53"> </span><span class="ff3c">Signed halfword (16 bits)</span></div><div class="t m0 x44 h10 y96d ff39 fs7 fc3 sc0 ls1 ws1">SW<span class="_ _41"> </span><span class="ff3c">Signed word</span></div><div class="t m0 xd h12 y668 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf87" data-dest-detail='[135,"XYZ",67,515,null]'><div class="d m1" style="border-style:none;position:absolute;left:260.697000px;bottom:529.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf87" data-dest-detail='[135,"XYZ",35,253,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:283.068000px;width:15.047600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf88" class="pf w2 h6" data-page-no="88"><div class="pc pc88 w2 h6"><img class="bi xc y96e w7 h30" alt="" src="bg88.png"/><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">119</div><div class="t m0 x1c hd y38c ff34 fs7 fc3 sc0 ls1 ws1">If you step thr<span class="_ _3"></span>ough this in the debugger<span class="_ _10"></span>, you can watch it load </div><div class="t m0 xc hd y38d ff34 fs7 fc3 sc0 ls1 ws1">0x123456789ABCDEF0 into <span class="ff38">X2</span>.</div><div class="t m0 x36 h1f y96f ff39 fse fc3 sc0 ls1 ws1">Note<span class="ff3c"> <span class="_ _17"> </span>The square bracket syntax represents indirect memory </span></div><div class="t m0 x36 h1f y970 ff3c fse fc3 sc0 ls1 ws1">access.<span class="_ _1"></span> <span class="_ _1"></span>This means load the da<span class="_ _0"></span>ta stored at the address pointed to by </div><div class="t m0 x36 h1f y971 ff39 fse fc3 sc0 ls1 ws1">X1<span class="ff3c">,<span class="_ _1"></span> not move the contents of <span class="ff39">X1</span> into <span class="ff39">X2</span>.</span></div><div class="t m0 x1c hd y703 ff34 fs7 fc3 sc0 ls1 ws1">This works<span class="_ _3"></span>, but you migh<span class="_ _3"></span>t be dissatisfied that it took us two </div><div class="t m0 xc hd y972 ff34 fs7 fc3 sc0 ls1 ws1">instructions to load <span class="ff38">X2</span> with our value from memory, one to load the </div><div class="t m0 xc hd y973 ff34 fs7 fc3 sc0 ls1 ws1">address and then one to load the da<span class="_ _3"></span>ta. This is life pr<span class="_ _1"></span>ogramming a RISC </div><div class="t m0 xc hd y974 ff34 fs7 fc3 sc0 ls1 ws1">processor<span class="_ _0"></span>; each instruction executes very quickly, but performs a small </div><div class="t m0 xc hd y975 ff34 fs7 fc3 sc0 ls1 ws1">chunk of work. As we develop algorithms<span class="_ _3"></span>, we’ll see that we usually load </div><div class="t m0 xc hd y976 ff34 fs7 fc3 sc0 ls1 ws1">an address once and then use it quite a bit, so most accesses take one </div><div class="t m0 xc hd y977 ff34 fs7 fc3 sc0 ls1 ws1">instruction once we are going.</div><div class="t m0 xc ha y978 ff39 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Indexing Through Memory</div><div class="t m0 xc hd y1f4 ff34 fs7 fc3 sc0 ls1 ws1">All high-level progr<span class="_ _1"></span>amming languages have an arr<span class="_ _3"></span>ay construct. They can </div><div class="t m0 xc hd y979 ff34 fs7 fc3 sc0 ls1 ws1">define an array of objects and then access the individual elements b<span class="_ _1"></span>y </div><div class="t m0 xc hd y97a ff34 fs7 fc3 sc0 ls1 ws1">index. The high-level language will define the array with something like</div><div class="t m0 xc h18 y97b ff3b fs7 fc3 sc0 ls1 ws1">DIM A[10] AS WORD</div><div class="t m0 x1c hd y97c ff34 fs7 fc3 sc0 ls1 ws1">then access the individual elements with statements lik<span class="_ _3"></span>e those in  </div><div class="t m0 xc hd y97d ff34 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">5-3</span>.</div><div class="t m0 xc h20 y97e ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-3. <span class="_ _15"> </span><span class="ff34">Pseudo-code to loop thr<span class="_ _3"></span>ough an array</span></div><div class="t m0 xc h18 y97f ff3b fs7 fc3 sc0 ls1 ws1"> // Set the 5th element of the array to the value 6</div><div class="t m0 xc h18 y980 ff3b fs7 fc3 sc0 ls1 ws1">A[5] = 6</div><div class="t m0 xc h18 y981 ff3b fs7 fc3 sc0 ls1 ws1">// Set the variable X equal to the 3rd array element</div><div class="t m0 xc h18 y982 ff3b fs7 fc3 sc0 ls1 ws1">      X = A[3]</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf88" data-dest-detail='[136,"XYZ",53,186,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:199.362000px;width:15.047600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf89" class="pf w2 h6" data-page-no="89"><div class="pc pc89 w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">120</div><div class="t m0 xd h18 y46b ff3b fs7 fc3 sc0 ls1 ws1">// Loop through all 10 elements</div><div class="t m0 xd h18 y46c ff3b fs7 fc3 sc0 ls1 ws1">       FOR I = 1 TO 10</div><div class="t m0 xd h18 y46d ff3b fs7 fc3 sc0 ls1 ws1">             // Set element I to I cubed</div><div class="t m0 xd h18 y623 ff3b fs7 fc3 sc0 ls1 ws1">             A[I] = I ** 3</div><div class="t m0 xd h18 y624 ff3b fs7 fc3 sc0 ls1 ws1">       NEXT I</div><div class="t m0 xc hd y85d ff34 fs7 fc3 sc0 ls1 ws1">The ARM instruction set gives us support for doing these sorts of </div><div class="t m0 xd hd y983 ff34 fs7 fc3 sc0 ls1 ws1">operations<span class="_ _1"></span>.</div><div class="t m0 xc hd y984 ff34 fs7 fc3 sc0 ls1 ws1">Suppose we ha<span class="_ _3"></span>ve an array of 10 wor<span class="_ _3"></span>ds (4 bytes each) defined b<span class="_ _3"></span>y</div><div class="t m0 xd h18 y473 ff3b fs7 fc3 sc0 ls1 ws1">arr1:   .FILL   10, 4, 0</div><div class="t m0 xc hd y474 ff34 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s load the array’<span class="_ _6"></span>s address into <span class="ff38">X1</span>:</div><div class="t m0 xd h18 y985 ff3b fs7 fc3 sc0 ls1 ws1">LDR   X1, =arr1</div><div class="t m0 xc hd y986 ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can now access the elements using <span class="ff38">LDR</span> as demonstra<span class="_ _3"></span>ted in  </div><div class="t m0 xd hd y987 ff34 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">5-4</span> and Fi<span class="_ _3"></span>gure <span class="fc5">5-1</span>.</div><div class="t m0 xd h20 y988 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-4. <span class="_ _15"> </span><span class="ff34">Indexing into an arra<span class="_ _3"></span>y</span></div><div class="t m0 xd h18 y989 ff3b fs7 fc3 sc0 ls1 ws1">      // Load the first element</div><div class="t m0 xd h18 y98a ff3b fs7 fc3 sc0 ls1 ws1">      LDR   W2, [X1]</div><div class="t m0 xd h18 y98b ff3b fs7 fc3 sc0 ls1 ws1">      // Load element 3</div><div class="t m0 xd h18 y98c ff3b fs7 fc3 sc0 ls1 ws1">      // The elements count from 0, so 2 is</div><div class="t m0 xd h18 y98d ff3b fs7 fc3 sc0 ls1 ws1">      // the third one. Each word is 4 bytes,</div><div class="t m0 xd h18 y98e ff3b fs7 fc3 sc0 ls1 ws1">      // so we need to multiply by 4</div><div class="t m0 xd h18 y98f ff3b fs7 fc3 sc0 ls1 ws1">      LDR   W2, [X1, #(2 * 4)]</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf89" data-dest-detail='[137,"XYZ",35,331,null]'><div class="d m1" style="border-style:none;position:absolute;left:70.055400px;bottom:345.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf8a" data-dest-detail='[138,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:139.805000px;bottom:345.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf8a" class="pf w2 h6" data-page-no="8a"><div class="pc pc8a w2 h6"><img class="bi x2e y990 w6 h3e" alt="" src="bg8a.png"/><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">121</div><div class="t m0 x1c hd y991 ff34 fs7 fc3 sc0 ls1 ws1">Notice ho<span class="_ _3"></span>w we use <span class="ff38">W2</span> to specify that we want to load 32 bits or one </div><div class="t m0 xc hd y992 ff34 fs7 fc3 sc0 ls1 ws1">word. Addr<span class="_ _1"></span>esses are always 64 bits and we must use an <span class="ff38">X</span> r<span class="_ _3"></span>egister<span class="_ _6"></span>. However<span class="_ _10"></span>, </div><div class="t m0 xc hd y993 ff34 fs7 fc3 sc0 ls1 ws1">as in this case, we often only need to load a smaller quan<span class="_ _3"></span>tity of data.</div><div class="t m0 x1c hd y994 ff34 fs7 fc3 sc0 ls1 ws1">This is fine for accessing har<span class="_ _1"></span>d-code<span class="_ _0"></span>d elements<span class="_ _1"></span>, but what about via a </div><div class="t m0 xc hd y995 ff34 fs7 fc3 sc0 ls1 ws1">variable? W<span class="_ _1"></span>e can use a register as demonstra<span class="_ _3"></span>ted in Listing <span class="fc5">5-5</span>.</div><div class="t m0 xc h20 y996 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-5. <span class="_ _15"> </span><span class="ff34">Using a r<span class="_ _1"></span>e<span class="_ _0"></span>gister as an offset</span></div><div class="t m0 xc h18 y997 ff3b fs7 fc3 sc0 ls1 ws1">// The 3rd element is still number 2</div><div class="t m0 xc h18 y998 ff3b fs7 fc3 sc0 ls1 ws1">      MOV   X3, #(2 * 4)</div><div class="t m0 xc h18 y999 ff3b fs7 fc3 sc0 ls1 ws1">// Add the offset in X3 to X1 to get our element.</div><div class="t m0 xc h18 y99a ff3b fs7 fc3 sc0 ls1 ws1">      LDR   W2, [X1, X3]</div><div class="t m0 x1c hd y99b ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can do these shifts in reverse. If <span class="ff38">X1</span> points t<span class="_ _3"></span>o the end of the array, </div><div class="t m0 xc hd y99c ff34 fs7 fc3 sc0 ls1 ws1">we can do</div><div class="t m0 xc h18 y99d ff3b fs7 fc3 sc0 ls1 ws1">LDR   W2, [X1, #-(2 * 4)]</div><div class="t m0 xc h18 y99e ff3b fs7 fc3 sc0 ls1 ws1">MOV   X3, #(-2 * 4)</div><div class="t m0 xc h18 y99f ff3b fs7 fc3 sc0 ls1 ws1">LDR   W2, [X1, X3]</div><div class="t m0 xc h3b y9a0 ff3a fs3 fc3 sc0 ls1 ws1">Figure 5-1. <span class="_ _15"> </span><span class="ff35">Graphica<span class="_ _3"></span>l view of using X1 and an index to load W2</span></div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf8a" data-dest-detail='[138,"XYZ",53,295,null]'><div class="d m1" style="border-style:none;position:absolute;left:324.739000px;bottom:308.941000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf8b" class="pf w2 h6" data-page-no="8b"><div class="pc pc8b w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">122</div><div class="t m0 xc hd y145 ff34 fs7 fc3 sc0 ls1 ws1">With the r<span class="_ _3"></span>egister as the offset, it is the same as a regist<span class="_ _3"></span>er and shift type </div><div class="t m0 xd hd y146 ff34 fs7 fc3 sc0 ls1 ws1">Operand2 tha<span class="_ _3"></span>t we studied in Chapter <span class="fc5">2</span>, “Loading and Adding.<span class="_ _8"></span>” F<span class="_ _1"></span>or the </div><div class="t m0 xd hd y147 ff34 fs7 fc3 sc0 ls1 ws1">preceding constants<span class="_ _1"></span>, we could do a <span class="ff3d">∗</span> 4in the immediate instruction, but </div><div class="t m0 xd hd y1b0 ff34 fs7 fc3 sc0 ls1 ws1">if it’<span class="_ _1"></span>s in a r<span class="_ _3"></span>egister<span class="_ _6"></span>, we would need to do an additional shift operation and </div><div class="t m0 xd hd y1b1 ff34 fs7 fc3 sc0 ls1 ws1">put the result in y<span class="_ _3"></span>et another register<span class="_ _10"></span>. With the register/shift forma<span class="_ _3"></span>t, we </div><div class="t m0 xd hd y218 ff34 fs7 fc3 sc0 ls1 ws1">can handle quite a few cases easily. Comp<span class="_ _3"></span>uting the address of an arr<span class="_ _3"></span>ay of </div><div class="t m0 xd hd y219 ff34 fs7 fc3 sc0 ls1 ws1">words is demonstr<span class="_ _3"></span>ated in Listing <span class="fc5">5-6</span>.</div><div class="t m0 xd h20 y9a1 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-6. <span class="_ _15"> </span><span class="ff34">M<span class="_ _3"></span>ultiplying an offset by 4 usin<span class="_ _3"></span>g a shift operation</span></div><div class="t m0 xd h18 y9a2 ff3b fs7 fc3 sc0 ls1 ws1">// Our array is of WORDs. 2 is the index</div><div class="t m0 xd h18 y9a3 ff3b fs7 fc3 sc0 ls1 ws1">   MOV   X3, #2</div><div class="t m0 xd h18 y9a4 ff3b fs7 fc3 sc0 ls1 ws1">// Shift X3 left by 2 positions to multiply</div><div class="t m0 xd h18 y9a5 ff3b fs7 fc3 sc0 ls1 ws1">// by 4 to get the correct address.</div><div class="t m0 xd h18 y9a6 ff3b fs7 fc3 sc0 ls1 ws1">   LDR   W2, [X1, X3, LSL #2]</div><div class="t m0 xd h2a y9a7 ff39 fsf fc3 sc0 ls1 wsbb"> Write <span class="_ _1b"> </span>Back</div><div class="t m0 xd hd y9a8 ff34 fs7 fc3 sc0 ls1 ws1">When the address is calcul<span class="_ _3"></span>ated, the result is thr<span class="_ _1"></span>own away after we<span class="_ _3"></span>’ve </div><div class="t m0 xd hd y9a9 ff34 fs7 fc3 sc0 ls1 ws1">loaded the register<span class="_ _10"></span>. When per<span class="_ _0"></span>forming a loop<span class="_ _1"></span>, it is handy to keep the </div><div class="t m0 xd hd y9aa ff34 fs7 fc3 sc0 ls1 ws1">calculated addr<span class="_ _3"></span>ess. T<span class="_ _3"></span>his sav<span class="_ _3"></span>es us doing a separate <span class="ff38">ADD</span> on o<span class="_ _3"></span>ur index </div><div class="t m0 xd hd y9ab ff34 fs7 fc3 sc0 ls1 ws1">register<span class="_ _10"></span>.</div><div class="t m0 xc hd y9ac ff34 fs7 fc3 sc0 ls1 ws1">The syntax for this is to put an exc<span class="_ _3"></span>lamation mar<span class="_ _3"></span>k (<span class="ff38">!</span>) after the </div><div class="t m0 xd hd y9ad ff34 fs7 fc3 sc0 ls1 ws1">instruction, and then the Assembler will set the bit in the generated </div><div class="t m0 xd hd y9ae ff34 fs7 fc3 sc0 ls1 ws1">instruction asking the CPU to sav<span class="_ _3"></span>e the calculated addr<span class="_ _3"></span>ess<span class="_ _0"></span>; thus</div><div class="t m0 xd h18 y9af ff3b fs7 fc3 sc0 ls1 ws1">LDR W2, [X1, #(2 * 4)]!</div><div class="t m0 xc hd y9b0 ff34 fs7 fc3 sc0 ls1 ws1">updates <span class="ff38">X1</span> with the value calculated. I<span class="_ _3"></span>n the examples we’<span class="_ _1"></span>ve studied, </div><div class="t m0 xd hd y9b1 ff34 fs7 fc3 sc0 ls1 ws1">this isn’t that useful, but it becomes much mor<span class="_ _1"></span>e us<span class="_ _0"></span>eful in the next section. </div><div class="t m0 xd hd y9b2 ff34 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou can only use this in the simple case shown; it can’t be used when a </div><div class="t m0 xd hd y9b3 ff34 fs7 fc3 sc0 ls1 ws1">register is used in place of an immediate offset.</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:211.228000px;bottom:561.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf8b" data-dest-detail='[139,"XYZ",35,468,null]'><div class="d m1" style="border-style:none;position:absolute;left:190.625000px;bottom:481.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf8c" class="pf w2 h6" data-page-no="8c"><div class="pc pc8c w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">123</div><div class="t m0 xc h2a y409 ff39 fsf fc3 sc0 ls1 wsbb"> P<span class="_ _1"></span>ost-Indexed <span class="_ _1b"> </span>Addressing</div><div class="t m0 xc hd y40a ff34 fs7 fc3 sc0 ls1 ws1">The preceding section co<span class="_ _3"></span>vers what is called <span class="ff38">pre-index<span class="_ _3"></span>ed addressing<span class="ff34">. This </span></span></div><div class="t m0 xc hd y40b ff34 fs7 fc3 sc0 ls1 ws1">is because the address is c<span class="_ _3"></span>alculated and then the data is r<span class="_ _1"></span>etr<span class="_ _0"></span>ieved using </div><div class="t m0 xc hd y40c ff34 fs7 fc3 sc0 ls1 ws1">the calculated addr<span class="_ _3"></span>ess. I<span class="_ _1"></span>n <span class="ff38">p<span class="_ _0"></span>ost<span class="_ _1"></span>-in<span class="_ _0"></span>dex<span class="_ _3"></span>ed addressing<span class="_ _0"></span>,<span class="ff34"> the data is r<span class="_ _1"></span>etr<span class="_ _0"></span>ieved </span></span></div><div class="t m0 xc hd y9b4 ff34 fs7 fc3 sc0 ls1 ws1">first using the base register; then any offset adding is done. In the cont<span class="_ _3"></span>ext </div><div class="t m0 xc hd y9b5 ff34 fs7 fc3 sc0 ls1 ws1">of one instruction, this seems strange, but when we write loops<span class="_ _3"></span>, we will </div><div class="t m0 xc hd y9b6 ff34 fs7 fc3 sc0 ls1 ws1">see this is what we want. T<span class="_ _3"></span>he calculated addr<span class="_ _3"></span>ess is written back to the base </div><div class="t m0 xc hd y9b7 ff34 fs7 fc3 sc0 ls1 ws1">address r<span class="_ _1"></span>e<span class="_ _0"></span>gister<span class="_ _10"></span>, since other<span class="_ _0"></span>wise there is no point in using this fea<span class="_ _3"></span>ture<span class="_ _1"></span>, so </div><div class="t m0 xc hd y9b8 ff34 fs7 fc3 sc0 ls1 ws1">we don’t need the <span class="ff38">!</span>.</div><div class="t m0 x1c hd y9b9 ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e indicate we want post<span class="_ _1"></span>-index addressing by placing the items to </div><div class="t m0 xc hd y9ba ff34 fs7 fc3 sc0 ls1 ws1">add outside the square br<span class="_ _3"></span>ackets<span class="_ _3"></span>. In Listing <span class="fc5">5-7</span>, <span class="ff38">LDR</span> will load <span class="ff38">X1</span> with the </div><div class="t m0 xc hd y9bb ff34 fs7 fc3 sc0 ls1 ws1">contents of memory pointed to by <span class="ff38">X2</span> and then update <span class="ff38">X2</span> b<span class="_ _3"></span>y adding the </div><div class="t m0 xc hd y9bc ff34 fs7 fc3 sc0 ls1 ws1">immediate constant to it<span class="_ _3"></span>.</div><div class="t m0 xc h20 y9bd ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-7. <span class="_ _15"> </span><span class="ff34">Example of post-index<span class="_ _3"></span>ed addressing</span></div><div class="t m0 xc h18 y9be ff3b fs7 fc3 sc0 ls1 ws1">// Load X1 with the memory pointed to by X2</div><div class="t m0 xc h18 y9bf ff3b fs7 fc3 sc0 ls1 ws1">// Then do X2 = X2 + 2</div><div class="t m0 xc h18 y9c0 ff3b fs7 fc3 sc0 ls1 ws1">   LDR   X1, [X2], #2</div><div class="t m0 xc h3f y9c1 ff39 fs0 fc3 sc0 ls1 ws1">Converting toUpper<span class="_ _1"></span>-Case</div><div class="t m0 xc hd y9c2 ff34 fs7 fc3 sc0 ls1 ws1">As an example of how post<span class="_ _1"></span>-indexed addressing helps up write loops, let’<span class="_ _6"></span>s </div><div class="t m0 xc hd y9c3 ff34 fs7 fc3 sc0 ls1 ws1">consider looping through a s<span class="_ _3"></span>tring of ASCII bytes. Suppose we want to </div><div class="t m0 xc hd y9c4 ff34 fs7 fc3 sc0 ls1 ws1">convert any lower<span class="_ _1"></span>-case char<span class="_ _3"></span>acters to upper<span class="_ _1"></span>-case. Listing <span class="fc5">5-8</span> gives pseudo- </div><div class="t m0 xc hd y9c5 ff34 fs7 fc3 sc0 ls1 ws1">code to do this.</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf8c" data-dest-detail='[140,"XYZ",53,360,null]'><div class="d m1" style="border-style:none;position:absolute;left:253.328000px;bottom:405.759000px;width:15.048000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf8d" data-dest-detail='[141,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:317.711000px;bottom:201.446000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf8d" class="pf w2 h6" data-page-no="8d"><div class="pc pc8d w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">124</div><div class="t m0 xd h20 y4c5 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-8. <span class="_ _15"> </span><span class="ff34">Pseudo-code to con<span class="_ _3"></span>vert a string to upper<span class="_ _1"></span>-case</span></div><div class="t m0 xd h18 y4c6 ff3b fs7 fc3 sc0 ls1 ws1">i = 0</div><div class="t m0 xd h18 y4c7 ff3b fs7 fc3 sc0 ls1 ws1">DO</div><div class="t m0 xd h18 y4c8 ff3b fs7 fc3 sc0 ls1 ws1">      char = inStr[i]</div><div class="t m0 xd h18 y4c9 ff3b fs7 fc3 sc0 ls1 ws1">      IF char &gt;= &apos;a&apos; AND char &lt;= &apos;z&apos; THEN</div><div class="t m0 xd h18 y9c6 ff3b fs7 fc3 sc0 ls1 ws1">            char = char - (&apos;a&apos; - &apos;A&apos;)</div><div class="t m0 xd h18 y9c7 ff3b fs7 fc3 sc0 ls1 ws1">      END IF</div><div class="t m0 xd h18 y9c8 ff3b fs7 fc3 sc0 ls1 ws1">      outStr[i] = char</div><div class="t m0 xd h18 y9c9 ff3b fs7 fc3 sc0 ls1 ws1">      i = i + 1</div><div class="t m0 xd h18 y9ca ff3b fs7 fc3 sc0 ls1 ws1">UNTIL char == 0</div><div class="t m0 xd h18 y9cb ff3b fs7 fc3 sc0 ls1 ws1">PRINT outStr</div><div class="t m0 xc hd y9cc ff34 fs7 fc3 sc0 ls1 ws1">In this example<span class="_ _3"></span>, we are going to use NULL-terminated strings<span class="_ _3"></span>. These </div><div class="t m0 xd hd y9cd ff34 fs7 fc3 sc0 ls1 ws1">are very common in C programmin<span class="_ _3"></span>g. Her<span class="_ _1"></span>e instead of a string being </div><div class="t m0 xd hd y9ce ff34 fs7 fc3 sc0 ls1 ws1">a length and a sequence of characters<span class="_ _1"></span>, the str<span class="_ _0"></span>ing is the sequence of </div><div class="t m0 xd hd y4fd ff34 fs7 fc3 sc0 ls1 ws1">characters<span class="_ _1"></span>, followed by a NULL (AS<span class="_ _0"></span>CII code 0 or \0) char<span class="_ _3"></span>acter<span class="_ _10"></span>. T<span class="_ _1"></span>o process </div><div class="t m0 xd hd y4fe ff34 fs7 fc3 sc0 ls1 ws1">the string, we simply loop until we hit the NULL character<span class="_ _10"></span>. This is quite </div><div class="t m0 xd hd y9cf ff34 fs7 fc3 sc0 ls1 ws1">different th<span class="_ _3"></span>an the fixed length string we dealt with when printing hex digits </div><div class="t m0 xd hd y9d0 ff34 fs7 fc3 sc0 ls1 ws1">in Chapter <span class="fc5">4</span>, “<span class="_ _1"></span>Controlling Pr<span class="_ _1"></span>ogram Flow.<span class="_ _8"></span>”</div><div class="t m0 xc hd y9d1 ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve alr<span class="_ _1"></span>eady covered FOR and WHILE loops<span class="_ _1"></span>. The third common </div><div class="t m0 xd hd y9d2 ff34 fs7 fc3 sc0 ls1 ws1">structured pr<span class="_ _3"></span>ogramming loop is the <span class="ff38">DO/UNTIL</span> loop, which p<span class="_ _3"></span>uts the </div><div class="t m0 xd hd y9d3 ff34 fs7 fc3 sc0 ls1 ws1">condition at the end of the loop<span class="_ _1"></span>. In this construct, the loop is always </div><div class="t m0 xd hd y9d4 ff34 fs7 fc3 sc0 ls1 ws1">executed once. I<span class="_ _3"></span>n our case, we wan<span class="_ _3"></span>t this, since if the string is em<span class="_ _3"></span>pty, we </div><div class="t m0 xd hd y9d5 ff34 fs7 fc3 sc0 ls1 ws1">still want to cop<span class="_ _3"></span>y the NULL character<span class="_ _10"></span>, so the output string will then be </div><div class="t m0 xd hd y9d6 ff34 fs7 fc3 sc0 ls1 ws1">empty as well.</div><div class="t m0 xc hd y9d7 ff34 fs7 fc3 sc0 ls1 ws1">Another difference is tha<span class="_ _3"></span>t we aren’t ch<span class="_ _3"></span>anging the input string. I<span class="_ _3"></span>nstead </div><div class="t m0 xd hd y9d8 ff34 fs7 fc3 sc0 ls1 ws1">we leave the in<span class="_ _3"></span>put string alone and produce a new output s<span class="_ _3"></span>tring with the </div><div class="t m0 xd hd y9d9 ff34 fs7 fc3 sc0 ls1 ws1">upper<span class="_ _1"></span>-case version of the input string.</div><div class="t m0 xc hd y9da ff34 fs7 fc3 sc0 ls1 ws1">As is common in Assembly Language pr<span class="_ _3"></span>ogramming, we r<span class="_ _1"></span>everse the </div><div class="t m0 xd hd y9db ff34 fs7 fc3 sc0 ls1 ws1">logic, to jump ar<span class="_ _3"></span>ound the code in the IF block. Listing <span class="fc5">5-9</span> shows the </div><div class="t m0 xd hd y9dc ff34 fs7 fc3 sc0 ls1 ws1">updated pseudo-code.</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:87.963500px;bottom:288.634000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf8e" data-dest-detail='[142,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:287.072000px;bottom:112.634000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf8e" class="pf w2 h6" data-page-no="8e"><div class="pc pc8e w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">125</div><div class="t m0 xc h20 y4c5 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-9. <span class="_ _15"> </span><span class="ff34">Pseudo-code for how we will implement the IF </span></div><div class="t m0 xc h20 y9dd ff34 fs3 fc3 sc0 ls1 ws1">statement</div><div class="t m0 xc h18 y9de ff3b fs7 fc3 sc0 ls1 ws1">      IF char &lt; &apos;a&apos; GOTO continue</div><div class="t m0 xc h18 y9df ff3b fs7 fc3 sc0 ls1 ws1">      IF char &gt; &apos;z&apos; GOTO continue</div><div class="t m0 xc h18 y9e0 ff3b fs7 fc3 sc0 ls1 ws1">      char = char - (&apos;a&apos; - &apos;A&apos;)</div><div class="t m0 xc h18 y9e1 ff3b fs7 fc3 sc0 ls1 ws1">continue: // the rest of the program</div><div class="t m0 x1c hd y9e2 ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e don’t have the structur<span class="_ _3"></span>ed progr<span class="_ _3"></span>amming constructs of a high-level </div><div class="t m0 xc hd y9e3 ff34 fs7 fc3 sc0 ls1 ws1">language to help us<span class="_ _3"></span>, and this turns out to be quite efficient in Assembly </div><div class="t m0 xc hd y9e4 ff34 fs7 fc3 sc0 ls1 ws1">Language<span class="_ _3"></span>.</div><div class="t m0 x1c hd y9e5 ff34 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">5-10</span> is the Assembly code to convert a string to upper<span class="_ _1"></span>-case.</div><div class="t m0 xc h20 y9e6 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-10. <span class="_ _15"> </span><span class="ff34">Progr<span class="_ _3"></span>am to convert a string to upper<span class="_ _1"></span>-case</span></div><div class="t m0 xc h18 y9e7 ff3b fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y9e8 ff3b fs7 fc3 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xc h18 y9e9 ff3b fs7 fc3 sc0 ls1 ws1">// all upper case.</div><div class="t m0 xc h18 y9ea ff3b fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y9eb ff3b fs7 fc3 sc0 ls1 ws1">// X0-X2 - parameters to Linux function services</div><div class="t m0 xc h18 y9ec ff3b fs7 fc3 sc0 ls1 ws1">// X3 - address of output string</div><div class="t m0 xc h18 y9ed ff3b fs7 fc3 sc0 ls1 ws1">// X4 - address of input string</div><div class="t m0 xc h18 y9ee ff3b fs7 fc3 sc0 ls1 ws1">// W5 - current character being processed</div><div class="t m0 xc h18 y9ef ff3b fs7 fc3 sc0 ls1 ws1">// X8 - linux function number</div><div class="t m0 xc h18 y9f0 ff3b fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y9f1 ff3b fs7 fc3 sc0 ls1 ws1">.global _start // Provide program starting address to linker</div><div class="t m0 xc h18 y9f2 ff3b fs7 fc3 sc0 ls1 ws1">_start: LDR   X4, =instr      // start of input string</div><div class="t m0 xc h18 y9f3 ff3b fs7 fc3 sc0 ls1 ws1">        LDR   X3, =outstr     // address of output string</div><div class="t m0 xc h18 y9f4 ff3b fs7 fc3 sc0 ls1 ws1">// The loop is until byte pointed to by X1 is non-zero</div><div class="t m0 xc h18 y9f5 ff3b fs7 fc3 sc0 ls12 wsc9">loo<span class="_ _0"></span>p:   LD<span class="_ _0"></span>RB  W<span class="_ _0"></span>5, [X<span class="_ _0"></span>4], #<span class="_ _0"></span>1    // l<span class="_ _0"></span>oad character and <span class="_ _1"></span>incr pointer</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf8e" data-dest-detail='[142,"XYZ",53,402,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:415.634000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf8f" class="pf w2 h6" data-page-no="8f"><div class="pc pc8f w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">126</div><div class="t m0 xd h18 y46b ff3b fs7 fc3 sc0 ls1 ws1">// If W5 &gt; &apos;z&apos; then goto cont</div><div class="t m0 xd h18 y46c ff3b fs7 fc3 sc0 ls1 ws1">       CMP   W5, #&apos;z&apos;         // is letter &gt; &apos;z&apos;?</div><div class="t m0 xd h18 y46d ff3b fs7 fc3 sc0 ls1 ws1">       B.GT  cont</div><div class="t m0 xd h18 y623 ff3b fs7 fc3 sc0 ls1 ws1">// Else if W5 &lt; &apos;a&apos; then goto end if</div><div class="t m0 xd h18 y624 ff3b fs7 fc3 sc0 ls1 ws1">       CMP   W5, #&apos;a&apos;</div><div class="t m0 xd h18 y625 ff3b fs7 fc3 sc0 ls1 ws1">       B.LT  cont            // goto to end if</div><div class="t m0 xd h18 y626 ff3b fs7 fc3 sc0 ls1 ws1">// if we got here then the letter is lower case, so convert it.</div><div class="t m0 xd h18 y627 ff3b fs7 fc3 sc0 ls1 ws1">       SUB   W5, W5, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xd h18 y628 ff3b fs7 fc3 sc0 ls1 ws1">cont:  // end if</div><div class="t m0 xd h18 y9f6 ff3b fs7 fc3 sc0 ls1 ws1">       STRB  W5, [X3], #1    // store character to output str</div><div class="t m0 xd h18 y9f7 ff3b fs7 fc3 sc0 ls18 wsb6">       CMP   W<span class="_ _0"></span>5, #0          /<span class="_ _0"></span>/ stop on hitting <span class="_ _3"></span>a null character</div><div class="t m0 xd h18 y9f8 ff3b fs7 fc3 sc0 ls1 ws1">       B.NE  loop            // loop if character isn&apos;t null</div><div class="t m0 xd h18 y9f9 ff3b fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print our hex number</div><div class="t m0 xd h18 y9fa ff3b fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y9fb ff3b fs7 fc3 sc0 ls1 ws1">      MOV    X0, #1          // 1 = StdOut</div><div class="t m0 xd h18 y9fc ff3b fs7 fc3 sc0 ls1 ws1">      LDR    X1, =outstr     // string to print</div><div class="t m0 xd h18 y9fd ff3b fs7 fc3 sc0 ls1 ws1">      SUB    X2, X3, X1      //  <span class="_ _20"></span>get the len by sub&apos;ing the </div><div class="t m0 x45 h18 y9fe ff3b fs7 fc3 sc0 ls1 ws1">pointers</div><div class="t m0 xd h18 y9ff ff3b fs7 fc3 sc0 ls1 ws1">      MOV    X8, #64         // Linux write system call</div><div class="t m0 xd h18 ya00 ff3b fs7 fc3 sc0 ls1 ws1">      SVC    0               // Call Linux to output the string</div><div class="t m0 xd h18 ya01 ff3b fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xd h18 ya02 ff3b fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 ya03 ff3b fs7 fc3 sc0 ls1 ws1">      MOV    X0, #0          // Use 0 return code</div><div class="t m0 xd h18 ya04 ff3b fs7 fc3 sc0 ls1 ws1">      MOV    X8, #93         // Service code 93 terminates</div><div class="t m0 xd h18 ya05 ff3b fs7 fc3 sc0 ls1 ws1">      SVC    0               //  <span class="_ _20"></span>Call Linux to terminate the </div><div class="t m0 x45 h18 ya06 ff3b fs7 fc3 sc0 ls1 ws1">program</div><div class="t m0 xd h18 y859 ff3b fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y85a ff3b fs7 fc3 sc0 ls25 ws1">in<span class="_ _0"></span>s<span class="_ _0"></span>tr<span class="_ _0"></span>: <span class="_ _0"></span> .<span class="_ _0"></span>a<span class="_ _0"></span>sc<span class="_ _0"></span>iz<span class="_ _0"></span>  <span class="_ _0"></span>&quot;<span class="_ _0"></span>This is our Test String that we will convert.\n&quot;</div><div class="t m0 xd h18 y85b ff3b fs7 fc3 sc0 ls1 ws1">outstr:      .fill  255, 1, 0</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf90" class="pf w2 h6" data-page-no="90"><div class="pc pc90 w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">127</div><div class="t m0 x1c hd y145 ff34 fs7 fc3 sc0 ls1 ws1">If we compile and run the program<span class="_ _3"></span>, we get the desired output<span class="_ _0"></span>:</div><div class="t m0 xc h18 y2e0 ff3b fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 5$ make</div><div class="t m0 xc h18 y2e1 ff3b fs7 fc3 sc0 ls1 ws1">as   upper.s -o upper.o</div><div class="t m0 xc h18 y2d7 ff3b fs7 fc3 sc0 ls1 ws1">ld -o upper upper.o</div><div class="t m0 xc h18 y2e2 ff3b fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 5$ ./upper</div><div class="t m0 xc h18 y60e ff3b fs7 fc3 sc0 ls1 ws1">THIS IS OUR TEST STRING THAT WE WILL CONVERT.</div><div class="t m0 xc h18 y230 ff3b fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 5$</div><div class="t m0 x1c hd y231 ff34 fs7 fc3 sc0 ls1 ws1">This progr<span class="_ _3"></span>am is quite short. Besides all the comments and the code </div><div class="t m0 xc hd y2e3 ff34 fs7 fc3 sc0 ls1 ws1">to print the string and exit, there ar<span class="_ _1"></span>e only 11 Ass<span class="_ _0"></span>embly ins<span class="_ _3"></span>tructions to </div><div class="t m0 xc hd y2e4 ff34 fs7 fc3 sc0 ls1 ws1">initialize and execute the loop:</div><div class="t m0 x1e hd ya07 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Two instructions: Initialize our pointers for instr and </div><div class="t m0 x9 hd y2e6 ff34 fs7 fc3 sc0 ls1 ws1">outstr<span class="_ _10"></span>.</div><div class="t m0 x1e hd y2e7 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Five instructions: Make up the if statemen<span class="_ _3"></span>t.</div><div class="t m0 x1e hd y2e8 ff34 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Fo<span class="_ _3"></span>ur instructions<span class="_ _0"></span>: F<span class="_ _3"></span>or the loop<span class="_ _1"></span>, including loading a </div><div class="t m0 x9 hd ya08 ff34 fs7 fc3 sc0 ls1 ws1">character<span class="_ _10"></span>, saving a ch<span class="_ _3"></span>aracter<span class="_ _10"></span>, updating both pointers, </div><div class="t m0 x9 hd ya09 ff34 fs7 fc3 sc0 ls1 ws1">checking for a null ch<span class="_ _3"></span>aracter<span class="_ _10"></span>, and branching if not null.</div><div class="t m0 x1c hd ya0a ff34 fs7 fc3 sc0 ls1 ws1">It would be nice if <span class="ff38">STRB</span> also set the condition flags<span class="_ _1"></span>, but there is </div><div class="t m0 xc hd ya0b ff34 fs7 fc3 sc0 ls1 ws1">no <span class="ff38">STRBS</span> version. <span class="ff38">LDR</span> and <span class="ff38 ls1c wsbf">STR</span> just load and save; they don’t ha<span class="_ _1"></span>ve </div><div class="t m0 xc hd ya0c ff34 fs7 fc3 sc0 ls1 ws1">functionality to examine what they ar<span class="_ _1"></span>e loading or saving, so they can’t set </div><div class="t m0 xc hd y6ad ff34 fs7 fc3 sc0 ls1 ws1">the condition flags, hence the need for the <span class="ff38">CMP</span> instruction in the UNTIL </div><div class="t m0 xc hd y6ae ff34 fs7 fc3 sc0 ls1 ws1">part of the loop to test for NULL<span class="_ _0"></span>.</div><div class="t m0 x1c hd y6af ff34 fs7 fc3 sc0 ls1 ws1">In this example<span class="_ _3"></span>, we use the <span class="ff38">LDRB</span> and <span class="ff38">STRB</span> instructions, since we are </div><div class="t m0 xc hd y6b0 ff34 fs7 fc3 sc0 ls1 ws1">processing b<span class="_ _1"></span>yte by byte. The <span class="ff38">S<span class="_ _3"></span>TRB<span class="ff34"> instruction is the reverse of the </span>LDRB<span class="ff34"> </span></span></div><div class="t m0 xc hd y6b1 ff34 fs7 fc3 sc0 ls1 ws1">instruction. It sa<span class="_ _1"></span>ves its first argument to the address b<span class="_ _3"></span>uilt from all its other </div><div class="t m0 xc hd y6b2 ff34 fs7 fc3 sc0 ls1 ws1">parameters<span class="_ _1"></span>. By covering <span class="ff38">LDR</span> in so much detail, we’<span class="_ _3"></span>ve also cover<span class="_ _1"></span>ed <span class="ff38 ls1c wsbf">ST<span class="_ _0"></span>R</span> </div><div class="t m0 xc hd y6b3 ff34 fs7 fc3 sc0 ls1 ws1">which is the mirror image<span class="_ _1"></span>.</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf91" class="pf w2 h6" data-page-no="91"><div class="pc pc91 w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">128</div><div class="t m0 xc hd y145 ff34 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o convert the letter to upper<span class="_ _1"></span>-case, we use</div><div class="t m0 xd h18 y2e0 ff3b fs7 fc3 sc0 ls1 ws1">SUB   W5, W5, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xc hd y6e7 ff34 fs7 fc3 sc0 ls1 ws1">The lower<span class="_ _1"></span>-case characters h<span class="_ _3"></span>ave hi<span class="_ _3"></span>gher values than the upper<span class="_ _1"></span>-case </div><div class="t m0 xd hd y496 ff34 fs7 fc3 sc0 ls1 ws1">characters<span class="_ _1"></span>, so we just use an expression that the Assembler will evaluate t<span class="_ _3"></span>o </div><div class="t m0 xd hd y567 ff34 fs7 fc3 sc0 ls1 ws1">get the correct number to subtr<span class="_ _3"></span>act.</div><div class="t m0 xc hd y2d9 ff34 fs7 fc3 sc0 ls1 ws1">When we come to print the string, we don’t know its length and Linux </div><div class="t m0 xd hd y2da ff34 fs7 fc3 sc0 ls1 ws1">requir<span class="_ _3"></span>es the length. W<span class="_ _1"></span>e use the following instruction:</div><div class="t m0 xd h18 y2db ff3b fs7 fc3 sc0 ls1 ws1">SUB   X2, X3, X1</div><div class="t m0 xc hd y2dc ff34 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e we’<span class="_ _1"></span>ve just loaded <span class="ff38">X1</span> with the address of outstr<span class="_ _6"></span>. <span class="ff38">X3</span> held </div><div class="t m0 xd hd y2dd ff34 fs7 fc3 sc0 ls1 ws1">the address of outs<span class="_ _3"></span>tr in our loop<span class="_ _1"></span>, but because we used p<span class="_ _0"></span>ost<span class="_ _1"></span>-indexed </div><div class="t m0 xd hd y2de ff34 fs7 fc3 sc0 ls1 ws1">addressing<span class="_ _3"></span>, it got incremented in each iter<span class="_ _1"></span>ation of the loop. As a r<span class="_ _1"></span>esult, it </div><div class="t m0 xd hd y54e ff34 fs7 fc3 sc0 ls1 ws1">is now pointing 1 past the end of the string. W<span class="_ _1"></span>e then calcula<span class="_ _3"></span>te the length </div><div class="t m0 xd hd y54f ff34 fs7 fc3 sc0 ls1 ws1">by subtr<span class="_ _3"></span>acting the address of the s<span class="_ _3"></span>tart of the string from the addres<span class="_ _3"></span>s of the </div><div class="t m0 xd hd y550 ff34 fs7 fc3 sc0 ls1 ws1">end of the string. W<span class="_ _1"></span>e could hav<span class="_ _3"></span>e kept a counter for this in our loop<span class="_ _1"></span>, but in </div><div class="t m0 xd hd y551 ff34 fs7 fc3 sc0 ls1 ws1">Assembly we are trying to be efficient, so we want as few instructions as </div><div class="t m0 xd hd y552 ff34 fs7 fc3 sc0 ls1 ws1">possible in our loops.</div><div class="t m0 xc hd y553 ff34 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at Listing <span class="fc5">5-11</span>, a disassembly of our pr<span class="_ _3"></span>ogram<span class="_ _3"></span>.</div><div class="t m0 xd h20 ya0d ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-11. <span class="_ _15"> </span><span class="ff34">Disassembly of the upper<span class="_ _1"></span>-case program</span></div><div class="t m0 xd h18 ya0e ff3b fs7 fc3 sc0 ls1 ws1">Disassembly of section .text:</div><div class="t m0 xd h18 ya0f ff3b fs7 fc3 sc0 ls1 ws1">00000000004000b0 &lt;_start&gt;:</div><div class="t m0 xd h18 ya10 ff3b fs7 fc3 sc0 ls1 ws1">  4000b0:    58000284    ldr    x4, 400100 &lt;cont+0x30&gt;</div><div class="t m0 xd h18 ya11 ff3b fs7 fc3 sc0 ls1 ws1">  4000b4:    580002a3    ldr    x3, 400108 &lt;cont+0x38&gt;</div><div class="t m0 xd h18 ya12 ff3b fs7 fc3 sc0 ls1 ws1">00000000004000b8 &lt;loop&gt;:</div><div class="t m0 xd h18 ya13 ff3b fs7 fc3 sc0 ls1 ws1">  4000b8:    38401485    ldrb   w5, [x4], #1</div><div class="t m0 xd h18 ya14 ff3b fs7 fc3 sc0 ls1 ws1">  4000bc:    7101e8bf    cmp    w5, #0x7a</div><div class="t m0 xd h18 ya15 ff3b fs7 fc3 sc0 ls1 ws1">  4000c0:    5400008c    b.gt   4000d0 &lt;cont&gt;</div><div class="t m0 xd h18 ya16 ff3b fs7 fc3 sc0 ls1 ws1">  4000c4:    710184bf    cmp    w5, #0x61</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf91" data-dest-detail='[145,"XYZ",35,276,null]'><div class="d m1" style="border-style:none;position:absolute;left:145.739000px;bottom:289.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf92" class="pf w2 h6" data-page-no="92"><div class="pc pc92 w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">129</div><div class="t m0 xc h18 y46b ff3b fs7 fc3 sc0 ls1 ws1">  4000c8:    5400004b    b.lt   4000d0 &lt;cont&gt; // b.tstop</div><div class="t m0 xc h18 y46c ff3b fs7 fc3 sc0 ls1 ws1">  4000cc:    510080a5    sub    w5, w5, #0x20</div><div class="t m0 xc h18 ya17 ff3b fs7 fc3 sc0 ls1 ws1">00000000004000d0 &lt;cont&gt;:</div><div class="t m0 xc h18 y85c ff3b fs7 fc3 sc0 ls1 ws1">  4000d0:    38001465    strb   w5, [x3], #1</div><div class="t m0 xc h18 y46f ff3b fs7 fc3 sc0 ls1 ws1">  4000d4:    710000bf    cmp    w5, #0x0</div><div class="t m0 xc h18 y85d ff3b fs7 fc3 sc0 ls1 ws1">  4000d8:    54ffff01    b.ne   4000b8 &lt;loop&gt;  // b.any</div><div class="t m0 xc h18 y85e ff3b fs7 fc3 sc0 ls1 ws1">  4000dc:    d2800020    mov    x0, #0x1       // #1</div><div class="t m0 xc h18 y847 ff3b fs7 fc3 sc0 ls1 ws1">  4000e0:    58000141    ldr    x1, 400108 &lt;cont+0x38&gt;</div><div class="t m0 xc h18 y85f ff3b fs7 fc3 sc0 ls1 ws1">  4000e4:    cb010062    sub    x2, x3, x1</div><div class="t m0 xc h18 y629 ff3b fs7 fc3 sc0 ls1 ws1">  4000e8:    d2800808    mov    x8, #0x40      // #64</div><div class="t m0 xc h18 y62a ff3b fs7 fc3 sc0 ls1 ws1">  4000ec:    d4000001    svc    #0x0</div><div class="t m0 xc h18 y62b ff3b fs7 fc3 sc0 ls1 ws1">  4000f0:    d2800000    mov    x0, #0x0       // #0</div><div class="t m0 xc h18 y9f9 ff3b fs7 fc3 sc0 ls1 ws1">  4000f4:    d2800ba8    mov    x8, #0x5d      // #93</div><div class="t m0 xc h18 y9fa ff3b fs7 fc3 sc0 ls1 ws1">  4000f8:    d4000001    svc    #0x0</div><div class="t m0 xc h18 y9fb ff3b fs7 fc3 sc0 ls1 ws1">  4000fc:    00000000    .inst  0x00000000 ; undefined</div><div class="t m0 xc h18 y9fc ff3b fs7 fc3 sc0 ls1 ws1">  400100:    00410110    .word  0x00410110</div><div class="t m0 xc h18 y9fd ff3b fs7 fc3 sc0 ls1 ws1">  400104:    00000000    .word  0x00000000</div><div class="t m0 xc h18 y9fe ff3b fs7 fc3 sc0 ls1 ws1">  400108:    0041013f    .word  0x0041013f</div><div class="t m0 xc h18 y9ff ff3b fs7 fc3 sc0 ls1 ws1">  40010c:    00000000    .word  0x00000000</div><div class="t m0 xc h18 ya18 ff3b fs7 fc3 sc0 ls1 ws1">Contents of section .data:</div><div class="t m0 xc h18 ya01 ff3b fs7 fc3 sc0 ls1 ws1"> 410110 54686973 20697320 6f757220 54657374  This is our Test</div><div class="t m0 xc h18 ya02 ff3b fs7 fc3 sc0 ls1 ws1"> 410120 20537472 696e6720 74686174 20776520   String that we</div><div class="t m0 xc h18 ya03 ff3b fs7 fc3 sc0 ls1 ws1"> 410130 77696c6c 20636f6e 76657274 2e0a0000  will convert....</div><div class="t m0 xc h18 ya04 ff3b fs7 fc3 sc0 ls1 ws1"> 410140 00000000 00000000 00000000 00000000  ................</div><div class="t m0 x1c hd y857 ff34 fs7 fc3 sc0 ls1 ws1">The instruction</div><div class="t m0 xc h18 ya19 ff3b fs7 fc3 sc0 ls1 ws1">LDR   X4, =instr</div><div class="t m0 xc hd ya1a ff34 fs7 fc3 sc0 ls1 ws1">is converted to</div><div class="t m0 xc h18 ya1b ff3b fs7 fc3 sc0 ls1 ws1">ldr   x4, 400100 &lt;cont+0x30&gt;</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf93" class="pf w2 h6" data-page-no="93"><div class="pc pc93 w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">130</div><div class="t m0 xc hd y145 ff34 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e objdump is trying to be helpful by telling us what will be loaded, </div><div class="t m0 xd hd y146 ff34 fs7 fc3 sc0 ls1 ws1">namely, the addr<span class="_ _3"></span>ess stored at addr<span class="_ _1"></span>ess 0x400100, which the Assembler </div><div class="t m0 xd hd y147 ff34 fs7 fc3 sc0 ls1 ws1">added to our .text section to hold the address of o<span class="_ _3"></span>ur input string. If we look </div><div class="t m0 xd hd y1b0 ff34 fs7 fc3 sc0 ls1 ws1">at addres<span class="_ _3"></span>s 0x400100, we see it contains 0x00410110, which is the address </div><div class="t m0 xd hd y1b1 ff34 fs7 fc3 sc0 ls1 ws1">of instr in the .data section. It mi<span class="_ _3"></span>ght appear her<span class="_ _3"></span>e that the addr<span class="_ _1"></span>ess<span class="_ _0"></span>es ar<span class="_ _3"></span>e 32 </div><div class="t m0 xd hd y1b2 ff34 fs7 fc3 sc0 ls1 ws1">bits, but this is objdum<span class="_ _3"></span>p doing some misinterpr<span class="_ _3"></span>etation. N<span class="_ _3"></span>otice the 0 word </div><div class="t m0 xd hd y1b3 ff34 fs7 fc3 sc0 ls1 ws1">before the addr<span class="_ _3"></span>ess, whic<span class="_ _3"></span>h objdump has listed as an illegal instruction, </div><div class="t m0 xd hd y1b4 ff34 fs7 fc3 sc0 ls1 ws1">whereas this is r<span class="_ _1"></span>eally the other half of our address<span class="_ _3"></span>.</div><div class="t m0 xc hd y1b5 ff34 fs7 fc3 sc0 ls1 ws1">If we look at the actual encoding of the instruction, it is 0x58000284. </div><div class="t m0 xd hd y1b6 ff34 fs7 fc3 sc0 ls1 ws1">The 58 is the opcode and the low-order 5 bits ar<span class="_ _1"></span>e the register number<span class="_ _10"></span>, in </div><div class="t m0 xd hd y1b7 ff34 fs7 fc3 sc0 ls1 ws1">this case 4. This means the offset encoded in the instruction is 101000in </div><div class="t m0 xd hd ya1c ff34 fs7 fc3 sc0 ls1 ws1">binary. Remember the offset is in words, so we need to shift left 2 bits to </div><div class="t m0 xd hd ya1d ff34 fs7 fc3 sc0 ls1 ws1">multiply by 4 for the offset in b<span class="_ _3"></span>ytes which gives 0101 0000in binary which </div><div class="t m0 xd hd y944 ff34 fs7 fc3 sc0 ls1 ws1">is 0x50in hex. If w<span class="_ _0"></span>e add 0x50 to the addr<span class="_ _1"></span>ess of the <span class="ff38">L<span class="_ _0"></span>DR</span> instruction which </div><div class="t m0 xd hd y945 ff34 fs7 fc3 sc0 ls1 ws1">is 0x4000b0, we get the desired addres<span class="_ _3"></span>s of 0x400100. Aren’t we glad the </div><div class="t m0 xd hd ya1e ff34 fs7 fc3 sc0 ls1 ws1">Assembler does all this for us?</div><div class="t m0 xc hd ya1f ff34 fs7 fc3 sc0 ls1 ws1">This shows how the Assembler added the liter<span class="_ _1"></span>al for the address of the </div><div class="t m0 xd hd ya20 ff34 fs7 fc3 sc0 ls1 ws1">string instr at the end of the code section. When we do the <span class="ff38">LDR</span>, it accesses </div><div class="t m0 xd hd ya21 ff34 fs7 fc3 sc0 ls1 ws1">this literal and loads it into memory; this gives us the address we need </div><div class="t m0 xd hd ya22 ff34 fs7 fc3 sc0 ls1 ws1">in memory. The other literal added to the code section is the address of </div><div class="t m0 xd hd ya23 ff34 fs7 fc3 sc0 ls1 ws1">outstr<span class="_ _10"></span>.</div><div class="t m0 xc hd ya24 ff34 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o see this program in action, it is worthwhile to single st<span class="_ _3"></span>ep through it </div><div class="t m0 xd hd ya25 ff34 fs7 fc3 sc0 ls1 ws1">in <span class="ff38">gdb</span>. Y<span class="_ _1"></span>ou can wa<span class="_ _3"></span>tch the registers with the “i r” (info registers) command. </div><div class="t m0 xd hd ya26 ff34 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o view instr and oustr as the processing occurs<span class="_ _1"></span>, there are a couple of </div><div class="t m0 xd hd ya27 ff34 fs7 fc3 sc0 ls1 ws1">ways of doing it<span class="_ _3"></span>. From the disassembly, we kno<span class="_ _3"></span>w the address of instr is </div><div class="t m0 xd hd ya28 ff34 fs7 fc3 sc0 ls1 ws1">0x410110, so we can enter</div><div class="t m0 xd h18 ya29 ff3b fs7 fc3 sc0 ls1 ws1">(gdb) x /2s 0x410110</div><div class="t m0 xd h18 ya2a ff3b fs7 fc3 sc0 ls1 ws1">0x410110:       &quot;This is our Test String that we will </div><div class="t m0 xd h18 ya2b ff3b fs7 fc3 sc0 ls1 ws1">convert.\n&quot;</div><div class="t m0 xd h18 ya2c ff3b fs7 fc3 sc0 ls1 ws1">0x41013f:       &quot;TH&quot;</div><div class="t m0 xd h18 ya2d ff3b fs7 fc3 sc0 ls1 ws1">(gdb)</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf94" class="pf w2 h6" data-page-no="94"><div class="pc pc94 w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">131</div><div class="t m0 x1c hd y145 ff34 fs7 fc3 sc0 ls1 ws1">This is convenien<span class="_ _3"></span>t since the x command knows ho<span class="_ _3"></span>w to format strings<span class="_ _3"></span>, </div><div class="t m0 xc hd y146 ff34 fs7 fc3 sc0 ls1 ws1">but it doesn’t know about la<span class="_ _3"></span>bels. W<span class="_ _1"></span>e can also enter</div><div class="t m0 xc h18 y2e1 ff3b fs7 fc3 sc0 ls1 ws1">(gdb) p (char[10]) outstr</div><div class="t m0 xc h18 y2d7 ff3b fs7 fc3 sc0 ls1 ws1">$1 = &quot;TH\000\000\000\000\000\000\000&quot;</div><div class="t m0 xc h18 y2e2 ff3b fs7 fc3 sc0 ls1 ws1">(gdb)</div><div class="t m0 x1c hd y2d9 ff34 fs7 fc3 sc0 ls1 ws1">The print (p) command knows a<span class="_ _3"></span>bout our labels but doesn’t know </div><div class="t m0 xc hd y2da ff34 fs7 fc3 sc0 ls1 ws1">about our data types<span class="_ _1"></span>, and w<span class="_ _0"></span>e mus<span class="_ _3"></span>t cast the label to tell it how to forma<span class="_ _3"></span>t </div><div class="t m0 xc hd y231 ff34 fs7 fc3 sc0 ls1 ws1">the output. Gdb handles this better with high-level langua<span class="_ _3"></span>ges because it </div><div class="t m0 xc hd y2e3 ff34 fs7 fc3 sc0 ls1 ws1">knows about the data types of the v<span class="_ _3"></span>ariables. I<span class="_ _3"></span>n Assembly, we are closer to </div><div class="t m0 xc hd y2e4 ff34 fs7 fc3 sc0 ls1 ws1">the metal.</div><div class="t m0 xc h15 y2af ff39 fsb fc3 sc0 ls1 wsaf"> Storing <span class="_ _11"> </span>aRegister</div><div class="t m0 xc hd y2b0 ff34 fs7 fc3 sc0 ls1 ws1">The store r<span class="_ _1"></span>egister <span class="ff38 ls1c wsbf">STR</span> instr<span class="_ _0"></span>uction is a mirror of the <span class="ff38">LDR</span> instruction. All </div><div class="t m0 xc hd ya2e ff34 fs7 fc3 sc0 ls1 ws1">the addressing modes we<span class="_ _3"></span>’<span class="_ _3"></span>ve talked about for <span class="ff38">LDR</span> work for <span class="ff38 ls1c wsbf">STR</span>. This is </div><div class="t m0 xc hd ya2f ff34 fs7 fc3 sc0 ls1 ws1">necessary since in a load-store ar<span class="_ _1"></span>chitecture, we need to stor<span class="_ _3"></span>e everything </div><div class="t m0 xc hd y2b3 ff34 fs7 fc3 sc0 ls1 ws1">we load after it is processed in the CPU<span class="_ _1"></span>.W<span class="_ _1"></span>e’ve seen the <span class="ff38 ls1c wsbf">STR</span> instruction a </div><div class="t m0 xc hd y34b ff34 fs7 fc3 sc0 ls1 ws1">couple of times already in o<span class="_ _3"></span>ur examples.</div><div class="t m0 x1c hd y34c ff34 fs7 fc3 sc0 ls1 ws1">If we are using the same r<span class="_ _1"></span>egisters to load and store the data in a loop<span class="_ _1"></span>, </div><div class="t m0 xc hd ya30 ff34 fs7 fc3 sc0 ls1 ws1">typically the first <span class="ff38">LDR</span> call will use pre-indexed addr<span class="_ _3"></span>essing without write </div><div class="t m0 xc hd ya31 ff34 fs7 fc3 sc0 ls1 ws1">back and then the <span class="ff38 ls1c wsbf">STR</span> instruction will use post-indexed addr<span class="_ _3"></span>essing with </div><div class="t m0 xc hd y34f ff34 fs7 fc3 sc0 ls1 ws1">write back to advance to the next item for the next iter<span class="_ _1"></span>ation of the loop.</div><div class="t m0 xc h15 ya32 ff39 fsb fc3 sc0 ls1 wsaf"> Double <span class="_ _11"> </span>Registers</div><div class="t m0 xc hd ya33 ff34 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e doubleword versions of all the <span class="ff38">LDR</span> and <span class="ff38 ls1c wsbf">STR</span> instructions we’ve </div><div class="t m0 xc hd ya34 ff34 fs7 fc3 sc0 ls1 ws1">seen. The <span class="ff38">LDP</span> instruction takes a pair of registers to load as par<span class="_ _3"></span>ameters </div><div class="t m0 xc hd ya35 ff34 fs7 fc3 sc0 ls1 ws1">and then loads 128 bits of memory into these. Similarly for the <span class="ff38 ls1c wsbf">STP</span> </div><div class="t m0 xc hd ya36 ff34 fs7 fc3 sc0 ls1 ws1">instruction.</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf95" class="pf w2 h6" data-page-no="95"><div class="pc pc95 w2 h6"><div class="t m0 xd hd y3f ff34 fs7 fc3 sc0 ls1 ws1">132</div><div class="t m0 xc hd y145 ff34 fs7 fc3 sc0 ls1 ws1">For exam<span class="_ _3"></span>ple, Listing <span class="fc5">5-12</span> loads the addr<span class="_ _1"></span>ess of a 128-bit quantity (the </div><div class="t m0 xd hd y146 ff34 fs7 fc3 sc0 ls1 ws1">address is still 64 bits) and then loads the 128 bits in<span class="_ _3"></span>to <span class="ff38">X2</span> and <span class="ff38">X3</span>. Then we </div><div class="t m0 xd hd y147 ff34 fs7 fc3 sc0 ls1 ws1">store <span class="ff38">X2</span> and <span class="ff38">X3</span> bac<span class="_ _3"></span>k into the myocta<span class="_ _1"></span>word.</div><div class="t m0 xd h20 ya37 ff3a fs3 fc3 sc0 ls1 ws1">Listing 5-12. <span class="_ _15"> </span><span class="ff34">Example of loading and storing a doubleword</span></div><div class="t m0 xd h18 ya38 ff3b fs7 fc3 sc0 ls1 ws1">      LDR   X1, =myoctaword</div><div class="t m0 xd h18 ya39 ff3b fs7 fc3 sc0 ls1 ws1">      LDP   X2, X3, [X1]</div><div class="t m0 xd h18 ya3a ff3b fs7 fc3 sc0 ls1 ws1">      STP   X2, X3, [X1]</div><div class="t m0 xd h18 ya3b ff3b fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 ya3c ff3b fs7 fc3 sc0 ls1 ws1">myoctaword: .OCTA 0x12345678876543211234567887654321</div><div class="t m0 xc hd ya3d ff34 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will us<span class="_ _0"></span>e these instructions extensively when we need to sa<span class="_ _3"></span>ve </div><div class="t m0 xd hd ya3e ff34 fs7 fc3 sc0 ls1 ws1">registers to the stac<span class="_ _3"></span>k and later r<span class="_ _3"></span>estore them in Ch<span class="_ _3"></span>apter <span class="fc5">6</span>, “F<span class="_ _3"></span>unctions and </div><div class="t m0 xd hd ya3f ff34 fs7 fc3 sc0 ls1 ws1">the Stack.<span class="_ _8"></span>”</div><div class="t m0 xd h15 ya40 ff39 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd ya41 ff34 fs7 fc3 sc0 ls1 ws1">With this cha<span class="_ _3"></span>pter<span class="_ _6"></span>, we can now load data fr<span class="_ _1"></span>om memor<span class="_ _0"></span>y, operate on it in the </div><div class="t m0 xd hd ya42 ff34 fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>, and then save the res<span class="_ _3"></span>ult back to memory. W<span class="_ _3"></span>e examined how the </div><div class="t m0 xd hd ya43 ff34 fs7 fc3 sc0 ls1 ws1">data load and stor<span class="_ _3"></span>e instructions help us with arrays of data and how they </div><div class="t m0 xd hd ya44 ff34 fs7 fc3 sc0 ls1 ws1">help us index through da<span class="_ _3"></span>ta in loops.</div><div class="t m0 xc hd ya45 ff34 fs7 fc3 sc0 ls1 ws1">In the next cha<span class="_ _3"></span>pter<span class="_ _6"></span>, we will look at how to make our code r<span class="_ _1"></span>eusable; </div><div class="t m0 xd hd ya46 ff34 fs7 fc3 sc0 ls1 ws1">after all, wouldn’t our upper<span class="_ _1"></span>-case program be handy if we could c<span class="_ _3"></span>all it </div><div class="t m0 xd hd ya47 ff34 fs7 fc3 sc0 ls1 ws1">whenever we wish?</div><div class="t m0 xd h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div><a class="l" href="#pf95" data-dest-detail='[149,"XYZ",35,532,null]'><div class="d m1" style="border-style:none;position:absolute;left:151.007000px;bottom:577.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:290.603000px;bottom:388.862000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf96" class="pf w2 h6" data-page-no="96"><div class="pc pc96 w2 h6"><div class="t m0 x17 hd y3f ff34 fs7 fc3 sc0 ls1 ws1">133</div><div class="t m0 xc h15 y186 ff39 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 x1c hd y355 ff34 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Create a sm<span class="_ _3"></span>all progr<span class="_ _3"></span>am to try out all the data </div><div class="t m0 x9 hd y356 ff34 fs7 fc3 sc0 ls1 ws1">definition directives the Assembler pr<span class="_ _1"></span>ovides. </div><div class="t m0 x9 hd ya48 ff34 fs7 fc3 sc0 ls1 ws1">Assemble your pr<span class="_ _3"></span>ogram and use objdump to </div><div class="t m0 x9 hd ya49 ff34 fs7 fc3 sc0 ls1 ws1">examine the data. A<span class="_ _3"></span>dd some align directives and </div><div class="t m0 x9 hd ya4a ff34 fs7 fc3 sc0 ls1 ws1">examine how they move ar<span class="_ _1"></span>ound.</div><div class="t m0 x1c hd ya4b ff34 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Explain how the <span class="ff38">LDR</span> instruction lets you load any </div><div class="t m0 x9 hd ya4c ff34 fs7 fc3 sc0 ls1 ws1">64-bit address in only one 32-bit instruction.</div><div class="t m0 x1c hd ya4d ff34 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Write a program tha<span class="_ _3"></span>t converts a string to all lower<span class="_ _1"></span>-</div><div class="t m0 x9 hd ya4e ff34 fs7 fc3 sc0 ls1a wsbd">ca<span class="_ _0"></span>se.</div><div class="t m0 x1c hd y35e ff34 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Write a program tha<span class="_ _3"></span>t converts any non-alph<span class="_ _3"></span>abetic </div><div class="t m0 x9 hd ya4f ff34 fs7 fc3 sc0 ls1 ws1">character in a NULL- <span class="_ _b"></span>terminated string to a space<span class="_ _3"></span>.</div><div class="t m0 x42 h12 y71 ff3c fsa fc3 sc0 ls1 ws1">CHAPTER 5 <span class="_ _f"> </span> <span class="_ _1"></span>THANKS FORTHE MEMORIES</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf97" class="pf w2 h6" data-page-no="97"><div class="pc pc97 w2 h6"><div class="t m0 x17 hd y16a ff3e fs7 fc3 sc0 ls1 ws1">135</div><div class="t m0 xc h17 y16b ff3e fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff3e fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff3f">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff3e">,  </span></span></div><div class="t m0 xc h17 y16d ff3e fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_6</div><div class="t m0 xc ha y16e ff40 fs6 fc3 sc0 ls1 ws1">CHAPTER 6</div><div class="t m0 xc h8 y16f ff41 fs4 fc3 sc0 ls1 ws1">Functions and </div><div class="t m0 xc h8 y747 ff41 fs4 fc3 sc0 ls1 ws1">theStack</div><div class="t m0 xc hd y748 ff3e fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we will examine how to organize our code into small </div><div class="t m0 xc hd y749 ff3e fs7 fc3 sc0 ls1 ws1">independent units called <span class="ff42">functions</span>. This allows us to build r<span class="_ _1"></span>eusable </div><div class="t m0 xc hd y74a ff3e fs7 fc3 sc0 ls1 ws1">components<span class="_ _3"></span>, which we can call easily form anywher<span class="_ _3"></span>e we wish by setting </div><div class="t m0 xc hd y74b ff3e fs7 fc3 sc0 ls1 ws1">up parameters and callin<span class="_ _3"></span>g them.</div><div class="t m0 x1c hd y74c ff3e fs7 fc3 sc0 ls1 ws1">Typic<span class="_ _3"></span>ally, in software development<span class="_ _3"></span>, we start with low-level </div><div class="t m0 xc hd y74d ff3e fs7 fc3 sc0 ls1 ws1">components<span class="_ _3"></span>. Then we build on these to crea<span class="_ _3"></span>te higher<span class="_ _1"></span>- and higher<span class="_ _1"></span>-level </div><div class="t m0 xc hd y74e ff3e fs7 fc3 sc0 ls1 ws1">modules. So far<span class="_ _10"></span>, w<span class="_ _0"></span>e know ho<span class="_ _3"></span>w to loop<span class="_ _1"></span>, per<span class="_ _0"></span>form conditional logic, and </div><div class="t m0 xc hd y74f ff3e fs7 fc3 sc0 ls1 ws1">perform some ar<span class="_ _0"></span>ithmetic. N<span class="_ _1"></span>ow, we examine how to compartmentalize </div><div class="t m0 xc hd y8c6 ff3e fs7 fc3 sc0 ls1 ws1">code into building blocks<span class="_ _1"></span>.</div><div class="t m0 x1c hd y8c7 ff3e fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e introduce the <span class="ff42">stack</span>, a computer science data s<span class="_ _3"></span>tructure for storing </div><div class="t m0 xc hd y8c8 ff3e fs7 fc3 sc0 ls1 ws1">data. If we<span class="_ _3"></span>’re going to b<span class="_ _3"></span>uild useful reusable functions<span class="_ _1"></span>, we ne<span class="_ _0"></span>ed a good </div><div class="t m0 xc hd y8c9 ff3e fs7 fc3 sc0 ls1 ws1">way to man<span class="_ _3"></span>age register us<span class="_ _3"></span>age, so tha<span class="_ _3"></span>t all these functions don’t clobber </div><div class="t m0 xc hd y8ca ff3e fs7 fc3 sc0 ls1 ws1">each other<span class="_ _6"></span>. In Cha<span class="_ _3"></span>pter <span class="fc5">5</span>, “Thanks for the Memories,<span class="_ _8"></span>” we studied how to </div><div class="t m0 xc hd y8cb ff3e fs7 fc3 sc0 ls1 ws1">store da<span class="_ _3"></span>ta in a data segment in main memory. The problem with this is </div><div class="t m0 xc hd y8cc ff3e fs7 fc3 sc0 ls1 ws1">that this memory exists for the duration that the pr<span class="_ _1"></span>ogram runs. With small </div><div class="t m0 xc hd y8cd ff3e fs7 fc3 sc0 ls1 ws1">functions, like con<span class="_ _1"></span>verting to upper-c<span class="_ _3"></span>ase, they run quickly; thus they might </div><div class="t m0 xc hd y8ce ff3e fs7 fc3 sc0 ls1 ws1">need a few memor<span class="_ _0"></span>y locations while they run, but when they’r<span class="_ _3"></span>e done, they </div><div class="t m0 xc hd y8cf ff3e fs7 fc3 sc0 ls1 ws1">don’t need this memor<span class="_ _0"></span>y anymor<span class="_ _1"></span>e. Stacks pr<span class="_ _3"></span>ovide us a tool to man<span class="_ _3"></span>age </div><div class="t m0 xc hd y8d0 ff3e fs7 fc3 sc0 ls1 ws1">register usage acr<span class="_ _1"></span>oss function calls and a tool to provide memory to </div><div class="t m0 xc hd ya50 ff3e fs7 fc3 sc0 ls1 ws1">functions for the duration of their in<span class="_ _3"></span>vocation.</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:160.358000px;bottom:220.802000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf98" class="pf w2 h6" data-page-no="98"><div class="pc pc98 w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">136</div><div class="t m0 xc hd y145 ff3e fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e introduce several lo<span class="_ _3"></span>w-level concepts first, and then we put them all </div><div class="t m0 xd hd y146 ff3e fs7 fc3 sc0 ls1 ws1">together to effectively crea<span class="_ _3"></span>te and use functions. F<span class="_ _3"></span>irst up is the abstr<span class="_ _3"></span>act data </div><div class="t m0 xd hd y147 ff3e fs7 fc3 sc0 ls1 ws1">type called a stack that is a con<span class="_ _1"></span>venient mechanism to store data for the </div><div class="t m0 xd hd y1b0 ff3e fs7 fc3 sc0 ls1 ws1">duration of a function c<span class="_ _3"></span>all.</div><div class="t m0 xd h15 y30f ff43 fsb fc3 sc0 ls1 wsaf"> Stacks <span class="_ _11"> </span>onLinux</div><div class="t m0 xd hd y57a ff3e fs7 fc3 sc0 ls1 ws1">In computer science<span class="_ _3"></span>, a stack is an ar<span class="_ _3"></span>ea of memory where there ar<span class="_ _3"></span>e two </div><div class="t m0 xd hd y57b ff3e fs7 fc3 sc0 ls1 ws1">operations:</div><div class="t m0 xa hd ya51 ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42">Push</span>: Adds an element to the ar<span class="_ _1"></span>ea</div><div class="t m0 xa hd ya52 ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42 ls1c wsbf">Pop</span>: Returns and remo<span class="_ _1"></span>ves the element that was most </div><div class="t m0 x1e hd ya53 ff3e fs7 fc3 sc0 ls1 ws1">recently added</div><div class="t m0 xc hd ya54 ff3e fs7 fc3 sc0 ls1 ws1">This beha<span class="_ _3"></span>vior is also called a <span class="ff42 ls8 ws9f">LIFO</span> (last in first out) queue.</div><div class="t m0 xc hd ya55 ff3e fs7 fc3 sc0 ls1 ws1">When Linux runs a program<span class="_ _1"></span>, it gives it an 8-megabyte stack. In </div><div class="t m0 xd hd ya56 ff3e fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>G<span class="_ _0"></span>ettin<span class="_ _3"></span>g Started,<span class="_ _8"></span>” we mentioned that regist<span class="_ _3"></span>er <span class="ff42">X31</span> had a special </div><div class="t m0 xd hd ya57 ff3e fs7 fc3 sc0 ls1 ws1">purpose as both the zero r<span class="_ _3"></span>egister and the stack pointer (<span class="ff42">SP</span>). Y<span class="_ _6"></span>ou might </div><div class="t m0 xd hd ya58 ff3e fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve noticed that <span class="ff42">X31</span> is named <span class="ff42">SP</span> in <span class="ff42">gdb</span> and tha<span class="_ _3"></span>t when you debugged </div><div class="t m0 xd hd ya59 ff3e fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams, it h<span class="_ _3"></span>ad a large value<span class="_ _3"></span>, something like 0x7ffffff230. This is a pointer </div><div class="t m0 xd hd ya5a ff3e fs7 fc3 sc0 ls1 ws1">to the current stac<span class="_ _3"></span>k location.</div><div class="t m0 xc hd ya5b ff3e fs7 fc3 sc0 ls1 ws1">The ARM instruction set has a handful of instructions to manipula<span class="_ _3"></span>te </div><div class="t m0 xd hd ya5c ff3e fs7 fc3 sc0 ls1 ws1">the stack<span class="_ _0"></span>; remember th<span class="_ _3"></span>at any instruction that doesn’t oper<span class="_ _3"></span>ate on the stack </div><div class="t m0 xd hd ya5d ff3e fs7 fc3 sc0 ls1 ws1">sees it as the zero r<span class="_ _3"></span>egister<span class="_ _6"></span>. There ar<span class="_ _1"></span>e two instr<span class="_ _0"></span>uctions to place r<span class="_ _3"></span>egisters on </div><div class="t m0 xd hd ya5e ff3e fs7 fc3 sc0 ls1 ws1">the stack, <span class="ff42 ls1c wsbf">STR</span> and <span class="ff42 ls1c wsbf">STP</span>, and then two instructions to retrieve items from </div><div class="t m0 xd hd ya5f ff3e fs7 fc3 sc0 ls1 ws1">the stack into r<span class="_ _3"></span>egisters<span class="_ _3"></span>, <span class="ff42">LDR</span> and <span class="ff42">LDP</span>. W<span class="_ _1"></span>e studied all thes<span class="_ _0"></span>e instructions </div><div class="t m0 xd hd ya60 ff3e fs7 fc3 sc0 ls1 ws1">in Chapter <span class="fc5">5</span>, “Thanks for the Memories<span class="_ _3"></span>,<span class="_ _8"></span>” but here we<span class="_ _3"></span>’ll use specific </div><div class="t m0 xd hd ya61 ff3e fs7 fc3 sc0 ls1 ws1">forms to copy data to and fr<span class="_ _3"></span>om the stack and to adjust the s<span class="_ _3"></span>tack pointer </div><div class="t m0 xd hd ya62 ff3e fs7 fc3 sc0 ls1 ws9b"> appropriately.</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:76.259700px;bottom:327.175000px;width:5.500000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:87.963500px;bottom:167.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf99" class="pf w2 h6" data-page-no="99"><div class="pc pc99 w2 h6"><img class="bi xc ya63 w7 h28" alt="" src="bg99.png"/><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">137</div><div class="t m0 x36 h41 y82c ff43 fse fc3 sc0 ls1 ws1">Note<span class="ff44"> <span class="_ _17"> </span>The <span class="_ _1"></span>ARM hardware requires that <span class="ff43">SP</span> is al<span class="_ _0"></span>ways 16-byte </span></div><div class="t m0 x36 h41 y82d ff44 fse fc3 sc0 ls1 ws1">aligned.<span class="_ _1"></span> <span class="_ _1"></span>This means we can only add and subtract from <span class="ff43">SP</span> with </div><div class="t m0 x36 h41 y82e ff44 fse fc3 sc0 ls1 ws1">multiples of 16.<span class="_ _1"></span> If we use <span class="ff43">SP</span> when it isn’t 16-byte aligned,<span class="_ _1"></span> we will </div><div class="t m0 x36 h41 ya64 ff44 fse fc3 sc0 ls1 ws1">get a bus error and our program will terminate.</div><div class="t m0 x1c hd ya65 ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o copy the single r<span class="_ _3"></span>egister <span class="ff42">X0</span> to the stack, we use</div><div class="t m0 xc h18 ya66 ff45 fs7 fc3 sc0 ls1 ws1">STR   X0, [SP, #-16]!</div><div class="t m0 x1c hd ya67 ff3e fs7 fc3 sc0 ls1 ws1">The conven<span class="_ _3"></span>tion for the stack is that <span class="ff42">SP</span> poin<span class="_ _3"></span>ts to the last element on </div><div class="t m0 xc hd ya68 ff3e fs7 fc3 sc0 ls1 ws1">the stack and the stack gr<span class="_ _3"></span>ows downwar<span class="_ _1"></span>d. This is why <span class="ff42">SP</span> contains a large </div><div class="t m0 xc hd ya69 ff3e fs7 fc3 sc0 ls1 ws1">address<span class="_ _1"></span>. The <span class="ff42 ls1c wsbf">STR</span> instr<span class="_ _0"></span>uction copies <span class="ff42">X0</span> to the memory location at <span class="ff42">SP</span>– 16 </div><div class="t m0 xc hd ya6a ff3e fs7 fc3 sc0 ls1 ws1">and then updates <span class="ff42">SP</span> to contain this addr<span class="_ _3"></span>ess since the stor<span class="_ _3"></span>ed value is now </div><div class="t m0 xc hd ya6b ff3e fs7 fc3 sc0 ls1 ws1">the last value on the stack. W<span class="_ _1"></span>e’r<span class="_ _1"></span>e wasting 8 bytes here<span class="_ _1"></span>, since <span class="ff42">X0</span> is only 8 </div><div class="t m0 xc hd ya6c ff3e fs7 fc3 sc0 ls1 ws1">bytes in size<span class="_ _1"></span>. T<span class="_ _1"></span>o keep the proper alignmen<span class="_ _3"></span>t, we must use 16 bytes<span class="_ _1"></span>.</div><div class="t m0 x1c hd ya6d ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o load the value at the top of the stack into r<span class="_ _1"></span>egister <span class="ff42">X0</span>, we us<span class="_ _0"></span>e</div><div class="t m0 xc h18 ya6e ff45 fs7 fc3 sc0 ls1 ws1">LDR   X0, [SP], #16</div><div class="t m0 x1c hd ya6f ff3e fs7 fc3 sc0 ls1 ws1">This does the reverse oper<span class="_ _3"></span>ation. I<span class="_ _3"></span>t moves the da<span class="_ _3"></span>ta pointed to by <span class="ff42">SP</span> </div><div class="t m0 xc hd ya70 ff3e fs7 fc3 sc0 ls1 ws1">from the stack t<span class="_ _3"></span>o <span class="ff42">X0</span> and then adds 16 to the <span class="ff42">SP</span>.</div><div class="t m0 x1c hd ya71 ff3e fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e more commonly use STP/LDP to push/pop two registers at once:</div><div class="t m0 xc h18 ya72 ff45 fs7 fc3 sc0 ls1 ws1">STP   X0, X1, [SP, #-16]!</div><div class="t m0 xc h18 ya73 ff45 fs7 fc3 sc0 ls1 ws1">LDP   X0, X1, [SP], #16</div><div class="t m0 x1c hd ya74 ff3e fs7 fc3 sc0 ls1 ws1">since we aren’t wasting an<span class="_ _3"></span>y space on the stack. But it does tak<span class="_ _3"></span>e longer </div><div class="t m0 xc hd ya75 ff3e fs7 fc3 sc0 ls1 ws1">to transfer 16 b<span class="_ _3"></span>ytes to memory than 8 bytes.</div><div class="t m0 x1c hd ya76 ff3e fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">6-1</span> shows the pr<span class="_ _1"></span>ocess of pushing a register onto the stac<span class="_ _3"></span>k, and </div><div class="t m0 xc hd ya77 ff3e fs7 fc3 sc0 ls1 ws1">then Fig<span class="_ _3"></span>ure<span class="fc5">6-2</span> shows the r<span class="_ _1"></span>everse operation of popping that value off the </div><div class="t m0 xc hd ya78 ff3e fs7 fc3 sc0 ls1 ws1">stack.</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pf9a" data-dest-detail='[154,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:104.032000px;bottom:159.770000px;width:15.047000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf9a" data-dest-detail='[154,"XYZ",35,477,null]'><div class="d m1" style="border-style:none;position:absolute;left:109.857000px;bottom:143.770000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf9a" class="pf w2 h6" data-page-no="9a"><div class="pc pc9a w2 h6"><img class="bi x2 ya79 w8 h42" alt="" src="bg9a.png"/><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">138</div><div class="t m0 xc hd ya7a ff3e fs7 fc3 sc0 ls1 ws1">The <span class="ff42">LDR</span>, <span class="ff42">LDP</span>, <span class="ff42 ls1c wsbf">STR</span>, and <span class="ff42 ls1c wsbf">STP</span> instructions are powerful general- </div><div class="t m0 xd hd ya7b ff3e fs7 fc3 sc0 ls1 ws1">purpose instructions that support stacks tha<span class="_ _3"></span>t grow in either dir<span class="_ _1"></span>ection </div><div class="t m0 xd hd ya7c ff3e fs7 fc3 sc0 ls1 ws1">or can be based on any register<span class="_ _10"></span>. Plus, they ha<span class="_ _1"></span>ve all the functionality we </div><div class="t m0 xd hd ya7d ff3e fs7 fc3 sc0 ls1 ws1">cover<span class="_ _1"></span>e<span class="_ _0"></span>d in Ch<span class="_ _3"></span>apter <span class="fc5">5</span>, “Thanks for the Memories.<span class="_ _8"></span>” In o<span class="_ _3"></span>ur usage, we wan<span class="_ _3"></span>t </div><div class="t m0 xd hd ya7e ff3e fs7 fc3 sc0 ls1 ws1">to implement them exactly as pr<span class="_ _3"></span>escribed, so we w<span class="_ _0"></span>or<span class="_ _3"></span>k well in the Linux </div><div class="t m0 xd hd ya7f ff3e fs7 fc3 sc0 ls1 ws1">envir<span class="_ _3"></span>onment and can inter<span class="_ _1"></span>act w<span class="_ _0"></span>ith code written in another language b<span class="_ _3"></span>y </div><div class="t m0 xd hd ya80 ff3e fs7 fc3 sc0 ls1 ws1">other progr<span class="_ _3"></span>ammers. N<span class="_ _1"></span>ow we’ll get into the details of calling functions and </div><div class="t m0 xd hd ya81 ff3e fs7 fc3 sc0 ls1 ws1">see how the stack fits into this with the branch with link instruction.</div><div class="t m0 xd h15 ya82 ff43 fsb fc3 sc0 ls1 wsaf"> Branch <span class="_ _11"> </span>withLink</div><div class="t m0 xd hd ya83 ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o call a function, we need to set up the ability for the function to return </div><div class="t m0 xd hd ya84 ff3e fs7 fc3 sc0 ls1 ws1">execution to after the point wher<span class="_ _3"></span>e we called the function. W<span class="_ _1"></span>e do this with </div><div class="t m0 xd hd ya85 ff3e fs7 fc3 sc0 ls1 ws1">the other special register we listed in Chapt<span class="_ _3"></span>er <span class="fc5">1</span>, “<span class="_ _3"></span>Getting Started,<span class="_ _8"></span>” the <span class="ff42">link </span></div><div class="t m0 xd hd ya86 ff42 fs7 fc3 sc0 ls1 ws1">register<span class="ff3e"> (</span><span class="ls24 wsc2">LR</span><span class="ff3e">) which is </span>X30<span class="ff3e">. T<span class="_ _6"></span>o make use of <span class="ff42 ls24 wsc2">LR</span>, we introduce the <span class="ff42">branch </span></span></div><div class="t m0 xd hd ya87 ff42 fs7 fc3 sc0 ls1 ws1">with link<span class="ff3e"> (</span><span class="ls1f wsc7">BL</span><span class="ff3e">) instruction, which is the same as the branch (</span>B<span class="ff3e">) instruction, </span></div><div class="t m0 xd hd ya88 ff3e fs7 fc3 sc0 ls1 ws1">except it puts the addr<span class="_ _3"></span>ess of the next instruction into <span class="ff42 ls24 wsc2">LR</span> befor<span class="_ _3"></span>e it performs </div><div class="t m0 xd hd ya89 ff3e fs7 fc3 sc0 ls1 ws1">the branch<span class="_ _3"></span>, giving a mechanism to r<span class="_ _3"></span>eturn from the function.</div><div class="t m0 xd h1c ya8a ff46 fs3 fc3 sc0 ls1 ws1">Figure 6-1. <span class="_ _15"> </span><span class="ff3f ls26 wsca">Pushing </span>X5<span class="ff3f"> onto the stack</span></div><div class="t m0 xd h1c ya8b ff46 fs3 fc3 sc0 ls1 ws1">Figure 6-2. <span class="_ _15"> </span><span class="ff3f">Popp<span class="_ _3"></span>ing <span class="ff46">X4</span> from the stack</span></div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:127.321000px;bottom:314.097000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:248.660000px;bottom:145.910000px;width:5.500000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf9b" class="pf w2 h6" data-page-no="9b"><div class="pc pc9b w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">139</div><div class="t m0 x1c hd y145 ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o return fr<span class="_ _3"></span>om the function, we use the <span class="ff42">return</span> (<span class="ff42 ls1c wsbf">RET</span>) instruction. </div><div class="t m0 xc hd y146 ff3e fs7 fc3 sc0 ls1 ws1">This instruction branches to the addr<span class="_ _3"></span>ess stored in <span class="ff42 ls24 wsc2">LR<span class="_ _3"></span><span class="ff3e ls1 ws1"> to return fr<span class="_ _1"></span>om the </span></span></div><div class="t m0 xc hd y147 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _b"></span>function. It’<span class="_ _6"></span>s important to use this instruction rather than some other </div><div class="t m0 xc hd y1b0 ff3e fs7 fc3 sc0 ls1 ws1">branch instruction, because the instruction pipeline knows about <span class="ff42 ls1c wsbf">RET</span> </div><div class="t m0 xc hd y1b1 ff3e fs7 fc3 sc0 ls1 ws1">instructions and knows to continue pr<span class="_ _1"></span>ocessing instructions from where <span class="ff42 ls24 wsc2">LR</span> </div><div class="t m0 xc hd y218 ff3e fs7 fc3 sc0 ls1 ws1">points. T<span class="_ _3"></span>his way we don’t ha<span class="_ _1"></span>ve a perfor<span class="_ _0"></span>mance penalty for r<span class="_ _1"></span>eturning from </div><div class="t m0 xc hd y219 ff3e fs7 fc3 sc0 ls1 ws1">functions.</div><div class="t m0 x1c hd y1b4 ff3e fs7 fc3 sc0 ls1 ws1">In Listing <span class="fc5">6-1</span>, the <span class="ff42 ls1f wsc7">BL</span> instruction stores the addr<span class="_ _1"></span>ess of the following </div><div class="t m0 xc hd y1b5 ff42 fs7 fc3 sc0 lsb wsb4">MOV<span class="ff3e ls1 ws1"> instruction into </span><span class="ls24 wsc2">LR<span class="ff3e ls1 ws1"> and then branches to myfunc<span class="_ _3"></span>. Myfunc does the </span></span></div><div class="t m0 xc hd y1b6 ff3e fs7 fc3 sc0 ls1 ws1">useful work the function was written to do and then returns ex<span class="_ _3"></span>ecution to </div><div class="t m0 xc hd y1b7 ff3e fs7 fc3 sc0 ls1 ws1">the caller by h<span class="_ _3"></span>aving <span class="ff42 ls1c wsbf">RET</span> br<span class="_ _3"></span>anch to the location stor<span class="_ _1"></span>e<span class="_ _0"></span>d in <span class="ff42 ls24 wsc2">LR</span>, which is the </div><div class="t m0 xc hd y942 ff42 fs7 fc3 sc0 lsb wsb4">MOV<span class="ff3e ls1 ws1"> instruction following the </span><span class="ls1f wsc7">BL<span class="ff3e ls1 ws1"> instruction.</span></span></div><div class="t m0 xc h20 y669 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-1. <span class="_ _15"> </span><span class="ff3e">Skeleton code to c<span class="_ _3"></span>all a function and return</span></div><div class="t m0 xc h18 y66a ff45 fs7 fc3 sc0 ls1 ws1">      // ... other code ...</div><div class="t m0 xc h18 ya8c ff45 fs7 fc3 sc0 ls1 ws1">      BL    myfunc</div><div class="t m0 xc h18 ya8d ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X1, #4</div><div class="t m0 xc h18 ya8e ff45 fs7 fc3 sc0 ls1 ws1">      // ... more code ...</div><div class="t m0 xc h18 ya8f ff45 fs7 fc3 sc0 ls1 ws1">-----------------------------</div><div class="t m0 xc h18 ya90 ff45 fs7 fc3 sc0 ls1 ws1">myfunc:     // do some work</div><div class="t m0 xc h18 ya91 ff45 fs7 fc3 sc0 ls1 ws1">            RET</div><div class="t m0 x1c hd ya92 ff3e fs7 fc3 sc0 ls1 ws1">There is only one <span class="ff42 ls24 wsc2">LR<span class="_ _3"></span><span class="ff3e ls1 ws1">, so you might be wondering what h<span class="_ _3"></span>appens if </span></span></div><div class="t m0 xc hd ya93 ff3e fs7 fc3 sc0 ls1 ws1">another function is called? How do we pr<span class="_ _1"></span>es<span class="_ _0"></span>erve the original value of <span class="ff42 ls24 wsc2">LR</span> </div><div class="t m0 xc hd ya94 ff3e fs7 fc3 sc0 ls1 ws1">when function calls are nest<span class="_ _3"></span>ed?</div><div class="t m0 xc h15 ya95 ff43 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Nesting Function Calls</div><div class="t m0 xc hd ya96 ff3e fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e successfully called and returned fr<span class="_ _3"></span>om a function, but we never used </div><div class="t m0 xc hd ya97 ff3e fs7 fc3 sc0 ls1 ws1">the stack. Why did we intr<span class="_ _1"></span>oduce the stack first and then not use it? First of </div><div class="t m0 xc hd ya98 ff3e fs7 fc3 sc0 ls1 ws1">all, think of what ha<span class="_ _3"></span>ppens if in the course of its processing<span class="_ _3"></span>, myfunc calls </div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pf9b" data-dest-detail='[155,"XYZ",53,388,null]'><div class="d m1" style="border-style:none;position:absolute;left:118.298000px;bottom:465.175000px;width:15.048000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf9c" class="pf w2 h6" data-page-no="9c"><div class="pc pc9c w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">140</div><div class="t m0 xd hd y145 ff3e fs7 fc3 sc0 ls1 ws1">another function. W<span class="_ _1"></span>e would expect this to be fairly common, as we wr<span class="_ _0"></span>ite </div><div class="t m0 xd hd y146 ff3e fs7 fc3 sc0 ls1 ws1">code building on the functionality we’<span class="_ _1"></span>ve previously written. If myfunc </div><div class="t m0 xd hd y147 ff3e fs7 fc3 sc0 ls1 ws1">executes a <span class="ff42 ls1f wsc7">BL</span> instruction, then <span class="ff42 ls1f wsc7">BL</span> will copy the next address in<span class="_ _3"></span>to <span class="ff42 ls24 wsc2">LR</span> </div><div class="t m0 xd hd y1b0 ff3e fs7 fc3 sc0 ls1 ws1">overwriting the return addr<span class="_ _3"></span>ess for myfunc and myfunc won’t be able to </div><div class="t m0 xd hd y1b1 ff3e fs7 fc3 sc0 ls1 ws1">return. Wh<span class="_ _3"></span>at we need is a way to keep a chain of r<span class="_ _1"></span>eturn addresses as we </div><div class="t m0 xd hd y218 ff3e fs7 fc3 sc0 ls1 ws1">call function after function. W<span class="_ _1"></span>ell, not a chain of return addr<span class="_ _1"></span>esses, but a </div><div class="t m0 xd hd y219 ff3e fs7 fc3 sc0 ls1 ws1">stack of ret<span class="_ _3"></span>urn addresses<span class="_ _1"></span>.</div><div class="t m0 xc hd y1b4 ff3e fs7 fc3 sc0 ls1 ws1">If myfunc is going to call other functions<span class="_ _1"></span>, then it nee<span class="_ _0"></span>ds to push <span class="ff42 ls24 wsc2">LR<span class="_ _3"></span><span class="ff3e ls1 ws1"> onto </span></span></div><div class="t m0 xd hd y1b5 ff3e fs7 fc3 sc0 ls1 ws1">the stack as the first thing it does and pop it fr<span class="_ _3"></span>om the stack just befor<span class="_ _3"></span>e it </div><div class="t m0 xd hd y1b6 ff3e fs7 fc3 sc0 ls1 ws1">returns<span class="_ _1"></span>, for example, Listing <span class="fc5">6-2</span> shows this pr<span class="_ _3"></span>ocess.</div><div class="t m0 xd h20 ya99 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-2. <span class="_ _15"> </span><span class="ff3e">Skeleton code for a function th<span class="_ _3"></span>at calls another function</span></div><div class="t m0 xd h18 ya9a ff45 fs7 fc3 sc0 ls1 ws1">      // ... other code ...</div><div class="t m0 xd h18 ya9b ff45 fs7 fc3 sc0 ls1 ws1">      BL    myfunc</div><div class="t m0 xd h18 ya9c ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X1, #4</div><div class="t m0 xd h18 ya9d ff45 fs7 fc3 sc0 ls1 ws1">      // ... more code ...</div><div class="t m0 xd h18 ya9e ff45 fs7 fc3 sc0 ls1 ws1">-----------------------------</div><div class="t m0 xd h18 ya9f ff45 fs7 fc3 sc0 ls1 ws1">myfunc:     STR   LR, [SP, #-16]!  // PUSH LR</div><div class="t m0 xd h18 yaa0 ff45 fs7 fc3 sc0 ls1 ws1">            // do some work ...</div><div class="t m0 xd h18 yaa1 ff45 fs7 fc3 sc0 ls1 ws1">            BL    myfunc2</div><div class="t m0 xd h18 yaa2 ff45 fs7 fc3 sc0 ls1 ws1">            // do some more work...</div><div class="t m0 xd h18 yaa3 ff45 fs7 fc3 sc0 ls1 ws1">            LDR   LR, [SP], #16    // POP LR</div><div class="t m0 xd h18 yaa4 ff45 fs7 fc3 sc0 ls1 ws1">            RET</div><div class="t m0 xd h18 yaa5 ff45 fs7 fc3 sc0 ls1 ws1">myfunc2:    // do some work ....</div><div class="t m0 xd h18 yaa6 ff45 fs7 fc3 sc0 ls1 ws1">            RET</div><div class="t m0 xc hd yaa7 ff3e fs7 fc3 sc0 ls1 ws1">In this example<span class="_ _3"></span>, we see how convenient the s<span class="_ _3"></span>tack is to stor<span class="_ _3"></span>e data that </div><div class="t m0 xd hd yaa8 ff3e fs7 fc3 sc0 ls1 ws1">only needs to exist for the duration of a function call.</div><div class="t m0 xc hd yaa9 ff3e fs7 fc3 sc0 ls1 ws1">If a function, such as myfunc, c<span class="_ _3"></span>alls other functions then it must sa<span class="_ _3"></span>ve </div><div class="t m0 xd hd yaaa ff42 fs7 fc3 sc0 ls24 wsc2">LR<span class="ff3e ls1 ws1">; if it doesn’t call other functions<span class="_ _3"></span>, such as myfunc2, then it doesn’t need </span></div><div class="t m0 xd hd yaab ff3e fs7 fc3 sc0 ls1 ws1">to sav<span class="_ _3"></span>e <span class="ff42 ls24 wsc2">LR</span>. Progr<span class="_ _3"></span>ammers often push and pop <span class="ff42 ls24 wsc2">LR</span> r<span class="_ _3"></span>egar<span class="_ _3"></span>dless, since if the </div><div class="t m0 xd hd yaac ff3e fs7 fc3 sc0 ls1 ws1">function is modified later to add a function call, and the pr<span class="_ _3"></span>ogrammer </div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pf9c" data-dest-detail='[156,"XYZ",35,420,null]'><div class="d m1" style="border-style:none;position:absolute;left:169.164000px;bottom:433.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf9d" class="pf w2 h6" data-page-no="9d"><div class="pc pc9d w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">141</div><div class="t m0 xc hd y145 ff3e fs7 fc3 sc0 ls1 ws1">forgets to add <span class="ff42 ls24 wsc2">LR</span> to the list of sa<span class="_ _1"></span>ved registers, then the pr<span class="_ _3"></span>ogram will fail </div><div class="t m0 xc hd y146 ff3e fs7 fc3 sc0 ls1 ws1">to return and either go in<span class="_ _3"></span>to an infinite loop or crash. T<span class="_ _3"></span>he downside is </div><div class="t m0 xc hd y147 ff3e fs7 fc3 sc0 ls1 ws1">that ther<span class="_ _3"></span>e’<span class="_ _6"></span>s only so much bandwidth between the CPU and memor<span class="_ _0"></span>y, so </div><div class="t m0 xc hd y1b0 ff3e fs7 fc3 sc0 ls1 ws1">PUSHing and POPing more r<span class="_ _1"></span>egisters does take extra execution cycles. The </div><div class="t m0 xc hd y1b1 ff3e fs7 fc3 sc0 ls1 ws1">trade-off in speed vs. m<span class="_ _3"></span>aintaina<span class="_ _3"></span>bility is a subjective decision depending on </div><div class="t m0 xc hd y1b2 ff3e fs7 fc3 sc0 ls1 ws1">the circumstances<span class="_ _1"></span>.</div><div class="t m0 x1c hd y1b3 ff3e fs7 fc3 sc0 ls1 ws1">Calling and r<span class="_ _3"></span>eturning fr<span class="_ _3"></span>om the function is only half the story. Like in </div><div class="t m0 xc hd y1b4 ff3e fs7 fc3 sc0 ls1 ws1">high-level languages<span class="_ _1"></span>, w<span class="_ _0"></span>e need to pass par<span class="_ _3"></span>ameters (<span class="_ _3"></span>data) into o<span class="_ _3"></span>ur functions </div><div class="t m0 xc hd y1b5 ff3e fs7 fc3 sc0 ls1 ws1">to be processed and then receive the r<span class="_ _1"></span>esults of the processing back in </div><div class="t m0 xc hd y1b6 ff3e fs7 fc3 sc0 ls1 ws1">return v<span class="_ _3"></span>alues. N<span class="_ _1"></span>ow we’ll look at how to do this<span class="_ _3"></span>.</div><div class="t m0 xc h15 yaad ff43 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Function P<span class="_ _1"></span>arameters andReturn V<span class="_ _3"></span>alues</div><div class="t m0 xc hd yaae ff3e fs7 fc3 sc0 ls1 ws1">In high-level lang<span class="_ _3"></span>uages, functions take p<span class="_ _3"></span>arameters and r<span class="_ _3"></span>eturn their res<span class="_ _3"></span>ults. </div><div class="t m0 xc hd yaaf ff3e fs7 fc3 sc0 ls1 ws1">Assembly Language pr<span class="_ _3"></span>ogramming is no differ<span class="_ _1"></span>ent. W<span class="_ _1"></span>e could invent our </div><div class="t m0 xc hd yab0 ff3e fs7 fc3 sc0 ls1 ws1">own mechanisms to do this<span class="_ _3"></span>, but this is counterpr<span class="_ _3"></span>oductive. E<span class="_ _1"></span>ventually, we </div><div class="t m0 xc hd yab1 ff3e fs7 fc3 sc0 ls1 ws1">will want the code to inter<span class="_ _3"></span>operate with code written in other progr<span class="_ _1"></span>amming </div><div class="t m0 xc hd yab2 ff3e fs7 fc3 sc0 ls1 ws1">languages<span class="_ _3"></span>. W<span class="_ _1"></span>e will want to call the new super<span class="_ _1"></span>-fast functions from C code, </div><div class="t m0 xc hd yab3 ff3e fs7 fc3 sc0 ls1 ws1">and we might want to c<span class="_ _3"></span>all functions that wer<span class="_ _3"></span>e written in C.</div><div class="t m0 x1c hd yab4 ff3e fs7 fc3 sc0 ls27 ws1">T<span class="_ _6"></span>o facilitate this, ther<span class="_ _1"></span>e are a set of design patterns for calling </div><div class="t m0 xc hd yab5 ff3e fs7 fc3 sc0 ls27 ws1">functions. If we follow these<span class="_ _1"></span>, the co<span class="_ _0"></span>de will work r<span class="_ _3"></span>eliably since others </div><div class="t m0 xc hd yab6 ff3e fs7 fc3 sc0 ls27 ws1">ha<span class="_ _3"></span>ve already wor<span class="_ _3"></span>ked out all the bugs<span class="_ _3"></span>, plus we achieve the goal of writing </div><div class="t m0 xc hd yab7 ff3e fs7 fc3 sc0 ls27 ws1">inter<span class="_ _3"></span>operable code<span class="_ _3"></span>.</div><div class="t m0 x1c hd yab8 ff3e fs7 fc3 sc0 ls1 ws1">The caller passes the first eight p<span class="_ _3"></span>arameters in <span class="ff42">X0</span><span class="ls8 ws9f"> to </span><span class="ff42">X7</span>. If ther<span class="_ _3"></span>e are </div><div class="t m0 xc hd yab9 ff3e fs7 fc3 sc0 ls1 ws1">additional parameters<span class="_ _1"></span>, then they are pushed onto the stack. If we only </div><div class="t m0 xc hd yaba ff3e fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve two parameters<span class="_ _1"></span>, then w<span class="_ _0"></span>e would only use <span class="ff42">X0</span> and <span class="ff42">X1</span>. This means the </div><div class="t m0 xc hd yabb ff3e fs7 fc3 sc0 ls1 ws1">first eight par<span class="_ _3"></span>ameters are alr<span class="_ _1"></span>eady loaded into registers and read<span class="_ _3"></span>y to be </div><div class="t m0 xc hd yabc ff3e fs7 fc3 sc0 ls1 ws1">processed. Addition<span class="_ _3"></span>al parameters need to be popped from the stack befor<span class="_ _1"></span>e </div><div class="t m0 xc hd yabd ff3e fs7 fc3 sc0 ls1 ws1">being processed.</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf9e" class="pf w2 h6" data-page-no="9e"><div class="pc pc9e w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">142</div><div class="t m0 xc hd y145 ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o return a value to the caller<span class="_ _10"></span>, place it in <span class="ff42">X0</span> before ret<span class="_ _3"></span>urning. In fact<span class="_ _3"></span>, </div><div class="t m0 xd hd y146 ff3e fs7 fc3 sc0 ls1 ws1">you can r<span class="_ _3"></span>eturn a 128-bit integer in the <span class="ff42">X0</span>, <span class="ff42">X1</span> r<span class="_ _3"></span>egister pair<span class="_ _6"></span>. If you need to </div><div class="t m0 xd hd y147 ff3e fs7 fc3 sc0 ls1 ws1">return mor<span class="_ _1"></span>e data, you would ha<span class="_ _1"></span>ve one of the parameters be an address to </div><div class="t m0 xd hd y1b0 ff3e fs7 fc3 sc0 ls1 ws1">a memory lo<span class="_ _0"></span>ca<span class="_ _3"></span>tion where yo<span class="_ _3"></span>u can place the additional da<span class="_ _3"></span>ta to be returned. </div><div class="t m0 xd hd y1b1 ff3e fs7 fc3 sc0 ls1 ws1">This is the same as C where y<span class="_ _3"></span>ou return d<span class="_ _3"></span>ata thro<span class="_ _3"></span>ugh call by r<span class="_ _1"></span>eference </div><div class="t m0 xd hd y1b2 ff3e fs7 fc3 sc0 ls1 ws1">parameters<span class="_ _1"></span>.</div><div class="t m0 xc hd y1b3 ff3e fs7 fc3 sc0 ls1 ws1">Since both the caller and callee ar<span class="_ _3"></span>e using the same set of general- </div><div class="t m0 xd hd y1b4 ff3e fs7 fc3 sc0 ls1 ws1">purpose registers<span class="_ _1"></span>, w<span class="_ _0"></span>e need a pr<span class="_ _3"></span>otocol or convention to ens<span class="_ _3"></span>ure tha<span class="_ _3"></span>t one </div><div class="t m0 xd hd y1b5 ff3e fs7 fc3 sc0 ls1 ws1">doesn’t overwrite the working data of the other<span class="_ _6"></span>. Nex<span class="_ _3"></span>t, we’ll look a<span class="_ _3"></span>t the </div><div class="t m0 xd hd y1b6 ff3e fs7 fc3 sc0 ls1 ws1">register m<span class="_ _3"></span>anagement con<span class="_ _3"></span>vention for the ARM pr<span class="_ _3"></span>ocessor<span class="_ _6"></span>.</div><div class="t m0 xd h15 yaad ff43 fsb fc3 sc0 ls1 wsaf"> Managing <span class="_ _11"> </span>theRegisters</div><div class="t m0 xd hd yaae ff3e fs7 fc3 sc0 ls1 ws1">If you call a function, chances ar<span class="_ _1"></span>e it was written by a different pr<span class="_ _1"></span>ogrammer </div><div class="t m0 xd hd yaaf ff3e fs7 fc3 sc0 ls1 ws1">and you don’t know wha<span class="_ _3"></span>t registers it will use<span class="_ _3"></span>. It would be very inefficient </div><div class="t m0 xd hd yab0 ff3e fs7 fc3 sc0 ls1 ws1">if you had to r<span class="_ _1"></span>eload all your registers every time you call a function. As a </div><div class="t m0 xd hd yab1 ff3e fs7 fc3 sc0 ls1 ws1">result<span class="_ _3"></span>, there ar<span class="_ _1"></span>e a s<span class="_ _0"></span>et of rules to govern which r<span class="_ _1"></span>egisters a function can use </div><div class="t m0 xd hd yab2 ff3e fs7 fc3 sc0 ls1 ws1">and who is responsible for sa<span class="_ _1"></span>ving each one.</div><div class="t m0 xa hd y1e8 ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42">X0</span><span class="ls28 wscb">–X<span class="_ _0"></span></span><span class="ff42">7</span>: These are the function parameters<span class="_ _1"></span>. The </div><div class="t m0 x1e hd yabe ff3e fs7 fc3 sc0 ls1 ws1">function can use these for any other purpose modifying </div><div class="t m0 x1e hd yabf ff3e fs7 fc3 sc0 ls1 ws1">them freely. If the calling r<span class="_ _1"></span>outine needs them saved, it </div><div class="t m0 x1e hd yac0 ff3e fs7 fc3 sc0 ls1 ws1">must sa<span class="_ _3"></span>ve them itself.</div><div class="t m0 xa hd yac1 ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42">X0</span>–<span class="ff42">X18</span>: Corruptible registers that a function is fr<span class="_ _1"></span>ee </div><div class="t m0 x1e hd yac2 ff3e fs7 fc3 sc0 ls1 ws1">to use without saving<span class="_ _3"></span>. If a caller needs these, then it is </div><div class="t m0 x1e hd yac3 ff3e fs7 fc3 sc0 ls1 ws1">responsible for sa<span class="_ _1"></span>ving them.</div><div class="t m0 xa hd yac4 ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42">X19</span>–<span class="ff42">X30</span>: These are callee sa<span class="_ _1"></span>ved, so must be pushed to </div><div class="t m0 x1e hd yac5 ff3e fs7 fc3 sc0 ls1 ws1">the stack if used in a function.</div><div class="t m0 xa hd yac6 ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42">SP</span>: This can be freely used b<span class="_ _3"></span>y the called routine<span class="_ _1"></span>. The </div><div class="t m0 x1e hd yac7 ff3e fs7 fc3 sc0 ls1 ws1">routine m<span class="_ _3"></span>ust POP the stack the same number of times </div><div class="t m0 x1e hd yac8 ff3e fs7 fc3 sc0 ls1 ws1">that it PUSHes<span class="_ _1"></span>, so it<span class="_ _0"></span>’<span class="_ _6"></span>s intact for the calling r<span class="_ _3"></span>outine.</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf9f" class="pf w2 h6" data-page-no="9f"><div class="pc pc9f w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">143</div><div class="t m0 x1e hd y145 ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42 ls24 wsc2">LR</span>: The called r<span class="_ _3"></span>outine must pr<span class="_ _3"></span>eserve this as we </div><div class="t m0 x9 hd y146 ff3e fs7 fc3 sc0 ls1 ws1">discussed in the last section.</div><div class="t m0 x1e hd y1fe ff3e fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff42">Condition flags</span>: Neither ro<span class="_ _3"></span>utine can make any </div><div class="t m0 x9 hd y148 ff3e fs7 fc3 sc0 ls1 ws1">assumptions about the condition flags<span class="_ _1"></span>. As far as the </div><div class="t m0 x9 hd y149 ff3e fs7 fc3 sc0 ls1 ws1">called routine is concerned, all the fla<span class="_ _3"></span>gs are unknown; </div><div class="t m0 x9 hd y14a ff3e fs7 fc3 sc0 ls1 ws1">similarly they are unknown to the caller when the </div><div class="t m0 x9 hd y1cb ff3e fs7 fc3 sc0 ls1 ws1">function returns<span class="_ _1"></span>.</div><div class="t m0 xc h15 y1ff ff43 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Summar<span class="_ _0"></span>y oftheFunction Call Algorithm</div><div class="t m0 xc hd y200 ff3e fs7 fc3 sc0 ls1 ws1">Calling r<span class="_ _3"></span>outine:</div><div class="t m0 x1c hd yac9 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>If we need any of <span class="ff42">X0–<span class="_ _1"></span>X18<span class="ff3e">, save them<span class="_ _1"></span>.</span></span></div><div class="t m0 x1c hd yaca ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Mov<span class="_ _3"></span>e first eight par<span class="_ _3"></span>ameters into r<span class="_ _3"></span>egisters <span class="ff42">X0</span>–<span class="ff42">X7</span>.</div><div class="t m0 x1c hd yacb ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Push any additional par<span class="_ _3"></span>ameters onto the stack.</div><div class="t m0 x1c hd yacc ff3e fs7 fc3 sc0 ls1 wscc"> <span class="_ _2"></span>4. Use <span class="_ _54"></span><span class="ff42 ls1f wsc7">BL<span class="ff3e ls1 ws1"> to call the function.</span></span></div><div class="t m0 x1c hd yacd ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Evalua<span class="_ _3"></span>te the return code in <span class="ff42">X0</span>.</div><div class="t m0 x1c hd y1f5 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>6. <span class="_ _f"> </span>Restore an<span class="_ _3"></span>y of <span class="ff42">X0</span>–<span class="ff42">X18</span> that we sa<span class="_ _3"></span>ved.</div><div class="t m0 x1c hd yace ff3e fs7 fc3 sc0 ls1 ws1">Called function:</div><div class="t m0 x1c hd yacf ff3e fs7 fc3 sc0 ls1 wscc"> <span class="_ _2"></span>1. PUSH <span class="_ _54"></span><span class="ff42 ls24 wsc2">LR<span class="ff3e ls1 ws1"> and <span class="ff42">X19</span>–<span class="ff42">X30</span> onto the stack if used in the </span></span></div><div class="t m0 x9 hd yad0 ff3e fs7 fc3 sc0 ls1 ws1">routine<span class="_ _1"></span>.</div><div class="t m0 x1c hd yad1 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Do our work.</div><div class="t m0 x1c hd yad2 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Put our ret<span class="_ _3"></span>urn code into <span class="ff42">X0</span>.</div><div class="t m0 x1c hd yad3 ff3e fs7 fc3 sc0 ls1 wscc"> <span class="_ _2"></span>4. POP <span class="_ _54"></span><span class="ff42 ls24 wsc2">LR<span class="ff3e ls1 ws1"> and <span class="ff42">X19</span>–<span class="ff42">X30</span> if pushed in step 1.</span></span></div><div class="t m0 x1c hd yad4 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Use the <span class="ff42 ls1c wsbf">RET</span> instruction to return execution to the </div><div class="t m0 x9 hd yad5 ff3e fs7 fc3 sc0 ls1 ws1">caller<span class="_ _6"></span>.</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa0" class="pf w2 h6" data-page-no="a0"><div class="pc pca0 w2 h6"><img class="bi xd yad6 w7 h43" alt="" src="bga0.png"/><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">144</div><div class="t m0 x34 h41 y82c ff43 fse fc3 sc0 ls1 ws1">Note<span class="ff44"> <span class="_ _17"> </span>We can save steps if we just use </span>X0<span class="ff44">–</span>X18<span class="ff44"> for function </span></div><div class="t m0 x34 h41 y82d ff44 fse fc3 sc0 ls1 ws1">parameters,<span class="_ _1"></span> return codes,<span class="_ _1"></span> and short-term work.<span class="_ _3"></span> <span class="_ _1"></span>Then we never have </div><div class="t m0 x34 h41 y82e ff44 fse fc3 sc0 ls1 ws1">to save and restore them around function calls.</div><div class="t m0 x34 h41 yad7 ff44 fse fc3 sc0 ls1 ws1">These aren’t all the rules.<span class="_ _1"></span> <span class="_ _1"></span>The coprocessors also ha<span class="_ _0"></span>ve registers that </div><div class="t m0 x34 h41 yad8 ff44 fse fc3 sc0 ls1 ws1">might need saving.<span class="_ _1"></span> <span class="_ _3"></span>We’ll discuss those rules when we discuss the </div><div class="t m0 x34 h41 yad9 ff44 fse fc3 sc0 ls1 ws1">coprocessors.</div><div class="t m0 xc hd yada ff3e fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at a practical example b<span class="_ _1"></span>y converting our upper<span class="_ _1"></span>-case program </div><div class="t m0 xd hd yadb ff3e fs7 fc3 sc0 ls1 ws1">into a function that we c<span class="_ _3"></span>an call with parameters to con<span class="_ _3"></span>vert any strings we </div><div class="t m0 xd hd yadc ff3e fs7 fc3 sc0 ls1 ws1">wish.</div><div class="t m0 xd h15 yadd ff43 fsb fc3 sc0 ls1 wsaf"> Upper<span class="_ _6"></span>-Case <span class="_ _12"> </span>Revisited</div><div class="t m0 xd hd yade ff3e fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s organize our upper<span class="_ _1"></span>-case example from Ch<span class="_ _3"></span>apter <span class="fc5">5</span>, “Thanks for the </div><div class="t m0 xd hd yadf ff3e fs7 fc3 sc0 ls1 ws1">Memories,<span class="_ _8"></span>” as a pr<span class="_ _1"></span>op<span class="_ _0"></span>er function. W<span class="_ _1"></span>e’ll mo<span class="_ _3"></span>ve the function into its o<span class="_ _3"></span>wn file </div><div class="t m0 xd hd yae0 ff3e fs7 fc3 sc0 ls1 ws1">and modify the makefile to mak<span class="_ _3"></span>e both the calling progr<span class="_ _1"></span>am and the upp<span class="_ _0"></span>er<span class="_ _1"></span>- </div><div class="t m0 xd hd yae1 ff3e fs7 fc3 sc0 ls1 ws1">case function.</div><div class="t m0 xc hd yae2 ff3e fs7 fc3 sc0 ls1 ws1">First of all, cr<span class="_ _1"></span>eate a file called main.s containing Listing <span class="fc5">6-3</span> for the </div><div class="t m0 xd hd yae3 ff3e fs7 fc3 sc0 ls1 ws1">driving application.</div><div class="t m0 xd h20 yae4 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-3. <span class="_ _15"> </span><span class="ff3e">Main pr<span class="_ _1"></span>ogram for upper<span class="_ _1"></span>-case example</span></div><div class="t m0 xd h18 yae5 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yae6 ff45 fs7 fc3 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xd h18 yae7 ff45 fs7 fc3 sc0 ls1 ws1">// all upper case by calling a function.</div><div class="t m0 xd h18 yae8 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yae9 ff45 fs7 fc3 sc0 ls1 ws1">// X0-X2 - parameters to linux function services</div><div class="t m0 xd h18 yaea ff45 fs7 fc3 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:283.354000px;bottom:331.770000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfa0" data-dest-detail='[160,"XYZ",35,238,null]'><div class="d m1" style="border-style:none;position:absolute;left:311.528000px;bottom:267.770000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa1" class="pf w2 h6" data-page-no="a1"><div class="pc pca1 w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">145</div><div class="t m0 xc h18 y46b ff45 fs7 fc3 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xc h18 y46c ff45 fs7 fc3 sc0 ls1 ws1">// X8 - linux function number</div><div class="t m0 xc h18 y46d ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y46e ff45 fs7 fc3 sc0 ls1 ws1">.global _start     // Provide program starting address</div><div class="t m0 xc h18 y910 ff45 fs7 fc3 sc0 ls1 ws1">_start: LDR X0, =instr // start of input string</div><div class="t m0 xc h18 y470 ff45 fs7 fc3 sc0 ls1 ws1">      LDR   X1, =outstr // address of output string</div><div class="t m0 xc h18 yaeb ff45 fs7 fc3 sc0 ls1 ws1">      BL    toupper</div><div class="t m0 xc h18 yaec ff45 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print our hex number</div><div class="t m0 xc h18 yaed ff45 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 yaee ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X2, X0 // return code is the length</div><div class="t m0 xc h18 yaef ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X0, #1        // 1 = StdOut</div><div class="t m0 xc h18 y986 ff45 fs7 fc3 sc0 ls1 ws1">      LDR   X1, =outstr   // string to print</div><div class="t m0 xc h18 y987 ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X8, #64       // linux write system call</div><div class="t m0 xc h18 yaf0 ff45 fs7 fc3 sc0 ls1 ws1">      SVC   0             // Call linux to output the string</div><div class="t m0 xc h18 yaf1 ff45 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xc h18 yaf2 ff45 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 yaf3 ff45 fs7 fc3 sc0 ls1 ws1">      MOV     X0, #0   // Use 0 return code</div><div class="t m0 xc h18 yaf4 ff45 fs7 fc3 sc0 ls1 ws1">      MOV     X8, #93  // Service command code 93</div><div class="t m0 xc h18 yaf5 ff45 fs7 fc3 sc0 ls1 ws1">      SVC     0        // Call linux to terminates</div><div class="t m0 xc h18 yaf6 ff45 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xc h18 yaf7 ff45 fs7 fc3 sc0 ls1 ws1">instr:  .asciz &quot;This is our Test String that we will </div><div class="t m0 xc h18 yaf8 ff45 fs7 fc3 sc0 ls1 ws1">convert.\n&quot;</div><div class="t m0 xc h18 yaf9 ff45 fs7 fc3 sc0 ls1 ws1">outstr:     .fill   255, 1, 0</div><div class="t m0 x1c hd yafa ff3e fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, crea<span class="_ _3"></span>te a file called upper<span class="_ _6"></span>.s containing Listing <span class="fc5">6-4</span>, the upper<span class="_ _1"></span>-case </div><div class="t m0 xc hd yafb ff3e fs7 fc3 sc0 ls1 ws1">conversion function.</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pfa2" data-dest-detail='[162,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:308.178000px;bottom:145.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa2" class="pf w2 h6" data-page-no="a2"><div class="pc pca2 w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">146</div><div class="t m0 xd h20 y4c5 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-4. <span class="_ _15"> </span><span class="ff3e">Function to con<span class="_ _1"></span>ver<span class="_ _0"></span>t strings to all upper<span class="_ _1"></span>-case</span></div><div class="t m0 xd h18 y4c6 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4c7 ff45 fs7 fc3 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xd h18 y4c8 ff45 fs7 fc3 sc0 ls1 ws1">// all upper case.</div><div class="t m0 xd h18 y4c9 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y5de ff45 fs7 fc3 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xd h18 y5df ff45 fs7 fc3 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xd h18 y6a2 ff45 fs7 fc3 sc0 ls1 ws1">// X4 - original output string for length calc.</div><div class="t m0 xd h18 yafc ff45 fs7 fc3 sc0 ls1 ws1">// W5 - current character being processed</div><div class="t m0 xd h18 y9ca ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4f9 ff45 fs7 fc3 sc0 ls1 ws1">.global toupper // Allow other files to call this routine</div><div class="t m0 xd h18 y4d0 ff45 fs7 fc3 sc0 ls1 ws1">toupper: MOV   X4, X1</div><div class="t m0 xd h18 y55c ff45 fs7 fc3 sc0 ls1 ws1">// The loop is until byte pointed to by X1 is non-zero</div><div class="t m0 xd h18 y55d ff45 fs7 fc3 sc0 ls1 ws1">loop:  LDRB W5, [X0], #1 // load character and incr ptr</div><div class="t m0 xd h18 yafd ff45 fs7 fc3 sc0 ls1 ws1">// If W5 &gt; &apos;z&apos; then goto cont</div><div class="t m0 xd h18 yafe ff45 fs7 fc3 sc0 ls1 ws1">      CMP   W5, #&apos;z&apos;        // is letter &gt; &apos;z&apos;?</div><div class="t m0 xd h18 yaff ff45 fs7 fc3 sc0 ls1 ws1">      B.GT  cont</div><div class="t m0 xd h18 yb00 ff45 fs7 fc3 sc0 ls1 ws1">// Else if W5 &lt; &apos;a&apos; then goto end if</div><div class="t m0 xd h18 yb01 ff45 fs7 fc3 sc0 ls1 ws1">      CMP   W5, #&apos;a&apos;</div><div class="t m0 xd h18 yb02 ff45 fs7 fc3 sc0 ls1 ws1">      B.LT  cont  // goto to end if</div><div class="t m0 xd h18 yb03 ff45 fs7 fc3 sc0 ls1 ws1">// if we got here then the letter is lower case,</div><div class="t m0 xd h18 yb04 ff45 fs7 fc3 sc0 ls1 ws1">// so convert it.</div><div class="t m0 xd h18 y505 ff45 fs7 fc3 sc0 ls1 ws1">      SUB   W5, W5, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xd h18 y506 ff45 fs7 fc3 sc0 ls1 ws1">cont: // end if</div><div class="t m0 xd h18 y507 ff45 fs7 fc3 sc0 ls1 ws1">      STRB  W5, [X1], #1 // store character to output str</div><div class="t m0 xd h18 y508 ff45 fs7 fc3 sc0 ls1 ws1">      CMP   W5, #0       // stop on hitting a null char</div><div class="t m0 xd h18 y509 ff45 fs7 fc3 sc0 ls1 ws1">      B.NE  loop         // loop if character isn&apos;t null</div><div class="t m0 xd h18 y50a ff45 fs7 fc3 sc0 ls1 ws1">      SUB   X0, X1, X4   // get the len by subing the ptrs</div><div class="t m0 xd h18 yb05 ff45 fs7 fc3 sc0 ls1 ws1">      RET         // Return to caller</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa3" class="pf w2 h6" data-page-no="a3"><div class="pc pca3 w2 h6"><img class="bi xc yb06 w7 h44" alt="" src="bga3.png"/><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">147</div><div class="t m0 x1c hd yb07 ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o build these, use the makefile in Listing <span class="fc5">6-5</span>.</div><div class="t m0 xc h20 yb08 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-5. <span class="_ _15"> </span><span class="ff3e">Mak<span class="_ _3"></span>efile for the upper<span class="_ _1"></span>-case function example</span></div><div class="t m0 xc h18 yb09 ff45 fs7 fc3 sc0 ls1 ws1">UPPEROBJS = main.o upper.o</div><div class="t m0 xc h18 yb0a ff45 fs7 fc3 sc0 ls1 ws1">ifdef DEBUG</div><div class="t m0 xc h18 yb0b ff45 fs7 fc3 sc0 ls1 ws1">DEBUGFLGS = -g</div><div class="t m0 xc h18 yb0c ff45 fs7 fc3 sc0 ls1 ws1">else</div><div class="t m0 xc h18 yb0d ff45 fs7 fc3 sc0 ls1 ws1">DEBUGFLGS =</div><div class="t m0 xc h18 yb0e ff45 fs7 fc3 sc0 ls1 ws1">endif</div><div class="t m0 xc h18 yb0f ff45 fs7 fc3 sc0 ls1 ws1">LSTFLGS =</div><div class="t m0 xc h18 yb10 ff45 fs7 fc3 sc0 ls1 ws1">all: upper</div><div class="t m0 xc h18 yb11 ff45 fs7 fc3 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xc h18 yb12 ff45 fs7 fc3 sc0 ls1 ws1">     as $(DEBUGFLGS) $(LSTFLGS) $&lt; -o $@</div><div class="t m0 xc h18 yb13 ff45 fs7 fc3 sc0 ls1 ws1">upper: $(UPPEROBJS)</div><div class="t m0 xc h18 yb14 ff45 fs7 fc3 sc0 ls1 ws1">     ld -o upper $(UPPEROBJS)</div><div class="t m0 x36 h41 yb15 ff43 fse fc3 sc0 ls1 ws1">Note<span class="ff44"> <span class="_ _17"> </span>The toupper function doesn’t call any other functions,<span class="_ _1"></span> so </span></div><div class="t m0 x36 h41 yb16 ff44 fse fc3 sc0 ls1 ws1">we don’t save <span class="ff43">LR</span>.<span class="_ _1"></span> If we ever change it to do so,<span class="_ _3"></span> we need to push </div><div class="t m0 x36 h41 yb17 ff43 fse fc3 sc0 ls1 ws1">LR<span class="ff44"> to the stack and pop it before we return.<span class="_ _1"></span> Since <span class="ff43">X0</span>–<span class="ff43">X18</span> are all </span></div><div class="t m0 x36 h41 yb18 ff44 fse fc3 sc0 ls1 ws1">corruptible,<span class="_ _1"></span> we have plenty of general-purpose registers to use </div><div class="t m0 x36 h41 yb19 ff44 fse fc3 sc0 ls1 ws1">without needing to save an<span class="_ _0"></span>y<span class="_ _6"></span>.</div><div class="t m0 x36 h41 yb1a ff44 fse fc3 sc0 ls29 ws1">Most C programmers will object that this function is dangerous.<span class="_ _1"></span> If<span class="_ _0"></span> </div><div class="t m0 x36 h41 yb1b ff44 fse fc3 sc0 ls29 ws1">the input string isn’t NULL terminated,<span class="_ _1"></span> then it will overrun the output<span class="_ _0"></span> </div><div class="t m0 x36 h41 yb1c ff44 fse fc3 sc0 ls29 ws1">string buffer—overwriting the memory past the end. <span class="_ _6"></span>The solution is to<span class="_ _0"></span> </div><div class="t m0 x36 h41 yb1d ff44 fse fc3 sc0 ls29 ws1">pass in a third parameter with the buffer lengths and check in the loop </div><div class="t m0 x36 h41 yb1e ff44 fse fc3 sc0 ls29 ws1">that we stop a<span class="_ _0"></span>t the end of the buffer if there is no NULL character<span class="_ _10"></span>.</div><div class="t m0 x36 h41 yb1f ff44 fse fc3 sc0 ls2a ws1">This routine only processes the core <span class="_ _1"></span>ASCII characters.<span class="_ _1"></span> It doesn’t handle<span class="_ _0"></span> </div><div class="t m0 x36 h41 yb20 ff44 fse fc3 sc0 ls2a ws1">the localized characters,<span class="_ _1"></span> for example,<span class="_ _1"></span> é won’t be converted to É.</div><div class="t m0 x46 h40 yb21 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pfa3" data-dest-detail='[163,"XYZ",53,564,null]'><div class="d m1" style="border-style:none;position:absolute;left:267.005000px;bottom:577.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa4" class="pf w2 h6" data-page-no="a4"><div class="pc pca4 w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">148</div><div class="t m0 xc hd y145 ff3e fs7 fc3 sc0 ls1 ws1">In the upper<span class="_ _1"></span>-case function, we didn’t need any additional memor<span class="_ _0"></span>y, </div><div class="t m0 xd hd y146 ff3e fs7 fc3 sc0 ls1 ws1">since we could do all the work with the av<span class="_ _3"></span>ailable registers<span class="_ _1"></span>. When we code </div><div class="t m0 xd hd y147 ff3e fs7 fc3 sc0 ls1 ws1">larger functions, we often r<span class="_ _1"></span>equire more memory for the variables than </div><div class="t m0 xd hd y1b0 ff3e fs7 fc3 sc0 ls1 ws1">fit in the registers<span class="_ _1"></span>. Rather than add clutter to the <span class="ff42">.data</span> section, we store </div><div class="t m0 xd hd y1b1 ff3e fs7 fc3 sc0 ls1 ws1">these variables on the stack. The section of the stack tha<span class="_ _3"></span>t holds our local </div><div class="t m0 xd hd y1b2 ff3e fs7 fc3 sc0 ls1 ws1">variables is called a stack fr<span class="_ _3"></span>ame.</div><div class="t m0 xd h15 y6b7 ff43 fsb fc3 sc0 ls1 wsaf"> Stack <span class="_ _11"> </span>Frames</div><div class="t m0 xd hd y6b8 ff3e fs7 fc3 sc0 ls1 ws1">Stacks work gr<span class="_ _1"></span>eat for saving and r<span class="_ _1"></span>estor<span class="_ _0"></span>ing r<span class="_ _1"></span>egisters, but to work well for </div><div class="t m0 xd hd yb22 ff3e fs7 fc3 sc0 ls1 ws1">other data, we need the concept of a stack fr<span class="_ _3"></span>ame. H<span class="_ _3"></span>ere we alloca<span class="_ _3"></span>te a block </div><div class="t m0 xd hd yb23 ff3e fs7 fc3 sc0 ls1 ws1">or frame of memory on the stack that we use to store o<span class="_ _3"></span>ur variables<span class="_ _3"></span>. This is </div><div class="t m0 xd hd y6bb ff3e fs7 fc3 sc0 ls1 ws1">an efficient mechanism to alloca<span class="_ _3"></span>te some memor<span class="_ _0"></span>y at the start of a function </div><div class="t m0 xd hd y6bc ff3e fs7 fc3 sc0 ls1 ws1">and then release it befor<span class="_ _3"></span>e we return.</div><div class="t m0 xc hd y6bd ff3e fs7 fc3 sc0 ls1 ws1">PUSHing variables on the stack isn’t pr<span class="_ _1"></span>actical, since we nee<span class="_ _0"></span>d to access </div><div class="t m0 xd hd y6be ff3e fs7 fc3 sc0 ls1 ws1">them in a random or<span class="_ _3"></span>der<span class="_ _6"></span>, rather th<span class="_ _3"></span>an the strict <span class="ff42 ls8 ws9f">LIFO</span> protocol that PUSH/</div><div class="t m0 xd hd y6bf ff3e fs7 fc3 sc0 ls1 ws1">POP enforce.</div><div class="t m0 xc hd yb24 ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o allocate space on the stack, we use a subtract ins<span class="_ _3"></span>truction to grow </div><div class="t m0 xd hd yb25 ff3e fs7 fc3 sc0 ls1 ws1">the stack by the amoun<span class="_ _3"></span>t we need. Suppose we need three variables that ar<span class="_ _1"></span>e </div><div class="t m0 xd hd yb26 ff3e fs7 fc3 sc0 ls1 ws1">each 32-bit integers<span class="_ _3"></span>, say, a, b<span class="_ _1"></span>, and c. Ther<span class="_ _3"></span>efore<span class="_ _1"></span>, w<span class="_ _0"></span>e need 12 bytes alloc<span class="_ _3"></span>ated </div><div class="t m0 xd hd yb27 ff3e fs7 fc3 sc0 ls1 ws1">on the stack (3 variables x 4 byt<span class="_ _3"></span>es/word). W<span class="_ _1"></span>e then need to round up to the </div><div class="t m0 xd hd yb28 ff3e fs7 fc3 sc0 ls1 ws1">next multiple of 16 to keep <span class="ff42">SP</span> 16-b<span class="_ _3"></span>yte aligned.</div><div class="t m0 xd h18 yb29 ff45 fs7 fc3 sc0 ls1 ws1">SUB   SP, SP, #16</div><div class="t m0 xc hd yb2a ff3e fs7 fc3 sc0 ls1 ws1">This moves the s<span class="_ _3"></span>tack pointer down by 16 b<span class="_ _1"></span>ytes, pro<span class="_ _3"></span>viding us a region </div><div class="t m0 xd hd yb2b ff3e fs7 fc3 sc0 ls1 ws1">of memory on the stack to place the variables. Suppose a is in <span class="ff42">W0</span>, b in <span class="ff42">W1</span>, </div><div class="t m0 xd hd yb2c ff3e fs7 fc3 sc0 ls1 ws1">and c in <span class="ff42">W2</span>—we can then store these using</div><div class="t m0 xd h18 yb2d ff45 fs7 fc3 sc0 ls1 ws1">STR    W0, [SP]         // Store a</div><div class="t m0 xd h18 yb2e ff45 fs7 fc3 sc0 ls1 ws1">STR    W1, [SP, #4]     // Store b</div><div class="t m0 xd h18 yb2f ff45 fs7 fc3 sc0 ls1 ws1">STR    W2, [SP, #8]     // Store c</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa5" class="pf w2 h6" data-page-no="a5"><div class="pc pca5 w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">149</div><div class="t m0 x1c hd y145 ff3e fs7 fc3 sc0 ls1 ws1">Before the end of the function, we need to execute</div><div class="t m0 xc h18 y2e0 ff45 fs7 fc3 sc0 ls1 ws1">ADD   SP, SP, #16</div><div class="t m0 x1c hd y3e9 ff3e fs7 fc3 sc0 ls1 ws1">to release our variables fr<span class="_ _1"></span>om the stack. Remember<span class="_ _6"></span>, it is the </div><div class="t m0 xc hd y496 ff3e fs7 fc3 sc0 ls1 ws1">responsibility of a function to r<span class="_ _1"></span>estore <span class="ff42">SP</span> to its original state befor<span class="_ _3"></span>e </div><div class="t m0 xc hd y567 ff3e fs7 fc3 sc0 ls1 ws1">returning<span class="_ _3"></span>.</div><div class="t m0 x1c hd y2d9 ff3e fs7 fc3 sc0 ls1 ws1">This is the simplest wa<span class="_ _3"></span>y to allocate some variables<span class="_ _3"></span>. Ho<span class="_ _3"></span>wever<span class="_ _6"></span>, if we are </div><div class="t m0 xc hd y2da ff3e fs7 fc3 sc0 ls1 ws1">doing a lot of other things with the stack in our function, it can be har<span class="_ _1"></span>d to </div><div class="t m0 xc hd y231 ff3e fs7 fc3 sc0 ls1 ws1">keep track of these offsets<span class="_ _3"></span>. The way to allevia<span class="_ _3"></span>te this is with a stack frame<span class="_ _1"></span>. </div><div class="t m0 xc hd y2e3 ff3e fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e we allocate a r<span class="_ _3"></span>egion on the stack and keep a pointer to this r<span class="_ _3"></span>egion </div><div class="t m0 xc hd y2e4 ff3e fs7 fc3 sc0 ls1 ws1">in another register th<span class="_ _3"></span>at we will refer to as the <span class="ff42">frame pointer</span> (<span class="ff42">FP</span>). Y<span class="_ _6"></span>ou </div><div class="t m0 xc hd y2e5 ff3e fs7 fc3 sc0 ls1 ws1">could use any register as the <span class="ff42">FP</span>, b<span class="_ _3"></span>ut we will follow the C programmin<span class="_ _3"></span>g </div><div class="t m0 xc hd yb30 ff3e fs7 fc3 sc0 ls1 ws1">convention and use <span class="ff42">X29</span>.</div><div class="t m0 x1c hd yb31 ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o use a stack frame, firs<span class="_ _3"></span>t set the frame pointer to the next fr<span class="_ _1"></span>ee spot on </div><div class="t m0 xc hd y63e ff3e fs7 fc3 sc0 ls1 ws1">the stack (it gro<span class="_ _3"></span>ws in descending addresses), then alloca<span class="_ _3"></span>te the space as </div><div class="t m0 xc hd yb32 ff3e fs7 fc3 sc0 ls1 ws1">before:</div><div class="t m0 xc h18 yb33 ff45 fs7 fc3 sc0 ls1 ws1">SUB   FP, SP, #16</div><div class="t m0 xc h18 yb34 ff45 fs7 fc3 sc0 ls1 ws1">SUB   SP, SP, #16</div><div class="t m0 x1c hd yb35 ff3e fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w address the variables usin<span class="_ _3"></span>g an offset from <span class="ff42">FP</span>:</div><div class="t m0 xc h18 y296 ff45 fs7 fc3 sc0 ls1 ws1">STR   W0, [FP]         // Store a</div><div class="t m0 xc h18 y297 ff45 fs7 fc3 sc0 ls1 ws1">STR   W1, [FP, #-4]    // Store b</div><div class="t m0 xc h18 y298 ff45 fs7 fc3 sc0 ls1 ws1">STR   W2, [FP, #-8]    // Store c</div><div class="t m0 x1c hd yb36 ff3e fs7 fc3 sc0 ls1 ws1">When using <span class="ff42">FP</span>, include it in the list of regist<span class="_ _3"></span>ers we PUSH at the </div><div class="t m0 xc hd y557 ff3e fs7 fc3 sc0 ls1 ws1">beginning of the function and then POP at the end. Since <span class="ff42">X29</span>, the <span class="ff42">FP</span> is </div><div class="t m0 xc hd yb37 ff3e fs7 fc3 sc0 ls1 ws1">one we are r<span class="_ _3"></span>esponsible for sa<span class="_ _3"></span>ving. One good thing about using <span class="ff42">FP</span> is that it </div><div class="t m0 xc hd yb38 ff3e fs7 fc3 sc0 ls1 ws1">isn’t requir<span class="_ _3"></span>ed to be 16-byte aligned.</div><div class="t m0 x1c hd y55a ff3e fs7 fc3 sc0 ls1 ws1">In this book, we’ll tend to NOT use <span class="ff42">FP</span>. This sa<span class="_ _1"></span>ves a couple of cycles on </div><div class="t m0 xc hd yb39 ff3e fs7 fc3 sc0 ls1 ws1">function entry and exit. After all, in Assembly Language progr<span class="_ _3"></span>amming, we </div><div class="t m0 xc hd yb3a ff3e fs7 fc3 sc0 ls1 ws1">want to be efficient<span class="_ _3"></span>.</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa6" class="pf w2 h6" data-page-no="a6"><div class="pc pca6 w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">150</div><div class="t m0 xd ha y248 ff43 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Stack Frame Example</div><div class="t m0 xd hd y249 ff3e fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">6-6</span> is a simple skeletal example of a function th<span class="_ _3"></span>at crea<span class="_ _3"></span>tes three </div><div class="t m0 xd hd y24a ff3e fs7 fc3 sc0 ls1 ws1">variables on the stack.</div><div class="t m0 xd h20 yb3b ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-6. <span class="_ _15"> </span><span class="ff3e">Simple skeletal function th<span class="_ _3"></span>at demonstra<span class="_ _3"></span>tes a stack </span></div><div class="t m0 xd h20 yb3c ff3e fs3 fc3 sc0 ls1 ws1">frame</div><div class="t m0 xd h18 yb3d ff45 fs7 fc3 sc0 ls1 ws1">// Simple function that takes 2 parameters</div><div class="t m0 xd h18 yb3e ff45 fs7 fc3 sc0 ls1 ws1">// VAR1 and VAR2. The function adds them,</div><div class="t m0 xd h18 yb3f ff45 fs7 fc3 sc0 ls1 ws1">// storing the result in a variable SUM.</div><div class="t m0 xd h18 yb40 ff45 fs7 fc3 sc0 ls1 ws1">// The function returns the sum.</div><div class="t m0 xd h18 yb41 ff45 fs7 fc3 sc0 ls1 ws1">// It is assumed this function does other work,</div><div class="t m0 xd h18 yb42 ff45 fs7 fc3 sc0 ls1 ws1">// including other functions.</div><div class="t m0 xd h18 yb43 ff45 fs7 fc3 sc0 ls1 ws1">// Define our variables</div><div class="t m0 xd h18 yb44 ff45 fs7 fc3 sc0 ls1 ws1">            .EQU  VAR1, 0</div><div class="t m0 xd h18 yb45 ff45 fs7 fc3 sc0 ls1 ws1">            .EQU  VAR2, 4</div><div class="t m0 xd h18 yb46 ff45 fs7 fc3 sc0 ls1 ws1">            .EQU  SUM,  8</div><div class="t m0 xd h18 yb47 ff45 fs7 fc3 sc0 ls1 ws1">SUMFN:      STP   LR, FP, [SP, #-16]!</div><div class="t m0 xd h18 yb48 ff45 fs7 fc3 sc0 ls1 ws1">            SUB   FP, SP, #16</div><div class="t m0 xd h18 yb49 ff45 fs7 fc3 sc0 ls1 ws1">            SUB   SP, SP, #16       // room for 3 32-bit values</div><div class="t m0 xd h18 yb4a ff45 fs7 fc3 sc0 ls1 ws1">            STR   W0, [FP, #VAR1]   // save first param.</div><div class="t m0 xd h18 yb4b ff45 fs7 fc3 sc0 ls1 ws1">            STR   W1, [FP, #VAR2]   // save second param.</div><div class="t m0 xd h18 yb4c ff45 fs7 fc3 sc0 ls1 ws1">// Do a bunch of other work, but don’t change SP.</div><div class="t m0 xd h18 yb4d ff45 fs7 fc3 sc0 ls1 ws1">            LDR   W4, [FP, #VAR1]</div><div class="t m0 xd h18 yb4e ff45 fs7 fc3 sc0 ls1 ws1">            LDR   W5, [FP, #VAR2]</div><div class="t m0 xd h18 yb4f ff45 fs7 fc3 sc0 ls1 ws1">            ADD   W6, W4, W5</div><div class="t m0 xd h18 yb50 ff45 fs7 fc3 sc0 ls1 ws1">            STR   W6, [FP, #SUM]</div><div class="t m0 xd h18 yb51 ff45 fs7 fc3 sc0 ls1 ws1">// Do other work</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pfa6" data-dest-detail='[166,"XYZ",35,519,null]'><div class="d m1" style="border-style:none;position:absolute;left:70.055400px;bottom:548.518000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa7" class="pf w2 h6" data-page-no="a7"><div class="pc pca7 w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">151</div><div class="t m0 xc h18 y46b ff45 fs7 fc3 sc0 ls1 ws1">// Function Epilog</div><div class="t m0 xc h18 y46c ff45 fs7 fc3 sc0 ls1 ws1">            LDR   W0, [FP, #SUM]    // load sum to return</div><div class="t m0 xc h18 y46d ff45 fs7 fc3 sc0 ls1 ws1">            ADD   SP, SP, #16       // Release local vars</div><div class="t m0 xc h18 y623 ff45 fs7 fc3 sc0 ls1 ws1">            LDP   LR, FP, [SP], #16 // Restore LR, FP</div><div class="t m0 xc h18 y624 ff45 fs7 fc3 sc0 ls1 ws1">            RET</div><div class="t m0 xc h2a yb52 ff43 fsf fc3 sc0 ls1 wsbb"> Defining <span class="_ _1b"> </span>Symbols</div><div class="t m0 xc hd yb53 ff3e fs7 fc3 sc0 ls1 ws1">In this example<span class="_ _3"></span>, we introduce the <span class="ff42">.EQU</span> Assembler dir<span class="_ _1"></span>e<span class="_ _0"></span>ctive<span class="_ _1"></span>. This directive </div><div class="t m0 xc hd yb54 ff3e fs7 fc3 sc0 ls1 ws1">allows us to define symbols tha<span class="_ _3"></span>t will be substituted by the Assembler </div><div class="t m0 xc hd yb55 ff3e fs7 fc3 sc0 ls1 ws1">before genera<span class="_ _3"></span>ting the compiled code. T<span class="_ _3"></span>his way we can m<span class="_ _3"></span>ake the code </div><div class="t m0 xc hd yb56 ff3e fs7 fc3 sc0 ls1 ws1">more r<span class="_ _3"></span>eadable<span class="_ _3"></span>. In this example<span class="_ _1"></span>, keeping track of which variable is which </div><div class="t m0 xc hd yb57 ff3e fs7 fc3 sc0 ls1 ws1">on the stack makes the code h<span class="_ _3"></span>ard to r<span class="_ _1"></span>ead and er<span class="_ _0"></span>r<span class="_ _3"></span>or<span class="_ _1"></span>-pr<span class="_ _3"></span>one. W<span class="_ _3"></span>ith the .EQU </div><div class="t m0 xc hd yb58 ff3e fs7 fc3 sc0 ls1 ws1">directive<span class="_ _1"></span>, w<span class="_ _0"></span>e can define each v<span class="_ _3"></span>ariable’<span class="_ _6"></span>s offset on the stack once.</div><div class="t m0 x1c hd yb59 ff3e fs7 fc3 sc0 ls20 ws1">Sadly, .EQU only defines numbers<span class="_ _1"></span>, s<span class="_ _0"></span>o we can’t define the whole “[SP<span class="_ _8"></span>, #4]”<span class="_ _0"></span> </div><div class="t m0 xc hd yb5a ff3e fs7 fc3 sc0 ls20 ws1">type string.</div><div class="t m0 xc h15 yb5b ff43 fsb fc3 sc0 ls1 wsaf"> Macros</div><div class="t m0 xc hd yb5c ff3e fs7 fc3 sc0 ls1 ws1">Another way to mak<span class="_ _3"></span>e the upper<span class="_ _1"></span>-case loop into a reusable bit of code is to </div><div class="t m0 xc hd yb5d ff3e fs7 fc3 sc0 ls1 ws1">use macros<span class="_ _1"></span>. The GNU Assembler has a powerful macro capa<span class="_ _3"></span>bility; with </div><div class="t m0 xc hd yb5e ff3e fs7 fc3 sc0 ls1 ws1">macros r<span class="_ _1"></span>ather than calling a function, the Assembler crea<span class="_ _3"></span>tes a copy of </div><div class="t m0 xc hd yb5f ff3e fs7 fc3 sc0 ls1 ws1">the code in each place where it is called, subs<span class="_ _3"></span>tituting any paramet<span class="_ _3"></span>ers. </div><div class="t m0 xc hd yb60 ff3e fs7 fc3 sc0 ls1 ws1">Consider this alternate implemen<span class="_ _3"></span>tation of our upper<span class="_ _1"></span>-case progr<span class="_ _3"></span>am—the </div><div class="t m0 xc hd yb61 ff3e fs7 fc3 sc0 ls1 ws1">first file is mainmacr<span class="_ _1"></span>o.s containin<span class="_ _3"></span>g the contents of Listing <span class="fc5">6-7</span>.</div><div class="t m0 xc h20 yb62 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-7. <span class="_ _15"> </span><span class="ff3e">Progr<span class="_ _3"></span>am to call our toupper m<span class="_ _3"></span>acro</span></div><div class="t m0 xc h18 yb63 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 yb64 ff45 fs7 fc3 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xc h18 yb65 ff45 fs7 fc3 sc0 ls1 ws1">// all upper case by calling a function.</div><div class="t m0 xc h18 yb66 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pfa7" data-dest-detail='[167,"XYZ",53,179,null]'><div class="d m1" style="border-style:none;position:absolute;left:322.990000px;bottom:193.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa8" class="pf w2 h6" data-page-no="a8"><div class="pc pca8 w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">152</div><div class="t m0 xd h18 y46b ff45 fs7 fc3 sc0 ls1 ws1">// X0-X2 - parameters to Linux function services</div><div class="t m0 xd h18 y46c ff45 fs7 fc3 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xd h18 y46d ff45 fs7 fc3 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xd h18 y623 ff45 fs7 fc3 sc0 ls1 ws1">// X2 - original address of input string</div><div class="t m0 xd h18 y624 ff45 fs7 fc3 sc0 ls1 ws1">// X8 - Linux function number</div><div class="t m0 xd h18 y625 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y85e ff45 fs7 fc3 sc0 ls1 ws1">.include &quot;uppermacro.s&quot;</div><div class="t m0 xd h18 yb67 ff45 fs7 fc3 sc0 ls1 ws1">.global _start      // Provide program starting address</div><div class="t m0 xd h18 y912 ff45 fs7 fc3 sc0 ls1 ws1">_start:</div><div class="t m0 xd h18 yb68 ff45 fs7 fc3 sc0 ls1 ws1">      // Convert tststr to upper case.</div><div class="t m0 xd h18 yb69 ff45 fs7 fc3 sc0 ls1 ws1">      toupper tststr, buffer</div><div class="t m0 xd h18 yb6a ff45 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print</div><div class="t m0 xd h18 yb6b ff45 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 yb6c ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X2, X0 // return code is the len of the string</div><div class="t m0 xd h18 yb6d ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X0, #1      // 1 = StdOut</div><div class="t m0 xd h18 yb6e ff45 fs7 fc3 sc0 ls1 ws1">      LDR   X1, =buffer // string to print</div><div class="t m0 xd h18 yb6f ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X8, #64     // linux write system call</div><div class="t m0 xd h18 yb70 ff45 fs7 fc3 sc0 ls1 ws1">      SVC   0           // Call linux to output the string</div><div class="t m0 xd h18 yb71 ff45 fs7 fc3 sc0 ls1 ws1">      // Convert second string tststr2.</div><div class="t m0 xd h18 yb72 ff45 fs7 fc3 sc0 ls1 ws1">      toupper tststr2, buffer</div><div class="t m0 xd h18 yb73 ff45 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print</div><div class="t m0 xd h18 yb74 ff45 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 yb75 ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X2, X0 // return code is the len of the string</div><div class="t m0 xd h18 yb76 ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X0, #1          // 1 = StdOut</div><div class="t m0 xd h18 yb77 ff45 fs7 fc3 sc0 ls1 ws1">      LDR   X1, =buffer     // string to print</div><div class="t m0 xd h18 yb78 ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X8, #64         // linux write system call</div><div class="t m0 xd h18 yb79 ff45 fs7 fc3 sc0 ls1 ws1">      SVC   0               // Call linux to output the string</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfa9" class="pf w2 h6" data-page-no="a9"><div class="pc pca9 w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">153</div><div class="t m0 xc h18 y46b ff45 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xc h18 y46c ff45 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 y46d ff45 fs7 fc3 sc0 ls1 ws1">      MOV     X0, #0      // Use 0 return code</div><div class="t m0 xc h18 y623 ff45 fs7 fc3 sc0 ls1 ws1">      MOV     X8, #93     // Service command code 93 terms</div><div class="t m0 xc h18 y624 ff45 fs7 fc3 sc0 ls1 ws1">        SVC     0         // Call Linux to terminate</div><div class="t m0 xc h18 y85d ff45 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xc h18 y983 ff45 fs7 fc3 sc0 ls1 ws1">tststr:  .asciz  &quot;This is our Test String that we will </div><div class="t m0 xc h18 y984 ff45 fs7 fc3 sc0 ls1 ws1">convert.\n&quot;</div><div class="t m0 xc h18 yb7a ff45 fs7 fc3 sc0 ls1 ws1">tststr2: .asciz    &quot;A second string to upper case!!\n&quot;</div><div class="t m0 xc h18 yb7b ff45 fs7 fc3 sc0 ls1 ws1">buffer:     .fill  255, 1, 0</div><div class="t m0 x1c hd y84a ff3e fs7 fc3 sc0 ls1 ws1">The macr<span class="_ _3"></span>o to make the string all upper<span class="_ _1"></span>-case is in uppermacro<span class="_ _1"></span>.s </div><div class="t m0 xc hd yb7c ff3e fs7 fc3 sc0 ls1 ws1">containing Listing <span class="fc5">6-8</span>.</div><div class="t m0 xc h20 yb7d ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-8. <span class="_ _15"> </span><span class="ff3e">Macr<span class="_ _1"></span>o version of our toupper function</span></div><div class="t m0 xc h18 yb7e ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 yb7f ff45 fs7 fc3 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xc h18 yb80 ff45 fs7 fc3 sc0 ls1 ws1">// all upper case.</div><div class="t m0 xc h18 yb81 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 yb82 ff45 fs7 fc3 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xc h18 yb83 ff45 fs7 fc3 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xc h18 yb84 ff45 fs7 fc3 sc0 ls1 ws1">// X2 - original output string for length calc.</div><div class="t m0 xc h18 yb85 ff45 fs7 fc3 sc0 ls1 ws1">// W3 - current character being processed</div><div class="t m0 xc h18 yb86 ff45 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 yb87 ff45 fs7 fc3 sc0 ls1 ws1">// label 1 = loop</div><div class="t m0 xc h18 yb88 ff45 fs7 fc3 sc0 ls1 ws1">// label 2 = cont</div><div class="t m0 xc h18 yb89 ff45 fs7 fc3 sc0 ls1 ws1">.MACRO      toupper      instr, outstr</div><div class="t m0 xc h18 yb8a ff45 fs7 fc3 sc0 ls1 ws1">      LDR   X0, =\instr</div><div class="t m0 xc h18 yb8b ff45 fs7 fc3 sc0 ls1 ws1">      LDR   X1, =\outstr</div><div class="t m0 xc h18 yb8c ff45 fs7 fc3 sc0 ls1 ws1">      MOV   X2, X1</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pfa9" data-dest-detail='[169,"XYZ",53,371,null]'><div class="d m1" style="border-style:none;position:absolute;left:140.877000px;bottom:385.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfaa" class="pf w2 h6" data-page-no="aa"><div class="pc pcaa w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">154</div><div class="t m0 xd h18 y46b ff45 fs7 fc3 sc0 ls1 ws1">// The loop is until byte pointed to by X1 is non-zero</div><div class="t m0 xd h18 y46c ff45 fs7 fc3 sc0 ls1 ws1">1:    LDRB  W3, [X0], #1 // load char and incr pointer</div><div class="t m0 xd h18 y46d ff45 fs7 fc3 sc0 ls1 ws1">// If R5 &gt; &apos;z&apos; then goto cont</div><div class="t m0 xd h18 y623 ff45 fs7 fc3 sc0 ls1 ws1">      CMP   W3, #&apos;z&apos;        // is letter &gt; &apos;z&apos;?</div><div class="t m0 xd h18 y624 ff45 fs7 fc3 sc0 ls1 ws1">      B.GT  2f</div><div class="t m0 xd h18 y625 ff45 fs7 fc3 sc0 ls1 ws1">// Else if R5 &lt; &apos;a&apos; then goto end if</div><div class="t m0 xd h18 y626 ff45 fs7 fc3 sc0 ls1 ws1">      CMP   W3, #&apos;a&apos;</div><div class="t m0 xd h18 y627 ff45 fs7 fc3 sc0 ls1 ws1">      B.LT  2f    // goto to end if</div><div class="t m0 xd h18 y628 ff45 fs7 fc3 sc0 ls1 ws1">// if we got here then the letter is lower case,</div><div class="t m0 xd h18 y9f6 ff45 fs7 fc3 sc0 ls1 ws1">// so convert it.</div><div class="t m0 xd h18 y9f7 ff45 fs7 fc3 sc0 ls1 ws1">      SUB   W3, W3, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xd h18 y9f8 ff45 fs7 fc3 sc0 ls1 ws1">2:    // end if</div><div class="t m0 xd h18 yb8d ff45 fs7 fc3 sc0 ls1 ws1">      STRB  W3, [X1], #1 // store char to output str</div><div class="t m0 xd h18 yb8e ff45 fs7 fc3 sc0 ls1 ws1">      CMP   W3, #0       // stop on hitting a null char</div><div class="t m0 xd h18 yb8f ff45 fs7 fc3 sc0 ls1 ws1">      B.NE  1b           // loop if character isn&apos;t null</div><div class="t m0 xd h18 yb90 ff45 fs7 fc3 sc0 ls1 ws1">      SUB   X0, X1, X2   // get the len by subing the ptrs</div><div class="t m0 xd h18 yb91 ff45 fs7 fc3 sc0 ls1 ws1">.ENDM</div><div class="t m0 xd ha yb92 ff43 fs6 fc3 sc0 ls1 wsb1"> Inc<span class="_ _1"></span>lude <span class="_ _14"> </span>Directive</div><div class="t m0 xd hd yb93 ff3e fs7 fc3 sc0 ls1 ws1">The file uppermacro<span class="_ _1"></span>.s defines the macro to con<span class="_ _1"></span>ver<span class="_ _0"></span>t a string to upper<span class="_ _1"></span>-case. </div><div class="t m0 xd hd yb94 ff3e fs7 fc3 sc0 ls1 ws1">The macr<span class="_ _3"></span>o doesn’t generate any code; it j<span class="_ _3"></span>ust defines the macr<span class="_ _3"></span>o for the </div><div class="t m0 xd hd yb95 ff3e fs7 fc3 sc0 ls1 ws1">Assembler to insert wherever it is called fr<span class="_ _3"></span>om. This file doesn’t gener<span class="_ _3"></span>ate an </div><div class="t m0 xd hd yb96 ff3e fs7 fc3 sc0 ls1 ws1">object (<span class="ff47">∗</span>.o) file; rather it is included b<span class="_ _3"></span>y whichever file needs to use it.</div><div class="t m0 xc hd yb97 ff3e fs7 fc3 sc0 ls1 ws1">The <span class="ff42">.include</span> directive</div><div class="t m0 xd h18 yb98 ff45 fs7 fc3 sc0 ls1 ws1">.include &quot;uppermacro.s&quot;</div><div class="t m0 xc hd yb99 ff3e fs7 fc3 sc0 ls1 ws1">takes the contents of this file and inserts it at this point<span class="_ _3"></span>, so that the </div><div class="t m0 xd hd yb9a ff3e fs7 fc3 sc0 ls1 ws1">source file becomes larger<span class="_ _10"></span>. This is done before any other pr<span class="_ _3"></span>ocessing. This is </div><div class="t m0 xd hd yb9b ff3e fs7 fc3 sc0 ls1 ws1">like the C <span class="ff42">#include</span> prepr<span class="_ _3"></span>ocessor directive<span class="_ _3"></span>.</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfab" class="pf w2 h6" data-page-no="ab"><div class="pc pcab w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">155</div><div class="t m0 xc ha y248 ff43 fs6 fc3 sc0 ls1 wsb1"> Macro <span class="_ _14"> </span>Definition</div><div class="t m0 xc hd y249 ff3e fs7 fc3 sc0 ls1 ws1">A macro is defined with the <span class="ff42">.MACRO</span> dir<span class="_ _1"></span>e<span class="_ _0"></span>ctive<span class="_ _1"></span>. This gives the name of the </div><div class="t m0 xc hd y24a ff3e fs7 fc3 sc0 ls1 ws1">macro and lis<span class="_ _3"></span>ts its parameters<span class="_ _1"></span>. The macro ends at the following <span class="ff42">.ENDM</span> </div><div class="t m0 xc hd y24b ff3e fs7 fc3 sc0 ls1 ws1">directive<span class="_ _1"></span>. The for<span class="_ _0"></span>m of the dir<span class="_ _3"></span>ective is</div><div class="t m0 xc h18 yb9c ff45 fs7 fc3 sc0 ls1 ws1">.MACRO   macroname   parameter1, parameter2, ...</div><div class="t m0 x1c hd y324 ff3e fs7 fc3 sc0 ls1 ws1">Within the macr<span class="_ _1"></span>o, you s<span class="_ _3"></span>pecify the parameters by pr<span class="_ _1"></span>ece<span class="_ _0"></span>ding their </div><div class="t m0 xc hd yb9d ff3e fs7 fc3 sc0 ls1 ws1">name with a backslash, for instance<span class="_ _1"></span>, \parameter1 to place the value of </div><div class="t m0 xc hd yb9e ff3e fs7 fc3 sc0 ls1 ws1">parameter1. The toupper m<span class="_ _3"></span>acro defines two par<span class="_ _3"></span>ameters instr and outstr<span class="_ _0"></span>:</div><div class="t m0 xc h18 y5f1 ff45 fs7 fc3 sc0 ls1 ws1">.MACRO   toupper   instr, outstr</div><div class="t m0 x1c hd y5f2 ff3e fs7 fc3 sc0 ls1 ws1">The parameters ar<span class="_ _1"></span>e us<span class="_ _0"></span>ed in the code with \instr and \oustr<span class="_ _10"></span>. These are </div><div class="t m0 xc hd yb9f ff3e fs7 fc3 sc0 ls1 ws1">text substitutions and need to r<span class="_ _3"></span>esult in correct Assembly syntax or y<span class="_ _3"></span>ou will </div><div class="t m0 xc hd yba0 ff3e fs7 fc3 sc0 ls1 ws1">get an error<span class="_ _10"></span>.</div><div class="t m0 xc ha yba1 ff43 fs6 fc3 sc0 ls1 wsb1"> Labels</div><div class="t m0 xc hd yba2 ff3e fs7 fc3 sc0 ls1 ws1">The labels “loop<span class="_ _1"></span>” and “<span class="_ _6"></span>cont” are replaced with the labels “1” and “2.<span class="_ _8"></span>” This </div><div class="t m0 xc hd yba3 ff3e fs7 fc3 sc0 ls1 ws1">takes aw<span class="_ _3"></span>ay fr<span class="_ _3"></span>om the readability of the pr<span class="_ _1"></span>ogram. The r<span class="_ _3"></span>eason we do this is </div><div class="t m0 xc hd yba4 ff3e fs7 fc3 sc0 ls1 ws1">that if we didn’t, we<span class="_ _3"></span>’<span class="_ _6"></span>d get an error that a label w<span class="_ _3"></span>as defined more than once<span class="_ _1"></span>, </div><div class="t m0 xc hd yba5 ff3e fs7 fc3 sc0 ls1 ws1">if we use the macro mor<span class="_ _3"></span>e than once<span class="_ _3"></span>. The trick here is th<span class="_ _3"></span>at the Assembler </div><div class="t m0 xc hd yba6 ff3e fs7 fc3 sc0 ls1 ws1">lets you define numeric labels as man<span class="_ _3"></span>y times as you want<span class="_ _3"></span>. T<span class="_ _6"></span>o refer<span class="_ _3"></span>ence </div><div class="t m0 xc hd yba7 ff3e fs7 fc3 sc0 ls1 ws1">them in the code, we used</div><div class="t m0 xc h18 yba8 ff45 fs7 fc3 sc0 ls1 ws1">B.GT   2f</div><div class="t m0 xc h18 yba9 ff45 fs7 fc3 sc0 ls1 ws1">B.NE   1b       @ loop if character isn&apos;t null</div><div class="t m0 x1c hd ybaa ff3e fs7 fc3 sc0 ls1 ws1">The <span class="ff42">f</span> after the <span class="ff42">2</span> means the next label <span class="ff42">2</span> in the forward dir<span class="_ _3"></span>ection. The <span class="ff42">1b</span> </div><div class="t m0 xc hd ybab ff3e fs7 fc3 sc0 ls1 ws1">means the next label <span class="ff42">1</span> in the back<span class="_ _1"></span>ward direction.</div><div class="t m0 x1c hd ybac ff3e fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o prov<span class="_ _3"></span>e that this works<span class="_ _1"></span>, we call toupper twice in the mainmacro<span class="_ _1"></span>.s file, </div><div class="t m0 xc hd ybad ff3e fs7 fc3 sc0 ls1 ws1">to show everything works and that we can r<span class="_ _3"></span>euse this macr<span class="_ _3"></span>o as many times </div><div class="t m0 xc hd ybae ff3e fs7 fc3 sc0 ls1 ws1">as we like.</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfac" class="pf w2 h6" data-page-no="ac"><div class="pc pcac w2 h6"><img class="bi xd ybaf w7 h34" alt="" src="bgac.png"/><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">156</div><div class="t m0 xd ha y248 ff43 fs6 fc3 sc0 ls1 wsb1"> Why <span class="_ _14"> </span>Macros?</div><div class="t m0 xd hd y249 ff3e fs7 fc3 sc0 ls1 ws1">Macr<span class="_ _1"></span>os substitute a copy of the code at every point they are used. This will </div><div class="t m0 xd hd y24a ff3e fs7 fc3 sc0 ls1 ws1">make the executable file lar<span class="_ _3"></span>ger<span class="_ _6"></span>, for example, when using</div><div class="t m0 xd h18 ybb0 ff45 fs7 fc3 sc0 ls1 ws1">objdump -d mainmacro</div><div class="t m0 xc hd ybb1 ff3e fs7 fc3 sc0 ls1 ws1">two copies of code are inserted. With functions<span class="_ _3"></span>, there is no extr<span class="_ _3"></span>a code </div><div class="t m0 xd hd y324 ff3e fs7 fc3 sc0 ls1 ws1">generated each time<span class="_ _1"></span>. This is why functions are quite appealing, even with </div><div class="t m0 xd hd yb9d ff3e fs7 fc3 sc0 ls1 ws1">the extra work of dealin<span class="_ _3"></span>g with the stack.</div><div class="t m0 xc hd yb9e ff3e fs7 fc3 sc0 ls1 ws1">The reason m<span class="_ _3"></span>acros get used is performance. M<span class="_ _3"></span>ost ARM devices ha<span class="_ _3"></span>ve </div><div class="t m0 xd hd ybb2 ff3e fs7 fc3 sc0 ls1 ws1">a gigab<span class="_ _3"></span>yte or more of memory—a lot of room for multiple copies of code<span class="_ _1"></span>. </div><div class="t m0 xd hd y923 ff3e fs7 fc3 sc0 ls1 ws1">Remember that whenev<span class="_ _3"></span>er we branch, we mus<span class="_ _3"></span>t restart the execution </div><div class="t m0 xd hd y924 ff3e fs7 fc3 sc0 ls1 ws1">pipeline, makin<span class="_ _3"></span>g branching an expensive instruction. W<span class="_ _3"></span>ith macros<span class="_ _1"></span>, we </div><div class="t m0 xd hd y925 ff3e fs7 fc3 sc0 ls1 ws1">eliminate the <span class="ff42 ls1f wsc7">BL</span> br<span class="_ _3"></span>anch to call the function and the <span class="ff42 ls1c wsbf">RET</span> branch to r<span class="_ _3"></span>eturn. </div><div class="t m0 xd hd y926 ff3e fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e also eliminate any instructions to sav<span class="_ _3"></span>e and restor<span class="_ _1"></span>e the registers we </div><div class="t m0 xd hd y927 ff3e fs7 fc3 sc0 ls1 ws1">use. If a macr<span class="_ _1"></span>o is small and we use it a lot, there could be considerable </div><div class="t m0 xd hd y928 ff3e fs7 fc3 sc0 ls1 ws1">execution time sa<span class="_ _3"></span>vings.</div><div class="t m0 x34 h41 ybb3 ff43 fse fc3 sc0 ls1 ws1">Note<span class="ff44"> <span class="_ _19"> </span>Notice in the macro implementation of toupper tha<span class="_ _0"></span>t only the </span></div><div class="t m0 x34 h41 ybb4 ff44 fse fc3 sc0 ls1 ws1">registers <span class="ff43">X0</span>–<span class="ff43">X3</span> were used.<span class="_ _1"></span> <span class="_ _1"></span>This a<span class="_ _0"></span>voids using any registers important </div><div class="t m0 x34 h41 ybb5 ff44 fse fc3 sc0 ls1 ws1">to the caller<span class="_ _6"></span>.<span class="_ _1"></span> <span class="_ _1"></span>There is no standard on ho<span class="_ _0"></span>w to regulate register </div><div class="t m0 x34 h41 ybb6 ff44 fse fc3 sc0 ls1 ws1">usage with macros,<span class="_ _1"></span> like there’<span class="_ _1"></span>s with functions,<span class="_ _1"></span> so it is up to you the </div><div class="t m0 x34 h41 ybb7 ff44 fse fc3 sc0 ls1 ws1">programmer to avoid conflicts and strange bugs.</div><div class="t m0 xc hd y92f ff3e fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can also use macros to make the code mor<span class="_ _1"></span>e readable and easier to </div><div class="t m0 xd hd ybb8 ff3e fs7 fc3 sc0 ls1 ws1">write, as described in the next section.</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfad" class="pf w2 h6" data-page-no="ad"><div class="pc pcad w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">157</div><div class="t m0 xc ha y248 ff43 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Macros toImprove Code</div><div class="t m0 xc hd y249 ff3e fs7 fc3 sc0 ls1 ws1">Using <span class="ff42">LDR</span>, <span class="ff42">LDP</span>, <span class="ff42 ls1c wsbf">STR</span>, and <span class="ff42 ls1c wsbf">STP</span> to manipulate the stack is c<span class="_ _3"></span>lumsy and </div><div class="t m0 xc hd y24a ff3e fs7 fc3 sc0 ls1 ws1">error<span class="_ _1"></span>-pr<span class="_ _1"></span>one. Y<span class="_ _1"></span>ou spend a lot of time cutting and pas<span class="_ _3"></span>ting the code from </div><div class="t m0 xc hd y24b ff3e fs7 fc3 sc0 ls1 ws1">other places to try and get it cor<span class="_ _0"></span>r<span class="_ _3"></span>ect. I<span class="_ _3"></span>t would be nice if there were </div><div class="t m0 xc hd y5ad ff3e fs7 fc3 sc0 ls1 ws1">instruction aliases to push and pop the stack. In fact, ther<span class="_ _1"></span>e is in 32-bit </div><div class="t m0 xc hd y5ae ff3e fs7 fc3 sc0 ls1 ws1">ARM Assembly Language<span class="_ _3"></span>. However<span class="_ _10"></span>, with macros<span class="_ _3"></span>, we can over<span class="_ _1"></span>come this. </div><div class="t m0 xc hd y7f6 ff3e fs7 fc3 sc0 ls1 ws1">Consider Listing <span class="fc5">6-9</span>.</div><div class="t m0 xc h20 y325 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-9. <span class="_ _15"> </span><span class="ff3e">Define four macros for p<span class="_ _3"></span>ushing and popping the stack</span></div><div class="t m0 xc h18 y326 ff45 fs7 fc3 sc0 ls1 ws1">.MACRO    PUSH1 register</div><div class="t m0 xc h18 y7f7 ff45 fs7 fc3 sc0 ls1 ws1">          STR   \register, [SP, #-16]!</div><div class="t m0 xc h18 ybb9 ff45 fs7 fc3 sc0 ls1 ws1">.ENDM</div><div class="t m0 xc h18 ybba ff45 fs7 fc3 sc0 ls1 ws1">.MACRO    POP1  register</div><div class="t m0 xc h18 ybbb ff45 fs7 fc3 sc0 ls1 ws1">          LDR   \register, [SP], #16</div><div class="t m0 xc h18 ybbc ff45 fs7 fc3 sc0 ls1 ws1">.ENDM</div><div class="t m0 xc h18 ybbd ff45 fs7 fc3 sc0 ls1 ws1">.MACRO    PUSH2 register1, register2</div><div class="t m0 xc h18 ybbe ff45 fs7 fc3 sc0 ls1 ws1">          STP   \register1, \register2, [SP, #-16]!</div><div class="t m0 xc h18 ybbf ff45 fs7 fc3 sc0 ls1 ws1">.ENDM</div><div class="t m0 xc h18 ybc0 ff45 fs7 fc3 sc0 ls1 ws1">.MACRO    POP2  register1, register2</div><div class="t m0 xc h18 ybc1 ff45 fs7 fc3 sc0 ls1 ws1">          LDP   \register1, \register2, [SP], #16</div><div class="t m0 xc h18 ybc2 ff45 fs7 fc3 sc0 ls1 ws1">.ENDM</div><div class="t m0 x1c hd ybc3 ff3e fs7 fc3 sc0 ls1 ws1">This simplifies our code since we can use these to write code like in </div><div class="t m0 xc hd ybc4 ff3e fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">6-10</span>.</div><div class="t m0 xc h20 ybc5 ff46 fs3 fc3 sc0 ls1 ws1">Listing 6-10. <span class="_ _15"> </span><span class="ff3e">Use our push and pop macr<span class="_ _1"></span>os</span></div><div class="t m0 xc h18 ybc6 ff45 fs7 fc3 sc0 ls1 ws1">Myfunction:</div><div class="t m0 xc h18 ybc7 ff45 fs7 fc3 sc0 ls1 ws1">      PUSH1 LR</div><div class="t m0 xc h18 ybc8 ff45 fs7 fc3 sc0 ls1 ws1">      PUSH2 X20, X23</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div><a class="l" href="#pfad" data-dest-detail='[173,"XYZ",53,455,null]'><div class="d m1" style="border-style:none;position:absolute;left:133.133000px;bottom:468.518000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfad" data-dest-detail='[173,"XYZ",53,186,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:200.018000px;width:20.547600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfae" class="pf w2 h6" data-page-no="ae"><div class="pc pcae w2 h6"><div class="t m0 xd hd y3f ff3e fs7 fc3 sc0 ls1 ws1">158</div><div class="t m0 xd h18 y46b ff45 fs7 fc3 sc0 ls1 ws1">// function body ...</div><div class="t m0 xd h18 y46c ff45 fs7 fc3 sc0 ls1 ws1">      POP2  X20, X23</div><div class="t m0 xd h18 y46d ff45 fs7 fc3 sc0 ls1 ws1">      POP1  LR</div><div class="t m0 xd h18 y623 ff45 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 xc hd y46f ff3e fs7 fc3 sc0 ls1 ws1">This makes writing the function pr<span class="_ _3"></span>ologues and epilogues easier and </div><div class="t m0 xd hd y85d ff3e fs7 fc3 sc0 ls1 ws1">clearer<span class="_ _10"></span>.</div><div class="t m0 xd h15 ybc9 ff43 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd ybca ff3e fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we covered the ARM stac<span class="_ _3"></span>k and how it’<span class="_ _6"></span>s used to help </div><div class="t m0 xd hd ybcb ff3e fs7 fc3 sc0 ls1 ws1">implement functions<span class="_ _3"></span>. W<span class="_ _1"></span>e cover<span class="_ _3"></span>ed how to write and call functions as a </div><div class="t m0 xd hd ybcc ff3e fs7 fc3 sc0 ls1 ws1">first step to cre<span class="_ _3"></span>ating libraries of r<span class="_ _3"></span>eusable code<span class="_ _3"></span>. W<span class="_ _1"></span>e learned how to manage </div><div class="t m0 xd hd ybcd ff3e fs7 fc3 sc0 ls1 ws1">register usage<span class="_ _1"></span>, so there aren’t any conflicts between calling pr<span class="_ _3"></span>ograms </div><div class="t m0 xd hd ybce ff3e fs7 fc3 sc0 ls1 ws1">and functions. W<span class="_ _1"></span>e learned the function calling pr<span class="_ _3"></span>otocol, which allows </div><div class="t m0 xd hd ybcf ff3e fs7 fc3 sc0 ls1 ws1">us to inter<span class="_ _3"></span>operate with other pr<span class="_ _3"></span>ogramming langua<span class="_ _3"></span>ges. Also<span class="_ _1"></span>, we looked </div><div class="t m0 xd hd ybd0 ff3e fs7 fc3 sc0 ls1 ws1">at defining stack<span class="_ _6"></span>-base<span class="_ _0"></span>d stor<span class="_ _3"></span>age for local variables and how to use this </div><div class="t m0 xd hd ybd1 ff3e fs7 fc3 sc0 ls1 ws1">memory.</div><div class="t m0 xc hd ybd2 ff3e fs7 fc3 sc0 ls1 ws1">Fin<span class="_ _3"></span>ally, we cover<span class="_ _3"></span>ed the GNU Assembler’<span class="_ _1"></span>s macro a<span class="_ _3"></span>bility as an </div><div class="t m0 xd hd ybd3 ff3e fs7 fc3 sc0 ls1 ws1">alternative to functions in certain performance critical applications<span class="_ _1"></span>.</div><div class="t m0 xd h15 ybd4 ff43 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd ybd5 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>If we are coding for an opera<span class="_ _3"></span>ting system wher<span class="_ _3"></span>e the </div><div class="t m0 x1e hd ybd6 ff3e fs7 fc3 sc0 ls1 ws1">stack gro<span class="_ _3"></span>ws upwar<span class="_ _1"></span>d, how would we code the <span class="ff42">L<span class="_ _0"></span>DR</span>, </div><div class="t m0 x1e hd ybd7 ff42 fs7 fc3 sc0 ls1 ws1">LDP<span class="ff3e">, </span><span class="ls1c wsbf">STR</span><span class="ff3e">, and </span><span class="ls1c wsbf">STP</span><span class="ff3e"> instructions?</span></div><div class="t m0 xc hd ybd8 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Suppose we have a function th<span class="_ _3"></span>at uses register<span class="_ _3"></span>s X4, </div><div class="t m0 x1e hd ybd9 ff3e fs7 fc3 sc0 ls1 ws1">X5, W20, X23, and W27. Further this function calls </div><div class="t m0 x1e hd ybda ff3e fs7 fc3 sc0 ls1 ws1">other functions. Code the pr<span class="_ _1"></span>ologue and epilogue </div><div class="t m0 x1e hd ybdb ff3e fs7 fc3 sc0 ls1 ws1">of this function to store and r<span class="_ _1"></span>estore the correct </div><div class="t m0 x1e hd ybdc ff3e fs7 fc3 sc0 ls1 ws1">registers to/fr<span class="_ _1"></span>om the stack.</div><div class="t m0 xd h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfaf" class="pf w2 h6" data-page-no="af"><div class="pc pcaf w2 h6"><div class="t m0 x17 hd y3f ff3e fs7 fc3 sc0 ls1 ws1">159</div><div class="t m0 x1c hd y145 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Write a function to convert text to all lower<span class="_ _1"></span>-case. </div><div class="t m0 x9 hd y146 ff3e fs7 fc3 sc0 ls1 ws1">Ha<span class="_ _1"></span>ve this function in one file and a main program in </div><div class="t m0 x9 hd y147 ff3e fs7 fc3 sc0 ls1 ws1">another file. I<span class="_ _3"></span>n the main progr<span class="_ _1"></span>am, call the function </div><div class="t m0 x9 hd y1b0 ff3e fs7 fc3 sc0 ls1 ws1">three times with differen<span class="_ _3"></span>t test strings.</div><div class="t m0 x1c hd y149 ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Convert the lower<span class="_ _1"></span>-case program in Exer<span class="_ _3"></span>cise 3 to a </div><div class="t m0 x9 hd y14a ff3e fs7 fc3 sc0 ls1 ws1">macro<span class="_ _1"></span>. H<span class="_ _3"></span>ave it run on the same thr<span class="_ _1"></span>e<span class="_ _0"></span>e test strings to </div><div class="t m0 x9 hd y1cb ff3e fs7 fc3 sc0 ls1 ws1">ensure it wor<span class="_ _3"></span>ks properly.</div><div class="t m0 x1c hd y58d ff3e fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Why does the function calling pr<span class="_ _3"></span>otocol ha<span class="_ _3"></span>ve some </div><div class="t m0 x9 hd y58e ff3e fs7 fc3 sc0 ls1 ws1">registers need to be sa<span class="_ _1"></span>ved by the caller and some </div><div class="t m0 x9 hd y2f3 ff3e fs7 fc3 sc0 ls1 ws1">by the callee? Why not m<span class="_ _3"></span>ake all sa<span class="_ _1"></span>ved by one or the </div><div class="t m0 x9 hd y2f4 ff3e fs7 fc3 sc0 ls1 ws1">other?</div><div class="t m0 x46 h40 y71 ff44 fsa fc3 sc0 ls1 ws1">CHAPTER 6 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>FUNCTIONS AND THEST<span class="_ _1"></span>ACK</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb0" class="pf w2 h6" data-page-no="b0"><div class="pc pcb0 w2 h6"><div class="t m0 x17 hd y16a ff48 fs7 fc3 sc0 ls1 ws1">161</div><div class="t m0 xc h17 y16b ff48 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff48 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff49">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff48">,  </span></span></div><div class="t m0 xc h17 y16d ff48 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_7</div><div class="t m0 xc ha y16e ff4a fs6 fc3 sc0 ls1 ws1">CHAPTER 7</div><div class="t m0 xc h8 y16f ff4b fs4 fc3 sc0 ls1 ws1">Lin<span class="_ _3"></span>ux Oper<span class="_ _1"></span>a<span class="_ _2"></span>ting </div><div class="t m0 xc h8 y747 ff4b fs4 fc3 sc0 ls1 ws1">System Ser<span class="_ _7"></span>vices</div><div class="t m0 xc hd y748 ff48 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">1</span>, “<span class="_ _1"></span>Getting Started,<span class="_ _8"></span>” we neede<span class="_ _0"></span>d the ability to exit our pr<span class="_ _1"></span>ogram </div><div class="t m0 xc hd y749 ff48 fs7 fc3 sc0 ls1 ws1">and to display a string. W<span class="_ _1"></span>e used Linux to do this, in<span class="_ _1"></span>voking operating </div><div class="t m0 xc hd y74a ff48 fs7 fc3 sc0 ls1 ws1">system services directly. In all high-level pr<span class="_ _3"></span>ogramming langua<span class="_ _3"></span>ges, ther<span class="_ _3"></span>e is </div><div class="t m0 xc hd y74b ff48 fs7 fc3 sc0 ls1 ws1">a runtime library that includes wrappers for c<span class="_ _3"></span>alling the operatin<span class="_ _3"></span>g system. </div><div class="t m0 xc hd y74c ff48 fs7 fc3 sc0 ls1 ws1">This makes it appear th<span class="_ _3"></span>at these services are part of the high-level language. </div><div class="t m0 xc hd y74d ff48 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we’ll look at what these runtime libr<span class="_ _3"></span>aries do under the </div><div class="t m0 xc hd y74e ff48 fs7 fc3 sc0 ls1 ws1">covers to c<span class="_ _3"></span>all Linux and what services are a<span class="_ _3"></span>vailable to us<span class="_ _3"></span>.</div><div class="t m0 x1c hd y74f ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will review the syntax for calling the opera<span class="_ _3"></span>ting system<span class="_ _3"></span>, the error </div><div class="t m0 xc hd y8c6 ff48 fs7 fc3 sc0 ls1 ws1">codes returned to us<span class="_ _1"></span>. We<span class="_ _1"></span>’ll g<span class="_ _0"></span>et some help fr<span class="_ _3"></span>om the GNU C compiler<span class="_ _6"></span>, </div><div class="t m0 xc hd y8c7 ff48 fs7 fc3 sc0 ls1 ws1">utilizing some C header files to get the definitions we need for the Linux </div><div class="t m0 xc hd y8c8 ff48 fs7 fc3 sc0 ls1 ws1">ser<span class="_ _0"></span>vice call n<span class="_ _3"></span>umbers, r<span class="_ _1"></span>ather than using magic numbers lik<span class="_ _3"></span>e 64 and 93.</div><div class="t m0 xc h15 ybdd ff4c fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>So Many Ser<span class="_ _0"></span>vices</div><div class="t m0 xc hd ybde ff48 fs7 fc3 sc0 ls1 ws1">Linux is a powerful, full-featur<span class="_ _3"></span>ed operating system with o<span class="_ _3"></span>ver 25 years of </div><div class="t m0 xc hd ybdf ff48 fs7 fc3 sc0 ls1 ws1">development. Linux po<span class="_ _3"></span>wers devices from watc<span class="_ _3"></span>hes all the way up to super<span class="_ _1"></span>- </div><div class="t m0 xc hd ybe0 ff48 fs7 fc3 sc0 ls1 ws1">computers<span class="_ _3"></span>. One of the keys to this success is the richness and power of all </div><div class="t m0 xc hd ybe1 ff48 fs7 fc3 sc0 ls1 ws1">the ser<span class="_ _0"></span>vices tha<span class="_ _3"></span>t it offers.</div><a class="l" href="#pfb0" data-dest-detail='[176,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:412.802000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb1" class="pf w2 h6" data-page-no="b1"><div class="pc pcb1 w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">162</div><div class="t m0 xc hd y145 ff48 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e slightly over 400 Linux service calls<span class="_ _0"></span>; covering all of these </div><div class="t m0 xd hd y146 ff48 fs7 fc3 sc0 ls1 ws1">is beyond the scope of this book, and more the topic for a book on </div><div class="t m0 xd hd y147 ff48 fs7 fc3 sc0 ls1 ws1">Linux System Pr<span class="_ _1"></span>ogramming. In this section, we cover the mechanisms </div><div class="t m0 xd hd y1b0 ff48 fs7 fc3 sc0 ls1 ws1">and conventions for c<span class="_ _3"></span>alling these ser<span class="_ _0"></span>vices and some examples<span class="_ _1"></span>, s<span class="_ _0"></span>o you </div><div class="t m0 xd hd y1b1 ff48 fs7 fc3 sc0 ls1 ws1">know how to go fr<span class="_ _3"></span>om the Linux documentation to writing code quickly. </div><div class="t m0 xd hd y1b2 ff48 fs7 fc3 sc0 ls1 ws1">Fortun<span class="_ _3"></span>ately, the Linux documenta<span class="_ _3"></span>tion for all these ser<span class="_ _0"></span>vices is quite good. </div><div class="t m0 xd hd y1b3 ff48 fs7 fc3 sc0 ls1 ws1">It is oriented en<span class="_ _3"></span>tirely to C pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>ammers, so any<span class="_ _3"></span>one else using it must know </div><div class="t m0 xd hd y1b4 ff48 fs7 fc3 sc0 ls1 ws1">enough C to convert the meaning to wh<span class="_ _3"></span>at is appr<span class="_ _3"></span>opriate for the language </div><div class="t m0 xd hd y1b5 ff48 fs7 fc3 sc0 ls1 ws1">they are using.</div><div class="t m0 xd h15 ybe2 ff4c fsb fc3 sc0 ls1 wsaf"> Calling <span class="_ _11"> </span>Convention</div><div class="t m0 xd hd y3ef ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve used two system calls: one to write AS<span class="_ _0"></span>CII data to the console and </div><div class="t m0 xd hd ybe3 ff48 fs7 fc3 sc0 ls1 ws1">the second to exit our program<span class="_ _3"></span>. The calling con<span class="_ _3"></span>vention for system c<span class="_ _3"></span>alls </div><div class="t m0 xd hd ybe4 ff48 fs7 fc3 sc0 ls1 ws1">is different fr<span class="_ _1"></span>om that for functions. I<span class="_ _1"></span>t us<span class="_ _0"></span>es a softwar<span class="_ _3"></span>e interrupt to switch </div><div class="t m0 xd hd ybe5 ff48 fs7 fc3 sc0 ls1 ws1">context fr<span class="_ _3"></span>om our user<span class="_ _1"></span>-level program to the con<span class="_ _3"></span>text of the Linux kernel.</div><div class="t m0 xc hd ybe6 ff48 fs7 fc3 sc0 ls1 ws1">The calling con<span class="_ _3"></span>vention is</div><div class="t m0 xc hd ybe7 ff48 fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ff4d ws1">X0<span class="ff48">–</span>X7<span class="ff48">: Input parameters<span class="_ _1"></span>, up to eight parameters for </span></span></div><div class="t m0 x1e hd ybe8 ff48 fs7 fc3 sc0 ls1 ws1">the system call.</div><div class="t m0 xc hd ybe9 ff48 fs7 fc3 sc0 ls1 wsad"> 2. <span class="_ _6"></span><span class="ff4d ws1">X8<span class="ff48">: The Linux system call number<span class="_ _10"></span>.</span></span></div><div class="t m0 xc hd ybea ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Call software in<span class="_ _3"></span>terrupt 0 with “<span class="ff4d ls14 wsb6">S<span class="_ _0"></span>VC 0</span><span class="ls2b wscd">”.</span></div><div class="t m0 xc hd ybeb ff48 fs7 fc3 sc0 ls1 wsad"> 4. <span class="_ _6"></span><span class="ff4d ws1">X0<span class="ff48">: The return code fr<span class="_ _3"></span>om the call.</span></span></div><div class="t m0 xc hd ybec ff48 fs7 fc3 sc0 ls1 wsa9">The software in<span class="_ _3"></span>terrupt is a clever way for us to call r<span class="_ _3"></span>outines in the Linux </div><div class="t m0 xd hd ybed ff48 fs7 fc3 sc0 ls1 ws1">kernel without knowing where they ar<span class="_ _1"></span>e stored in memor<span class="_ _0"></span>y. I<span class="_ _1"></span>t als<span class="_ _0"></span>o pr<span class="_ _3"></span>ovides </div><div class="t m0 xd hd ybee ff48 fs7 fc3 sc0 ls1 ws1">a mechanism to run at a higher security level while the call executes<span class="_ _3"></span>. Linux </div><div class="t m0 xd hd ybef ff48 fs7 fc3 sc0 ls1 ws1">will check if you ha<span class="_ _1"></span>ve the cor<span class="_ _0"></span>r<span class="_ _3"></span>ect access rights to perform the requested </div><div class="t m0 xd hd ybf0 ff48 fs7 fc3 sc0 ls1 ws1">operation and give bac<span class="_ _3"></span>k an error code like EACCES (13) if you are denied.</div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb2" class="pf w2 h6" data-page-no="b2"><div class="pc pcb2 w2 h6"><div class="t m0 x17 hd y3f ff48 fs7 fc3 sc0 ls1 ws1">163</div><div class="t m0 x1c hd y145 ff48 fs7 fc3 sc0 ls1 ws1">Although it doesn’t follow the function calling con<span class="_ _1"></span>vention from </div><div class="t m0 xc hd y146 ff48 fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">6</span>, “F<span class="_ _3"></span>unctions and the Stack<span class="_ _3"></span>,<span class="_ _8"></span>” the Linux system call mechanism </div><div class="t m0 xc hd y147 ff48 fs7 fc3 sc0 ls1 ws1">will preserve all registers not used as parameters or the r<span class="_ _3"></span>eturn code. When </div><div class="t m0 xc hd y1b0 ff48 fs7 fc3 sc0 ls1 ws1">system calls r<span class="_ _3"></span>equire a large block of par<span class="_ _1"></span>ameters, they tend to take a pointer </div><div class="t m0 xc hd y1b1 ff48 fs7 fc3 sc0 ls1 ws1">to a block of memory as one parameter<span class="_ _6"></span>, which then holds all the data they </div><div class="t m0 xc hd y218 ff48 fs7 fc3 sc0 ls1 ws1">need. Hence, mos<span class="_ _3"></span>t system calls don’t use that m<span class="_ _3"></span>any parameters<span class="_ _1"></span>.</div><div class="t m0 x1c hd y219 ff48 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we need to know where to get those magic Linux s<span class="_ _3"></span>ystem call </div><div class="t m0 xc hd y1b4 ff48 fs7 fc3 sc0 ls1 ws1">numbers<span class="_ _3"></span>, so we can call all those useful ser<span class="_ _0"></span>vices<span class="_ _3"></span>.</div><div class="t m0 xc ha y6b8 ff4c fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Linux System Call Numbers</div><div class="t m0 xc hd ybe2 ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e know 93 is the Linux system call number for exit and 64 is the num<span class="_ _3"></span>ber </div><div class="t m0 xc hd ybf1 ff48 fs7 fc3 sc0 ls1 ws1">for write to a file. These seem rather cryptic. Where do we look these up? </div><div class="t m0 xc hd ybf2 ff48 fs7 fc3 sc0 ls1 ws1">Can’t we use something symbolic in our pr<span class="_ _3"></span>ograms ra<span class="_ _3"></span>ther than these magic </div><div class="t m0 xc hd ybf3 ff48 fs7 fc3 sc0 ls1 ws1">numbers? The Linux sys<span class="_ _3"></span>tem call numbers ar<span class="_ _1"></span>e define<span class="_ _0"></span>d in the C include file:</div><div class="t m0 xc h18 ybf4 ff4f fs7 fc3 sc0 ls1 ws1">/usr/include/asm-generic/unistd.h</div><div class="t m0 x1c hd ybf5 ff48 fs7 fc3 sc0 ls1 ws1">In this file<span class="_ _3"></span>, there ar<span class="_ _3"></span>e define statements s<span class="_ _3"></span>uch as the following:</div><div class="t m0 xc h18 ybf6 ff4f fs7 fc3 sc0 ls1 ws1">#define __NR_write 64</div><div class="t m0 x1c hd ybf7 ff48 fs7 fc3 sc0 ls1 ws1">This defines the symbol __NR_write to repr<span class="_ _1"></span>es<span class="_ _0"></span>en<span class="_ _3"></span>t the magic number 64 </div><div class="t m0 xc hd ybf8 ff48 fs7 fc3 sc0 ls1 ws1">for the write Linux system call.</div><div class="t m0 x1c hd ybf9 ff48 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we need a similar method for the ser<span class="_ _0"></span>vice ret<span class="_ _3"></span>urn codes, so we </div><div class="t m0 xc hd ybfa ff48 fs7 fc3 sc0 ls1 ws1">know what wen<span class="_ _3"></span>t wrong if they fail.</div><div class="t m0 xc ha ya32 ff4c fs6 fc3 sc0 ls1 wsb1"> Return <span class="_ _14"> </span>Codes</div><div class="t m0 xc hd ya33 ff48 fs7 fc3 sc0 ls1 ws1">The return code for these functions is usually z<span class="_ _3"></span>ero or a positive num<span class="_ _3"></span>ber </div><div class="t m0 xc hd ya34 ff48 fs7 fc3 sc0 ls1 ws1">for success and a negative n<span class="_ _3"></span>umber for failure<span class="_ _1"></span>. The negative number is the </div><div class="t m0 xc hd ya35 ff48 fs7 fc3 sc0 ls1 ws1">negative of the err<span class="_ _3"></span>or codes from the C include file:</div><div class="t m0 xc h18 ybfb ff4f fs7 fc3 sc0 ls1 ws1">/usr/include/errno.h</div><div class="t m0 x47 h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:94.259700px;bottom:561.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb3" class="pf w2 h6" data-page-no="b3"><div class="pc pcb3 w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">164</div><div class="t m0 xc hd y145 ff48 fs7 fc3 sc0 ls1 ws1">This file includes several other files; the main ones that contain most of </div><div class="t m0 xd hd y146 ff48 fs7 fc3 sc0 ls1 ws1">the actual error codes ar<span class="_ _3"></span>e</div><div class="t m0 xd h18 y2e1 ff4f fs7 fc3 sc0 ls1 ws1">/usr/include/asm-generic/errno.h</div><div class="t m0 xd h18 y2d7 ff4f fs7 fc3 sc0 ls1 ws1">/usr/include/asm-generic/errno-base.h</div><div class="t m0 xc hd y567 ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll see how to use the constants from these files in our code when we </div><div class="t m0 xd hd y2d9 ff48 fs7 fc3 sc0 ls1 ws1">get to a sample progr<span class="_ _1"></span>am.</div><div class="t m0 xc hd y2da ff48 fs7 fc3 sc0 ls1 ws1">For exam<span class="_ _3"></span>ple, the open call to open a file r<span class="_ _1"></span>eturns a file descr<span class="_ _0"></span>iptor if it </div><div class="t m0 xd hd y231 ff48 fs7 fc3 sc0 ls1 ws1">is successful. A file descriptor is a small positive number<span class="_ _10"></span>, then a negative </div><div class="t m0 xd hd y2e3 ff48 fs7 fc3 sc0 ls1 ws1">number if it fails<span class="_ _3"></span>, where it is the nega<span class="_ _3"></span>tive of one of the constants in errno<span class="_ _1"></span>.h.</div><div class="t m0 xc hd y2e4 ff48 fs7 fc3 sc0 ls1 ws1">If you’<span class="_ _3"></span>ve progr<span class="_ _1"></span>amme<span class="_ _0"></span>d in C, you know man<span class="_ _3"></span>y of the C runtime functions </div><div class="t m0 xd hd y2e5 ff48 fs7 fc3 sc0 ls1 ws1">take structures as par<span class="_ _1"></span>ameters. The Linux service calls are the same and </div><div class="t m0 xd hd yb30 ff48 fs7 fc3 sc0 ls1 ws1">we’ll look at dealing with these next.</div><div class="t m0 xd ha y2b0 ff4c fs6 fc3 sc0 ls1 wsb1"> Structures</div><div class="t m0 xd hd ybfc ff48 fs7 fc3 sc0 ls1 ws1">Man<span class="_ _3"></span>y Linux services take pointers to blocks of memor<span class="_ _0"></span>y as their </div><div class="t m0 xd hd ybfd ff48 fs7 fc3 sc0 ls1 ws1">parameters<span class="_ _1"></span>. The contents of these blocks of memor<span class="_ _0"></span>y ar<span class="_ _1"></span>e do<span class="_ _0"></span>cument<span class="_ _3"></span>ed with </div><div class="t m0 xd hd ybfe ff48 fs7 fc3 sc0 ls1 ws1">C structures<span class="_ _1"></span>, s<span class="_ _0"></span>o as Assembly pr<span class="_ _1"></span>ogrammers, we must r<span class="_ _3"></span>everse engineer the </div><div class="t m0 xd hd ybff ff48 fs7 fc3 sc0 ls1 ws1">C and duplicate the memory structure. F<span class="_ _1"></span>or instance, the nanosleep service </div><div class="t m0 xd hd yc00 ff48 fs7 fc3 sc0 ls1 ws1">lets the progr<span class="_ _3"></span>am sleep for several nanoseconds; it is define<span class="_ _0"></span>d as</div><div class="t m0 xd h18 yc01 ff4f fs7 fc3 sc0 ls12 ws1">int nanosleep(const struct timespec *req, struct timespec *rem);</div><div class="t m0 xc hd yc02 ff48 fs7 fc3 sc0 ls1 ws1">and then the struct timespec is defined as</div><div class="t m0 xd h18 yc03 ff4f fs7 fc3 sc0 ls1 ws1">   struct timespec {</div><div class="t m0 xd h18 yc04 ff4f fs7 fc3 sc0 ls1 ws1">               time_t tv_sec;      /* seconds */</div><div class="t m0 xd h18 yc05 ff4f fs7 fc3 sc0 ls1 ws1">               long   tv_nsec;     /* nanoseconds */</div><div class="t m0 xd h18 yc06 ff4f fs7 fc3 sc0 ls1 ws1">           };</div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb4" class="pf w2 h6" data-page-no="b4"><div class="pc pcb4 w2 h6"><div class="t m0 x17 hd y3f ff48 fs7 fc3 sc0 ls1 ws1">165</div><div class="t m0 x1c hd y145 ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e then must figure out th<span class="_ _3"></span>at these ar<span class="_ _3"></span>e two 64-bit integers, then define </div><div class="t m0 xc hd y146 ff48 fs7 fc3 sc0 ls1 ws1">in Assembly</div><div class="t m0 xc h18 y2e1 ff4f fs7 fc3 sc0 ls1 ws1">timespecsec:   .dword   0</div><div class="t m0 xc h18 y2d7 ff4f fs7 fc3 sc0 ls1 ws1">timespecnano:  .dword   100000000</div><div class="t m0 x1c hd y567 ff48 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o use them, we load their address into the r<span class="_ _1"></span>egisters for the first two </div><div class="t m0 xc hd y2d9 ff48 fs7 fc3 sc0 ls1 ws1">parameters:</div><div class="t m0 xc h18 yc07 ff4f fs7 fc3 sc0 ls1 ws1">        ldr         X0, =timespecsec</div><div class="t m0 xc h18 y2db ff4f fs7 fc3 sc0 ls1 ws1">        ldr         X1, =timespecsec</div><div class="t m0 x1c hd y2dc ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll be using the nanosleep function in Chapter <span class="fc5">8</span>, “Pr<span class="_ _1"></span>ogramming </div><div class="t m0 xc hd y2dd ff48 fs7 fc3 sc0 ls1 ws1">GPIO Pins,<span class="_ _8"></span>” but this is typical of wh<span class="_ _3"></span>at it takes to dir<span class="_ _1"></span>e<span class="_ _0"></span>ctly call some Linux </div><div class="t m0 xc hd y2de ff48 fs7 fc3 sc0 ls1 ws1">ser<span class="_ _0"></span>vices<span class="_ _3"></span>.</div><div class="t m0 x1c hd y54e ff48 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we need to decide how to make these calls easier to use<span class="_ _3"></span>. Do we </div><div class="t m0 xc hd y54f ff48 fs7 fc3 sc0 ls1 ws1">wrap them in Assembly functions or use another method?</div><div class="t m0 xc h15 yc08 ff4c fsb fc3 sc0 ls1 wsaf"> Wrappers</div><div class="t m0 xc hd y887 ff48 fs7 fc3 sc0 ls1 ws1">Rather than fig<span class="_ _3"></span>ure out all the r<span class="_ _1"></span>egisters each time we want to call a Linux </div><div class="t m0 xc hd yc09 ff48 fs7 fc3 sc0 ls1 ws1">ser<span class="_ _0"></span>vice<span class="_ _3"></span>, we will develop a library of routines or macr<span class="_ _3"></span>os to make our job </div><div class="t m0 xc hd yc0a ff48 fs7 fc3 sc0 ls1 ws1">easier<span class="_ _6"></span>. The C progr<span class="_ _1"></span>amming language includes function call wrappers </div><div class="t m0 xc hd yc0b ff48 fs7 fc3 sc0 ls1 ws1">for all the Linux ser<span class="_ _0"></span>vices; we w<span class="_ _0"></span>ill see how to use these in Chapter <span class="fc5">9</span>, </div><div class="t m0 xc hd yc0c ff48 fs7 fc3 sc0 ls1 ws1">“Inter<span class="_ _3"></span>acting with C and Python.<span class="_ _8"></span>”</div><div class="t m0 x1c hd ybeb ff48 fs7 fc3 sc0 ls1 ws1">Rather than duplica<span class="_ _3"></span>te the work of the C runtime library by developing </div><div class="t m0 xc hd yc0d ff48 fs7 fc3 sc0 ls1 ws1">wrapper functions<span class="_ _1"></span>, w<span class="_ _0"></span>e<span class="_ _3"></span>’ll develop a library of Linux system calls using the </div><div class="t m0 xc hd yc0e ff48 fs7 fc3 sc0 ls1 ws1">GNU Assembler’<span class="_ _1"></span>s macro function<span class="_ _3"></span>ality. W<span class="_ _1"></span>e won’t develop this for all the </div><div class="t m0 xc hd yc0f ff48 fs7 fc3 sc0 ls1 ws1">functions, j<span class="_ _3"></span>ust the functions we need. Most progr<span class="_ _1"></span>ammers do this<span class="_ _0"></span>; then </div><div class="t m0 xc hd yc10 ff48 fs7 fc3 sc0 ls1 ws1">over time their libr<span class="_ _3"></span>aries become quite extensive.</div><div class="t m0 x1c hd yc11 ff48 fs7 fc3 sc0 ls1 ws1">A problem with macr<span class="_ _1"></span>os is that you often need several variants with </div><div class="t m0 xc hd yc12 ff48 fs7 fc3 sc0 ls1 ws1">different p<span class="_ _3"></span>arameter types<span class="_ _3"></span>. For ins<span class="_ _3"></span>tance, sometimes you migh<span class="_ _3"></span>t like to </div><div class="t m0 xc hd yc13 ff48 fs7 fc3 sc0 ls1 ws1">call the macr<span class="_ _3"></span>o with a register as a par<span class="_ _3"></span>ameter and other times with an </div><div class="t m0 xc hd yc14 ff48 fs7 fc3 sc0 ls1 ws1">immediate value<span class="_ _3"></span>.</div><div class="t m0 x47 h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:301.908000px;bottom:417.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:356.913000px;bottom:241.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb5" class="pf w2 h6" data-page-no="b5"><div class="pc pcb5 w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">166</div><div class="t m0 xc hd y145 ff48 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w that we understand the theory of using Linux ser<span class="_ _0"></span>vices<span class="_ _3"></span>, let’<span class="_ _6"></span>s lo<span class="_ _0"></span>ok at </div><div class="t m0 xd hd y146 ff48 fs7 fc3 sc0 ls1 ws1">a complete progr<span class="_ _3"></span>am that uses a collection of these<span class="_ _3"></span>.</div><div class="t m0 xd h15 y50d ff4c fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Converting aFile toUpper<span class="_ _6"></span>-Case</div><div class="t m0 xd hd y50e ff48 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we present a complete pr<span class="_ _3"></span>ogram to con<span class="_ _3"></span>vert the contents of a </div><div class="t m0 xd hd yc15 ff48 fs7 fc3 sc0 ls1 ws1">text file to all upper<span class="_ _1"></span>-case. W<span class="_ _1"></span>e will use our toupper function from Chapter <span class="fc5">6</span>, </div><div class="t m0 xd hd yc16 ff48 fs7 fc3 sc0 ls1 ws1">“Functions and the S<span class="_ _3"></span>tack,<span class="_ _8"></span>” and get practice coding loops and if sta<span class="_ _3"></span>tements<span class="_ _3"></span>.</div><div class="t m0 xc hd yc17 ff48 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o start with, we need a librar<span class="_ _0"></span>y of file I/O r<span class="_ _3"></span>outines to read fr<span class="_ _1"></span>om our </div><div class="t m0 xd hd y393 ff48 fs7 fc3 sc0 ls1 ws1">input file<span class="_ _3"></span>, then write the upper<span class="_ _1"></span>-case version to another file. If you’<span class="_ _3"></span>ve </div><div class="t m0 xd hd yc18 ff48 fs7 fc3 sc0 ls1 ws1">done any C progr<span class="_ _3"></span>amming, these should look familiar<span class="_ _10"></span>, since the C runtime </div><div class="t m0 xd hd yc19 ff48 fs7 fc3 sc0 ls1 ws1">pro<span class="_ _3"></span>vides a thin layer o<span class="_ _1"></span>ver these s<span class="_ _0"></span>ervices. W<span class="_ _1"></span>e create a file <span class="ff4d">fileio<span class="_ _3"></span>.S<span class="ff48"> containing </span></span></div><div class="t m0 xd hd yc1a ff48 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">7-1</span>. Note the file ex<span class="_ _3"></span>tension is a capital S; this is important as this </div><div class="t m0 xd hd yc1b ff48 fs7 fc3 sc0 ls1 ws1">allows us to use C include files as we’ll discuss shortly.</div><div class="t m0 xd h20 y9a7 ff50 fs3 fc3 sc0 ls1 ws1">Listing 7-1. <span class="_ _15"> </span><span class="ff48">Macr<span class="_ _1"></span>os to help us read and write files</span></div><div class="t m0 xd h18 y9a8 ff4f fs7 fc3 sc0 ls1 ws1">// Various macros to perform file I/O</div><div class="t m0 xd h18 y9a9 ff4f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y9aa ff4f fs7 fc3 sc0 ls1 ws1">// The fd parameter needs to be a register.</div><div class="t m0 xd h18 y9ab ff4f fs7 fc3 sc0 ls1 ws1">// Uses X0, X1, X8.</div><div class="t m0 xd h18 y9ac ff4f fs7 fc3 sc0 ls1 ws1">// Return code is in X0.</div><div class="t m0 xd h18 yc1c ff4f fs7 fc3 sc0 ls1 ws1">#include &lt;asm/unistd.h&gt;</div><div class="t m0 xd h18 yc1d ff4f fs7 fc3 sc0 ls1 ws1">.equ  O_RDONLY, 0</div><div class="t m0 xd h18 yc1e ff4f fs7 fc3 sc0 ls1 ws1">.equ  O_WRONLY, 1</div><div class="t m0 xd h18 y9b0 ff4f fs7 fc3 sc0 ls1 ws1">.equ  O_CREAT,  0100</div><div class="t m0 xd h18 y9b1 ff4f fs7 fc3 sc0 ls1 ws1">.equ  O_EXCL,   0200</div><div class="t m0 xd h18 y9b2 ff4f fs7 fc3 sc0 ls1 ws1">.equ  S_RDWR,   0666</div><div class="t m0 xd h18 y9b3 ff4f fs7 fc3 sc0 ls1 ws1">.equ  AT_FDCWD, -100</div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:375.236000px;bottom:473.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb5" data-dest-detail='[181,"XYZ",35,348,null]'><div class="d m1" style="border-style:none;position:absolute;left:70.055400px;bottom:377.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb6" class="pf w2 h6" data-page-no="b6"><div class="pc pcb6 w2 h6"><div class="t m0 x17 hd y3f ff48 fs7 fc3 sc0 ls1 ws1">167</div><div class="t m0 xc h18 y46b ff4f fs7 fc3 sc0 ls1 ws1">.macro  openFile    fileName, flags</div><div class="t m0 xc h18 y46c ff4f fs7 fc3 sc0 ls1 ws1">      mov         X0, #AT_FDCWD</div><div class="t m0 xc h18 y46d ff4f fs7 fc3 sc0 ls1 ws1">      ldr         X1, =\fileName</div><div class="t m0 xc h18 y623 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X2, #\flags</div><div class="t m0 xc h18 y624 ff4f fs7 fc3 sc0 ls1 ws1">      mov       X3, #S_RDWR          // RW access rights</div><div class="t m0 xc h18 y625 ff4f fs7 fc3 sc0 ls1 ws1">      mov       X8, #__NR_openat</div><div class="t m0 xc h18 y626 ff4f fs7 fc3 sc0 ls1 ws1">      svc         0</div><div class="t m0 xc h18 y627 ff4f fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xc h18 y628 ff4f fs7 fc3 sc0 ls1 ws1">.macro  readFile   fd, buffer, length</div><div class="t m0 xc h18 y9f6 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X0, \fd      // file descriptor</div><div class="t m0 xc h18 y9f7 ff4f fs7 fc3 sc0 ls1 ws1">      ldr         X1, =\buffer</div><div class="t m0 xc h18 y9f8 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X2, #\length</div><div class="t m0 xc h18 yb8d ff4f fs7 fc3 sc0 ls1 ws1">      mov         X8, #__NR_read</div><div class="t m0 xc h18 yb8e ff4f fs7 fc3 sc0 ls1 ws1">      svc         0</div><div class="t m0 xc h18 yb8f ff4f fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xc h18 yb90 ff4f fs7 fc3 sc0 ls1 ws1">.macro  writeFile   fd, buffer, length</div><div class="t m0 xc h18 yb91 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X0, \fd      // file descriptor</div><div class="t m0 xc h18 yc1f ff4f fs7 fc3 sc0 ls1 ws1">      ldr         X1, =\buffer</div><div class="t m0 xc h18 yc20 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X2, \length</div><div class="t m0 xc h18 yc21 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X8, #__NR_write</div><div class="t m0 xc h18 yc22 ff4f fs7 fc3 sc0 ls1 ws1">      svc         0</div><div class="t m0 xc h18 yc23 ff4f fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xc h18 yc24 ff4f fs7 fc3 sc0 ls1 ws1">.macro  flushClose  fd</div><div class="t m0 xc h18 yc25 ff4f fs7 fc3 sc0 ls1 ws1">//fsync syscall</div><div class="t m0 xc h18 yc26 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X0, \fd</div><div class="t m0 xc h18 yc27 ff4f fs7 fc3 sc0 ls1 ws1">      mov         X8, #__NR_fsync</div><div class="t m0 xc h18 yc28 ff4f fs7 fc3 sc0 ls1 ws1">      svc         0</div><div class="t m0 xc h18 yc29 ff4f fs7 fc3 sc0 ls1 ws1">//close syscall</div><div class="t m0 xc h18 yc2a ff4f fs7 fc3 sc0 ls1 ws1">      mov         X0, \fd</div><div class="t m0 xc h18 yc2b ff4f fs7 fc3 sc0 ls1 ws1">      mov         X8, #__NR_close</div><div class="t m0 xc h18 yc2c ff4f fs7 fc3 sc0 ls1 ws1">      svc         0</div><div class="t m0 xc h18 yc2d ff4f fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 x47 h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb7" class="pf w2 h6" data-page-no="b7"><div class="pc pcb7 w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">168</div><div class="t m0 xc hd y145 ff48 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we need a main program to or<span class="_ _1"></span>chestrate the process<span class="_ _1"></span>. W<span class="_ _3"></span>e’ll call this </div><div class="t m0 xd hd y146 ff48 fs7 fc3 sc0 ls1 ws1">main.S<span class="_ _1"></span>, again with the capital S file extension, containing the conten<span class="_ _3"></span>ts of </div><div class="t m0 xd hd y147 ff48 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">7-2</span>.</div><div class="t m0 xd h20 ya37 ff50 fs3 fc3 sc0 ls1 ws1">Listing 7-2. <span class="_ _15"> </span><span class="ff48">Main pr<span class="_ _1"></span>ogram for case conversion pr<span class="_ _1"></span>ogram</span></div><div class="t m0 xd h18 ya38 ff4f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 ya39 ff4f fs7 fc3 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xd h18 ya3a ff4f fs7 fc3 sc0 ls1 ws1">// all upper case by calling a function.</div><div class="t m0 xd h18 ya3b ff4f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 ya3c ff4f fs7 fc3 sc0 ls1 ws1">// X0-X2, X8 - used by macros to call linux</div><div class="t m0 xd h18 yc2e ff4f fs7 fc3 sc0 ls1 ws1">// X11 - input file descriptor</div><div class="t m0 xd h18 yc2f ff4f fs7 fc3 sc0 ls1 ws1">// X9 - output file descriptor</div><div class="t m0 xd h18 yc30 ff4f fs7 fc3 sc0 ls1 ws1">// X10 - number of characters read</div><div class="t m0 xd h18 yc31 ff4f fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yc32 ff4f fs7 fc3 sc0 ls1 ws1">#include &lt;asm/unistd.h&gt;</div><div class="t m0 xd h18 yc33 ff4f fs7 fc3 sc0 ls1 ws1">#include &quot;fileio.S&quot;</div><div class="t m0 xd h18 yc34 ff4f fs7 fc3 sc0 ls1 ws1">.equ  BUFFERLEN, 250</div><div class="t m0 xd h18 yc35 ff4f fs7 fc3 sc0 ls1 ws1">.global _start                    //  <span class="_ _20"></span>Provide program starting </div><div class="t m0 x48 h18 yc36 ff4f fs7 fc3 sc0 ls1 ws1">address to linker</div><div class="t m0 xd h18 yc37 ff4f fs7 fc3 sc0 ls1 ws1">_start: openFile       inFile, O_RDONLY</div><div class="t m0 xd h18 yc38 ff4f fs7 fc3 sc0 ls1 ws1">       ADDS            X11, XZR, X0 // save file descriptor</div><div class="t m0 xd h18 yc39 ff4f fs7 fc3 sc0 ls1 ws1">       B.PL            nxtfil  // pos number file opened ok</div><div class="t m0 xd h18 yc3a ff4f fs7 fc3 sc0 ls1 ws1">       MOV             X1, #1  // stdout</div><div class="t m0 xd h18 yc3b ff4f fs7 fc3 sc0 ls1 ws1">       LDR             X2, =inpErrsz // Error msg</div><div class="t m0 xd h18 yc3c ff4f fs7 fc3 sc0 ls1 ws1">       LDR             W2, [X2]</div><div class="t m0 xd h18 yc3d ff4f fs7 fc3 sc0 ls1 ws1">       writeFile       X1, inpErr, X2 // print the error</div><div class="t m0 xd h18 yc3e ff4f fs7 fc3 sc0 ls1 ws1">       B               exit</div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pfb7" data-dest-detail='[183,"XYZ",35,532,null]'><div class="d m1" style="border-style:none;position:absolute;left:70.055400px;bottom:545.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb8" class="pf w2 h6" data-page-no="b8"><div class="pc pcb8 w2 h6"><div class="t m0 x17 hd y3f ff48 fs7 fc3 sc0 ls1 ws1">169</div><div class="t m0 xc h18 y46b ff4f fs7 fc3 sc0 ls1 ws1">nxtfil: openFile       outFile, O_CREAT+O_WRONLY</div><div class="t m0 xc h18 y46c ff4f fs7 fc3 sc0 ls1 ws1">       ADDS            X9, XZR, X0   // save file descriptor</div><div class="t m0 xc h18 y46d ff4f fs7 fc3 sc0 ls1 ws1">       B.PL            loop    // pos number file opened ok</div><div class="t m0 xc h18 y623 ff4f fs7 fc3 sc0 ls1 ws1">       MOV             X1, #1</div><div class="t m0 xc h18 y624 ff4f fs7 fc3 sc0 ls1 ws1">       LDR             X2, =outErrsz</div><div class="t m0 xc h18 y625 ff4f fs7 fc3 sc0 ls1 ws1">       LDR             W2, [X2]</div><div class="t m0 xc h18 y626 ff4f fs7 fc3 sc0 ls1 ws1">       writeFile       X1, outErr, X2</div><div class="t m0 xc h18 y627 ff4f fs7 fc3 sc0 ls1 ws1">       B               exit</div><div class="t m0 xc h18 y85f ff4f fs7 fc3 sc0 ls1 ws1">// loop through file until done.</div><div class="t m0 xc h18 y629 ff4f fs7 fc3 sc0 ls1 ws1">loop:  readFile        X11, buffer, BUFFERLEN</div><div class="t m0 xc h18 y62a ff4f fs7 fc3 sc0 ls1 ws1">       MOV             X10, X0       // Keep the length read</div><div class="t m0 xc h18 y62b ff4f fs7 fc3 sc0 ls1 ws1">       MOV             X1, #0        //  <span class="_ _20"></span>Null terminator for </div><div class="t m0 x49 h18 y9f9 ff4f fs7 fc3 sc0 ls1 ws1">string</div><div class="t m0 xc h18 y860 ff4f fs7 fc3 sc0 ls1 ws1">       // setup call to toupper and call function</div><div class="t m0 xc h18 y861 ff4f fs7 fc3 sc0 ls1 ws1">       LDR             X0, =buffer   // first param for toupper</div><div class="t m0 xc h18 yc3f ff4f fs7 fc3 sc0 ls1 ws1">       STRB            W1, [X0, X10] //  <span class="_ _20"></span>put null at end of </div><div class="t m0 x49 h18 yc40 ff4f fs7 fc3 sc0 ls1 ws1">string.</div><div class="t m0 xc h18 yc41 ff4f fs7 fc3 sc0 ls1 ws1">       LDR             X1, =outBuf</div><div class="t m0 xc h18 yc42 ff4f fs7 fc3 sc0 ls1 ws1">       BL              toupper</div><div class="t m0 xc h18 y852 ff4f fs7 fc3 sc0 ls1 ws1">       writeFile       X9, outBuf, X10</div><div class="t m0 xc h18 yc43 ff4f fs7 fc3 sc0 ls1 ws1">       CMP             X10, #BUFFERLEN</div><div class="t m0 xc h18 yc44 ff4f fs7 fc3 sc0 ls1 ws1">       B.EQ            loop</div><div class="t m0 xc h18 y867 ff4f fs7 fc3 sc0 ls1 ws1">       flushClose      X11</div><div class="t m0 xc h18 y868 ff4f fs7 fc3 sc0 ls1 ws1">       flushClose      X9</div><div class="t m0 xc h18 y869 ff4f fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xc h18 y86a ff4f fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 y86b ff4f fs7 fc3 sc0 ls1 ws1">exit:  MOV     X0, #0      // Use 0 return code</div><div class="t m0 xc h18 ya1b ff4f fs7 fc3 sc0 ls1 ws1">       MOV     X8, #__NR_exit</div><div class="t m0 xc h18 yc45 ff4f fs7 fc3 sc0 ls1 ws1">       SVC     0           // Call Linux to terminate</div><div class="t m0 x47 h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfb9" class="pf w2 h6" data-page-no="b9"><div class="pc pcb9 w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">170</div><div class="t m0 xd h18 y46b ff4f fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y46c ff4f fs7 fc3 sc0 ls1 ws1">inFile:  .asciz  &quot;main.S&quot;</div><div class="t m0 xd h18 y46d ff4f fs7 fc3 sc0 ls1 ws1">outFile: .asciz      &quot;upper.txt&quot;</div><div class="t m0 xd h18 y623 ff4f fs7 fc3 sc0 ls1 ws1">buffer:      .fill  BUFFERLEN + 1, 1, 0</div><div class="t m0 xd h18 y624 ff4f fs7 fc3 sc0 ls1 ws1">outBuf:      .fill  BUFFERLEN + 1, 1, 0</div><div class="t m0 xd h18 yc46 ff4f fs7 fc3 sc0 ls1 ws1">inpErr: .asciz      &quot;Failed to open input file.\n&quot;</div><div class="t m0 xd h18 y626 ff4f fs7 fc3 sc0 ls1 ws1">inpErrsz: .word  .-inpErr</div><div class="t m0 xd h18 y627 ff4f fs7 fc3 sc0 ls1 ws1">outErr: .asciz      &quot;Failed to open output file.\n&quot;</div><div class="t m0 xd h18 yc47 ff4f fs7 fc3 sc0 ls1 ws1">outErrsz: .word     .-outErr</div><div class="t m0 xc hd yb7b ff48 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o build these source files<span class="_ _3"></span>, we add a new rule to our makefile, to b<span class="_ _3"></span>uild </div><div class="t m0 xd hd y62a ff48 fs7 fc3 sc0 ls1 ws1">.S files with <span class="ff4d ls7 ws6f">gcc</span> rather th<span class="_ _3"></span>an <span class="ff4d">as</span>, as shown in the next section.</div><div class="t m0 xd ha yc48 ff4c fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Building .S Files</div><div class="t m0 xd hd y477 ff48 fs7 fc3 sc0 ls1 ws1">The makefile is con<span class="_ _3"></span>tained in Listing <span class="fc5">7-3</span>.</div><div class="t m0 xd h20 y988 ff50 fs3 fc3 sc0 ls1 ws1">Listing 7-3. <span class="_ _15"> </span><span class="ff48">Mak<span class="_ _3"></span>efile for our file conv<span class="_ _3"></span>ersion progr<span class="_ _3"></span>am</span></div><div class="t m0 xd h18 y989 ff4f fs7 fc3 sc0 ls1 ws1">UPPEROBJS = main.o upper.o</div><div class="t m0 xd h18 yc49 ff4f fs7 fc3 sc0 ls1 ws1">ifdef DEBUG</div><div class="t m0 xd h18 yc4a ff4f fs7 fc3 sc0 ls1 ws1">DEBUGFLGS = -g</div><div class="t m0 xd h18 yc4b ff4f fs7 fc3 sc0 ls1 ws1">else</div><div class="t m0 xd h18 yc4c ff4f fs7 fc3 sc0 ls1 ws1">DEBUGFLGS =</div><div class="t m0 xd h18 yc4d ff4f fs7 fc3 sc0 ls1 ws1">endif</div><div class="t m0 xd h18 yc4e ff4f fs7 fc3 sc0 ls1 ws1">all: upper</div><div class="t m0 xd h18 yc4f ff4f fs7 fc3 sc0 ls1 ws1">%.o : %.S</div><div class="t m0 xd h18 yc50 ff4f fs7 fc3 sc0 ls1 ws1">      gcc $(DEBUGFLGS) -c $&lt; -o $@</div><div class="t m0 xd h18 yc51 ff4f fs7 fc3 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xd h18 yc52 ff4f fs7 fc3 sc0 ls1 ws1">      as $(DEBUGFLGS) $&lt; -o $@</div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pfb9" data-dest-detail='[185,"XYZ",35,331,null]'><div class="d m1" style="border-style:none;position:absolute;left:204.275000px;bottom:345.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfba" class="pf w2 h6" data-page-no="ba"><div class="pc pcba w2 h6"><div class="t m0 x17 hd y3f ff48 fs7 fc3 sc0 ls1 ws1">171</div><div class="t m0 xc h18 y46b ff4f fs7 fc3 sc0 ls1 ws1">upper: $(UPPEROBJS)</div><div class="t m0 xc h18 y46c ff4f fs7 fc3 sc0 ls1 ws1">      ld -o upper $(UPPEROBJS)</div><div class="t m0 x1c hd ya17 ff48 fs7 fc3 sc0 ls1 ws1">This progr<span class="_ _3"></span>am uses the upper<span class="_ _6"></span>.s file from Cha<span class="_ _3"></span>pter <span class="fc5">6</span>, “Functions and the </div><div class="t m0 xc hd y46e ff48 fs7 fc3 sc0 ls1 ws1">Stack,<span class="_ _8"></span>” tha<span class="_ _3"></span>t contains the function version of our upper<span class="_ _1"></span>-case logic.</div><div class="t m0 x1c hd y46f ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e added a rule to compile our two .S files w<span class="_ _0"></span>ith <span class="ff4d ls7 ws6f">gcc</span> r<span class="_ _3"></span>ather than <span class="ff4d">as</span>. </div><div class="t m0 xc hd y85d ff48 fs7 fc3 sc0 ls1 ws1">Most people think of gcc as the GNU C compiler<span class="_ _10"></span>, but it actually stands for </div><div class="t m0 xc hd y983 ff48 fs7 fc3 sc0 ls1 ws1">the GNU Compiler Collection and is capable of compilin<span class="_ _3"></span>g several other </div><div class="t m0 xc hd y984 ff48 fs7 fc3 sc0 ls1 ws1">languages in addition to C including Assembly Lan<span class="_ _3"></span>guage. T<span class="_ _3"></span>he clever trick </div><div class="t m0 xc hd yb7a ff48 fs7 fc3 sc0 ls1 ws1">that gcc supports when we do this is the ability to add C prepr<span class="_ _1"></span>ocessor </div><div class="t m0 xc hd yb7b ff48 fs7 fc3 sc0 ls1 ws1">commands to our Assembly code<span class="_ _3"></span>.</div><div class="t m0 x1c hd y62a ff48 fs7 fc3 sc0 ls1 ws1">When we compile a .S (the capital is important) file with <span class="ff4d ls7 ws6f">gcc</span>, it will </div><div class="t m0 xc hd y62b ff48 fs7 fc3 sc0 ls1 ws1">process all C #include and #define dir<span class="_ _1"></span>e<span class="_ _0"></span>ctives befor<span class="_ _3"></span>e processin<span class="_ _3"></span>g the </div><div class="t m0 xc hd y9f9 ff48 fs7 fc3 sc0 ls1 ws1">Assembly instructions and directives<span class="_ _1"></span>. This means we can include standard </div><div class="t m0 xc hd yc53 ff48 fs7 fc3 sc0 ls1 ws1">C include files for their symbols<span class="_ _3"></span>, as long as the files don’t contain any C </div><div class="t m0 xc hd yc54 ff48 fs7 fc3 sc0 ls1 ws1">code or conditionally exclude the C code when pr<span class="_ _3"></span>ocessed by the GNU </div><div class="t m0 xc hd yc55 ff48 fs7 fc3 sc0 ls1 ws1">Assembler<span class="_ _6"></span>.</div><div class="t m0 x1c hd yc56 ff48 fs7 fc3 sc0 ls1 ws1">The Linux kernel consists of both C and Assembly Lang<span class="_ _3"></span>uage code. F<span class="_ _1"></span>or </div><div class="t m0 xc hd y9fe ff48 fs7 fc3 sc0 ls1 ws1">the definition of constants tha<span class="_ _3"></span>t are used by both code bases<span class="_ _3"></span>, they don’t </div><div class="t m0 xc hd y9ff ff48 fs7 fc3 sc0 ls1 ws1">want to mak<span class="_ _3"></span>e the definitions in two places and risk errors from differ<span class="_ _3"></span>ences. </div><div class="t m0 xc hd yc57 ff48 fs7 fc3 sc0 ls1 ws1">Thus<span class="_ _3"></span>, all the Assembly Language code in the Linux kernel ar<span class="_ _1"></span>e in .S files and </div><div class="t m0 xc hd yc58 ff48 fs7 fc3 sc0 ls1 ws1">use various C include files including <span class="ff4d">unistd.h</span>.</div><div class="t m0 x1c hd yc59 ff48 fs7 fc3 sc0 ls1 ws1">Using this technique<span class="_ _3"></span>, our Linux function numbers ar<span class="_ _1"></span>e no longer magic </div><div class="t m0 xc hd yc5a ff48 fs7 fc3 sc0 ls1 ws1">numbers and will be correct and re<span class="_ _3"></span>adable.</div><div class="t m0 x1c hd yc5b ff48 fs7 fc3 sc0 ls1 ws1">When we process a .s (lower<span class="_ _1"></span>-case) file with <span class="ff4d ls7 ws6f">gcc</span>, it assumes we want </div><div class="t m0 xc hd yc5c ff48 fs7 fc3 sc0 ls1 ws1">pure Assembl<span class="_ _3"></span>y code and won’t run things through the C pr<span class="_ _3"></span>eprocessor first.</div><div class="t m0 x1c hd yc5d ff48 fs7 fc3 sc0 ls1 ws1">If you build this pr<span class="_ _3"></span>ogram<span class="_ _3"></span>, notice that it is only 3KB in size<span class="_ _1"></span>. This is one </div><div class="t m0 xc hd yc5e ff48 fs7 fc3 sc0 ls1 ws1">of the appeals of pure As<span class="_ _3"></span>sembly Language pr<span class="_ _3"></span>ogramming. T<span class="_ _3"></span>here is nothing </div><div class="t m0 xc hd yc5f ff48 fs7 fc3 sc0 ls1 ws1">extra added to the pr<span class="_ _3"></span>ogram—we contr<span class="_ _1"></span>ol ever<span class="_ _0"></span>y byte—no mys<span class="_ _3"></span>terious </div><div class="t m0 xc hd yc60 ff48 fs7 fc3 sc0 ls1 ws1">libraries or runtimes added.</div><div class="t m0 x1c hd yc61 ff48 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, let’<span class="_ _6"></span>s look at the details of opening a file.</div><div class="t m0 x47 h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:296.584000px;bottom:537.186000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfbb" class="pf w2 h6" data-page-no="bb"><div class="pc pcbb w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">172</div><div class="t m0 xd ha y248 ff4c fs6 fc3 sc0 ls1 wsb1"> Opening <span class="_ _14"> </span>aFile</div><div class="t m0 xd hd y249 ff48 fs7 fc3 sc0 ls1 ws1">The Linux <span class="ff4d">openat</span> ser<span class="_ _0"></span>vice is typical of a Linux sys<span class="_ _3"></span>tem ser<span class="_ _0"></span>vice<span class="_ _3"></span>. It tak<span class="_ _3"></span>es four </div><div class="t m0 xd hd y24a ff48 fs7 fc3 sc0 ls1 ws1">parameters:</div><div class="t m0 xc hd y300 ff48 fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ff4d ws1">Director<span class="_ _0"></span>y File Des<span class="_ _0"></span>criptor<span class="ff48">: File descriptor to the </span></span></div><div class="t m0 x1e hd y301 ff48 fs7 fc3 sc0 ls1 ws1">folder that filename is open r<span class="_ _1"></span>elative to<span class="_ _3"></span>. If this is the </div><div class="t m0 x1e hd y302 ff48 fs7 fc3 sc0 ls1 ws1">magic num<span class="_ _3"></span>ber A<span class="_ _1"></span>T_FDC<span class="_ _0"></span>WD<span class="_ _1"></span>, then it means open </div><div class="t m0 x1e hd y303 ff48 fs7 fc3 sc0 ls1 ws1">rela<span class="_ _3"></span>tive to the current folder<span class="_ _10"></span>.</div><div class="t m0 xc hd yc62 ff48 fs7 fc3 sc0 ls1 wsad"> 2. <span class="_ _6"></span><span class="ff4d ws1">Filename<span class="ff48">: The file to open as a NULL-terminated </span></span></div><div class="t m0 x1e hd y29c ff48 fs7 fc3 sc0 lsb wsb4">string.</div><div class="t m0 xc hd yc63 ff48 fs7 fc3 sc0 ls1 wsad"> 3. <span class="_ _6"></span><span class="ff4d ls8 ws9f">Flags<span class="ff48 ls1 ws1">: T<span class="_ _1"></span>o specify whether we’r<span class="_ _3"></span>e opening it for </span></span></div><div class="t m0 x1e hd y29e ff48 fs7 fc3 sc0 ls1 ws1">reading or writing or whether to cr<span class="_ _1"></span>eate the file. W<span class="_ _1"></span>e </div><div class="t m0 x1e hd y29f ff48 fs7 fc3 sc0 ls1 ws1">included some .<span class="ff4d">EQU</span> directives with the values we </div><div class="t m0 x1e hd y2a0 ff48 fs7 fc3 sc0 ls1 ws1">need (using the same names as in the C runtime).</div><div class="t m0 xc hd y45f ff48 fs7 fc3 sc0 ls1 wsad"> 4. <span class="_ _6"></span><span class="ff4d ls12 wsc9">Mo<span class="_ _0"></span>de<span class="ff48 ls1 ws1">: The access mode for the file when we create </span></span></div><div class="t m0 x1e hd y256 ff48 fs7 fc3 sc0 ls1 ws1">the file. W<span class="_ _1"></span>e included a couple of defines, b<span class="_ _3"></span>ut in octal </div><div class="t m0 x1e hd y257 ff48 fs7 fc3 sc0 ls1 ws1">these are the same as the par<span class="_ _3"></span>ameters to the <span class="ff4d">chmod</span> </div><div class="t m0 x1e hd y460 ff48 fs7 fc3 sc0 ls1 ws1">Linux command.</div><div class="t m0 xc hd y259 ff48 fs7 fc3 sc0 ls1 ws1">The return code is either a file descriptor or an error code<span class="_ _1"></span>. L<span class="_ _0"></span>ike m<span class="_ _3"></span>any </div><div class="t m0 xd hd yc64 ff48 fs7 fc3 sc0 ls1 ws1">Linux ser<span class="_ _0"></span>vices<span class="_ _1"></span>, the call fits this in a single return code by m<span class="_ _3"></span>aking errors </div><div class="t m0 xd hd yc65 ff48 fs7 fc3 sc0 ls1 ws1">negative and successful r<span class="_ _1"></span>esults positive.</div><div class="t m0 xc hd yc66 ff48 fs7 fc3 sc0 ls1 ws1">The C runtime has both open and openat r<span class="_ _1"></span>outines<span class="_ _0"></span>; the open routine </div><div class="t m0 xd hd yc67 ff48 fs7 fc3 sc0 ls1 ws1">calls the openat Linux service with A<span class="_ _1"></span>T_FDC<span class="_ _0"></span>WD for the first parameter as </div><div class="t m0 xd hd yc68 ff48 fs7 fc3 sc0 ls1 ws1">we use here.</div><div class="t m0 xd ha yc69 ff4c fs6 fc3 sc0 ls1 wsb1"> Error <span class="_ _14"> </span>Checking</div><div class="t m0 xd hd yc6a ff48 fs7 fc3 sc0 ls1 ws1">Books tend to not promote good pr<span class="_ _3"></span>ogramming pr<span class="_ _3"></span>actices for error </div><div class="t m0 xd hd yc6b ff48 fs7 fc3 sc0 ls1 ws1">checking. The sample pr<span class="_ _1"></span>ograms are kept as small as possible<span class="_ _1"></span>, so the main </div><div class="t m0 xd hd yc6c ff48 fs7 fc3 sc0 ls1 ws1">ideas being explained aren’t lost in a sea of details<span class="_ _1"></span>. This is the first program </div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfbc" class="pf w2 h6" data-page-no="bc"><div class="pc pcbc w2 h6"><div class="t m0 x17 hd y3f ff48 fs7 fc3 sc0 ls1 ws1">173</div><div class="t m0 xc hd y145 ff48 fs7 fc3 sc0 ls1 ws1">where we test any r<span class="_ _1"></span>eturn codes, partly because we had to develop enough </div><div class="t m0 xc hd y146 ff48 fs7 fc3 sc0 ls1 ws1">code to be able to do it and secondly error checking code tends to not </div><div class="t m0 xc hd y147 ff48 fs7 fc3 sc0 ls1 ws1">reveal an<span class="_ _3"></span>y new concepts.</div><div class="t m0 x1c hd y1b0 ff48 fs7 fc3 sc0 ls1 ws1">File open calls ar<span class="_ _1"></span>e prone to failing. The file might not exist<span class="_ _3"></span>, perhaps<span class="_ _1"></span>, </div><div class="t m0 xc hd y1b1 ff48 fs7 fc3 sc0 ls1 ws1">because we are in the wr<span class="_ _3"></span>ong folder or we may not h<span class="_ _3"></span>a<span class="_ _3"></span>ve sufficient access </div><div class="t m0 xc hd y1b2 ff48 fs7 fc3 sc0 ls1 ws1">rights to the file. Generally, chec<span class="_ _3"></span>k the return code to every system call, or </div><div class="t m0 xc hd y1b3 ff48 fs7 fc3 sc0 ls1 ws1">function you call, but pr<span class="_ _3"></span>actically speaking pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>ammers are la<span class="_ _3"></span>zy and tend </div><div class="t m0 xc hd y1b4 ff48 fs7 fc3 sc0 ls1 ws1">to only check those that ar<span class="_ _1"></span>e likely to fail. In this program<span class="_ _3"></span>, we check the two </div><div class="t m0 xc hd y1b5 ff48 fs7 fc3 sc0 ls1 ws1">file open calls. Chec<span class="_ _3"></span>king every return code would make the code listings </div><div class="t m0 xc hd y1b6 ff48 fs7 fc3 sc0 ls1 ws1">too long to include in this book, so don’t take this code as an example; do </div><div class="t m0 xc hd y1b7 ff48 fs7 fc3 sc0 ls1 ws1">the error checking in yo<span class="_ _3"></span>ur real code<span class="_ _3"></span>.</div><div class="t m0 x1c hd ya1c ff48 fs7 fc3 sc0 ls1 ws1">First of all, we h<span class="_ _3"></span>ave to cop<span class="_ _1"></span>y the file des<span class="_ _0"></span>criptor to a r<span class="_ _3"></span>egister that won’t be </div><div class="t m0 xc hd ya1d ff48 fs7 fc3 sc0 ls1 ws1">overwritten, so we move it to X11. W<span class="_ _1"></span>e do this with an <span class="ff4d">ADD<span class="_ _0"></span>S</span> instruction, so </div><div class="t m0 xc hd y944 ff48 fs7 fc3 sc0 ls1 ws1">the condition flags will be set. It would be nice if ther<span class="_ _1"></span>e was a <span class="ff4d">MOVS</span> alias </div><div class="t m0 xc hd y945 ff48 fs7 fc3 sc0 ls1 ws1">for <span class="ff4d">ADDS</span>, but since there isn’t, we add <span class="ff4d">X0</span> to the zer<span class="_ _1"></span>o register <span class="ff4d ls7 ws6f">XZR</span> and put </div><div class="t m0 xc hd ya1e ff48 fs7 fc3 sc0 ls1 ws1">the result in <span class="ff4d">X11</span>, and the condition fla<span class="_ _3"></span>gs are set accor<span class="_ _3"></span>dingly.</div><div class="t m0 xc h18 y618 ff4f fs7 fc3 sc0 ls1 ws1">ADDS   X11, XZR, X0 // save file descriptor</div><div class="t m0 x1c hd y642 ff48 fs7 fc3 sc0 ls1 ws1">This means we can test if it’<span class="_ _6"></span>s positive, and if so<span class="_ _1"></span>, go on to the next bit of </div><div class="t m0 xc hd y643 ff48 fs7 fc3 sc0 ls1 ws1">code:</div><div class="t m0 xc h18 yc6d ff4f fs7 fc3 sc0 ls1 ws1">B.PL   nxtfil  // pos number file opened ok</div><div class="t m0 x1c hd yc6e ff48 fs7 fc3 sc0 ls1 ws1">If the branch isn’t taken, then openF<span class="_ _1"></span>ile returned a negative number<span class="_ _10"></span>. </div><div class="t m0 xc hd yc6f ff48 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e we use our writeFile r<span class="_ _3"></span>outine to write an error message to stdout<span class="_ _3"></span>, then </div><div class="t m0 xc hd yc70 ff48 fs7 fc3 sc0 ls1 ws1">branch to the end of the pr<span class="_ _3"></span>ogram to exit.</div><div class="t m0 xc h18 yc71 ff4f fs7 fc3 sc0 ls1 ws1">MOV          X1, #1           // stdout</div><div class="t m0 xc h18 y1dd ff4f fs7 fc3 sc0 ls1 ws1">LDR          X2, =inpErrsz    // Error msg</div><div class="t m0 xc h18 yc72 ff4f fs7 fc3 sc0 ls1 ws1">LDR          W2, [X2]</div><div class="t m0 xc h18 yc73 ff4f fs7 fc3 sc0 ls1 ws1">writeFile    X1, inpErr, X2   // print the error</div><div class="t m0 xc h18 yc74 ff4f fs7 fc3 sc0 ls1 ws1">B            exit</div><div class="t m0 x47 h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfbd" class="pf w2 h6" data-page-no="bd"><div class="pc pcbd w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">174</div><div class="t m0 xc hd y145 ff48 fs7 fc3 sc0 ls1 ws1">In our .data section, we defined the error messa<span class="_ _3"></span>ges as follows<span class="_ _0"></span>:</div><div class="t m0 xd h18 y2e0 ff4f fs7 fc3 sc0 ls1 ws1">inpErr: .asciz    &quot;Failed to open input file.\n&quot;</div><div class="t m0 xd h18 y2e1 ff4f fs7 fc3 sc0 ls1 ws1">inpErrsz: .word  .-inpErr</div><div class="t m0 xc hd y496 ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve seen .<span class="ff4d">asciz</span> and this is standard. F<span class="_ _1"></span>or wr<span class="_ _0"></span>iteF<span class="_ _1"></span>ile, we need the </div><div class="t m0 xd hd y567 ff48 fs7 fc3 sc0 ls1 ws1">length of the string to write to the console. In Ch<span class="_ _3"></span>apter <span class="fc5">1</span>, “<span class="_ _1"></span>G<span class="_ _0"></span>etting S<span class="_ _3"></span>tarted,<span class="_ _8"></span>” </div><div class="t m0 xd hd y2d9 ff48 fs7 fc3 sc0 ls1 ws1">we counted the char<span class="_ _3"></span>acters in our string and put the har<span class="_ _1"></span>d-co<span class="_ _0"></span>ded num<span class="_ _3"></span>ber </div><div class="t m0 xd hd y2da ff48 fs7 fc3 sc0 ls1 ws1">in our code. W<span class="_ _1"></span>e could do that her<span class="_ _1"></span>e too, but err<span class="_ _3"></span>or messages start getting </div><div class="t m0 xd hd y231 ff48 fs7 fc3 sc0 ls1 ws1">long and counting the ch<span class="_ _3"></span>aracters seems like something the computer </div><div class="t m0 xd hd y232 ff48 fs7 fc3 sc0 ls1 ws1">should do<span class="_ _1"></span>. W<span class="_ _3"></span>e could write a routine lik<span class="_ _3"></span>e the C library’<span class="_ _1"></span>s <span class="ff4d">strlen</span>(<span class="_ _2"></span>) function to </div><div class="t m0 xd hd y233 ff48 fs7 fc3 sc0 ls1 ws1">calculate the length of a NULL-terminated string. I<span class="_ _3"></span>nstead, we use a little </div><div class="t m0 xd hd y2e5 ff48 fs7 fc3 sc0 ls1 ws1">GNU Assembler trickery. We add a .wor<span class="_ _1"></span>d directive right after the string </div><div class="t m0 xd hd yb30 ff48 fs7 fc3 sc0 ls1 ws1">and initialize it with “<span class="_ _b"></span>.-inpErr<span class="_ _0"></span>”<span class="_ _2d"></span>. The “<span class="_ _1"></span>.<span class="_ _6"></span>” is a special Ass<span class="_ _0"></span>embler v<span class="_ _3"></span>ariable that </div><div class="t m0 xd hd yb31 ff48 fs7 fc3 sc0 ls1 ws1">contains the curren<span class="_ _3"></span>t address the Assembler is on as it wor<span class="_ _3"></span>ks. H<span class="_ _3"></span>ence, the </div><div class="t m0 xd hd y63e ff48 fs7 fc3 sc0 ls1 ws1">current addr<span class="_ _1"></span>ess r<span class="_ _0"></span>igh<span class="_ _3"></span>t after the string minus the address of the s<span class="_ _3"></span>tart of </div><div class="t m0 xd hd y63f ff48 fs7 fc3 sc0 ls1 ws1">the string is the length. N<span class="_ _1"></span>ow people can revise the wording of the error </div><div class="t m0 xd hd y640 ff48 fs7 fc3 sc0 ls1 ws1">message to their heart’<span class="_ _1"></span>s conten<span class="_ _3"></span>t without needing to count the char<span class="_ _3"></span>acters </div><div class="t m0 xd hd y641 ff48 fs7 fc3 sc0 ls1 ws1">each time.</div><div class="t m0 xc hd y642 ff48 fs7 fc3 sc0 ls1 ws1">Most applic<span class="_ _3"></span>ations contain an error module<span class="_ _1"></span>, s<span class="_ _0"></span>o if a function fails<span class="_ _1"></span>, the </div><div class="t m0 xd hd y643 ff48 fs7 fc3 sc0 ls1 ws1">error module is called. Then the error module is r<span class="_ _1"></span>esponsible for reporting </div><div class="t m0 xd hd y946 ff48 fs7 fc3 sc0 ls1 ws1">and logging the error<span class="_ _10"></span>. This way error r<span class="_ _3"></span>eporting can be made quite </div><div class="t m0 xd hd y947 ff48 fs7 fc3 sc0 ls1 ws1">sophisticated without cluttering up the res<span class="_ _3"></span>t of the code with error handling </div><div class="t m0 xd hd y61d ff48 fs7 fc3 sc0 ls1 ws1">code. Another pr<span class="_ _3"></span>oblem with error handling code is tha<span class="_ _3"></span>t it tends to not be </div><div class="t m0 xd hd y948 ff48 fs7 fc3 sc0 ls1 ws1">tested. Often bad things can ha<span class="_ _3"></span>ppen when an error finally does happen, </div><div class="t m0 xd hd y949 ff48 fs7 fc3 sc0 ls1 ws1">and problems with the pr<span class="_ _3"></span>eviously untested code manifest<span class="_ _3"></span>.</div><div class="t m0 xd ha y681 ff4c fs6 fc3 sc0 ls1 wsb1"> Looping</div><div class="t m0 xd hd yc75 ff48 fs7 fc3 sc0 ls1 ws1">In our loop<span class="_ _1"></span>, we</div><div class="t m0 xc hd yc76 ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Read a block of 250 char<span class="_ _3"></span>acters from the inp<span class="_ _3"></span>ut file</div><div class="t m0 xc hd yc77 ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Append a NULL terminator</div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:286.643000px;bottom:497.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfbe" class="pf w2 h6" data-page-no="be"><div class="pc pcbe w2 h6"><div class="t m0 x17 hd y3f ff48 fs7 fc3 sc0 ls1 ws1">175</div><div class="t m0 x1c hd y145 ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Call toupper</div><div class="t m0 x1c hd y58c ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Write the converted characters to the outp<span class="_ _3"></span>ut file</div><div class="t m0 x1c hd yc78 ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>If we aren’t done, br<span class="_ _1"></span>anch to the top of the loop</div><div class="t m0 x1c hd yc79 ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e check if we are done with</div><div class="t m0 xc h18 yc7a ff4f fs7 fc3 sc0 ls1 ws1">CMP      X10, #BUFFERLEN</div><div class="t m0 xc h18 yc7b ff4f fs7 fc3 sc0 ls1 ws1">B.EQ     loop</div><div class="t m0 x1c hd yc7c ff4d fs7 fc3 sc0 ls1 ws1">X10<span class="ff48"> contains the number of ch<span class="_ _3"></span>aracters r<span class="_ _3"></span>eturned from the r<span class="_ _1"></span>ead </span></div><div class="t m0 xc hd yc7d ff48 fs7 fc3 sc0 ls1 ws1">ser<span class="_ _0"></span>vice call. If it equals the num<span class="_ _3"></span>ber of characters r<span class="_ _1"></span>equested, then w<span class="_ _0"></span>e </div><div class="t m0 xc hd yc7e ff48 fs7 fc3 sc0 ls1 ws1">branch to loop<span class="_ _1"></span>. If it doesn’t equal exactly, then either we hit end of file, </div><div class="t m0 xc hd yc7f ff48 fs7 fc3 sc0 ls1 ws1">so the number of char<span class="_ _3"></span>acters returned is less (and possibly 0), or an err<span class="_ _3"></span>or </div><div class="t m0 xc hd yc80 ff48 fs7 fc3 sc0 ls1 ws1">occurred, in which case the number is nega<span class="_ _3"></span>tive. Either w<span class="_ _3"></span>ay, we are done </div><div class="t m0 xc hd yc81 ff48 fs7 fc3 sc0 ls1 ws1">and fall through to the pr<span class="_ _1"></span>ogram exit.</div><div class="t m0 xc h15 y978 ff4c fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xc hd y1f4 ff48 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we gave an o<span class="_ _1"></span>ver<span class="_ _0"></span>view of how to call the various Linux </div><div class="t m0 xc hd y979 ff48 fs7 fc3 sc0 ls1 ws1">system services. W<span class="_ _1"></span>e covered the calling con<span class="_ _1"></span>vention and how to interpret </div><div class="t m0 xc hd y97a ff48 fs7 fc3 sc0 ls1 ws1">the return codes<span class="_ _1"></span>. We didn’t co<span class="_ _1"></span>ver the purpose of each call and referred the </div><div class="t m0 xc hd yc82 ff48 fs7 fc3 sc0 ls1 ws1">user to the Linux documentation instead.</div><div class="t m0 x1c hd y1ea ff48 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e presented a progr<span class="_ _3"></span>am to read a file<span class="_ _1"></span>, convert it to upper<span class="_ _1"></span>-case, and </div><div class="t m0 xc hd yc83 ff48 fs7 fc3 sc0 ls1 ws1">write it out to another file. This is our fir<span class="_ _3"></span>st chance to put together wha<span class="_ _3"></span>t </div><div class="t m0 xc hd yc84 ff48 fs7 fc3 sc0 ls1 ws1">we learned in Chapters <span class="fc5">1</span>–<span class="fc5">6</span> to build a full applica<span class="_ _3"></span>tion, with loops, if </div><div class="t m0 xc hd yc85 ff48 fs7 fc3 sc0 ls1 ws1">statements<span class="_ _1"></span>, er<span class="_ _0"></span>r<span class="_ _3"></span>or messages<span class="_ _3"></span>, and file I/O<span class="_ _3"></span>.</div><div class="t m0 x1c hd yc86 ff48 fs7 fc3 sc0 ls1 ws1">In the next cha<span class="_ _3"></span>pter<span class="_ _6"></span>, we will use Linux ser<span class="_ _0"></span>vice calls to manipula<span class="_ _3"></span>te the </div><div class="t m0 xc hd yc87 ff48 fs7 fc3 sc0 ls1 ws1">GPIO pins on the Raspberr<span class="_ _0"></span>y Pi boar<span class="_ _3"></span>d.</div><div class="t m0 x47 h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:164.339000px;bottom:199.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:175.009000px;bottom:199.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfbf" class="pf w2 h6" data-page-no="bf"><div class="pc pcbf w2 h6"><div class="t m0 xd hd y3f ff48 fs7 fc3 sc0 ls1 ws1">176</div><div class="t m0 xd h15 y186 ff4c fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y355 ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>The files this progr<span class="_ _3"></span>am operates on ar<span class="_ _1"></span>e hard coded </div><div class="t m0 x1e hd y356 ff48 fs7 fc3 sc0 ls1 ws1">in the <span class="ff4d">.data</span> section. Change them, pla<span class="_ _1"></span>y w<span class="_ _0"></span>ith them, </div><div class="t m0 x1e hd ya48 ff48 fs7 fc3 sc0 ls1 ws1">generate some errors t<span class="_ _3"></span>o see what happens<span class="_ _1"></span>. Single </div><div class="t m0 x1e hd ya49 ff48 fs7 fc3 sc0 ls1 ws1">step through the pr<span class="_ _1"></span>ogram in <span class="ff4d">gdb</span> to ensure you </div><div class="t m0 x1e hd ya4a ff48 fs7 fc3 sc0 ls1 ws1">understand how it works<span class="_ _1"></span>.</div><div class="t m0 xc hd ya4b ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Modify the progr<span class="_ _1"></span>am to convert the file to all  </div><div class="t m0 x1e hd ya4c ff48 fs7 fc3 sc0 ls1 ws1">lower<span class="_ _1"></span>-case.</div><div class="t m0 xc hd ya4d ff48 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Convert fileio<span class="_ _1"></span>.S to use callable functions rather than </div><div class="t m0 x1e hd ya4e ff48 fs7 fc3 sc0 ls1 ws1">macros<span class="_ _1"></span>. Change main.S to call these functions.</div><div class="t m0 xd h12 y71 ff4e fsa fc3 sc0 ls1 ws1">Chapter 7 <span class="_ _f"> </span> Linux Opera<span class="_ _1"></span>ting SyStem ServiCeS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc0" class="pf w2 h6" data-page-no="c0"><div class="pc pcc0 w2 h6"><div class="t m0 x17 hd y16a ff51 fs7 fc3 sc0 ls1 ws1">177</div><div class="t m0 xc h17 y16b ff51 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff51 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff52">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff51">,  </span></span></div><div class="t m0 xc h17 y16d ff51 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_8</div><div class="t m0 xc ha y16e ff53 fs6 fc3 sc0 ls1 ws1">CHAPTER 8</div><div class="t m0 xc h8 y16f ff54 fs4 fc3 sc0 ls1 ws1">Pr<span class="_ _3"></span>ogr<span class="_ _1"></span>amming  </div><div class="t m0 xc h8 y747 ff54 fs4 fc3 sc0 ls1 ws1">GPIO Pins</div><div class="t m0 xc hd y748 ff51 fs7 fc3 sc0 ls1 ws1">Most single boar<span class="_ _1"></span>d computers based on an ARM CPU have a set of </div><div class="t m0 xc hd y749 ff51 fs7 fc3 sc0 ls1 ws1">general-<span class="_ _1"></span>purpose I/O (<span class="_ _0"></span><span class="ff55">GPIO</span>) pins tha<span class="_ _3"></span>t you can use to contr<span class="_ _1"></span>ol homemade </div><div class="t m0 xc hd y74a ff51 fs7 fc3 sc0 ls1 ws1">electronics pr<span class="_ _3"></span>ojects. I<span class="_ _3"></span>n this chapter<span class="_ _10"></span>, we look at the GPIO ports on a </div><div class="t m0 xc hd y74b ff51 fs7 fc3 sc0 ls1 ws1">Raspberr<span class="_ _0"></span>y Pi. W<span class="_ _1"></span>e will run the 64-bit version of Kali Linux. Most of the </div><div class="t m0 xc hd y74c ff51 fs7 fc3 sc0 ls1 ws1">Raspberr<span class="_ _0"></span>y Pi starter kits include a br<span class="_ _3"></span>eadboard and a few electr<span class="_ _3"></span>onic </div><div class="t m0 xc hd y74d ff51 fs7 fc3 sc0 ls1 ws1">components to play with<span class="_ _3"></span>. In this chapter<span class="_ _10"></span>, we will look at programming </div><div class="t m0 xc hd y74e ff51 fs7 fc3 sc0 ls1 ws1">GPIO pins from Assembly Lan<span class="_ _3"></span>guage.</div><div class="t m0 x1c hd y74f ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will exper<span class="_ _0"></span>iment with a br<span class="_ _3"></span>eadboard containin<span class="_ _3"></span>g several LEDs and </div><div class="t m0 xc hd y8c6 ff51 fs7 fc3 sc0 ls1 wsa9">resistors<span class="_ _1"></span>, so w<span class="_ _0"></span>e can write some r<span class="_ _3"></span>eal code. W<span class="_ _1"></span>e will program the GPIO pins in </div><div class="t m0 xc hd y8c7 ff51 fs7 fc3 sc0 ls1 ws1">two ways: first, by using the Linux device driver and, second, by accessing </div><div class="t m0 xc hd y8c8 ff51 fs7 fc3 sc0 ls1 ws1">the GPIO contr<span class="_ _3"></span>oller’<span class="_ _1"></span>s registers dir<span class="_ _3"></span>ectly.</div><div class="t m0 xc h15 ybdd ff56 fsb fc3 sc0 ls1 wsaf"> GPIO <span class="_ _11"> </span>Over<span class="_ _0"></span>view</div><div class="t m0 xc hd ybde ff51 fs7 fc3 sc0 ls1 ws1">The original Raspberry Pi 1 has 26 GPIO pins, but the new Raspberry Pi’<span class="_ _6"></span>s </div><div class="t m0 xc hd ybdf ff51 fs7 fc3 sc0 ls1 ws1">expanded this to 40 pins. I<span class="_ _3"></span>n this section, we will limit our discussion to the </div><div class="t m0 xc hd ybe0 ff51 fs7 fc3 sc0 ls1 wsbe">original 26 pins. T<span class="_ _3"></span>hey either pro<span class="_ _3"></span>vide power or are gener<span class="_ _3"></span>ally progr<span class="_ _3"></span>ammable:</div><div class="t m0 x1e hd yc88 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Pins 1 and 17: Pro<span class="_ _3"></span>vide +3.3V DC power</div><div class="t m0 x1e hd yc89 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Pins 2 and 4: Pro<span class="_ _3"></span>vide +5V DC power</div><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc1" class="pf w2 h6" data-page-no="c1"><div class="pc pcc1 w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">178</div><div class="t m0 xa hd y145 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Pins 6, 9, 14, 20, and 25: Pro<span class="_ _3"></span>vide electrical ground</div><div class="t m0 xa hd y58c ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Pins 3, 5, 7–8, 10–13, 15, 16, 18, 19, 21–24, and 26: Are </div><div class="t m0 x1e hd y1fe ff51 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ammable general p<span class="_ _3"></span>urpose</div><div class="t m0 xc hd yc8a ff51 fs7 fc3 sc0 ls1 ws1">For the pr<span class="_ _1"></span>ogrammable pins<span class="_ _3"></span>, we can use them for output, wher<span class="_ _3"></span>e we </div><div class="t m0 xd hd y6e2 ff51 fs7 fc3 sc0 ls1 ws1">control whether they outp<span class="_ _3"></span>ut power or not (binar<span class="_ _0"></span>y 1 or 0). W<span class="_ _1"></span>e can re<span class="_ _3"></span>ad </div><div class="t m0 xd hd y28c ff51 fs7 fc3 sc0 ls1 ws1">them to see if power is pro<span class="_ _3"></span>vided, for instance, if it is connected to a switch.</div><div class="t m0 xc hd y14b ff51 fs7 fc3 sc0 ls1 ws1">However<span class="_ _10"></span>, this isn’t all there is to GPIO; besides the functions we’<span class="_ _1"></span>ve </div><div class="t m0 xd hd y58d ff51 fs7 fc3 sc0 ls1 ws1">talked about so far<span class="_ _6"></span>, a number of the pins ha<span class="_ _1"></span>ve alternate functions that y<span class="_ _3"></span>ou </div><div class="t m0 xd hd y58e ff51 fs7 fc3 sc0 ls1 ws1">can select progr<span class="_ _3"></span>ammatically. F<span class="_ _1"></span>or instance, pins 3 and 5 can support the </div><div class="t m0 xd hd y2f3 ff51 fs7 fc3 sc0 ls1 ws1">I2C standard th<span class="_ _3"></span>at allows two micr<span class="_ _3"></span>ochips to talk to each other<span class="_ _6"></span>.</div><div class="t m0 xc hd y2f4 ff51 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e pins that can support two serial por<span class="_ _0"></span>ts which ar<span class="_ _3"></span>e handy for </div><div class="t m0 xd hd y2f5 ff51 fs7 fc3 sc0 ls1 ws1">connecting to radios or printers<span class="_ _1"></span>. There are pins tha<span class="_ _3"></span>t support pulse width </div><div class="t m0 xd hd y1d0 ff51 fs7 fc3 sc0 ls1 ws1">modulation (PWM) and pulse-position modula<span class="_ _3"></span>tion (PPM), which convert </div><div class="t m0 xd hd y1d1 ff51 fs7 fc3 sc0 ls1 ws1">digital to analog and ar<span class="_ _3"></span>e handy for contr<span class="_ _1"></span>olling electr<span class="_ _0"></span>ic motors<span class="_ _1"></span>.</div><div class="t m0 xc hd y1d2 ff51 fs7 fc3 sc0 ls1 ws1">For o<span class="_ _3"></span>ur first progr<span class="_ _3"></span>am, we<span class="_ _3"></span>’re going to let Linux do the he<span class="_ _3"></span>avy lifting for </div><div class="t m0 xd hd y1d3 ff51 fs7 fc3 sc0 ls1 ws1">us. This will be typical for ho<span class="_ _3"></span>w to control h<span class="_ _3"></span>ardw<span class="_ _3"></span>are when ther<span class="_ _3"></span>e is a device </div><div class="t m0 xd hd y1d4 ff51 fs7 fc3 sc0 ls1 ws1">driver availa<span class="_ _3"></span>ble.</div><div class="t m0 xd h15 yc8b ff56 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>In Linux,<span class="_ _6"></span> Ever<span class="_ _0"></span>ything Is aFile</div><div class="t m0 xd hd yc8c ff51 fs7 fc3 sc0 ls1 ws1">The model for contr<span class="_ _3"></span>olling devices in Linux is to map each device to a file<span class="_ _1"></span>. </div><div class="t m0 xd hd yc8d ff51 fs7 fc3 sc0 ls1 ws1">The file appears under either /dev or /sys and can be manip<span class="_ _3"></span>ulated with the </div><div class="t m0 xd hd yc8e ff51 fs7 fc3 sc0 ls1 ws1">same Linux service calls that operate on r<span class="_ _1"></span>e<span class="_ _0"></span>gular files<span class="_ _1"></span>. The GPIO pins are </div><div class="t m0 xd hd yc8f ff51 fs7 fc3 sc0 ls1 ws1">no different<span class="_ _3"></span>. Ther<span class="_ _3"></span>e is a Linux device driver for them that contr<span class="_ _1"></span>ols the pin’<span class="_ _1"></span>s </div><div class="t m0 xd hd yc90 ff51 fs7 fc3 sc0 ls1 ws1">operations via applic<span class="_ _3"></span>ation pr<span class="_ _3"></span>ograms opening files<span class="_ _3"></span>, then reads and writes </div><div class="t m0 xd hd yc91 ff51 fs7 fc3 sc0 ls1 ws1">data to them.</div><div class="t m0 xc hd yc92 ff51 fs7 fc3 sc0 ls1 ws1">The files to contr<span class="_ _3"></span>ol the GPIO pins all appear under the /sys/class/gpio </div><div class="t m0 xd hd yc93 ff51 fs7 fc3 sc0 ls1 ws1">folder<span class="_ _6"></span>. By writing short text strings to these files, we contr<span class="_ _1"></span>ol the operation </div><div class="t m0 xd hd yc94 ff51 fs7 fc3 sc0 ls1 ws1">of the pins.</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc2" class="pf w2 h6" data-page-no="c2"><div class="pc pcc2 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">179</div><div class="t m0 x1c hd y145 ff51 fs7 fc3 sc0 ls1 ws1">Suppose we want to pr<span class="_ _3"></span>ogramma<span class="_ _3"></span>tically contr<span class="_ _3"></span>ol pin 17; the first thing </div><div class="t m0 xc hd y146 ff51 fs7 fc3 sc0 ls1 ws1">we do is tell the driver we want to do this. W<span class="_ _1"></span>e write the string “17” to /sys/</div><div class="t m0 xc hd y147 ff51 fs7 fc3 sc0 ls1 ws1">class/gpio/export. If this succeeds, then we now con<span class="_ _3"></span>trol the pin. The driver </div><div class="t m0 xc hd y1b0 ff51 fs7 fc3 sc0 ls1 ws1">then crea<span class="_ _3"></span>tes the following files in a gpio17 folder<span class="_ _0"></span>:</div><div class="t m0 x1e hd y149 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>/sys/class/gpio/gpio17/direction: Used to specify </div><div class="t m0 x9 hd y14a ff51 fs7 fc3 sc0 ls1 ws1">whether the pin is for input or output</div><div class="t m0 x1e hd y14b ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>/sys/class/gpio/gpio17/value: Used to set or read the </div><div class="t m0 x9 hd y14c ff51 fs7 fc3 sc0 ls1 ws1">value of the pin</div><div class="t m0 x1e hd y14d ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>/sys/class/gpio/gpio17/edge: Used to set an interrupt </div><div class="t m0 x9 hd y14e ff51 fs7 fc3 sc0 ls1 ws1">to detect value changes</div><div class="t m0 x1e hd y14f ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>/sys/class/gpio/gpio17/active_low: Used to in<span class="_ _3"></span>vert the </div><div class="t m0 x9 hd y150 ff51 fs7 fc3 sc0 ls1 ws1">meaning of 0 and 1</div><div class="t m0 x1c hd y151 ff51 fs7 fc3 sc0 ls12 ws1">The next thing we do is set the direction for the pin, either use it for input </div><div class="t m0 xc hd y152 ff51 fs7 fc3 sc0 ls12 ws1">or for output. W<span class="_ _1"></span>e either write “in” or “<span class="_ _6"></span>out<span class="_ _0"></span>” to the dir<span class="_ _1"></span>e<span class="_ _0"></span>ction file to do this<span class="_ _1"></span>.</div><div class="t m0 x1c hd y153 ff51 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we can write to the value file for an output pin or r<span class="_ _3"></span>ead the value </div><div class="t m0 xc hd y154 ff51 fs7 fc3 sc0 ls1 ws1">file for an input pin. T<span class="_ _6"></span>o turn on a pin, we write “1” to value, and to turn it </div><div class="t m0 xc hd y155 ff51 fs7 fc3 sc0 ls1 ws1">off, we write “0.<span class="_ _8"></span>” When activated, the GPIO pin pr<span class="_ _3"></span>ovides +3.3V<span class="_ _8"></span>.</div><div class="t m0 x1c hd y156 ff51 fs7 fc3 sc0 ls1 ws1">When we are done with a pin, we should write its pin number to /sys/</div><div class="t m0 xc hd y157 ff51 fs7 fc3 sc0 ls1 ws1">class/gpio/unexport. However<span class="_ _10"></span>, this will be done automatically when our </div><div class="t m0 xc hd y158 ff51 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am terminates<span class="_ _3"></span>.</div><div class="t m0 x1c hd y159 ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can do all this with the macros we crea<span class="_ _3"></span>ted in Chapter <span class="fc5">7</span>, “Linux </div><div class="t m0 xc hd y15a ff51 fs7 fc3 sc0 ls1 ws1">Operating S<span class="_ _3"></span>ystem Services,<span class="_ _8"></span>” in fileio<span class="_ _3"></span>.S<span class="_ _3"></span>.In fact, b<span class="_ _3"></span>y pro<span class="_ _1"></span>viding this interface, </div><div class="t m0 xc hd y15b ff51 fs7 fc3 sc0 ls1 ws1">you can contr<span class="_ _1"></span>ol the GPIO pins via any programming lan<span class="_ _3"></span>guage capable of </div><div class="t m0 xc hd y15c ff51 fs7 fc3 sc0 ls1 ws1">reading and writing files<span class="_ _1"></span>, which is pretty much every single one.</div><div class="t m0 xc h15 yc95 ff56 fsb fc3 sc0 ls1 wsaf"> Flashing <span class="_ _11"> </span>LEDs</div><div class="t m0 xc hd yc76 ff51 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o demonstrate pr<span class="_ _3"></span>ogramming the GPIO<span class="_ _1"></span>, we will conne<span class="_ _0"></span>ct some LEDs to a </div><div class="t m0 xc hd yc96 ff51 fs7 fc3 sc0 ls1 ws1">breadboar<span class="_ _3"></span>d and then make them flash in sequence<span class="_ _3"></span>.</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfb0" data-dest-detail='[176,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:338.009000px;bottom:227.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc3" class="pf w2 h6" data-page-no="c3"><div class="pc pcc3 w2 h6"><img class="bi xd yc97 w7 h45" alt="" src="bgc3.png"/><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">180</div><div class="t m0 xc hd y275 ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will conne<span class="_ _0"></span>ct each of thr<span class="_ _1"></span>e<span class="_ _0"></span>e LEDs to a GPIO pin (in this case 17, 27, </div><div class="t m0 xd hd y276 ff51 fs7 fc3 sc0 ls1 ws1">and 22), then to ground thr<span class="_ _1"></span>ough a resistor<span class="_ _6"></span>. W<span class="_ _1"></span>e need the resistor because </div><div class="t m0 xd hd y277 ff51 fs7 fc3 sc0 ls1 ws1">the GPIO is specified to keep the current under 16mA, or you can damage </div><div class="t m0 xd hd y278 ff51 fs7 fc3 sc0 ls1 ws1">the circuits<span class="_ _1"></span>.</div><div class="t m0 xc hd y279 ff51 fs7 fc3 sc0 ls1 ws1">Most of the kits come with several 220 O<span class="_ _3"></span>hm resistors<span class="_ _1"></span>. By Ohm<span class="_ _1"></span>’<span class="_ _6"></span>s law, </div><div class="t m0 xd hd y27a ff51 fs7 fc3 sc0 ls1 ws1">I = V / R, these would cause the current to be 3.3V/220<span class="ff58">Ω</span> = 15mA, so just </div><div class="t m0 xd hd y27b ff51 fs7 fc3 sc0 ls1 ws1">right. Y<span class="_ _6"></span>ou need to have a r<span class="_ _1"></span>esistor in ser<span class="_ _0"></span>ies with the LED since the LED’<span class="_ _1"></span>s </div><div class="t m0 xd hd y27c ff51 fs7 fc3 sc0 ls1 ws1">resistance is quite lo<span class="_ _3"></span>w (typically aro<span class="_ _3"></span>und 13 Ohms and variable).</div><div class="t m0 x34 h1f y27d ff56 fse fc3 sc0 ls1 ws1">Warning<span class="ff57"> <span class="_ _17"> </span>LEDs ha<span class="_ _0"></span>ve a positive and negative side.<span class="_ _1"></span> <span class="_ _3"></span>The positive side </span></div><div class="t m0 x34 h1f y27e ff57 fse fc3 sc0 ls1 ws1">needs to connect to the GPIO pin; reversing it could damage the LED.</div><div class="t m0 xc hd y27f ff51 fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">8-1</span> shows ho<span class="_ _3"></span>w the LEDs and resistors ar<span class="_ _1"></span>e w<span class="_ _0"></span>ir<span class="_ _3"></span>ed up on a </div><div class="t m0 xd hd y280 ff51 fs7 fc3 sc0 ls1 ws1">breadboar<span class="_ _3"></span>d.</div><div class="t m0 xd h1c yc98 ff59 fs3 fc3 sc0 ls1 ws1">Figure 8-1. <span class="_ _15"> </span><span class="ff52">Breadboard with LEDs and resistors insta<span class="_ _3"></span>lled</span></div><div class="t m0 xd h12 y28b ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfc3" data-dest-detail='[195,"XYZ",35,345,null]'><div class="d m1" style="border-style:none;position:absolute;left:86.031500px;bottom:376.362000px;width:15.047500px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc4" class="pf w2 h6" data-page-no="c4"><div class="pc pcc4 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">181</div><div class="t m0 x1c hd y145 ff51 fs7 fc3 sc0 ls1 ws1">Initially, we’ll define a set of m<span class="_ _3"></span>acros in gpiomacr<span class="_ _1"></span>os.S. con<span class="_ _3"></span>taining </div><div class="t m0 xc hd y146 ff51 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">8-1</span>, which uses the macros in fileio<span class="_ _1"></span>.S to perform the various GPIO </div><div class="t m0 xc hd y147 ff51 fs7 fc3 sc0 ls1 ws1">functions.</div><div class="t m0 xc h20 ya37 ff59 fs3 fc3 sc0 ls1 ws1">Listing 8-1. <span class="_ _15"> </span><span class="ff51">Macr<span class="_ _1"></span>os to control the GPIO pins</span></div><div class="t m0 xc h46 ya38 ff5a fs7 fc3 sc0 ls1 ws1">// Various macros to access the GPIO pins</div><div class="t m0 xc h46 ya39 ff5a fs7 fc3 sc0 ls1 ws1">// on the Raspberry Pi.</div><div class="t m0 xc h46 ya3a ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 ya3b ff5a fs7 fc3 sc0 ls1 ws1">// X9 - file descriptor.</div><div class="t m0 xc h46 ya3c ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 ya3d ff5a fs7 fc3 sc0 ls1 ws1">#include &quot;fileio.S&quot;</div><div class="t m0 xc h46 yc99 ff5a fs7 fc3 sc0 ls1 ws1">// Macro nanoSleep to sleep .1 second</div><div class="t m0 xc h46 yc9a ff5a fs7 fc3 sc0 ls1 ws1">// Calls Linux nanosleep entry point.</div><div class="t m0 xc h46 yc9b ff5a fs7 fc3 sc0 ls1 ws1">// Pass a reference to a timespec in both X0 and X1</div><div class="t m0 xc h46 yc9c ff5a fs7 fc3 sc0 ls1 ws1">// First is input time to sleep in seconds and nanoseconds.</div><div class="t m0 xc h46 yc9d ff5a fs7 fc3 sc0 ls12 ws1">// Second is time left to sleep if interrupted (which we ignore)</div><div class="t m0 xc h46 yc34 ff5a fs7 fc3 sc0 ls1 ws1">.macro  nanoSleep</div><div class="t m0 xc h46 yc9e ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X0, =timespecsec</div><div class="t m0 xc h46 yc9f ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X1, =timespecsec</div><div class="t m0 xc h46 yca0 ff5a fs7 fc3 sc0 ls1 ws1">        mov         x8, #__NR_nanosleep</div><div class="t m0 xc h46 yca1 ff5a fs7 fc3 sc0 ls1 ws1">        svc         0</div><div class="t m0 xc h46 yca2 ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xc h46 yca3 ff5a fs7 fc3 sc0 ls1 ws1">.macro  GPIOExport  pin</div><div class="t m0 xc h46 yca4 ff5a fs7 fc3 sc0 ls1 ws1">        openFile    gpioexp, O_WRONLY</div><div class="t m0 xc h46 yca5 ff5a fs7 fc3 sc0 ls1 ws1">        mov         X9, X0      // save the file descriptor</div><div class="t m0 xc h46 yca6 ff5a fs7 fc3 sc0 ls1 ws1">        writeFile   X9, \pin, #2</div><div class="t m0 xc h46 yca7 ff5a fs7 fc3 sc0 ls1 ws1">        flushClose  X9</div><div class="t m0 xc h46 yca8 ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfc4" data-dest-detail='[196,"XYZ",53,532,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:561.362000px;width:15.047600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc5" class="pf w2 h6" data-page-no="c5"><div class="pc pcc5 w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">182</div><div class="t m0 xd h46 y46b ff5a fs7 fc3 sc0 ls1 ws1">.macro  GPIODirectionOut   pin</div><div class="t m0 xd h46 y46c ff5a fs7 fc3 sc0 ls1 ws1">        // copy pin into filename pattern</div><div class="t m0 xd h46 y46d ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X1, =\pin</div><div class="t m0 xd h46 y623 ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X2, =gpiopinfile</div><div class="t m0 xd h46 y624 ff5a fs7 fc3 sc0 ls1 ws1">        add         X2, X2, #20</div><div class="t m0 xd h46 y625 ff5a fs7 fc3 sc0 ls1 ws1">        ldrb        W3, [X1], #1 // load pin and post increment</div><div class="t m0 xd h46 y626 ff5a fs7 fc3 sc0 ls1 ws1">        strb        W3, [X2], #1  <span class="_ _20"></span>// store to filename and post </div><div class="t m0 x29 h46 y627 ff5a fs7 fc3 sc0 ls1 ws1">increment</div><div class="t m0 xd h46 y628 ff5a fs7 fc3 sc0 ls1 ws1">        ldrb        W3, [X1]</div><div class="t m0 xd h46 y9f6 ff5a fs7 fc3 sc0 ls1 ws1">        strb        W3, [X2]</div><div class="t m0 xd h46 y9f7 ff5a fs7 fc3 sc0 ls1 ws1">        openFile    gpiopinfile, O_WRONLY</div><div class="t m0 xd h46 y9f8 ff5a fs7 fc3 sc0 ls1 ws1">        mov         X9, X0      // save the file descriptor</div><div class="t m0 xd h46 yb8d ff5a fs7 fc3 sc0 ls1 ws1">        writeFile   X9, outstr, #3</div><div class="t m0 xd h46 yb8e ff5a fs7 fc3 sc0 ls1 ws1">        flushClose  X9</div><div class="t m0 xd h46 yb8f ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xd h46 yb90 ff5a fs7 fc3 sc0 ls1 ws1">.macro  GPIOWrite   pin, value</div><div class="t m0 xd h46 yb91 ff5a fs7 fc3 sc0 ls1 ws1">        // copy pin into filename pattern</div><div class="t m0 xd h46 yc1f ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X1, =\pin</div><div class="t m0 xd h46 yc20 ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X2, =gpiovaluefile</div><div class="t m0 xd h46 yc21 ff5a fs7 fc3 sc0 ls1 ws1">        add         X2, X2, #20</div><div class="t m0 xd h46 yc22 ff5a fs7 fc3 sc0 ls1 ws1">        ldrb        W3, [X1], #1 // load pin and post incr</div><div class="t m0 xd h46 yc23 ff5a fs7 fc3 sc0 ls1 ws1">        strb        W3, [X2], #1 // store to file and post incr</div><div class="t m0 xd h46 yc24 ff5a fs7 fc3 sc0 ls1 ws1">        ldrb        W3, [X1]</div><div class="t m0 xd h46 yc25 ff5a fs7 fc3 sc0 ls1 ws1">        strb        W3, [X2]</div><div class="t m0 xd h46 yc26 ff5a fs7 fc3 sc0 ls1 ws1">        openFile    gpiovaluefile, O_WRONLY</div><div class="t m0 xd h46 yc27 ff5a fs7 fc3 sc0 ls1 ws1">        mov         X9, X0      // save the file descriptor</div><div class="t m0 xd h46 yc28 ff5a fs7 fc3 sc0 ls1 ws1">        writeFile   X9, \value, #1</div><div class="t m0 xd h46 yca9 ff5a fs7 fc3 sc0 ls1 ws1">        flushClose  X9</div><div class="t m0 xd h46 ycaa ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xd h46 yc2b ff5a fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h46 yc2c ff5a fs7 fc3 sc0 ls1 ws1">timespecsec:   .dword   0</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc6" class="pf w2 h6" data-page-no="c6"><div class="pc pcc6 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">183</div><div class="t m0 xc h46 y46b ff5a fs7 fc3 sc0 ls1 ws1">timespecnano:  .dword   100000000</div><div class="t m0 xc h46 y46c ff5a fs7 fc3 sc0 ls1 ws1">gpioexp:    .asciz  &quot;/sys/class/gpio/export&quot;</div><div class="t m0 xc h46 y46d ff5a fs7 fc3 sc0 ls1 ws1">gpiopinfile: .asciz &quot;/sys/class/gpio/gpioxx/direction&quot;</div><div class="t m0 xc h46 y623 ff5a fs7 fc3 sc0 ls1 ws1">gpiovaluefile: .asciz &quot;/sys/class/gpio/gpioxx/value&quot;</div><div class="t m0 xc h46 y624 ff5a fs7 fc3 sc0 ls1 ws1">outstr:     .asciz  &quot;out&quot;</div><div class="t m0 xc h46 yc46 ff5a fs7 fc3 sc0 ls1 ws1">            .align  4    // save users having to do this.</div><div class="t m0 xc h46 y626 ff5a fs7 fc3 sc0 ls1 ws1">.text</div><div class="t m0 x1c hd y984 ff51 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we need a controlling pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>am, main.S con<span class="_ _3"></span>taining Listing <span class="fc5">8-2</span>, to </div><div class="t m0 xc hd yb7a ff51 fs7 fc3 sc0 ls1 ws1">orchestr<span class="_ _3"></span>ate the pr<span class="_ _3"></span>ocess.</div><div class="t m0 xc h20 ycab ff59 fs3 fc3 sc0 ls1 ws1">Listing 8-2. <span class="_ _15"> </span><span class="ff51">Main pr<span class="_ _1"></span>ogram to flash the LEDs</span></div><div class="t m0 xc h46 ycac ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 ycad ff5a fs7 fc3 sc0 ls1 ws1">// Assembler program to flash three LEDs connected to the</div><div class="t m0 xc h46 ycae ff5a fs7 fc3 sc0 ls1 ws1">// Raspberry Pi GPIO port.</div><div class="t m0 xc h46 ycaf ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 ycb0 ff5a fs7 fc3 sc0 ls1 ws1">// W6 - loop variable to flash lights 10 times</div><div class="t m0 xc h46 ycb1 ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 ycb2 ff5a fs7 fc3 sc0 ls1 ws1">#include &quot;gpiomacros.S&quot;</div><div class="t m0 xc h46 ycb3 ff5a fs7 fc3 sc0 ls1 ws1">.global _start       // Provide program starting address</div><div class="t m0 xc h46 ycb4 ff5a fs7 fc3 sc0 ls1 ws1">_start: GPIOExport  pin17</div><div class="t m0 xc h46 ycb5 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOExport  pin27</div><div class="t m0 xc h46 ycb6 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOExport  pin22</div><div class="t m0 xc h46 ycb7 ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xc h46 ycb8 ff5a fs7 fc3 sc0 ls1 ws1">        GPIODirectionOut pin17</div><div class="t m0 xc h46 ycb9 ff5a fs7 fc3 sc0 ls1 ws1">        GPIODirectionOut pin27</div><div class="t m0 xc h46 ycba ff5a fs7 fc3 sc0 ls1 ws1">        GPIODirectionOut pin22</div><div class="t m0 xc h46 ycbb ff5a fs7 fc3 sc0 ls1 ws1">        // setup a loop counter for 10 iterations</div><div class="t m0 xc h46 ycbc ff5a fs7 fc3 sc0 ls1 ws1">        mov         W6, #10</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfc6" data-dest-detail='[198,"XYZ",53,427,null]'><div class="d m1" style="border-style:none;position:absolute;left:366.147000px;bottom:457.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc7" class="pf w2 h6" data-page-no="c7"><div class="pc pcc7 w2 h6"><img class="bi xd ycbd w7 h24" alt="" src="bgc7.png"/><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">184</div><div class="t m0 xd h46 ycbe ff5a fs7 fc3 sc0 ls1 ws1">loop:   GPIOWrite   pin17, high</div><div class="t m0 xd h46 ycbf ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xd h46 ycc0 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOWrite   pin17, low</div><div class="t m0 xd h46 ycc1 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOWrite   pin27, high</div><div class="t m0 xd h46 ycc2 ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xd h46 ycc3 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOWrite   pin27, low</div><div class="t m0 xd h46 ycc4 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOWrite   pin22, high</div><div class="t m0 xd h46 ycc5 ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xd h46 ycc6 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOWrite   pin22, low</div><div class="t m0 xd h46 ycc7 ff5a fs7 fc3 sc0 ls1 ws1">        // decrement loop counter and see if we loop</div><div class="t m0 xd h46 ycc8 ff5a fs7 fc3 sc0 ls1 ws1">        // Subtract 1 from loop register</div><div class="t m0 xd h46 ycc9 ff5a fs7 fc3 sc0 ls1 ws1">        // setting status register</div><div class="t m0 xd h46 ycca ff5a fs7 fc3 sc0 ls1 ws1">        subs    W6, W6, #1</div><div class="t m0 xd h46 yccb ff5a fs7 fc3 sc0 ls1 ws1">        // If we haven&apos;t counted down to 0 then loop</div><div class="t m0 xd h46 yccc ff5a fs7 fc3 sc0 ls1 ws1">        b.ne     loop</div><div class="t m0 xd h46 yccd ff5a fs7 fc3 sc0 ls1 ws1">_end:   mov     X0, #0      // Use 0 return code</div><div class="t m0 xd h46 ycce ff5a fs7 fc3 sc0 ls1 ws1">        mov     X8, #__NR_exit</div><div class="t m0 xd h46 yccf ff5a fs7 fc3 sc0 ls1 ws1">        svc     0           // Linux command to terminate</div><div class="t m0 xd h46 ycd0 ff5a fs7 fc3 sc0 ls1 ws1">pin17:      .asciz  &quot;17&quot;</div><div class="t m0 xd h46 ycd1 ff5a fs7 fc3 sc0 ls1 ws1">pin27:      .asciz  &quot;27&quot;</div><div class="t m0 xd h46 ycd2 ff5a fs7 fc3 sc0 ls1 ws1">pin22:      .asciz  &quot;22&quot;</div><div class="t m0 xd h46 ycd3 ff5a fs7 fc3 sc0 ls1 ws1">low:        .asciz  &quot;0&quot;</div><div class="t m0 xd h46 ycd4 ff5a fs7 fc3 sc0 ls1 ws1">high:       .asciz  &quot;1&quot;</div><div class="t m0 xc hd ycd5 ff51 fs7 fc3 sc0 ls1 ws1">This progr<span class="_ _3"></span>am is a straigh<span class="_ _3"></span>tforward application of the Linux sys<span class="_ _3"></span>tem </div><div class="t m0 xd hd ycd6 ff51 fs7 fc3 sc0 ls1 ws1">ser<span class="_ _0"></span>vice calls we learned in Cha<span class="_ _3"></span>pter <span class="fc5">7</span>, “Linux Operating S<span class="_ _1"></span>ystem S<span class="_ _0"></span>ervices.<span class="_ _8"></span>”</div><div class="t m0 x34 h1f ycd7 ff56 fse fc3 sc0 ls1 ws1">Note<span class="ff57"> <span class="_ _19"> </span>Under Kali Linux,<span class="_ _1"></span> the /sys/class/gpio files have restricted </span></div><div class="t m0 x34 h1f ycd8 ff57 fse fc3 sc0 ls1 ws1">access,<span class="_ _1"></span> so you either need to run your program using sudo.</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfb0" data-dest-detail='[176,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:200.381000px;bottom:169.186000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc8" class="pf w2 h6" data-page-no="c8"><div class="pc pcc8 w2 h6"><img class="bi xc ycd9 w7 h47" alt="" src="bgc8.png"/><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">185</div><div class="t m0 xc h15 y186 ff56 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Moving Closer totheMetal</div><div class="t m0 xc hd y187 ff51 fs7 fc3 sc0 ls8 ws1">For As<span class="_ _3"></span>sembly Language pr<span class="_ _3"></span>ogrammers<span class="_ _3"></span>, the previous exam<span class="_ _3"></span>ple is not </div><div class="t m0 xc hd y188 ff51 fs7 fc3 sc0 ls8 ws1">satisfying. When we pr<span class="_ _3"></span>ogram in Assembly Lang<span class="_ _3"></span>uage, we ar<span class="_ _3"></span>e usually </div><div class="t m0 xc hd y2be ff51 fs7 fc3 sc0 ls8 ws1">directly manip<span class="_ _3"></span>ulating devices for performance reasons<span class="_ _1"></span>, or to p<span class="_ _0"></span>erform </div><div class="t m0 xc hd y18a ff51 fs7 fc3 sc0 ls8 wsc2">operations th<span class="_ _3"></span>at simply can’t be done in high-level pr<span class="_ _1"></span>ogramming languages<span class="_ _3"></span>. </div><div class="t m0 xc hd y18b ff51 fs7 fc3 sc0 ls8 ws1">In this section, we will interact with the GPIO contr<span class="_ _3"></span>oller directly.</div><div class="t m0 x36 h1f ycda ff56 fse fc3 sc0 ls1 ws1">Warning<span class="ff57"> <span class="_ _17"> </span>Make sure you back up your work before running your </span></div><div class="t m0 x36 h1f ycdb ff57 fse fc3 sc0 ls1 ws1">program,<span class="_ _1"></span> since you may need to power off and po<span class="_ _0"></span>wer back on again.<span class="_ _1"></span> </div><div class="t m0 x36 h1f ycdc ff57 fse fc3 sc0 ls1 ws1">The GPIO controller controls 54 pins,<span class="_ _1"></span> the Raspberr<span class="_ _0"></span>y Pi only exposes </div><div class="t m0 x36 h1f ycdd ff57 fse fc3 sc0 ls1 ws1">either 26 or 40 of them,<span class="_ _1"></span> depending on the Pi model,<span class="_ _1"></span> and for external </div><div class="t m0 x36 h1f ycde ff57 fse fc3 sc0 ls1 ws1">use,<span class="_ _1"></span> many of the others are used by the Raspberr<span class="_ _0"></span>y Pi for other </div><div class="t m0 x36 h1f ycdf ff57 fse fc3 sc0 ls1 ws1">important tasks.<span class="_ _1"></span> In the previous section,<span class="_ _1"></span> the device driver provided </div><div class="t m0 x36 h1f yce0 ff57 fse fc3 sc0 ls1 ws1">a level of protection,<span class="_ _1"></span> so we couldn’t easily do any dama<span class="_ _0"></span>ge.<span class="_ _1"></span> Now </div><div class="t m0 x36 h1f yce1 ff57 fse fc3 sc0 ls1 ws1">that we are writing directly to the GPIO controller<span class="_ _6"></span>,<span class="_ _1"></span> we ha<span class="_ _0"></span>ve no such </div><div class="t m0 x36 h1f yce2 ff57 fse fc3 sc0 ls1 ws1">protection; if we make a mistake and manipulate the wrong pins,<span class="_ _1"></span> we </div><div class="t m0 x36 h1f yce3 ff57 fse fc3 sc0 ls1 ws1">may interfere with the Raspberry Pi’<span class="_ _1"></span>s operation and cause it to crash </div><div class="t m0 x36 h1f yce4 ff57 fse fc3 sc0 ls1 ws1">or lock up.</div><div class="t m0 xc h15 yce5 ff56 fsb fc3 sc0 ls1 wsaf"> Virtual <span class="_ _11"> </span>Memor<span class="_ _0"></span>y</div><div class="t m0 xc hd yce6 ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e looked at how to access memory in Chapter <span class="fc5">5</span>, “Thanks for the </div><div class="t m0 xc hd yce7 ff51 fs7 fc3 sc0 ls1 ws1">Memories,<span class="_ _8"></span>” and the memory addresses our instructions are s<span class="_ _3"></span>tored at in </div><div class="t m0 xc hd yce8 ff55 fs7 fc3 sc0 ls1 ws1">gdb<span class="ff51">. These memor<span class="_ _0"></span>y addr<span class="_ _3"></span>esses aren’t ph<span class="_ _3"></span>ysical memory addresses<span class="_ _0"></span>; ra<span class="_ _3"></span>ther </span></div><div class="t m0 xc hd yce9 ff51 fs7 fc3 sc0 ls1 ws1">they’re virtual memory addresses. As a Linux pr<span class="_ _1"></span>ocess, our progr<span class="_ _3"></span>am is given </div><div class="t m0 xc hd ycea ff51 fs7 fc3 sc0 ls1 ws1">a large virtual address space th<span class="_ _3"></span>at we can expand well beyond the amount </div><div class="t m0 xc hd yceb ff51 fs7 fc3 sc0 ls1 ws1">of physical memory. Within this addres<span class="_ _3"></span>s space, some of it is ma<span class="_ _3"></span>pped to </div><div class="t m0 xc hd ycec ff51 fs7 fc3 sc0 ls1 ws1">physical memory to store our Assembl<span class="_ _3"></span>y instructions, our .data sections<span class="_ _1"></span>, </div><div class="t m0 xc hd yced ff51 fs7 fc3 sc0 ls1 ws1">and our 8MB stack. F<span class="_ _1"></span>ur<span class="_ _0"></span>thermore<span class="_ _1"></span>, Linux may swap some of this memory to </div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:277.110000px;bottom:193.590000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfc9" class="pf w2 h6" data-page-no="c9"><div class="pc pcc9 w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">186</div><div class="t m0 xd hd y145 ff51 fs7 fc3 sc0 ls1 ws1">secondar<span class="_ _0"></span>y stor<span class="_ _3"></span>age like the SD Car<span class="_ _1"></span>d as it nee<span class="_ _0"></span>ds mor<span class="_ _3"></span>e physical memory for </div><div class="t m0 xd hd y146 ff51 fs7 fc3 sc0 ls1 ws1">other processes<span class="_ _3"></span>. There is a lot of com<span class="_ _3"></span>plexity in the memor<span class="_ _0"></span>y man<span class="_ _3"></span>agement </div><div class="t m0 xd hd y147 ff51 fs7 fc3 sc0 ls1 ws1">process to allo<span class="_ _3"></span>w dozens of pr<span class="_ _3"></span>ocesses to run independently of each other<span class="_ _6"></span>, </div><div class="t m0 xd hd y1b0 ff51 fs7 fc3 sc0 ls1 ws1">each thinking it has the whole system to itself<span class="_ _1"></span>.</div><div class="t m0 xc hd y1b1 ff51 fs7 fc3 sc0 ls1 ws1">In the next section, we want access to specific ph<span class="_ _3"></span>ysical memory </div><div class="t m0 xd hd y1b2 ff51 fs7 fc3 sc0 ls1 ws1">addresses<span class="_ _1"></span>, but when we request that access<span class="_ _3"></span>, Linux returns a virtual </div><div class="t m0 xd hd y1b3 ff51 fs7 fc3 sc0 ls1 ws1">memory p<span class="_ _0"></span>oint<span class="_ _3"></span>er that is differ<span class="_ _3"></span>ent than the ph<span class="_ _3"></span>ysical addr<span class="_ _3"></span>ess we asked for<span class="_ _6"></span>. </div><div class="t m0 xd hd y1b4 ff51 fs7 fc3 sc0 ls1 ws1">This is okay, as behind the scenes the memory management har<span class="_ _1"></span>dware in </div><div class="t m0 xd hd y1b5 ff51 fs7 fc3 sc0 ls1 ws1">the Raspberr<span class="_ _0"></span>y Pi will be doing the memory translations between virtual </div><div class="t m0 xd hd y1b6 ff51 fs7 fc3 sc0 ls1 ws1">and physical memory for us.</div><div class="t m0 xd h15 yaad ff56 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>In Devices,<span class="_ _6"></span> Ever<span class="_ _0"></span>ything Is Memor<span class="_ _0"></span>y</div><div class="t m0 xd hd yaae ff51 fs7 fc3 sc0 ls1 ws1">The GPIO contr<span class="_ _3"></span>oller has 41 r<span class="_ _3"></span>egisters<span class="_ _0"></span>; however<span class="_ _10"></span>, we can’t read or write </div><div class="t m0 xd hd yaaf ff51 fs7 fc3 sc0 ls1 ws1">these like the ARM CPU’<span class="_ _1"></span>s registers<span class="_ _1"></span>. The ARM instruction s<span class="_ _0"></span>et doesn’t know </div><div class="t m0 xd hd yab0 ff51 fs7 fc3 sc0 ls1 ws1">anything about the GPIO con<span class="_ _3"></span>troller and ther<span class="_ _3"></span>e are no special instructions </div><div class="t m0 xd hd yab1 ff51 fs7 fc3 sc0 ls1 ws1">to support it. The way we access these r<span class="_ _3"></span>egisters is by r<span class="_ _1"></span>eading and writing to </div><div class="t m0 xd hd yab2 ff51 fs7 fc3 sc0 ls1 ws1">specific memor<span class="_ _0"></span>y loca<span class="_ _3"></span>tions. Ther<span class="_ _1"></span>e is circuitry in the Raspber<span class="_ _0"></span>ry Pi’<span class="_ _6"></span>s system </div><div class="t m0 xd hd yab3 ff51 fs7 fc3 sc0 ls1 ws1">on a chip (SoC) that will see these memor<span class="_ _0"></span>y reads and writes and r<span class="_ _3"></span>edirect </div><div class="t m0 xd hd yab4 ff51 fs7 fc3 sc0 ls1 ws1">them to the GPIO’<span class="_ _6"></span>s registers. This is ho<span class="_ _3"></span>w most har<span class="_ _3"></span>dware comm<span class="_ _3"></span>unicates<span class="_ _1"></span>.</div><div class="t m0 xc hd yab5 ff51 fs7 fc3 sc0 ls1 ws1">The memory address for the GPIO registers under 64-bit K<span class="_ _1"></span>ali L<span class="_ _0"></span>inux is </div><div class="t m0 xd hd yab6 ff51 fs7 fc3 sc0 ls1 ws1">0xFE200000. This address is confi<span class="_ _3"></span>gurable b<span class="_ _1"></span>y the op<span class="_ _0"></span>er<span class="_ _3"></span>ating system<span class="_ _3"></span>, so you </div><div class="t m0 xd hd yab7 ff51 fs7 fc3 sc0 ls1 ws1">need to check what it is for wha<span class="_ _3"></span>t you ar<span class="_ _3"></span>e doing. The easiest wa<span class="_ _1"></span>y to confir<span class="_ _0"></span>m </div><div class="t m0 xd hd yab8 ff51 fs7 fc3 sc0 ls1 ws1">the true value is to use the command</div><div class="t m0 xd h46 ycee ff5a fs7 fc3 sc0 ls1 ws1">dmesg</div><div class="t m0 xc hd ycef ff51 fs7 fc3 sc0 ls1 ws1">In its output yo<span class="_ _3"></span>u will find something like</div><div class="t m0 xd h46 ycf0 ff5a fs7 fc3 sc0 ls1 ws1">[  +0.000669] gpiomem-bcm2835 fe200000.gpiomem: Initialised: </div><div class="t m0 xd h46 ycf1 ff5a fs7 fc3 sc0 ls1 ws1">Registers at 0xfe200000</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfca" class="pf w2 h6" data-page-no="ca"><div class="pc pcca w2 h6"><img class="bi xc ycf2 w7 h48" alt="" src="bgca.png"/><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">187</div><div class="t m0 x36 h1f y82c ff56 fse fc3 sc0 ls1 ws1">Note<span class="ff57"> <span class="_ _17"> </span>The output of </span>dmesg<span class="ff57"> could be quite long.<span class="_ _1"></span> Use</span></div><div class="t m0 xc h46 ycf3 ff5a fs7 fc3 sc0 ls1 ws1">    dmesg | grep gpio</div><div class="t m0 x36 h1f ycf4 ff57 fse fc3 sc0 ls1 ws1">or something similar to scan for this entry<span class="_ _1"></span>.</div><div class="t m0 x1c hd ycf5 ff51 fs7 fc3 sc0 ls12 ws1">This is a kernel message fr<span class="_ _1"></span>om initializing the Broadcom bcm2835 GPIO </div><div class="t m0 xc hd ycf6 ff51 fs7 fc3 sc0 ls12 ws1">controller c<span class="_ _3"></span>hip<span class="_ _1"></span>, which gives the useful infor<span class="_ _0"></span>ma<span class="_ _3"></span>tion of where the r<span class="_ _1"></span>e<span class="_ _0"></span>gisters ar<span class="_ _1"></span>e.</div><div class="t m0 x1c hd ycf7 ff51 fs7 fc3 sc0 ls1 ws1">Sounds easy—we know how to load addr<span class="_ _3"></span>esses into r<span class="_ _3"></span>egisters, then </div><div class="t m0 xc hd ycf8 ff51 fs7 fc3 sc0 ls1 ws1">refer<span class="_ _1"></span>ence the memor<span class="_ _0"></span>y stored ther<span class="_ _3"></span>e. N<span class="_ _1"></span>ot s<span class="_ _0"></span>o fast<span class="_ _3"></span>, if we tried this, our </div><div class="t m0 xc hd ycf9 ff51 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am would just crash with a memory access error<span class="_ _6"></span>. This is because </div><div class="t m0 xc hd ycfa ff51 fs7 fc3 sc0 ls1 ws1">these memor<span class="_ _0"></span>y addr<span class="_ _3"></span>esses are outside those assi<span class="_ _3"></span>gned to our progr<span class="_ _3"></span>am, and </div><div class="t m0 xc hd ycfb ff51 fs7 fc3 sc0 ls1 ws1">we are not allowed to use them. O<span class="_ _3"></span>ur first job then is to get access.</div><div class="t m0 x1c hd ycfc ff51 fs7 fc3 sc0 ls1 ws1">This leads us back to everything being a file in Linux. There is a file that </div><div class="t m0 xc hd ycfd ff51 fs7 fc3 sc0 ls1 ws1">will give us a pointer<span class="_ _6"></span>, which we can use to access these memory lo<span class="_ _0"></span>ca<span class="_ _3"></span>tions, </div><div class="t m0 xc hd ycfe ff51 fs7 fc3 sc0 ls1 ws1">as follows<span class="_ _0"></span>:</div><div class="t m0 x1c hd ycff ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Open the file /dev/mem.</div><div class="t m0 x1c hd yd00 ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Then we ask /dev/mem to map the regist<span class="_ _3"></span>ers for GPIO </div><div class="t m0 x9 hd yd01 ff51 fs7 fc3 sc0 ls1 ws1">into our memory space. W<span class="_ _1"></span>e do this with the Linux </div><div class="t m0 x9 hd yd02 ff51 fs7 fc3 sc0 ls1 ws1">mmap service. Mmap takes the follo<span class="_ _3"></span>wing parameters:</div><div class="t m0 x9 hd yd03 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff55">X0</span>: Hint for the virtual addr<span class="_ _1"></span>ess we w<span class="_ _0"></span>ould like<span class="_ _1"></span>. W<span class="_ _3"></span>e </div><div class="t m0 x4b hd yd04 ff51 fs7 fc3 sc0 ls1 ws1">don’t really car<span class="_ _1"></span>e and will us<span class="_ _0"></span>e NULL, which gives </div><div class="t m0 x4b hd yd05 ff51 fs7 fc3 sc0 ls1 ws1">Linux complete fr<span class="_ _3"></span>eedom to choose.</div><div class="t m0 x9 hd yd06 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff55">X1</span>: Length of region. Should be a multiple of 4096, </div><div class="t m0 x4b hd yd07 ff51 fs7 fc3 sc0 ls1 ws1">the memory page size.</div><div class="t m0 x9 hd yd08 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff55">X2</span>: Memory protection requir<span class="_ _1"></span>e<span class="_ _0"></span>d.</div><div class="t m0 x9 hd yd09 ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff55">X3</span>: File descriptor to access /dev/mem.</div><div class="t m0 x9 hd yd0a ff51 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff55">X4</span>: Offset into physical memory. In our case </div><div class="t m0 x4b hd yd0b ff51 fs7 fc3 sc0 ls1 ws1">0xFE200000.</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfcb" class="pf w2 h6" data-page-no="cb"><div class="pc pccb w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">188</div><div class="t m0 xc hd y145 ff51 fs7 fc3 sc0 ls1 ws1">This call will return a virtual addr<span class="_ _1"></span>ess in <span class="ff55">X0</span> that maps to the physic<span class="_ _3"></span>al </div><div class="t m0 xd hd y146 ff51 fs7 fc3 sc0 ls1 ws1">address we asked for<span class="_ _10"></span>. This function returns a small nega<span class="_ _3"></span>tive number if it </div><div class="t m0 xd hd y147 ff51 fs7 fc3 sc0 ls1 ws1">fails, which we can look up in errno<span class="_ _1"></span>.h.</div><div class="t m0 xd h15 y163 ff56 fsb fc3 sc0 ls1 wsaf"> Registers <span class="_ _11"> </span>inBits</div><div class="t m0 xd hd y164 ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will cover just those registers we need to configur<span class="_ _1"></span>e our pins for output, </div><div class="t m0 xd hd y485 ff51 fs7 fc3 sc0 ls1 ws1">then to set the bits to flash the LEDs. If you ar<span class="_ _1"></span>e interested in the full </div><div class="t m0 xd hd y486 ff51 fs7 fc3 sc0 ls1 ws1">functionality, then check the Br<span class="_ _3"></span>oadcom data sheet for the GPIO contr<span class="_ _3"></span>oller<span class="_ _6"></span>.</div><div class="t m0 xc hd y167 ff51 fs7 fc3 sc0 ls1 ws1">Although we’<span class="_ _1"></span>ve mapped these registers to memory locations, they </div><div class="t m0 xd hd y168 ff51 fs7 fc3 sc0 ls1 ws1">don’t always act like memory. Some of the registers ar<span class="_ _3"></span>e write-only and </div><div class="t m0 xd hd y169 ff51 fs7 fc3 sc0 ls1 ws1">if we read them<span class="_ _3"></span>, we won’t crash, but we<span class="_ _3"></span>’ll just r<span class="_ _3"></span>ead some random bits<span class="_ _3"></span>. </div><div class="t m0 xd hd y487 ff51 fs7 fc3 sc0 ls1 ws1">Broadcom defines the pr<span class="_ _1"></span>otocol for interacting with the registers; it<span class="_ _0"></span>’<span class="_ _6"></span>s a good </div><div class="t m0 xd hd y488 ff51 fs7 fc3 sc0 ls1 ws1">idea to follow their documentation exactl<span class="_ _3"></span>y. These aren’t like CPU r<span class="_ _1"></span>e<span class="_ _0"></span>gisters </div><div class="t m0 xd hd y489 ff51 fs7 fc3 sc0 ls1 ws1">or real memory. The circuitry is intercepting o<span class="_ _3"></span>ur memory reads and writes </div><div class="t m0 xd hd y48a ff51 fs7 fc3 sc0 ls1 ws1">to these locations<span class="_ _3"></span>, but only acting on things tha<span class="_ _3"></span>t it understands. I<span class="_ _1"></span>n the </div><div class="t m0 xd hd y48b ff51 fs7 fc3 sc0 ls1 ws1">previous sections<span class="_ _3"></span>, the Linux device driver for GPIO hid all these details </div><div class="t m0 xd hd y48c ff51 fs7 fc3 sc0 ls1 ws1">from us<span class="_ _1"></span>.</div><div class="t m0 xc hd y48d ff51 fs7 fc3 sc0 ls14 ws1">The GPIO registers ar<span class="_ _1"></span>e 32 bits in size. W<span class="_ _1"></span>e can only transfer data between </div><div class="t m0 xd hd y48e ff51 fs7 fc3 sc0 ls14 ws1">these registers and a 32-bit <span class="ff55 ls1">W</span> ver<span class="_ _3"></span>sion of a CPU register<span class="_ _10"></span>. For instance<span class="_ _3"></span>, if X2 </div><div class="t m0 xd hd y48f ff51 fs7 fc3 sc0 ls14 ws1">contains the addres<span class="_ _3"></span>s to a GPIO address and we try to read it with</div><div class="t m0 xd h46 yd0c ff5a fs7 fc3 sc0 ls1 ws1">LDR   X1, [X2]</div><div class="t m0 xc hd yd0d ff51 fs7 fc3 sc0 ls1 ws1">we will get a bus error when we run our program<span class="_ _3"></span>, because the GPIO </div><div class="t m0 xd hd yd0e ff51 fs7 fc3 sc0 ls1 ws1">controller c<span class="_ _3"></span>an’t pro<span class="_ _1"></span>vide 64 bits of data. W<span class="_ _1"></span>e must use</div><div class="t m0 xd h46 yd0f ff5a fs7 fc3 sc0 ls1 ws1">LDR   W1, [X2]</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfcc" class="pf w2 h6" data-page-no="cc"><div class="pc pccc w2 h6"><img class="bi xc yd10 we h49" alt="" src="bgcc.png"/><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">189</div><div class="t m0 xc ha yd11 ff56 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>GPIO Function Select Registers</div><div class="t m0 xc hd yd12 ff51 fs7 fc3 sc0 ls1 ws1">The first thing we need to do is configur<span class="_ _3"></span>e the pins we are using for outp<span class="_ _3"></span>ut. </div><div class="t m0 xc hd yd13 ff51 fs7 fc3 sc0 ls1 ws1">There is a bank of six r<span class="_ _1"></span>egisters to configure all the GPIO pins for input or </div><div class="t m0 xc hd yd14 ff51 fs7 fc3 sc0 ls1 ws1">output. These GPIO function select r<span class="_ _3"></span>egisters are n<span class="_ _3"></span>amed GPSEL0-GPSEL5. </div><div class="t m0 xc hd yd15 ff51 fs7 fc3 sc0 ls1 ws1">Each pin gets 3 bits in one of these registers to configur<span class="_ _1"></span>e it. These are read- </div><div class="t m0 xc hd yd16 ff51 fs7 fc3 sc0 ls1 ws1">write registers<span class="_ _3"></span>. Since each r<span class="_ _3"></span>egister is 32 bits, each one c<span class="_ _3"></span>an contr<span class="_ _3"></span>ol ten pins, </div><div class="t m0 xc hd yd17 ff51 fs7 fc3 sc0 ls1 ws1">with 2 bits left unused (GPSEL5 only controls four pins). T<span class="_ _10"></span>able<span class="fc5">8-1</span> shows </div><div class="t m0 xc hd yd18 ff51 fs7 fc3 sc0 ls1 ws1">the details of each select register<span class="_ _10"></span>.</div><div class="t m0 x1c hd yd19 ff51 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o use these registers, the pr<span class="_ _1"></span>otocol is to</div><div class="t m0 x1c hd yd1a ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Read the register</div><div class="t m0 x1c hd yd1b ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Set the bits for what we want to do</div><div class="t m0 x1c hd yd1c ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Write the value back</div><div class="t m0 x36 h1f yd1d ff56 fse fc3 sc0 ls1 ws1">Note<span class="ff57"> <span class="_ _17"> </span>We must be careful not to affect other bits in the register<span class="_ _10"></span>.</span></div><div class="t m0 x1c hd yd1e ff51 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>able <span class="fc5">8-2</span> shows the bits corres<span class="_ _3"></span>ponding to each pin in the GPSEL1 </div><div class="t m0 xc hd yd1f ff51 fs7 fc3 sc0 ls1 ws1">register<span class="_ _10"></span>.</div><div class="t m0 xc h1c yd20 ff59 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 8-1. <span class="_ _15"> </span><span class="ff52">GPIO function select registers</span></div><div class="t m0 xc h10 yd21 ff56 fs7 fc3 sc0 ls1 ws1">No.<span class="_ _3a"> </span>Address<span class="_ _55"> </span>Name<span class="_ _56"> </span>Pins</div><div class="t m0 xc h10 yd22 ff57 fs7 fc3 sc0 ls1 ws1">0<span class="_ _57"> </span>0xFE200000<span class="_ _48"> </span>GPSEL0<span class="_ _43"> </span>0–9</div><div class="t m0 xc h10 yd23 ff57 fs7 fc3 sc0 ls1 ws1">1<span class="_ _57"> </span>0xFE200004<span class="_ _48"> </span>GPSEL1<span class="_ _43"> </span>10–19</div><div class="t m0 xc h10 yd24 ff57 fs7 fc3 sc0 ls1 ws1">2<span class="_ _57"> </span>0xFE200008<span class="_ _48"> </span>GPSEL2<span class="_ _43"> </span>20–29</div><div class="t m0 xc h10 yd25 ff57 fs7 fc3 sc0 ls1 ws1">3<span class="_ _57"> </span>0xFE20000C<span class="_ _43"> </span>GPSEL3<span class="_ _43"> </span>30–39</div><div class="t m0 xc h10 yd26 ff57 fs7 fc3 sc0 ls1 ws1">4<span class="_ _57"> </span>0xFE200010<span class="_ _48"> </span>GPSEL4<span class="_ _43"> </span>40–49</div><div class="t m0 xc h10 yd27 ff57 fs7 fc3 sc0 ls1 ws1">5<span class="_ _57"> </span>0xFE200014<span class="_ _48"> </span>GPSEL5<span class="_ _43"> </span>50–53</div><div class="t m0 x4a h12 yd28 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfcc" data-dest-detail='[204,"XYZ",53,437,null]'><div class="d m1" style="border-style:none;position:absolute;left:344.539000px;bottom:468.518000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfcd" data-dest-detail='[205,"XYZ",136,590,null]'><div class="d m1" style="border-style:none;position:absolute;left:99.730600px;bottom:101.370000px;width:15.048400px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfcd" class="pf w2 h6" data-page-no="cd"><div class="pc pccd w2 h6"><img class="bi x4c yd29 w12 h3c" alt="" src="bgcd.png"/><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">190</div><div class="t m0 xc hd yd2a ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e store 000in the 3 bits if we want to input fr<span class="_ _1"></span>om the pin, and we store </div><div class="t m0 xd hd yd2b ff51 fs7 fc3 sc0 ls1 ws1">001in the bits if we want to write to the pin.</div><div class="t m0 xd ha yd2c ff56 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>GPIO Output Set andClear Registers</div><div class="t m0 xd hd yd2d ff51 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e tw<span class="_ _0"></span>o r<span class="_ _3"></span>egisters for setting pins<span class="_ _3"></span>, then two registers to clear them<span class="_ _3"></span>. </div><div class="t m0 xd hd yd2e ff51 fs7 fc3 sc0 ls1 ws1">The first regist<span class="_ _3"></span>er controls the firs<span class="_ _3"></span>t 32 pins<span class="_ _0"></span>; then the second controls the </div><div class="t m0 xd hd yd2f ff51 fs7 fc3 sc0 ls1 ws1">remainin<span class="_ _3"></span>g 22 pins. T<span class="_ _10"></span>able<span class="fc5">8-3</span> shows the details of these registers<span class="_ _1"></span>.</div><div class="t m0 x4c h1c yd30 ff59 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 8-2. <span class="_ _15"> </span><span class="ff52">Pin number </span></div><div class="t m0 x4c h1c yd31 ff52 fs3 fc3 sc0 ls1 ws1">and corresponding bits </div><div class="t m0 x4c h1c yd32 ff52 fs3 fc3 sc0 ls1 ws1">for the GPSEL1 register</div><div class="t m0 x4c h10 yd33 ff56 fs7 fc3 sc0 ls1 ws1">Pin No.<span class="_ _41"> </span>GPSEL1 Bits</div><div class="t m0 x4c h10 yd34 ff57 fs7 fc3 sc0 ls1 ws1">10<span class="_ _58"> </span>0–2</div><div class="t m0 x4c h10 yd35 ff57 fs7 fc3 sc0 ls1 ws1">11<span class="_ _58"> </span>3–5</div><div class="t m0 x4c h10 yd36 ff57 fs7 fc3 sc0 ls1 ws1">12<span class="_ _58"> </span>6–8</div><div class="t m0 x4c h10 yd37 ff57 fs7 fc3 sc0 ls1 ws1">13<span class="_ _58"> </span>9–11</div><div class="t m0 x4c h10 yd38 ff57 fs7 fc3 sc0 ls1 ws1">14<span class="_ _58"> </span>12–14</div><div class="t m0 x4c h10 yd39 ff57 fs7 fc3 sc0 ls1 ws1">15<span class="_ _58"> </span>15–17</div><div class="t m0 x4c h10 yd3a ff57 fs7 fc3 sc0 ls1 ws1">16<span class="_ _58"> </span>18–20</div><div class="t m0 x4c h10 yd3b ff57 fs7 fc3 sc0 ls1 ws1">17<span class="_ _58"> </span>21–23</div><div class="t m0 x4c h10 yd3c ff57 fs7 fc3 sc0 ls1 ws1">18<span class="_ _58"> </span>24–26</div><div class="t m0 x4c h10 yd3d ff57 fs7 fc3 sc0 ls1 ws1">19<span class="_ _58"> </span>27–29</div><div class="t m0 xd h12 y668 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfce" data-dest-detail='[206,"XYZ",115,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:152.763000px;bottom:167.579000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfce" class="pf w2 h6" data-page-no="ce"><div class="pc pcce w2 h6"><img class="bi x4d y64d w13 h2f" alt="" src="bgce.png"/><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">191</div><div class="t m0 x1c hd yd3e ff51 fs7 fc3 sc0 ls1 ws1">These registers ar<span class="_ _1"></span>e wr<span class="_ _0"></span>ite-only. Y<span class="_ _6"></span>ou should set the bit for the register </div><div class="t m0 xc hd yd3f ff51 fs7 fc3 sc0 ls1 ws1">you want (with all the other bits 0) and write that bit<span class="_ _3"></span>. Reading these </div><div class="t m0 xc hd yd40 ff51 fs7 fc3 sc0 ls1 ws1">registers is meaningles<span class="_ _3"></span>s.</div><div class="t m0 x1c hd yd41 ff51 fs7 fc3 sc0 ls1 ws1">The Broadcom da<span class="_ _3"></span>tasheet states this as a featur<span class="_ _1"></span>e, in that they sa<span class="_ _3"></span>ve you </div><div class="t m0 xc hd yd42 ff51 fs7 fc3 sc0 ls1 ws1">reading the r<span class="_ _1"></span>egister first, then it’<span class="_ _1"></span>s easier to just set a single bit, th<span class="_ _3"></span>an edit </div><div class="t m0 xc hd yd43 ff51 fs7 fc3 sc0 ls1 ws1">a bit in a sequence of bits. Ho<span class="_ _3"></span>wever<span class="_ _6"></span>, it could also be that this sa<span class="_ _1"></span>ved them </div><div class="t m0 xc hd yd44 ff51 fs7 fc3 sc0 ls1 ws1">some circuitry and reduced the cost of the contr<span class="_ _3"></span>oller chip<span class="_ _1"></span>.</div><div class="t m0 xc h15 yd45 ff56 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>More Flashing LEDs</div><div class="t m0 xc hd yd46 ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll now repea<span class="_ _3"></span>t our flashing LEDs pr<span class="_ _3"></span>ogram, b<span class="_ _3"></span>ut this time we’ll use </div><div class="t m0 xc hd yd47 ff51 fs7 fc3 sc0 ls1 ws1">mapped memory and access the GPIO’<span class="_ _1"></span>s registers dir<span class="_ _3"></span>ectly. Firs<span class="_ _3"></span>t of all, the </div><div class="t m0 xc hd yd48 ff51 fs7 fc3 sc0 ls1 ws1">macros th<span class="_ _3"></span>at do the nitty-gritty work fr<span class="_ _3"></span>om Listing <span class="fc5">8-3</span> go in gpiomem.S<span class="_ _1"></span>.</div><div class="t m0 xc h20 yd49 ff59 fs3 fc3 sc0 ls1 ws1">Listing 8-3. <span class="_ _15"> </span><span class="ff51">GPIO support macros usin<span class="_ _3"></span>g mapped memory</span></div><div class="t m0 xc h46 yd4a ff5a fs7 fc3 sc0 ls1 ws1">// Various macros to access the GPIO pins</div><div class="t m0 xc h46 yd4b ff5a fs7 fc3 sc0 ls1 ws1">// on the Raspberry Pi.</div><div class="t m0 xc h46 yd4c ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 yd4d ff5a fs7 fc3 sc0 ls1 ws1">// X9 - memory map address.</div><div class="t m0 xc h46 yd4e ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 yd4f ff5a fs7 fc3 sc0 ls1 ws1">#include &quot;fileio.S&quot;</div><div class="t m0 x4d h1c yd50 ff59 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 8-3. <span class="_ _15"> </span><span class="ff52">The GP set and clear pin register<span class="_ _3"></span>s</span></div><div class="t m0 x4d h10 yd51 ff56 fs7 fc3 sc0 ls1 ws1">No.<span class="_ _59"> </span>Address<span class="_ _53"> </span>Name<span class="_ _5a"> </span>Pins</div><div class="t m0 x4d h10 yd52 ff57 fs7 fc3 sc0 ls1 ws1">0<span class="_ _5b"> </span>0xFE20001C<span class="_ _2e"> </span>GPSET0<span class="_ _5c"> </span>0–31</div><div class="t m0 x4d h10 yd53 ff57 fs7 fc3 sc0 ls1 ws1">1<span class="_ _5b"> </span>0xFE200020<span class="_ _5b"> </span>GPSET1<span class="_ _5d"> </span>32–53</div><div class="t m0 x4d h10 yd54 ff57 fs7 fc3 sc0 ls1 ws1">2<span class="_ _5b"> </span>0xFE200028<span class="_ _5b"> </span>GPCLR0<span class="_ _5e"> </span>0–31</div><div class="t m0 x4d h10 yd55 ff57 fs7 fc3 sc0 ls1 ws1">3<span class="_ _5b"> </span>0xFE20002C<span class="_ _2e"> </span>GPCLR1<span class="_ _5f"> </span>32–53</div><div class="t m0 x4a h12 y668 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfce" data-dest-detail='[206,"XYZ",53,221,null]'><div class="d m1" style="border-style:none;position:absolute;left:280.201000px;bottom:235.162000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfcf" class="pf w2 h6" data-page-no="cf"><div class="pc pccf w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">192</div><div class="t m0 xd h46 y46b ff5a fs7 fc3 sc0 ls1 ws1">.equ   pagelen, 4096</div><div class="t m0 xd h46 y46c ff5a fs7 fc3 sc0 ls1 ws1">.equ   setregoffset, 28</div><div class="t m0 xd h46 y46d ff5a fs7 fc3 sc0 ls1 ws1">.equ   clrregoffset, 40</div><div class="t m0 xd h46 y623 ff5a fs7 fc3 sc0 ls1 ws1">.equ   PROT_READ, 1</div><div class="t m0 xd h46 y624 ff5a fs7 fc3 sc0 ls1 ws1">.equ   PROT_WRITE, 2</div><div class="t m0 xd h46 y625 ff5a fs7 fc3 sc0 ls1 ws1">.equ   MAP_SHARED, 1</div><div class="t m0 xd h46 y85e ff5a fs7 fc3 sc0 ls1 ws1">// Macro to map memory for GPIO Registers</div><div class="t m0 xd h46 y847 ff5a fs7 fc3 sc0 ls1 ws1">.macro mapMem</div><div class="t m0 xd h46 y85f ff5a fs7 fc3 sc0 ls1 ws1">       openFile     devmem, O_O_RDWR+O_EXCL // open /dev/mem</div><div class="t m0 xd h46 y629 ff5a fs7 fc3 sc0 ls1 ws1">       ADDS         X4, XZR, X0  // fd for memmap</div><div class="t m0 xd h46 y62a ff5a fs7 fc3 sc0 ls1 ws1">       // check for error and print error msg if necessary</div><div class="t m0 xd h46 y62b ff5a fs7 fc3 sc0 ls1 ws1">       B.PL         1f  // pos number file opened ok</div><div class="t m0 xd h46 y9f9 ff5a fs7 fc3 sc0 ls1 ws1">       MOV          X1, #1  // stdout</div><div class="t m0 xd h46 y9fa ff5a fs7 fc3 sc0 ls1 ws1">       LDR          X2, =memOpnsz     // Error msg</div><div class="t m0 xd h46 y9fb ff5a fs7 fc3 sc0 ls1 ws1">       LDR          W2, [X2]</div><div class="t m0 xd h46 y9fc ff5a fs7 fc3 sc0 ls1 ws1">       writeFile    X1, memOpnErr, X2 // print the error</div><div class="t m0 xd h46 y9fd ff5a fs7 fc3 sc0 ls1 ws1">       B            _end</div><div class="t m0 xd h46 yc41 ff5a fs7 fc3 sc0 ls1 ws1">// Setup can call the mmap2 Linux service</div><div class="t m0 xd h46 yc42 ff5a fs7 fc3 sc0 ls1 ws1">1:     ldr          X5, =gpioaddr      // ad<span class="_ _3"></span>dr<span class="_ _3"></span>es<span class="_ _3"></span>s <span class="_ _1"></span>we w<span class="_ _3"></span>an<span class="_ _1"></span>t / <span class="_ _1"></span>4096</div><div class="t m0 xd h46 ya18 ff5a fs7 fc3 sc0 ls1 ws1">       ldr          X5, [X5]           // load the address</div><div class="t m0 xd h46 ya01 ff5a fs7 fc3 sc0 ls1 ws1">       mov          X1, #pagelen       // size of mem we want</div><div class="t m0 xd h46 ya02 ff5a fs7 fc3 sc0 ls1 ws1">       // mem protection options</div><div class="t m0 xd h46 ya03 ff5a fs7 fc3 sc0 ls1 ws1">       mov          X2, #(PROT_READ + PROT_WRITE)</div><div class="t m0 xd h46 ya04 ff5a fs7 fc3 sc0 ls1 ws1">       mov          X3, #MAP_SHARED    // mem share options</div><div class="t m0 xd h46 ya05 ff5a fs7 fc3 sc0 ls1 ws1">       // let linux choose a virtual address</div><div class="t m0 xd h46 ya06 ff5a fs7 fc3 sc0 ls1 ws1">       mov          X0, #0</div><div class="t m0 xd h46 yd56 ff5a fs7 fc3 sc0 ls1 ws1">       mov          X8, #__NR_mmap     // mmap service num</div><div class="t m0 xd h46 yd57 ff5a fs7 fc3 sc0 ls1 ws1">       svc          0                  // call service</div><div class="t m0 xd h46 yd58 ff5a fs7 fc3 sc0 ls1 ws1">       // keep the returned virtual address</div><div class="t m0 xd h46 yd59 ff5a fs7 fc3 sc0 ls1 ws1">       ADDS         X9, XZR, X0</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd0" class="pf w2 h6" data-page-no="d0"><div class="pc pcd0 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">193</div><div class="t m0 xc h46 y46b ff5a fs7 fc3 sc0 ls1 ws1">       // check for error and print error msg if necessary</div><div class="t m0 xc h46 y46c ff5a fs7 fc3 sc0 ls1 ws1">       B.PL         2f  // pos number file opened ok</div><div class="t m0 xc h46 y46d ff5a fs7 fc3 sc0 ls1 ws1">       MOV          X1, #1  // stdout</div><div class="t m0 xc h46 y623 ff5a fs7 fc3 sc0 ls1 ws1">       LDR          X2, =memMapsz      // Error msg</div><div class="t m0 xc h46 y624 ff5a fs7 fc3 sc0 ls1 ws1">       LDR          W2, [X2]</div><div class="t m0 xc h46 y625 ff5a fs7 fc3 sc0 ls1 ws1">       writeFile    X1, memMapErr, X2  // print the error</div><div class="t m0 xc h46 y626 ff5a fs7 fc3 sc0 ls1 ws1">       B            _end</div><div class="t m0 xc h46 y627 ff5a fs7 fc3 sc0 ls1 ws1">2:</div><div class="t m0 xc h46 y628 ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xc h46 y629 ff5a fs7 fc3 sc0 ls1 ws1">// Macro nanoSleep to sleep .1 second</div><div class="t m0 xc h46 y62a ff5a fs7 fc3 sc0 ls1 ws1">// Calls Linux nanosleep entry point which is function 162.</div><div class="t m0 xc h46 y62b ff5a fs7 fc3 sc0 ls1 ws1">// Pass a reference to a timespec in both X0 and X1</div><div class="t m0 xc h46 y9f9 ff5a fs7 fc3 sc0 ls1 ws1">// First is input time to sleep in seconds and nanoseconds.</div><div class="t m0 xc h46 y9fa ff5a fs7 fc3 sc0 ls12 ws1">// Second is time left to sleep if interrupted (which we ignore)</div><div class="t m0 xc h46 y9fb ff5a fs7 fc3 sc0 ls1 ws1">.macro  nanoSleep</div><div class="t m0 xc h46 y9fc ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X0, =timespecsec</div><div class="t m0 xc h46 y9fd ff5a fs7 fc3 sc0 ls1 ws1">        ldr         X1, =timespecsec</div><div class="t m0 xc h46 y9fe ff5a fs7 fc3 sc0 ls1 ws1">        mov         X8, #__NR_nanosleep</div><div class="t m0 xc h46 y9ff ff5a fs7 fc3 sc0 ls1 ws1">        svc         0</div><div class="t m0 xc h46 ya00 ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xc h46 yd5a ff5a fs7 fc3 sc0 ls1 ws1">.macro  GPIODirectionOut   pin</div><div class="t m0 xc h46 yd5b ff5a fs7 fc3 sc0 ls1 ws1">      ldr    X2, =\pin     // offset of select register</div><div class="t m0 xc h46 yd5c ff5a fs7 fc3 sc0 ls1 ws1">      ldr    W2, [X2]      // load the value</div><div class="t m0 xc h46 yd5d ff5a fs7 fc3 sc0 ls1 ws1">      ldr    W1, [X9, X2]  // address of register</div><div class="t m0 xc h46 yd5e ff5a fs7 fc3 sc0 ls1 ws1">      ldr    X3, =\pin     // address of pin table</div><div class="t m0 xc h46 yd5f ff5a fs7 fc3 sc0 ls1 ws1">      add    X3, X3, #4    // load amount to shift from table</div><div class="t m0 xc h46 yd60 ff5a fs7 fc3 sc0 ls1 ws1">      ldr    W3, [X3]      // load value of shift amt</div><div class="t m0 xc h46 yc29 ff5a fs7 fc3 sc0 ls1 ws1">      mov    X0, #0b111    // mask to clear 3 bits</div><div class="t m0 xc h46 yc2a ff5a fs7 fc3 sc0 ls1 ws1">      lsl    X0, X0, X3    // shift into position</div><div class="t m0 xc h46 yc2b ff5a fs7 fc3 sc0 ls1 ws1">      bic    X1, X1, X0    // clear the three bits</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd1" class="pf w2 h6" data-page-no="d1"><div class="pc pcd1 w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">194</div><div class="t m0 xd h46 y46b ff5a fs7 fc3 sc0 ls1 ws1">      mov    X0, #1        // 1 bit to shift into pos</div><div class="t m0 xd h46 y46c ff5a fs7 fc3 sc0 ls1 ws1">      lsl    X0, X0, X3    // shift by amount from table</div><div class="t m0 xd h46 y46d ff5a fs7 fc3 sc0 ls1 ws1">      orr    X1, X1, X0    // set the bit</div><div class="t m0 xd h46 y623 ff5a fs7 fc3 sc0 ls1 ws1">      str    W1, [X9, X2]  // save it to register to do work</div><div class="t m0 xd h46 y624 ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xd h46 y625 ff5a fs7 fc3 sc0 ls1 ws1">.macro  GPIOTurnOn   pin, value</div><div class="t m0 xd h46 y626 ff5a fs7 fc3 sc0 ls1 ws1">      mov    X2, X9        // address of gpio regs</div><div class="t m0 xd h46 y627 ff5a fs7 fc3 sc0 ls1 ws1">      add    X2, X2, #setregoffset // off to set reg</div><div class="t m0 xd h46 y628 ff5a fs7 fc3 sc0 ls1 ws1">      mov    X0, #1        // 1 bit to shift into pos</div><div class="t m0 xd h46 y9f6 ff5a fs7 fc3 sc0 ls1 ws1">      ldr    X3, =\pin     // base of pin info table</div><div class="t m0 xd h46 y9f7 ff5a fs7 fc3 sc0 ls1 ws1">      add    X3, X3, #8    // add offset for shift amt</div><div class="t m0 xd h46 y9f8 ff5a fs7 fc3 sc0 ls1 ws1">      ldr    W3, [X3]      // load shift from table</div><div class="t m0 xd h46 yb8d ff5a fs7 fc3 sc0 ls1 ws1">      lsl    X0, X0, X3    // do the shift</div><div class="t m0 xd h46 yb8e ff5a fs7 fc3 sc0 ls1 ws1">      str    W0, [X2]      // write to the register</div><div class="t m0 xd h46 yb8f ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xd h46 yb90 ff5a fs7 fc3 sc0 ls1 ws1">.macro  GPIOTurnOff   pin, value</div><div class="t m0 xd h46 yb91 ff5a fs7 fc3 sc0 ls1 ws1">      mov    X2, X9        // address of gpio regs</div><div class="t m0 xd h46 yc1f ff5a fs7 fc3 sc0 ls1 ws1">      add    X2, X2, #clrregoffset // off set of clr reg</div><div class="t m0 xd h46 yc20 ff5a fs7 fc3 sc0 ls1 ws1">      mov    X0, #1        // 1 bit to shift into pos</div><div class="t m0 xd h46 yc21 ff5a fs7 fc3 sc0 ls1 ws1">      ldr    X3, =\pin     // base of pin info table</div><div class="t m0 xd h46 yc22 ff5a fs7 fc3 sc0 ls1 ws1">      add    X3, X3, #8    // add offset for shift amt</div><div class="t m0 xd h46 yc23 ff5a fs7 fc3 sc0 ls1 ws1">      ldr    W3, [X3]      // load shift from table</div><div class="t m0 xd h46 yc24 ff5a fs7 fc3 sc0 ls1 ws1">      lsl    X0, X0, X3    // do the shift</div><div class="t m0 xd h46 yc25 ff5a fs7 fc3 sc0 ls1 ws1">      str    W0, [X2]      // write to the register</div><div class="t m0 xd h46 yc26 ff5a fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xd h46 yd5f ff5a fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h46 yd60 ff5a fs7 fc3 sc0 ls1 ws1">timespecsec:   .dword   0</div><div class="t m0 xd h46 yc29 ff5a fs7 fc3 sc0 ls1 ws1">timespecnano:  .dword   100000000</div><div class="t m0 xd h46 yc2a ff5a fs7 fc3 sc0 ls1 ws1">//devmem:       .asciz  &quot;/dev/gpiomem&quot;</div><div class="t m0 xd h46 yc2b ff5a fs7 fc3 sc0 ls1 ws1">devmem:         .asciz  &quot;/dev/mem&quot;</div><div class="t m0 xd h46 yc2c ff5a fs7 fc3 sc0 ls1 ws1">memOpnErr:     .asciz  &quot;Failed to open /dev/mem\n&quot;</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd2" class="pf w2 h6" data-page-no="d2"><div class="pc pcd2 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">195</div><div class="t m0 xc h46 y46b ff5a fs7 fc3 sc0 ls1 ws1">memOpnsz:      .word  .-memOpnErr</div><div class="t m0 xc h46 y46c ff5a fs7 fc3 sc0 ls1 ws1">memMapErr:     .asciz  &quot;Failed to map memory\n&quot;</div><div class="t m0 xc h46 y46d ff5a fs7 fc3 sc0 ls1 ws1">memMapsz:      .word  .-memMapErr</div><div class="t m0 xc h46 y623 ff5a fs7 fc3 sc0 ls1 ws1">               .align  4 // relign after strings</div><div class="t m0 xc h46 y624 ff5a fs7 fc3 sc0 ls1 ws1">//gpioaddr:      .dword   0x0      // mem address for gpiomem</div><div class="t m0 xc h46 yc46 ff5a fs7 fc3 sc0 ls1 ws1">gpioaddr:      .dword   0xFE200000         <span class="_ _20"></span>// mem address of </div><div class="t m0 x4e h46 y626 ff5a fs7 fc3 sc0 ls1 ws1">gpio registers</div><div class="t m0 xc h46 y627 ff5a fs7 fc3 sc0 ls1 ws1">pin17:         .word   4   // offset to select register</div><div class="t m0 xc h46 yc47 ff5a fs7 fc3 sc0 ls1 ws1">               .word   21  // bit offset in select register</div><div class="t m0 xc h46 yd61 ff5a fs7 fc3 sc0 ls1 ws1">               .word   17  // bit offset in set &amp; clr register</div><div class="t m0 xc h46 yd62 ff5a fs7 fc3 sc0 ls1 ws1">pin22:         .word   8   // offset to select register</div><div class="t m0 xc h46 yd63 ff5a fs7 fc3 sc0 ls1 ws1">               .word   6  // bit offset in select register</div><div class="t m0 xc h46 yb8d ff5a fs7 fc3 sc0 ls1 ws1">               .word   22  // bit offset in set &amp; clr register</div><div class="t m0 xc h46 yb8e ff5a fs7 fc3 sc0 ls1 ws1">pin27:         .word   8   // offset to select register</div><div class="t m0 xc h46 yd64 ff5a fs7 fc3 sc0 ls1 ws1">               .word   21  // bit offset in select register</div><div class="t m0 xc h46 yd65 ff5a fs7 fc3 sc0 ls1 ws1">               .word   27  // bit offset in set &amp; clr register</div><div class="t m0 xc h46 yc56 ff5a fs7 fc3 sc0 ls1 ws1">.text</div><div class="t m0 x1c hd yd66 ff51 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w the driving program m<span class="_ _3"></span>ainmem.S containin<span class="_ _3"></span>g Listing <span class="fc5">8-4</span>, which is </div><div class="t m0 xc hd yd67 ff51 fs7 fc3 sc0 ls1 ws1">quite similar to the last one. T<span class="_ _3"></span>he main differ<span class="_ _3"></span>ences are in the macr<span class="_ _1"></span>os.</div><div class="t m0 xc h20 yd68 ff59 fs3 fc3 sc0 ls1 ws1">Listing 8-4. <span class="_ _15"> </span><span class="ff51">Main pr<span class="_ _1"></span>ogram for the memor<span class="_ _0"></span>y ma<span class="_ _3"></span>pped flashing lights</span></div><div class="t m0 xc h46 yd69 ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 yd6a ff5a fs7 fc3 sc0 ls1 ws1">// Assembler program to flash three LEDs connected to the</div><div class="t m0 xc h46 yd6b ff5a fs7 fc3 sc0 ls1 ws1">// Raspberry Pi GPIO port using direct memory access.</div><div class="t m0 xc h46 yd6c ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 yd6d ff5a fs7 fc3 sc0 ls1 ws1">// W6 - loop variable to flash lights 10 times</div><div class="t m0 xc h46 yd6e ff5a fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h46 yd6f ff5a fs7 fc3 sc0 ls1 ws1">#include &quot;gpiomem.S&quot;</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfd2" data-dest-detail='[210,"XYZ",53,259,null]'><div class="d m1" style="border-style:none;position:absolute;left:338.141000px;bottom:289.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd3" class="pf w2 h6" data-page-no="d3"><div class="pc pcd3 w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">196</div><div class="t m0 xd h46 y46b ff5a fs7 fc3 sc0 ls1 ws1">.global _start      // Provide program starting address</div><div class="t m0 xd h46 y46c ff5a fs7 fc3 sc0 ls1 ws1">_start: mapMem</div><div class="t m0 xd h46 y46d ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xd h46 y85c ff5a fs7 fc3 sc0 ls1 ws1">        GPIODirectionOut pin17</div><div class="t m0 xd h46 y46f ff5a fs7 fc3 sc0 ls1 ws1">        GPIODirectionOut pin27</div><div class="t m0 xd h46 y85d ff5a fs7 fc3 sc0 ls1 ws1">        GPIODirectionOut pin22</div><div class="t m0 xd h46 y85e ff5a fs7 fc3 sc0 ls1 ws1">        // setup a loop counter for 10 iterations</div><div class="t m0 xd h46 y847 ff5a fs7 fc3 sc0 ls1 ws1">        mov         W6, #10</div><div class="t m0 xd h46 y848 ff5a fs7 fc3 sc0 ls1 ws1">loop:   GPIOTurnOn   pin17</div><div class="t m0 xd h46 y849 ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xd h46 y84a ff5a fs7 fc3 sc0 ls1 ws1">        GPIOTurnOff   pin17</div><div class="t m0 xd h46 y84b ff5a fs7 fc3 sc0 ls1 ws1">        GPIOTurnOn    pin27</div><div class="t m0 xd h46 y62c ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xd h46 y860 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOTurnOff   pin27</div><div class="t m0 xd h46 y861 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOTurnOn    pin22</div><div class="t m0 xd h46 yc3f ff5a fs7 fc3 sc0 ls1 ws1">        nanoSleep</div><div class="t m0 xd h46 yc40 ff5a fs7 fc3 sc0 ls1 ws1">brk1:</div><div class="t m0 xd h46 yc41 ff5a fs7 fc3 sc0 ls1 ws1">        GPIOTurnOff   pin22</div><div class="t m0 xd h46 yc42 ff5a fs7 fc3 sc0 ls1 ws1">        //decrement loop counter and see if we loop</div><div class="t m0 xd h46 ya18 ff5a fs7 fc3 sc0 lsd wsb0">        // Subtract 1 from loop register <span class="_ _3"></span>setting status register</div><div class="t m0 xd h46 ya01 ff5a fs7 fc3 sc0 ls1 ws1">        subs    W6, W6, #1</div><div class="t m0 xd h46 ya02 ff5a fs7 fc3 sc0 ls1 ws1">        // If we haven&apos;t counted down to 0 then loop</div><div class="t m0 xd h46 ya03 ff5a fs7 fc3 sc0 ls1 ws1">        b.ne     loop</div><div class="t m0 xd h46 y856 ff5a fs7 fc3 sc0 ls1 ws1">_end:   mov     X0, #0      // Use 0 return code</div><div class="t m0 xd h46 y857 ff5a fs7 fc3 sc0 ls1 ws1">        mov     X8, #__NR_exit</div><div class="t m0 xd h46 y858 ff5a fs7 fc3 sc0 ls1 ws1">        svc     0           // Linus command to terminate</div><div class="t m0 xc hd yd70 ff51 fs7 fc3 sc0 ls1 ws1">The main pr<span class="_ _3"></span>ogram is the same as the first example<span class="_ _1"></span>, except that it </div><div class="t m0 xd hd yd71 ff51 fs7 fc3 sc0 ls1 ws1">includes a differen<span class="_ _3"></span>t set of macros<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd4" class="pf w2 h6" data-page-no="d4"><div class="pc pcd4 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">197</div><div class="t m0 x1c hd y145 ff51 fs7 fc3 sc0 ls1 ws1">The first thing we need to do is call the mapM<span class="_ _1"></span>em macro<span class="_ _1"></span>. This opens /</div><div class="t m0 xc hd y146 ff51 fs7 fc3 sc0 ls1 ws1">dev/mem and sets up and calls the mmap service as we des<span class="_ _0"></span>cribed in the </div><div class="t m0 xc hd y147 ff51 fs7 fc3 sc0 ls1 ws1">section “In Devices, E<span class="_ _3"></span>verything Is Memory.<span class="_ _8"></span>” W<span class="_ _3"></span>e stor<span class="_ _3"></span>e the returned addr<span class="_ _3"></span>ess </div><div class="t m0 xc hd y1b0 ff51 fs7 fc3 sc0 ls1 ws1">into <span class="ff55">X9</span>, so that it is easily acces<span class="_ _3"></span>sible from the r<span class="_ _3"></span>est of the macr<span class="_ _3"></span>os. T<span class="_ _3"></span>here is </div><div class="t m0 xc hd y1b1 ff51 fs7 fc3 sc0 ls1 ws1">error checking on the file open and mma<span class="_ _3"></span>p calls since these can fail.</div><div class="t m0 xc ha y164 ff56 fs6 fc3 sc0 ls1 wsb1"> Root <span class="_ _14"> </span>Access</div><div class="t m0 xc hd y6b7 ff51 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o access /dev/mem, you need root access<span class="_ _1"></span>, so r<span class="_ _0"></span>un this pr<span class="_ _3"></span>ogram with root </div><div class="t m0 xc hd yd72 ff51 fs7 fc3 sc0 ls1 ws1">access via</div><div class="t m0 xc h46 yd73 ff5a fs7 fc3 sc0 ls1 ws1">sudo ./flashmem</div><div class="t m0 x1c hd yd74 ff51 fs7 fc3 sc0 ls1 ws1">If you don’t, then the file open will fail. Accessing /dev/mem is v<span class="_ _3"></span>ery </div><div class="t m0 xc hd yd75 ff51 fs7 fc3 sc0 ls1 ws1">powerful and gives you access to all memory and all hardwar<span class="_ _3"></span>e devices.</div><div class="t m0 x1c hd yd76 ff51 fs7 fc3 sc0 ls1d ws1">This is a restricted opera<span class="_ _3"></span>tion, so we need to be root. Pr<span class="_ _3"></span>ograms tha<span class="_ _3"></span>t </div><div class="t m0 xc hd yd77 ff51 fs7 fc3 sc0 ls1d ws1">directly access memory are usually implemen<span class="_ _3"></span>ted as Linux device drivers or </div><div class="t m0 xc hd yd78 ff51 fs7 fc3 sc0 ls1d ws1">kernel loadable modules<span class="_ _3"></span>, but then installing these also requir<span class="_ _1"></span>es root access. </div><div class="t m0 xc hd yd79 ff51 fs7 fc3 sc0 ls1d ws1">A virus or other malware would lo<span class="_ _1"></span>ve to have access to all ph<span class="_ _3"></span>ysical memory.</div><div class="t m0 x1c hd yd7a ff51 fs7 fc3 sc0 ls1 ws1">There is a mor<span class="_ _1"></span>e restricted version, /dev/gpiomem. This is a safer file </div><div class="t m0 xc hd yd7b ff51 fs7 fc3 sc0 ls1 ws1">to use, since it will only ret<span class="_ _3"></span>urn the mapping for the GPIO addr<span class="_ _1"></span>ess<span class="_ _0"></span>es<span class="_ _1"></span>. It has </div><div class="t m0 xc hd yd7c ff51 fs7 fc3 sc0 ls1 ws1">the additional benefit that y<span class="_ _3"></span>ou don’t need to know the physical addr<span class="_ _1"></span>ess of </div><div class="t m0 xc hd yd7d ff51 fs7 fc3 sc0 ls1 ws1">the GPIO registers<span class="_ _1"></span>. If you use this file instead of /dev/mem, then the only </div><div class="t m0 xc hd yd7e ff51 fs7 fc3 sc0 ls1 ws1">other change you need to mak<span class="_ _3"></span>e is to set gpioaddr to 0, since this file knows </div><div class="t m0 xc hd yd7f ff51 fs7 fc3 sc0 ls1 ws1">the address<span class="_ _1"></span>. Kali Linux still requir<span class="_ _3"></span>es root access for this file<span class="_ _1"></span>, but some other </div><div class="t m0 xc hd yd80 ff51 fs7 fc3 sc0 ls1 ws1">Linux distributions allow user progr<span class="_ _3"></span>ams to access it. The code for this is </div><div class="t m0 xc hd yd81 ff51 fs7 fc3 sc0 ls1 ws1">pro<span class="_ _3"></span>vided in the listing but commented out<span class="_ _3"></span>.</div><div class="t m0 xc ha y577 ff56 fs6 fc3 sc0 ls1 wsb1"> T<span class="_ _10"></span>able <span class="_ _14"> </span>Driven</div><div class="t m0 xc hd yd82 ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e won’t cover multiplication or division un<span class="_ _3"></span>til Chapter <span class="fc5">11</span>, “M<span class="_ _1"></span>ultiply, </div><div class="t m0 xc hd yd83 ff51 fs7 fc3 sc0 ls1 ws1">Divide, and A<span class="_ _3"></span>ccumulate<span class="_ _3"></span>”; without these, it’<span class="_ _6"></span>s hard to compute the pin </div><div class="t m0 xc hd yd84 ff51 fs7 fc3 sc0 ls1 ws1">offsets inside these registers<span class="_ _3"></span>. Division is a slow opera<span class="_ _3"></span>tion and Assembly </div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:313.389000px;bottom:113.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd5" class="pf w2 h6" data-page-no="d5"><div class="pc pcd5 w2 h6"><img class="bi xd yd85 w7 h38" alt="" src="bgd5.png"/><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">198</div><div class="t m0 xd hd y275 ff51 fs7 fc3 sc0 ls1 ws1">Language pr<span class="_ _3"></span>ogrammers tend to a<span class="_ _1"></span>void it. The common workaround is to </div><div class="t m0 xd hd y276 ff51 fs7 fc3 sc0 ls1 ws1">use a table of precomputed v<span class="_ _3"></span>alues, r<span class="_ _3"></span>ather than calc<span class="_ _3"></span>ulating the values as we </div><div class="t m0 xd hd y277 ff51 fs7 fc3 sc0 ls1 ws1">need them. A table look<span class="_ _3"></span>up is very fast, and we examined all the features </div><div class="t m0 xd hd y278 ff51 fs7 fc3 sc0 ls1 ws1">in the ARM instruction set to help us do this in Chapter <span class="fc5">5</span>, “Thanks for the </div><div class="t m0 xd hd y279 ff51 fs7 fc3 sc0 ls1 ws1">Memories.<span class="_ _8"></span>”</div><div class="t m0 xc hd y27a ff51 fs7 fc3 sc0 ls1 ws1">For e<span class="_ _3"></span>ach pin, we pro<span class="_ _3"></span>vide three values in the .<span class="ff55 ls1d wsce">data</span> section:</div><div class="t m0 xc hd yd86 ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>The offset to the select register (from the base </div><div class="t m0 x1e hd yd87 ff51 fs7 fc3 sc0 ls1 ws1">memory address)</div><div class="t m0 xc hd yd88 ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>The bit offset in select register for this pin</div><div class="t m0 xc hd yd89 ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>The bit offset in set &amp; clr register</div><div class="t m0 xc hd yd8a ff51 fs7 fc3 sc0 ls1 ws1">With these in hand, accessing and m<span class="_ _3"></span>anipulating the GPIO con<span class="_ _3"></span>trol </div><div class="t m0 xd hd yd8b ff51 fs7 fc3 sc0 ls1 ws1">registers is a sn<span class="_ _3"></span>ap<span class="_ _1"></span>.</div><div class="t m0 x34 h1f yd8c ff56 fse fc3 sc0 ls1 ws1">Note<span class="ff57"> <span class="_ _17"> </span>We only populate these tables for the three pins we use.</span></div><div class="t m0 xd ha yd8d ff56 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Setting Pin Direction</div><div class="t m0 xd hd yd8e ff51 fs7 fc3 sc0 ls1 ws1">Start with loading the offset of the selection register for our pin—for pin17, </div><div class="t m0 xd hd yd8f ff51 fs7 fc3 sc0 ls1 ws1">this is 4:</div><div class="t m0 xd h46 yd90 ff5a fs7 fc3 sc0 ls1 ws1">ldr   X2, =\pin    // offset of select register</div><div class="t m0 xd h46 yd91 ff5a fs7 fc3 sc0 ls1 ws1">ldr   W2, [X2]     // load the value</div><div class="t m0 xc hd yd92 ff51 fs7 fc3 sc0 ls1 ws1">Our table consists of 32-bit wor<span class="_ _3"></span>ds, so we load it into the lo<span class="_ _3"></span>wer 32 bits of </div><div class="t m0 xd hd yd93 ff51 fs7 fc3 sc0 ls1 ws1">register 2, n<span class="_ _3"></span>amely, <span class="ff55">W2</span>. No<span class="_ _3"></span>w use pre-index addr<span class="_ _3"></span>essing to load the curren<span class="_ _3"></span>t </div><div class="t m0 xd hd yd94 ff51 fs7 fc3 sc0 ls1 ws1">contents of the selection r<span class="_ _3"></span>egister<span class="_ _6"></span>. <span class="ff55">X9</span> is the address<span class="_ _1"></span>, plus the offs<span class="_ _0"></span>et we just </div><div class="t m0 xd hd yd95 ff51 fs7 fc3 sc0 ls1 ws1">loaded into <span class="ff55">W2/X2</span>.</div><div class="t m0 xd h46 yd96 ff5a fs7 fc3 sc0 ls1 ws1">ldr   W1, [X9, X2]    // address of register</div><div class="t m0 xd h12 y28b ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:294.563000px;bottom:529.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd6" class="pf w2 h6" data-page-no="d6"><div class="pc pcd6 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">199</div><div class="t m0 x1c hd y145 ff51 fs7 fc3 sc0 ls1 ws1">Remember we must access the GPIO r<span class="_ _1"></span>e<span class="_ _0"></span>gisters as 32 bits<span class="_ _1"></span>, so w<span class="_ _0"></span>e mus<span class="_ _3"></span>t </div><div class="t m0 xc hd y146 ff51 fs7 fc3 sc0 ls1 ws1">load them into a <span class="ff55">W</span> r<span class="_ _3"></span>egister<span class="_ _6"></span>. W<span class="_ _1"></span>e now load the second item in the table, the </div><div class="t m0 xc hd y147 ff51 fs7 fc3 sc0 ls1 ws1">shift into the contr<span class="_ _1"></span>ol register for our 3 bits.</div><div class="t m0 xc h46 y2d7 ff5a fs7 fc3 sc0 ls1 ws1">ldr   X3, =\pin     // address of pin table</div><div class="t m0 xc h46 y2e2 ff5a fs7 fc3 sc0 ls1 ws1">add   X3, X3, #4    // load amount to shift from table</div><div class="t m0 xc h46 y60e ff5a fs7 fc3 sc0 ls1 ws1">ldr   W3, [X3]      // load value of shift amt</div><div class="t m0 x1c hd y2da ff51 fs7 fc3 sc0 ls1 ws1">Clear the 3 bits with a mask of binary 111 that we shift into position, </div><div class="t m0 xc hd y231 ff51 fs7 fc3 sc0 ls1 ws1">then call bit clear (<span class="ff55">bic</span>) to clear<span class="_ _0"></span>:</div><div class="t m0 xc h46 y377 ff5a fs7 fc3 sc0 ls1 ws1">mov   X0, #0b111    // mask to clear 3 bits</div><div class="t m0 xc h46 yd97 ff5a fs7 fc3 sc0 ls1 ws1">lsl   X0, X0, X3    // shift into position</div><div class="t m0 xc h46 yd98 ff5a fs7 fc3 sc0 ls1 ws1">bic   X1, X1, X0    // clear the three bits</div><div class="t m0 x1c hd y379 ff51 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e move one into position, so we can set the lower of the 3 bits to 1 </div><div class="t m0 xc hd y54f ff51 fs7 fc3 sc0 ls1 ws1">using a logical or instruction (<span class="ff55">orr</span>):</div><div class="t m0 xc h46 y291 ff5a fs7 fc3 sc0 ls1 ws1">mov   X0, #1        // 1 bit to shift into pos</div><div class="t m0 xc h46 y292 ff5a fs7 fc3 sc0 ls1 ws1">lsl   X0, X0, X3    // shift by amount from table</div><div class="t m0 xc h46 y293 ff5a fs7 fc3 sc0 ls1 ws1">orr   X1, X1, X0    // set the bit</div><div class="t m0 x1c hd yd99 ff51 fs7 fc3 sc0 ls1 ws1">Fin<span class="_ _3"></span>ally, now that we<span class="_ _1"></span>’ve set our 3 bits, we write the value back to the </div><div class="t m0 xc hd yd9a ff51 fs7 fc3 sc0 ls1 ws1">GPIO contr<span class="_ _3"></span>ol register to execute our comm<span class="_ _3"></span>and:</div><div class="t m0 xc h46 y6ad ff5a fs7 fc3 sc0 ls1 ws1">str   W1, [X9, X2]    // save it to register to do work</div><div class="t m0 xc ha yd9b ff56 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Setting andClearing Pins</div><div class="t m0 xc hd ya32 ff51 fs7 fc3 sc0 ls1 ws1">Setting and clearing pins is easier<span class="_ _6"></span>, since we don’t need to read the r<span class="_ _3"></span>egister </div><div class="t m0 xc hd yd9c ff51 fs7 fc3 sc0 ls1 ws1">first. W<span class="_ _1"></span>e just need to construct the value to write and execute it.</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd7" class="pf w2 h6" data-page-no="d7"><div class="pc pcd7 w2 h6"><div class="t m0 xd hd y3f ff51 fs7 fc3 sc0 ls1 ws1">200</div><div class="t m0 xc hd y145 ff51 fs7 fc3 sc0 ls1 ws1">Since all our pins ar<span class="_ _3"></span>e controlled b<span class="_ _1"></span>y one register<span class="_ _6"></span>, we just ha<span class="_ _3"></span>ve its offset </div><div class="t m0 xd hd y146 ff51 fs7 fc3 sc0 ls1 ws1">defined in a .<span class="ff55">EQU</span> directive. W<span class="_ _1"></span>e take the base virtual address and add th<span class="_ _3"></span>at </div><div class="t m0 xd hd y147 ff51 fs7 fc3 sc0 ls1 ws1">offset.</div><div class="t m0 xd h46 y2d7 ff5a fs7 fc3 sc0 ls1 ws1">mov   X2, X9                // address of gpio regs</div><div class="t m0 xd h46 y2e2 ff5a fs7 fc3 sc0 ls1 ws1">add   X2, X2, #setregoffset // off to set reg</div><div class="t m0 xc hd y2d9 ff51 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we want to ha<span class="_ _1"></span>ve a register with just a 1in the correct position. W<span class="_ _1"></span>e </div><div class="t m0 xd hd y2da ff51 fs7 fc3 sc0 ls1 ws1">start with 1 and shift it into position. W<span class="_ _1"></span>e look up that shift value as the third </div><div class="t m0 xd hd y231 ff51 fs7 fc3 sc0 ls1 ws1">item in our pin lookup ta<span class="_ _3"></span>ble.</div><div class="t m0 xd h46 y377 ff5a fs7 fc3 sc0 ls1 ws1">mov   X0, #1        // 1 bit to shift into pos</div><div class="t m0 xd h46 yd97 ff5a fs7 fc3 sc0 ls1 ws1">ldr   X3, =\pin     // base of pin info table</div><div class="t m0 xd h46 yd98 ff5a fs7 fc3 sc0 ls1 ws1">add   X3, X3, #8    // add offset for shift amt</div><div class="t m0 xd h46 yd9d ff5a fs7 fc3 sc0 ls1 ws1">ldr   W3, [X3]      // load shift from table</div><div class="t m0 xd h46 yd9e ff5a fs7 fc3 sc0 ls1 ws1">lsl   X0, X0, X3    // do the shift</div><div class="t m0 xc hd y550 ff51 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we hav<span class="_ _3"></span>e <span class="ff55">X0</span> containing a 1in the correct bit<span class="_ _0"></span>; we write it back to </div><div class="t m0 xd hd y551 ff51 fs7 fc3 sc0 ls1 ws1">the GPIO set register to turn on the LED<span class="_ _1"></span>, again writing it using the 32-bit </div><div class="t m0 xd hd y552 ff51 fs7 fc3 sc0 ls1 ws1">version of register 0:</div><div class="t m0 xd h46 y294 ff5a fs7 fc3 sc0 ls1 ws1">str   W0, [X2]    // write to the register</div><div class="t m0 xc hd yd9a ff51 fs7 fc3 sc0 ls1 ws1">Clearing the pin is the same, except tha<span class="_ _3"></span>t we use the clear register r<span class="_ _3"></span>ather </div><div class="t m0 xd hd yd9f ff51 fs7 fc3 sc0 ls1 ws1">than the set register<span class="_ _10"></span>.</div><div class="t m0 xd h15 yd9b ff56 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd ya32 ff51 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we built on ever<span class="_ _0"></span>ything we<span class="_ _3"></span>’v<span class="_ _3"></span>e learned so far<span class="_ _6"></span>, to write a </div><div class="t m0 xd hd yd9c ff51 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am to flash a series of LEDs attached to the GPIO ports on our </div><div class="t m0 xd hd yda0 ff51 fs7 fc3 sc0 ls1 ws1">Raspberr<span class="_ _0"></span>y Pi. W<span class="_ _1"></span>e did this in two ways:</div><div class="t m0 xc hd y54b ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Using the GPIO device driver by accessin<span class="_ _3"></span>g the files </div><div class="t m0 x1e hd y54c ff51 fs7 fc3 sc0 ls1 ws1">under /sys/class/gpio</div><div class="t m0 xd h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd8" class="pf w2 h6" data-page-no="d8"><div class="pc pcd8 w2 h6"><div class="t m0 x17 hd y3f ff51 fs7 fc3 sc0 ls1 ws1">201</div><div class="t m0 x1c hd y145 ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Using dir<span class="_ _3"></span>ect memor<span class="_ _0"></span>y access b<span class="_ _3"></span>y asking the device </div><div class="t m0 x9 hd y146 ff51 fs7 fc3 sc0 ls1 ws1">driver for /dev/mem to give us a virtual block </div><div class="t m0 x9 hd y147 ff51 fs7 fc3 sc0 ls1 ws1">of memory cor<span class="_ _0"></span>r<span class="_ _3"></span>esponding to the GPIO’<span class="_ _6"></span>s control </div><div class="t m0 x9 hd y1b0 ff51 fs7 fc3 sc0 ls1 ws1">registers</div><div class="t m0 x1c hd y149 ff51 fs7 fc3 sc0 ls1d ws1">Contr<span class="_ _3"></span>olling devices are a key use case for Assembly Lang<span class="_ _3"></span>uage </div><div class="t m0 xc hd y14a ff51 fs7 fc3 sc0 ls1d ws1">progr<span class="_ _3"></span>amming. Hopefully, this ch<span class="_ _3"></span>apter ga<span class="_ _1"></span>ve you a flavor for wha<span class="_ _3"></span>t is involv<span class="_ _3"></span>ed.</div><div class="t m0 x1c hd y1e1 ff51 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">9</span>, “I<span class="_ _3"></span>nter<span class="_ _3"></span>acting with C and Python,<span class="_ _10"></span>” we will learn how to </div><div class="t m0 xc hd y1e2 ff51 fs7 fc3 sc0 ls1 ws1">interact with high-level pr<span class="_ _1"></span>ogramming languages like C and Python.</div><div class="t m0 xc h15 yda1 ff56 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 x1c hd yac9 ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Not all device inter<span class="_ _3"></span>actions can be abstr<span class="_ _3"></span>acted by </div><div class="t m0 x9 hd yda2 ff51 fs7 fc3 sc0 ls1 ws1">reading or writing files<span class="_ _1"></span>. L<span class="_ _0"></span>in<span class="_ _3"></span>ux allows a general </div><div class="t m0 x9 hd yda3 ff51 fs7 fc3 sc0 ls1 ws1">function, ioctl, to define special operations<span class="_ _3"></span>. </div><div class="t m0 x9 hd yda4 ff51 fs7 fc3 sc0 ls1 ws1">Consider a network interface; what ar<span class="_ _1"></span>e some </div><div class="t m0 x9 hd yda5 ff51 fs7 fc3 sc0 ls1 ws1">functions you would need to contr<span class="_ _3"></span>ol with ioctl?</div><div class="t m0 x1c hd yda6 ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Why does the GPIO contr<span class="_ _3"></span>oller pack so much </div><div class="t m0 x9 hd yda7 ff51 fs7 fc3 sc0 ls1 ws1">functionality into each r<span class="_ _1"></span>e<span class="_ _0"></span>gister? Wh<span class="_ _3"></span>y not ha<span class="_ _3"></span>ve a </div><div class="t m0 x9 hd yda8 ff51 fs7 fc3 sc0 ls1 ws1">separate r<span class="_ _1"></span>e<span class="_ _0"></span>gister for each pin? Wh<span class="_ _3"></span>at ar<span class="_ _3"></span>e the pros and </div><div class="t m0 x9 hd yda9 ff51 fs7 fc3 sc0 ls1 ws1">cons of each approac<span class="_ _3"></span>h?</div><div class="t m0 x1c hd ydaa ff51 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Why does Kali Linux consider access to the GPIO </div><div class="t m0 x9 hd ydab ff51 fs7 fc3 sc0 ls1 ws1">controller d<span class="_ _3"></span>angerous and r<span class="_ _1"></span>estr<span class="_ _0"></span>ict usage to r<span class="_ _1"></span>oot?</div><div class="t m0 x4a h12 y71 ff57 fsa fc3 sc0 ls1 ws1">CHAPTER 8 <span class="_ _f"> </span> PROGRAMMING GPIO PINS </div><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.503000px;bottom:475.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfd9" class="pf w2 h6" data-page-no="d9"><div class="pc pcd9 w2 h6"><div class="t m0 x17 hd y16a ff5b fs7 fc3 sc0 ls1 ws1">203</div><div class="t m0 xc h17 y16b ff5b fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff5b fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff5c">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff5b">,  </span></span></div><div class="t m0 xc h17 y16d ff5b fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_9</div><div class="t m0 xc ha y16e ff5d fs6 fc3 sc0 ls1 ws1">CHAPTER 9</div><div class="t m0 xc h8 y16f ff5e fs4 fc3 sc0 ls1 ws1">Inter<span class="_ _3"></span>acting with  </div><div class="t m0 xc h8 y747 ff5e fs4 fc3 sc0 ls1 ws1">C andPython</div><div class="t m0 xc hd y748 ff5b fs7 fc3 sc0 ls1 ws1">In the early da<span class="_ _3"></span>ys of microcomputers<span class="_ _1"></span>, like the Apple II, people wrote </div><div class="t m0 xc hd y749 ff5b fs7 fc3 sc0 ls1 ws1">complete applications in As<span class="_ _3"></span>sembly Language<span class="_ _3"></span>, such as the first spr<span class="_ _3"></span>eadsheet </div><div class="t m0 xc hd y74a ff5b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am VisiCalc. M<span class="_ _1"></span>any video games were also written in Assembly to </div><div class="t m0 xc hd y74b ff5b fs7 fc3 sc0 ls1 ws1">squeeze every bit of per<span class="_ _0"></span>formance they could out of the har<span class="_ _1"></span>dware. T<span class="_ _3"></span>hese </div><div class="t m0 xc hd y74c ff5b fs7 fc3 sc0 ls1 ws1">days<span class="_ _3"></span>, modern compilers like the GNU C compiler genera<span class="_ _3"></span>te good code and </div><div class="t m0 xc hd y74d ff5b fs7 fc3 sc0 ls1 ws1">micropr<span class="_ _3"></span>ocessors are m<span class="_ _3"></span>uch faster<span class="_ _0"></span>; as a res<span class="_ _3"></span>ult most applications ar<span class="_ _1"></span>e wr<span class="_ _0"></span>itten </div><div class="t m0 xc hd y74e ff5b fs7 fc3 sc0 ls1 ws1">in a collection of programmin<span class="_ _3"></span>g languages<span class="_ _3"></span>, where each ex<span class="_ _3"></span>cels at a specific </div><div class="t m0 xc hd y74f ff5b fs7 fc3 sc0 ls1 ws1">function. If you ar<span class="_ _3"></span>e writing a video game today, chances ar<span class="_ _1"></span>e you would </div><div class="t m0 xc hd y8c6 ff5b fs7 fc3 sc0 ls1 ws1">write most in C, C++, or even C# and then use Assembly for per<span class="_ _0"></span>formance<span class="_ _3"></span>, </div><div class="t m0 xc hd y8c7 ff5b fs7 fc3 sc0 ls1 ws1">or to access parts of the video hardwar<span class="_ _1"></span>e not expos<span class="_ _0"></span>ed thr<span class="_ _3"></span>ough the graphics </div><div class="t m0 xc hd y8c8 ff5b fs7 fc3 sc0 ls1 ws1">library you are using.</div><div class="t m0 x1c hd y8c9 ff5b fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we will look at using components written in other </div><div class="t m0 xc hd y8ca ff5b fs7 fc3 sc0 ls1 ws1">languages fr<span class="_ _3"></span>om our Assembly Language code and look at ho<span class="_ _3"></span>w other </div><div class="t m0 xc hd y8cb ff5b fs7 fc3 sc0 ls1 ws1">computer languages c<span class="_ _3"></span>an make use of the fast<span class="_ _1"></span>-efficient code we are writing </div><div class="t m0 xc hd y8cc ff5b fs7 fc3 sc0 ls1 ws1">in Assembly.</div><div class="t m0 xc h15 ydac ff5f fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Calling C Routines</div><div class="t m0 xc hd ydad ff5b fs7 fc3 sc0 ls1 ws1">If we want to call C functions<span class="_ _3"></span>, we must r<span class="_ _3"></span>estructure our pr<span class="_ _1"></span>ogram. The C </div><div class="t m0 xc hd ydae ff5b fs7 fc3 sc0 ls1 ws1">runtime has a _start label; it expects to be called first and to initialize itself </div><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:164.585000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfda" class="pf w2 h6" data-page-no="da"><div class="pc pcda w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">204</div><div class="t m0 xd hd y145 ff5b fs7 fc3 sc0 ls1 ws1">before calling o<span class="_ _3"></span>ur progr<span class="_ _3"></span>am, which it does b<span class="_ _3"></span>y calling a main function. If </div><div class="t m0 xd hd y146 ff5b fs7 fc3 sc0 ls1 ws1">we leave o<span class="_ _3"></span>ur _start label in, we will get an error that _start is defined more </div><div class="t m0 xd hd y147 ff5b fs7 fc3 sc0 ls1 ws1">than once. S<span class="_ _3"></span>imilarly, we won’t call the Linux terminate pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>am ser<span class="_ _0"></span>vice </div><div class="t m0 xd hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">anymore; inst<span class="_ _3"></span>ead we’ll r<span class="_ _3"></span>eturn from m<span class="_ _3"></span>ain and let the C runtime do that </div><div class="t m0 xd hd y1b1 ff5b fs7 fc3 sc0 ls1 ws1">along with any other cleanup it performs.</div><div class="t m0 xc hd y1b2 ff5b fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o include the C runtime, we could add it to the command line </div><div class="t m0 xd hd y1b3 ff5b fs7 fc3 sc0 ls1 ws1">arguments in the <span class="ff60">ld</span> command in o<span class="_ _3"></span>ur makefile<span class="_ _3"></span>. Ho<span class="_ _3"></span>wever<span class="_ _6"></span>, it’<span class="_ _1"></span>s easier to </div><div class="t m0 xd hd y1b4 ff5b fs7 fc3 sc0 ls1 ws1">compile our pr<span class="_ _3"></span>ogram with the GNU C compiler (which includes the GNU </div><div class="t m0 xd hd y1b5 ff5b fs7 fc3 sc0 ls1 ws1">Assembler); then it will link in the C runtime automatic<span class="_ _3"></span>ally. T<span class="_ _6"></span>o compile our </div><div class="t m0 xd hd y1b6 ff5b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am, we will use</div><div class="t m0 xd h18 y612 ff61 fs7 fc3 sc0 ls1 ws1">gcc -o myprogram myprogram.s</div><div class="t m0 xc hd yb30 ff5b fs7 fc3 sc0 ls1 ws1">That will call <span class="ff60">as</span> on m<span class="_ _3"></span>yprogr<span class="_ _3"></span>am.s and then do the <span class="ff60">ld</span> command </div><div class="t m0 xd hd yb31 ff5b fs7 fc3 sc0 ls1 ws1">including the C runtime.</div><div class="t m0 xc hd y63e ff5b fs7 fc3 sc0 ls1 ws1">The C runtime gives us a lot of capabilities inc<span class="_ _3"></span>luding wrappers for most </div><div class="t m0 xd hd yb32 ff5b fs7 fc3 sc0 ls1 ws1">of the Linux system services. There is an ex<span class="_ _3"></span>tensive library for manipulating </div><div class="t m0 xd hd ydaf ff5b fs7 fc3 sc0 ls1 ws1">NULL-terminated strings, r<span class="_ _3"></span>outines for memory management, and r<span class="_ _3"></span>outines </div><div class="t m0 xd hd y641 ff5b fs7 fc3 sc0 ls1 ws1">to convert between all the data types.</div><div class="t m0 xd ha y888 ff5f fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Printing Debug Information</div><div class="t m0 xd hd ydb0 ff5b fs7 fc3 sc0 ls1 ws1">One handy use of the C runtime is to print out data to trace wh<span class="_ _3"></span>at our </div><div class="t m0 xd hd ydb1 ff5b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am is doing. W<span class="_ _1"></span>e wrote a r<span class="_ _3"></span>outine to output the cont<span class="_ _3"></span>ents of a register </div><div class="t m0 xd hd ydb2 ff5b fs7 fc3 sc0 ls1 ws1">in hexadecimal, and we could write more Assembly code to extend this<span class="_ _1"></span>, or </div><div class="t m0 xd hd ydb3 ff5b fs7 fc3 sc0 ls1 ws1">we could just get the C runtime to do it. After all, if we ar<span class="_ _3"></span>e printing out trace </div><div class="t m0 xd hd ydb4 ff5b fs7 fc3 sc0 ls1 ws1">or debugging information, it doesn’t need to be performant, r<span class="_ _3"></span>ather easy to </div><div class="t m0 xd hd ydb5 ff5b fs7 fc3 sc0 ls1 ws1">add to our code.</div><div class="t m0 xc hd ydb6 ff5b fs7 fc3 sc0 ls1 ws1">For this exam<span class="_ _3"></span>ple, we<span class="_ _3"></span>’ll use the C runtime’<span class="_ _6"></span>s printf function to print out </div><div class="t m0 xd hd ydb7 ff5b fs7 fc3 sc0 ls1 ws1">the contents of a r<span class="_ _1"></span>e<span class="_ _0"></span>gister in both decimal and hexadecim<span class="_ _3"></span>al format. W<span class="_ _1"></span>e’ll </div><div class="t m0 xd hd ydb8 ff5b fs7 fc3 sc0 ls1 ws1">package this r<span class="_ _3"></span>outine as a macr<span class="_ _3"></span>o<span class="_ _1"></span>, and we’ll preserve all the registers that </div><div class="t m0 xd hd ydb9 ff5b fs7 fc3 sc0 ls1 ws1">might be corrupted. This way we can call the m<span class="_ _3"></span>acro without worrying </div><div class="t m0 xd hd ydba ff5b fs7 fc3 sc0 ls1 ws1">about regist<span class="_ _3"></span>er conflicts. The ex<span class="_ _3"></span>ception is the condition flags which it can’t </div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfdb" class="pf w2 h6" data-page-no="db"><div class="pc pcdb w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">205</div><div class="t m0 xc hd y145 ff5b fs7 fc3 sc0 ls1 ws1">preserve, so don’t put these macr<span class="_ _3"></span>os between instructions that set the flags </div><div class="t m0 xc hd y146 ff5b fs7 fc3 sc0 ls1 ws1">and then test the flags<span class="_ _3"></span>. W<span class="_ _1"></span>e also provide a macr<span class="_ _1"></span>o to pr<span class="_ _0"></span>int a s<span class="_ _3"></span>tring for either </div><div class="t m0 xc hd y147 ff5b fs7 fc3 sc0 ls1 ws1">logging or formatting purposes<span class="_ _1"></span>.</div><div class="t m0 x1c hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">The C printf function is mighty, as it takes a v<span class="_ _3"></span>ariable number of </div><div class="t m0 xc hd y1b1 ff5b fs7 fc3 sc0 ls1 ws1">arguments depending on the con<span class="_ _3"></span>tents of a format string. Ther<span class="_ _1"></span>e is extensive </div><div class="t m0 xc hd y218 ff5b fs7 fc3 sc0 ls1 ws1">online documentation on printf<span class="_ _3"></span>, so for a fuller understanding, please ha<span class="_ _1"></span>ve </div><div class="t m0 xc hd y219 ff5b fs7 fc3 sc0 ls1 ws1">a look. W<span class="_ _1"></span>e will call our collection of macros debug.s<span class="_ _1"></span>., and it contains the </div><div class="t m0 xc hd y1b4 ff5b fs7 fc3 sc0 ls1 ws1">code from Listing <span class="fc5">9-1</span>.</div><div class="t m0 xc h20 ydbb ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-1. <span class="_ _15"> </span><span class="ff5b">Debug macr<span class="_ _3"></span>os that use the C runtime<span class="_ _3"></span>’<span class="_ _6"></span>s printf function</span></div><div class="t m0 xc h18 ydbc ff61 fs7 fc3 sc0 ls1 ws1">// Various macros to help with debugging</div><div class="t m0 xc h18 ydbd ff61 fs7 fc3 sc0 ls1 ws1">// These macros preserve all registers.</div><div class="t m0 xc h18 ydbe ff61 fs7 fc3 sc0 ls1 ws1">// Beware they will change the condition flags.</div><div class="t m0 xc h18 ydbf ff61 fs7 fc3 sc0 ls1 ws1">.macro  printReg    reg</div><div class="t m0 xc h18 ydc0 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X0, X1, [SP, #-16]!</div><div class="t m0 xc h18 ydc1 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X2, X3, [SP, #-16]!</div><div class="t m0 xc h18 ydc2 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X4, X5, [SP, #-16]!</div><div class="t m0 xc h18 ydc3 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X6, X7, [SP, #-16]!</div><div class="t m0 xc h18 ydc4 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X8, X9, [SP, #-16]!</div><div class="t m0 xc h18 ydc5 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X10, X11, [SP, #-16]!</div><div class="t m0 xc h18 ydc6 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X12, X13, [SP, #-16]!</div><div class="t m0 xc h18 ydc7 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X14, X15, [SP, #-16]!</div><div class="t m0 xc h18 ydc8 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X16, X17, [SP, #-16]!</div><div class="t m0 xc h18 ydc9 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X18, LR, [SP, #-16]!</div><div class="t m0 xc h18 ydca ff61 fs7 fc3 sc0 ls1 ws1">      mov       X2, X\reg    // for the %d</div><div class="t m0 xc h18 ydcb ff61 fs7 fc3 sc0 ls1 ws1">      mov       X3, X\reg    // for the %x</div><div class="t m0 xc h18 ydcc ff61 fs7 fc3 sc0 ls1 ws1">      mov       X1, #\reg</div><div class="t m0 xc h18 ydcd ff61 fs7 fc3 sc0 ls1 ws1">      add       X1, X1, #&apos;0&apos; // for %c</div><div class="t m0 xc h18 ydce ff61 fs7 fc3 sc0 ls1 ws1">      ldr       X0, =ptfStr  // printf format str</div><div class="t m0 xc h18 ydcf ff61 fs7 fc3 sc0 ls1 ws1">      bl        printf // call printf</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfdb" data-dest-detail='[219,"XYZ",53,452,null]'><div class="d m1" style="border-style:none;position:absolute;left:137.940000px;bottom:465.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfdc" class="pf w2 h6" data-page-no="dc"><div class="pc pcdc w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">206</div><div class="t m0 xd h18 y46b ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X18, LR, [SP], #16</div><div class="t m0 xd h18 y46c ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X16, X17, [SP], #16</div><div class="t m0 xd h18 y46d ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X14, X15, [SP], #16</div><div class="t m0 xd h18 y623 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X12, X13, [SP], #16</div><div class="t m0 xd h18 y624 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X10, X11, [SP], #16</div><div class="t m0 xd h18 y625 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X8, X9, [SP], #16</div><div class="t m0 xd h18 y626 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X6, X7, [SP], #16</div><div class="t m0 xd h18 y627 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X4, X5, [SP], #16</div><div class="t m0 xd h18 y628 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X2, X3, [SP], #16</div><div class="t m0 xd h18 y9f6 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X0, X1, [SP], #16</div><div class="t m0 xd h18 y9f7 ff61 fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xd h18 y62b ff61 fs7 fc3 sc0 ls1 ws1">.macro    printStr    str</div><div class="t m0 xd h18 y9f9 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X0, X1, [SP, #-16]!</div><div class="t m0 xd h18 y9fa ff61 fs7 fc3 sc0 ls1 ws1">      stp       X2, X3, [SP, #-16]!</div><div class="t m0 xd h18 y9fb ff61 fs7 fc3 sc0 ls1 ws1">      stp       X4, X5, [SP, #-16]!</div><div class="t m0 xd h18 y9fc ff61 fs7 fc3 sc0 ls1 ws1">      stp       X6, X7, [SP, #-16]!</div><div class="t m0 xd h18 y9fd ff61 fs7 fc3 sc0 ls1 ws1">      stp       X8, X9, [SP, #-16]!</div><div class="t m0 xd h18 y9fe ff61 fs7 fc3 sc0 ls1 ws1">      stp       X10, X11, [SP, #-16]!</div><div class="t m0 xd h18 y9ff ff61 fs7 fc3 sc0 ls1 ws1">      stp       X12, X13, [SP, #-16]!</div><div class="t m0 xd h18 ya00 ff61 fs7 fc3 sc0 ls1 ws1">      stp       X14, X15, [SP, #-16]!</div><div class="t m0 xd h18 yd5a ff61 fs7 fc3 sc0 ls1 ws1">      stp       X16, X17, [SP, #-16]!</div><div class="t m0 xd h18 yd5b ff61 fs7 fc3 sc0 ls1 ws1">      stp       X18, LR, [SP, #-16]!</div><div class="t m0 xd h18 yd5c ff61 fs7 fc3 sc0 ls1 ws1">      ldr       X0, =1f     // load print str</div><div class="t m0 xd h18 yd5d ff61 fs7 fc3 sc0 ls1 ws1">      bl        printf // call printf</div><div class="t m0 xd h18 yd5e ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X18, LR, [SP], #16</div><div class="t m0 xd h18 yd5f ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X16, X17, [SP], #16</div><div class="t m0 xd h18 yd60 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X14, X15, [SP], #16</div><div class="t m0 xd h18 yc29 ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X12, X13, [SP], #16</div><div class="t m0 xd h18 yc2a ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X10, X11, [SP], #16</div><div class="t m0 xd h18 yc2b ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X8, X9, [SP], #16</div><div class="t m0 xd h18 yc2c ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X6, X7, [SP], #16</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfdd" class="pf w2 h6" data-page-no="dd"><div class="pc pcdd w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">207</div><div class="t m0 xc h18 y46b ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X4, X5, [SP], #16</div><div class="t m0 xc h18 y46c ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X2, X3, [SP], #16</div><div class="t m0 xc h18 y46d ff61 fs7 fc3 sc0 ls1 ws1">      ldp       X0, X1, [SP], #16</div><div class="t m0 xc h18 y623 ff61 fs7 fc3 sc0 ls1 ws1">      b         2f           // branch around str</div><div class="t m0 xc h18 y624 ff61 fs7 fc3 sc0 ls1 ws1">1:    .asciz         &quot;\str\n&quot;</div><div class="t m0 xc h18 y625 ff61 fs7 fc3 sc0 ls1 ws1">      .align         4</div><div class="t m0 xc h18 y626 ff61 fs7 fc3 sc0 ls1 ws1">2:</div><div class="t m0 xc h18 y627 ff61 fs7 fc3 sc0 ls1 ws1">.endm</div><div class="t m0 xc h18 y85f ff61 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xc h18 y629 ff61 fs7 fc3 sc0 ls1 ws1">ptfStr: .asciz &quot;X%c = %32ld, 0x%016lx\n&quot;</div><div class="t m0 xc h18 y62a ff61 fs7 fc3 sc0 ls1 ws1">.align 4</div><div class="t m0 xc h18 y62b ff61 fs7 fc3 sc0 ls1 ws1">.text</div><div class="t m0 xc h2a ydd0 ff5f fsf fc3 sc0 ls1 wsbb"> Preser<span class="_ _0"></span>ving <span class="_ _15"> </span>State</div><div class="t m0 xc hd ydd1 ff5b fs7 fc3 sc0 ls1 ws1">First<span class="_ _3"></span>, we push registers <span class="ff60">X0</span>–<span class="ff60">X18</span> and <span class="ff60 ls24 wsc2">LR<span class="_ _3"></span><span class="ff5b ls1 ws1">; we either use these registers or </span></span></div><div class="t m0 xc hd ydd2 ff5b fs7 fc3 sc0 ls1 ws1">printf might chan<span class="_ _3"></span>ge them. They aren’t s<span class="_ _3"></span>aved as part of the function calling </div><div class="t m0 xc hd ydd3 ff5b fs7 fc3 sc0 ls1 ws1">protocol. A<span class="_ _1"></span>t the end, w<span class="_ _0"></span>e r<span class="_ _3"></span>estore these<span class="_ _1"></span>. This makes calling our macr<span class="_ _1"></span>os as </div><div class="t m0 xc hd ydd4 ff5b fs7 fc3 sc0 ls1 ws1">minimally disruptive to the calling code as possible<span class="_ _3"></span>.</div><div class="t m0 x1c hd ydd5 ff5b fs7 fc3 sc0 ls1 ws1">It is unfortuna<span class="_ _3"></span>te that each instruction can only s<span class="_ _3"></span>ave or r<span class="_ _1"></span>estore two </div><div class="t m0 xc hd ydd6 ff5b fs7 fc3 sc0 ls1 ws1">registers a<span class="_ _3"></span>t a time, and since ther<span class="_ _1"></span>e are 19 corruptible registers along with </div><div class="t m0 xc hd ydd7 ff60 fs7 fc3 sc0 ls24 wsc2">LR<span class="ff5b ls1 ws1">, this means ten instructions to push all these registers and another ten </span></div><div class="t m0 xc hd ydd8 ff5b fs7 fc3 sc0 ls1 ws1">to pop them all off of the stack.</div><div class="t m0 xc h2a ydd9 ff5f fsf fc3 sc0 ls1 wsbb"> Calling <span class="_ _1b"> </span>Printf</div><div class="t m0 xc hd ydda ff5b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e call the C function with these arguments<span class="_ _0"></span>:</div><div class="t m0 xc h18 yddb ff61 fs7 fc3 sc0 ls1 ws1">printf(&quot;R%c = %32ld, 0x%016lx\n&quot;, reg, Rreg, Rreg);</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfde" class="pf w2 h6" data-page-no="de"><div class="pc pcde w2 h6"><img class="bi xd yddc w7 h34" alt="" src="bgde.png"/><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">208</div><div class="t m0 xc hd y3ce ff5b fs7 fc3 sc0 ls1 ws1">Since there ar<span class="_ _1"></span>e four parameters, we set them into <span class="ff60">X0</span>–<span class="ff60">X3</span>. I<span class="_ _3"></span>n printf, </div><div class="t m0 xd hd y3cf ff5b fs7 fc3 sc0 ls1 ws1">each string that starts with a percen<span class="_ _3"></span>tage sign (“%”) takes the next </div><div class="t m0 xd hd y3d0 ff5b fs7 fc3 sc0 ls1 ws1">parameter and formats it accor<span class="_ _1"></span>ding to the next letter<span class="_ _0"></span>:</div><div class="t m0 xa hd yddd ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff60">c</span> for character</div><div class="t m0 xa hd ydde ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff60">d</span> for decimal</div><div class="t m0 xa hd yddf ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff60">x</span> for hex</div><div class="t m0 xa hd yde0 ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff60">0</span> means 0 pad</div><div class="t m0 xa hd yde1 ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff60">l</span> for long meaning 64 bits</div><div class="t m0 xa hd yde2 ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A number specifying the length of the field to print</div><div class="t m0 x34 h1f yde3 ff5f fse fc3 sc0 ls1 ws1">Note<span class="ff62"> <span class="_ _19"> </span>It is important to move the value of the register to </span>X2<span class="ff62"> and </span>X3<span class="ff62"> </span></div><div class="t m0 x34 h1f yde4 ff62 fse fc3 sc0 ls1 ws1">first since populating the other registers might wipe out the passed </div><div class="t m0 x34 h1f yde5 ff62 fse fc3 sc0 ls1 ws1">in value if we are printing <span class="ff5f">X0</span> or <span class="ff5f">X1</span>.<span class="_ _1"></span> If our register is <span class="ff5f">X2</span> or <span class="ff5f">X3</span>,<span class="_ _1"></span> one of </div><div class="t m0 x34 h1f yde6 ff62 fse fc3 sc0 ls1 ws1">the <span class="ff5f">MOV</span> instructions does nothing.<span class="_ _1"></span> Luckily<span class="_ _1"></span>,<span class="_ _1"></span> we don’t get an error or </div><div class="t m0 x34 h1f yde7 ff62 fse fc3 sc0 ls1 ws1">warning,<span class="_ _1"></span> so we don’t need a special case.</div><div class="t m0 xc hd yde8 ff5b fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we look at the details of how we pass this format string to printf<span class="_ _3"></span>.</div><div class="t m0 xd h2a yde9 ff5f fsf fc3 sc0 ls1 wsbb"> P<span class="_ _1"></span>assing <span class="_ _1b"> </span>aString</div><div class="t m0 xd hd ydea ff5b fs7 fc3 sc0 ls1 ws1">In the printStr m<span class="_ _3"></span>acro<span class="_ _1"></span>, we pass in a string to print. Assembly doesn’t handle </div><div class="t m0 xd hd ydeb ff5b fs7 fc3 sc0 ls1 ws1">strings, so we embed the string in the code with an <span class="ff60">.asciz</span> directive, then </div><div class="t m0 xd hd ydec ff5b fs7 fc3 sc0 ls1 ws1">branch ar<span class="_ _3"></span>ound it.</div><div class="t m0 xc hd yded ff5b fs7 fc3 sc0 ls1b ws1">There is an <span class="ff60 wsa9">.align</span> directive righ<span class="_ _3"></span>t after the string, since Assembly </div><div class="t m0 xd hd ydee ff5b fs7 fc3 sc0 ls1b ws1">instructions must be word aligned. I<span class="_ _1"></span>t is g<span class="_ _0"></span>ood practice to add an <span class="ff60 wsa9">.align</span><span class="ls1"> </span></div><div class="t m0 xd hd ydef ff5b fs7 fc3 sc0 ls1b ws1">directive after strings<span class="_ _1"></span>, since other data types will load faster if they are </div><div class="t m0 xd hd ydf0 ff5b fs7 fc3 sc0 ls1b ws1">word aligned.</div><div class="t m0 xc hd ydf1 ff5b fs7 fc3 sc0 ls1 ws1">Generally, I don’t like adding data to the code section, but for our </div><div class="t m0 xd hd ydf2 ff5b fs7 fc3 sc0 ls1 ws1">macro<span class="_ _1"></span>, this is the easiest way. T<span class="_ _3"></span>he assumption is tha<span class="_ _3"></span>t the debug calls will </div><div class="t m0 xd h12 y3e8 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfdf" class="pf w2 h6" data-page-no="df"><div class="pc pcdf w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">209</div><div class="t m0 xc hd y145 ff5b fs7 fc3 sc0 ls1 ws1">be remo<span class="_ _3"></span>ved from the fin<span class="_ _3"></span>al code. If we add too many strings<span class="_ _1"></span>, we could make </div><div class="t m0 xc hd y146 ff60 fs7 fc3 sc0 ls10 ws37">PC<span class="ff5b ls1 ws1"> r<span class="_ _3"></span>elative offsets too large to be r<span class="_ _3"></span>esolved. If this happens<span class="_ _3"></span>, we may need to </span></div><div class="t m0 xc hd y147 ff5b fs7 fc3 sc0 ls1 ws1">shorten the strings, or r<span class="_ _3"></span>emove some<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we need a program th<span class="_ _3"></span>at needs to print something.</div><div class="t m0 xc ha y50e ff5f fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Adding withCarr<span class="_ _0"></span>y Revisited</div><div class="t m0 xc hd y235 ff5b fs7 fc3 sc0 ls1f ws1">In Chapter <span class="fc5 ls1">2<span class="_ _3"></span><span class="fc3 ls1f">, “Loading and Adding,<span class="_ _8"></span>” we ga<span class="_ _3"></span>ve sample code to add two 128- </span></span></div><div class="t m0 xc hd y53b ff5b fs7 fc3 sc0 ls1f ws1">bit numbers using <span class="ff60 wsc7">ADDS</span> and <span class="ff60 wsc7">ADC</span> instructions. What was lac<span class="_ _3"></span>king from this </div><div class="t m0 xc hd y53c ff5b fs7 fc3 sc0 ls1f ws1">example was some way to see the output<span class="_ _3"></span>. No<span class="_ _3"></span>w we’ll take addexamp2.s and </div><div class="t m0 xc hd y53d ff5b fs7 fc3 sc0 ls1f ws1">add some calls to our debug macr<span class="_ _1"></span>os, in Listing <span class="fc5 wsc7">9-2</span>, to show it in action.</div><div class="t m0 xc h20 ydf3 ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-2. <span class="_ _15"> </span><span class="ff5b">Updated addexamp2.s to print o<span class="_ _3"></span>ut the inputs and </span></div><div class="t m0 xc h20 ydf4 ff5b fs3 fc3 sc0 ls1 ws1">outputs</div><div class="t m0 xc h18 ydf5 ff61 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 ydf6 ff61 fs7 fc3 sc0 ls1 ws1">// Example of 128-Bit addition with the ADD/ADC instructions.</div><div class="t m0 xc h18 ydf7 ff61 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 ydf8 ff61 fs7 fc3 sc0 ls1 ws1">.include &quot;debug.s&quot;</div><div class="t m0 xc h18 ydf9 ff61 fs7 fc3 sc0 ls1 ws1">.global main            // Provide program starting address</div><div class="t m0 xc h18 ydfa ff61 fs7 fc3 sc0 ls1 ws1">// Load the registers with some data</div><div class="t m0 xc h18 ydfb ff61 fs7 fc3 sc0 ls1 ws1">// First 64-bit number is 0x0000000000000003FFFFFFFFFFFFFFFF</div><div class="t m0 xc h18 ydfc ff61 fs7 fc3 sc0 ls1 ws1">main:</div><div class="t m0 xc h18 ydfd ff61 fs7 fc3 sc0 ls1 ws1">      STR    LR,[SP,#-16]!</div><div class="t m0 xc h18 ydfe ff61 fs7 fc3 sc0 ls1 ws1">      MOV    X2, #0x0000000000000003</div><div class="t m0 xc h18 ydff ff61 fs7 fc3 sc0 ls1 ws1">      MOV    X3, #0xFFFFFFFFFFFFFFFF  // will change to MOVN</div><div class="t m0 xc h18 ye00 ff61 fs7 fc3 sc0 ls1 ws1">// Second 64-bit number is 0x00000000000000050000000000000001</div><div class="t m0 xc h18 ye01 ff61 fs7 fc3 sc0 ls1 ws1">      MOV    X4, #0x0000000000000005</div><div class="t m0 xc h18 ye02 ff61 fs7 fc3 sc0 ls1 ws1">      MOV    X5, #0x0000000000000001</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.261000px;bottom:465.362000px;width:5.478000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfdf" data-dest-detail='[223,"XYZ",53,404,null]'><div class="d m1" style="border-style:none;position:absolute;left:271.159000px;bottom:417.362000px;width:14.982000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe0" class="pf w2 h6" data-page-no="e0"><div class="pc pce0 w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">210</div><div class="t m0 xd h18 y46b ff61 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Inputs:&quot;</div><div class="t m0 xd h18 y46c ff61 fs7 fc3 sc0 ls1 ws1">      printReg 2</div><div class="t m0 xd h18 y46d ff61 fs7 fc3 sc0 ls1 ws1">      printReg 3</div><div class="t m0 xd h18 y623 ff61 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xd h18 y624 ff61 fs7 fc3 sc0 ls1 ws1">      printReg 5</div><div class="t m0 xd h18 yc46 ff61 fs7 fc3 sc0 ls1 ws1">      ADDS   X1, X3, X5   // Lower order word</div><div class="t m0 xd h18 y626 ff61 fs7 fc3 sc0 ls1 ws1">      ADC    X0, X2, X4   // Higher order word</div><div class="t m0 xd h18 y984 ff61 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Outputs:&quot;</div><div class="t m0 xd h18 yb7a ff61 fs7 fc3 sc0 ls1 ws1">      printReg 1</div><div class="t m0 xd h18 yb7b ff61 fs7 fc3 sc0 ls1 ws1">      printReg 0</div><div class="t m0 xd h18 y62a ff61 fs7 fc3 sc0 ls1 ws1">      MOV    X0, #0       // return code</div><div class="t m0 xd h18 y62b ff61 fs7 fc3 sc0 ls1 ws1">      LDR    LR, [SP], #16</div><div class="t m0 xd h18 y9f9 ff61 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 xc hd ye03 ff5b fs7 fc3 sc0 ls1 ws1">The makefile<span class="_ _1"></span>, in L<span class="_ _0"></span>isting <span class="fc5">9-3</span>, for this is quite sim<span class="_ _3"></span>ple.</div><div class="t m0 xd h20 ye04 ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-3. <span class="_ _15"> </span><span class="ff5b">Mak<span class="_ _3"></span>efile for updated addexamp2.s</span></div><div class="t m0 xd h18 ye05 ff61 fs7 fc3 sc0 ls1 ws1">addexamp2: addexamp2.s debug.s</div><div class="t m0 xd h18 ye06 ff61 fs7 fc3 sc0 ls1 ws1">     gcc -o addexamp2 addexamp2.s</div><div class="t m0 xc hd ye07 ff5b fs7 fc3 sc0 ls1 ws1">If we compile and run the program<span class="_ _3"></span>, we will see</div><div class="t m0 xd h18 ye08 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ make</div><div class="t m0 xd h18 ye09 ff61 fs7 fc3 sc0 ls1 ws1">gcc -o addexamp2 addexamp2.s</div><div class="t m0 xd h18 ye0a ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ ./addexamp2</div><div class="t m0 xd h18 ye0b ff61 fs7 fc3 sc0 ls1 ws1">Inputs:</div><div class="t m0 xd h18 ye0c ff61 fs7 fc3 sc0 ls1 ws1">X2 =                                3, 0x0000000000000003</div><div class="t m0 xd h18 ye0d ff61 fs7 fc3 sc0 ls1 ws1">X3 =                               -1, 0xffffffffffffffff</div><div class="t m0 xd h18 ye0e ff61 fs7 fc3 sc0 ls1 ws1">X4 =                                5, 0x0000000000000005</div><div class="t m0 xd h18 ye0f ff61 fs7 fc3 sc0 ls1 ws1">X5 =                                1, 0x0000000000000001</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfe0" data-dest-detail='[224,"XYZ",35,339,null]'><div class="d m1" style="border-style:none;position:absolute;left:165.340000px;bottom:353.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe1" class="pf w2 h6" data-page-no="e1"><div class="pc pce1 w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">211</div><div class="t m0 xc h18 y46b ff61 fs7 fc3 sc0 ls1 ws1">Outputs:</div><div class="t m0 xc h18 y46c ff61 fs7 fc3 sc0 ls1 ws1">X1 =                                0, 0x0000000000000000</div><div class="t m0 xc h18 y46d ff61 fs7 fc3 sc0 ls1 ws1">X0 =                                9, 0x0000000000000009</div><div class="t m0 xc h18 y623 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$</div><div class="t m0 x1c hd y46f ff5b fs7 fc3 sc0 ls1 ws1">Besides adding the debug statemen<span class="_ _3"></span>ts, notice ho<span class="_ _3"></span>w the progr<span class="_ _3"></span>am is </div><div class="t m0 xc hd y85d ff5b fs7 fc3 sc0 ls1 ws1">restructur<span class="_ _3"></span>ed as a function. The entry point is main, and it follows the </div><div class="t m0 xc hd y983 ff5b fs7 fc3 sc0 ls1 ws1">function protocol of sa<span class="_ _1"></span>ving <span class="ff60 ls24 wsc2">LR</span>.</div><div class="t m0 x1c hd y984 ff5b fs7 fc3 sc0 ls1 ws1">By just adding the C runtime<span class="_ _1"></span>, we br<span class="_ _0"></span>ing a powerful tool-chest to sa<span class="_ _1"></span>ve us </div><div class="t m0 xc hd yb7a ff5b fs7 fc3 sc0 ls1 ws1">time as we develop our full Assembly application. On the downside<span class="_ _3"></span>, notice </div><div class="t m0 xc hd yb7b ff5b fs7 fc3 sc0 ls1 ws1">our executable has gr<span class="_ _1"></span>own to over 9KB.</div><div class="t m0 x1c hd y62a ff5b fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we know how to call C r<span class="_ _1"></span>outines from our Assembly Language </div><div class="t m0 xc hd y62b ff5b fs7 fc3 sc0 ls1 ws1">code, next let’<span class="_ _6"></span>s do the reverse and call Assembly Lang<span class="_ _3"></span>uage from C.</div><div class="t m0 xc h15 y477 ff5f fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Calling Assembly Routines fromC</div><div class="t m0 xc hd y478 ff5b fs7 fc3 sc0 ls1 ws1">A typical scenario is to write most of our application in C, then call </div><div class="t m0 xc hd y479 ff5b fs7 fc3 sc0 ls1 ws1">Assembly Language r<span class="_ _3"></span>outines in specific use cases. If we follow the function </div><div class="t m0 xc hd y47a ff5b fs7 fc3 sc0 ls1 ws1">calling pr<span class="_ _3"></span>otocol from Cha<span class="_ _3"></span>pter <span class="fc5">6</span>, “Functions and the S<span class="_ _3"></span>tack,<span class="_ _8"></span>” C won’t be able </div><div class="t m0 xc hd y47b ff5b fs7 fc3 sc0 ls1 ws1">to tell the difference between our functions and any functions written in C.</div><div class="t m0 x1c hd ye10 ff5b fs7 fc3 sc0 ls1 ws1">As an example, let’<span class="_ _6"></span>s call the toupper function in Listing <span class="fc5">9-4</span> from </div><div class="t m0 xc hd ye11 ff5b fs7 fc3 sc0 ls1 ws1">C.Listing <span class="fc5">9-4</span> contains the C code for uppertst.c to call our Assembly </div><div class="t m0 xc hd ye12 ff5b fs7 fc3 sc0 ls1 ws1">function.</div><div class="t m0 xc h20 ye13 ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-4. <span class="_ _15"> </span><span class="ff5b">Main pr<span class="_ _1"></span>ogram to show calling our to<span class="_ _3"></span>upper function </span></div><div class="t m0 xc h20 ye14 ff5b fs3 fc3 sc0 ls1 ws1">from C</div><div class="t m0 xc h18 ye15 ff61 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 ye16 ff61 fs7 fc3 sc0 ls1 ws1">// C program to call our Assembly</div><div class="t m0 xc h18 ye17 ff61 fs7 fc3 sc0 ls1 ws1">// toupper routine.</div><div class="t m0 xc h18 ye18 ff61 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:194.479000px;bottom:289.186000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe1" data-dest-detail='[225,"XYZ",53,211,null]'><div class="d m1" style="border-style:none;position:absolute;left:329.429000px;bottom:257.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe1" data-dest-detail='[225,"XYZ",53,211,null]'><div class="d m1" style="border-style:none;position:absolute;left:100.430000px;bottom:241.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe2" class="pf w2 h6" data-page-no="e2"><div class="pc pce2 w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">212</div><div class="t m0 xd h18 y46b ff61 fs7 fc3 sc0 ls1 ws1">#include &lt;stdio.h&gt;</div><div class="t m0 xd h18 ye19 ff61 fs7 fc3 sc0 ls1 ws1">extern int mytoupper( char *, char * );</div><div class="t m0 xd h18 ye1a ff61 fs7 fc3 sc0 ls1 ws1">#define MAX_BUFFSIZE 255</div><div class="t m0 xd h18 ye1b ff61 fs7 fc3 sc0 ls1 ws1">int main()</div><div class="t m0 xd h18 y910 ff61 fs7 fc3 sc0 ls1 ws1">{</div><div class="t m0 xd h18 y470 ff61 fs7 fc3 sc0 ls1 ws1">      char *str = &quot;This is a test.&quot;;</div><div class="t m0 xd h18 y471 ff61 fs7 fc3 sc0 ls1 ws1">      char outBuf[MAX_BUFFSIZE];</div><div class="t m0 xd h18 y472 ff61 fs7 fc3 sc0 ls1 ws1">      int len;</div><div class="t m0 xd h18 y912 ff61 fs7 fc3 sc0 ls1 ws1">      len = mytoupper( str, outBuf );</div><div class="t m0 xd h18 y474 ff61 fs7 fc3 sc0 ls1 ws1">      printf(&quot;Before str: %s\n&quot;, str);</div><div class="t m0 xd h18 y475 ff61 fs7 fc3 sc0 ls1 ws1">      printf(&quot;After str: %s\n&quot;, outBuf);</div><div class="t m0 xd h18 y476 ff61 fs7 fc3 sc0 ls1 ws1">      printf(&quot;Str len = %d\n&quot;, len);</div><div class="t m0 xd h18 ye1c ff61 fs7 fc3 sc0 ls1 ws1">      return(0);</div><div class="t m0 xd h18 y62d ff61 fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 xc hd ye1d ff5b fs7 fc3 sc0 ls1 ws1">The makefile is in Listing <span class="fc5">9-5</span>.</div><div class="t m0 xd h20 y989 ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-5. <span class="_ _15"> </span><span class="ff5b">Mak<span class="_ _3"></span>efile for C and our toupper function</span></div><div class="t m0 xd h18 ye1e ff61 fs7 fc3 sc0 ls1 ws1">uppertst: uppertst.c upper.s</div><div class="t m0 xd h18 ye1f ff61 fs7 fc3 sc0 ls1 ws1">      gcc -o uppertst uppertst.c upper.s</div><div class="t m0 xc hd ye20 ff5b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e had to change the name of our toupper function to m<span class="_ _1"></span>ytoupper<span class="_ _6"></span>, </div><div class="t m0 xd hd ye21 ff5b fs7 fc3 sc0 ls1 ws1">since there is alr<span class="_ _1"></span>eady a toupper function in the C r<span class="_ _0"></span>untime<span class="_ _1"></span>, and this led </div><div class="t m0 xd hd ye22 ff5b fs7 fc3 sc0 ls1 ws1">to a multiple definition error<span class="_ _10"></span>. This had to be done in both the C and the </div><div class="t m0 xd hd ye23 ff5b fs7 fc3 sc0 ls1 ws1">Assembly code. Otherwise, the function is the same as in <span class="ff5c">Chapter</span> <span class="fc5">6</span><span class="ff5c">, </span></div><div class="t m0 xd hd ye24 ff5c fs7 fc3 sc0 ls1 ws1">“Functions and the S<span class="_ _3"></span>tack<span class="ff5b ls2c wscf">.”</span></div><div class="t m0 xc hd ye25 ff5b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e must define the parameters and r<span class="_ _3"></span>eturn code for our function to the </div><div class="t m0 xd hd ye26 ff5b fs7 fc3 sc0 ls1 ws1">C compiler<span class="_ _6"></span>. W<span class="_ _1"></span>e do this with</div><div class="t m0 xd h18 ye27 ff61 fs7 fc3 sc0 ls1 ws1">extern int mytoupper( char *, char * );</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfe2" data-dest-detail='[226,"XYZ",35,307,null]'><div class="d m1" style="border-style:none;position:absolute;left:172.567000px;bottom:321.186000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:342.169000px;bottom:180.686000px;width:5.500000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe3" class="pf w2 h6" data-page-no="e3"><div class="pc pce3 w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">213</div><div class="t m0 x1c hd y145 ff5b fs7 fc3 sc0 ls1 ws1">This should be familiar to all C pr<span class="_ _3"></span>ogrammers<span class="_ _3"></span>, as you must do this for </div><div class="t m0 xc hd y146 ff5b fs7 fc3 sc0 ls1 ws1">C functions as well. Usually, you would g<span class="_ _3"></span>ather up all these definitions and </div><div class="t m0 xc hd y147 ff5b fs7 fc3 sc0 ls1 ws1">put them in a header (.<span class="ff60">h</span>) file.</div><div class="t m0 x1c hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">As far as the C code is concerned, there is no differ<span class="_ _3"></span>ence in using this </div><div class="t m0 xc hd y1b1 ff5b fs7 fc3 sc0 ls1 ws1">Assembly function than if we wrot<span class="_ _3"></span>e it in C.When we compile and r<span class="_ _0"></span>un the </div><div class="t m0 xc hd y1b2 ff5b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am, we get</div><div class="t m0 xc h18 y230 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ make</div><div class="t m0 xc h18 y60f ff61 fs7 fc3 sc0 ls1 ws1">gcc -o uppertst uppertst.c upper.s</div><div class="t m0 xc h18 y610 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ ./uppertst</div><div class="t m0 xc h18 y611 ff61 fs7 fc3 sc0 ls1 ws1">Before str: This is a test.</div><div class="t m0 xc h18 y612 ff61 fs7 fc3 sc0 ls1 ws1">After str: THIS IS A TEST.</div><div class="t m0 xc h18 y613 ff61 fs7 fc3 sc0 ls1 ws1">Str len = 16</div><div class="t m0 xc h18 y614 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$</div><div class="t m0 x1c hd y63e ff5b fs7 fc3 sc0 ls1 ws1">The string is in upper<span class="_ _1"></span>-case as we would expect, but the string length </div><div class="t m0 xc hd yb32 ff5b fs7 fc3 sc0 ls1 ws1">appears one grea<span class="_ _3"></span>ter than we might expect. T<span class="_ _3"></span>hat is because the length </div><div class="t m0 xc hd ydaf ff5b fs7 fc3 sc0 ls1 ws1">includes the NULL character<span class="_ _10"></span>, which isn’t the C standard. If we really </div><div class="t m0 xc hd y641 ff5b fs7 fc3 sc0 ls1 ws1">wanted to use this a lot with C, we should subtract 1, so that our length is </div><div class="t m0 xc hd y642 ff5b fs7 fc3 sc0 ls1 ws1">consistent with other C runtime ro<span class="_ _3"></span>utines.</div><div class="t m0 xc h15 ydb0 ff5f fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>P<span class="_ _1"></span>ackaging Our Code</div><div class="t m0 xc hd y587 ff5b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e could leave our Assembly code in individual object (.<span class="ff60">o</span>) files<span class="_ _1"></span>, but it<span class="_ _0"></span>’<span class="_ _6"></span>s </div><div class="t m0 xc hd ye28 ff5b fs7 fc3 sc0 ls1 ws1">more con<span class="_ _3"></span>venient for pr<span class="_ _3"></span>ogrammers using o<span class="_ _3"></span>ur library to package them </div><div class="t m0 xc hd ye29 ff5b fs7 fc3 sc0 ls1 ws1">together in a library. This way the user of our Assembly r<span class="_ _3"></span>outines just needs </div><div class="t m0 xc hd ye2a ff5b fs7 fc3 sc0 ls1 ws1">to add one library to get all of our code, ra<span class="_ _3"></span>ther than possibly dozens of </div><div class="t m0 xc hd ye2b ff5b fs7 fc3 sc0 ls1 ws1">.<span class="ff60">o</span> files. I<span class="_ _3"></span>n Linux there ar<span class="_ _1"></span>e tw<span class="_ _0"></span>o wa<span class="_ _3"></span>ys to do this<span class="_ _3"></span>. The first way is to pac<span class="_ _3"></span>kage </div><div class="t m0 xc hd ye2c ff5b fs7 fc3 sc0 ls1 ws1">our code together into a static libr<span class="_ _3"></span>ary that is linked into the progr<span class="_ _1"></span>am. The </div><div class="t m0 xc hd ye2d ff5b fs7 fc3 sc0 ls1 ws1">second method is to package our code as a shar<span class="_ _3"></span>ed library that lives outside </div><div class="t m0 xc hd ye2e ff5b fs7 fc3 sc0 ls1 ws1">the calling pr<span class="_ _3"></span>ogram and can be shar<span class="_ _1"></span>ed by several applications<span class="_ _1"></span>.</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe4" class="pf w2 h6" data-page-no="e4"><div class="pc pce4 w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">214</div><div class="t m0 xd ha y248 ff5f fs6 fc3 sc0 ls1 wsb1"> Static <span class="_ _14"> </span>Librar<span class="_ _0"></span>y</div><div class="t m0 xd hd y249 ff5b fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o package our code as a static libr<span class="_ _3"></span>ary, w<span class="_ _0"></span>e use the Linux <span class="ff60">ar</span> command. T<span class="_ _3"></span>his </div><div class="t m0 xd hd y24a ff5b fs7 fc3 sc0 ls1 ws1">command will take a number of .<span class="ff60">o</span> files and combine them in<span class="_ _3"></span>to a single </div><div class="t m0 xd hd y24b ff5b fs7 fc3 sc0 ls1 ws1">file, b<span class="_ _3"></span>y conven<span class="_ _3"></span>tion lib&lt;ourname&gt;.a, th<span class="_ _3"></span>at can then be included into a <span class="ff60 ls7 ws6f">gcc<span class="_ _3"></span><span class="ff5b ls1 ws1"> </span></span></div><div class="t m0 xd hd y5ad ff5b fs7 fc3 sc0 ls1 ws1">or <span class="ff60">ld</span> command. T<span class="_ _6"></span>o do this, we modify our mak<span class="_ _3"></span>efile to build this way as </div><div class="t m0 xd hd y5ae ff5b fs7 fc3 sc0 ls1 ws1">demonstrated in Listing <span class="fc5">9-6</span>.</div><div class="t m0 xd h20 y5af ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-6. <span class="_ _15"> </span><span class="ff5b">Mak<span class="_ _3"></span>efile to build upper<span class="_ _10"></span>.s into a statically linked libr<span class="_ _3"></span>ary</span></div><div class="t m0 xd h18 y5b0 ff61 fs7 fc3 sc0 ls1 ws1">LIBOBJS = upper.o</div><div class="t m0 xd h18 ye2f ff61 fs7 fc3 sc0 ls1 ws1">all: uppertst2</div><div class="t m0 xd h18 ye30 ff61 fs7 fc3 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xd h18 ye31 ff61 fs7 fc3 sc0 ls1 ws1">      as $(DEBUGFLGS) $&lt; -o $@</div><div class="t m0 xd h18 ye32 ff61 fs7 fc3 sc0 ls1 ws1">libupper.a: $(LIBOBJS)</div><div class="t m0 xd h18 ye33 ff61 fs7 fc3 sc0 ls1 ws1">      ar -cvq libupper.a upper.o</div><div class="t m0 xd h18 ye34 ff61 fs7 fc3 sc0 ls1 ws1">uppertst2: uppertst.c libupper.a</div><div class="t m0 xd h18 ye35 ff61 fs7 fc3 sc0 ls1 ws1">      gcc -o uppertst2 uppertst.c libupper.a</div><div class="t m0 xc hd ye36 ff5b fs7 fc3 sc0 ls1 ws1">If we build and run this program<span class="_ _3"></span>, we get<span class="_ _0"></span>:</div><div class="t m0 xd h18 ye37 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ make</div><div class="t m0 xd h18 ye38 ff61 fs7 fc3 sc0 ls1 ws1">as   upper.s -o upper.o</div><div class="t m0 xd h18 ye39 ff61 fs7 fc3 sc0 ls1 ws1">ar -cvq libupper.a upper.o</div><div class="t m0 xd h18 ye3a ff61 fs7 fc3 sc0 ls1 ws1">a - upper.o</div><div class="t m0 xd h18 ye3b ff61 fs7 fc3 sc0 ls1 ws1">gcc -o uppertst2 uppertst.c libupper.a</div><div class="t m0 xd h18 ye3c ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ ./uppertst2</div><div class="t m0 xd h18 ye3d ff61 fs7 fc3 sc0 ls1 ws1">Before str: This is a test.</div><div class="t m0 xd h18 ye3e ff61 fs7 fc3 sc0 ls1 ws1">After str: THIS IS A TEST.</div><div class="t m0 xd h18 ye3f ff61 fs7 fc3 sc0 ls1 ws1">Str len = 16</div><div class="t m0 xd h18 ye40 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfe4" data-dest-detail='[228,"XYZ",35,471,null]'><div class="d m1" style="border-style:none;position:absolute;left:149.925000px;bottom:484.518000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe5" class="pf w2 h6" data-page-no="e5"><div class="pc pce5 w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">215</div><div class="t m0 x1c hd y145 ff5b fs7 fc3 sc0 ls1 ws1">The only difference com<span class="_ _3"></span>pared to the last example is th<span class="_ _3"></span>at we first </div><div class="t m0 xc hd y146 ff5b fs7 fc3 sc0 ls1 ws1">use <span class="ff60">as</span> to compile upper<span class="_ _6"></span>.s into upper<span class="_ _6"></span>.o and then use <span class="ff60">ar</span> to build a library </div><div class="t m0 xc hd y147 ff5b fs7 fc3 sc0 ls1 ws1">containing our r<span class="_ _3"></span>outine<span class="_ _3"></span>. If we want to distribute our libr<span class="_ _3"></span>ary, w<span class="_ _0"></span>e include </div><div class="t m0 xc hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">libupper<span class="_ _6"></span>.a, a header file with the C function definitions and some </div><div class="t m0 xc hd y1b1 ff5b fs7 fc3 sc0 ls1 ws1">documentation. E<span class="_ _1"></span>ven if you aren’t selling, or otherwis<span class="_ _0"></span>e distributing yo<span class="_ _3"></span>ur </div><div class="t m0 xc hd y218 ff5b fs7 fc3 sc0 ls1 ws1">code, building libr<span class="_ _1"></span>ar<span class="_ _0"></span>ies intern<span class="_ _3"></span>ally can help organiza<span class="_ _3"></span>tionally to shar<span class="_ _1"></span>e code </div><div class="t m0 xc hd y219 ff5b fs7 fc3 sc0 ls1 ws1">among progr<span class="_ _3"></span>ammers and reduce duplica<span class="_ _3"></span>ted work. In the nex<span class="_ _3"></span>t section, we </div><div class="t m0 xc hd y1b4 ff5b fs7 fc3 sc0 ls1 ws1">explore shar<span class="_ _1"></span>ed libraries, another Linux facility for sharing code.</div><div class="t m0 xc ha y6b8 ff5f fs6 fc3 sc0 ls1 wsb1"> Shared <span class="_ _14"> </span>Librar<span class="_ _0"></span>y</div><div class="t m0 xc hd ybe2 ff5b fs7 fc3 sc0 ls1 ws1">Shar<span class="_ _3"></span>ed libraries are m<span class="_ _3"></span>uch more technical th<span class="_ _3"></span>an statically link<span class="_ _3"></span>ed libraries. </div><div class="t m0 xc hd ybf1 ff5b fs7 fc3 sc0 ls1 ws1">They place the code in a separate file fr<span class="_ _3"></span>om the executable and ar<span class="_ _3"></span>e </div><div class="t m0 xc hd ybf2 ff5b fs7 fc3 sc0 ls1 ws1">dynamically loaded b<span class="_ _3"></span>y the system as needed. There ar<span class="_ _3"></span>e several issues<span class="_ _1"></span>, </div><div class="t m0 xc hd ybf3 ff5b fs7 fc3 sc0 ls1 ws1">but we are only going to to<span class="_ _3"></span>uch on them, such as versionin<span class="_ _3"></span>g and library </div><div class="t m0 xc hd ye41 ff5b fs7 fc3 sc0 ls1 ws1">placement in the file system<span class="_ _3"></span>. If you decide to package yo<span class="_ _3"></span>ur code as a </div><div class="t m0 xc hd ye42 ff5b fs7 fc3 sc0 ls1 ws1">shared libr<span class="_ _3"></span>ary, this section provides a starting point and demonstr<span class="_ _3"></span>ates that </div><div class="t m0 xc hd ye43 ff5b fs7 fc3 sc0 ls1 ws1">it applies to Assembly Language code as m<span class="_ _3"></span>uch as C code.</div><div class="t m0 x1c hd ye44 ff5b fs7 fc3 sc0 ls1 ws1">The shar<span class="_ _3"></span>ed library is created with the <span class="ff60 ls7 ws6f">gcc</span> command, giving it the </div><div class="t m0 xc hd ye45 ff60 fs7 fc3 sc0 ls1 ws1">-shared<span class="ff5b"> command line parameter to indic<span class="_ _3"></span>ate we want to cr<span class="_ _1"></span>eate a shared </span></div><div class="t m0 xc hd ye46 ff5b fs7 fc3 sc0 ls1 ws1">library and then the <span class="ff60">-sonam<span class="_ _0"></span>e</span> par<span class="_ _3"></span>ameter to name it.</div><div class="t m0 x1c hd ye47 ff5b fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o use a shared library, it must be in a specific place in the filesystem. </div><div class="t m0 xc hd ye48 ff5b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can add new places, but we<span class="_ _3"></span>’re going to use a place cr<span class="_ _3"></span>eated by the C </div><div class="t m0 xc hd ye49 ff5b fs7 fc3 sc0 ls1 ws1">runtime, namel<span class="_ _3"></span>y, /usr/local/lib<span class="_ _1"></span>. After we build our library, w<span class="_ _0"></span>e cop<span class="_ _3"></span>y it here </div><div class="t m0 xc hd ye4a ff5b fs7 fc3 sc0 ls1 ws1">and crea<span class="_ _3"></span>te a couple of links to it. These steps ar<span class="_ _1"></span>e all required as part of </div><div class="t m0 xc hd ye4b ff5b fs7 fc3 sc0 ls1 ws1">shared libr<span class="_ _3"></span>ary versioning control system<span class="_ _1"></span>.</div><div class="t m0 x1c hd ye4c ff5b fs7 fc3 sc0 ls1 ws1">Then to use our shar<span class="_ _3"></span>ed library libup<span class="_ _3"></span>.so<span class="_ _1"></span>.1, w<span class="_ _0"></span>e include -lup on the <span class="ff60 ls7 ws6f">gcc</span> </div><div class="t m0 xc hd ye4d ff5b fs7 fc3 sc0 ls1 ws1">command to compile uppertst3. The makefile is pr<span class="_ _1"></span>esented in Listing <span class="fc5">9-7</span>.</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfe6" data-dest-detail='[230,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:374.612000px;bottom:145.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe6" class="pf w2 h6" data-page-no="e6"><div class="pc pce6 w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">216</div><div class="t m0 xd h20 y4c5 ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-7. <span class="_ _15"> </span><span class="ff5b">Mak<span class="_ _3"></span>efile for building and using a sh<span class="_ _3"></span>ared libr<span class="_ _3"></span>ary</span></div><div class="t m0 xd h18 y4c6 ff61 fs7 fc3 sc0 ls1 ws1">LIBOBJS = upper.o</div><div class="t m0 xd h18 y4f6 ff61 fs7 fc3 sc0 ls1 ws1">all: uppertst3</div><div class="t m0 xd h18 ye4e ff61 fs7 fc3 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xd h18 ye4f ff61 fs7 fc3 sc0 ls1 ws1">        as $(DEBUGFLGS) $&lt; -o $@</div><div class="t m0 xd h18 ye50 ff61 fs7 fc3 sc0 ls1 ws1">libup.so.1.0: $(LIBOBJS)</div><div class="t m0 xd h18 ye51 ff61 fs7 fc3 sc0 ls1 ws1">         <span class="_ _20"></span>gcc -shared -Wl,-soname,libup.so.1 -o libup.so.1.0: </div><div class="t m0 x4f h18 ye52 ff61 fs7 fc3 sc0 ls1 ws1">$(LIBOBJS)</div><div class="t m0 xd h18 ye53 ff61 fs7 fc3 sc0 ls1 ws1">         <span class="_ _20"></span>gcc -shared -Wl,-soname,libup.so.1 -o libup.so.1.0 </div><div class="t m0 x4f h18 ye54 ff61 fs7 fc3 sc0 ls1 ws1">$(LIBOBJS)</div><div class="t m0 xd h18 y5c6 ff61 fs7 fc3 sc0 ls1 ws1">        mv libup.so.1.0 /usr/local/lib</div><div class="t m0 xd h18 y5e1 ff61 fs7 fc3 sc0 ls1 ws1">         <span class="_ _20"></span>ln -sf /usr/local/lib/libup.so.1.0 /usr/local/lib/</div><div class="t m0 x4f h18 y4d1 ff61 fs7 fc3 sc0 ls1 ws1">libup.so.1</div><div class="t m0 xd h18 y4d2 ff61 fs7 fc3 sc0 ls1 ws1">         <span class="_ _20"></span>ln -sf /usr/local/lib/libup.so.1.0 /usr/local/lib/</div><div class="t m0 x4f h18 y4d3 ff61 fs7 fc3 sc0 ls1 ws1">libup.so</div><div class="t m0 xd h18 y4d4 ff61 fs7 fc3 sc0 ls1 ws1">        ldconfig</div><div class="t m0 xd h18 ye55 ff61 fs7 fc3 sc0 ls1 ws1">uppertst3: libup.so.1.0</div><div class="t m0 xd h18 y4d6 ff61 fs7 fc3 sc0 ls1 ws1">       gcc -o uppertst3 uppertst.c -lup</div><div class="t m0 xc hd y4d7 ff5b fs7 fc3 sc0 ls1 ws1">If we run this, several commands will fail. T<span class="_ _10"></span>o copy the files to /usr/</div><div class="t m0 xd hd y4d8 ff5b fs7 fc3 sc0 ls1 ws1">local/lib<span class="_ _1"></span>, we nee<span class="_ _0"></span>d r<span class="_ _3"></span>oot access, so use the sudo command t<span class="_ _3"></span>o run make. </div><div class="t m0 xd hd y4d9 ff5b fs7 fc3 sc0 ls1 ws1">Notice ther<span class="_ _1"></span>e is a call to the following command:</div><div class="t m0 xd h18 ye56 ff61 fs7 fc3 sc0 ls1 ws1">ldconfig</div><div class="t m0 xc hd ye57 ff5b fs7 fc3 sc0 ls1 ws1">after the shar<span class="_ _3"></span>ed library is put in place. This causes Linux to sear<span class="_ _1"></span>ch all </div><div class="t m0 xd hd ye58 ff5b fs7 fc3 sc0 ls1 ws1">the folders that hold shar<span class="_ _1"></span>ed libraries and update its master list. W<span class="_ _1"></span>e must </div><div class="t m0 xd hd y4dd ff5b fs7 fc3 sc0 ls1 ws1">run this once after we successfully compile our library, or Linux won’t </div><div class="t m0 xd hd y4de ff5b fs7 fc3 sc0 ls1 ws1">know it exists.</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe7" class="pf w2 h6" data-page-no="e7"><div class="pc pce7 w2 h6"><img class="bi xc y82b w7 h30" alt="" src="bge7.png"/><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">217</div><div class="t m0 x36 h1f y82c ff5f fse fc3 sc0 ls1 ws1">Note<span class="ff62"> <span class="_ _19"> </span>Placing -lup on the end of the command to build uppertst3,<span class="_ _1"></span> </span></div><div class="t m0 x36 h1f y82d ff62 fse fc3 sc0 ls1 ws1">after the file that uses it,<span class="_ _1"></span> is important,<span class="_ _3"></span> or you will get unresolved </div><div class="t m0 x36 h1f y82e ff62 fse fc3 sc0 ls1 ws1">externals when you build.</div><div class="t m0 x1c hd y82f ff5b fs7 fc3 sc0 ls1 ws1">The following is the sequence of commands to build and run the </div><div class="t m0 xc hd ye59 ff5b fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am<span class="_ _0"></span>:</div><div class="t m0 xc h18 ye5a ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ sudo make -B</div><div class="t m0 xc h18 ye5b ff61 fs7 fc3 sc0 ls1 ws1">as   upper.s -o upper.o</div><div class="t m0 xc h18 ye5c ff61 fs7 fc3 sc0 ls1 ws1">gcc -shared -Wl,-soname,libup.so.1 -o libup.so.1.0 upper.o</div><div class="t m0 xc h18 ye5d ff61 fs7 fc3 sc0 ls1 ws1">mv libup.so.1.0 /usr/local/lib</div><div class="t m0 xc h18 ye5e ff61 fs7 fc3 sc0 ls1 ws1">ln -sf /usr/local/lib/libup.so.1.0 /usr/local/lib/libup.so.1</div><div class="t m0 xc h18 ye5f ff61 fs7 fc3 sc0 ls1 ws1">ln -sf /usr/local/lib/libup.so.1.0 /usr/local/lib/libup.so</div><div class="t m0 xc h18 ye60 ff61 fs7 fc3 sc0 ls1 ws1">ldconfig</div><div class="t m0 xc h18 ye61 ff61 fs7 fc3 sc0 ls1 ws1">gcc -o uppertst3 uppertst.c -lup</div><div class="t m0 xc h18 ye62 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$ ./uppertst3</div><div class="t m0 xc h18 ye63 ff61 fs7 fc3 sc0 ls1 ws1">Before str: This is a test.</div><div class="t m0 xc h18 ye64 ff61 fs7 fc3 sc0 ls1 ws1">After str: THIS IS A TEST.</div><div class="t m0 xc h18 ye65 ff61 fs7 fc3 sc0 ls1 ws1">Str len = 16</div><div class="t m0 xc h18 ye66 ff61 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 9$</div><div class="t m0 x1c hd ye67 ff5b fs7 fc3 sc0 ls1 ws1">If you use objdump to look inside uppertst3, you won’t find the code </div><div class="t m0 xc hd ye68 ff5b fs7 fc3 sc0 ls1 ws1">for the mytoupper r<span class="_ _3"></span>outine; instead, in our main code<span class="_ _1"></span>, you will find</div><div class="t m0 xc h18 ye69 ff61 fs7 fc3 sc0 ls1 ws1"> 7dc: 97ffffad bl 690 &lt;mytoupper@plt&gt;</div><div class="t m0 x1c hd ye6a ff5b fs7 fc3 sc0 ls1 ws1">which calls</div><div class="t m0 xc h18 ye6b ff61 fs7 fc3 sc0 ls1 ws1">0000000000000690 &lt;mytoupper@plt&gt;:</div><div class="t m0 xc h18 ye6c ff61 fs7 fc3 sc0 ls1 ws1"> 690: b0000090 adrp x16, 11000 &lt;__cxa_finalize@GLIBC_2.17&gt;</div><div class="t m0 xc h18 ye6d ff61 fs7 fc3 sc0 ls1 ws1"> 694: f9401211 ldr x17, [x16, #32]</div><div class="t m0 xc h18 ye6e ff61 fs7 fc3 sc0 ls1 ws1"> 698: 91008210 add x16, x16, #0x20</div><div class="t m0 xc h18 ye6f ff61 fs7 fc3 sc0 ls1 ws1"> 69c: d61f0220 br x17</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe8" class="pf w2 h6" data-page-no="e8"><div class="pc pce8 w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">218</div><div class="t m0 xc hd y145 ff5b fs7 fc3 sc0 ls1 ws1">Gcc inser<span class="_ _0"></span>ted this indir<span class="_ _3"></span>ection into our code<span class="_ _3"></span>, so the loader can fix up the </div><div class="t m0 xd hd y146 ff5b fs7 fc3 sc0 ls1 ws1">address when it dyn<span class="_ _3"></span>amically loads the shar<span class="_ _3"></span>ed library.</div><div class="t m0 xc hd y147 ff5b fs7 fc3 sc0 ls1 ws1">As a final technique, we will look at mixing Assembly Lang<span class="_ _3"></span>uage and C </div><div class="t m0 xd hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">code in the same source code file<span class="_ _3"></span>.</div><div class="t m0 xd h15 y30f ff5f fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Embedding Assembly Code Inside C Code</div><div class="t m0 xd hd y57a ff5b fs7 fc3 sc0 ls1 ws1">The GNU C compiler allows Assembly code to be embedded right in the </div><div class="t m0 xd hd y57b ff5b fs7 fc3 sc0 ls1 ws1">middle of C code. I<span class="_ _1"></span>t contains features to inter<span class="_ _1"></span>act w<span class="_ _0"></span>ith C variables and </div><div class="t m0 xd hd y57c ff5b fs7 fc3 sc0 ls1 ws1">labels and cooperate with the C compiler for r<span class="_ _1"></span>e<span class="_ _0"></span>gister usa<span class="_ _3"></span>ge.</div><div class="t m0 xc hd y57d ff5b fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">9-8</span> is a simple example<span class="_ _3"></span>, where we embed the cor<span class="_ _3"></span>e algorithm for </div><div class="t m0 xd hd y57e ff5b fs7 fc3 sc0 ls1 ws1">the toupper function inside the C main pr<span class="_ _3"></span>ogram.</div><div class="t m0 xd h20 ye70 ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-8. <span class="_ _15"> </span><span class="ff5b">Embedding our Assembly r<span class="_ _1"></span>outine directly in C code</span></div><div class="t m0 xd h18 ye71 ff61 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 ye72 ff61 fs7 fc3 sc0 ls1 ws1">// C program to embed our Assembly</div><div class="t m0 xd h18 ye73 ff61 fs7 fc3 sc0 ls1 ws1">// toupper routine inline.</div><div class="t m0 xd h18 ye74 ff61 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 ye75 ff61 fs7 fc3 sc0 ls1 ws1">#include &lt;stdio.h&gt;</div><div class="t m0 xd h18 ye76 ff61 fs7 fc3 sc0 ls1 ws1">extern int mytoupper( char *, char * );</div><div class="t m0 xd h18 ye77 ff61 fs7 fc3 sc0 ls1 ws1">#define MAX_BUFFSIZE 255</div><div class="t m0 xd h18 ye78 ff61 fs7 fc3 sc0 ls1 ws1">int main()</div><div class="t m0 xd h18 ye79 ff61 fs7 fc3 sc0 ls1 ws1">{</div><div class="t m0 xd h18 ye7a ff61 fs7 fc3 sc0 ls1 ws1">      char *str = &quot;This is a test.&quot;;</div><div class="t m0 xd h18 ye7b ff61 fs7 fc3 sc0 ls1 ws1">      char outBuf[MAX_BUFFSIZE];</div><div class="t m0 xd h18 ye7c ff61 fs7 fc3 sc0 ls1 ws1">      int len;</div><div class="t m0 xd h18 ye7d ff61 fs7 fc3 sc0 ls1 ws1">      asm</div><div class="t m0 xd h18 ye7e ff61 fs7 fc3 sc0 ls1 ws1">      (</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfe8" data-dest-detail='[232,"XYZ",35,380,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.054800px;bottom:409.362000px;width:15.048200px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfe9" class="pf w2 h6" data-page-no="e9"><div class="pc pce9 w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">219</div><div class="t m0 xc h18 y46b ff61 fs7 fc3 sc0 ls1 ws1">            &quot;MOV   X4, %2\n&quot;</div><div class="t m0 xc h18 y46c ff61 fs7 fc3 sc0 ls1 ws1">            &quot;loop: LDRB    W5, [%1], #1\n&quot;</div><div class="t m0 xc h18 y46d ff61 fs7 fc3 sc0 ls1 ws1">            &quot;CMP   W5, #&apos;z&apos;\n&quot;</div><div class="t m0 xc h18 y623 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;BGT   cont\n&quot;</div><div class="t m0 xc h18 y624 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;CMP   W5, #&apos;a&apos;\n&quot;</div><div class="t m0 xc h18 y625 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;BLT   cont\n&quot;</div><div class="t m0 xc h18 y626 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;SUB   W5, W5, #(&apos;a&apos;-&apos;A&apos;)\n&quot;</div><div class="t m0 xc h18 y627 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;cont: STRB W5, [%2], #1\n&quot;</div><div class="t m0 xc h18 y628 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;CMP   W5, #0\n&quot;</div><div class="t m0 xc h18 y9f6 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;B.NE  loop\n&quot;</div><div class="t m0 xc h18 y9f7 ff61 fs7 fc3 sc0 ls1 ws1">            &quot;SUB   %0, %2, X4\n&quot;</div><div class="t m0 xc h18 y9f8 ff61 fs7 fc3 sc0 ls1 ws1">            : &quot;=r&quot; (len)</div><div class="t m0 xc h18 yb8d ff61 fs7 fc3 sc0 ls1 ws1">            : &quot;r&quot; (str), &quot;r&quot; (outBuf)</div><div class="t m0 xc h18 yb8e ff61 fs7 fc3 sc0 ls1 ws1">            : &quot;r4&quot;, &quot;r5&quot;</div><div class="t m0 xc h18 yb8f ff61 fs7 fc3 sc0 ls1 ws1">      );</div><div class="t m0 xc h18 y9fc ff61 fs7 fc3 sc0 ls1 ws1">      printf(&quot;Before str: %s\n&quot;, str);</div><div class="t m0 xc h18 y9fd ff61 fs7 fc3 sc0 ls1 ws1">      printf(&quot;After str: %s\n&quot;, outBuf);</div><div class="t m0 xc h18 y9fe ff61 fs7 fc3 sc0 ls1 ws1">      printf(&quot;Str len = %d\n&quot;, len);</div><div class="t m0 xc h18 y9ff ff61 fs7 fc3 sc0 ls1 ws1">      return(0);</div><div class="t m0 xc h18 ya00 ff61 fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 x1c hd ya01 ff5b fs7 fc3 sc0 ls1 ws1">The <span class="ff60">asm</span> statement lets us em<span class="_ _3"></span>bed Assembly code directly into o<span class="_ _3"></span>ur C </div><div class="t m0 xc hd ya02 ff5b fs7 fc3 sc0 ls1 ws1">code. By doin<span class="_ _3"></span>g this, we could write an arbitr<span class="_ _3"></span>ary mixture of C and Assembly. </div><div class="t m0 xc hd ya03 ff5b fs7 fc3 sc0 ls1 ws1">I stripped out the comments from the Assembly code<span class="_ _1"></span>, s<span class="_ _0"></span>o the structur<span class="_ _3"></span>e of </div><div class="t m0 xc hd ya04 ff5b fs7 fc3 sc0 ls1 ws1">the C and Assembly is a bit easier to re<span class="_ _3"></span>ad. The general form of the asm </div><div class="t m0 xc hd ya05 ff5b fs7 fc3 sc0 ls1 ws1">statement is</div><div class="t m0 xc h18 y858 ff61 fs7 fc3 sc0 ls1 ws1">asm asm-qualifiers ( AssemblerTemplate</div><div class="t m0 xc h18 y859 ff61 fs7 fc3 sc0 ls1 ws1">                : OutputOperands</div><div class="t m0 xc h18 y85a ff61 fs7 fc3 sc0 ls1 ws1">                [ : InputOperands]</div><div class="t m0 xc h18 y85b ff61 fs7 fc3 sc0 ls1 ws1">                [ : Clobbers ] ]</div><div class="t m0 xc h18 ye7f ff61 fs7 fc3 sc0 ls1 ws1">                [ : GotoLabels])</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfea" class="pf w2 h6" data-page-no="ea"><div class="pc pcea w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">220</div><div class="t m0 xc hd y145 ff5b fs7 fc3 sc0 ls1 ws1">The parameters ar<span class="_ _1"></span>e</div><div class="t m0 xa hd y58c ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>AssemblerT<span class="_ _6"></span>emplate: A C string containing the </div><div class="t m0 x1e hd y1fe ff5b fs7 fc3 sc0 ls1 ws1">Assembly code. Ther<span class="_ _1"></span>e are macro s<span class="_ _3"></span>ubstitutions that </div><div class="t m0 x1e hd y148 ff5b fs7 fc3 sc0 ls1 ws1">start with <span class="ff60">%</span> to let the C compiler insert the inputs and </div><div class="t m0 x1e hd y149 ff5b fs7 fc3 sc0 ls1 ws1">outputs<span class="_ _3"></span>.</div><div class="t m0 xa hd y28c ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>OutputOperands: A list of variables or registers </div><div class="t m0 x1e hd y14b ff5b fs7 fc3 sc0 ls1 ws1">returned fr<span class="_ _1"></span>om the co<span class="_ _0"></span>de<span class="_ _3"></span>. This is r<span class="_ _3"></span>equired, since it’<span class="_ _6"></span>s </div><div class="t m0 x1e hd y58d ff5b fs7 fc3 sc0 ls1 ws1">expected that the ro<span class="_ _3"></span>utine does something. In our case<span class="_ _1"></span>, </div><div class="t m0 x1e hd y58e ff5b fs7 fc3 sc0 ls1 ws1">this is “=r” (len) where the =r means an output register </div><div class="t m0 x1e hd y2f3 ff5b fs7 fc3 sc0 ls1 ws1">and that we want it to go in<span class="_ _3"></span>to the C variable len.</div><div class="t m0 xa hd y264 ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>InputOper<span class="_ _3"></span>ands<span class="_ _0"></span>: List of input variables or r<span class="_ _1"></span>egisters </div><div class="t m0 x1e hd y265 ff5b fs7 fc3 sc0 ls1 ws1">used by our r<span class="_ _3"></span>outine. I<span class="_ _3"></span>n this case “r” (str), “r<span class="_ _0"></span>” (<span class="_ _1"></span>outBuf<span class="_ _7"></span>) </div><div class="t m0 x1e hd y266 ff5b fs7 fc3 sc0 ls1 ws1">meaning we want two regist<span class="_ _3"></span>ers, one holding s<span class="_ _3"></span>tr </div><div class="t m0 x1e hd y1f2 ff5b fs7 fc3 sc0 ls1 ws1">and one holding outBuf<span class="_ _3"></span>. It is fortun<span class="_ _3"></span>ate tha<span class="_ _3"></span>t C string </div><div class="t m0 x1e hd y1f3 ff5b fs7 fc3 sc0 ls1 ws1">variables hold the address of the s<span class="_ _3"></span>tring, which is what </div><div class="t m0 x1e hd ye80 ff5b fs7 fc3 sc0 ls1 ws1">we want in the regist<span class="_ _3"></span>er<span class="_ _6"></span>.</div><div class="t m0 xa hd y293 ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Clobbers<span class="_ _0"></span>: A list of register<span class="_ _3"></span>s that we use and will be </div><div class="t m0 x1e hd y294 ff5b fs7 fc3 sc0 ls1 ws1">clobbered when our code runs<span class="_ _3"></span>. In this case “<span class="ff60">r4</span>” and </div><div class="t m0 x1e hd y295 ff5b fs7 fc3 sc0 ls1 ws1">“<span class="ff60">r5</span>”<span class="_ _18"></span>. This statement is the s<span class="_ _3"></span>ame for all processors<span class="_ _3"></span>, so it </div><div class="t m0 x1e hd y296 ff5b fs7 fc3 sc0 ls1 ws1">just means r<span class="_ _3"></span>egisters 4 and 5, which in our case ar<span class="_ _3"></span>e <span class="ff60">X4</span> </div><div class="t m0 x1e hd y297 ff5b fs7 fc3 sc0 ls1 ws1">and <span class="ff60">X5</span>.</div><div class="t m0 xa hd ye81 ff5b fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>GotoLabelsr<span class="_ _0"></span>: A list of C progr<span class="_ _3"></span>am labels that our code </div><div class="t m0 x1e hd ye82 ff5b fs7 fc3 sc0 ls1 ws1">might want t<span class="_ _3"></span>o jump to<span class="_ _1"></span>. Usually, this is an error exit. If </div><div class="t m0 x1e hd y15c ff5b fs7 fc3 sc0 ls1 ws1">you do jump to a C la<span class="_ _3"></span>bel, you must warn the com<span class="_ _3"></span>piler </div><div class="t m0 x1e hd ye83 ff5b fs7 fc3 sc0 ls1 ws1">with a goto asm-qualifier<span class="_ _6"></span>.</div><div class="t m0 xc hd ye84 ff5b fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou can label the input and output operands<span class="_ _1"></span>, we didn’t, and that </div><div class="t m0 xd hd ye85 ff5b fs7 fc3 sc0 ls1 ws1">means the compiler will assign them names %0, %1, … as you c<span class="_ _3"></span>an see used </div><div class="t m0 xd hd ye86 ff5b fs7 fc3 sc0 ls1 ws1">in the Assembly code.</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfeb" class="pf w2 h6" data-page-no="eb"><div class="pc pceb w2 h6"><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">221</div><div class="t m0 x1c hd y145 ff5b fs7 fc3 sc0 ls1 ws1">Since this is a single C file<span class="_ _3"></span>, it is easy to compile with</div><div class="t m0 xc h18 y2e0 ff61 fs7 fc3 sc0 ls1 ws1">gcc -o uppertst4 uppertst4.c</div><div class="t m0 x1c hd y6e7 ff5b fs7 fc3 sc0 ls1 ws1">Running the pr<span class="_ _1"></span>ogram produces the same output as the last section.</div><div class="t m0 x1c hd y496 ff5b fs7 fc3 sc0 ls1 ws1">If you disassemble the pr<span class="_ _3"></span>ogram<span class="_ _3"></span>, you will find that the C compiler </div><div class="t m0 xc hd y567 ff5b fs7 fc3 sc0 ls1 ws1">avoids us<span class="_ _3"></span>ing registers <span class="ff60">X4</span> and <span class="ff60">X5</span> en<span class="_ _3"></span>tirely, lea<span class="_ _1"></span>ving them to us. Y<span class="_ _6"></span>ou will see </div><div class="t m0 xc hd y2d9 ff5b fs7 fc3 sc0 ls1 ws1">it loads up our input r<span class="_ _3"></span>egisters from the v<span class="_ _3"></span>ariables on the stack, befor<span class="_ _3"></span>e our </div><div class="t m0 xc hd y2da ff5b fs7 fc3 sc0 ls1 ws1">code executes and then copies our ret<span class="_ _3"></span>urn value from the assi<span class="_ _3"></span>gned register </div><div class="t m0 xc hd y231 ff5b fs7 fc3 sc0 ls1 ws1">to the variable len on the stack. I<span class="_ _1"></span>t doesn’t give the same registers we </div><div class="t m0 xc hd y232 ff5b fs7 fc3 sc0 ls1 ws1">originally used, but that isn’t a pr<span class="_ _1"></span>oblem.</div><div class="t m0 x1c hd y233 ff5b fs7 fc3 sc0 ls1 ws1">This ro<span class="_ _3"></span>utine is straightforward and doesn’t h<span class="_ _3"></span>ave an<span class="_ _3"></span>y side effects. If </div><div class="t m0 xc hd y2e5 ff5b fs7 fc3 sc0 ls1 ws1">your Assembly code is modifying things behind the scenes<span class="_ _3"></span>, you need to </div><div class="t m0 xc hd yb30 ff5b fs7 fc3 sc0 ls1 ws1">add a volatile keywor<span class="_ _3"></span>d to the <span class="ff60">asm</span> statement to m<span class="_ _3"></span>ake the C compile be </div><div class="t m0 xc hd yb31 ff5b fs7 fc3 sc0 ls1 ws1">more conservative on any assumptions it m<span class="_ _3"></span>akes about your code<span class="_ _1"></span>.</div><div class="t m0 x1c hd y63e ff5b fs7 fc3 sc0 ls1 ws1">In the next section, we’ll look at c<span class="_ _3"></span>alling our Assembly Langua<span class="_ _3"></span>ge code </div><div class="t m0 xc hd y63f ff5b fs7 fc3 sc0 ls1 ws1">from the popular Python progr<span class="_ _3"></span>amming language<span class="_ _1"></span>.</div><div class="t m0 xc h15 y887 ff5f fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Calling Assembly fromPython</div><div class="t m0 xc hd y888 ff5b fs7 fc3 sc0 ls1 ws1">If we write our functions following the Linux function calling pr<span class="_ _3"></span>otocol from </div><div class="t m0 xc hd y889 ff5b fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">6</span>, “F<span class="_ _3"></span>unctions and the Stack<span class="_ _3"></span>,<span class="_ _8"></span>” we can follow the documentation </div><div class="t m0 xc hd y88a ff5b fs7 fc3 sc0 ls1 ws1">on how to call C functions for any given pr<span class="_ _1"></span>ogramming language. Python </div><div class="t m0 xc hd y88b ff5b fs7 fc3 sc0 ls1 ws1">has a good capability to call C functions in its <span class="ff60">ctypes</span> module. This module </div><div class="t m0 xc hd y88c ff5b fs7 fc3 sc0 ls1 ws1">requir<span class="_ _3"></span>es we package our r<span class="_ _3"></span>outines into a shar<span class="_ _1"></span>ed librar<span class="_ _0"></span>y.</div><div class="t m0 x1c hd y88d ff5b fs7 fc3 sc0 ls1 ws1">Since Python is an interpreted langua<span class="_ _3"></span>ge, we can’t link sta<span class="_ _3"></span>tic libraries to </div><div class="t m0 xc hd y88e ff5b fs7 fc3 sc0 ls1 ws1">it, but we can dynamic<span class="_ _3"></span>ally load and call shar<span class="_ _3"></span>ed libraries<span class="_ _3"></span>. The techniques </div><div class="t m0 xc hd y88f ff5b fs7 fc3 sc0 ls1 ws1">we go through her<span class="_ _3"></span>e for Python have m<span class="_ _3"></span>atching componen<span class="_ _3"></span>ts in many other </div><div class="t m0 xc hd y890 ff5b fs7 fc3 sc0 ls1 ws1">interpr<span class="_ _3"></span>eted languages<span class="_ _3"></span>.</div><div class="t m0 x1c hd y891 ff5b fs7 fc3 sc0 ls1 ws1">The har<span class="_ _3"></span>d part is already done<span class="_ _3"></span>, we’<span class="_ _1"></span>ve built the shared library version of </div><div class="t m0 xc hd ye87 ff5b fs7 fc3 sc0 ls1 ws1">our upper<span class="_ _1"></span>-case function; all we must do is call it from Python. Listing <span class="fc5">9-9</span> is </div><div class="t m0 xc hd ye88 ff5b fs7 fc3 sc0 ls1 ws1">the Python code for upper<span class="_ _0"></span>tst5.p<span class="_ _3"></span>y.</div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:94.259700px;bottom:249.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfec" data-dest-detail='[236,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:376.801000px;bottom:105.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfec" class="pf w2 h6" data-page-no="ec"><div class="pc pcec w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">222</div><div class="t m0 xd h20 y4c5 ff63 fs3 fc3 sc0 ls1 ws1">Listing 9-9. <span class="_ _15"> </span><span class="ff5b">Python code to call mytoupper</span></div><div class="t m0 xd h18 y4c6 ff61 fs7 fc3 sc0 ls1 ws1">from ctypes import *</div><div class="t m0 xd h18 y4f6 ff61 fs7 fc3 sc0 ls1 ws1">libupper = CDLL(&quot;libup.so&quot;)</div><div class="t m0 xd h18 ye4e ff61 fs7 fc3 sc0 ls1 ws1">libupper.mytoupper.argtypes = [c_char_p, c_char_p]</div><div class="t m0 xd h18 ye4f ff61 fs7 fc3 sc0 ls1 ws1">libupper.mytoupper.restype = c_int</div><div class="t m0 xd h18 ye50 ff61 fs7 fc3 sc0 ls1 ws1">inStr = create_string_buffer(b&quot;This is a test!&quot;)</div><div class="t m0 xd h18 ye51 ff61 fs7 fc3 sc0 ls1 ws1">outStr = create_string_buffer(250)</div><div class="t m0 xd h18 ye89 ff61 fs7 fc3 sc0 ls1 ws1">len = libupper.mytoupper(inStr, outStr)</div><div class="t m0 xd h18 ye8a ff61 fs7 fc3 sc0 ls1 ws1">print(inStr.value.decode())</div><div class="t m0 xd h18 ye8b ff61 fs7 fc3 sc0 ls1 ws1">print(outStr.value.decode())</div><div class="t m0 xd h18 ye8c ff61 fs7 fc3 sc0 ls1 ws1">print(len)</div><div class="t m0 xc hd ye8d ff5b fs7 fc3 sc0 ls1 ws1">The code is fairly simple; we first import the ctypes module so we can </div><div class="t m0 xd hd ye8e ff5b fs7 fc3 sc0 ls1 ws1">use it. W<span class="_ _1"></span>e then load our shared libr<span class="_ _3"></span>ary w<span class="_ _0"></span>ith the CDLL function. This is an </div><div class="t m0 xd hd ye8f ff5b fs7 fc3 sc0 ls1 ws1">unfortunate name since it r<span class="_ _1"></span>efers to Windows DLLs, ra<span class="_ _3"></span>ther than something </div><div class="t m0 xd hd ye90 ff5b fs7 fc3 sc0 ls1 ws1">more oper<span class="_ _3"></span>ating system neutr<span class="_ _3"></span>al. Since we installed our shar<span class="_ _1"></span>e<span class="_ _0"></span>d libr<span class="_ _3"></span>ary in  </div><div class="t m0 xd hd y5e4 ff5b fs7 fc3 sc0 ls1 ws1">/usr/local/lib and added it to the Linux shar<span class="_ _3"></span>ed library cache, Python has </div><div class="t m0 xd hd ye91 ff5b fs7 fc3 sc0 ls1 ws1">no trouble findin<span class="_ _3"></span>g and loading it.</div><div class="t m0 xc hd ye92 ff5b fs7 fc3 sc0 ls1 ws1">The next two lines are option<span class="_ _3"></span>al, but good practice<span class="_ _3"></span>. They define the </div><div class="t m0 xd hd ye93 ff5b fs7 fc3 sc0 ls1 ws1">function parameters and r<span class="_ _3"></span>eturn type to Python, so it can do extra error </div><div class="t m0 xd hd ye94 ff5b fs7 fc3 sc0 lsb wsb4">checking.</div><div class="t m0 xc hd ye95 ff5b fs7 fc3 sc0 ls1 ws1">In Python, strings are immutable<span class="_ _1"></span>, meaning you can’t change them, </div><div class="t m0 xd hd ye56 ff5b fs7 fc3 sc0 ls1 ws1">and they are in Unicode<span class="_ _3"></span>, meaning each char<span class="_ _1"></span>acter takes up more than one </div><div class="t m0 xd hd y4db ff5b fs7 fc3 sc0 ls1 ws1">byte<span class="_ _3"></span>. W<span class="_ _1"></span>e need to provide the strings in r<span class="_ _3"></span>egular buffers tha<span class="_ _3"></span>t we can change<span class="_ _3"></span>, </div><div class="t m0 xd hd y4dc ff5b fs7 fc3 sc0 ls1 ws1">and we need the strings in AS<span class="_ _0"></span>CII r<span class="_ _3"></span>ather than Unicode<span class="_ _1"></span>. We c<span class="_ _3"></span>an make a </div><div class="t m0 xd hd ye96 ff5b fs7 fc3 sc0 ls1 ws1">string ASCII in P<span class="_ _0"></span>ython by p<span class="_ _3"></span>utting a “b<span class="_ _1"></span>” in front of the string, which means </div><div class="t m0 xd hd ye97 ff5b fs7 fc3 sc0 ls1 ws1">to make it a b<span class="_ _3"></span>yte array using ASCII char<span class="_ _3"></span>acters. The cr<span class="_ _1"></span>eate_string_buffer </div><div class="t m0 xd hd ye98 ff5b fs7 fc3 sc0 ls1 ws1">function in the ctypes module creates a string buffer th<span class="_ _3"></span>at is compa<span class="_ _3"></span>tible </div><div class="t m0 xd hd ye99 ff5b fs7 fc3 sc0 ls1 ws1">with C (and hence Assembly) for us to use.</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfed" class="pf w2 h6" data-page-no="ed"><div class="pc pced w2 h6"><img class="bi x2e ye9a w6 h4a" alt="" src="bged.png"/><div class="t m0 x17 hd y3f ff5b fs7 fc3 sc0 ls1 ws1">223</div><div class="t m0 x1c hd y145 ff5b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e then call our function and print the inputs and outputs; it uses the </div><div class="t m0 xc hd y146 ff5b fs7 fc3 sc0 ls1 ws1">decode method to convert from ASCII back to Unicode<span class="_ _3"></span>. There ar<span class="_ _1"></span>e quite a </div><div class="t m0 xc hd y147 ff5b fs7 fc3 sc0 ls1 ws1">few good Python IDEs for L<span class="_ _0"></span>inux. I used the Thonny Python IDE as shown </div><div class="t m0 xc hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">in Fig<span class="_ _3"></span>ure<span class="fc5">9-1</span>, so we can use that to t<span class="_ _3"></span>est the progr<span class="_ _3"></span>am.</div><div class="t m0 xc h15 ye9b ff5f fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xc hd ye9c ff5b fs7 fc3 sc0 ls20 ws1">In this chapter<span class="_ _10"></span>, we looked at calling C functions from o<span class="_ _3"></span>ur Assembly code. W<span class="_ _1"></span>e </div><div class="t m0 xc hd ye9d ff5b fs7 fc3 sc0 ls20 ws1">made use of the standard C runtime to dev<span class="_ _3"></span>elop some debug helper functions </div><div class="t m0 xc hd ye9e ff5b fs7 fc3 sc0 ls20 ws1">to make developing o<span class="_ _3"></span>ur Assembly code a little easier<span class="_ _6"></span>. W<span class="_ _1"></span>e then did the reverse </div><div class="t m0 xc hd ye9f ff5b fs7 fc3 sc0 ls20 ws1">and called our Assembly upper<span class="_ _1"></span>-case function from a C main pr<span class="_ _1"></span>ogram.</div><div class="t m0 xc h37 yea0 ff63 fs3 fc3 sc0 ls1 ws1">Figure 9-1. <span class="_ _15"> </span><span class="ff5c">Our Python program running in the Thonny IDE</span></div><div class="t m0 x29 h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfed" data-dest-detail='[237,"XYZ",53,518,null]'><div class="d m1" style="border-style:none;position:absolute;left:97.735300px;bottom:529.362000px;width:15.047700px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfee" class="pf w2 h6" data-page-no="ee"><div class="pc pcee w2 h6"><div class="t m0 xd hd y3f ff5b fs7 fc3 sc0 ls1 ws1">224</div><div class="t m0 xc hd y145 ff5b fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e learned how to package our code as both static and shar<span class="_ _1"></span>ed </div><div class="t m0 xd hd y146 ff5b fs7 fc3 sc0 ls1 ws1">libraries. W<span class="_ _1"></span>e discussed how to package our code for cons<span class="_ _3"></span>umption. W<span class="_ _1"></span>e </div><div class="t m0 xd hd y147 ff5b fs7 fc3 sc0 ls1 ws1">looked at how to call o<span class="_ _3"></span>ur upper<span class="_ _1"></span>-case function from Python, which is typical </div><div class="t m0 xd hd y1b0 ff5b fs7 fc3 sc0 ls1 ws1">of high-level languages with the ability to call sh<span class="_ _3"></span>ared libr<span class="_ _3"></span>aries.</div><div class="t m0 xc hd y1b1 ff5b fs7 fc3 sc0 ls27 ws1">In the next cha<span class="_ _3"></span>pter<span class="_ _6"></span>, Chapter <span class="fc5 wsd0">10</span>, “In<span class="_ _3"></span>terfacing with Kotlin and S<span class="_ _3"></span>wift,<span class="_ _8"></span>” </div><div class="t m0 xd hd y218 ff5b fs7 fc3 sc0 ls27 ws1">we will see how to incorporate Assembly Language code in<span class="_ _3"></span>to Android<span class="_ _3"></span> </div><div class="t m0 xd hd y219 ff5b fs7 fc3 sc0 ls27 ws1">and iOS apps.</div><div class="t m0 xd h15 yea1 ff5f fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd yea2 ff5b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Add a macr<span class="_ _3"></span>o to debug.s to print a string given a </div><div class="t m0 x1e hd yea3 ff5b fs7 fc3 sc0 ls1 ws1">register as a par<span class="_ _3"></span>ameter that con<span class="_ _3"></span>tains a pointer to the </div><div class="t m0 x1e hd yea4 ff5b fs7 fc3 sc0 ls1 ws1">string to print.</div><div class="t m0 xc hd yea5 ff5b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Add a macr<span class="_ _3"></span>o to debug.s to print a r<span class="_ _1"></span>e<span class="_ _0"></span>gister<span class="_ _10"></span>, if it </div><div class="t m0 x1e hd yea6 ff5b fs7 fc3 sc0 ls1 ws1">contains a single ASCII character<span class="_ _10"></span>.</div><div class="t m0 xc hd yab1 ff5b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>In the printReg macr<span class="_ _3"></span>o<span class="_ _1"></span>, set <span class="ff60">X0</span>–<span class="ff60">X18</span> to known </div><div class="t m0 x1e hd yab2 ff5b fs7 fc3 sc0 ls1 ws1">unusual values befor<span class="_ _3"></span>e the call to printf<span class="_ _3"></span>. Then step </div><div class="t m0 x1e hd yab3 ff5b fs7 fc3 sc0 ls1 ws1">through the c<span class="_ _3"></span>all to printf to see how many of these </div><div class="t m0 x1e hd yab4 ff5b fs7 fc3 sc0 ls1 ws1">registers ar<span class="_ _1"></span>e clobbered.</div><div class="t m0 xc hd yea7 ff5b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Create a C pr<span class="_ _1"></span>ogram to call the lower<span class="_ _1"></span>-case routine </div><div class="t m0 x1e hd yea8 ff5b fs7 fc3 sc0 ls1 ws1">from Ch<span class="_ _3"></span>apter <span class="fc5">6</span> (“Functions and the S<span class="_ _1"></span>tack<span class="_ _0"></span>”), </div><div class="t m0 x1e hd yea9 ff5b fs7 fc3 sc0 ls1 ws1">Exercise 3, and print out some test cases<span class="_ _3"></span>.</div><div class="t m0 xc hd yac2 ff5b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Create sta<span class="_ _3"></span>tic and shar<span class="_ _3"></span>ed library packages for the </div><div class="t m0 x1e hd yeaa ff5b fs7 fc3 sc0 ls1 ws1">lower<span class="_ _1"></span>-case routine fr<span class="_ _3"></span>om Chapter <span class="fc5">6</span>, Exercise 3.</div><div class="t m0 xc hd yc87 ff5b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>6. <span class="_ _f"> </span>T<span class="_ _6"></span>ake the lower<span class="_ _1"></span>-case routine fr<span class="_ _3"></span>om Chapter <span class="fc5">6</span>, Exercise 3, </div><div class="t m0 x1e hd yeab ff5b fs7 fc3 sc0 ls1 ws1">and embed it in C code using an <span class="ff60">asm</span> statement<span class="_ _3"></span>.</div><div class="t m0 xc hd yeac ff5b fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>7. <span class="_ _f"> </span>Create a Python progr<span class="_ _3"></span>am to call the shar<span class="_ _1"></span>ed librar<span class="_ _0"></span>y </div><div class="t m0 x1e hd yead ff5b fs7 fc3 sc0 ls1 ws1">from Exercise 5.</div><div class="t m0 xd h12 y71 ff62 fsa fc3 sc0 ls1 ws1">CHAPTER 9 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERACTING WITH <span class="_ _0"></span>C ANDPYTHON </span></div><a class="l" href="#pfef" data-dest-detail='[239,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:188.936000px;bottom:513.362000px;width:11.176000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:147.880000px;bottom:227.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:237.188000px;bottom:173.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:278.668000px;bottom:151.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfef" class="pf w2 h6" data-page-no="ef"><div class="pc pcef w2 h6"><div class="t m0 x17 hd y16a ff64 fs7 fc3 sc0 ls1 ws1">225</div><div class="t m0 xc h17 y16b ff64 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff64 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff65">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff64">,  </span></span></div><div class="t m0 xc h17 y16d ff64 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_10</div><div class="t m0 xc ha y16e ff66 fs6 fc3 sc0 ls1 ws1">CHAPTER 10</div><div class="t m0 xc h8 y16f ff67 fs4 fc3 sc0 ls1 ws1">Interfacing with  </div><div class="t m0 xc h8 y747 ff67 fs4 fc3 sc0 ls1 ws1">K<span class="_ _10"></span>otlin andSwift</div><div class="t m0 xc hd y748 ff64 fs7 fc3 sc0 ls1f ws1">In Chapter <span class="fc5 ls1">3<span class="_ _3"></span><span class="fc3 ls1f">, “T<span class="_ _1"></span>ooling Up<span class="_ _1"></span>,<span class="_ _8"></span>” we introduced the tools we will need for </span></span></div><div class="t m0 xc hd y749 ff64 fs7 fc3 sc0 ls1f ws1">developing Android and iOS applic<span class="_ _3"></span>ations (apps). W<span class="_ _1"></span>e introduced sm<span class="_ _3"></span>all </div><div class="t m0 xc hd y74a ff64 fs7 fc3 sc0 ls1f ws1">projects to get some Assembly Language code running on such devices<span class="_ _1"></span>. In </div><div class="t m0 xc hd y74b ff64 fs7 fc3 sc0 ls1f ws1">this chapter<span class="_ _10"></span>, we w<span class="_ _0"></span>ill look at ho<span class="_ _3"></span>w Assembly Language is mor<span class="_ _3"></span>e realistic<span class="_ _3"></span>ally </div><div class="t m0 xc hd y74c ff64 fs7 fc3 sc0 ls1f ws1">incorporated into a sm<span class="_ _3"></span>artphone or tablet app<span class="_ _1"></span>. W<span class="_ _3"></span>e will first develop an app </div><div class="t m0 xc hd y74d ff64 fs7 fc3 sc0 ls1f ws1">in Android, pr<span class="_ _3"></span>ogramming in K<span class="_ _1"></span>otlin to demonstrate incorpora<span class="_ _3"></span>ting some </div><div class="t m0 xc hd y74e ff64 fs7 fc3 sc0 ls1f ws1">Assembly Language<span class="_ _3"></span>, and then we will do the same thing using Swift for iOS<span class="_ _3"></span>.</div><div class="t m0 x1c hd y74f ff64 fs7 fc3 sc0 ls1 ws1">The app will be simple; it will allow you to enter some tex<span class="_ _3"></span>t and convert </div><div class="t m0 xc hd y8c6 ff64 fs7 fc3 sc0 ls1 ws1">that text to upper<span class="_ _1"></span>-case when you tap a b<span class="_ _3"></span>utton. This demonstra<span class="_ _3"></span>tes a </div><div class="t m0 xc hd y8c7 ff64 fs7 fc3 sc0 ls1 ws1">complete app wher<span class="_ _3"></span>e the calculation is performed in Assembly Language. </div><div class="t m0 xc hd y8c8 ff64 fs7 fc3 sc0 ls1 ws1">After intr<span class="_ _3"></span>oducing the progr<span class="_ _3"></span>amming languages<span class="_ _1"></span>, w<span class="_ _0"></span>e<span class="_ _3"></span>’ll use Android S<span class="_ _3"></span>tudio to </div><div class="t m0 xc hd y8c9 ff64 fs7 fc3 sc0 ls1 ws1">crea<span class="_ _3"></span>te our first app<span class="_ _1"></span>.</div><div class="t m0 xc h15 yaa6 ff68 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>About Kotlin,<span class="_ _6"></span> Swift,<span class="_ _1"></span> andJav<span class="_ _3"></span>a</div><div class="t m0 xc hd yeae ff64 fs7 fc3 sc0 ls21 ws1">Kotlin, S<span class="_ _1"></span>w<span class="_ _0"></span>ift, and J<span class="_ _1"></span>ava ar<span class="_ _1"></span>e advanced object-oriented progr<span class="_ _1"></span>amming </div><div class="t m0 xc hd yeaf ff64 fs7 fc3 sc0 ls21 ws1">languages tha<span class="_ _3"></span>t pro<span class="_ _3"></span>vide a high level of abstr<span class="_ _3"></span>action and expressiv<span class="_ _3"></span>eness </div><div class="t m0 xc hd yeb0 ff64 fs7 fc3 sc0 ls21 ws1">for progr<span class="_ _3"></span>ammers to be more pr<span class="_ _1"></span>o<span class="_ _0"></span>ductive<span class="_ _1"></span>, espe<span class="_ _0"></span>cially on lar<span class="_ _3"></span>ge projects<span class="_ _3"></span>. </div><a class="l" href="#pfef" data-dest-detail='[239,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:168.835000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.261000px;bottom:412.802000px;width:5.478000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff0" class="pf w2 h6" data-page-no="f0"><div class="pc pcf0 w2 h6"><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">226</div><div class="t m0 xd hd y145 ff64 fs7 fc3 sc0 ls21 ws1">The downside is that the r<span class="_ _1"></span>esulting code may not run as fast as you need. </div><div class="t m0 xd hd y146 ff64 fs7 fc3 sc0 ls21 ws1">Google and Apple recognize this and pr<span class="_ _3"></span>ovide all the mechanisms to<span class="_ _3"></span> </div><div class="t m0 xd hd y147 ff64 fs7 fc3 sc0 ls21 ws1">include C and Assembly Language modules in Andr<span class="_ _3"></span>oid or iOS projects<span class="_ _3"></span>.</div><div class="t m0 xd h15 y163 ff68 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Creating anAndroid App</div><div class="t m0 xd hd y164 ff64 fs7 fc3 sc0 ls1 ws1">In this section, we let Android S<span class="_ _3"></span>tudio do as much of the work as possible<span class="_ _1"></span>. </div><div class="t m0 xd hd y165 ff64 fs7 fc3 sc0 ls1 ws1">It’<span class="_ _6"></span>s a powerful tool, so we’ll take advantage of it. I<span class="_ _3"></span>n Chapter <span class="fc5">3</span>, “T<span class="_ _6"></span>ooling Up<span class="_ _1"></span>,<span class="_ _8"></span>” </div><div class="t m0 xd hd y166 ff64 fs7 fc3 sc0 ls1 ws1">we used the fact that Android is based on Linux, to find the standard GNU </div><div class="t m0 xd hd y167 ff64 fs7 fc3 sc0 ls1 ws1">tools in the Android SDK and built an Andr<span class="_ _1"></span>oid application exactly like we </div><div class="t m0 xd hd y168 ff64 fs7 fc3 sc0 ls1 ws1">built any other Linux applica<span class="_ _3"></span>tion. However<span class="_ _10"></span>, Android is designed to run </div><div class="t m0 xd hd y169 ff64 fs7 fc3 sc0 ls1 ws1">apps, r<span class="_ _1"></span>ather than regular Linux pr<span class="_ _3"></span>ograms<span class="_ _1"></span>.</div><div class="t m0 xc hd y487 ff64 fs7 fc3 sc0 ls1 ws1">Android apps ar<span class="_ _1"></span>e L<span class="_ _0"></span>in<span class="_ _3"></span>ux progr<span class="_ _3"></span>ams that use a specific progr<span class="_ _1"></span>amming </div><div class="t m0 xd hd y488 ff64 fs7 fc3 sc0 ls1 ws1">framework and set of libr<span class="_ _3"></span>aries<span class="_ _0"></span>; Android apps</div><div class="t m0 xa hd yeb1 ff64 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>All beha<span class="_ _3"></span>ve in a similar manner</div><div class="t m0 xa hd yeb2 ff64 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Are easy to deplo<span class="_ _1"></span>y from the Google Play store</div><div class="t m0 xa hd yeb3 ff64 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Pro<span class="_ _3"></span>vide a good user experience</div><div class="t m0 xc hd yeb4 ff64 fs7 fc3 sc0 ls1 ws1">Most Andr<span class="_ _3"></span>oid applications ar<span class="_ _1"></span>e wr<span class="_ _0"></span>itten in either the J<span class="_ _1"></span>ava or K<span class="_ _1"></span>otlin </div><div class="t m0 xd hd yeb5 ff64 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming languages<span class="_ _1"></span>. B<span class="_ _0"></span>oth langua<span class="_ _3"></span>ges compile to a machine- </div><div class="t m0 xd hd yeb6 ff64 fs7 fc3 sc0 ls1 ws1">independent format tha<span class="_ _3"></span>t is then run on a virtual machine runtime. This </div><div class="t m0 xd hd yeb7 ff64 fs7 fc3 sc0 ls1 ws1">places them somewhere between fully compiled and fully interpr<span class="_ _3"></span>eted </div><div class="t m0 xd hd yeb8 ff64 fs7 fc3 sc0 ls1 ws1">languages<span class="_ _3"></span>. The benefit is to get some performance gain from being </div><div class="t m0 xd hd yeb9 ff64 fs7 fc3 sc0 ls1 ws1">compiled while rem<span class="_ _3"></span>aining machine independent, s<span class="_ _3"></span>ince they can run </div><div class="t m0 xd hd yeba ff64 fs7 fc3 sc0 ls1 ws1">anywhere th<span class="_ _3"></span>at the runtime is ported.</div><div class="t m0 xc hd yebb ff64 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">9</span>, “I<span class="_ _3"></span>nter<span class="_ _3"></span>acting with C and Python,<span class="_ _10"></span>” we learned how to call </div><div class="t m0 xd hd yebc ff64 fs7 fc3 sc0 ls1 ws1">our Assembly Language r<span class="_ _1"></span>outines and how it is simple to do if we follow </div><div class="t m0 xd hd yebd ff64 fs7 fc3 sc0 ls1 ws1">the ARM function calling conv<span class="_ _3"></span>entions<span class="_ _3"></span>. J<span class="_ _1"></span>ava and Kotlin tak<span class="_ _3"></span>e a differen<span class="_ _3"></span>t </div><div class="t m0 xd hd yebe ff64 fs7 fc3 sc0 ls1 ws1">approach to in<span class="_ _3"></span>teracting with C and Assembly Lang<span class="_ _3"></span>uage code; they want </div><div class="t m0 xd hd yebf ff64 fs7 fc3 sc0 ls1 ws1">to make the C or Assembly Lang<span class="_ _3"></span>uage code look like J<span class="_ _1"></span>ava or K<span class="_ _3"></span>otlin routines </div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:312.262000px;bottom:457.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:161.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff1" class="pf w2 h6" data-page-no="f1"><div class="pc pcf1 w2 h6"><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">227</div><div class="t m0 xc hd y145 ff64 fs7 fc3 sc0 ls1 ws1">to the J<span class="_ _1"></span>ava or K<span class="_ _3"></span>otlin progr<span class="_ _3"></span>ammer<span class="_ _6"></span>. They requir<span class="_ _3"></span>e that a <span class="ff6a">wr<span class="_ _3"></span>apper<span class="ff64"> layer is </span></span></div><div class="t m0 xc hd y146 ff64 fs7 fc3 sc0 ls1 ws1">crea<span class="_ _3"></span>ted to translate between the J<span class="_ _1"></span>ava or K<span class="_ _1"></span>otlin and the C or Ass<span class="_ _0"></span>embly </div><div class="t m0 xc hd y147 ff64 fs7 fc3 sc0 ls1 ws1">Language worlds<span class="_ _3"></span>. In this chapter<span class="_ _10"></span>, we learn how to create s<span class="_ _3"></span>uch a wrapper </div><div class="t m0 xc hd y1b0 ff64 fs7 fc3 sc0 ls1 ws1">for our shar<span class="_ _3"></span>ed library, so it can be used by J<span class="_ _3"></span>av<span class="_ _3"></span>a or Kotlin pr<span class="_ _1"></span>ograms.</div><div class="t m0 x1c hd y1b1 ff64 fs7 fc3 sc0 ls1 ws1">Previously, we used the standar<span class="_ _3"></span>d make tool to build our pr<span class="_ _1"></span>ograms. </div><div class="t m0 xc hd y218 ff64 fs7 fc3 sc0 ls1 ws1">Android S<span class="_ _3"></span>tudio uses the <span class="ff6a">Gradle</span> build system to build the K<span class="_ _1"></span>otlin and Ja<span class="_ _1"></span>va </div><div class="t m0 xc hd y219 ff64 fs7 fc3 sc0 ls1 ws1">components<span class="_ _3"></span>, as well as to package the whole thing into an Andr<span class="_ _1"></span>oid app </div><div class="t m0 xc hd y1b4 ff64 fs7 fc3 sc0 ls1 ws1">package<span class="_ _3"></span>. However<span class="_ _10"></span>, <span class="ff6a ls1a wsbd">C<span class="_ _0"></span>Make</span> builds the C and Assembly Language portions </div><div class="t m0 xc hd y1b5 ff64 fs7 fc3 sc0 ls1 ws1">of the project. These ar<span class="_ _1"></span>e both op<span class="_ _0"></span>en sour<span class="_ _3"></span>ce build systems<span class="_ _1"></span>, and like <span class="ff6a ls1a wsbd">m<span class="_ _0"></span>ake</span>, </div><div class="t m0 xc hd y1b6 ff64 fs7 fc3 sc0 ls1 ws1">they define rules and dependencies to perfor<span class="_ _0"></span>m the build. W<span class="_ _1"></span>e won’t go into </div><div class="t m0 xc hd y1b7 ff64 fs7 fc3 sc0 ls1 ws1">the details of these systems, b<span class="_ _3"></span>ut will point out where we need to add our </div><div class="t m0 xc hd y942 ff64 fs7 fc3 sc0 ls1 ws1">code, so it will be built correctly.</div><div class="t m0 x1c hd y943 ff64 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o demonstrate all of this<span class="_ _3"></span>, we will build a simple Android app wher<span class="_ _1"></span>e </div><div class="t m0 xc hd y944 ff64 fs7 fc3 sc0 ls1 ws1">you enter text<span class="_ _3"></span>, and when you tap a but<span class="_ _3"></span>ton, the text will be displayed in </div><div class="t m0 xc hd y945 ff64 fs7 fc3 sc0 ls1 ws1">upper<span class="_ _1"></span>-case. The user interface (UI) will be defined in XML and controlled </div><div class="t m0 xc hd ya1e ff64 fs7 fc3 sc0 ls1 ws1">by a K<span class="_ _1"></span>otlin program, but the work of con<span class="_ _1"></span>verting to upper-c<span class="_ _3"></span>ase will be </div><div class="t m0 xc hd ya1f ff64 fs7 fc3 sc0 ls1 ws1">handled by the trusty r<span class="_ _3"></span>outine we developed in Chapter <span class="fc5">6</span>, “F<span class="_ _3"></span>unctions and </div><div class="t m0 xc hd ya20 ff64 fs7 fc3 sc0 ls1 ws1">the Stack.<span class="_ _8"></span>” So<span class="_ _1"></span>, without further ado, let’<span class="_ _6"></span>s power up Android Studio<span class="_ _1"></span>.</div><div class="t m0 xc ha y888 ff68 fs6 fc3 sc0 ls1 wsb1"> Create <span class="_ _14"> </span>theProject</div><div class="t m0 xc hd ydb0 ff64 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o create our a<span class="_ _3"></span>pp</div><div class="t m0 x1c hd y2eb ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Run Andr<span class="_ _3"></span>oid Studio<span class="_ _1"></span>.</div><div class="t m0 x1c hd yec0 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>From the “N<span class="_ _3"></span>ew Project” dialog box, choose the </div><div class="t m0 x9 hd yec1 ff64 fs7 fc3 sc0 ls1 ws1">project type as “N<span class="_ _1"></span>ative C++” as shown in Figur<span class="_ _3"></span>e<span class="fc5">10-1</span>.</div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:311.000000px;bottom:321.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff2" data-dest-detail='[242,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:323.540000px;bottom:181.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff2" class="pf w2 h6" data-page-no="f2"><div class="pc pcf2 w2 h6"><img class="bi x2 yec2 w6 h4b" alt="" src="bgf2.png"/><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">228</div><div class="t m0 xc hd yec3 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>On the next dialog box, cho<span class="_ _0"></span>ose our pr<span class="_ _1"></span>oj<span class="_ _0"></span>ect name<span class="_ _1"></span>, </div><div class="t m0 x1e hd yec4 ff64 fs7 fc3 sc0 ls1 ws1">in our case “T<span class="_ _6"></span>oUpper<span class="_ _0"></span>”; keep the language as K<span class="_ _1"></span>otlin </div><div class="t m0 x1e hd yec5 ff64 fs7 fc3 sc0 ls1 ws1">and select “<span class="_ _10"></span>API21: Android 5.0 (Lollipop)” as the </div><div class="t m0 x1e hd yec6 ff64 fs7 fc3 sc0 ls1 ws1">minimum API level. I chose this API level since it </div><div class="t m0 x1e hd yec7 ff64 fs7 fc3 sc0 ls1 ws1">is the first one with 64-bit support. Y<span class="_ _6"></span>ou may need </div><div class="t m0 x1e hd yec8 ff64 fs7 fc3 sc0 ls1 ws1">to choose a different vers<span class="_ _3"></span>ion depending on your </div><div class="t m0 x1e hd yec9 ff64 fs7 fc3 sc0 ls1 ws1">requir<span class="_ _3"></span>ements<span class="_ _3"></span>, as shown in Fi<span class="_ _3"></span>gure<span class="fc5">10-2</span>.</div><div class="t m0 xd h37 yeca ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-1. <span class="_ _15"> </span><span class="ff65">Select a “Native C++” project type</span></div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pff3" data-dest-detail='[243,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:240.377000px;bottom:196.507000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff3" class="pf w2 h6" data-page-no="f3"><div class="pc pcf3 w2 h6"><img class="bi x2e yec2 w6 h4b" alt="" src="bgf3.png"/><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">229</div><div class="t m0 x1c hd yecb ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Click the “Next” button and accept the defa<span class="_ _3"></span>ults on </div><div class="t m0 x9 hd yecc ff64 fs7 fc3 sc0 ls1 ws1">the third scr<span class="_ _3"></span>een by clicking “F<span class="_ _1"></span>inish.<span class="_ _8"></span>” This creates an </div><div class="t m0 x9 hd yecd ff64 fs7 fc3 sc0 ls1 ws1">Android applic<span class="_ _3"></span>ation with the main code generated </div><div class="t m0 x9 hd yece ff64 fs7 fc3 sc0 ls1 ws1">in Kotlin and a sin<span class="_ _3"></span>gle view as the UI.The project </div><div class="t m0 x9 hd yecf ff64 fs7 fc3 sc0 ls1 ws1">contains a C++ file which r<span class="_ _3"></span>eturns a har<span class="_ _3"></span>d-coded </div><div class="t m0 x9 hd yed0 ff64 fs7 fc3 sc0 ls1 ws1">string to display in the UI.W<span class="_ _1"></span>e can now build and </div><div class="t m0 x9 hd yed1 ff64 fs7 fc3 sc0 ls1 ws1">run our app to ensure everything is installed and </div><div class="t m0 x9 hd yed2 ff64 fs7 fc3 sc0 ls1 ws1">working correctly. F<span class="_ _1"></span>igure<span class="fc5">10-3</span> shows the important </div><div class="t m0 x9 hd yed3 ff64 fs7 fc3 sc0 ls1 ws1">files that wer<span class="_ _3"></span>e crea<span class="_ _3"></span>ted.</div><div class="t m0 xc h37 yed4 ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-2. <span class="_ _15"> </span><span class="ff65">Second screen in the new project wizard</span></div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pff4" data-dest-detail='[244,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:219.471000px;bottom:180.301000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff4" class="pf w2 h6" data-page-no="f4"><div class="pc pcf4 w2 h6"><img class="bi x44 yed5 w14 h4c" alt="" src="bgf4.png"/><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">230</div><div class="t m0 xc hd yed6 ff64 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we can start our app by cr<span class="_ _3"></span>eating our UI either b<span class="_ _1"></span>y wr<span class="_ _0"></span>iting XML or </div><div class="t m0 xd hd yed7 ff64 fs7 fc3 sc0 ls1 ws1">using the Android S<span class="_ _3"></span>tudio screen design tool.</div><div class="t m0 xd ha yed8 ff68 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>XML Screen Definition</div><div class="t m0 xd hd yed9 ff64 fs7 fc3 sc0 ls1 ws1">The XML code is included here<span class="_ _3"></span>, but you typically cr<span class="_ _1"></span>eate this in the design </div><div class="t m0 xd hd yeda ff64 fs7 fc3 sc0 ls1 ws1">tool as shown in Fig<span class="_ _3"></span>ure<span class="fc5">10-4</span>.</div><div class="t m0 xd h37 yedb ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-3. <span class="_ _15"> </span><span class="ff65">Some of the files created by the wizard</span></div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pff5" data-dest-detail='[245,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:146.054000px;bottom:112.987000px;width:20.548000px;height:12.275000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff5" class="pf w2 h6" data-page-no="f5"><div class="pc pcf5 w2 h6"><img class="bi x2e yedc w6 h4d" alt="" src="bgf5.png"/><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">231</div><div class="t m0 x1c hd yedd ff64 fs7 fc3 sc0 ls10 ws1">The XML version of the screen, activity_main.xml, is sho<span class="_ _3"></span>wn in </div><div class="t m0 xc hd yede ff64 fs7 fc3 sc0 ls10 ws37">Listing <span class="fc5">10-1</span><span class="ws1">. Most of this XML was generated b<span class="_ _3"></span>y the crea<span class="_ _3"></span>te project<span class="_ _3"></span> </span></div><div class="t m0 xc hd yedf ff64 fs7 fc3 sc0 ls10 ws1">wizard; then the contr<span class="_ _1"></span>ols w<span class="_ _0"></span>e need were added in the scr<span class="_ _3"></span>een design tool.</div><div class="t m0 xc h20 yee0 ff6b fs3 fc3 sc0 ls1 ws1">Listing 10-1. <span class="_ _15"> </span><span class="ff64">The XML screen definition activity_main.xml  </span></div><div class="t m0 xc h20 yee1 ff64 fs3 fc3 sc0 ls1 ws1">for our app</div><div class="t m0 xc h18 yee2 ff6c fs7 fc3 sc0 ls1 ws1">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="t m0 xc h18 yee3 ff6c fs7 fc3 sc0 ls1 ws1">&lt;androidx.constraintlayout.widget.ConstraintLayout </div><div class="t m0 xc h18 yee4 ff6c fs7 fc3 sc0 ls1 ws1">xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="t m0 xc h18 yee5 ff6c fs7 fc3 sc0 ls1 ws1">    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="t m0 xc h18 yee6 ff6c fs7 fc3 sc0 ls1 ws1">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="t m0 xc h18 yee7 ff6c fs7 fc3 sc0 ls1 ws1">    android:layout_width=&quot;match_parent&quot;</div><div class="t m0 xc h18 yee8 ff6c fs7 fc3 sc0 ls1 ws1">    android:layout_height=&quot;match_parent&quot;</div><div class="t m0 xc h18 yee9 ff6c fs7 fc3 sc0 ls1 ws1">    tools:context=&quot;.MainActivity&quot;&gt;</div><div class="t m0 xc h18 yeea ff6c fs7 fc3 sc0 ls1 ws1">    &lt;EditText</div><div class="t m0 xc h18 yeeb ff6c fs7 fc3 sc0 ls1 ws1">        android:id=&quot;@+id/enterText&quot;</div><div class="t m0 xc h18 yeec ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_width=&quot;wrap_content&quot;</div><div class="t m0 xc h18 yeed ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_height=&quot;wrap_content&quot;</div><div class="t m0 xc h37 yeee ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-4. <span class="_ _15"> </span><span class="ff65">The UI in the screen design tool</span></div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pff5" data-dest-detail='[245,"XYZ",53,329,null]'><div class="d m1" style="border-style:none;position:absolute;left:89.199400px;bottom:358.587000px;width:21.119600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff6" class="pf w2 h6" data-page-no="f6"><div class="pc pcf6 w2 h6"><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">232</div><div class="t m0 xd h18 y46b ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_marginStart=&quot;92dp&quot;</div><div class="t m0 xd h18 y46c ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_marginTop=&quot;144dp&quot;</div><div class="t m0 xd h18 y46d ff6c fs7 fc3 sc0 ls1 ws1">        android:ems=&quot;10&quot;</div><div class="t m0 xd h18 y623 ff6c fs7 fc3 sc0 ls1 ws1">        android:hint=&quot;Enter some text&quot;</div><div class="t m0 xd h18 y624 ff6c fs7 fc3 sc0 ls1 ws1">        android:inputType=&quot;textPersonName&quot;</div><div class="t m0 xd h18 y625 ff6c fs7 fc3 sc0 ls1 ws1">        app:layout_constraintStart_toStartOf=&quot;parent&quot;</div><div class="t m0 xd h18 y626 ff6c fs7 fc3 sc0 ls1 ws1">        app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;</div><div class="t m0 xd h18 y847 ff6c fs7 fc3 sc0 ls1 ws1">    &lt;TextView</div><div class="t m0 xd h18 y85f ff6c fs7 fc3 sc0 ls1 ws1">        android:id=&quot;@+id/convertedText&quot;</div><div class="t m0 xd h18 y629 ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_width=&quot;wrap_content&quot;</div><div class="t m0 xd h18 y62a ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_height=&quot;wrap_content&quot;</div><div class="t m0 xd h18 y62b ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_marginStart=&quot;92dp&quot;</div><div class="t m0 xd h18 y9f9 ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_marginTop=&quot;272dp&quot;</div><div class="t m0 xd h18 y9fa ff6c fs7 fc3 sc0 ls1 ws1">        android:text=&quot;Converted text&quot;</div><div class="t m0 xd h18 y9fb ff6c fs7 fc3 sc0 ls1 ws1">        app:layout_constraintStart_toStartOf=&quot;parent&quot;</div><div class="t m0 xd h18 y9fc ff6c fs7 fc3 sc0 ls1 ws1">        app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;</div><div class="t m0 xd h18 yc40 ff6c fs7 fc3 sc0 ls1 ws1">    &lt;Button</div><div class="t m0 xd h18 yc41 ff6c fs7 fc3 sc0 ls1 ws1">        android:id=&quot;@+id/convert&quot;</div><div class="t m0 xd h18 yc42 ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_width=&quot;wrap_content&quot;</div><div class="t m0 xd h18 ya18 ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_height=&quot;wrap_content&quot;</div><div class="t m0 xd h18 ya01 ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_marginStart=&quot;180dp&quot;</div><div class="t m0 xd h18 ya02 ff6c fs7 fc3 sc0 ls1 ws1">        android:layout_marginTop=&quot;412dp&quot;</div><div class="t m0 xd h18 ya03 ff6c fs7 fc3 sc0 ls1 ws1">        android:onClick=&quot;convertMessage&quot;</div><div class="t m0 xd h18 ya04 ff6c fs7 fc3 sc0 ls1 ws1">        android:text=&quot;Convert Text&quot;</div><div class="t m0 xd h18 ya05 ff6c fs7 fc3 sc0 ls1 ws1">        app:layout_constraintStart_toStartOf=&quot;parent&quot;</div><div class="t m0 xd h18 ya06 ff6c fs7 fc3 sc0 ls1 ws1">        app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;</div><div class="t m0 xd h18 yd56 ff6c fs7 fc3 sc0 ls1 ws1">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff7" class="pf w2 h6" data-page-no="f7"><div class="pc pcf7 w2 h6"><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">233</div><div class="t m0 x1c hd y145 ff64 fs7 fc3 sc0 ls1 ws1">The important parts of this are tha<span class="_ _3"></span>t we added</div><div class="t m0 x1e hd y58c ff64 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>An <span class="ff6a">EditT<span class="_ _6"></span>ext<span class="ff64"> control with id enterT<span class="_ _6"></span>ext, wher<span class="_ _1"></span>e you type </span></span></div><div class="t m0 x9 hd y1fe ff64 fs7 fc3 sc0 ls1 ws1">the text to be converted to upper<span class="_ _1"></span>-case</div><div class="t m0 x1e hd yc8a ff64 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A <span class="ff6a">ViewT<span class="_ _6"></span>ext<span class="ff64"> contr<span class="_ _1"></span>ol w<span class="_ _0"></span>ith id conv<span class="_ _3"></span>ertedT<span class="_ _6"></span>ext to display the </span></span></div><div class="t m0 x9 hd y6e2 ff64 fs7 fc3 sc0 ls1 ws1">converted string</div><div class="t m0 x1e hd yeef ff64 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>A <span class="ff6a">Button</span> with id con<span class="_ _3"></span>vert and onClick convertMessa<span class="_ _3"></span>ge </div><div class="t m0 x9 hd y6e3 ff64 fs7 fc3 sc0 ls1 ws1">to trigger the conversion</div><div class="t m0 x1c hd yef0 ff64 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we look at the K<span class="_ _3"></span>otlin part of the app<span class="_ _1"></span>.</div><div class="t m0 xc ha ybe2 ff68 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Kotlin Main Program</div><div class="t m0 xc hd y3ef ff64 fs7 fc3 sc0 ls1 ws1">The K<span class="_ _3"></span>otlin file is shown in Listing <span class="fc5">10-2</span>. Most of this code was cr<span class="_ _1"></span>eated by </div><div class="t m0 xc hd yef1 ff64 fs7 fc3 sc0 ls1 ws1">the crea<span class="_ _3"></span>te project wizard.</div><div class="t m0 xc h20 y9a7 ff6b fs3 fc3 sc0 ls1 ws1">Listing 10-2. <span class="_ _15"> </span><span class="ff64">Kotlin m<span class="_ _3"></span>ain progr<span class="_ _1"></span>am MainActivity.k<span class="_ _3"></span>t of our app</span></div><div class="t m0 xc h18 y9a8 ff6c fs7 fc3 sc0 ls1 ws1">package com.example.toupper</div><div class="t m0 xc h18 yef2 ff6c fs7 fc3 sc0 ls1 ws1">import androidx.appcompat.app.AppCompatActivity</div><div class="t m0 xc h18 yef3 ff6c fs7 fc3 sc0 ls1 ws1">import android.os.Bundle</div><div class="t m0 xc h18 yef4 ff6c fs7 fc3 sc0 ls1 ws1">import android.view.View</div><div class="t m0 xc h18 yef5 ff6c fs7 fc3 sc0 ls1 ws1">import android.widget.EditText</div><div class="t m0 xc h18 yc1c ff6c fs7 fc3 sc0 ls1 ws1">import android.widget.TextView</div><div class="t m0 xc h18 yef6 ff6c fs7 fc3 sc0 ls1 ws1">import kotlinx.android.synthetic.main.activity_main.*</div><div class="t m0 xc h18 yc1e ff6c fs7 fc3 sc0 ls1 ws1">class MainActivity : AppCompatActivity() {</div><div class="t m0 xc h18 yef7 ff6c fs7 fc3 sc0 ls1 ws1">    override fun onCreate(savedInstanceState: Bundle?) {</div><div class="t m0 xc h18 yef8 ff6c fs7 fc3 sc0 ls1 ws1">        super.onCreate(savedInstanceState)</div><div class="t m0 xc h18 yef9 ff6c fs7 fc3 sc0 ls1 ws1">        setContentView(R.layout.activity_main)</div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pff7" data-dest-detail='[247,"XYZ",53,348,null]'><div class="d m1" style="border-style:none;position:absolute;left:211.176000px;bottom:377.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff8" class="pf w2 h6" data-page-no="f8"><div class="pc pcf8 w2 h6"><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">234</div><div class="t m0 xd h18 y46b ff6c fs7 fc3 sc0 ls1 ws1">        // Example of a call to a native method</div><div class="t m0 xd h18 y46c ff6c fs7 fc3 sc0 ls1 ws1">        //sample_text.text = stringFromJNI()</div><div class="t m0 xd h18 y46d ff6c fs7 fc3 sc0 ls1 ws1">    }</div><div class="t m0 xd h18 y85c ff6c fs7 fc3 sc0 ls1 ws1">    /** Called when the user taps the Send button */</div><div class="t m0 xd h18 y46f ff6c fs7 fc3 sc0 ls1 ws1">    fun convertMessage(view: View) {</div><div class="t m0 xd h18 y85d ff6c fs7 fc3 sc0 ls1 ws1">        // Do something in response to button</div><div class="t m0 xd h18 y85e ff6c fs7 fc3 sc0 ls1 ws1">        val editText = findViewById&lt;EditText&gt;(R.id.enterText)</div><div class="t m0 xd h18 y847 ff6c fs7 fc3 sc0 ls1 ws1">        val message = toupperJNI(editText.text.toString())</div><div class="t m0 xd h18 y85f ff6c fs7 fc3 sc0 ls1 ws1">         <span class="_ _20"></span>val textView = findViewById&lt;TextView&gt;(R.id. </div><div class="t m0 x4f h18 y629 ff6c fs7 fc3 sc0 ls1 ws1">convertedText).apply {</div><div class="t m0 xd h18 y62a ff6c fs7 fc3 sc0 ls1 ws1">            text = message</div><div class="t m0 xd h18 y62b ff6c fs7 fc3 sc0 ls1 ws1">        }</div><div class="t m0 xd h18 y9f9 ff6c fs7 fc3 sc0 ls1 ws1">    }</div><div class="t m0 xd h18 y860 ff6c fs7 fc3 sc0 ls1 ws1">    /**</div><div class="t m0 xd h18 y861 ff6c fs7 fc3 sc0 ls1 ws1">      <span class="_ _20"></span>* A native method that is implemented by the &apos;native-lib&apos; </div><div class="t m0 xa h18 yc3f ff6c fs7 fc3 sc0 ls1 ws1">native library,</div><div class="t m0 xd h18 yc40 ff6c fs7 fc3 sc0 ls1 ws1">     * which is packaged with this application.</div><div class="t m0 xd h18 yc41 ff6c fs7 fc3 sc0 ls1 ws1">     */</div><div class="t m0 xd h18 yc42 ff6c fs7 fc3 sc0 ls1 ws1">    external fun toupperJNI(input: String): String</div><div class="t m0 xd h18 y852 ff6c fs7 fc3 sc0 ls1 ws1">    companion object {</div><div class="t m0 xd h18 yc43 ff6c fs7 fc3 sc0 ls1 ws1">         <span class="_ _20"></span>// Used to load the &apos;native-lib&apos; library on application </div><div class="t m0 x4f h18 yc44 ff6c fs7 fc3 sc0 ls1 ws1">startup.</div><div class="t m0 xd h18 yefa ff6c fs7 fc3 sc0 ls1 ws1">        init {</div><div class="t m0 xd h18 yefb ff6c fs7 fc3 sc0 ls1 ws1">            System.loadLibrary(&quot;native-lib&quot;)</div><div class="t m0 xd h18 yefc ff6c fs7 fc3 sc0 ls1 ws1">        }</div><div class="t m0 xd h18 ya19 ff6c fs7 fc3 sc0 ls1 ws1">    }</div><div class="t m0 xd h18 yd70 ff6c fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pff9" class="pf w2 h6" data-page-no="f9"><div class="pc pcf9 w2 h6"><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">235</div><div class="t m0 x1c hd y145 ff64 fs7 fc3 sc0 ls1 ws1">The new project wizar<span class="_ _3"></span>d created a sim<span class="_ _3"></span>ple C++ shared object called </div><div class="t m0 xc hd y146 ff64 fs7 fc3 sc0 ls1 ws1">native-lib and included the S<span class="_ _3"></span>ystem.loadLibr<span class="_ _3"></span>ary co<span class="_ _0"></span>de to load it for us<span class="_ _1"></span>. We </div><div class="t m0 xc hd y147 ff64 fs7 fc3 sc0 ls1 ws1">will add our Assembly Language code to this na<span class="_ _3"></span>tive-lib<span class="_ _1"></span>.</div><div class="t m0 x1c hd y1b0 ff64 fs7 fc3 sc0 ls1 ws1">In the activity_main.xml file<span class="_ _3"></span>, we set the onClick event for the button to </div><div class="t m0 xc hd y1b1 ff64 fs7 fc3 sc0 ls1 ws1">convertMess<span class="_ _3"></span>age. This connects the but<span class="_ _3"></span>ton to the convertMes<span class="_ _3"></span>sage function </div><div class="t m0 xc hd y218 ff64 fs7 fc3 sc0 ls1 ws1">in our main K<span class="_ _1"></span>otlin file. This convertMessa<span class="_ _3"></span>ge function gets the text from the </div><div class="t m0 xc hd y219 ff64 fs7 fc3 sc0 ls1 ws1">EditT<span class="_ _6"></span>ext contr<span class="_ _3"></span>ol with id enterT<span class="_ _6"></span>ext, calls toupperJNI which is the wr<span class="_ _3"></span>apper </div><div class="t m0 xc hd y1b4 ff64 fs7 fc3 sc0 ls1 ws1">function for our Assembly Language upper<span class="_ _1"></span>-case routine<span class="_ _1"></span>, and then places </div><div class="t m0 xc hd y1b5 ff64 fs7 fc3 sc0 ls1 ws1">the result in the T<span class="_ _10"></span>extView with id convertedT<span class="_ _6"></span>ext.</div><div class="t m0 x1c hd y1b6 ff64 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we’ll look at the C++ wr<span class="_ _3"></span>apper code.</div><div class="t m0 xc ha y49b ff68 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>The C++ Wrapper</div><div class="t m0 xc hd y2af ff64 fs7 fc3 sc0 ls18 ws1">T<span class="_ _6"></span>o call C, C++, or Assembly Language code from K<span class="_ _3"></span>otlin or J<span class="_ _1"></span>ava, we use the </div><div class="t m0 xc hd yefd ff64 fs7 fc3 sc0 ls18 ws1">J<span class="_ _1"></span>ava N<span class="_ _1"></span>ative Interface (<span class="ff6a ls16 wsb9">JNI</span>). When Ja<span class="_ _1"></span>va or Kotlin call na<span class="_ _3"></span>tive code, it uses a </div><div class="t m0 xc hd yefe ff64 fs7 fc3 sc0 ls18 ws1">specific interface and uses specialized data types. W<span class="_ _1"></span>e need to write a layer of </div><div class="t m0 xc hd y49e ff64 fs7 fc3 sc0 ls18 ws1">code to translate fr<span class="_ _1"></span>om the interface JNI uses to that of our routine<span class="_ _1"></span>. Another<span class="_ _0"></span> </div><div class="t m0 xc hd y49f ff64 fs7 fc3 sc0 ls18 ws1">approach would be to r<span class="_ _1"></span>ewr<span class="_ _0"></span>ite our Assembl<span class="_ _3"></span>y Language upper<span class="_ _1"></span>-case routine </div><div class="t m0 xc hd y4a0 ff64 fs7 fc3 sc0 ls18 ws1">to take this as its nativ<span class="_ _3"></span>e API, but then it becomes specialized to only being </div><div class="t m0 xc hd y4a1 ff64 fs7 fc3 sc0 ls18 ws1">called by JNI.Wha<span class="_ _3"></span>t we are showing her<span class="_ _1"></span>e is the way native code is usually </div><div class="t m0 xc hd y4a2 ff64 fs7 fc3 sc0 ls18 ws1">connected to J<span class="_ _3"></span>a<span class="_ _3"></span>va or K<span class="_ _3"></span>otlin. Listing <span class="fc5 wsc0">10-3</span> shows the C++ wrapper code<span class="_ _1"></span>.</div><div class="t m0 xc h20 yeff ff6b fs3 fc3 sc0 ls1 ws1">Listing 10-3. <span class="_ _15"> </span><span class="ff64">C++ wrapper code in na<span class="_ _3"></span>tive-lib<span class="_ _1"></span>.cpp</span></div><div class="t m0 xc h18 yf00 ff6c fs7 fc3 sc0 ls1 ws1">#include &lt;jni.h&gt;</div><div class="t m0 xc h18 yf01 ff6c fs7 fc3 sc0 ls1 ws1">#include &lt;string&gt;</div><div class="t m0 xc h18 yf02 ff6c fs7 fc3 sc0 ls1 ws1">extern &quot;C&quot; int mytoupper( const char * input, char * output);</div><div class="t m0 xc h18 yf03 ff6c fs7 fc3 sc0 ls1 ws1">extern &quot;C&quot; JNIEXPORT jstring JNICALL</div><div class="t m0 xc h18 yf04 ff6c fs7 fc3 sc0 ls1 ws1">Java_com_example_toupper_MainActivity_toupperJNI(</div><div class="t m0 xc h18 yf05 ff6c fs7 fc3 sc0 ls1 ws1">        JNIEnv* env,</div><div class="t m0 xc h18 yf06 ff6c fs7 fc3 sc0 ls1 ws1">        jobject /* this */,</div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pff9" data-dest-detail='[249,"XYZ",53,244,null]'><div class="d m1" style="border-style:none;position:absolute;left:216.083000px;bottom:257.362000px;width:20.240000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pffa" class="pf w2 h6" data-page-no="fa"><div class="pc pcfa w2 h6"><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">236</div><div class="t m0 xd h18 y46b ff6c fs7 fc3 sc0 ls1 ws1">        jstring input) {</div><div class="t m0 xd h18 y46c ff6c fs7 fc3 sc0 ls1 ws1">    char upperStr[255];</div><div class="t m0 xd h18 ya17 ff6c fs7 fc3 sc0 ls1 ws1">    mytoupper(env-&gt;GetStringUTFChars(input, NULL), upperStr);</div><div class="t m0 xd h18 y46e ff6c fs7 fc3 sc0 ls1 ws1">    return env-&gt;NewStringUTF(upperStr);</div><div class="t m0 xd h18 y46f ff6c fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 xc hd y470 ff64 fs7 fc3 sc0 ls1 ws1">Whenever JNI calls a nativ<span class="_ _3"></span>e routine<span class="_ _1"></span>, the first two arguments are </div><div class="t m0 xd hd y471 ff64 fs7 fc3 sc0 ls1 ws1">standard and give us acces<span class="_ _3"></span>s to C++ objects where we can call other </div><div class="t m0 xd hd y472 ff64 fs7 fc3 sc0 ls1 ws1">functions or get relevan<span class="_ _3"></span>t data. The thir<span class="_ _1"></span>d argument is our string we want </div><div class="t m0 xd hd y473 ff64 fs7 fc3 sc0 ls1 ws1">converted. This is passed to us as a J<span class="_ _1"></span>ava/K<span class="_ _1"></span>otlin Unicode str<span class="_ _0"></span>ing. W<span class="_ _1"></span>e use </div><div class="t m0 xd hd y849 ff64 fs7 fc3 sc0 ls1 ws1">the GetStringU<span class="_ _0"></span>TFCh<span class="_ _3"></span>ars member of the env v<span class="_ _3"></span>ariable to convert it to a </div><div class="t m0 xd hd y84a ff64 fs7 fc3 sc0 ls1 ws1">standard C ASCII string. Then we use NewS<span class="_ _3"></span>tringUTF to convert our result </div><div class="t m0 xd hd yb7c ff64 fs7 fc3 sc0 ls1 ws1">to a J<span class="_ _1"></span>ava/K<span class="_ _3"></span>otlin string to return. The c<span class="_ _3"></span>all to mytoupper should be familiar </div><div class="t m0 xd hd yf07 ff64 fs7 fc3 sc0 ls1 ws1">from Ch<span class="_ _3"></span>apter <span class="fc5">9</span>, “Inter<span class="_ _3"></span>acting with C and Python.<span class="_ _8"></span>” The “C” after the <span class="ff6a">extern</span> </div><div class="t m0 xd hd ye03 ff64 fs7 fc3 sc0 ls1 ws1">is important as it tells the compiler this is a strai<span class="_ _3"></span>ght C function with no </div><div class="t m0 xd hd yf08 ff64 fs7 fc3 sc0 ls1 ws1">C++ namespace decora<span class="_ _3"></span>tion added. If you lea<span class="_ _3"></span>ve the “<span class="_ _1"></span>C<span class="_ _0"></span>” out<span class="_ _3"></span>, you will get a </div><div class="t m0 xd hd yc3f ff65 fs7 fc3 sc0 ls1 ws1">Function no<span class="_ _3"></span>t found<span class="ff64"> error from the link<span class="_ _3"></span>er<span class="_ _6"></span>.</span></div><div class="t m0 xc hd yc40 ff64 fs7 fc3 sc0 ls1 ws1">That’<span class="_ _6"></span>s all the code we need, although we still need to add our code </div><div class="t m0 xd hd yd66 ff64 fs7 fc3 sc0 ls1 ws1">from Ch<span class="_ _3"></span>apter <span class="fc5">6</span>, “Functions and the S<span class="_ _1"></span>tack,<span class="_ _8"></span>” to the project and make some </div><div class="t m0 xd hd yd67 ff64 fs7 fc3 sc0 ls1 ws1">changes to complete the build.</div><div class="t m0 xd ha yf09 ff68 fs6 fc3 sc0 ls1 wsb1"> Building <span class="_ _14"> </span>theProject</div><div class="t m0 xd hd yf0a ff64 fs7 fc3 sc0 ls1 ws1">If we build the project now, we will get an error tha<span class="_ _3"></span>t mytoupper is </div><div class="t m0 xd hd yf0b ff64 fs7 fc3 sc0 ls1 ws1">undefined. T<span class="_ _6"></span>o fix this, we do the following:</div><div class="t m0 xc hd yf0c ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Right<span class="_ _1"></span>-click the cpp folder and choose New File<span class="_ _3"></span>.</div><div class="t m0 xc hd yf0d ff64 fs7 fc3 sc0 lsc ws1"> <span class="_ _16"> </span>2.<span class="_ _0"></span> <span class="_ _f"> </span>W<span class="_ _1"></span>e enter the name as upper<span class="_ _6"></span>.s to create a new em<span class="_ _3"></span>pty file.</div><div class="t m0 xc hd yf0e ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Cut and paste o<span class="_ _3"></span>ur code from the upper<span class="_ _10"></span>.s file in </div><div class="t m0 x1e hd yf0f ff64 fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">9</span>, “In<span class="_ _3"></span>teracting with C and Python,<span class="_ _8"></span>” into this </div><div class="t m0 x1e hd yf10 ff64 fs7 fc3 sc0 ls1 ws1">file and sav<span class="_ _3"></span>e it.</div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:101.108000px;bottom:368.999000px;width:5.500000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:101.108000px;bottom:289.186000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:123.031000px;bottom:111.186000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pffb" class="pf w2 h6" data-page-no="fb"><div class="pc pcfb w2 h6"><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">237</div><div class="t m0 x1c hd y145 ff64 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w if we build, we will get a different set of error messages<span class="_ _1"></span>. T<span class="_ _1"></span>o fix </div><div class="t m0 xc hd y146 ff64 fs7 fc3 sc0 ls1 ws1">these, we need to make some changes to the <span class="ff6a ls1a wsbd">CMake<span class="_ _0"></span></span> file<span class="_ _3"></span>.</div><div class="t m0 x1c hd y147 ff64 fs7 fc3 sc0 ls1 ws1">By default, As<span class="_ _3"></span>sembly Language code isn’t allowed, so we must change </div><div class="t m0 xc hd y1b0 ff64 fs7 fc3 sc0 ls1 ws1">a configura<span class="_ _3"></span>tion setting to allow Assembly Langua<span class="_ _3"></span>ge code. Andr<span class="_ _3"></span>oid </div><div class="t m0 xc hd y1b1 ff64 fs7 fc3 sc0 ls1 ws1">supports other processors than 64-bit ARM, so we need to tell the system </div><div class="t m0 xc hd y1b2 ff64 fs7 fc3 sc0 ls1 ws1">that we want to b<span class="_ _3"></span>uild for this. B<span class="_ _3"></span>y default, it builds for 32-bit ARM and this </div><div class="t m0 xc hd y1b3 ff64 fs7 fc3 sc0 ls1 ws1">produces a lot of errors fr<span class="_ _1"></span>om the Assembler<span class="_ _6"></span>.</div><div class="t m0 x1c hd y1b4 ff64 fs7 fc3 sc0 ls1 ws1">In the CM<span class="_ _3"></span>akeLists<span class="_ _3"></span>.txt file, we need to add</div><div class="t m0 xc h18 y610 ff6c fs7 fc3 sc0 ls1 ws1">set(can_use_assembler TRUE)</div><div class="t m0 xc h18 y611 ff6c fs7 fc3 sc0 ls1 ws1">enable_language(ASM)</div><div class="t m0 x1c hd y2e5 ff64 fs7 fc3 sc0 ls1 ws1">near the top after the cmake_minimum_r<span class="_ _1"></span>equired line. This allows the </div><div class="t m0 xc hd yb30 ff64 fs7 fc3 sc0 ls1 ws1">use of Assembly Language in the pr<span class="_ _3"></span>oject.</div><div class="t m0 x1c hd yb31 ff64 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w we need to add upper<span class="_ _6"></span>.s to the source files that m<span class="_ _3"></span>ake up the </div><div class="t m0 xc hd y63e ff64 fs7 fc3 sc0 ls1 ws1">native-lib sh<span class="_ _3"></span>ared library. Add upper<span class="_ _10"></span>.s to the add_librar<span class="_ _0"></span>y definition for </div><div class="t m0 xc hd yb32 ff64 fs7 fc3 sc0 ls1 ws1">native-lib after n<span class="_ _3"></span>ative-lib<span class="_ _1"></span>.cpp<span class="_ _3"></span>.</div><div class="t m0 xc h18 yb33 ff6c fs7 fc3 sc0 ls1 ws1">add_library( # Sets the name of the library.</div><div class="t m0 xc h18 yb34 ff6c fs7 fc3 sc0 ls1 ws1">             native-lib</div><div class="t m0 xc h18 yb35 ff6c fs7 fc3 sc0 ls1 ws1">             # Sets the library as a shared library.</div><div class="t m0 xc h18 yf11 ff6c fs7 fc3 sc0 ls1 ws1">             SHARED</div><div class="t m0 xc h18 y297 ff6c fs7 fc3 sc0 ls1 ws1">             # Provides a relative path to your source file(s).</div><div class="t m0 xc h18 y298 ff6c fs7 fc3 sc0 ls1 ws1">             native-lib.cpp upper.s )</div><div class="t m0 x1c hd yb36 ff64 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, specify our CPU target. Andr<span class="_ _3"></span>oid Studio can b<span class="_ _3"></span>uild C, C++, and </div><div class="t m0 xc hd y557 ff64 fs7 fc3 sc0 ls1 ws1">Assembly code for the ARM processor<span class="_ _10"></span>, either 32 or 64 bits, as well as for </div><div class="t m0 xc hd yb37 ff64 fs7 fc3 sc0 ls1 ws1">Intel CPU<span class="_ _3"></span>s. Since we h<span class="_ _3"></span>ave added an Assembl<span class="_ _3"></span>y Language file that will only </div><div class="t m0 xc hd yb38 ff64 fs7 fc3 sc0 ls1 ws1">compile for 64-bit ARM, we need to let the build system know tha<span class="_ _3"></span>t. W<span class="_ _1"></span>e do </div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pffc" class="pf w2 h6" data-page-no="fc"><div class="pc pcfc w2 h6"><img class="bi x37 yf12 w15 h4e" alt="" src="bgfc.png"/><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">238</div><div class="t m0 xd hd y145 ff64 fs7 fc3 sc0 ls1 ws1">this in one of the Gradle files<span class="_ _3"></span>. W<span class="_ _1"></span>e edit the build.gradle file in the app folder<span class="_ _10"></span>. </div><div class="t m0 xd hd y146 ff64 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e add the following:</div><div class="t m0 xd h18 y2e1 ff6c fs7 fc3 sc0 ls1 ws1">        ndk {</div><div class="t m0 xd h18 y2d7 ff6c fs7 fc3 sc0 ls1 ws1">            abiFilters &apos;arm64-v8a&apos;</div><div class="t m0 xd h18 y2d8 ff6c fs7 fc3 sc0 ls1 ws1">        }</div><div class="t m0 xc hd y2d9 ff64 fs7 fc3 sc0 ls1 ws1">to the defaultConfig section. If you ha<span class="_ _1"></span>ve Assembly Language code for </div><div class="t m0 xd hd y2da ff64 fs7 fc3 sc0 ls1 ws1">other processors<span class="_ _3"></span>, then you can specify which ar<span class="_ _1"></span>e which and allow more </div><div class="t m0 xd hd y231 ff64 fs7 fc3 sc0 ls1 ws1">builds. F<span class="_ _1"></span>or our purposes, we’ll r<span class="_ _1"></span>estr<span class="_ _0"></span>ict ourselves to 64-bit ARM.</div><div class="t m0 xc hd y232 ff64 fs7 fc3 sc0 ls1 ws1">With this complete<span class="_ _1"></span>, w<span class="_ _0"></span>e can build and run our pr<span class="_ _1"></span>oje<span class="_ _0"></span>ct as shown in </div><div class="t m0 xd hd y233 ff64 fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">10-5</span>.</div><div class="t m0 xd h37 yf13 ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-5. <span class="_ _15"> </span><span class="ff65">The Andr<span class="_ _3"></span>oid app in action</span></div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pffc" data-dest-detail='[252,"XYZ",35,403,null]'><div class="d m1" style="border-style:none;position:absolute;left:68.031500px;bottom:417.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pffd" class="pf w2 h6" data-page-no="fd"><div class="pc pcfd w2 h6"><img class="bi xc yf14 w7 h28" alt="" src="bgfd.png"/><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">239</div><div class="t m0 x1c hd y38c ff64 fs7 fc3 sc0 ls1 ws1">That tak<span class="_ _3"></span>es care of one of the m<span class="_ _3"></span>ajor cell phone platforms; now let’<span class="_ _1"></span>s look </div><div class="t m0 xc hd y38d ff64 fs7 fc3 sc0 ls1 ws1">at the other and develop the same app in S<span class="_ _3"></span>wift for iOS.</div><div class="t m0 xc h15 y50d ff68 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Creating aniOS App</div><div class="t m0 xc hd y50e ff64 fs7 fc3 sc0 ls1 ws1">For o<span class="_ _3"></span>ur iOS app<span class="_ _1"></span>, we’ll use Apple’<span class="_ _6"></span>s new Swift progr<span class="_ _3"></span>amming language<span class="_ _1"></span>. If </div><div class="t m0 xc hd yc15 ff64 fs7 fc3 sc0 ls1 ws1">we used the older Objective-C<span class="_ _0"></span>, calling our As<span class="_ _3"></span>sembly Language r<span class="_ _3"></span>outine </div><div class="t m0 xc hd yc16 ff64 fs7 fc3 sc0 ls1 ws1">would be as shown in Chapter <span class="fc5">9</span>, “In<span class="_ _3"></span>teracting with C and Python,<span class="_ _8"></span>” since </div><div class="t m0 xc hd yc17 ff64 fs7 fc3 sc0 ls1 ws1">Objective-C is an object-oriented ext<span class="_ _3"></span>ension of C.Calling our Assembly </div><div class="t m0 xc hd y393 ff64 fs7 fc3 sc0 ls1 ws1">Language r<span class="_ _3"></span>outine from S<span class="_ _3"></span>wift is simpler than the Andr<span class="_ _3"></span>oid case, since the </div><div class="t m0 xc hd yc18 ff64 fs7 fc3 sc0 ls1 ws1">tools in XCode gener<span class="_ _3"></span>ate the necessary “<span class="_ _1"></span>glue” code for us<span class="_ _3"></span>, so we don’t need </div><div class="t m0 xc hd yc19 ff64 fs7 fc3 sc0 ls1 ws1">to write our own like we did with JNI for Android.</div><div class="t m0 x1c hd yc1a ff64 fs7 fc3 sc0 ls1 ws1">XCode h<span class="_ _3"></span>as its own build system<span class="_ _3"></span>, but fortunately we don’t need to </div><div class="t m0 xc hd yc1b ff64 fs7 fc3 sc0 ls1 ws1">worr<span class="_ _0"></span>y about the details<span class="_ _1"></span>, as the build r<span class="_ _0"></span>ules will be added correctly when we </div><div class="t m0 xc hd yf15 ff64 fs7 fc3 sc0 ls1 ws1">add our files to the IDE.</div><div class="t m0 x1c hd yf16 ff64 fs7 fc3 sc0 ls1 ws1">This tutorial focuses on adding Assembly Language code to a simple </div><div class="t m0 xc hd yf17 ff64 fs7 fc3 sc0 ls1 ws1">Swift app<span class="_ _1"></span>.</div><div class="t m0 x36 h1f yf18 ff68 fse fc3 sc0 ls1 ws1">Note<span class="ff69"> <span class="_ _19"> </span>It is assumed the reader has some familiarity with creating </span></div><div class="t m0 x36 h1f yf19 ff69 fse fc3 sc0 ls1 ws1">a storyboard and connecting it to Swift code. <span class="_ _6"></span>This is easy in XCode,<span class="_ _3"></span> </div><div class="t m0 x36 h1f yf1a ff69 fse fc3 sc0 ls1 ws1">once you are familiar with how you connect UI elements to Swift code </div><div class="t m0 x36 h1f yf1b ff69 fse fc3 sc0 ls1 ws1">by holding down the Control key and dra<span class="_ _0"></span>gging from one to the other<span class="_ _10"></span>.</div><div class="t m0 x1c hd yf1c ff64 fs7 fc3 sc0 ls1 ws1">Crea<span class="_ _3"></span>ting apps with XCode is fun, so let’<span class="_ _6"></span>s dive in.</div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:197.229000px;bottom:457.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pffe" class="pf w2 h6" data-page-no="fe"><div class="pc pcfe w2 h6"><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">240</div><div class="t m0 xd ha y248 ff68 fs6 fc3 sc0 ls1 wsb1"> Create <span class="_ _14"> </span>theProject</div><div class="t m0 xd hd y249 ff64 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o create our pr<span class="_ _1"></span>oject, run XCode and perform these steps<span class="_ _0"></span>:</div><div class="t m0 xc hd yf1d ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Select that you want to “<span class="_ _1"></span>Create a new X<span class="_ _1"></span>Code </div><div class="t m0 x1e hd y300 ff64 fs7 fc3 sc0 ls1 ws1">project” from the in<span class="_ _3"></span>troductory screen.</div><div class="t m0 xc hd yf1e ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Select “Single V<span class="_ _3"></span>iew App<span class="_ _1"></span>” for iOS and click Nex<span class="_ _3"></span>t.</div><div class="t m0 xc hd yf1f ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Name the pr<span class="_ _1"></span>oduct “<span class="_ _0"></span>T<span class="_ _6"></span>oUpper”<span class="_ _18"></span>, choose the </div><div class="t m0 x1e hd yf20 ff64 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming language as S<span class="_ _3"></span>wift and the user </div><div class="t m0 x1e hd yf21 ff64 fs7 fc3 sc0 ls1 ws1">interface as “S<span class="_ _1"></span>tor<span class="_ _0"></span>yboard,<span class="_ _8"></span>” and click N<span class="_ _1"></span>ext.</div><div class="t m0 xc hd yf22 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Select where you want the pr<span class="_ _1"></span>oject files saved and </div><div class="t m0 x1e hd yf23 ff64 fs7 fc3 sc0 ls1 ws1">click Crea<span class="_ _3"></span>te.</div><div class="t m0 x1e hd yf24 ff64 fs7 fc3 sc0 ls1 ws1">This gives us an empty pr<span class="_ _3"></span>oject.</div><div class="t m0 xc hd yf25 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Go to the “Signing &amp; C<span class="_ _3"></span>apabilities<span class="_ _1"></span>” tab on the first </div><div class="t m0 x1e hd yf26 ff64 fs7 fc3 sc0 ls1 ws1">screen and select the T<span class="_ _6"></span>eam. Y<span class="_ _6"></span>ou need this so that </div><div class="t m0 x1e hd yf27 ff64 fs7 fc3 sc0 ls1 ws1">the app can be signed and run on a device.</div><div class="t m0 xc hd yf28 ff64 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w that we ha<span class="_ _1"></span>ve our project crea<span class="_ _3"></span>ted, we’ll develop the UI screen.</div><div class="t m0 xd ha yf29 ff68 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Adding Elements totheMain Stor<span class="_ _0"></span>yboard</div><div class="t m0 xd hd yf2a ff64 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e need to add UI elements to the main storyboard:</div><div class="t m0 xc hd y463 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Click the Main S<span class="_ _3"></span>toryboard in the file explorer<span class="_ _10"></span>.</div><div class="t m0 xc hd yf2b ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Add a T<span class="_ _6"></span>ext Field, a B<span class="_ _3"></span>utton, and a Label contr<span class="_ _3"></span>ol, </div><div class="t m0 x1e hd yf2c ff64 fs7 fc3 sc0 ls1 ws1">laying them out as indic<span class="_ _3"></span>ated in Fi<span class="_ _3"></span>gure<span class="fc5">10-6</span> (y<span class="_ _3"></span>ou add </div><div class="t m0 x1e hd yf2d ff64 fs7 fc3 sc0 ls1 ws1">controls b<span class="_ _1"></span>y clicking the + button in the upper right </div><div class="t m0 x1e hd yf2e ff64 fs7 fc3 sc0 ls1 ws1">of the XCode window).</div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pfff" data-dest-detail='[255,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:260.716000px;bottom:174.518000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pfff" class="pf w2 h6" data-page-no="ff"><div class="pc pcff w2 h6"><img class="bi x2e yf2f w6 h2c" alt="" src="bgff.png"/><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">241</div><div class="t m0 x1c hd yf30 ff64 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we connect our UI elements to some Swift code<span class="_ _3"></span>.</div><div class="t m0 xc ha yf31 ff68 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Adding Swift Code</div><div class="t m0 xc hd yf32 ff64 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e switch the UI to “<span class="_ _10"></span>Assistant” mode so we can connect our UI controls to </div><div class="t m0 xc hd yf33 ff64 fs7 fc3 sc0 ls1 ws1">code in the ViewContr<span class="_ _3"></span>oller via the following steps:</div><div class="t m0 x1c hd yf34 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Create the definitions and n<span class="_ _3"></span>ames of the contr<span class="_ _3"></span>ols. </div><div class="t m0 x9 hd yf35 ff64 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e do this by creatin<span class="_ _3"></span>g Outlets<span class="_ _3"></span>. Contr<span class="_ _3"></span>ol drag each </div><div class="t m0 x9 hd yf36 ff64 fs7 fc3 sc0 ls1 ws1">control t<span class="_ _3"></span>o the top of the ViewContr<span class="_ _3"></span>oller code to </div><div class="t m0 x9 hd yf37 ff64 fs7 fc3 sc0 ls1 ws1">crea<span class="_ _3"></span>te the outlet definitions. N<span class="_ _1"></span>ame the outlets </div><div class="t m0 x9 hd yf38 ff64 fs7 fc3 sc0 ls1 ws1">enterT<span class="_ _6"></span>ext, con<span class="_ _3"></span>vertBtn, and convertedT<span class="_ _6"></span>ext. N<span class="_ _3"></span>ow we </div><div class="t m0 x9 hd yf39 ff64 fs7 fc3 sc0 ls1 ws1">can access our thr<span class="_ _3"></span>ee controls fr<span class="_ _1"></span>om Swift code.</div><div class="t m0 x1c hd yf3a ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Create a function to be c<span class="_ _3"></span>alled when the convertBtn </div><div class="t m0 x9 hd yf3b ff64 fs7 fc3 sc0 ls1 ws1">is tapped. W<span class="_ _1"></span>e do this by creatin<span class="_ _3"></span>g an Action. W<span class="_ _1"></span>e </div><div class="t m0 x9 hd yf3c ff64 fs7 fc3 sc0 ls1 ws1">do this by contr<span class="_ _1"></span>ol dragging the button from </div><div class="t m0 x9 hd yf3d ff64 fs7 fc3 sc0 ls1 ws1">the storyboard to below the constructor in the </div><div class="t m0 x9 hd yf3e ff64 fs7 fc3 sc0 ls1 ws1">ViewContr<span class="_ _3"></span>oller<span class="_ _0"></span>; call this action doCon<span class="_ _3"></span>version.</div><div class="t m0 xc h37 yf3f ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-6. <span class="_ _15"> </span><span class="ff65">Layout and matching S<span class="_ _1"></span>w<span class="_ _0"></span>ift code for the app</span></div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf100" class="pf w2 h6" data-page-no="100"><div class="pc pc100 w2 h6"><img class="bi xd yf40 w7 h24" alt="" src="bg100.png"/><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">242</div><div class="t m0 xc hd y275 ff64 fs7 fc3 sc0 ls1 ws1">With this done<span class="_ _3"></span>, we can write our code to call our Assembly Langua<span class="_ _3"></span>ge </div><div class="t m0 xd hd y276 ff64 fs7 fc3 sc0 ls1 ws1">function. Listing <span class="fc5">10-4</span> is the complete Swift code for the ViewCon<span class="_ _3"></span>troller<span class="_ _10"></span>.</div><div class="t m0 x34 h1f yf41 ff68 fse fc3 sc0 ls1 ws1">Note<span class="ff69"> <span class="_ _17"> </span>We only wrote the three lines of code inside the doConversion </span></div><div class="t m0 x34 h1f yf42 ff69 fse fc3 sc0 ls1 ws1">action function.<span class="_ _1"></span> <span class="_ _1"></span>The rest of the code was genera<span class="_ _0"></span>ted for us by XCode.</div><div class="t m0 xd h20 yf43 ff6b fs3 fc3 sc0 ls1 ws1">Listing 10-4. <span class="_ _15"> </span><span class="ff64">Swift source code for the V<span class="_ _3"></span>iewContr<span class="_ _3"></span>oller</span></div><div class="t m0 xd h18 yf44 ff6c fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yf45 ff6c fs7 fc3 sc0 ls1 ws1">//  ViewController.swift</div><div class="t m0 xd h18 yf46 ff6c fs7 fc3 sc0 ls1 ws1">//  ToUpper</div><div class="t m0 xd h18 yf47 ff6c fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yf48 ff6c fs7 fc3 sc0 ls1 ws1">//  Created by Stephen Smith on 2020-01-24.</div><div class="t m0 xd h18 yf49 ff6c fs7 fc3 sc0 ls1 ws1">//  Copyright © 2020 Stephen Smith. All rights reserved.</div><div class="t m0 xd h18 yf4a ff6c fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yf4b ff6c fs7 fc3 sc0 ls1 ws1">import UIKit</div><div class="t m0 xd h18 yf4c ff6c fs7 fc3 sc0 ls1 ws1">class ViewController: UIViewController {</div><div class="t m0 xd h18 yf4d ff6c fs7 fc3 sc0 ls1 ws1">    //MARK: Properties</div><div class="t m0 xd h18 yf4e ff6c fs7 fc3 sc0 ls1 ws1">    @IBOutlet weak var enterText: UITextField!</div><div class="t m0 xd h18 yf4f ff6c fs7 fc3 sc0 ls1 ws1">    @IBOutlet weak var convertBtn: UIButton!</div><div class="t m0 xd h18 yf50 ff6c fs7 fc3 sc0 ls1 ws1">    @IBOutlet weak var convertedText: UILabel!</div><div class="t m0 xd h18 yf51 ff6c fs7 fc3 sc0 ls1 ws1">    override func viewDidLoad() {</div><div class="t m0 xd h18 yf52 ff6c fs7 fc3 sc0 ls1 ws1">        super.viewDidLoad()</div><div class="t m0 xd h18 yf53 ff6c fs7 fc3 sc0 ls1 ws1">        // Do any additional setup after loading the view.</div><div class="t m0 xd h18 yf54 ff6c fs7 fc3 sc0 ls1 ws1">    }</div><div class="t m0 xd h12 y28b ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pf100" data-dest-detail='[256,"XYZ",35,475,null]'><div class="d m1" style="border-style:none;position:absolute;left:114.902000px;bottom:561.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf101" class="pf w2 h6" data-page-no="101"><div class="pc pc101 w2 h6"><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">243</div><div class="t m0 xc h18 y46b ff6c fs7 fc3 sc0 ls1 ws1">    //MARK: Actions</div><div class="t m0 xc h18 y46c ff6c fs7 fc3 sc0 ls1 ws1">    @IBAction func doConversion(_ sender: UIButton) {</div><div class="t m0 xc h18 y46d ff6c fs7 fc3 sc0 ls1 ws1">        var output : [CChar] = Array(repeating: 0, count: 255)</div><div class="t m0 xc h18 y623 ff6c fs7 fc3 sc0 ls1 ws1">        mytoupper(enterText.text, &amp;output)</div><div class="t m0 xc h18 y624 ff6c fs7 fc3 sc0 ls1 ws1">        convertedText.text = String(validatingUTF8: output)</div><div class="t m0 xc h18 y625 ff6c fs7 fc3 sc0 ls1 ws1">    }</div><div class="t m0 xc h18 y626 ff6c fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 x1c hd y847 ff64 fs7 fc3 sc0 ls1 ws1">Inter<span class="_ _3"></span>acting between Swift and C, Objective-C or Assembly Language is </div><div class="t m0 xc hd y85f ff64 fs7 fc3 sc0 ls1 ws1">easy. There ar<span class="_ _1"></span>e types built into Swift to match the common C types along </div><div class="t m0 xc hd y629 ff64 fs7 fc3 sc0 ls1 ws1">with conversion r<span class="_ _3"></span>outines to move them in<span class="_ _3"></span>to the Swift na<span class="_ _3"></span>tive types. Like </div><div class="t m0 xc hd y62a ff64 fs7 fc3 sc0 ls1 ws1">Kotlin, S<span class="_ _1"></span>w<span class="_ _0"></span>ift’<span class="_ _6"></span>s native strings are all Unicode<span class="_ _1"></span>, so w<span class="_ _0"></span>e need to convert to ASCII </div><div class="t m0 xc hd y62b ff64 fs7 fc3 sc0 ls1 ws1">and back for our r<span class="_ _3"></span>outine to work. The first sta<span class="_ _3"></span>tement</div><div class="t m0 xc h18 y62c ff6c fs7 fc3 sc0 ls1 ws1">var output : [CChar] = Array(repeating: 0, count: 255)</div><div class="t m0 x1c hd y62d ff64 fs7 fc3 sc0 ls1 ws1">defines a buffer to place the res<span class="_ _3"></span>ulting converted string in. <span class="ff6a">CChar</span> is </div><div class="t m0 xc hd y84d ff64 fs7 fc3 sc0 ls1 ws1">Swift’<span class="_ _6"></span>s typ<span class="_ _0"></span>e to m<span class="_ _3"></span>atch normal C or Assembly Langua<span class="_ _3"></span>ge ASCII str<span class="_ _0"></span>ings<span class="_ _1"></span>. This </div><div class="t m0 xc hd y84e ff64 fs7 fc3 sc0 ls1 ws1">syntax cr<span class="_ _3"></span>eates a buffer tha<span class="_ _3"></span>t is 255 character<span class="_ _3"></span>s long for us.</div><div class="t m0 x1c hd y84f ff64 fs7 fc3 sc0 ls1 ws1">The next statemen<span class="_ _3"></span>t calls our Assembly Langua<span class="_ _3"></span>ge routine:</div><div class="t m0 xc h18 y862 ff6c fs7 fc3 sc0 ls1 ws1">mytoupper(enterText.text, &amp;output)</div><div class="t m0 x1c hd y863 ff64 fs7 fc3 sc0 ls1 ws1">Swift knows the types our function r<span class="_ _3"></span>equires<span class="_ _1"></span>, s<span class="_ _0"></span>o it will pro<span class="_ _1"></span>vide a </div><div class="t m0 xc hd y864 ff64 fs7 fc3 sc0 ls1 ws1">conversion fr<span class="_ _1"></span>om Unicode to AS<span class="_ _0"></span>CII for enterT<span class="_ _10"></span>ext.text. Then the r<span class="_ _3"></span>esult will </div><div class="t m0 xc hd y865 ff64 fs7 fc3 sc0 ls1 ws1">go in output<span class="_ _0"></span>; the “&amp;” tells Swift to pass the address of outp<span class="_ _3"></span>ut. Then, the </div><div class="t m0 xc hd y866 ff64 fs7 fc3 sc0 ls1 ws1">next statement</div><div class="t m0 xc h18 yf55 ff6c fs7 fc3 sc0 ls1 ws1">convertedText.text = String(validatingUTF8: output)</div><div class="t m0 x1c hd yf56 ff64 fs7 fc3 sc0 ls1 ws1">converts our output string to U<span class="_ _3"></span>nicode to display on our UI.</div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf102" class="pf w2 h6" data-page-no="102"><div class="pc pc102 w2 h6"><img class="bi x2 yf57 w6 h4f" alt="" src="bg102.png"/><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">244</div><div class="t m0 xd ha y248 ff68 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Adding our Assembly Language Routine</div><div class="t m0 xd hd y249 ff64 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o add our Assembly Language code, follo<span class="_ _3"></span>w these steps<span class="_ _0"></span>:</div><div class="t m0 xc hd yf1d ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Add a new file to the project<span class="_ _3"></span>. Choose the type as </div><div class="t m0 x1e hd y300 ff64 fs7 fc3 sc0 ls1 ws1">“<span class="_ _10"></span>Assembly F<span class="_ _1"></span>ile” and the name as upper<span class="_ _6"></span>.s (you need </div><div class="t m0 x1e hd y301 ff64 fs7 fc3 sc0 ls1 ws1">to scroll down to the Other ca<span class="_ _3"></span>tegor<span class="_ _0"></span>y to find this).</div><div class="t m0 xc hd yf58 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Cut and paste the code fr<span class="_ _1"></span>om L<span class="_ _0"></span>isting <span class="fc5">10-4</span> in<span class="_ _3"></span>to this </div><div class="t m0 x1e hd yf59 ff64 fs7 fc3 sc0 ls1 ws1">file. Y<span class="_ _6"></span>ou need to change the function name to </div><div class="t m0 x1e hd yf5a ff64 fs7 fc3 sc0 ls1 ws1">_mytoupper<span class="_ _10"></span>. Many C compilers add an underscor<span class="_ _3"></span>e </div><div class="t m0 x1e hd yf5b ff64 fs7 fc3 sc0 ls1 ws1">character befor<span class="_ _1"></span>e each local function name.</div><div class="t m0 xc hd yf5c ff64 fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">10-7</span> shows this code added to the pr<span class="_ _1"></span>oje<span class="_ _0"></span>ct.</div><div class="t m0 xc hd yf5d ff64 fs7 fc3 sc0 ls1 ws1">At this point<span class="_ _3"></span>, if we compile, we will get errors tha<span class="_ _3"></span>t mytoupper is </div><div class="t m0 xd hd yf5e ff64 fs7 fc3 sc0 ls1 ws1">undefined. W<span class="_ _1"></span>e need to build a br<span class="_ _0"></span>idge between Swift and our code<span class="_ _3"></span>.</div><div class="t m0 xd h37 yf5f ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-7. <span class="_ _15"> </span><span class="ff65">The Assembly Language code added to the project</span></div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pf100" data-dest-detail='[256,"XYZ",35,475,null]'><div class="d m1" style="border-style:none;position:absolute;left:250.761000px;bottom:472.518000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf102" data-dest-detail='[258,"XYZ",35,388,null]'><div class="d m1" style="border-style:none;position:absolute;left:86.031500px;bottom:402.518000px;width:20.547500px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf103" class="pf w2 h6" data-page-no="103"><div class="pc pc103 w2 h6"><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">245</div><div class="t m0 xc ha y248 ff68 fs6 fc3 sc0 ls1 wsb1"> Creating <span class="_ _14"> </span>theBridge</div><div class="t m0 xc hd y249 ff64 fs7 fc3 sc0 ls12 ws1">W<span class="_ _1"></span>e need to create a C style header file for our r<span class="_ _3"></span>outine<span class="_ _3"></span>. Create a new file of </div><div class="t m0 xc hd y24a ff64 fs7 fc3 sc0 ls12 ws1">type header file and call it upper<span class="_ _6"></span>.h. Add the code fr<span class="_ _1"></span>om L<span class="_ _0"></span>isting <span class="fc5 wsc9">10-5</span> to this file<span class="_ _1"></span>.</div><div class="t m0 xc h20 yb3b ff6b fs3 fc3 sc0 ls1 ws1">Listing 10-5. <span class="_ _15"> </span><span class="ff64">C Header file definition of m<span class="_ _3"></span>ytoupper</span></div><div class="t m0 xc h18 yf60 ff6c fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 yf61 ff6c fs7 fc3 sc0 ls1 ws1">//  upper.h</div><div class="t m0 xc h18 yf62 ff6c fs7 fc3 sc0 ls1 ws1">//  ToUpper</div><div class="t m0 xc h18 yf63 ff6c fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 yf64 ff6c fs7 fc3 sc0 ls1 ws1">//  Created by Stephen Smith on 2020-01-24.</div><div class="t m0 xc h18 yf65 ff6c fs7 fc3 sc0 ls1 ws1">//  Copyright © 2020 Stephen Smith. All rights reserved.</div><div class="t m0 xc h18 yf66 ff6c fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 yf67 ff6c fs7 fc3 sc0 ls1 ws1">#ifndef upper_h</div><div class="t m0 xc h18 yf68 ff6c fs7 fc3 sc0 ls1 ws1">#define upper_h</div><div class="t m0 xc h18 yf69 ff6c fs7 fc3 sc0 ls1 ws1">extern int mytoupper(const char *, char *);</div><div class="t m0 xc h18 yf6a ff6c fs7 fc3 sc0 ls1 ws1">#endif /* upper_h */</div><div class="t m0 x1c hd yf6b ff64 fs7 fc3 sc0 ls1 ws1">XCode and S<span class="_ _1"></span>w<span class="_ _0"></span>ift ha<span class="_ _1"></span>ve a tool that can read this file and then kno<span class="_ _3"></span>w </div><div class="t m0 xc hd yf6c ff64 fs7 fc3 sc0 ls1 ws1">how to cr<span class="_ _3"></span>eate the correct code<span class="_ _3"></span>, when it compiles the Swift code to call it. </div><div class="t m0 xc hd yf6d ff64 fs7 fc3 sc0 ls1 ws1">However<span class="_ _10"></span>, we need to per<span class="_ _0"></span>form one more trick befor<span class="_ _3"></span>e this is connected.</div><div class="t m0 x1c hd yf6e ff64 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e need to add a C source code file. W<span class="_ _1"></span>e don’t need this file, except tha<span class="_ _3"></span>t </div><div class="t m0 xc hd yf6f ff64 fs7 fc3 sc0 ls1 ws1">crea<span class="_ _3"></span>ting it causes X<span class="_ _1"></span>Code to ask us if w<span class="_ _0"></span>e wan<span class="_ _3"></span>t to crea<span class="_ _3"></span>te a bridging header </div><div class="t m0 xc hd yf70 ff64 fs7 fc3 sc0 ls1 ws1">file for our project. Cr<span class="_ _1"></span>eate a new C file, the name doesn’t ma<span class="_ _3"></span>tter<span class="_ _10"></span>, and when </div><div class="t m0 xc hd yf71 ff64 fs7 fc3 sc0 ls1 ws1">XCode asks if y<span class="_ _3"></span>ou want a bridging header file<span class="_ _1"></span>, make sure you answer “Y<span class="_ _1"></span>es.<span class="_ _8"></span>” </div><div class="t m0 xc hd yf72 ff64 fs7 fc3 sc0 ls1 ws1">XCode will cr<span class="_ _3"></span>eate a file called T<span class="_ _10"></span>oUpper<span class="_ _3"></span>-Bridging-Header<span class="_ _10"></span>.h, which it will </div><div class="t m0 xc hd yf73 ff64 fs7 fc3 sc0 ls1 ws1">use to support calling C code from S<span class="_ _3"></span>wift code. Edit this file and add the line</div><div class="t m0 xc h18 yf74 ff6c fs7 fc3 sc0 ls1 ws1">#include &quot;upper.h&quot;</div><div class="t m0 x1c hd yf75 ff64 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w, our routine will be calla<span class="_ _3"></span>ble from S<span class="_ _3"></span>wift.</div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pf103" data-dest-detail='[259,"XYZ",53,519,null]'><div class="d m1" style="border-style:none;position:absolute;left:333.616000px;bottom:532.518000px;width:20.108000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf104" class="pf w2 h6" data-page-no="104"><div class="pc pc104 w2 h6"><img class="bi x37 yf76 w15 h50" alt="" src="bg104.png"/><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">246</div><div class="t m0 xd ha y248 ff68 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Building andRunning theProject</div><div class="t m0 xd hd y249 ff64 fs7 fc3 sc0 ls1 ws1">As we mentioned in Chapter <span class="fc5">3</span>, “T<span class="_ _6"></span>ooling Up<span class="_ _1"></span>,<span class="_ _10"></span>” once we add ARM Assembly </div><div class="t m0 xd hd y24a ff64 fs7 fc3 sc0 ls1 ws1">Language code to our pr<span class="_ _3"></span>oject, we can no longer run it in the iOS simulator </div><div class="t m0 xd hd y24b ff64 fs7 fc3 sc0 ls1 ws1">as these run locally using Intel code<span class="_ _3"></span>. T<span class="_ _6"></span>o run the project, we need to set our </div><div class="t m0 xd hd y5ad ff64 fs7 fc3 sc0 ls1 ws1">target as a real iOS device<span class="_ _3"></span>, whether it’<span class="_ _6"></span>s an iPhone or iPad; then the pr<span class="_ _3"></span>oject </div><div class="t m0 xd hd y5ae ff64 fs7 fc3 sc0 ls1 ws1">will compile and the app will be downloaded to your device and run there. </div><div class="t m0 xd hd y7f6 ff64 fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure<span class="fc5">10-8</span> shows the a<span class="_ _3"></span>pp running on an iPhone 8.</div><div class="t m0 xd h37 yf77 ff6b fs3 fc3 sc0 ls1 ws1">Figure 10-8. <span class="_ _15"> </span><span class="ff65">The app running on an iPhone 8</span></div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:171.419000px;bottom:548.518000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf104" data-dest-detail='[260,"XYZ",35,454,null]'><div class="d m1" style="border-style:none;position:absolute;left:68.031500px;bottom:468.518000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf105" class="pf w2 h6" data-page-no="105"><div class="pc pc105 w2 h6"><div class="t m0 x17 hd y3f ff64 fs7 fc3 sc0 ls1 ws1">247</div><div class="t m0 xc h15 y186 ff68 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>T<span class="_ _1"></span>ips forOptimizing Apps</div><div class="t m0 xc hd y187 ff64 fs7 fc3 sc0 ls1 ws1">Optimizing progr<span class="_ _3"></span>ams is both a science and an art. W<span class="_ _1"></span>e’ll return to ho<span class="_ _3"></span>w to </div><div class="t m0 xc hd y188 ff64 fs7 fc3 sc0 ls1 ws1">optimize our Assembly code in Chapter <span class="fc5">14</span>, “<span class="_ _1"></span>Optimizing Code.<span class="_ _8"></span>” In this </div><div class="t m0 xc hd y2be ff64 fs7 fc3 sc0 ls1 ws1">section, we present some advice on when to incorporate C or As<span class="_ _3"></span>sembly </div><div class="t m0 xc hd y18a ff64 fs7 fc3 sc0 ls1 ws1">Language code in your apps<span class="_ _1"></span>. Here is a pr<span class="_ _3"></span>ocedure you typic<span class="_ _3"></span>ally use to write </div><div class="t m0 xc hd y18b ff64 fs7 fc3 sc0 ls1 ws1">a new app:</div><div class="t m0 x1c hd yf78 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Write the app in the normal high-level language for </div><div class="t m0 x9 hd yf79 ff64 fs7 fc3 sc0 ls1 ws1">that app<span class="_ _1"></span>’<span class="_ _6"></span>s development such as K<span class="_ _3"></span>otlin or Swift.</div><div class="t m0 x1c hd yf7a ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Identify parts of the pr<span class="_ _3"></span>ograms that don’t pr<span class="_ _1"></span>ovide </div><div class="t m0 x9 hd yf7b ff64 fs7 fc3 sc0 ls1 ws1">adequate performance. Leav<span class="_ _3"></span>e alone anything that </div><div class="t m0 x9 hd yf7c ff64 fs7 fc3 sc0 ls1 ws1">already pr<span class="_ _1"></span>ovides good perfor<span class="_ _0"></span>mance<span class="_ _1"></span>.</div><div class="t m0 x1c hd yf7d ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Tr<span class="_ _0"></span>y to r<span class="_ _3"></span>ework the high-level code<span class="_ _3"></span>. Usually, using a </div><div class="t m0 x9 hd yf7e ff64 fs7 fc3 sc0 ls1 ws1">better algorithm is all that’<span class="_ _6"></span>s needed, for instance, </div><div class="t m0 x9 hd yf7f ff64 fs7 fc3 sc0 ls1 ws1">using a binary search rather th<span class="_ _3"></span>an a linear search<span class="_ _3"></span>.</div><div class="t m0 x1c hd y89a ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>If the problem can’t be addr<span class="_ _3"></span>essed in the high-level </div><div class="t m0 x9 hd y89b ff64 fs7 fc3 sc0 ls1 ws1">language<span class="_ _3"></span>, rewrite the crucial part in C and call that<span class="_ _3"></span>.</div><div class="t m0 x1c hd yf80 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Again, rework the al<span class="_ _3"></span>gorithm in C, but if that fails, </div><div class="t m0 x9 hd yf81 ff64 fs7 fc3 sc0 ls1 ws1">consider Assembly Language<span class="_ _3"></span>.</div><div class="t m0 x1c hd yf82 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>6. <span class="_ _f"> </span>When you write it in Assembly Language<span class="_ _3"></span>, consider </div><div class="t m0 x9 hd yf83 ff64 fs7 fc3 sc0 ls1 ws1">the ARM processor’<span class="_ _1"></span>s copr<span class="_ _3"></span>ocessors. The NEON </div><div class="t m0 x9 hd yf84 ff64 fs7 fc3 sc0 ls1 ws1">coprocessor can be especially helpful, and we will </div><div class="t m0 x9 hd yf85 ff64 fs7 fc3 sc0 ls1 ws1">examine that in Cha<span class="_ _3"></span>pter <span class="fc5">13</span>, “Neon Copr<span class="_ _1"></span>o<span class="_ _0"></span>cessor<span class="_ _10"></span>.<span class="_ _8"></span>”</div><div class="t m0 x1c hd yf86 ff64 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou want as much as your pr<span class="_ _3"></span>ogram as possible in the high-level </div><div class="t m0 xc hd yf87 ff64 fs7 fc3 sc0 ls1 ws1">language<span class="_ _3"></span>, as this is more portable acr<span class="_ _3"></span>oss devices and more m<span class="_ _3"></span>aintainable </div><div class="t m0 xc hd yf88 ff64 fs7 fc3 sc0 ls1 ws1">as you mov<span class="_ _3"></span>e from version to v<span class="_ _3"></span>ersion.</div><div class="t m0 x3c h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:240.888000px;bottom:531.090000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:216.050000px;bottom:191.090000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf106" class="pf w2 h6" data-page-no="106"><div class="pc pc106 w2 h6"><div class="t m0 xd hd y3f ff64 fs7 fc3 sc0 ls1 ws1">248</div><div class="t m0 xd h15 y186 ff68 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y187 ff64 fs7 fc3 sc0 ls18 ws1">This chapter was a quic<span class="_ _3"></span>k taste of mobile app development to sho<span class="_ _3"></span>w how </div><div class="t m0 xd hd y188 ff64 fs7 fc3 sc0 ls18 wsa9">Assembly Language code can be incorpor<span class="_ _3"></span>ated into an app running on either </div><div class="t m0 xd hd y189 ff64 fs7 fc3 sc0 ls18 ws1">Google’<span class="_ _6"></span>s Android or Apple<span class="_ _3"></span>’<span class="_ _6"></span>s iOS.All Apple mobile devices run 64- <span class="_ _b"></span>bit ARM </div><div class="t m0 xd hd y18a ff64 fs7 fc3 sc0 ls18 ws1">processors these days<span class="_ _1"></span>, so our Assembly modules will r<span class="_ _0"></span>un on any modern </div><div class="t m0 xd hd y18b ff64 fs7 fc3 sc0 ls18 ws1">Apple iPhone or iP<span class="_ _1"></span>ad. However<span class="_ _10"></span>, the Android world is a little bit more diverse </div><div class="t m0 xd hd y18c ff64 fs7 fc3 sc0 ls18 ws1">with a few 32-bit ARM devices and a few Intel-based devices out there<span class="_ _1"></span>.</div><div class="t m0 xc hd y18d ff64 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e wrote a Kotlin-b<span class="_ _3"></span>ased Android app to con<span class="_ _3"></span>vert text to upper<span class="_ _1"></span>-case </div><div class="t m0 xd hd y18e ff64 fs7 fc3 sc0 ls1 ws1">where we performed the upper<span class="_ _1"></span>-case conversion in Assembly Language<span class="_ _3"></span>. </div><div class="t m0 xd hd y18f ff64 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e then did the same thing in Swift to create an iOS app<span class="_ _1"></span>. W<span class="_ _1"></span>e also looked at </div><div class="t m0 xd hd y190 ff64 fs7 fc3 sc0 ls1 ws1">a strategy for optimizing a<span class="_ _3"></span>pplications<span class="_ _3"></span>, where we wan<span class="_ _3"></span>t to include as small </div><div class="t m0 xd hd y191 ff64 fs7 fc3 sc0 ls1 ws1">amount of Assembly Langua<span class="_ _3"></span>ge code as possible.</div><div class="t m0 xc hd y192 ff64 fs7 fc3 sc0 ls1 ws1">In the next cha<span class="_ _3"></span>pter<span class="_ _6"></span>, we return to m<span class="_ _3"></span>ath and examine the ARM </div><div class="t m0 xd hd y193 ff64 fs7 fc3 sc0 ls1 ws1">processor’<span class="_ _1"></span>s multiply, divide<span class="_ _1"></span>, and multiply with accumulate instructions.</div><div class="t m0 xd h15 y784 ff68 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd yf89 ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Create an a<span class="_ _3"></span>pp in Android S<span class="_ _3"></span>tudio to convert text </div><div class="t m0 x1e hd yf8a ff64 fs7 fc3 sc0 ls1 ws1">to lower<span class="_ _1"></span>-case. Write it first entir<span class="_ _3"></span>ely in Kotlin t<span class="_ _3"></span>o get </div><div class="t m0 x1e hd yf8b ff64 fs7 fc3 sc0 ls1 ws1">everything to work. Next<span class="_ _3"></span>, incorporate a lower<span class="_ _1"></span>-case </div><div class="t m0 x1e hd yf8c ff64 fs7 fc3 sc0 ls1 ws1">routine written in C.Fin<span class="_ _3"></span>ally, swap out the C r<span class="_ _1"></span>outine </div><div class="t m0 x1e hd yf8d ff64 fs7 fc3 sc0 ls1 ws1">for a version written in Assembly Language<span class="_ _1"></span>.</div><div class="t m0 xc hd yf8e ff64 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Create an a<span class="_ _3"></span>pp in XCode to con<span class="_ _1"></span>ver<span class="_ _0"></span>t text to lo<span class="_ _3"></span>wer<span class="_ _1"></span>-</div><div class="t m0 x1e hd yf8f ff64 fs7 fc3 sc0 ls1 ws1">case. Write it first entir<span class="_ _1"></span>ely in Swift to get ever<span class="_ _0"></span>ything </div><div class="t m0 x1e hd yf90 ff64 fs7 fc3 sc0 ls1 ws1">to work. N<span class="_ _3"></span>ext, incorpora<span class="_ _3"></span>te a lower<span class="_ _1"></span>- <span class="_ _b"></span>case routine </div><div class="t m0 x1e hd yf91 ff64 fs7 fc3 sc0 ls1 ws1">written in C.Finally, swap out the C r<span class="_ _1"></span>outine for a </div><div class="t m0 x1e hd yf92 ff64 fs7 fc3 sc0 ls1 ws1">version written in Assembly Language<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff69 fsa fc3 sc0 ls1 ws1">CHAPTER 10 <span class="_ _f"> </span><span class="wsb7"> <span class="_ _0"></span>INTERF<span class="_ _1"></span>ACING WITH <span class="_ _0"></span>KOTLIN ANDSWIFT </span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf107" class="pf w2 h6" data-page-no="107"><div class="pc pc107 w2 h6"><div class="t m0 x17 hd y16a ff6d fs7 fc3 sc0 ls1 ws1">249</div><div class="t m0 xc h17 y16b ff6d fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff6d fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff6e">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff6d">,  </span></span></div><div class="t m0 xc h17 y16d ff6d fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_11</div><div class="t m0 xc ha y16e ff6f fs6 fc3 sc0 ls1 ws1">CHAPTER 1<span class="_ _6"></span>1</div><div class="t m0 xc h23 y16f ff70 fs4 fc3 sc0 ls1 ws1">Multiply<span class="_ _1a"></span>, Di<span class="_ _1"></span>vide, </div><div class="t m0 xc h23 y747 ff70 fs4 fc3 sc0 ls1 ws1">andAccumula<span class="_ _0"></span>te</div><div class="t m0 xc hd y748 ff6d fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we return to using ma<span class="_ _3"></span>thematics<span class="_ _1"></span>. We<span class="_ _1"></span>’ve already co<span class="_ _1"></span>vered </div><div class="t m0 xc hd y749 ff6d fs7 fc3 sc0 ls1 ws1">addition, subtraction, and a collection of bit opera<span class="_ _3"></span>tions on our 64-bit </div><div class="t m0 xc hd y74a ff6d fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>. Now, we will learn multiplication and division.</div><div class="t m0 x1c hd y74b ff6d fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e will program multiply with accumulat<span class="_ _3"></span>e instructions. But first of all, </div><div class="t m0 xc hd y74c ff6d fs7 fc3 sc0 ls1 ws1">we will provide some backgr<span class="_ _1"></span>ound on why the ARM processor has so much </div><div class="t m0 xc hd y74d ff6d fs7 fc3 sc0 ls1 ws1">circuitry dedicated to performing this operation. This will get us into the </div><div class="t m0 xc hd y74e ff6d fs7 fc3 sc0 ls1 ws1">mechanics of vector and matrix multiplic<span class="_ _3"></span>ation.</div><div class="t m0 xc h15 yf93 ff71 fsb fc3 sc0 ls1 wsaf"> Multiplication</div><div class="t m0 xc hd yf94 ff6d fs7 fc3 sc0 ls1 ws1">The multiply instruction is</div><div class="t m0 xc h18 yf95 ff72 fs7 fc3 sc0 ls1 ws1">MUL Xd, Xn, Xm</div><div class="t m0 x1c hd yf96 ff6d fs7 fc3 sc0 ls1 ws1">This instruction computes Xd = Xn <span class="ff73">∗</span> Xm<span class="_ _3"></span>. Looks good, but people </div><div class="t m0 xc hd yf97 ff6d fs7 fc3 sc0 ls1 ws1">familiar with multiplication migh<span class="_ _3"></span>t immediately ask<span class="_ _0"></span>: <span class="ff6e">These are all 64-bit </span></div><div class="t m0 xc h51 yf98 ff6e fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>, so when y<span class="_ _0"></span>ou m<span class="_ _3"></span>ultiply two 64-bit numbers, don<span class="_ _6"></span>’t you g<span class="_ _0"></span>et a  </div><div class="t m0 xc hd yf99 ff6e fs7 fc3 sc0 ls1 wsf">128- bit <span class="_ _9"> </span>product?<span class="ff6d ws1"> That is true, and that is the mos<span class="_ _3"></span>t obvious limita<span class="_ _3"></span>tion on  </span></div><div class="t m0 xc hd yf9a ff6d fs7 fc3 sc0 ls1 ws1">this instruction. Here ar<span class="_ _1"></span>e some notes on this instr<span class="_ _0"></span>uction:</div><div class="t m0 x1e hd yf9b ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff74 ls1f wsc7">Xd</span> is the lower 64 bits of the product. T<span class="_ _3"></span>he upper 64 bits </div><div class="t m0 x9 hd yf9c ff6d fs7 fc3 sc0 ls1 ws1">are discar<span class="_ _1"></span>de<span class="_ _0"></span>d.</div><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:168.835000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf108" class="pf w2 h6" data-page-no="108"><div class="pc pc108 w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">250</div><div class="t m0 xa hd y145 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>There is no “<span class="ff74">S</span>” ver<span class="_ _3"></span>sion of this instruction, so no </div><div class="t m0 x1e hd y146 ff6d fs7 fc3 sc0 ls1 ws1">condition flags can be set. Ther<span class="_ _3"></span>efore<span class="_ _1"></span>, you can’t detect </div><div class="t m0 x1e hd y147 ff6d fs7 fc3 sc0 ls1 ws1">an overflow.</div><div class="t m0 xa hd y148 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>There ar<span class="_ _1"></span>en’t separate signed and unsigned versions<span class="_ _0"></span>; </div><div class="t m0 x1e hd y149 ff6d fs7 fc3 sc0 ls1 ws1">multiplication isn’t lik<span class="_ _3"></span>e addition where the two<span class="_ _1"></span>’<span class="_ _6"></span>s </div><div class="t m0 x1e hd y14a ff6d fs7 fc3 sc0 ls1 ws1">complement, as discussed in Chapt<span class="_ _3"></span>er <span class="fc5">2</span>, “Loading and </div><div class="t m0 x1e hd y1e1 ff6d fs7 fc3 sc0 ls1 ws1">Adding,<span class="_ _8"></span>” mak<span class="_ _3"></span>es the operations the same<span class="_ _1"></span>.</div><div class="t m0 xa hd y14c ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>All the operands ar<span class="_ _3"></span>e registers; immediate operands </div><div class="t m0 x1e hd yf9d ff6d fs7 fc3 sc0 ls1 ws1">aren’t allowed, but r<span class="_ _1"></span>emember you can use left shift to </div><div class="t m0 x1e hd y2f3 ff6d fs7 fc3 sc0 ls1 ws1">multiply by po<span class="_ _3"></span>wers of two<span class="_ _3"></span>, such as two<span class="_ _1"></span>, four<span class="_ _6"></span>, and eight.</div><div class="t m0 xa hd y264 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>If you multiply two 32-bit <span class="ff74">W</span> r<span class="_ _3"></span>egisters, then the </div><div class="t m0 x1e hd y265 ff6d fs7 fc3 sc0 ls1 ws1">destination m<span class="_ _3"></span>ust be a <span class="ff74">W</span> register<span class="_ _10"></span>. Why can’t it be a </div><div class="t m0 x1e hd y266 ff6d fs7 fc3 sc0 ls1 ws1">64-bit <span class="ff74">X</span> register? So you don’t lose half the r<span class="_ _1"></span>esulting </div><div class="t m0 x1e hd y1f2 ff6d fs7 fc3 sc0 ls1 ws1">product.</div><div class="t m0 xc hd y291 ff6d fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o over<span class="_ _3"></span>come some of these limitations, ther<span class="_ _1"></span>e are a few additional </div><div class="t m0 xd hd y6e4 ff6d fs7 fc3 sc0 ls1 ws1">multiply instructions, as follo<span class="_ _3"></span>ws<span class="_ _0"></span>:</div><div class="t m0 xa hd y155 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>SMULH <span class="_ _3d"> </span> <span class="_ _5a"> </span>Xd, Xn, Xm</div><div class="t m0 xa hd yf9e ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>SMULL <span class="_ _60"> </span> <span class="_ _5a"> </span>Xd, Wn, Wm</div><div class="t m0 xa hd yf9f ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>UMULH <span class="_ _61"> </span> <span class="_ _5a"> </span>Xd, Xn, Xm</div><div class="t m0 xa hd yfa0 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>UMULL <span class="_ _3d"> </span> <span class="_ _62"> </span>Xd, Wn, Wm</div><div class="t m0 xc hd yfa1 ff74 fs7 fc3 sc0 ls1 ws1">SMULL<span class="ff6d"> and </span>UMULL<span class="ff6d"> allow us to multiply two 32-bit registers and get </span></div><div class="t m0 xd hd yfa2 ff6d fs7 fc3 sc0 ls1 ws1">the full result in a 64-bit r<span class="_ _1"></span>egister<span class="_ _6"></span>.</div><div class="t m0 xa hd yfa3 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff74">SMULL</span> is for signed integers.</div><div class="t m0 xa hd yfa4 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff74">UMULL</span> for unsigned integers.</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:260.123000px;bottom:491.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf109" class="pf w2 h6" data-page-no="109"><div class="pc pc109 w2 h6"><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">251</div><div class="t m0 x1c hd y145 ff74 fs7 fc3 sc0 ls1 ws1">SMULH<span class="ff6d"> and </span>UMULH<span class="ff6d"> complement </span>MUL<span class="ff6d"> by giving us the upper 64 bits </span></div><div class="t m0 xc hd y146 ff6d fs7 fc3 sc0 ls1 ws1">of the product of two 64-bit numbers:</div><div class="t m0 x1e hd y1fe ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Calling <span class="ff74">SMULH</span> and <span class="ff74">MUL</span> we can get the complete 128- </div><div class="t m0 x9 hd y148 ff6d fs7 fc3 sc0 ls1 ws1">bit product for signed integers<span class="_ _1"></span>.</div><div class="t m0 x1e hd y6e2 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff74">UMULH</span> works with <span class="ff74">MUL</span> to get the upper 64 bits of the </div><div class="t m0 x9 hd y28c ff6d fs7 fc3 sc0 ls1 ws1">product of unsigned integers<span class="_ _1"></span>.</div><div class="t m0 x1c hd y6e3 ff6d fs7 fc3 sc0 ls20 wsc3">See <span class="ff6e ws1">Exercise 1<span class="ff6d"> in this chapter to confirm how </span></span><span class="ff74">MUL</span><span class="ws1"> works with both cases<span class="_ _1"></span>.</span></div><div class="t m0 x1c hd y28d ff6d fs7 fc3 sc0 ls1f ws1">All these instructions have the same performance and work in a similar </div><div class="t m0 xc hd y14d ff6d fs7 fc3 sc0 ls1f ws1">manner to how we learned to multiply in gr<span class="_ _3"></span>ade school, by multiplying e<span class="_ _3"></span>ach </div><div class="t m0 xc hd y14e ff6d fs7 fc3 sc0 ls1f ws1">digit in a loop and adding the res<span class="_ _3"></span>ults (with shifts) together<span class="_ _6"></span>. The ability to </div><div class="t m0 xc hd y264 ff6d fs7 fc3 sc0 ls1f ws1">detect when a multiplication is complete (r<span class="_ _1"></span>emaining leftmost digits are 0) </div><div class="t m0 xc hd y265 ff6d fs7 fc3 sc0 ls1f ws1">was added to the ARM processor some time ago<span class="_ _1"></span>, so you aren’t penalized </div><div class="t m0 xc hd y266 ff6d fs7 fc3 sc0 ls1f ws1">for multiplying small n<span class="_ _3"></span>umbers (the loop knows to stop early).</div><div class="t m0 x1c hd y1f2 ff6d fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e a set of similar functions that calculate the negativ<span class="_ _3"></span>e or the </div><div class="t m0 xc hd y267 ff6d fs7 fc3 sc0 ls1 ws1">multiplication; these ar<span class="_ _1"></span>e</div><div class="t m0 x1e hd y6e4 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>MNEG <span class="_ _5c"> </span> <span class="_ _62"> </span>Xd, Xn, Xm</div><div class="t m0 x1e hd y155 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>SMNEGL <span class="_ _63"> </span> <span class="_ _5a"> </span>Xd, Wn, Wm</div><div class="t m0 x1e hd yf9e ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>UMNEGL <span class="_ _64"> </span> <span class="_ _5a"> </span>Xd, Wn, Wm</div><div class="t m0 x1c hd yf9f ff6d fs7 fc3 sc0 ls1 ws1">MNEG calculates –(Xn <span class="ff73">∗</span> Xm) and places the r<span class="_ _3"></span>esult in Xd, as well as for </div><div class="t m0 xc hd yfa5 ff74 fs7 fc3 sc0 ls1 ws1">SMNEGL<span class="ff6d"> and </span>UMNEG<span class="_ _0"></span>L<span class="ff6d">. W<span class="_ _3"></span>ith only a limited number of operands possible </span></div><div class="t m0 xc hd yfa6 ff6d fs7 fc3 sc0 ls1 ws1">in the 32 bits for instructions, these ma<span class="_ _3"></span>y seem like a strange addition to the </div><div class="t m0 xc hd yfa7 ff6d fs7 fc3 sc0 ls1 ws1">instruction set, but we’ll see where they come fr<span class="_ _1"></span>om later in this chapter<span class="_ _6"></span>.</div><div class="t m0 xc ha yfa8 ff71 fs6 fc3 sc0 ls1 wsb1"> Examples</div><div class="t m0 xc hd yfa9 ff6d fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">11-1</span> has some code to demonstra<span class="_ _3"></span>te all the various multiply </div><div class="t m0 xc hd yfaa ff6d fs7 fc3 sc0 ls1 ws1">instructions. W<span class="_ _1"></span>e use our debug.s file fr<span class="_ _3"></span>om <span class="ff6e">Chapter</span> <span class="fc5">9</span><span class="ff6e">, “In<span class="_ _3"></span>teracting with C </span></div><div class="t m0 xc hd yfab ff6e fs7 fc3 sc0 ls1 ws1">and Python<span class="ff6d">,<span class="_ _10"></span>” meaning o<span class="_ _3"></span>ur progr<span class="_ _3"></span>am must be organiz<span class="_ _3"></span>ed with the C runtime </span></div><div class="t m0 xc hd yfac ff6d fs7 fc3 sc0 ls1 ws1">in mind.</div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div><a class="l" href="#pf10a" data-dest-detail='[266,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:135.362000px;width:20.547600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:289.661000px;bottom:119.362000px;width:5.500000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf10a" class="pf w2 h6" data-page-no="10a"><div class="pc pc10a w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">252</div><div class="t m0 xd h20 y4c5 ff76 fs3 fc3 sc0 ls1 ws1">Listing 11-1. <span class="_ _15"> </span><span class="ff6d">Examples of the various multiply instructions</span></div><div class="t m0 xd h18 y4c6 ff72 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4c7 ff72 fs7 fc3 sc0 ls1 ws1">// Example of 32 &amp; 64-Bit Multiplication</div><div class="t m0 xd h18 y4c8 ff72 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4f8 ff72 fs7 fc3 sc0 ls1 ws1">.include &quot;debug.s&quot;</div><div class="t m0 xd h18 y5c1 ff72 fs7 fc3 sc0 ls1 ws1">.global main // Provide program starting address</div><div class="t m0 xd h18 ye51 ff72 fs7 fc3 sc0 ls1 ws1">// Load the registers with some data</div><div class="t m0 xd h18 ye52 ff72 fs7 fc3 sc0 ls1 ws1">// Use small positive numbers that will work for all</div><div class="t m0 xd h18 ye53 ff72 fs7 fc3 sc0 ls1 ws1">// multiply instructions.</div><div class="t m0 xd h18 ye54 ff72 fs7 fc3 sc0 ls1 ws1">main:</div><div class="t m0 xd h18 y5c6 ff72 fs7 fc3 sc0 ls1 ws1">      MOV    X2, #25</div><div class="t m0 xd h18 y5e1 ff72 fs7 fc3 sc0 ls1 ws1">      MOV    X3, #4</div><div class="t m0 xd h18 yfad ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Inputs:&quot;</div><div class="t m0 xd h18 y5e2 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 2</div><div class="t m0 xd h18 y6a3 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 3</div><div class="t m0 xd h18 y6a4 ff72 fs7 fc3 sc0 ls1 ws1">      MUL    X4, X2, X3</div><div class="t m0 xd h18 y6a5 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;MUL X4=X2*X3:&quot;</div><div class="t m0 xd h18 y6a6 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xd h18 ye93 ff72 fs7 fc3 sc0 ls1 ws1">      MNEG   X4, X2, X3</div><div class="t m0 xd h18 ye94 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;MNEG X4=-X2*X3:&quot;</div><div class="t m0 xd h18 ye95 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xd h18 yfae ff72 fs7 fc3 sc0 ls1 ws1">      SMULL  X4, W2, W3</div><div class="t m0 xd h18 ye57 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;SMULL X4=W2*W3:&quot;</div><div class="t m0 xd h18 ye58 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xd h18 yfaf ff72 fs7 fc3 sc0 ls1 ws1">      SMNEGL X4, W2, W3</div><div class="t m0 xd h18 yfb0 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;SMNEGL X4=-W2*W3:&quot;</div><div class="t m0 xd h18 yfb1 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf10b" class="pf w2 h6" data-page-no="10b"><div class="pc pc10b w2 h6"><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">253</div><div class="t m0 xc h18 y46b ff72 fs7 fc3 sc0 ls1 ws1">      UMULL  X4, W2, W3</div><div class="t m0 xc h18 y46c ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;UMULL X4=W2*W3:&quot;</div><div class="t m0 xc h18 y46d ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xc h18 y85c ff72 fs7 fc3 sc0 ls1 ws1">      UMNEGL X4, W2, W3</div><div class="t m0 xc h18 y46f ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;UMNEGL X4=-W2*W3:&quot;</div><div class="t m0 xc h18 y85d ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xc h18 yfb2 ff72 fs7 fc3 sc0 ls1 ws1">      LDR    X2, =A</div><div class="t m0 xc h18 yb67 ff72 fs7 fc3 sc0 ls1 ws1">      LDR    X2, [X2]</div><div class="t m0 xc h18 y848 ff72 fs7 fc3 sc0 ls1 ws1">      LDR    X3, =B</div><div class="t m0 xc h18 y849 ff72 fs7 fc3 sc0 ls1 ws1">      LDR    X3, [X3]</div><div class="t m0 xc h18 y84a ff72 fs7 fc3 sc0 ls1 ws1">      MUL    X4, X2, X3</div><div class="t m0 xc h18 y84b ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Inputs:&quot;</div><div class="t m0 xc h18 y62c ff72 fs7 fc3 sc0 ls1 ws1">      printReg 2</div><div class="t m0 xc h18 y860 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 3</div><div class="t m0 xc h18 y861 ff72 fs7 fc3 sc0 ls1 ws1">      MUL    X4, X2, X3</div><div class="t m0 xc h18 yc3f ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;MUL X4 = bottom 64 bits of X2*X3:&quot;</div><div class="t m0 xc h18 yc40 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xc h18 yc41 ff72 fs7 fc3 sc0 ls1 ws1">      SMULH  X4, X2, X3</div><div class="t m0 xc h18 yc42 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;SMULH X4 = top 64 bits of X2*X3 (signed):&quot;</div><div class="t m0 xc h18 ya18 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xc h18 y853 ff72 fs7 fc3 sc0 ls1 ws1">      UMULH  X4, X2, X3</div><div class="t m0 xc h18 y854 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;UMULH X4 = top 64 bits of X2*X3 (unsigned):&quot;</div><div class="t m0 xc h18 y855 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xc h18 yefb ff72 fs7 fc3 sc0 ls1 ws1">      MOV    X0, #0            // return code</div><div class="t m0 xc h18 yefc ff72 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 xc h18 yfb3 ff72 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xc h18 ya1a ff72 fs7 fc3 sc0 ls1 ws1">A:    .dword       0x7812345678</div><div class="t m0 xc h18 yfb4 ff72 fs7 fc3 sc0 ls1 ws1">B:    .dword       0xFABCD12345678901</div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf10c" class="pf w2 h6" data-page-no="10c"><div class="pc pc10c w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">254</div><div class="t m0 xc hd y145 ff6d fs7 fc3 sc0 ls1 ws1">The makefile is as expected. The output is</div><div class="t m0 xd h18 y2e0 ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$ make</div><div class="t m0 xd h18 y2e1 ff72 fs7 fc3 sc0 ls1 ws1">gcc -o mulexamp mulexamp.s</div><div class="t m0 xd h18 y2d7 ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$ ./mulexamp</div><div class="t m0 xd h18 y2e2 ff72 fs7 fc3 sc0 ls1 ws1">Inputs:</div><div class="t m0 xd h18 y60e ff72 fs7 fc3 sc0 ls1 ws1">X2 =                               25, 0x0000000000000019</div><div class="t m0 xd h18 y230 ff72 fs7 fc3 sc0 ls1 ws1">X3 =                                4, 0x0000000000000004</div><div class="t m0 xd h18 y60f ff72 fs7 fc3 sc0 ls1 ws1">MUL X4=X2*X3:</div><div class="t m0 xd h18 y610 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                              100, 0x0000000000000064</div><div class="t m0 xd h18 y611 ff72 fs7 fc3 sc0 ls1 ws1">MNEG X4=-X2*X3:</div><div class="t m0 xd h18 y612 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                             -100, 0xffffffffffffff9c</div><div class="t m0 xd h18 y613 ff72 fs7 fc3 sc0 ls1 ws1">SMULL X4=W2*W3:</div><div class="t m0 xd h18 y614 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                              100, 0x0000000000000064</div><div class="t m0 xd h18 y615 ff72 fs7 fc3 sc0 ls1 ws1">SMNEGL X4=-W2*W3:</div><div class="t m0 xd h18 y616 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                             -100, 0xffffffffffffff9c</div><div class="t m0 xd h18 y617 ff72 fs7 fc3 sc0 ls1 ws1">UMULL X4=W2*W3:</div><div class="t m0 xd h18 y618 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                              100, 0x0000000000000064</div><div class="t m0 xd h18 y619 ff72 fs7 fc3 sc0 ls1 ws1">UMNEGL X4=-W2*W3:</div><div class="t m0 xd h18 y61a ff72 fs7 fc3 sc0 ls1 ws1">X4 =                             -100, 0xffffffffffffff9c</div><div class="t m0 xd h18 y61b ff72 fs7 fc3 sc0 ls1 ws1">Inputs:</div><div class="t m0 xd h18 y61c ff72 fs7 fc3 sc0 ls1 ws1">X2 =                     515701495416, 0x0000007812345678</div><div class="t m0 xd h18 yfb5 ff72 fs7 fc3 sc0 ls1 ws1">X3 =              -379198319187490559, 0xfabcd12345678901</div><div class="t m0 xd h18 yfb6 ff72 fs7 fc3 sc0 ls1 ws1">MUL X4 = bottom 64 bits of X2*X3:</div><div class="t m0 xd h18 yfb7 ff72 fs7 fc3 sc0 ls1 ws1">X4 =              8455362044785495672, 0x75577afb36c28e78</div><div class="t m0 xd h18 yfb8 ff72 fs7 fc3 sc0 ls1 ws1">SMULH X4 = top 64 bits of X2*X3 (signed):</div><div class="t m0 xd h18 yfb9 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                     -10600956976, 0xfffffffd88223bd0</div><div class="t m0 xd h18 ya29 ff72 fs7 fc3 sc0 ls1 ws1">UMULH X4 = top 64 bits of X2*X3 (unsigned):</div><div class="t m0 xd h18 ya2a ff72 fs7 fc3 sc0 ls1 ws1">X4 =                     505100538440, 0x000000759a569248</div><div class="t m0 xd h18 ya2b ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf10d" class="pf w2 h6" data-page-no="10d"><div class="pc pc10d w2 h6"><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">255</div><div class="t m0 x1c hd y145 ff6d fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o demonstrate SMULH and UMULH, we load some large numbers </div><div class="t m0 xc hd y146 ff6d fs7 fc3 sc0 ls1 ws1">that o<span class="_ _3"></span>verflowed a 64-bit result<span class="_ _3"></span>, so we saw nonzer<span class="_ _3"></span>o values in the upper 64 </div><div class="t m0 xc hd y147 ff6d fs7 fc3 sc0 ls1 ws1">bits. N<span class="_ _1"></span>otice the difference between the signed and unsigned computation.</div><div class="t m0 x1c hd y1b0 ff6d fs7 fc3 sc0 ls1 ws1">M<span class="_ _3"></span>ultiply is straigh<span class="_ _3"></span>tforward, so let’<span class="_ _1"></span>s move on to divis<span class="_ _3"></span>ion.</div><div class="t m0 xc h15 yfba ff71 fsb fc3 sc0 ls1 wsaf"> Division</div><div class="t m0 xc hd yfbb ff6d fs7 fc3 sc0 ls1 ws1">Integer division is standar<span class="_ _1"></span>d in all 64-bit ARM processors. This gives </div><div class="t m0 xc hd yfbc ff6d fs7 fc3 sc0 ls1 ws1">us some standardization, unlik<span class="_ _3"></span>e the 32-bit ARM world where some </div><div class="t m0 xc hd yfbd ff6d fs7 fc3 sc0 ls1 ws1">processors contain an in<span class="_ _3"></span>teger division instruction and some don’t.</div><div class="t m0 x1c hd yfbe ff6d fs7 fc3 sc0 ls1 ws1">The division instructions are</div><div class="t m0 x1e hd yfbf ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>SDIV <span class="_ _10"></span> <span class="_ _5a"> </span> <span class="_ _5a"> </span>Xd, Xn, Xm</div><div class="t m0 x1e hd yfc0 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>UDIV <span class="_ _65"> </span> <span class="_ _5a"> </span>Xd, Xn, Xm</div><div class="t m0 x1c hd yfc1 ff6d fs7 fc3 sc0 ls1 ws1">where</div><div class="t m0 x1e hd yfc2 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff74 ls1f wsc7">Xd</span> is the destination r<span class="_ _3"></span>egister</div><div class="t m0 x1e hd yfc3 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff74 lsb wsb4">Xn</span> is the register holding the n<span class="_ _3"></span>umerator</div><div class="t m0 x1e hd yfc4 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ff74">Xm</span> is the register holding the denomin<span class="_ _3"></span>ator</div><div class="t m0 x1c hd yfc5 ff6d fs7 fc3 sc0 ls1 ws1">The registers c<span class="_ _3"></span>an be all <span class="ff74">X</span> or all <span class="ff74">W</span> registers<span class="_ _1"></span>.</div><div class="t m0 x1c hd yfc6 ff6d fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e a few problems or technical notes on these instructions<span class="_ _0"></span>:</div><div class="t m0 x1e hd yfc7 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>There is no “<span class="_ _1"></span>S” option of this instruction, as they don’t </div><div class="t m0 x9 hd yfc8 ff6d fs7 fc3 sc0 ls1 ws1">set the condition flags.</div><div class="t m0 x1e hd yfc9 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Dividing by 0 should thr<span class="_ _1"></span>ow an exception; with these </div><div class="t m0 x9 hd yfca ff6d fs7 fc3 sc0 ls1 ws1">instructions it returns 0 which can be very misleading.</div><div class="t m0 x1e hd yfcb ff6d fs7 fc3 sc0 ls16 wsb9">• <span class="_ _c"> </span><span class="ws1">These instructions aren’t the inverses of </span><span class="ff74">MUL</span><span class="ws1"> and </span></div><div class="t m0 x9 hd yfcc ff74 fs7 fc3 sc0 ls16 wsb9">SMULH<span class="ff6d ws1">. For this Xn needs to be a r<span class="_ _3"></span>egister pair<span class="_ _6"></span>, so the </span></div><div class="t m0 x9 hd yfcd ff6d fs7 fc3 sc0 ls16 ws1">value to be divided can be 128 bits. T<span class="_ _10"></span>o divide a 128- <span class="_ _66"></span>bit </div><div class="t m0 x9 hd yfce ff6d fs7 fc3 sc0 ls16 ws1">value, we need to either go to the floating-<span class="_ _1"></span>point processor </div><div class="t m0 x9 hd yfcf ff6d fs7 fc3 sc0 ls16 ws1">or roll our o<span class="_ _3"></span>wn code.</div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf10e" class="pf w2 h6" data-page-no="10e"><div class="pc pc10e w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">256</div><div class="t m0 xa hd y145 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The instruction only returns the quotien<span class="_ _3"></span>t, not the </div><div class="t m0 x1e hd y146 ff6d fs7 fc3 sc0 ls1 ws1">remainder<span class="_ _10"></span>. Many al<span class="_ _3"></span>gorithms require the r<span class="_ _1"></span>emainder </div><div class="t m0 x1e hd y147 ff6d fs7 fc3 sc0 ls1 ws1">and you must calc<span class="_ _3"></span>ulate it as rem<span class="_ _3"></span>ainder = numer<span class="_ _3"></span>ator- </div><div class="t m0 x1e hd y1b0 ff6d fs7 fc3 sc0 ls1 ws1">(<span class="_ _3"></span>quotient <span class="ff73">∗</span> denominat<span class="_ _3"></span>or).</div><div class="t m0 xd ha y50e ff71 fs6 fc3 sc0 ls1 wsb1"> Example</div><div class="t m0 xd hd y235 ff6d fs7 fc3 sc0 ls1 ws1">The code to execute the divide instructions is simple. Listin<span class="_ _3"></span>g <span class="fc5">11-2</span> is an </div><div class="t m0 xd hd y53b ff6d fs7 fc3 sc0 ls1 ws1">example like we did for multiplica<span class="_ _3"></span>tion.</div><div class="t m0 xd h20 yfd0 ff76 fs3 fc3 sc0 ls1 ws1">Listing 11-2. <span class="_ _15"> </span><span class="ff6d">Examples of the SDIV and UDIV instr<span class="_ _0"></span>uctions</span></div><div class="t m0 xd h18 yfd1 ff72 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yfd2 ff72 fs7 fc3 sc0 ls1 ws1">// Examples of 64-Bit Integer Division</div><div class="t m0 xd h18 yfd3 ff72 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 yfd4 ff72 fs7 fc3 sc0 ls1 ws1">.include &quot;debug.s&quot;</div><div class="t m0 xd h18 yfd5 ff72 fs7 fc3 sc0 ls1 ws1">.global main // Provide program starting address</div><div class="t m0 xd h18 yfd6 ff72 fs7 fc3 sc0 ls1 ws1">// Load the registers with some data</div><div class="t m0 xd h18 yfd7 ff72 fs7 fc3 sc0 ls1 ws1">// Perform various division instructions</div><div class="t m0 xd h18 yfd8 ff72 fs7 fc3 sc0 ls1 ws1">main:</div><div class="t m0 xd h18 yfd9 ff72 fs7 fc3 sc0 ls1 ws1">      MOV    X2, #100</div><div class="t m0 xd h18 yfda ff72 fs7 fc3 sc0 ls1 ws1">      MOV    X3, #4</div><div class="t m0 xd h18 yfdb ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Inputs:&quot;</div><div class="t m0 xd h18 yfdc ff72 fs7 fc3 sc0 ls1 ws1">      printReg 2</div><div class="t m0 xd h18 yfdd ff72 fs7 fc3 sc0 ls1 ws1">      printReg 3</div><div class="t m0 xd h18 yfde ff72 fs7 fc3 sc0 ls1 ws1">      SDIV   X4, X2, X3</div><div class="t m0 xd h18 yfdf ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Outputs:&quot;</div><div class="t m0 xd h18 ydad ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div><a class="l" href="#pf10e" data-dest-detail='[270,"XYZ",35,436,null]'><div class="d m1" style="border-style:none;position:absolute;left:319.125000px;bottom:465.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf10f" class="pf w2 h6" data-page-no="10f"><div class="pc pc10f w2 h6"><img class="bi xc yfe0 w7 h24" alt="" src="bg10f.png"/><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">257</div><div class="t m0 xc h18 ycbe ff72 fs7 fc3 sc0 ls1 ws1">      UDIV   X4, X2, X3</div><div class="t m0 xc h18 ycbf ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Outputs:&quot;</div><div class="t m0 xc h18 ycc0 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xc h18 yfe1 ff72 fs7 fc3 sc0 ls1 ws1">      // Division by zero</div><div class="t m0 xc h18 yfe2 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Division by zero:&quot;</div><div class="t m0 xc h18 yfe3 ff72 fs7 fc3 sc0 ls1 ws1">      MOV    X3, #0</div><div class="t m0 xc h18 yfe4 ff72 fs7 fc3 sc0 ls1 ws1">      SDIV   X4, X2, X3</div><div class="t m0 xc h18 yfe5 ff72 fs7 fc3 sc0 ls1 ws1">      printStr &quot;Outputs:&quot;</div><div class="t m0 xc h18 yfe6 ff72 fs7 fc3 sc0 ls1 ws1">      printReg 4</div><div class="t m0 xc h18 yfe7 ff72 fs7 fc3 sc0 ls1 ws1">      MOV    X0, #0        // return code</div><div class="t m0 xc h18 yfe8 ff72 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 x1c hd yfe9 ff6d fs7 fc3 sc0 ls1 ws1">The makefile is as expected; if we build and run this progr<span class="_ _3"></span>am, we get</div><div class="t m0 xc h18 yfea ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$ make</div><div class="t m0 xc h18 yfeb ff72 fs7 fc3 sc0 ls1 ws1">gcc -o divexamp divexamp.s</div><div class="t m0 xc h18 yfec ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$ ./divexamp</div><div class="t m0 xc h18 yfed ff72 fs7 fc3 sc0 ls1 ws1">Inputs:</div><div class="t m0 xc h18 yfee ff72 fs7 fc3 sc0 ls1 ws1">X2 =                              100, 0x0000000000000064</div><div class="t m0 xc h18 yfef ff72 fs7 fc3 sc0 ls1 ws1">X3 =                                4, 0x0000000000000004</div><div class="t m0 xc h18 yff0 ff72 fs7 fc3 sc0 ls1 ws1">Outputs:</div><div class="t m0 xc h18 yff1 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                               25, 0x0000000000000019</div><div class="t m0 xc h18 yff2 ff72 fs7 fc3 sc0 ls1 ws1">Outputs:</div><div class="t m0 xc h18 yff3 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                               25, 0x0000000000000019</div><div class="t m0 xc h18 yff4 ff72 fs7 fc3 sc0 ls1 ws1">Division by zero:</div><div class="t m0 xc h18 yff5 ff72 fs7 fc3 sc0 ls1 ws1">Outputs:</div><div class="t m0 xc h18 yff6 ff72 fs7 fc3 sc0 ls1 ws1">X4 =                                0, 0x0000000000000000</div><div class="t m0 xc h18 yff7 ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$</div><div class="t m0 x36 h1f yff8 ff71 fse fc3 sc0 ls2d wsd1">Note<span class="ff75 ws1"> <span class="_ _17"> </span>The incorrect result when we divide by 0 should trigger an error<span class="_ _6"></span>,<span class="_ _1"></span> </span></div><div class="t m0 x36 h1f yff9 ff75 fse fc3 sc0 ls2d ws1">but it didn’t.<span class="_ _1"></span> <span class="_ _1"></span>Thus,<span class="_ _3"></span> we need to check for division by 0in our code.</div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf110" class="pf w2 h6" data-page-no="110"><div class="pc pc110 w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">258</div><div class="t m0 xc hd y145 ff6d fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, we look at combining multiplic<span class="_ _3"></span>ation and addition, so we can </div><div class="t m0 xd hd y146 ff6d fs7 fc3 sc0 ls1 ws1">optimize loops operating on v<span class="_ _3"></span>ectors.</div><div class="t m0 xd h15 y50d ff71 fsb fc3 sc0 ls1 wsaf"> Multiply <span class="_ _11"> </span>andAccumulate</div><div class="t m0 xd hd y50e ff6d fs7 fc3 sc0 ls1 ws1">The multiply and accumula<span class="_ _3"></span>te operation m<span class="_ _3"></span>ultiplies two numbers<span class="_ _3"></span>, then </div><div class="t m0 xd hd y50f ff6d fs7 fc3 sc0 ls1 ws1">adds them to a third. As we go thr<span class="_ _3"></span>ough the next few chapt<span class="_ _3"></span>ers, we will see </div><div class="t m0 xd hd yffa ff6d fs7 fc3 sc0 ls1 ws1">this operation r<span class="_ _1"></span>eappear again and again. The ARM pr<span class="_ _3"></span>ocessor is RISC<span class="_ _0"></span>; if </div><div class="t m0 xd hd yc17 ff6d fs7 fc3 sc0 ls1 ws1">the instruction set is reduced, then why do we find so many instructions<span class="_ _3"></span>, </div><div class="t m0 xd hd y393 ff6d fs7 fc3 sc0 ls1 ws1">and as a result so much cir<span class="_ _1"></span>cuitr<span class="_ _0"></span>y dedicated to performing multiply and </div><div class="t m0 xd hd yc18 ff6d fs7 fc3 sc0 ls1 ws1">accumulate?</div><div class="t m0 xc hd yc19 ff6d fs7 fc3 sc0 ls1 ws1">The answer goes back to our fa<span class="_ _3"></span>vorite first year university ma<span class="_ _3"></span>th course </div><div class="t m0 xd hd yc1a ff6d fs7 fc3 sc0 ls1 ws1">on linear algebra<span class="_ _1"></span>. Most science students are for<span class="_ _3"></span>ced to take this course<span class="_ _3"></span>, </div><div class="t m0 xd hd yffb ff6d fs7 fc3 sc0 ls1 ws1">learn to work with vectors and matrices<span class="_ _3"></span>, and then hope they never see </div><div class="t m0 xd hd yffc ff6d fs7 fc3 sc0 ls1 ws1">these concepts again. Unfortunat<span class="_ _3"></span>ely, they form the foundation for both </div><div class="t m0 xd hd yffd ff6d fs7 fc3 sc0 ls1 ws1">graphics and mac<span class="_ _3"></span>hine learning. Before delvin<span class="_ _3"></span>g into the ARM instructions </div><div class="t m0 xd hd yffe ff6d fs7 fc3 sc0 ls1 ws1">for multiply and accumula<span class="_ _3"></span>te, let’<span class="_ _6"></span>s review a bit of linear algebr<span class="_ _3"></span>a.</div><div class="t m0 xd ha yfff ff71 fs6 fc3 sc0 ls1 wsb1"> V<span class="_ _1"></span>ectors <span class="_ _14"> </span>andMatrices</div><div class="t m0 xd hd y1000 ff6d fs7 fc3 sc0 ls1 ws1">A vector is an order<span class="_ _1"></span>e<span class="_ _0"></span>d list of n<span class="_ _3"></span>umbers. F<span class="_ _1"></span>or instance, in 3D graphics it mi<span class="_ _3"></span>ght </div><div class="t m0 xd hd y1001 ff6d fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esent your loca<span class="_ _3"></span>tion in 3D space where [x, y, z] are yo<span class="_ _3"></span>ur coordina<span class="_ _3"></span>tes. </div><div class="t m0 xd hd y1002 ff6d fs7 fc3 sc0 ls1 ws1">V<span class="_ _6"></span>e<span class="_ _0"></span>ctors ha<span class="_ _1"></span>ve a dimension which is the number of elements they contain. </div><div class="t m0 xd hd y1003 ff6d fs7 fc3 sc0 ls1 ws1">It turns o<span class="_ _3"></span>ut a useful computation with vectors is something called a dot </div><div class="t m0 xd hd y1004 ff6d fs7 fc3 sc0 ls1 ws1">product. If A = [a</div><div class="t m0 x51 h1b y1005 ff6d fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x52 hd y1006 ff6d fs7 fc3 sc0 ls1 ws1">, a</div><div class="t m0 x53 h1b y1005 ff6d fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x1 hd y1006 ff6d fs7 fc3 sc0 ls1 ws1">, … , a</div><div class="t m0 x54 h1b y1005 ff6d fsd fc3 sc0 ls1 ws1">n</div><div class="t m0 x55 hd y1006 ff6d fs7 fc3 sc0 ls1 ws1">] is one vector and B = [b</div><div class="t m0 x56 h1b y1005 ff6d fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x57 hd y1006 ff6d fs7 fc3 sc0 ls1 ws1">, b</div><div class="t m0 x58 h1b y1005 ff6d fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x59 hd y1006 ff6d fs7 fc3 sc0 ls1 ws1">, … , b</div><div class="t m0 x5a h1b y1005 ff6d fsd fc3 sc0 ls1 ws1">n</div><div class="t m0 x13 hd y1006 ff6d fs7 fc3 sc0 ls1 ws1">] is another </div><div class="t m0 xd hd y1007 ff6d fs7 fc3 sc0 ls1 ws1">vector<span class="_ _6"></span>, then their dot product is defined as</div><div class="t m0 xd h18 y1008 ff72 fs7 fc3 sc0 ls1 ws1">A <span class="ff73">∙</span> B = a</div><div class="t m0 x5b h19 y1009 ff72 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x5c h18 ya33 ff72 fs7 fc3 sc0 ls1 ws1">*b</div><div class="t m0 x5d h19 y1009 ff72 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x9 h18 ya33 ff72 fs7 fc3 sc0 ls1 ws1"> + a</div><div class="t m0 xb h19 y1009 ff72 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x53 h18 ya33 ff72 fs7 fc3 sc0 ls1 ws1">* b</div><div class="t m0 x3b h19 y1009 ff72 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x5e h18 ya33 ff72 fs7 fc3 sc0 ls1 ws1"> + ... + a</div><div class="t m0 x3c h19 y1009 ff72 fsd fc3 sc0 ls1 ws1">n</div><div class="t m0 x5f h18 ya33 ff72 fs7 fc3 sc0 ls1 ws1"> * b</div><div class="t m0 x38 h19 y1009 ff72 fsd fc3 sc0 ls1 ws1">n</div><div class="t m0 xc hd y100a ff6d fs7 fc3 sc0 ls1 ws1">If we want to calculat<span class="_ _3"></span>e this dot product, then a loop performing </div><div class="t m0 xd hd y1fc ff6d fs7 fc3 sc0 ls1 ws1">multiply and accumula<span class="_ _3"></span>te instructions will be quite efficient.</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf111" class="pf w2 h6" data-page-no="111"><div class="pc pc111 w2 h6"><img class="bi x51 y100b w16 h4b" alt="" src="bg111.png"/><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">259</div><div class="t m0 x1c hd y145 ff6d fs7 fc3 sc0 ls1 ws1">A matrix is a two-dimensional table of num<span class="_ _3"></span>bers such as</div><div class="t m0 x4a hc y100c ff6d fs8 fc3 sc0 ls1 ws1"> </div><div class="t m0 x1c hd y100d ff6d fs7 fc3 sc0 ls1 ws1">Ma<span class="_ _3"></span>trix multiplication is a complic<span class="_ _3"></span>ated process th<span class="_ _3"></span>at drives first year </div><div class="t m0 xc hd y100e ff6d fs7 fc3 sc0 ls1 ws1">linear algebra st<span class="_ _3"></span>udents nuts<span class="_ _1"></span>. W<span class="_ _0"></span>hen yo<span class="_ _3"></span>u multiply matrix A times ma<span class="_ _3"></span>trix B, </div><div class="t m0 xc hd y100f ff6d fs7 fc3 sc0 ls1 ws1">then each element on the r<span class="_ _3"></span>esulting matrix is the dot pr<span class="_ _3"></span>oduct of a ro<span class="_ _3"></span>w of </div><div class="t m0 xc hd y1010 ff6d fs7 fc3 sc0 ls1 ws1">matrix A with a column of matrix B.</div><div class="t m0 x60 hc y1011 ff6d fs8 fc3 sc0 ls1 ws1"> </div><div class="t m0 x1c hd y1012 ff6d fs7 fc3 sc0 ls1 ws1">If these were 3x3 matrices<span class="_ _1"></span>, then there would be nine dot products each </div><div class="t m0 xc hd y1013 ff6d fs7 fc3 sc0 ls1 ws1">with nine terms. W<span class="_ _1"></span>e can also multiply a matrix by a vector the same w<span class="_ _3"></span>ay.</div><div class="t m0 x61 hc y1014 ff6d fs8 fc3 sc0 ls1 ws1"> </div><div class="t m0 x1c hd y1015 ff6d fs7 fc3 sc0 ls1 ws1">In 3D gra<span class="_ _3"></span>phics, if we r<span class="_ _3"></span>epresent a poin<span class="_ _3"></span>t as a 4D vector [x, y, z, 1], then </div><div class="t m0 xc hd y1016 ff6d fs7 fc3 sc0 ls1 ws1">the affine transformations of scale<span class="_ _1"></span>, rotate, shear<span class="_ _10"></span>, and reflection can be </div><div class="t m0 xc hd y1017 ff6d fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esented as 4x4 matrices<span class="_ _1"></span>. Any number of these transformations can be </div><div class="t m0 xc hd y1018 ff6d fs7 fc3 sc0 ls1 ws1">combined into a single ma<span class="_ _3"></span>trix. Thus, to transform an object into a scene </div><div class="t m0 xc hd y1019 ff6d fs7 fc3 sc0 ls1 ws1">requir<span class="_ _3"></span>es a matrix multiplica<span class="_ _3"></span>tion applied to each of the object’<span class="_ _6"></span>s ver<span class="_ _0"></span>tex </div><div class="t m0 xc hd y101a ff6d fs7 fc3 sc0 ls1 ws1">points. T<span class="_ _3"></span>he faster we can do this, the fas<span class="_ _3"></span>ter we can render a fr<span class="_ _3"></span>ame in a </div><div class="t m0 xc hd y101b ff6d fs7 fc3 sc0 ls1 ws1">video game.</div><div class="t m0 x1c hd y101c ff6d fs7 fc3 sc0 ls1 ws1">In neural networ<span class="_ _3"></span>ks, the calc<span class="_ _3"></span>ulation for each lay<span class="_ _3"></span>er of neurons is </div><div class="t m0 xc hd y101d ff6d fs7 fc3 sc0 ls1 ws1">calculated b<span class="_ _3"></span>y a matrix multiplica<span class="_ _3"></span>tion followed by the applica<span class="_ _3"></span>tion of a </div><div class="t m0 xc hd y101e ff6d fs7 fc3 sc0 ls1 ws1">nonlinear function. The bulk of the work is the ma<span class="_ _3"></span>trix multiplication. M<span class="_ _3"></span>ost </div><div class="t m0 xc hd y101f ff6d fs7 fc3 sc0 ls1 ws1">neural networks h<span class="_ _3"></span>ave m<span class="_ _3"></span>any lay<span class="_ _3"></span>ers of neurons<span class="_ _1"></span>, each requiring a matrix </div><div class="t m0 xc hd y1020 ff6d fs7 fc3 sc0 ls1 ws1">multiplication. T<span class="_ _3"></span>he matrix size corresponds to the n<span class="_ _3"></span>umber of variables and </div><div class="t m0 xc hd y1021 ff6d fs7 fc3 sc0 ls1 ws1">the number of neur<span class="_ _3"></span>ons<span class="_ _0"></span>; consequently, the ma<span class="_ _3"></span>trices’ dimensions ar<span class="_ _1"></span>e often </div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf112" class="pf w2 h6" data-page-no="112"><div class="pc pc112 w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">260</div><div class="t m0 xd hd y145 ff6d fs7 fc3 sc0 ls1 ws1">in the thousands<span class="_ _3"></span>. How quickl<span class="_ _3"></span>y we perform obje<span class="_ _0"></span>ct r<span class="_ _3"></span>ecognition or speech </div><div class="t m0 xd hd y146 ff6d fs7 fc3 sc0 ls1 ws1">translation depends on ho<span class="_ _3"></span>w fast we can multiply ma<span class="_ _3"></span>trices, which depends </div><div class="t m0 xd hd y147 ff6d fs7 fc3 sc0 ls1 ws1">on how fast we can do multiply with accumula<span class="_ _3"></span>te.</div><div class="t m0 xc hd y1b0 ff6d fs7 fc3 sc0 ls1 ws1">These important applications ar<span class="_ _1"></span>e why the ARM processor dedicates </div><div class="t m0 xd hd y1b1 ff6d fs7 fc3 sc0 ls1 ws1">so much silicon to multiply and accumul<span class="_ _3"></span>ate. W<span class="_ _1"></span>e’ll k<span class="_ _3"></span>eep returning to ho<span class="_ _3"></span>w </div><div class="t m0 xd hd y1b2 ff6d fs7 fc3 sc0 ls1 ws1">to speed up this process as we explore the ARM CPU’<span class="_ _6"></span>s floating-<span class="_ _3"></span>point unit </div><div class="t m0 xd hd y1b3 ff6d fs7 fc3 sc0 ls1 ws1">(FPU) and Neon coprocessors in the following cha<span class="_ _3"></span>pters.</div><div class="t m0 xd ha y236 ff71 fs6 fc3 sc0 ls1 wsb1"> Accumulate <span class="_ _14"> </span>Instructions</div><div class="t m0 xd hd y434 ff6d fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e are the m<span class="_ _3"></span>ultiply with accumulate instructions<span class="_ _0"></span>:</div><div class="t m0 xa hd y435 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>MADD <span class="_ _5e"> </span> <span class="_ _5a"> </span>Xd, Xn, Xm, Xa</div><div class="t m0 xa hd y436 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>MSUB <span class="_ _2e"> </span> <span class="_ _5a"> </span>Xd, Xn, Xm, Xa</div><div class="t m0 xa hd y437 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>SMADDL <span class="_ _67"> </span> <span class="_ _5a"> </span>Xd, Wn, Wm, Xa</div><div class="t m0 xa hd y438 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>UMADDL <span class="_ _4"> </span> <span class="_ _62"> </span>Xd, Wn, Wm<span class="_ _3"></span>, Xa</div><div class="t m0 xa hd y439 ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>SMSUBL <span class="_ _68"> </span> <span class="_ _5a"> </span>Xd, Wn, Wm, Xa</div><div class="t m0 xa hd y43a ff6d fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>UMSUBL <span class="_ _63"> </span> <span class="_ _5a"> </span>Xd, Wn, Wm, Xa</div><div class="t m0 xc hd y1022 ff6d fs7 fc3 sc0 ls1 ws1">The multiplica<span class="_ _3"></span>tion with accumulate instructions map closely to the </div><div class="t m0 xd hd y1023 ff6d fs7 fc3 sc0 ls1 ws1">multiply instructions that we<span class="_ _3"></span>’v<span class="_ _3"></span>e already discussed. In fact<span class="_ _3"></span>, most of the </div><div class="t m0 xd hd y1024 ff6d fs7 fc3 sc0 ls1 ws1">multiply instructions are aliases of these instructions using the zer<span class="_ _3"></span>o </div><div class="t m0 xd hd y1025 ff6d fs7 fc3 sc0 ls1 ws1">register for <span class="ff74 ls10 ws37">Xa<span class="_ _3"></span><span class="ff6d ls1 ws1">.</span></span></div><div class="t m0 xc hd y1026 ff6d fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e either add or subtract the product fr<span class="_ _3"></span>om the running accumulator<span class="_ _10"></span>. </div><div class="t m0 xd hd y1027 ff6d fs7 fc3 sc0 ls1 ws1">The calculation is</div><div class="t m0 xd h18 y1028 ff72 fs7 fc3 sc0 ls1 ws1">Xd = Xa + Xn * Xm</div><div class="t m0 xc hd y1029 ff6d fs7 fc3 sc0 ls1 ws1">or</div><div class="t m0 xd h18 y102a ff72 fs7 fc3 sc0 ls1 ws1">Xd = Xa – Xn * Xm</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf113" class="pf w2 h6" data-page-no="113"><div class="pc pc113 w2 h6"><img class="bi xc y102b w7 h38" alt="" src="bg113.png"/><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">261</div><div class="t m0 x36 h1f y7cb ff71 fse fc3 sc0 ls1 ws1">Note<span class="ff75"> <span class="_ _19"> </span></span>Xd<span class="ff75"> can be the same as </span>Xa<span class="ff75">,<span class="_ _1"></span> for calculating a running sum.</span></div><div class="t m0 x1c hd y102c ff6d fs7 fc3 sc0 ls1 ws1">In the second case, we see that if <span class="ff74 ls10 ws37">Xa<span class="_ _1"></span><span class="ff6d ls1 ws1"> is the zero register<span class="_ _10"></span>, then we get all </span></span></div><div class="t m0 xc hd y102d ff6d fs7 fc3 sc0 ls1 ws1">the multiply negativ<span class="_ _3"></span>e operations in the last section.</div><div class="t m0 x1c hd y102e ff6d fs7 fc3 sc0 ls1 ws1">For the v<span class="_ _3"></span>ersions that m<span class="_ _3"></span>ultiple two 32-bit registers to get a 64-bit r<span class="_ _3"></span>esults, </div><div class="t m0 xc hd y102f ff6d fs7 fc3 sc0 ls1 ws1">the sum needs to be a 64-bit <span class="ff74">X</span> register<span class="_ _10"></span>.</div><div class="t m0 xc ha y1030 ff71 fs6 fc3 sc0 ls1 wsb1"> Example <span class="_ _14"> </span>1</div><div class="t m0 xc hd y1031 ff6d fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve talk<span class="_ _3"></span>ed about how multiply and acc<span class="_ _3"></span>umulate is ideal for multipl<span class="_ _3"></span>ying </div><div class="t m0 xc hd y1032 ff6d fs7 fc3 sc0 ls1 ws1">matrices<span class="_ _3"></span>, so for an example, let’<span class="_ _6"></span>s multiply two 3x3 matrices.</div><div class="t m0 x1c hd y1033 ff6d fs7 fc3 sc0 ls1 ws1">The algorithm we are implementin<span class="_ _3"></span>g is shown in Listing <span class="fc5">11-3</span>.</div><div class="t m0 xc h20 y1034 ff76 fs3 fc3 sc0 ls1 ws1">Listing 11-3. <span class="_ _15"> </span><span class="ff6d">Pseudo-code for our m<span class="_ _3"></span>atrix multiplication pr<span class="_ _1"></span>ogram</span></div><div class="t m0 xc h18 y1035 ff72 fs7 fc3 sc0 ls1 ws1">FOR row = 1 to 3</div><div class="t m0 xc h18 y1036 ff72 fs7 fc3 sc0 ls1 ws1">      FOR col = 1 to 3</div><div class="t m0 xc h18 y1037 ff72 fs7 fc3 sc0 ls1 ws1">            acum = 0</div><div class="t m0 xc h18 y1038 ff72 fs7 fc3 sc0 ls1 ws1">            FOR i = 1 to 3</div><div class="t m0 xc h18 y1039 ff72 fs7 fc3 sc0 ls1 ws1">                  acum = acum + A[row, i]*B[i, col]</div><div class="t m0 xc h18 y103a ff72 fs7 fc3 sc0 ls1 ws1">            NEXT I</div><div class="t m0 xc h18 y103b ff72 fs7 fc3 sc0 ls1 ws1">            C[row, col] = acum</div><div class="t m0 xc h18 y103c ff72 fs7 fc3 sc0 ls1 ws1">      NEXT col</div><div class="t m0 xc h18 y103d ff72 fs7 fc3 sc0 ls1 ws1">NEXT row</div><div class="t m0 x1c hd y103e ff6d fs7 fc3 sc0 ls1 ws1">The ro<span class="_ _3"></span>w and column loops go through each cell of the outp<span class="_ _3"></span>ut matrix </div><div class="t m0 xc hd y103f ff6d fs7 fc3 sc0 ls1 ws1">and calculate the corr<span class="_ _3"></span>ect dot product for that cell in the innermost loop<span class="_ _1"></span>.</div><div class="t m0 x1c hd y1040 ff6d fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">11-4</span> shows the implementa<span class="_ _3"></span>tion in Assembly.</div><div class="t m0 x50 h12 y28b ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div><a class="l" href="#pf113" data-dest-detail='[275,"XYZ",53,373,null]'><div class="d m1" style="border-style:none;position:absolute;left:331.541000px;bottom:386.770000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf114" data-dest-detail='[276,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:150.270000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf114" class="pf w2 h6" data-page-no="114"><div class="pc pc114 w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">262</div><div class="t m0 xd h20 y4c5 ff76 fs3 fc3 sc0 ls1 ws1">Listing 11-4. <span class="_ _15"> </span><span class="ff6d">3x3 matrix multiplica<span class="_ _3"></span>tion in Assembly</span></div><div class="t m0 xd h18 y4c6 ff72 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4c7 ff72 fs7 fc3 sc0 ls1 ws1">// Multiply 2 3x3 integer matrices</div><div class="t m0 xd h18 y4c8 ff72 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y4c9 ff72 fs7 fc3 sc0 ls1 ws1">// Registers:</div><div class="t m0 xd h18 y5de ff72 fs7 fc3 sc0 ls1 ws1">//    W1 - Row index</div><div class="t m0 xd h18 y5df ff72 fs7 fc3 sc0 ls1 ws1">//    W2 - Column index</div><div class="t m0 xd h18 y6a2 ff72 fs7 fc3 sc0 ls1 ws1">//    X4 - Address of row</div><div class="t m0 xd h18 yafc ff72 fs7 fc3 sc0 ls1 ws1">//    X5 - Address of column</div><div class="t m0 xd h18 y9ca ff72 fs7 fc3 sc0 ls1 ws1">//    X7 - 64 bit accumulated sum</div><div class="t m0 xd h18 y9cb ff72 fs7 fc3 sc0 ls1 ws1">//    W9 - Cell of A</div><div class="t m0 xd h18 y1041 ff72 fs7 fc3 sc0 ls1 ws1">//    W10 - Cell of B</div><div class="t m0 xd h18 y1042 ff72 fs7 fc3 sc0 ls1 ws1">//    X19 - Position in C</div><div class="t m0 xd h18 y1043 ff72 fs7 fc3 sc0 ls1 ws1">//    X20 - Loop counter for printing</div><div class="t m0 xd h18 y1044 ff72 fs7 fc3 sc0 ls1 ws1">//    X12 - row in dotloop</div><div class="t m0 xd h18 y1045 ff72 fs7 fc3 sc0 ls1 ws1">//    X6 - col in dotloop</div><div class="t m0 xd h18 y4ff ff72 fs7 fc3 sc0 ls1 ws1">.global main // Provide program starting address</div><div class="t m0 xd h18 yb00 ff72 fs7 fc3 sc0 ls1 ws1">      .equ    N, 3   // Matrix dimensions</div><div class="t m0 xd h18 yb01 ff72 fs7 fc3 sc0 ls1 ws1">      .equ    WDSIZE, 4 // Size of element</div><div class="t m0 xd h18 yb02 ff72 fs7 fc3 sc0 ls1 ws1">main:</div><div class="t m0 xd h18 yb03 ff72 fs7 fc3 sc0 ls1 ws1">      STR     LR, [SP, #-16]!          // Save required regs</div><div class="t m0 xd h18 yb04 ff72 fs7 fc3 sc0 ls1 ws1">      STP     X19, X20, [SP, #-16]!    // Save required regs</div><div class="t m0 xd h18 y1046 ff72 fs7 fc3 sc0 ls1 ws1">      MOV     W1, #N       // Row index</div><div class="t m0 xd h18 y1047 ff72 fs7 fc3 sc0 ls1 ws1">      LDR     X4, =A       // Address of current row</div><div class="t m0 xd h18 y1048 ff72 fs7 fc3 sc0 ls1 ws1">      LDR     X19, =C      // Address of results matrix</div><div class="t m0 xd h18 y1049 ff72 fs7 fc3 sc0 ls1 ws1">rowloop:</div><div class="t m0 xd h18 y104a ff72 fs7 fc3 sc0 ls1 ws1">      LDR     X5, =B       // first column in B</div><div class="t m0 xd h18 y104b ff72 fs7 fc3 sc0 ls2e wsd2">      M<span class="_ _0"></span>OV<span class="_ _0"></span>     W<span class="_ _0"></span>2,<span class="_ _0"></span> #N<span class="_ _0"></span>       // Column <span class="_ _1"></span>index (will <span class="_ _1"></span>count down <span class="_ _1"></span>to 0)</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf115" class="pf w2 h6" data-page-no="115"><div class="pc pc115 w2 h6"><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">263</div><div class="t m0 xc h18 y46b ff72 fs7 fc3 sc0 ls1 ws1">colloop:</div><div class="t m0 xc h18 y46c ff72 fs7 fc3 sc0 ls1 ws1">      // Zero accumulator registers</div><div class="t m0 xc h18 y46d ff72 fs7 fc3 sc0 ls1 ws1">      MOV     X7, #0</div><div class="t m0 xc h18 y85c ff72 fs7 fc3 sc0 ls1 ws1">      MOV     W0, #N       // dot product loop counter</div><div class="t m0 xc h18 y46f ff72 fs7 fc3 sc0 ls1 ws1">      MOV     X12, X4      // row for dot product</div><div class="t m0 xc h18 y85d ff72 fs7 fc3 sc0 ls1 ws1">      MOV     X6, X5       // column for dot product</div><div class="t m0 xc h18 y85e ff72 fs7 fc3 sc0 ls1 ws1">dotloop:</div><div class="t m0 xc h18 y847 ff72 fs7 fc3 sc0 ls1 ws1">      // Do dot product of a row of A with column of B</div><div class="t m0 xc h18 y85f ff72 fs7 fc3 sc0 ls1 ws1">      LDR     W9, [X12], #WDSIZE    // load A[row, i] and incr</div><div class="t m0 xc h18 y629 ff72 fs7 fc3 sc0 ls1 ws1">      LDR     W10, [X6], #(N*WDSIZE)       // load B[i, col]</div><div class="t m0 xc h18 y62a ff72 fs7 fc3 sc0 ls1 ws1">      SMADDL  X7, W9, W10, X7       //  <span class="_ _20"></span>Do multiply and </div><div class="t m0 x2c h18 y62b ff72 fs7 fc3 sc0 ls1 ws1">accumulate</div><div class="t m0 xc h18 y9f9 ff72 fs7 fc3 sc0 ls1 ws1">      SUBS    W0, W0, #1            // Dec loop counter</div><div class="t m0 xc h18 y9fa ff72 fs7 fc3 sc0 ls1 ws1">      B.NE    dotloop               // If not zero loop</div><div class="t m0 xc h18 y861 ff72 fs7 fc3 sc0 ls1 ws1">      STR     W7, [X19], #4         // C[row, col] = dotprod</div><div class="t m0 xc h18 yc3f ff72 fs7 fc3 sc0 ls1 ws1">      ADD     X5, X5, #WDSIZE       // Inc current col</div><div class="t m0 xc h18 yc40 ff72 fs7 fc3 sc0 ls1 ws1">      SUBS    W2, W2, #1            // Dec col loop counter</div><div class="t m0 xc h18 yc41 ff72 fs7 fc3 sc0 ls1 ws1">      B.NE    colloop               // If not zero loop</div><div class="t m0 xc h18 y851 ff72 fs7 fc3 sc0 ls1 ws1">      ADD     X4, X4, #(N*WDSIZE)   // Increment to next row</div><div class="t m0 xc h18 y852 ff72 fs7 fc3 sc0 ls1 ws1">      SUBS    W1, W1, #1            // Dec row loop counter</div><div class="t m0 xc h18 y853 ff72 fs7 fc3 sc0 ls1 ws1">      B.NE    rowloop               // If not zero loop</div><div class="t m0 xc h18 yc44 ff72 fs7 fc3 sc0 ls1 ws1">// Print out matrix C</div><div class="t m0 xc h18 yefa ff72 fs7 fc3 sc0 ls1 ws1">// Loop through 3 rows printing 3 cols each time.</div><div class="t m0 xc h18 yefb ff72 fs7 fc3 sc0 ls1 ws1">      MOV     W20, #3               // Print 3 rows</div><div class="t m0 xc h18 yefc ff72 fs7 fc3 sc0 ls1 ws1">      LDR     X19, =C               // Addr of results matrix</div><div class="t m0 xc h18 ya19 ff72 fs7 fc3 sc0 ls1 ws1">printloop:</div><div class="t m0 xc h18 ya1a ff72 fs7 fc3 sc0 ls1 ws1">      LDR     X0, =prtstr           // printf format string</div><div class="t m0 xc h18 yfb4 ff72 fs7 fc3 sc0 ls1 ws1">      LDR     W1, [X19], #WDSIZE    //  <span class="_ _20"></span>first element in  </div><div class="t m0 x2c h18 y104c ff72 fs7 fc3 sc0 ls1 ws1">current row</div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf116" class="pf w2 h6" data-page-no="116"><div class="pc pc116 w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">264</div><div class="t m0 xd h18 y46b ff72 fs7 fc3 sc0 ls1 ws1">      LDR     W2, [X19], #WDSIZE    //  <span class="_ _20"></span>second element in </div><div class="t m0 x4a h18 y46c ff72 fs7 fc3 sc0 ls1 ws1">current row</div><div class="t m0 xd h18 y46d ff72 fs7 fc3 sc0 ls1 ws1">      LDR     W3, [X19], #WDSIZE    //  <span class="_ _20"></span>third element in  </div><div class="t m0 x4a h18 y623 ff72 fs7 fc3 sc0 ls1 ws1">curent row</div><div class="t m0 xd h18 y624 ff72 fs7 fc3 sc0 ls1 ws1">      BL      printf                // Call printf</div><div class="t m0 xd h18 y625 ff72 fs7 fc3 sc0 ls1 ws1">      SUBS    W20, W20, #1          // Dec loop counter</div><div class="t m0 xd h18 y626 ff72 fs7 fc3 sc0 ls1 ws1">      B.NE    printloop             // If not zero loop</div><div class="t m0 xd h18 y847 ff72 fs7 fc3 sc0 ls1 ws1">      MOV     X0, #0                // return code</div><div class="t m0 xd h18 y85f ff72 fs7 fc3 sc0 ls1 ws1">      LDP     X19, X20, [SP], #16   // Restore Regs</div><div class="t m0 xd h18 y629 ff72 fs7 fc3 sc0 ls1 ws1">      LDR     LR, [SP], #16         // Restore LR</div><div class="t m0 xd h18 y62a ff72 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 xd h18 y84b ff72 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y62c ff72 fs7 fc3 sc0 ls1 ws1">// First matrix</div><div class="t m0 xd h18 y860 ff72 fs7 fc3 sc0 ls1 ws1">A:    .word   1, 2, 3</div><div class="t m0 xd h18 y861 ff72 fs7 fc3 sc0 ls1 ws1">      .word   4, 5, 6</div><div class="t m0 xd h18 yc3f ff72 fs7 fc3 sc0 ls1 ws1">      .word   7, 8, 9</div><div class="t m0 xd h18 yc40 ff72 fs7 fc3 sc0 ls1 ws1">// Second matrix</div><div class="t m0 xd h18 yc41 ff72 fs7 fc3 sc0 ls1 ws1">B:    .word   9, 8, 7</div><div class="t m0 xd h18 yc42 ff72 fs7 fc3 sc0 ls1 ws1">      .word   6, 5, 4</div><div class="t m0 xd h18 ya18 ff72 fs7 fc3 sc0 ls1 ws1">      .word   3, 2, 1</div><div class="t m0 xd h18 ya01 ff72 fs7 fc3 sc0 ls1 ws1">// Result matix</div><div class="t m0 xd h18 ya02 ff72 fs7 fc3 sc0 ls1 ws1">C:    .fill   9, 4, 0</div><div class="t m0 xd h18 y855 ff72 fs7 fc3 sc0 ls1 ws1">prtstr: .asciz  &quot;%3d  %3d  %3d\n&quot;</div><div class="t m0 xc hd yefb ff6d fs7 fc3 sc0 ls1 ws1">After compiling and running this progr<span class="_ _1"></span>am, we get</div><div class="t m0 xd h18 y104d ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$ make</div><div class="t m0 xd h18 yfb3 ff72 fs7 fc3 sc0 ls1 ws1">gcc -g -o matrixmult matrixmult.s</div><div class="t m0 xd h18 ya1a ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$ ./matrixmult</div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf117" class="pf w2 h6" data-page-no="117"><div class="pc pc117 w2 h6"><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">265</div><div class="t m0 xc h18 y46b ff72 fs7 fc3 sc0 ls1 ws1"> 30   24   18</div><div class="t m0 xc h18 y46c ff72 fs7 fc3 sc0 ls1 ws1"> 84   69   54</div><div class="t m0 xc h18 y46d ff72 fs7 fc3 sc0 ls1 ws1">138  114   90</div><div class="t m0 xc h18 y623 ff72 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 11$</div><div class="t m0 xc h2a y104e ff71 fsf fc3 sc0 ls1 ws1"> <span class="_ _1a"></span>Accessing Matrix Elements</div><div class="t m0 xc hd y104f ff6d fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e store the three m<span class="_ _3"></span>atrices in memory, in row order<span class="_ _10"></span>. They are arranged </div><div class="t m0 xc hd y1050 ff6d fs7 fc3 sc0 ls1 ws1">in the .<span class="ff74 ls1f wsc7">word</span> directives so that yo<span class="_ _3"></span>u can see the matrix structure<span class="_ _1"></span>. In the </div><div class="t m0 xc hd y1051 ff6d fs7 fc3 sc0 ls1 ws1">pseudo-code, we refer to the m<span class="_ _3"></span>atrix elements using two-dimensional </div><div class="t m0 xc hd y1052 ff6d fs7 fc3 sc0 ls1 ws1">arrays<span class="_ _1"></span>. There are no instructions or operand forma<span class="_ _3"></span>ts to specify two- </div><div class="t m0 xc hd y1053 ff6d fs7 fc3 sc0 ls1 ws1">dimensional array acces<span class="_ _3"></span>s, so we must do it our<span class="_ _3"></span>selves. T<span class="_ _10"></span>o Ass<span class="_ _0"></span>embly each </div><div class="t m0 xc hd y1054 ff6d fs7 fc3 sc0 ls1 ws1">array is jus<span class="_ _3"></span>t a nine-word sequence of memory. Now that we kno<span class="_ _3"></span>w how to </div><div class="t m0 xc hd y1055 ff6d fs7 fc3 sc0 ls1 ws1">multiply, we can do something like</div><div class="t m0 x21 hd y1056 ff6d fs7 fc3 sc0 ls1 ws1">A[i, j] = A[i<span class="ff73">∗</span>N + j]</div><div class="t m0 x1c hd y1057 ff6d fs7 fc3 sc0 ls1 ws1">where N is the dimension of the arra<span class="_ _1"></span>y. We don’t do this though; in </div><div class="t m0 xc hd y1058 ff6d fs7 fc3 sc0 ls1 ws1">Assembly it pays to notice th<span class="_ _3"></span>at we access the array elemen<span class="_ _3"></span>ts in order and </div><div class="t m0 xc hd y1059 ff6d fs7 fc3 sc0 ls1 ws1">can go from one elemen<span class="_ _3"></span>t in a row t<span class="_ _3"></span>o the next by adding the siz<span class="_ _3"></span>e of an </div><div class="t m0 xc hd y105a ff6d fs7 fc3 sc0 ls1 ws1">element<span class="_ _1"></span>—the size of a word, or 4 bytes<span class="_ _3"></span>. W<span class="_ _1"></span>e can go from an element in a </div><div class="t m0 xc hd y105b ff6d fs7 fc3 sc0 ls1 ws1">column to the next one by adding the siz<span class="_ _3"></span>e of a ro<span class="_ _3"></span>w. Therefor<span class="_ _1"></span>e, we use the </div><div class="t m0 xc hd y105c ff6d fs7 fc3 sc0 ls1 ws1">constant N <span class="ff73">∗</span> WDSIZE so often in the code. This w<span class="_ _3"></span>ay we go through the </div><div class="t m0 xc hd y105d ff6d fs7 fc3 sc0 ls1 ws1">array incr<span class="_ _3"></span>ementally and never ha<span class="_ _1"></span>ve to multiply array indexes<span class="_ _1"></span>. G<span class="_ _0"></span>enerally, </div><div class="t m0 xc hd y105e ff6d fs7 fc3 sc0 ls1 ws1">multiplication and division ar<span class="_ _1"></span>e expensive operations, and we should try to </div><div class="t m0 xc hd y105f ff6d fs7 fc3 sc0 ls1 ws1">avoid them as m<span class="_ _3"></span>uch as possible.</div><div class="t m0 x1c hd y1060 ff6d fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can use post-indexing techniques to access elements and </div><div class="t m0 xc hd y1061 ff6d fs7 fc3 sc0 ls1 ws1">increment poin<span class="_ _3"></span>ters to the next element<span class="_ _3"></span>. W<span class="_ _1"></span>e use post-indexing to stor<span class="_ _3"></span>e the </div><div class="t m0 xc hd y1062 ff6d fs7 fc3 sc0 ls1 ws1">result of each com<span class="_ _3"></span>putation in the arra<span class="_ _3"></span>y C.W<span class="_ _3"></span>e see this in the following:</div><div class="t m0 xc h18 y1063 ff72 fs7 fc3 sc0 ls1 ws1">STR  W7, [X19], #4   // C[row, col] = dotprod</div><div class="t m0 x1c hd y1064 ff6d fs7 fc3 sc0 ls1 ws1">which stores o<span class="_ _3"></span>ur computed dot product in<span class="_ _3"></span>to C and then incremen<span class="_ _3"></span>ts </div><div class="t m0 xc hd y1065 ff6d fs7 fc3 sc0 ls1 ws1">the pointer into C b<span class="_ _3"></span>y 4 bytes<span class="_ _3"></span>. W<span class="_ _1"></span>e see it again when we print the C matrix at </div><div class="t m0 xc hd y1066 ff6d fs7 fc3 sc0 ls1 ws1">the end.</div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf118" class="pf w2 h6" data-page-no="118"><div class="pc pc118 w2 h6"><div class="t m0 xd hd y3f ff6d fs7 fc3 sc0 ls1 ws1">266</div><div class="t m0 xd h2a y409 ff71 fsf fc3 sc0 ls1 wsbb"> Multiply <span class="_ _1b"> </span>withAccumulate</div><div class="t m0 xd hd y40a ff6d fs7 fc3 sc0 ls1 ws1">The core of the al<span class="_ _3"></span>gorithm relies on the <span class="ff74">SMADDL</span> instruction to multiply an </div><div class="t m0 xd hd y40b ff6d fs7 fc3 sc0 ls1 ws1">element of A by an elemen<span class="_ _3"></span>t of B and add that to the running sum for the </div><div class="t m0 xd hd y40c ff6d fs7 fc3 sc0 ls1 ws1">dot product<span class="_ _0"></span>:</div><div class="t m0 xd h18 y1067 ff72 fs7 fc3 sc0 ls1 ws1">SMADDL X7, W9, W10, X7</div><div class="t m0 xc hd y1068 ff6d fs7 fc3 sc0 ls1 ws1">This instruction accumulates a 64-bit sum<span class="_ _1"></span>, though we only take the </div><div class="t m0 xd hd y1069 ff6d fs7 fc3 sc0 ls1 ws1">lower 32 bits when we store it in<span class="_ _3"></span>to the result m<span class="_ _3"></span>atrix C.W<span class="_ _3"></span>e don’t check for </div><div class="t m0 xd hd y106a ff6d fs7 fc3 sc0 ls1 ws1">overflow, but as lon<span class="_ _3"></span>g as the numbers in A and B ar<span class="_ _3"></span>e small, we won’t ha<span class="_ _3"></span>ve a </div><div class="t m0 xd hd y106b ff6d fs7 fc3 sc0 ls1 ws1">problem<span class="_ _3"></span>.</div><div class="t m0 xd h2a y411 ff71 fsf fc3 sc0 ls1 wsbb"> Register <span class="_ _1b"> </span>Usage</div><div class="t m0 xd hd y106c ff6d fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e use quite a few registers, so we<span class="_ _3"></span>’re luck<span class="_ _3"></span>y we can keep track of all o<span class="_ _3"></span>ur </div><div class="t m0 xd hd y106d ff6d fs7 fc3 sc0 ls1 ws1">loop indexes and pointers in r<span class="_ _3"></span>egisters, without h<span class="_ _3"></span>aving to mo<span class="_ _1"></span>ve them in and </div><div class="t m0 xd hd y106e ff6d fs7 fc3 sc0 ls1 ws1">out of memory. If we had to do this, we would ha<span class="_ _3"></span>ve allocated space on the </div><div class="t m0 xd hd y106f ff6d fs7 fc3 sc0 ls1 ws1">stack to hold any needed variables<span class="_ _3"></span>.</div><div class="t m0 xc hd y1070 ff6d fs7 fc3 sc0 ls1 ws1">Notice th<span class="_ _3"></span>at we use registers <span class="ff74">X19</span> and <span class="ff74">X20</span> in the loop tha<span class="_ _3"></span>t does the </div><div class="t m0 xd hd y1071 ff6d fs7 fc3 sc0 ls1 ws1">printing. Tha<span class="_ _3"></span>t is because the printf function will change any of r<span class="_ _3"></span>egisters </div><div class="t m0 xd hd y1072 ff74 fs7 fc3 sc0 ls1 ws1">X0<span class="ff6d">–</span>X18<span class="ff6d"> on us. W<span class="_ _1"></span>e mostly use registers <span class="ff74">X0</span>–<span class="ff74">X18</span> otherwise since we don’t </span></div><div class="t m0 xd hd y1073 ff6d fs7 fc3 sc0 ls1 ws1">need to preserve these for our caller<span class="_ _6"></span>. However<span class="_ _10"></span>, w<span class="_ _0"></span>e do need to pr<span class="_ _3"></span>eser<span class="_ _0"></span>ve <span class="ff74">X19</span> </div><div class="t m0 xd hd y1074 ff6d fs7 fc3 sc0 ls1 ws1">and <span class="ff74">X20</span>, so we push and pop these to and from the stack along with <span class="ff74 ls24 wsc2">LR</span>.</div><div class="t m0 xd h15 y1075 ff71 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y1076 ff6d fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e introduced the various forms of the multiply and division instructions </div><div class="t m0 xd hd y1077 ff6d fs7 fc3 sc0 ls1 ws1">supported in the ARM 64-bit instruction set.</div><div class="t m0 xc hd y1078 ff6d fs7 fc3 sc0 ls21 ws1">W<span class="_ _1"></span>e then explained the concept of multiply and accumulate and </div><div class="t m0 xd hd y1079 ff6d fs7 fc3 sc0 ls21 ws1">why these instructions are so important to modern applica<span class="_ _3"></span>tions in </div><div class="t m0 xd hd y107a ff6d fs7 fc3 sc0 ls21 ws1">graphics and mac<span class="_ _3"></span>hine learning. W<span class="_ _1"></span>e reviewed the many variations of<span class="_ _3"></span> </div><div class="t m0 xd h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf119" class="pf w2 h6" data-page-no="119"><div class="pc pc119 w2 h6"><div class="t m0 x17 hd y3f ff6d fs7 fc3 sc0 ls1 ws1">267</div><div class="t m0 xc hd y145 ff6d fs7 fc3 sc0 ls21 ws1">these instructions and then presented an example ma<span class="_ _3"></span>trix multiplication </div><div class="t m0 xc hd y146 ff6d fs7 fc3 sc0 ls21 ws1">progr<span class="_ _3"></span>am to show them in action.</div><div class="t m0 x1c hd y147 ff6d fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">12</span>, “F<span class="_ _3"></span>loating-P<span class="_ _3"></span>oint Opera<span class="_ _3"></span>tions,<span class="_ _66"></span>” we will lo<span class="_ _0"></span>ok at mor<span class="_ _1"></span>e math, </div><div class="t m0 xc hd y1b0 ff6d fs7 fc3 sc0 ls1 ws1">but this time in scientific notation allowing fr<span class="_ _3"></span>actions and exponents<span class="_ _3"></span>, going </div><div class="t m0 xc hd y1b1 ff6d fs7 fc3 sc0 ls1 ws1">beyond integers for the first time.</div><div class="t m0 xc h15 y235 ff71 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 x1c hd yea1 ff6d fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>T<span class="_ _6"></span>o multiply two 64-bit numbers resultin<span class="_ _3"></span>g in a 128-</div><div class="t m0 x9 hd ya51 ff6d fs7 fc3 sc0 ls1 ws1">bit product, we used the MUL instruction to obtain </div><div class="t m0 x9 hd y107b ff6d fs7 fc3 sc0 ls1 ws1">the lower 64 bits of the product for both the signed </div><div class="t m0 x9 hd y107c ff6d fs7 fc3 sc0 ls1 ws1">and unsigned integer cases. T<span class="_ _10"></span>o prove th<span class="_ _3"></span>at this works<span class="_ _1"></span>, </div><div class="t m0 x9 hd y107d ff6d fs7 fc3 sc0 ls1 ws1">let’<span class="_ _1"></span>s work a small exam<span class="_ _3"></span>ple multiplying two 4-bit </div><div class="t m0 x9 hd y107e ff6d fs7 fc3 sc0 ls1 ws1">numbers to get an 8-bit pr<span class="_ _3"></span>oduct. M<span class="_ _1"></span>ultiply 0xf by 2. </div><div class="t m0 x9 hd y107f ff6d fs7 fc3 sc0 ls1 ws1">In this signed case<span class="_ _3"></span>, 0xf is -1 and the product is -2; </div><div class="t m0 x9 hd y1080 ff6d fs7 fc3 sc0 ls1 ws1">in the unsigned case, 0xf is 15 and the pr<span class="_ _1"></span>o<span class="_ _0"></span>duct is </div><div class="t m0 x9 hd y1081 ff6d fs7 fc3 sc0 ls1 ws1">30. Man<span class="_ _3"></span>ually perform the calculation to ensure the </div><div class="t m0 x9 hd y1082 ff6d fs7 fc3 sc0 ls1 ws1">correct res<span class="_ _3"></span>ult is obtained in both cases.</div><div class="t m0 x1c hd y1083 ff6d fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Write a signed 64-bit integer division routine tha<span class="_ _3"></span>t </div><div class="t m0 x9 hd y1084 ff6d fs7 fc3 sc0 ls1 ws1">checks if the denominator is zer<span class="_ _1"></span>o before performing </div><div class="t m0 x9 hd y1085 ff6d fs7 fc3 sc0 ls1 ws1">the division. Print an error if zer<span class="_ _3"></span>o is encounter<span class="_ _3"></span>ed.</div><div class="t m0 x1c hd ya5d ff6d fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Write a routine to compute a dot pr<span class="_ _1"></span>oduct of </div><div class="t m0 x9 hd ya5e ff6d fs7 fc3 sc0 ls1 ws1">dimension six. Put the numbers to calculate in the </div><div class="t m0 x9 hd ya5f ff6d fs7 fc3 sc0 ls1 ws1">.data section and print the result<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1086 ff6d fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Change your pr<span class="_ _3"></span>ogram in <span class="ff6e">Exercise 3</span> to use multiply </div><div class="t m0 x9 hd y1087 ff6d fs7 fc3 sc0 ls1 ws1">and subtract fr<span class="_ _3"></span>om accumulator<span class="_ _10"></span>, instead of adding.</div><div class="t m0 x1c hd y1088 ff6d fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Change the matrices calcula<span class="_ _3"></span>ted in the example and </div><div class="t m0 x9 hd y1089 ff6d fs7 fc3 sc0 ls1 ws1">check that the r<span class="_ _1"></span>esult is cor<span class="_ _0"></span>r<span class="_ _3"></span>ect.</div><div class="t m0 x50 h12 y71 ff75 fsa fc3 sc0 ls1 ws1">CHAPTER 11 <span class="_ _f"> </span> MUL<span class="_ _6"></span>TIPL<span class="_ _6"></span>Y<span class="_ _10"></span>, DIVIDE,<span class="_ _1"></span> <span class="_ _1"></span>ANDACCUMULA<span class="_ _1"></span>TE</div><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.503000px;bottom:545.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf11a" class="pf w2 h6" data-page-no="11a"><div class="pc pc11a w2 h6"><div class="t m0 x17 hd y16a ff77 fs7 fc3 sc0 ls1 ws1">269</div><div class="t m0 xc h17 y16b ff77 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff77 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff78">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff77">,  </span></span></div><div class="t m0 xc h17 y16d ff77 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_12</div><div class="t m0 xc ha y16e ff79 fs6 fc3 sc0 ls1 ws1">CHAPTER 12</div><div class="t m0 xc h8 y16f ff7a fs4 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>loa<span class="_ _0"></span>ting-P<span class="_ _6"></span>oint </div><div class="t m0 xc h8 y747 ff7a fs4 fc3 sc0 ls1 ws1">Oper<span class="_ _3"></span>a<span class="_ _0"></span>tions</div><div class="t m0 xc hd y748 ff77 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we’ll look at what the floa<span class="_ _3"></span>ting-<span class="_ _1"></span>point unit (FPU<span class="_ _0"></span>) does. </div><div class="t m0 xc hd y749 ff77 fs7 fc3 sc0 ls1 ws1">Some ARM documentation refer<span class="_ _3"></span>s to this as the vector floating-<span class="_ _1"></span>point </div><div class="t m0 xc hd y74a ff77 fs7 fc3 sc0 ls1 ws1">(VFP) coprocessor to promote the fact that it c<span class="_ _3"></span>an do some limited vector </div><div class="t m0 xc hd y74b ff77 fs7 fc3 sc0 ls1 ws1">processing<span class="_ _3"></span>. Any vector processin<span class="_ _3"></span>g in the FPU is now replaced b<span class="_ _3"></span>y the much </div><div class="t m0 xc hd y74c ff77 fs7 fc3 sc0 ls1 ws1">better parallel pr<span class="_ _3"></span>ocessing pr<span class="_ _3"></span>ovided by the NEON copr<span class="_ _1"></span>ocess<span class="_ _0"></span>or<span class="_ _10"></span>, which we </div><div class="t m0 xc hd y74d ff77 fs7 fc3 sc0 ls1 ws1">will study in Chapter <span class="fc5">13</span>, “N<span class="_ _3"></span>eon Coprocessor<span class="_ _10"></span>.<span class="_ _8"></span>” Regardless, the FPU pr<span class="_ _1"></span>ovides </div><div class="t m0 xc hd y74e ff77 fs7 fc3 sc0 ls1 ws1">several useful instructions for performing floating-<span class="_ _3"></span>point mathem<span class="_ _3"></span>atics<span class="_ _3"></span>.</div><div class="t m0 x1c hd y74f ff77 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll review wha<span class="_ _3"></span>t floating-<span class="_ _1"></span>point numbers are<span class="_ _1"></span>, how they’re repr<span class="_ _3"></span>esented </div><div class="t m0 xc hd y8c6 ff77 fs7 fc3 sc0 ls1 ws1">in memory, and how to inser<span class="_ _0"></span>t them into o<span class="_ _3"></span>ur Assembly Language </div><div class="t m0 xc hd y8c7 ff77 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams. W<span class="_ _1"></span>e’ll see how to tr<span class="_ _3"></span>ansfer data between the FPU and the </div><div class="t m0 xc hd y8c8 ff77 fs7 fc3 sc0 ls1 ws1">ARM’<span class="_ _6"></span>s regular r<span class="_ _3"></span>egisters and memory. We<span class="_ _1"></span>’ll also p<span class="_ _0"></span>erform basic arithmetic </div><div class="t m0 xc hd y8c9 ff77 fs7 fc3 sc0 ls1 ws1">operations<span class="_ _1"></span>, comparis<span class="_ _0"></span>ons<span class="_ _3"></span>, and conversions<span class="_ _1"></span>.</div><div class="t m0 xc h15 yaa6 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>About Floating-P<span class="_ _1"></span>oint Numbers</div><div class="t m0 xc hd yeae ff77 fs7 fc3 sc0 ls1 ws1">Floating-<span class="_ _1"></span>point numbers ar<span class="_ _3"></span>e a way to r<span class="_ _3"></span>epresent n<span class="_ _3"></span>umbers in scientific </div><div class="t m0 xc hd yeaf ff77 fs7 fc3 sc0 ls1 ws1">notation on the computer<span class="_ _10"></span>, which represents n<span class="_ _3"></span>umbers something like this:</div><div class="t m0 x62 hd y108a ff77 fs7 fc3 sc0 ls1 ws1">1.456354 x 10</div><div class="t m0 x3f h1b y108b ff77 fsd fc3 sc0 ls1 ws1">16</div><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:168.835000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:153.043000px;bottom:332.802000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf11b" class="pf w2 h6" data-page-no="11b"><div class="pc pc11b w2 h6"><img class="bi xd y78e w7 h52" alt="" src="bg11b.png"/><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">270</div><div class="t m0 xc hd y38c ff77 fs7 fc3 sc0 ls1 ws1">There<span class="_ _1"></span>’<span class="_ _1"></span>s a fractional part and an exponent tha<span class="_ _3"></span>t lets you mo<span class="_ _3"></span>ve the </div><div class="t m0 xd hd y38d ff77 fs7 fc3 sc0 ls1 ws1">decimal place to the left if it’<span class="_ _6"></span>s positive and to the right if it’<span class="_ _1"></span>s negative<span class="_ _3"></span>. The </div><div class="t m0 xd hd y4ae ff77 fs7 fc3 sc0 ls1 ws1">ARM CPU deals with half-<span class="_ _1"></span>precision floating-<span class="_ _3"></span>point numbers th<span class="_ _3"></span>at are 16 bits </div><div class="t m0 xd hd y4af ff77 fs7 fc3 sc0 ls1 ws1">in size, sin<span class="_ _3"></span>gle-pr<span class="_ _1"></span>ecision floating-poin<span class="_ _3"></span>t numbers tha<span class="_ _3"></span>t are 32 bits in size<span class="_ _1"></span>, and </div><div class="t m0 xd hd y4b0 ff77 fs7 fc3 sc0 ls1 ws1">double-<span class="_ _3"></span>precision floa<span class="_ _3"></span>ting-<span class="_ _3"></span>point numbers th<span class="_ _3"></span>at are 64 bits in s<span class="_ _3"></span>ize.</div><div class="t m0 x34 h1f y108c ff7b fse fc3 sc0 ls1 ws1">Note<span class="ff7c"> <span class="_ _19"> </span>Only newer <span class="_ _1"></span>ARM processors based on <span class="_ _1"></span>ARMv8.2 support </span></div><div class="t m0 x34 h1f y108d ff7c fse fc3 sc0 ls1 ws1">half-precision 16-bit floating-point numbers.<span class="_ _1"></span> Older processors such </div><div class="t m0 x34 h1f y108e ff7c fse fc3 sc0 ls1 ws1">as that in the Raspberr<span class="_ _0"></span>y Pi 4 do not.<span class="_ _1"></span> <span class="_ _1"></span>These are typically used in <span class="_ _1"></span>AI </div><div class="t m0 x34 h1f y108f ff7c fse fc3 sc0 ls1 ws1">applica<span class="_ _0"></span>tions where speed and memory size are more important than </div><div class="t m0 x34 h1f y1090 ff7c fse fc3 sc0 ls1 wsd3">accurac<span class="_ _3"></span>y<span class="_ _6"></span>.<span class="_ _3"></span> If you plan to use these,<span class="_ _1"></span> make sure you check if your device </div><div class="t m0 x34 h1f y1091 ff7c fse fc3 sc0 ls1 ws1">supports them.<span class="_ _1"></span> <span class="_ _1"></span>Y<span class="_ _6"></span>ou may need to add -march=“armv8.2-a+fp16”<span class="_ _3"></span> to </div><div class="t m0 x34 h1f y1092 ff7c fse fc3 sc0 ls1 ws1">the <span class="ff7b">as</span> or <span class="ff7b">gcc</span> command lines to enable support for half-precision.</div><div class="t m0 xc hd y1e4 ff77 fs7 fc3 sc0 ls1 ws1">The ARM CPU uses the IEEE 754 standard for floa<span class="_ _3"></span>ting-<span class="_ _3"></span>point numbers<span class="_ _1"></span>. </div><div class="t m0 xd hd y1e5 ff77 fs7 fc3 sc0 ls1 ws1">Each number contains a si<span class="_ _3"></span>gn bit to indicate if it’<span class="_ _6"></span>s positive or negative, a </div><div class="t m0 xd hd y1e6 ff77 fs7 fc3 sc0 ls1 ws1">field of bits for the exponent, and a string of digits for the fr<span class="_ _3"></span>actional part. </div><div class="t m0 xd hd y1e7 ff77 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>able<span class="fc5">12-1</span> lists the number of bits for the parts of each format<span class="_ _3"></span>.</div><div class="t m0 xd h1c y1093 ff7d fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able 12-1. <span class="_ _15"> </span><span class="ff78">Bits of a floating-<span class="_ _1"></span>point number</span></div><div class="t m0 xd h10 y1094 ff7b fs7 fc3 sc0 ls1 ws1">Name<span class="_ _69"> </span>Precision<span class="_ _6a"> </span>Sign<span class="_ _6a"> </span>Fractional<span class="_ _6a"> </span>Exponent<span class="_ _6a"> </span>Decimal Digits</div><div class="t m0 xd h10 y1095 ff7c fs7 fc3 sc0 ls1 ws1">Half<span class="_ _6b"> </span>16 bits<span class="_ _6b"> </span>1<span class="_ _6c"> </span>10<span class="_ _6d"> </span>5<span class="_ _49"> </span>3</div><div class="t m0 xd h10 y1096 ff7c fs7 fc3 sc0 ls1 ws1">Single<span class="_ _69"> </span>32 bits<span class="_ _6b"> </span>1<span class="_ _6c"> </span>23<span class="_ _6d"> </span>8<span class="_ _49"> </span>7</div><div class="t m0 xd h10 y1097 ff7c fs7 fc3 sc0 ls1 ws1">Double<span class="_ _6a"> </span>64 bits<span class="_ _6b"> </span>1<span class="_ _6c"> </span>52<span class="_ _6d"> </span>11<span class="_ _6e"> </span>16</div><div class="t m0 xc hd y1098 ff77 fs7 fc3 sc0 ls1 ws1">The decimal digits column of T<span class="_ _10"></span>able<span class="fc5">12-1</span> is the approxima<span class="_ _3"></span>te number of </div><div class="t m0 xd hd y1099 ff77 fs7 fc3 sc0 ls1 ws1">decimal digits that the forma<span class="_ _3"></span>t can r<span class="_ _3"></span>epresent<span class="_ _3"></span>, or the decimal precision.</div><div class="t m0 xd h12 y484 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf11b" data-dest-detail='[283,"XYZ",35,274,null]'><div class="d m1" style="border-style:none;position:absolute;left:63.730600px;bottom:291.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11b" data-dest-detail='[283,"XYZ",35,274,null]'><div class="d m1" style="border-style:none;position:absolute;left:220.032000px;bottom:132.683000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf11c" class="pf w2 h6" data-page-no="11c"><div class="pc pc11c w2 h6"><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">271</div><div class="t m0 xc ha y248 ff7b fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>About Normalization andNaNs</div><div class="t m0 xc hd y249 ff77 fs7 fc3 sc0 ls12 ws1">In the integers we<span class="_ _3"></span>’ve seen so far<span class="_ _10"></span>, all combinations of the bits pro<span class="_ _3"></span>vide a valid </div><div class="t m0 xc hd y24a ff77 fs7 fc3 sc0 ls12 ws1">unique number<span class="_ _10"></span>. No two different pa<span class="_ _3"></span>tterns of bits produce the same n<span class="_ _3"></span>umber<span class="_ _0"></span>; </div><div class="t m0 xc hd y24b ff77 fs7 fc3 sc0 ls12 ws1">however<span class="_ _6"></span>, this isn’t the case in floating poin<span class="_ _3"></span>t. F<span class="_ _3"></span>irst of all, we ha<span class="_ _3"></span>ve the concept </div><div class="t m0 xc hd y24c ff77 fs7 fc3 sc0 ls12 ws1">of Not a N<span class="_ _1"></span>umber (<span class="ff7e ls2f wsd4">Na<span class="_ _0"></span>N</span>). NaN<span class="_ _3"></span>s are pr<span class="_ _3"></span>oduced from illegal oper<span class="_ _3"></span>ations like </div><div class="t m0 xc hd y24d ff77 fs7 fc3 sc0 ls12 ws1">dividing by zer<span class="_ _1"></span>o or taking the square root of a negativ<span class="_ _3"></span>e number<span class="_ _10"></span>. These allow </div><div class="t m0 xc hd y24e ff77 fs7 fc3 sc0 ls12 ws1">the error to quietly pr<span class="_ _3"></span>opagate thr<span class="_ _1"></span>ough the calculation without crashing a </div><div class="t m0 xc hd y24f ff77 fs7 fc3 sc0 ls12 ws1">progr<span class="_ _3"></span>am. In the IEEE 754 specifica<span class="_ _3"></span>tion, a N<span class="_ _1"></span>aN is represented by an exponen<span class="_ _3"></span>t </div><div class="t m0 xc hd y45d ff77 fs7 fc3 sc0 ls12 ws1">of all one bits, for example<span class="_ _1"></span>, 11111, depending on the size of the exponent.</div><div class="t m0 x1c hd y45e ff77 fs7 fc3 sc0 ls1 ws1">A normalized floating-<span class="_ _1"></span>point number means the first digit in the </div><div class="t m0 xc hd y109a ff77 fs7 fc3 sc0 ls1 ws1">fractional part is nonzer<span class="_ _1"></span>o. A pr<span class="_ _3"></span>oblem with floating-<span class="_ _1"></span>p<span class="_ _0"></span>oint n<span class="_ _3"></span>umbers is </div><div class="t m0 xc hd y109b ff77 fs7 fc3 sc0 ls1 ws1">that num<span class="_ _3"></span>bers can often be repr<span class="_ _1"></span>esented in multiple ways. F<span class="_ _1"></span>or instance, a </div><div class="t m0 xc hd y109c ff77 fs7 fc3 sc0 ls1 ws1">fractional part of 0 with either sign bit and any exponent is zer<span class="_ _1"></span>o. Consider a </div><div class="t m0 xc hd y109d ff77 fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esentation of 1:</div><div class="t m0 x54 hd y109e ff77 fs7 fc3 sc0 ls1 ws1">1E0 = 0.1E1 = 0.01E2 = 0.001E3</div><div class="t m0 x1c hd y109f ff77 fs7 fc3 sc0 ls1 ws1">All of these repr<span class="_ _3"></span>esent 1, but we call the first one with no leading zer<span class="_ _3"></span>os </div><div class="t m0 xc hd y10a0 ff77 fs7 fc3 sc0 ls1 ws1">the normalized form. The ARM FPU tries to keep floating-<span class="_ _1"></span>point numbers </div><div class="t m0 xc hd y10a1 ff77 fs7 fc3 sc0 ls1 ws1">in normal form, but will break this rule for small n<span class="_ _3"></span>umbers, wher<span class="_ _1"></span>e the </div><div class="t m0 xc hd y10a2 ff77 fs7 fc3 sc0 ls1 ws1">exponent is already as neg<span class="_ _3"></span>ative as it can go; then to try to avoid underflow </div><div class="t m0 xc hd y10a3 ff77 fs7 fc3 sc0 ls1 ws1">errors<span class="_ _3"></span>, the FPU will give up on normalization to repr<span class="_ _1"></span>es<span class="_ _0"></span>ent n<span class="_ _3"></span>umbers a bit </div><div class="t m0 xc hd y10a4 ff77 fs7 fc3 sc0 ls1 ws1">smaller than it could otherwise.</div><div class="t m0 xc ha y10a5 ff7b fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Recognizing Rounding Errors</div><div class="t m0 xc hd y10a6 ff77 fs7 fc3 sc0 ls1 ws1">If we take a number like <span class="ff7f">⅓</span> = 0.33333..., and r<span class="_ _1"></span>epresent it in floating point, </div><div class="t m0 xc hd y10a7 ff77 fs7 fc3 sc0 ls1 ws1">then we only keep seven or so digits for single precision. This in<span class="_ _3"></span>troduces </div><div class="t m0 xc hd y10a8 ff77 fs7 fc3 sc0 ls1 ws1">roundin<span class="_ _3"></span>g errors<span class="_ _3"></span>. If these are a pr<span class="_ _3"></span>oblem, usually going to do<span class="_ _3"></span>uble precision </div><div class="t m0 xc hd y10a9 ff77 fs7 fc3 sc0 ls1 ws1">solves the problems<span class="_ _1"></span>, but some calculations are prone t<span class="_ _3"></span>o magnifying </div><div class="t m0 xc hd y10aa ff77 fs7 fc3 sc0 ls1 ws1">roundin<span class="_ _3"></span>g errors<span class="_ _3"></span>, such as subtracting two n<span class="_ _3"></span>umbers that h<span class="_ _3"></span>ave a min<span class="_ _3"></span>ute </div><div class="t m0 xc hd y10ab ff77 fs7 fc3 sc0 ls1 ws1">difference<span class="_ _1"></span>.</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf11d" class="pf w2 h6" data-page-no="11d"><div class="pc pc11d w2 h6"><img class="bi xd y10ac w7 h53" alt="" src="bg11d.png"/><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">272</div><div class="t m0 x34 h1f y82c ff7b fse fc3 sc0 ls1 ws1">Note<span class="ff7c"> <span class="_ _19"> </span>Floating-point numbers are represented in base two,<span class="_ _1"></span> so the </span></div><div class="t m0 x34 h1f y82d ff7c fse fc3 sc0 ls1 ws1">decimal expansions leading to repeating pa<span class="_ _0"></span>tterns of digits is different </div><div class="t m0 x34 h1f y82e ff7c fse fc3 sc0 ls1 ws1">than that of base 10.<span class="_ _1"></span> It comes as a surprise to man<span class="_ _0"></span>y people that 0.1 </div><div class="t m0 x34 h1f y10ad ff7c fse fc3 sc0 ls1 ws1">is a repeating binar<span class="_ _0"></span>y fraction,<span class="_ _1"></span> 0.00011001100110011…,<span class="_ _1"></span> meaning </div><div class="t m0 x34 h1f y10ae ff7c fse fc3 sc0 ls1 ws1">that adding dollars and cents in floa<span class="_ _0"></span>ting point will introduce rounding </div><div class="t m0 x34 h1f y10af ff7c fse fc3 sc0 ls1 ws1">error over enough calculations.</div><div class="t m0 xc hd y10b0 ff77 fs7 fc3 sc0 ls1 ws1">For fin<span class="_ _3"></span>ancial calculations<span class="_ _1"></span>, most applications use fixed point arithmetic </div><div class="t m0 xd hd y10b1 ff77 fs7 fc3 sc0 ls1 ws1">that is built on in<span class="_ _3"></span>teger arithmetic to avoid r<span class="_ _3"></span>ounding errors in addition and </div><div class="t m0 xd hd y10b2 ff77 fs7 fc3 sc0 ls1 ws1">subtraction.</div><div class="t m0 xd h15 y10b3 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Defining Floating-P<span class="_ _1"></span>oint Numbers</div><div class="t m0 xd hd y10b4 ff77 fs7 fc3 sc0 ls1 ws1">The GNU Assembler has dir<span class="_ _3"></span>ectives for defining stora<span class="_ _3"></span>ge for both single- and </div><div class="t m0 xd hd y10b5 ff77 fs7 fc3 sc0 ls1 ws1">double-<span class="_ _3"></span>precision floa<span class="_ _3"></span>ting-<span class="_ _3"></span>point numbers<span class="_ _1"></span>. These are .<span class="ff7e">single</span> and .<span class="ff7e">double</span>, </div><div class="t m0 xd hd y10b6 ff77 fs7 fc3 sc0 ls1 ws1">for example:</div><div class="t m0 xd h18 y10b7 ff80 fs7 fc3 sc0 ls1 ws1">.single    1.343, 4.343e20, -0.4343, -0.4444e-10</div><div class="t m0 xd h18 y10b8 ff80 fs7 fc3 sc0 ls1 ws1">.double    -4.24322322332e-10, 3.141592653589793</div><div class="t m0 xc hd y10b9 ff77 fs7 fc3 sc0 ls1 ws1">These directives alwa<span class="_ _3"></span>ys take base 10 numbers<span class="_ _1"></span>.</div><div class="t m0 x34 h1f y10ba ff7b fse fc3 sc0 ls1 ws1">Note<span class="ff7c"> <span class="_ _17"> </span>The GNU <span class="_ _1"></span>Assembler doesn’t have a directive for 16-bit half- </span></div><div class="t m0 x34 h1f y10bb ff7c fse fc3 sc0 ls1 ws1">precision floating-point numbers,<span class="_ _1"></span> so we need to load one of these </div><div class="t m0 x34 h1f y10bc ff7c fse fc3 sc0 ls1 ws1">and then do a conversion.</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf11e" class="pf w2 h6" data-page-no="11e"><div class="pc pc11e w2 h6"><img class="bi xc y10bd w7 h54" alt="" src="bg11e.png"/><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">273</div><div class="t m0 xc h15 y186 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>About FPU Registers</div><div class="t m0 xc hd y187 ff77 fs7 fc3 sc0 ls1 ws1">The ARM FPU and the NEON coprocessor shar<span class="_ _3"></span>e a set of registers<span class="_ _1"></span>. There </div><div class="t m0 xc hd y188 ff77 fs7 fc3 sc0 ls1 ws1">are 32 128-bit r<span class="_ _3"></span>egisters referr<span class="_ _1"></span>e<span class="_ _0"></span>d to as <span class="ff7e">V0</span>, …, <span class="ff7e">V31</span>. I<span class="_ _3"></span>n the same way tha<span class="_ _3"></span>t a </div><div class="t m0 xc hd y2be ff7e fs7 fc3 sc0 ls1 ws1">W<span class="ff77"> register is h<span class="_ _3"></span>alf an <span class="ff7e">X</span> register<span class="_ _10"></span>, we have 32 double-<span class="_ _1"></span>precision floating-<span class="_ _1"></span>point </span></div><div class="t m0 xc hd y18a ff77 fs7 fc3 sc0 ls1 ws1">registers <span class="ff7e">D0</span>, …, <span class="ff7e">D31</span>. I<span class="_ _3"></span>n this case <span class="ff7e">D0</span> is the lower 64 bits of <span class="ff7e">V0</span>, <span class="ff7e">D1</span> is the </div><div class="t m0 xc hd y18b ff77 fs7 fc3 sc0 ls1 ws1">lower 64 bits of <span class="ff7e">V1,</span> and so on. W<span class="_ _1"></span>e can refer to the lower 32 bits of each of </div><div class="t m0 xc hd y732 ff77 fs7 fc3 sc0 ls1 ws1">these registers using <span class="ff7e">S0</span>, …, <span class="ff7e">S31</span> and then the lo<span class="_ _3"></span>wer 16 bits of each register </div><div class="t m0 xc hd y733 ff77 fs7 fc3 sc0 ls1 ws1">using <span class="ff7e">H0</span>, …, <span class="ff7e">H31</span>. Fi<span class="_ _3"></span>gure<span class="fc5">12-1</span> sho<span class="_ _3"></span>ws this configura<span class="_ _3"></span>tion of registers<span class="_ _1"></span>.</div><div class="t m0 xc h1c y10be ff7d fs3 fc3 sc0 ls1 ws1">Figure 12-1. <span class="_ _15"> </span><span class="ff78">A single ARM FPU registers<span class="_ _1"></span>, the f<span class="_ _0"></span>ormat of the da<span class="_ _3"></span>ta </span></div><div class="t m0 xc h1c y10bf ff78 fs3 fc3 sc0 ls1 ws1">depends on how you reference the r<span class="_ _1"></span>egister</div><div class="t m0 x36 h1f y10c0 ff7b fse fc3 sc0 ls1 ws1">Note<span class="ff7c"> <span class="_ _17"> </span>The register H1 is the lower 16 bits of register S1 which is the </span></div><div class="t m0 x36 h1f y10c1 ff7c fse fc3 sc0 ls1 ws1">lower 32 bits of register D1 which is the lo<span class="_ _0"></span>wer 64 bits of the 128-bit </div><div class="t m0 x36 h1f y10c2 ff7c fse fc3 sc0 ls1 wsc4">register V1.</div><div class="t m0 x1c hd y10c3 ff77 fs7 fc3 sc0 ls30 ws1">The floating-<span class="_ _1"></span>point unit can only process values up to 64 bits in<span class="_ _3"></span> </div><div class="t m0 xc hd y10c4 ff77 fs7 fc3 sc0 ls30 ws1">size. W<span class="_ _1"></span>e’ll see how the full 128 bits ar<span class="_ _1"></span>e use<span class="_ _0"></span>d b<span class="_ _3"></span>y the NEON processor in </div><div class="t m0 xc hd y10c5 ff77 fs7 fc3 sc0 ls30 ws61">Chapter <span class="fc5">13</span><span class="ws1">, “Neon Copr<span class="_ _1"></span>o<span class="_ _0"></span>cessor<span class="_ _10"></span>.<span class="_ _8"></span>” We need to be a<span class="_ _3"></span>ware of the full 128 bits<span class="_ _1"></span> </span></div><div class="t m0 xc hd y10c6 ff77 fs7 fc3 sc0 ls30 ws1">since we may need to sa<span class="_ _3"></span>ve the r<span class="_ _3"></span>egister to the stack as part of the function </div><div class="t m0 xc hd y10c7 ff77 fs7 fc3 sc0 ls30 ws1">calling pr<span class="_ _3"></span>otocol. The NEON Coprocessor can place in<span class="_ _3"></span>tegers in these </div><div class="t m0 xc hd y10c8 ff77 fs7 fc3 sc0 ls30 ws1">registers as well. F<span class="_ _1"></span>or 128-bit integers, the NEON Coprocessor labels these </div><div class="t m0 xc hd y10c9 ff77 fs7 fc3 sc0 ls30 ws61">registers <span class="ff7e">Q0</span><span class="ws1">, …, </span><span class="ff7e">Q31</span><span class="ws1">. W<span class="_ _1"></span>e only need to know this in this chapter<span class="_ _10"></span>, be<span class="_ _0"></span>ca<span class="_ _3"></span>use </span></div><div class="t m0 xc hd y10ca ff77 fs7 fc3 sc0 ls30 ws1">some instructions use this name to refer to the whole 128 bits<span class="_ _3"></span>, so as we </div><div class="t m0 xc hd y10cb ff77 fs7 fc3 sc0 ls30 ws1">will see in the next section, we ne<span class="_ _0"></span>ed to r<span class="_ _3"></span>efer to the registers as <span class="ff7e ls1">Q</span> r<span class="_ _3"></span>egisters </div><div class="t m0 xc hd y10cc ff77 fs7 fc3 sc0 ls30 ws1">to push and pop them to and from the stac<span class="_ _3"></span>k.</div><div class="t m0 x30 h12 y3e8 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf11e" data-dest-detail='[286,"XYZ",53,432,null]'><div class="d m1" style="border-style:none;position:absolute;left:172.469000px;bottom:450.903000px;width:20.547000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:95.139700px;bottom:194.020000px;width:11.220300px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf11f" class="pf w2 h6" data-page-no="11f"><div class="pc pc11f w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">274</div><div class="t m0 xd h15 y186 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Defining theFunction Call Protocol</div><div class="t m0 xd hd y187 ff77 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">6</span>, “F<span class="_ _1"></span>unctions and the Stack,<span class="_ _8"></span>” we gav<span class="_ _3"></span>e the protocol for who sa<span class="_ _1"></span>ves </div><div class="t m0 xd hd y188 ff77 fs7 fc3 sc0 ls1 ws1">which registers when c<span class="_ _3"></span>alling functions. W<span class="_ _1"></span>ith thes<span class="_ _0"></span>e floatin<span class="_ _3"></span>g-<span class="_ _3"></span>point registers<span class="_ _1"></span>, </div><div class="t m0 xd hd y2be ff77 fs7 fc3 sc0 ls1 ws1">we must add them to our pr<span class="_ _3"></span>otocol.</div><div class="t m0 xa hd y10cd ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Callee sa<span class="_ _3"></span>ved: The function is res<span class="_ _3"></span>ponsible for savin<span class="_ _3"></span>g </div><div class="t m0 x1e hd y892 ff77 fs7 fc3 sc0 ls1 ws1">registers <span class="ff7e">V8</span>–<span class="ff7e">V15</span>. They need to be sa<span class="_ _1"></span>ved by a function, </div><div class="t m0 x1e hd yf78 ff77 fs7 fc3 sc0 ls1 ws1">if the function uses them.</div><div class="t m0 xa hd y10ce ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Caller sa<span class="_ _1"></span>ved: All other registers don’t need to be saved </div><div class="t m0 x1e hd yf7a ff77 fs7 fc3 sc0 ls1 ws1">by a function, so they must be sa<span class="_ _1"></span>ved by the caller if </div><div class="t m0 x1e hd yf7b ff77 fs7 fc3 sc0 ls1 ws1">they are r<span class="_ _3"></span>equired to be pr<span class="_ _3"></span>eser<span class="_ _0"></span>ved. This includes <span class="ff7e">V0</span>–<span class="ff7e">V7</span> </div><div class="t m0 x1e hd yf7c ff77 fs7 fc3 sc0 ls1 ws1">which are used to pass par<span class="_ _3"></span>ameters.</div><div class="t m0 xc hd yf7d ff77 fs7 fc3 sc0 ls1 ws1">Man<span class="_ _3"></span>y of the Assembly instructions that we ha<span class="_ _1"></span>ve seen w<span class="_ _0"></span>ill take floa<span class="_ _3"></span>ting- </div><div class="t m0 xd hd yf7e ff77 fs7 fc3 sc0 ls1 ws1">point registers as well as <span class="ff7e">W</span> and <span class="ff7e">X</span> in<span class="_ _3"></span>teger registers<span class="_ _1"></span>. For instance, we can </div><div class="t m0 xd hd yf7f ff77 fs7 fc3 sc0 ls1 ws1">use <span class="ff7e ls1c wsbf">STP</span>, <span class="ff7e ls1c wsbf">STR</span>, <span class="ff7e ls31 wsd5">L<span class="_ _7"></span>D<span class="_ _7"></span>P,<span class="_ _7"></span></span> and <span class="ff7e">LDR</span> to load and save these registers to and fr<span class="_ _1"></span>om </div><div class="t m0 xd hd y10cf ff77 fs7 fc3 sc0 ls1 ws1">memory. In the context here<span class="_ _1"></span>, w<span class="_ _0"></span>e can con<span class="_ _3"></span>tinue to use these to push and </div><div class="t m0 xd hd y10d0 ff77 fs7 fc3 sc0 ls1 ws1">pop values to and from the stac<span class="_ _3"></span>k. W<span class="_ _1"></span>e need to keep in mind that the <span class="ff7e">Q</span> </div><div class="t m0 xd hd y10d1 ff77 fs7 fc3 sc0 ls1 ws1">registers ar<span class="_ _1"></span>e 128 bits or 16 bytes in size. Thus<span class="_ _1"></span>, the following are examples of </div><div class="t m0 xd hd y10d2 ff77 fs7 fc3 sc0 ls1 ws1">pushing and popping floating-<span class="_ _1"></span>point registers:</div><div class="t m0 xd h18 y10d3 ff81 fs7 fc3 sc0 ls1 ws1">STP<span class="ff80">   Q8, Q9, [SP, #-32]!</span></div><div class="t m0 xd h18 y10d4 ff81 fs7 fc3 sc0 ls1 ws1">STR<span class="ff80">   Q10, [SP, #-16]!</span></div><div class="t m0 xd h18 y10d5 ff81 fs7 fc3 sc0 ls1 ws1">LDP<span class="ff80">   Q8, Q9, [SP], #32</span></div><div class="t m0 xd h18 y10d6 ff81 fs7 fc3 sc0 ls1 ws1">LDR<span class="ff80">   Q10, [SP], #16</span></div><div class="t m0 xd h15 y10d7 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Loading andSaving FPU Registers</div><div class="t m0 xd hd y10d8 ff77 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">5</span>, “Thanks for the M<span class="_ _3"></span>emories,<span class="_ _66"></span>” we covered the <span class="ff7e">LDR</span> and <span class="ff7e ls1c wsbf">STR</span> </div><div class="t m0 xd hd y10d9 ff77 fs7 fc3 sc0 ls1 ws1">instructions to load registers fr<span class="_ _3"></span>om memory, then store them back to </div><div class="t m0 xd hd y10da ff77 fs7 fc3 sc0 ls1 ws1">memory. The FPU registers can all be used in these instructions, for </div><div class="t m0 xd hd y10db ff77 fs7 fc3 sc0 ls1 ws1">example:</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.502600px;bottom:547.090000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.502600px;bottom:136.903000px;width:5.500000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf120" class="pf w2 h6" data-page-no="120"><div class="pc pc120 w2 h6"><img class="bi xc y10dc w7 h24" alt="" src="bg120.png"/><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">275</div><div class="t m0 xc h18 ycbe ff80 fs7 fc3 sc0 ls1 ws1">      LDR    X1, =fp1</div><div class="t m0 xc h18 ycbf ff80 fs7 fc3 sc0 ls1 ws1">      LDR    S4, [X1]</div><div class="t m0 xc h18 ycc0 ff80 fs7 fc3 sc0 ls1 ws1">      LDR    D5, [X1, #4]</div><div class="t m0 xc h18 ycc1 ff80 fs7 fc3 sc0 ls1 ws1">      STR    S4, [X1]</div><div class="t m0 xc h18 ycc2 ff80 fs7 fc3 sc0 ls1 ws1">      STR    D5, [X1, #4]</div><div class="t m0 xc h18 ycc3 ff80 fs7 fc3 sc0 ls1 ws1">      ...</div><div class="t m0 xc h18 ycc4 ff80 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xc h18 ycc5 ff80 fs7 fc3 sc0 ls1 ws1">fp1:   .single    3.14159</div><div class="t m0 xc h18 ycc6 ff80 fs7 fc3 sc0 ls1 ws1">fp2:   .double    4.3341</div><div class="t m0 xc h18 ycc7 ff80 fs7 fc3 sc0 ls1 ws1">fp3:   .single    0.0</div><div class="t m0 xc h18 ycc8 ff80 fs7 fc3 sc0 ls1 ws1">fp4:   .double    0.0</div><div class="t m0 x1c hd y10dd ff77 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can also move data between the CPU’<span class="_ _1"></span>s integer regist<span class="_ _3"></span>ers and the </div><div class="t m0 xc hd y10de ff77 fs7 fc3 sc0 ls1 ws1">FPU with the <span class="ff7e">FMOV</span> instruction. This instruction also lets you move data </div><div class="t m0 xc hd y10df ff77 fs7 fc3 sc0 ls1 ws1">between FPU registers. Generally, the r<span class="_ _1"></span>egisters should be the same size, </div><div class="t m0 xc hd y10e0 ff77 fs7 fc3 sc0 ls1 ws1">but for half-<span class="_ _1"></span>precision <span class="ff7e">H</span> registers<span class="_ _1"></span>, you can copy them into lar<span class="_ _3"></span>ger integer </div><div class="t m0 xc hd yccd ff77 fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>, for example:</div><div class="t m0 x1e hd y10e1 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMOV <span class="_ _6f"> </span>H1, W2</div><div class="t m0 x1e hd y10e2 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMOV <span class="_ _6f"> </span>W2, H1</div><div class="t m0 x1e hd y10e3 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMOV <span class="_ _6f"> </span>S1, W2</div><div class="t m0 x1e hd y10e4 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMOV <span class="_ _6f"> </span>X1, D2</div><div class="t m0 x1e hd y10e5 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMOV <span class="_ _6f"> </span>D2, D3</div><div class="t m0 x36 h1f y10e6 ff7b fse fc3 sc0 ls1 ws1">Note<span class="ff7c wsd6"> The <span class="_ _70"></span><span class="ff7b ws1">FMOV<span class="ff7c"> instruction copies the bits unmodified.<span class="_ _1"></span> It doesn’t </span></span></span></div><div class="t m0 x36 h1f y10e7 ff7c fse fc3 sc0 ls1 ws1">perform any sort of conversion.</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf121" class="pf w2 h6" data-page-no="121"><div class="pc pc121 w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">276</div><div class="t m0 xd h15 y186 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>P<span class="_ _1"></span>erforming Basic Arithmetic</div><div class="t m0 xd hd y187 ff77 fs7 fc3 sc0 ls1 ws1">The FPU includes the four basic arithmetic operations<span class="_ _1"></span>, along with a </div><div class="t m0 xd hd y188 ff77 fs7 fc3 sc0 ls1 ws1">few extensions like multiply and accum<span class="_ _3"></span>ulate<span class="_ _3"></span>. There ar<span class="_ _1"></span>e some specialty </div><div class="t m0 xd hd y189 ff77 fs7 fc3 sc0 ls1 ws1">functions like square r<span class="_ _1"></span>o<span class="_ _0"></span>ot and quite a few variations th<span class="_ _3"></span>at affect the sign—</div><div class="t m0 xd hd y18a ff77 fs7 fc3 sc0 ls1 ws1">negate versions of functions<span class="_ _1"></span>.</div><div class="t m0 xc hd y18b ff77 fs7 fc3 sc0 ls1 ws1">Each of these functions can operate on either <span class="ff7e">H</span>, <span class="ff7e ls15 wsb8">S,<span class="_ _3"></span><span class="ff77 ls1 ws1"> or <span class="ff7e">D</span> registers<span class="_ _1"></span>. </span></span></div><div class="t m0 xd hd y18c ff77 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e’<span class="_ _6"></span>s a selection of the instructions. W<span class="_ _1"></span>e list the three forms of the <span class="ff7e">F<span class="_ _1"></span>ADD<span class="ff77"> </span></span></div><div class="t m0 xd hd y18d ff77 fs7 fc3 sc0 ls1 ws1">instruction with each floating-<span class="_ _3"></span>point type, then list the r<span class="_ _1"></span>est w<span class="_ _0"></span>ith jus<span class="_ _3"></span>t the <span class="ff7e">D</span> </div><div class="t m0 xd hd y18e ff77 fs7 fc3 sc0 ls1 ws1">registers to sa<span class="_ _1"></span>ve space:</div><div class="t m0 xa hd y10e8 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>F<span class="_ _6"></span>ADD <span class="_ _71"> </span>Hd, Hn, Hm <span class="_ _72"> </span>// Hd = Hn + Hm</div><div class="t m0 xa hd y10e9 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>F<span class="_ _6"></span>ADD <span class="_ _71"> </span>Sd, Sn, Sm <span class="_ _59"> </span>// Sd = Sn + Sm</div><div class="t m0 xa hd y10ea ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>F<span class="_ _6"></span>ADD <span class="_ _71"> </span>Dd, Dn, Dm <span class="_ _64"> </span>// Dd = Dn + Dm</div><div class="t m0 xa hd y10eb ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FSUB <span class="_ _73"> </span>Dd, Dn, Dm <span class="_ _64"> </span>// Dd = Dn- Dm</div><div class="t m0 xa h18 y10ec ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMUL <span class="_ _74"> </span>Dd, Dn, Dm <span class="_ _64"> </span>// Dd = Dn <span class="ff80">*</span> Dm</div><div class="t m0 xa hd y10ed ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FDIV <span class="_ _66"></span>D<span class="_ _0"></span>d, Dn, Dm <span class="_ _64"> </span>// Dd = Dn / Dm</div><div class="t m0 xa h18 y10ee ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ls12">FMADD <span class="_ _75"> </span>Dd, Dn, Dm, Da <span class="_ _76"> </span>// Dd = Da + Dm </span><span class="ff80">*</span><span class="ls8 wsb8"> Dn</span></div><div class="t m0 xa h18 y10ef ff77 fs7 fc3 sc0 ls12 wsc9">• <span class="_ _c"> </span><span class="ws1">FMSUB <span class="_ _60"> </span>Dd, Dn, Dm, Da <span class="_ _76"> </span>// Dd = Da– Dm <span class="ff80 ls1">*</span><span class="ls8 ws9f">Dn</span></span></div><div class="t m0 xa hd y10f0 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FNEG <span class="_ _71"> </span>Dd, Dn  <span class="_ _5a"> </span>// Dd =- Dn</div><div class="t m0 xa hd y10f1 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>F<span class="_ _6"></span>ABS <span class="_ _8"></span>Dd, D<span class="_ _0"></span>n <span class="_ _1"></span> <span class="_ _5a"> </span>// D<span class="_ _0"></span>d = Absolute V<span class="_ _6"></span>alue( Dn )</div><div class="t m0 xa hd y10f2 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMAX <span class="_ _74"> </span>Dd, Dn, Dm <span class="_ _64"> </span>// Dd = Max( Dn, Dm )</div><div class="t m0 xa hd y10f3 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FMIN <span class="_ _6b"> </span>Dd, Dn, Dm <span class="_ _64"> </span>// Dd = Min( Dn, Dm )</div><div class="t m0 xa hd y10f4 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FSQRT <span class="_ _5f"> </span>Dd, Dn  <span class="_ _5a"> </span>// Dd = Square Root( Dn )</div><div class="t m0 xc hd y10f5 ff77 fs7 fc3 sc0 ls1 ws1">These functions are all fairly simple<span class="_ _1"></span>, so let<span class="_ _0"></span>’<span class="_ _6"></span>s move on to an example </div><div class="t m0 xd hd y10f6 ff77 fs7 fc3 sc0 ls1 ws1">using floating-<span class="_ _1"></span>point functions.</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf122" class="pf w2 h6" data-page-no="122"><div class="pc pc122 w2 h6"><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">277</div><div class="t m0 xc h15 y186 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Calculating Distance Between P<span class="_ _1"></span>oints</div><div class="t m0 xc hd y187 ff77 fs7 fc3 sc0 ls1 ws1">If we hav<span class="_ _3"></span>e two points (x</div><div class="t m0 x63 h1b y10f7 ff77 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x4 hd y187 ff77 fs7 fc3 sc0 ls1 ws1">, y</div><div class="t m0 x64 h1b y10f7 ff77 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x65 hd y187 ff77 fs7 fc3 sc0 ls1 ws1">) and (x</div><div class="t m0 x66 h1b y10f7 ff77 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x29 hd y187 ff77 fs7 fc3 sc0 ls1 ws1">, y</div><div class="t m0 x39 h1b y10f7 ff77 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x3a hd y187 ff77 fs7 fc3 sc0 ls1 ws1">), then the distance between them is </div><div class="t m0 xc hd y188 ff77 fs7 fc3 sc0 ls1 ws1">given by the formula</div><div class="t m0 x67 hd y10f8 ff77 fs7 fc3 sc0 ls1 ws1">d = sqrt( (y</div><div class="t m0 x29 h1b y10f9 ff77 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x2a hd y10fa ff77 fs7 fc3 sc0 ls1 ws1">-y</div><div class="t m0 x30 h1b y10f9 ff77 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x31 hd y10fa ff77 fs7 fc3 sc0 ls1 ws1">)</div><div class="t m0 x68 h1b y10fb ff77 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x42 hd y10fc ff77 fs7 fc3 sc0 ls1 ws1"> + (x</div><div class="t m0 x69 h1b y10fd ff77 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x6a hd y10fc ff77 fs7 fc3 sc0 ls28 wscb">-x</div><div class="t m0 x6b h1b y10fd ff77 fsd fc3 sc0 ls1 ws1">1</div><div class="t m0 x56 hd y10fc ff77 fs7 fc3 sc0 ls1 ws1">)</div><div class="t m0 x57 h1b y10fb ff77 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x32 hd y10fc ff77 fs7 fc3 sc0 ls1 ws1"> )</div><div class="t m0 x1c hd y10fe ff77 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s write a function to calculate this for any two single-<span class="_ _1"></span>precision </div><div class="t m0 xc hd y10ff ff77 fs7 fc3 sc0 ls30 ws1">floating-<span class="_ _1"></span>point pair of coordinates<span class="_ _1"></span>. We<span class="_ _1"></span>’ll us<span class="_ _0"></span>e the C runtime<span class="_ _3"></span>’<span class="_ _6"></span>s <span class="ff7e ws61">printf</span><span class="ls1"> </span></div><div class="t m0 xc hd y1100 ff77 fs7 fc3 sc0 ls1 ws1">fun<span class="_ _0"></span>ctio<span class="_ _0"></span>n to print out our results<span class="_ _1"></span>. First of all, copy the distance function </div><div class="t m0 xc hd y1101 ff77 fs7 fc3 sc0 ls1 ws1">from Listing <span class="fc5">12-1</span> to the file distance<span class="_ _1"></span>.s.</div><div class="t m0 xc h20 y1102 ff7d fs3 fc3 sc0 ls1 ws1">Listing 12-1. <span class="_ _15"> </span><span class="ff77">Function to c<span class="_ _3"></span>alculate the distance between two points</span></div><div class="t m0 xc h18 y1103 ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y1104 ff80 fs7 fc3 sc0 ls1 ws1">// Example function to calculate the distance</div><div class="t m0 xc h18 y1105 ff80 fs7 fc3 sc0 ls1 ws1">// between two points in single precision</div><div class="t m0 xc h18 y1106 ff80 fs7 fc3 sc0 ls1 ws1">// floating-point.</div><div class="t m0 xc h18 y1107 ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y1108 ff80 fs7 fc3 sc0 ls1 ws1">// Inputs:</div><div class="t m0 xc h18 y1109 ff80 fs7 fc3 sc0 ls1 ws1">//    X0 - pointer to the 4 FP numbers</div><div class="t m0 xc h18 y110a ff80 fs7 fc3 sc0 ls1 ws1">//           they are x1, y1, x2, y2</div><div class="t m0 xc h18 y110b ff80 fs7 fc3 sc0 ls1 ws1">// Outputs:</div><div class="t m0 xc h18 y110c ff80 fs7 fc3 sc0 ls1 ws1">//    X0 - the length (as single precision FP)</div><div class="t m0 xc h18 y110d ff80 fs7 fc3 sc0 ls1 ws1">.global distance // Allow function to be called by others</div><div class="t m0 xc h18 y110e ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y110f ff80 fs7 fc3 sc0 ls1 ws1">distance:</div><div class="t m0 xc h18 y1110 ff80 fs7 fc3 sc0 ls1 ws1">      // push all registers to be safe, we don&apos;t really</div><div class="t m0 xc h18 y1111 ff80 fs7 fc3 sc0 ls1 ws1">      // need to push so many.</div><div class="t m0 xc h18 y1112 ff80 fs7 fc3 sc0 ls1 ws1">      STR    LR, [SP, #-16]!</div><div class="t m0 xc h18 y1113 ff80 fs7 fc3 sc0 ls1 ws1">      // load all 4 numbers at once</div><div class="t m0 xc h18 y1114 ff80 fs7 fc3 sc0 ls1 ws1">      LDP    S0, S1, [X0], #8</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf122" data-dest-detail='[290,"XYZ",53,419,null]'><div class="d m1" style="border-style:none;position:absolute;left:112.904000px;bottom:433.090000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf123" class="pf w2 h6" data-page-no="123"><div class="pc pc123 w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">278</div><div class="t m0 xd h18 y46b ff80 fs7 fc3 sc0 ls1 ws1">      LDP    S2, S3, [X0]</div><div class="t m0 xd h18 ye19 ff80 fs7 fc3 sc0 ls1 ws1">      // calc s4 = x2 - x1</div><div class="t m0 xd h18 ya17 ff80 fs7 fc3 sc0 ls1 ws1">      FSUB   S4, S2, S0</div><div class="t m0 xd h18 y46e ff80 fs7 fc3 sc0 ls1 ws1">      // calc s5 = y2 - y1</div><div class="t m0 xd h18 y46f ff80 fs7 fc3 sc0 ls1 ws1">      FSUB   S5, S3, S1</div><div class="t m0 xd h18 y85d ff80 fs7 fc3 sc0 ls1 ws1">      // calc s4 = S4 * S4 (x2-X1)^2</div><div class="t m0 xd h18 y983 ff80 fs7 fc3 sc0 ls1 ws1">      FMUL   S4, S4, S4</div><div class="t m0 xd h18 y984 ff80 fs7 fc3 sc0 ls1 ws1">      // calc s5 = s5 * s5 (Y2-Y1)^2</div><div class="t m0 xd h18 yb7a ff80 fs7 fc3 sc0 ls1 ws1">      FMUL   S5, S5, S5</div><div class="t m0 xd h18 yb7b ff80 fs7 fc3 sc0 ls1 ws1">      // calc S4 = S4 + S5</div><div class="t m0 xd h18 y62a ff80 fs7 fc3 sc0 ls1 ws1">      FADD   S4, S4, S5</div><div class="t m0 xd h18 y62b ff80 fs7 fc3 sc0 ls1 ws1">      // calc sqrt(S4)</div><div class="t m0 xd h18 y9f9 ff80 fs7 fc3 sc0 ls1 ws1">      FSQRT  S4, S4</div><div class="t m0 xd h18 yc53 ff80 fs7 fc3 sc0 ls1 ws1">      // move result to X0 to be returned</div><div class="t m0 xd h18 yc54 ff80 fs7 fc3 sc0 ls1 ws1">      FMOV   W0, S4</div><div class="t m0 xd h18 yc3f ff80 fs7 fc3 sc0 ls1 ws1">      // restore what we preserved.</div><div class="t m0 xd h18 yc40 ff80 fs7 fc3 sc0 ls1 ws1">      LDR    LR, [SP], #16</div><div class="t m0 xd h18 yd66 ff80 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 xc hd y1115 ff77 fs7 fc3 sc0 ls1 ws1">Place the code from Listing <span class="fc5">12-2</span> in m<span class="_ _3"></span>ain.s that calls dis<span class="_ _3"></span>tance three </div><div class="t m0 xd hd y1116 ff77 fs7 fc3 sc0 ls1 ws1">times with three differen<span class="_ _3"></span>t points and prints out the distance for each one<span class="_ _1"></span>.</div><div class="t m0 xd h20 yd69 ff7d fs3 fc3 sc0 ls1 ws1">Listing 12-2. <span class="_ _15"> </span><span class="ff77">Main pr<span class="_ _1"></span>ogram to call the distance function three times</span></div><div class="t m0 xd h18 ye13 ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y1117 ff80 fs7 fc3 sc0 ls1 ws1">// Main program to test our distance function</div><div class="t m0 xd h18 y1118 ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y1119 ff80 fs7 fc3 sc0 ls1 ws1">// W19 - loop counter</div><div class="t m0 xd h18 y111a ff80 fs7 fc3 sc0 ls1 ws1">// X20 - address to current set of points</div><div class="t m0 xd h18 y111b ff80 fs7 fc3 sc0 ls1 ws1">.global main // Provide program starting address to linker</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf123" data-dest-detail='[291,"XYZ",35,235,null]'><div class="d m1" style="border-style:none;position:absolute;left:182.874000px;bottom:265.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf124" class="pf w2 h6" data-page-no="124"><div class="pc pc124 w2 h6"><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">279</div><div class="t m0 xc h18 y46b ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 ye19 ff80 fs7 fc3 sc0 ls1 ws1">      .equ  N, 3   // Number of points.</div><div class="t m0 xc h18 y111c ff80 fs7 fc3 sc0 ls1 ws1">main:</div><div class="t m0 xc h18 ye1b ff80 fs7 fc3 sc0 ls1 ws1">      STP   X19, X20, [SP, #-16]!</div><div class="t m0 xc h18 y111d ff80 fs7 fc3 sc0 ls1 ws1">      STR   LR, [SP, #-16]!</div><div class="t m0 xc h18 y111e ff80 fs7 fc3 sc0 ls1 ws1">      LDR   X20, =points   // pointer to current points</div><div class="t m0 xc h18 y111f ff80 fs7 fc3 sc0 ls1 ws1">      MOV   W19, #N        // number of loop iterations</div><div class="t m0 xc h18 y1120 ff80 fs7 fc3 sc0 ls1 ws1">loop: MOV   X0, X20        // move pointer to parameter 1 (X0)</div><div class="t m0 xc h18 y1121 ff80 fs7 fc3 sc0 ls1 ws1">      BL    distance       // call distance function</div><div class="t m0 xc h18 y1122 ff80 fs7 fc3 sc0 ls1 ws1">// need to take the single precision return value</div><div class="t m0 xc h18 y1123 ff80 fs7 fc3 sc0 ls1 ws1">// and convert it to a double, because the C printf</div><div class="t m0 xc h18 y1124 ff80 fs7 fc3 sc0 ls1 ws1">// function can only print doubles.</div><div class="t m0 xc h18 y1125 ff80 fs7 fc3 sc0 ls1 ws1">      FMOV  S2, W0         // move back to fpu for conversion</div><div class="t m0 xc h18 y1126 ff80 fs7 fc3 sc0 ls1 ws1">      FCVT  D0, S2         // convert single to double</div><div class="t m0 xc h18 y1127 ff80 fs7 fc3 sc0 ls1 ws1">      FMOV  X1, D0         // return double to X1</div><div class="t m0 xc h18 y1128 ff80 fs7 fc3 sc0 ls1 ws1">      LDR   X0, =prtstr    // load print string</div><div class="t m0 xc h18 y1129 ff80 fs7 fc3 sc0 ls1 ws1">      BL    printf         // print the distance</div><div class="t m0 xc h18 y112a ff80 fs7 fc3 sc0 ls1 ws1">      ADD   X20, X20, #(4*4)      // 4 points each 4 bytes</div><div class="t m0 xc h18 y112b ff80 fs7 fc3 sc0 ls1 ws1">      SUBS  W19, W19, #1   // decrement loop counter</div><div class="t m0 xc h18 y112c ff80 fs7 fc3 sc0 ls1 ws1">      B.NE  loop           // loop if more points</div><div class="t m0 xc h18 y112d ff80 fs7 fc3 sc0 ls1 ws1">      MOV   X0, #0         // return code</div><div class="t m0 xc h18 y112e ff80 fs7 fc3 sc0 ls1 ws1">      LDR   LR, [SP], #16</div><div class="t m0 xc h18 y112f ff80 fs7 fc3 sc0 ls1 ws1">      LDP   X19, X20, [SP], #16</div><div class="t m0 xc h18 y1130 ff80 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf125" class="pf w2 h6" data-page-no="125"><div class="pc pc125 w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">280</div><div class="t m0 xd h18 y46b ff80 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y46c ff80 fs7 fc3 sc0 ls1 ws1">points:     .single        0.0, 0.0, 3.0, 4.0</div><div class="t m0 xd h18 y46d ff80 fs7 fc3 sc0 ls1 ws1">            .single        1.3, 5.4, 3.1, -1.5</div><div class="t m0 xd h18 y623 ff80 fs7 fc3 sc0 ls1 ws1">            .single 1.323e10, -1.2e-4, 34.55, 5454.234</div><div class="t m0 xd h18 y624 ff80 fs7 fc3 sc0 ls1 ws1">prtstr:     .asciz &quot;Distance = %f\n&quot;</div><div class="t m0 xc hd y85d ff77 fs7 fc3 sc0 ls1 ws1">The makefile is in Listing <span class="fc5">12-3</span>.</div><div class="t m0 xd h20 y1131 ff7d fs3 fc3 sc0 ls1 ws1">Listing 12-3. <span class="_ _15"> </span><span class="ff77">Mak<span class="_ _3"></span>efile for the distance progr<span class="_ _1"></span>am</span></div><div class="t m0 xd h18 y1132 ff80 fs7 fc3 sc0 ls1 ws1">distance: distance.s main.s</div><div class="t m0 xd h18 y1133 ff80 fs7 fc3 sc0 ls1 ws1">      gcc -o distance distance.s main.s</div><div class="t m0 xc hd y1134 ff77 fs7 fc3 sc0 ls1 ws1">If we build and run the program<span class="_ _3"></span>, we get</div><div class="t m0 xd h18 y1135 ff80 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 12$ make</div><div class="t m0 xd h18 y1136 ff80 fs7 fc3 sc0 ls1 ws1">gcc -g -o distance distance.s main.s</div><div class="t m0 xd h18 y1137 ff80 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 12$ ./distance</div><div class="t m0 xd h18 y1138 ff80 fs7 fc3 sc0 ls1 ws1">Distance = 5.000000</div><div class="t m0 xd h18 y1139 ff80 fs7 fc3 sc0 ls1 ws1">Distance = 7.130919</div><div class="t m0 xd h18 y113a ff80 fs7 fc3 sc0 ls1 ws1">Distance = 13230000128.000000</div><div class="t m0 xd h18 y113b ff80 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 12$</div><div class="t m0 xc hd y113c ff77 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e constructed the data, so the first set of points comprise a 3-4-5 </div><div class="t m0 xd hd y113d ff77 fs7 fc3 sc0 ls1 ws1">triangle, which is wh<span class="_ _3"></span>y we get the exact answer of 5 for the first distance.</div><div class="t m0 xc hd y113e ff77 fs7 fc3 sc0 ls12 ws1">The distance function is strai<span class="_ _3"></span>ghtforward. It loads the fo<span class="_ _3"></span>ur numbers </div><div class="t m0 xd hd y113f ff77 fs7 fc3 sc0 ls12 ws1">in two <span class="ff7e wsc9">LDP</span> instructions, then calls the various floating-<span class="_ _1"></span>point arithmetic </div><div class="t m0 xd hd y1140 ff77 fs7 fc3 sc0 ls12 ws1">functions to perform the calculation. This function operates on  <span class="_ _b"></span>single- </div><div class="t m0 xd hd y1141 ff77 fs7 fc3 sc0 ls12 ws1">precision 32-bit floatin<span class="_ _3"></span>g-<span class="_ _3"></span>point numbers using the <span class="ff7e ls1">S<span class="_ _3"></span><span class="ff77 ls12"> versions of the r<span class="_ _3"></span>egisters.</span></span></div><div class="t m0 xc hd y1142 ff77 fs7 fc3 sc0 ls1 ws1">The part of the main ro<span class="_ _3"></span>utine that loops and calls the distance r<span class="_ _1"></span>outine is </div><div class="t m0 xd hd y1143 ff77 fs7 fc3 sc0 ls1 ws1">straigh<span class="_ _3"></span>tfor<span class="_ _0"></span>war<span class="_ _1"></span>d. The part that calls printf has a couple of new complexities<span class="_ _3"></span>. </div><div class="t m0 xd hd y1144 ff77 fs7 fc3 sc0 ls1 ws1">The problem is th<span class="_ _3"></span>at the C printf r<span class="_ _3"></span>outine only has support to print doubles<span class="_ _3"></span>. </div><div class="t m0 xd hd y1145 ff77 fs7 fc3 sc0 ls1 ws1">In C this isn’t much of a pr<span class="_ _1"></span>oblem, since you can just cast the ar<span class="_ _3"></span>gument to </div><div class="t m0 xd hd y1146 ff77 fs7 fc3 sc0 ls1 ws1">force a con<span class="_ _3"></span>version. In Assembly Lan<span class="_ _3"></span>guage, we need to con<span class="_ _3"></span>vert our single- </div><div class="t m0 xd hd y1147 ff77 fs7 fc3 sc0 ls1 ws1">precision sum to a double-<span class="_ _1"></span>precision number<span class="_ _10"></span>, so we can pr<span class="_ _0"></span>int it<span class="_ _3"></span>.</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf125" data-dest-detail='[293,"XYZ",35,478,null]'><div class="d m1" style="border-style:none;position:absolute;left:172.567000px;bottom:489.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf126" class="pf w2 h6" data-page-no="126"><div class="pc pc126 w2 h6"><img class="bi xc y3cd w7 h28" alt="" src="bg126.png"/><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">281</div><div class="t m0 x1c hd y3ce ff77 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o do the conversion, we <span class="ff7e">FMOV</span> the sum back to the FPU<span class="_ _1"></span>.W<span class="_ _1"></span>e use the </div><div class="t m0 xc hd y3cf ff7e fs7 fc3 sc0 ls8 ws9f">FCV<span class="_ _0"></span>T<span class="ff77 ls1 ws1"> instruction to convert fr<span class="_ _3"></span>om single to double pr<span class="_ _3"></span>ecision. This function </span></div><div class="t m0 xc hd y3d0 ff77 fs7 fc3 sc0 ls1 ws1">is the topic of the next section. W<span class="_ _1"></span>e then <span class="ff7e">FMOV</span> the freshly constructed </div><div class="t m0 xc hd y3d1 ff77 fs7 fc3 sc0 ls1 ws1">double back to r<span class="_ _3"></span>egister <span class="ff7e">X1</span>.</div><div class="t m0 x1c hd y3d2 ff77 fs7 fc3 sc0 ls1 ws1">When we call printf, the first par<span class="_ _3"></span>ameter<span class="_ _10"></span>, the pr<span class="_ _0"></span>intf forma<span class="_ _3"></span>t string, goes in </div><div class="t m0 xc hd y3d3 ff7e fs7 fc3 sc0 ls1 ws1">X0<span class="ff77">, and then the next parameter<span class="_ _10"></span>, the double to print, goes in <span class="ff7e">X1</span>.</span></div><div class="t m0 x36 h1f y3d4 ff7b fse fc3 sc0 ls1 ws1">Note<span class="ff7c"> <span class="_ _19"> </span>If you are debugging the program with </span>gdb<span class="ff7c">,<span class="_ _1"></span> and you want  </span></div><div class="t m0 x36 h1f y3d5 ff7c fse fc3 sc0 ls1 ws1">to see the contents of the FPU registers at an<span class="_ _0"></span>y point,<span class="_ _1"></span> use the  </div><div class="t m0 x36 h1f y3d6 ff7c fse fc3 sc0 ls1 ws1">“<span class="ff7b">info all-registers</span>”<span class="_ _1"></span> command that will exhaustively list all the </div><div class="t m0 x36 h1f y3d7 ff7c fse fc3 sc0 ls1 ws1">coprocessor registers.</div><div class="t m0 xc h15 y1148 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>P<span class="_ _1"></span>erforming Floating-P<span class="_ _1"></span>oint Conversions</div><div class="t m0 xc hd y1149 ff77 fs7 fc3 sc0 ls1 ws1">In the last example<span class="_ _1"></span>, w<span class="_ _0"></span>e had o<span class="_ _3"></span>ur first look at the conver<span class="_ _3"></span>sion instruction </div><div class="t m0 xc hd y114a ff7e fs7 fc3 sc0 ls8 ws9f">FCV<span class="_ _0"></span>T<span class="ff77 ls1 ws1">. The FPU supports a variety of versions of this function; not only </span></div><div class="t m0 xc hd y114b ff77 fs7 fc3 sc0 ls1 ws1">does it support conversions between single- and double-<span class="_ _1"></span>precision </div><div class="t m0 xc hd y114c ff77 fs7 fc3 sc0 ls1 ws1">floating-<span class="_ _1"></span>point numbers, but it supports con<span class="_ _3"></span>versions to and from in<span class="_ _3"></span>tegers. I<span class="_ _1"></span>t </div><div class="t m0 xc hd y114d ff77 fs7 fc3 sc0 ls1 ws1">also supports conversion to fixed point decimal n<span class="_ _3"></span>umbers (integers with an </div><div class="t m0 xc hd y114e ff77 fs7 fc3 sc0 ls1 ws1">implied decimal). I<span class="_ _3"></span>t supports several roundin<span class="_ _3"></span>g methods as well. The most </div><div class="t m0 xc hd y114f ff77 fs7 fc3 sc0 ls1 ws1">used versions of this function are</div><div class="t m0 x1e hd y1150 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>T <span class="_ _76"> </span>Dd, Sm</div><div class="t m0 x1e hd y1151 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>T <span class="_ _76"> </span>Sd, Dm</div><div class="t m0 x1e hd y1152 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>T <span class="_ _76"> </span>Sd, Hm</div><div class="t m0 x1e hd y1153 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>T <span class="_ _76"> </span>H<span class="_ _3"></span>d, Sm</div><div class="t m0 x1c hd y1154 ff77 fs7 fc3 sc0 ls12 ws1">These convert single to double pr<span class="_ _1"></span>ecision and double to single precision.</div><div class="t m0 x30 h12 y3e8 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf127" class="pf w2 h6" data-page-no="127"><div class="pc pc127 w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">282</div><div class="t m0 xc hd y145 ff77 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o convert from an int<span class="_ _3"></span>eger to a floating-<span class="_ _1"></span>p<span class="_ _0"></span>oint n<span class="_ _3"></span>umber<span class="_ _10"></span>, w<span class="_ _0"></span>e ha<span class="_ _1"></span>ve</div><div class="t m0 xa hd y58c ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>SC<span class="_ _0"></span>VTF <span class="_ _5f"> </span>D<span class="_ _0"></span>d, Xm <span class="_ _b"></span>// Dd = signed integer from Xm</div><div class="t m0 xa hd yc78 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>UCV<span class="_ _0"></span>TF <span class="_ _77"> </span>Sd, Wm// Sd = unsigned integer from Wm</div><div class="t m0 xc hd yc79 ff77 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o convert from floa<span class="_ _3"></span>ting point to integer<span class="_ _10"></span>, we have several choices for </div><div class="t m0 xd hd y1155 ff77 fs7 fc3 sc0 ls1 ws1">how we want r<span class="_ _3"></span>ounding handled:</div><div class="t m0 xa hd y1156 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>T<span class="_ _1"></span>AS <span class="_ _78"> </span>W<span class="_ _1"></span>d, Hn// signed, round to near<span class="_ _1"></span>est</div><div class="t m0 xa hd y1157 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>T<span class="_ _1"></span>A<span class="_ _1"></span>U <span class="_ _79"> </span>W<span class="_ _1"></span>d, Sn// unsigned, round to nearest</div><div class="t m0 xa hd y1158 ff77 fs7 fc3 sc0 lse wsb2">• <span class="_ _c"> </span><span class="ws1">FC<span class="_ _0"></span>VTMS <span class="_ _79"> </span>Xd, Dn<span class="_ _0"></span><span class="_ _0"></span>// signed, round t<span class="_ _3"></span>owar<span class="_ _3"></span>ds minus infinity</span></div><div class="t m0 xa hd y1159 ff77 fs7 fc3 sc0 lse wsb2">• <span class="_ _c"> </span><span class="ws1">FC<span class="_ _0"></span>VTMU <span class="_ _7a"> </span>Xd, Dn<span class="_ _0"></span><span class="_ _0"></span>// unsigned, round tow<span class="_ _3"></span>ards minus infinity</span></div><div class="t m0 xa hd y115a ff77 fs7 fc3 sc0 lse wsb2">• <span class="_ _c"> </span><span class="ws1">FC<span class="_ _0"></span>VTP<span class="_ _0"></span>S <span class="_ _3d"> </span>Xd, Dn<span class="_ _0"></span><span class="_ _0"></span>// signed, round to<span class="_ _3"></span>war<span class="_ _3"></span>ds positive infinity</span></div><div class="t m0 xa hd y115b ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ls2e">FCV<span class="_ _0"></span>TPU <span class="_ _78"> </span>Xd, Dn<span class="_ _0"></span><span class="_ _0"></span>// unsigned, round towar<span class="_ _1"></span>ds positive infinity</span></div><div class="t m0 xa hd y115c ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>TZS <span class="_ _78"> </span>Xd, Dn// signed, round to<span class="_ _3"></span>wards z<span class="_ _3"></span>ero</div><div class="t m0 xa hd y115d ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCV<span class="_ _0"></span>TZU <span class="_ _7b"> </span>Xd, Dn// unsigned, round to<span class="_ _3"></span>wards zer<span class="_ _1"></span>o</div><div class="t m0 xd h15 y1f5 ff7b fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Comparing Floating-P<span class="_ _1"></span>oint Numbers</div><div class="t m0 xd hd y26b ff77 fs7 fc3 sc0 ls1 ws1">Most of the floatin<span class="_ _3"></span>g-<span class="_ _3"></span>point instructions don’t ha<span class="_ _3"></span>ve “<span class="_ _3"></span>S” vers<span class="_ _3"></span>ions<span class="_ _0"></span>; therefor<span class="_ _1"></span>e, </div><div class="t m0 xd hd y115e ff77 fs7 fc3 sc0 ls1 ws1">don’t update the condition flags<span class="_ _3"></span>. The main instruction tha<span class="_ _3"></span>t updates these </div><div class="t m0 xd hd y115f ff77 fs7 fc3 sc0 ls1 ws1">flags is the <span class="ff7e">FCMP</span> instruction. Her<span class="_ _3"></span>e are its forms:</div><div class="t m0 xa hd y1160 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCMP <span class="_ _74"> </span>Hd, Hm</div><div class="t m0 xa hd y1161 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCMP <span class="_ _74"> </span>Hd, #0.0</div><div class="t m0 xa hd y1162 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCMP <span class="_ _74"> </span>S<span class="_ _0"></span>d, Sm</div><div class="t m0 xa hd y1163 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCMP <span class="_ _74"> </span>S<span class="_ _0"></span>d, #0.0</div><div class="t m0 xa hd y1164 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCMP <span class="_ _74"> </span>D<span class="_ _0"></span>d, Dm</div><div class="t m0 xa hd y1165 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>FCMP <span class="_ _74"> </span>D<span class="_ _0"></span>d, #0.0</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf128" class="pf w2 h6" data-page-no="128"><div class="pc pc128 w2 h6"><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">283</div><div class="t m0 x1c hd y145 ff77 fs7 fc3 sc0 ls1 ws1">It c<span class="_ _3"></span>an compare two half<span class="_ _1"></span>-precision r<span class="_ _3"></span>egisters<span class="_ _3"></span>, two single-pr<span class="_ _1"></span>ecision </div><div class="t m0 xc hd y146 ff77 fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>, or tw<span class="_ _0"></span>o double-<span class="_ _1"></span>precision registers<span class="_ _1"></span>. It allows one immediate value<span class="_ _1"></span>, </div><div class="t m0 xc hd y147 ff77 fs7 fc3 sc0 ls1 ws1">namely, zer<span class="_ _3"></span>o<span class="_ _1"></span>, so it can compare half-, sin<span class="_ _3"></span>gle-, or double-<span class="_ _3"></span>precision r<span class="_ _1"></span>e<span class="_ _0"></span>gister </div><div class="t m0 xc hd y1b0 ff77 fs7 fc3 sc0 ls1 ws1">to zero<span class="_ _1"></span>. This is needed since there is no floatin<span class="_ _3"></span>g-poin<span class="_ _3"></span>t zero r<span class="_ _1"></span>egister<span class="_ _6"></span>.</div><div class="t m0 x1c hd y1b1 ff77 fs7 fc3 sc0 ls12 wsc9">The <span class="ff7e">FCMP</span><span class="ws1"> instruction updates the condition flags b<span class="_ _3"></span>ased on subtracting </span></div><div class="t m0 xc hd y218 ff77 fs7 fc3 sc0 ls1 ws1">the operands<span class="_ _3"></span>, like the <span class="ff7e">CMP</span> instruction we studied in Chapter <span class="fc5">4</span>, </div><div class="t m0 xc hd y219 ff77 fs7 fc3 sc0 ls1 ws1">“<span class="_ _3"></span>Contr<span class="_ _3"></span>olling Progr<span class="_ _1"></span>am Flow.<span class="_ _8"></span>”</div><div class="t m0 x1c hd y1b4 ff77 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>esting for equality of floating-<span class="_ _3"></span>point numbers is pr<span class="_ _1"></span>oblematic, because </div><div class="t m0 xc hd y1b5 ff77 fs7 fc3 sc0 ls1 ws1">roundin<span class="_ _3"></span>g error numbers ar<span class="_ _1"></span>e often close, but not exactly equal. The </div><div class="t m0 xc hd y1b6 ff77 fs7 fc3 sc0 ls1 ws1">solution is to decide on a tolerance, then consider n<span class="_ _3"></span>umbers equal if they </div><div class="t m0 xc hd y1b7 ff77 fs7 fc3 sc0 ls1 ws1">are within the tolerance fr<span class="_ _1"></span>om each other<span class="_ _6"></span>. For instance<span class="_ _3"></span>, we might define  </div><div class="t m0 xc hd y942 ff77 fs7 fc3 sc0 ls1 ws1">e = 0.000001 and then consider two registers equal if</div><div class="t m0 x22 hd y1166 ff77 fs7 fc3 sc0 ls1 ws1">abs(S1- S2) &lt; e</div><div class="t m0 x1c hd y94f ff77 fs7 fc3 sc0 ls1 ws1">where abs() is a function to c<span class="_ _3"></span>alculate the absolute value<span class="_ _1"></span>.</div><div class="t m0 xc ha y1167 ff7b fs6 fc3 sc0 ls1 wsb1"> Example</div><div class="t m0 xc hd yacd ff77 fs7 fc3 sc0 ls1 ws1">Crea<span class="_ _3"></span>te a routine to test if two floa<span class="_ _3"></span>ting-<span class="_ _3"></span>point numbers ar<span class="_ _1"></span>e equal using this </div><div class="t m0 xc hd y1168 ff77 fs7 fc3 sc0 ls1 ws1">technique. W<span class="_ _1"></span>e’ll first add 100 cen<span class="_ _3"></span>ts, then test if they exactly equal $1.00 </div><div class="t m0 xc hd y1169 ff77 fs7 fc3 sc0 ls1 ws1">(spoiler alert, they won’t). Then we’ll compar<span class="_ _3"></span>e the sum using our fpcomp </div><div class="t m0 xc hd y116a ff77 fs7 fc3 sc0 ls1 ws1">routine th<span class="_ _3"></span>at tests them within a supplied tolerance (usually r<span class="_ _1"></span>efer<span class="_ _0"></span>r<span class="_ _3"></span>ed to as </div><div class="t m0 xc hd y116b ff77 fs7 fc3 sc0 ls1 ws1">epsilon).</div><div class="t m0 x1c hd y116c ff77 fs7 fc3 sc0 ls1 ws1">Start with our floating-<span class="_ _1"></span>point comparison routine, placing the con<span class="_ _3"></span>tents </div><div class="t m0 xc hd y116d ff77 fs7 fc3 sc0 ls1 ws1">of Listing <span class="fc5">12-4</span> into fpcomp<span class="_ _1"></span>.s.</div><div class="t m0 xc h20 y116e ff7d fs3 fc3 sc0 ls1 ws1">Listing 12-4. <span class="_ _15"> </span><span class="ff77">Routine to compar<span class="_ _1"></span>e tw<span class="_ _0"></span>o floatin<span class="_ _3"></span>g-<span class="_ _3"></span>point numbers </span></div><div class="t m0 xc h20 y116f ff77 fs3 fc3 sc0 ls1 ws1">within a tolerance</div><div class="t m0 xc h18 y1170 ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y1171 ff80 fs7 fc3 sc0 ls1 ws1">// Function to compare to floating-point numbers</div><div class="t m0 xc h18 y1172 ff80 fs7 fc3 sc0 ls1 ws1">// the parameters are a pointer to the two numbers</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:341.833000px;bottom:497.175000px;width:5.500000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf128" data-dest-detail='[296,"XYZ",53,184,null]'><div class="d m1" style="border-style:none;position:absolute;left:99.451200px;bottom:197.362000px;width:20.547800px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf129" class="pf w2 h6" data-page-no="129"><div class="pc pc129 w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">284</div><div class="t m0 xd h18 y46b ff80 fs7 fc3 sc0 ls1 ws1">// and an error epsilon.</div><div class="t m0 xd h18 y46c ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y46d ff80 fs7 fc3 sc0 ls1 ws1">// Inputs:</div><div class="t m0 xd h18 y623 ff80 fs7 fc3 sc0 ls1 ws1">//    X0 - pointer to the 3 FP numbers</div><div class="t m0 xd h18 y624 ff80 fs7 fc3 sc0 ls1 ws1">//           they are x1, x2, e</div><div class="t m0 xd h18 yc46 ff80 fs7 fc3 sc0 ls1 ws1">// Outputs:</div><div class="t m0 xd h18 y626 ff80 fs7 fc3 sc0 ls1 ws1">//    X0 - 1 if they are equal, else 0</div><div class="t m0 xd h18 y984 ff80 fs7 fc3 sc0 ls1 ws1">.global fpcomp // Allow function to be called by others</div><div class="t m0 xd h18 y473 ff80 fs7 fc3 sc0 ls1 ws1">fpcomp:      // load the 3 numbers</div><div class="t m0 xd h18 y849 ff80 fs7 fc3 sc0 ls1 ws1">      LDP    S0, S1, [X0], #8</div><div class="t m0 xd h18 y84a ff80 fs7 fc3 sc0 ls1 ws1">      LDR    S2, [X0]</div><div class="t m0 xd h18 y476 ff80 fs7 fc3 sc0 ls1 ws1">      // calc s3 = x2 - x1</div><div class="t m0 xd h18 ye1c ff80 fs7 fc3 sc0 ls1 ws1">      FSUB   S3, S1, S0</div><div class="t m0 xd h18 y62d ff80 fs7 fc3 sc0 ls1 ws1">      FABS   S3, S3</div><div class="t m0 xd h18 y84d ff80 fs7 fc3 sc0 ls1 ws1">      FCMP   S3, S2</div><div class="t m0 xd h18 y1173 ff80 fs7 fc3 sc0 ls1 ws1">      B.LE          notequal</div><div class="t m0 xd h18 y1174 ff80 fs7 fc3 sc0 ls1 ws1">      MOV           X0, #1</div><div class="t m0 xd h18 y1175 ff80 fs7 fc3 sc0 ls1 ws1">      B             done</div><div class="t m0 xd h18 y1176 ff80 fs7 fc3 sc0 ls1 ws1">notequal:MOV        X0, #0</div><div class="t m0 xd h18 y1177 ff80 fs7 fc3 sc0 ls1 ws1">done: RET</div><div class="t m0 xc hd y1178 ff77 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w the main progr<span class="_ _1"></span>am maincomp<span class="_ _3"></span>.s contains Listing <span class="fc5">12-5</span>.</div><div class="t m0 xd h20 y10e6 ff7d fs3 fc3 sc0 ls32 ws1">Listing 12-5. <span class="_ _15"> </span><span class="ff77">Main pr<span class="_ _1"></span>ogram to add up 100 cents and compar<span class="_ _3"></span>e to $1.00</span></div><div class="t m0 xd h18 y1179 ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y117a ff80 fs7 fc3 sc0 ls1 ws1">// Main program to test our distance function</div><div class="t m0 xd h18 y117b ff80 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y117c ff80 fs7 fc3 sc0 ls1 ws1">// W19 - loop counter</div><div class="t m0 xd h18 y117d ff80 fs7 fc3 sc0 ls1 ws1">// X20 - address to current set of points</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf129" data-dest-detail='[297,"XYZ",35,195,null]'><div class="d m1" style="border-style:none;position:absolute;left:301.871000px;bottom:209.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf12a" class="pf w2 h6" data-page-no="12a"><div class="pc pc12a w2 h6"><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">285</div><div class="t m0 xc h18 y46b ff80 fs7 fc3 sc0 ls1 ws1">.global main // Provide program starting address</div><div class="t m0 xc h18 ye19 ff80 fs7 fc3 sc0 ls1 ws1">      .equ   N, 100        // Number of additions.</div><div class="t m0 xc h18 y111c ff80 fs7 fc3 sc0 ls1 ws1">main:</div><div class="t m0 xc h18 ye1b ff80 fs7 fc3 sc0 ls1 ws1">      STP    X19, X20, [SP, #-16]!</div><div class="t m0 xc h18 y111d ff80 fs7 fc3 sc0 ls1 ws1">      STR    LR, [SP, #-16]!</div><div class="t m0 xc h18 y111e ff80 fs7 fc3 sc0 ls1 ws1">// Add up one hundred cents and test if they equal $1.00</div><div class="t m0 xc h18 y111f ff80 fs7 fc3 sc0 ls1 ws1">      MOV    W19, #N       // number of loop iterations</div><div class="t m0 xc h18 y1120 ff80 fs7 fc3 sc0 ls1 ws1">// load cents, running sum and real sum to FPU</div><div class="t m0 xc h18 y117e ff80 fs7 fc3 sc0 ls1 ws1">      LDR    X0, =cent</div><div class="t m0 xc h18 y117f ff80 fs7 fc3 sc0 ls1 ws1">      LDP    S0, S1, [X0], #8</div><div class="t m0 xc h18 yaef ff80 fs7 fc3 sc0 ls1 ws1">      LDR    S2, [X0]</div><div class="t m0 xc h18 y1180 ff80 fs7 fc3 sc0 ls1 ws1">loop:</div><div class="t m0 xc h18 y1181 ff80 fs7 fc3 sc0 ls1 ws1">      // add cent to running sum</div><div class="t m0 xc h18 yaf0 ff80 fs7 fc3 sc0 ls1 ws1">      FADD   S1, S1, S0</div><div class="t m0 xc h18 yb6d ff80 fs7 fc3 sc0 ls1 ws1">      SUBS   W19, W19, #1  // decrement loop counter</div><div class="t m0 xc h18 yb6e ff80 fs7 fc3 sc0 ls1 ws1">      B.NE   loop          // loop if more points</div><div class="t m0 xc h18 y1182 ff80 fs7 fc3 sc0 ls1 ws1">      // compare running sum to real sum</div><div class="t m0 xc h18 y1183 ff80 fs7 fc3 sc0 ls1 ws1">      FCMP   S1, S2</div><div class="t m0 xc h18 yb71 ff80 fs7 fc3 sc0 ls1 ws1">      // print if the numbers are equal or not</div><div class="t m0 xc h18 yb72 ff80 fs7 fc3 sc0 ls1 ws1">      B.EQ   equal</div><div class="t m0 xc h18 y1184 ff80 fs7 fc3 sc0 ls1 ws1">      LDR    X0, =notequalstr</div><div class="t m0 xc h18 y1185 ff80 fs7 fc3 sc0 ls1 ws1">      BL     printf</div><div class="t m0 xc h18 yf55 ff80 fs7 fc3 sc0 ls1 ws1">      B      next</div><div class="t m0 xc h18 y1186 ff80 fs7 fc3 sc0 ls1 ws1">equal:  LDR  X0, =equalstr</div><div class="t m0 xc h18 y869 ff80 fs7 fc3 sc0 ls1 ws1">      BL     printf</div><div class="t m0 xc h18 y1187 ff80 fs7 fc3 sc0 ls1 ws1">next:</div><div class="t m0 xc h18 y1188 ff80 fs7 fc3 sc0 ls1 ws1">// load pointer to running sum, real sum and epsilon</div><div class="t m0 xc h18 y1189 ff80 fs7 fc3 sc0 ls1 ws1">      LDR    X0, =runsum</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf12b" class="pf w2 h6" data-page-no="12b"><div class="pc pc12b w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">286</div><div class="t m0 xd h18 y46b ff80 fs7 fc3 sc0 ls1 ws1">// call comparison function</div><div class="t m0 xd h18 y46c ff80 fs7 fc3 sc0 ls1 ws1">      BL     fpcomp        // call comparison function</div><div class="t m0 xd h18 y46d ff80 fs7 fc3 sc0 ls1 ws1">// compare return code to 1 and print if the numbers</div><div class="t m0 xd h18 y623 ff80 fs7 fc3 sc0 ls1 ws1">// are equal or not (within epsilon).</div><div class="t m0 xd h18 y624 ff80 fs7 fc3 sc0 ls1 ws1">      CMP    X0, #1</div><div class="t m0 xd h18 yc46 ff80 fs7 fc3 sc0 ls1 ws1">      B.EQ   equal2</div><div class="t m0 xd h18 y626 ff80 fs7 fc3 sc0 ls1 ws1">      LDR    X0, =notequalstr</div><div class="t m0 xd h18 y627 ff80 fs7 fc3 sc0 ls1 ws1">      BL     printf</div><div class="t m0 xd h18 yc47 ff80 fs7 fc3 sc0 ls1 ws1">      B      done</div><div class="t m0 xd h18 yd61 ff80 fs7 fc3 sc0 ls1 ws1">equal2: LDR  X0, =equalstr</div><div class="t m0 xd h18 yd62 ff80 fs7 fc3 sc0 ls1 ws1">      BL     printf</div><div class="t m0 xd h18 y62b ff80 fs7 fc3 sc0 ls1 ws1">done: MOV    X0, #0        // return code</div><div class="t m0 xd h18 y9f9 ff80 fs7 fc3 sc0 ls1 ws1">      LDR    LR, [SP], #16</div><div class="t m0 xd h18 yc53 ff80 fs7 fc3 sc0 ls1 ws1">      LDP    X19, X20, [SP], #16</div><div class="t m0 xd h18 yc54 ff80 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 xd h18 yc3f ff80 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 yc40 ff80 fs7 fc3 sc0 ls1 ws1">cent:        .single 0.01</div><div class="t m0 xd h18 yd66 ff80 fs7 fc3 sc0 ls1 ws1">runsum:      .single 0.0</div><div class="t m0 xd h18 yd67 ff80 fs7 fc3 sc0 ls1 ws1">sum:         .single 1.00</div><div class="t m0 xd h18 y118a ff80 fs7 fc3 sc0 ls1 ws1">epsilon:     .single 0.00001</div><div class="t m0 xd h18 y118b ff80 fs7 fc3 sc0 ls1 ws1">equalstr:    .asciz &quot;equal\n&quot;</div><div class="t m0 xd h18 y118c ff80 fs7 fc3 sc0 ls1 ws1">notequalstr: .asciz &quot;not equal\n&quot;</div><div class="t m0 xc hd y118d ff77 fs7 fc3 sc0 ls1 ws1">The makefile<span class="_ _1"></span>, in L<span class="_ _0"></span>isting <span class="fc5">12-6</span>, is as we would expect.</div><div class="t m0 xd h20 y118e ff7d fs3 fc3 sc0 ls33 ws1">Listing 12-6. <span class="_ _15"> </span><span class="ff77">The makefile for the floa<span class="_ _3"></span>ting-<span class="_ _1"></span>p<span class="_ _0"></span>oint com<span class="_ _3"></span>parison </span></div><div class="t m0 xd h20 y118f ff77 fs3 fc3 sc0 ls33 wsd7">example</div><div class="t m0 xd h18 y1190 ff80 fs7 fc3 sc0 ls1 ws1">fpcomp: fpcomp.s maincomp.s</div><div class="t m0 xd h18 y1191 ff80 fs7 fc3 sc0 ls1 ws1">      gcc -o fpcomp fpcomp.s maincomp.s</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf12b" data-dest-detail='[299,"XYZ",35,187,null]'><div class="d m1" style="border-style:none;position:absolute;left:165.340000px;bottom:201.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf12c" class="pf w2 h6" data-page-no="12c"><div class="pc pc12c w2 h6"><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">287</div><div class="t m0 x1c hd y145 ff77 fs7 fc3 sc0 ls1 ws1">If we build and run the program<span class="_ _3"></span>, we get</div><div class="t m0 xc h18 y2e0 ff80 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 12$ make</div><div class="t m0 xc h18 y2e1 ff80 fs7 fc3 sc0 ls1 ws1">gcc -g -o fpcomp fpcomp.s maincomp.s</div><div class="t m0 xc h18 y2d7 ff80 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 12$ ./fpcomp</div><div class="t m0 xc h18 y2e2 ff80 fs7 fc3 sc0 ls1 ws1">not equal</div><div class="t m0 xc h18 y60e ff80 fs7 fc3 sc0 ls1 ws1">equal</div><div class="t m0 xc h18 y230 ff80 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 12$</div><div class="t m0 x1c hd y231 ff77 fs7 fc3 sc0 ls1 ws1">If we run the program under <span class="ff7e">gdb</span>, we can examine the sum of 100 </div><div class="t m0 xc hd y2e3 ff77 fs7 fc3 sc0 ls1 ws1">cents<span class="_ _3"></span>. W<span class="_ _1"></span>e see</div><div class="t m0 xc h18 yd97 ff80 fs7 fc3 sc0 ls2e ws1">s0  {f = 0x0, u = 0x3c23d70a, s = 0x3c23d70a} {f = 0.00999999978,<span class="_ _0"></span> </div><div class="t m0 xc h18 yd98 ff80 fs7 fc3 sc0 ls2e ws1">u = 1008981770, s = 1008981770}</div><div class="t m0 xc h18 yd9d ff80 fs7 fc3 sc0 ls1 ws1">s1  {f = 0x0, u = 0x3f7ffff5, s = 0x3f7ffff5} {f = 0.999999344, </div><div class="t m0 xc h18 yd9e ff80 fs7 fc3 sc0 ls1 ws1">u = 1065353205, s = 1065353205}</div><div class="t m0 xc h18 y1192 ff80 fs7 fc3 sc0 ls1 ws1">s2  {f = 0x1, u = 0x3f800000, s = 0x3f800000} {f = 1,  </div><div class="t m0 xc h18 y1193 ff80 fs7 fc3 sc0 ls1 ws1">u = 1065353216, s = 1065353216}</div><div class="t m0 x1c hd y552 ff7e fs7 fc3 sc0 ls1 ws1">S0<span class="ff77"> contains a cent, $0.01, and we see fr<span class="_ _3"></span>om gdb that this hasn’t been </span></div><div class="t m0 xc hd y1194 ff77 fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esented exactly and this is wher<span class="_ _3"></span>e rounding err<span class="_ _3"></span>or will come in. The sum </div><div class="t m0 xc hd yb35 ff77 fs7 fc3 sc0 ls1 ws1">of 100 cents ends up being in r<span class="_ _3"></span>egister <span class="ff7e">S1</span> as 0.999999344, which doesn’t </div><div class="t m0 xc hd yf11 ff77 fs7 fc3 sc0 ls1 ws1">equal our expected sum of 1 contained in register <span class="ff7e">S2</span>.</div><div class="t m0 x1c hd y1195 ff77 fs7 fc3 sc0 ls1 ws1">Then we call our fpcomp r<span class="_ _3"></span>outine that determines if the num<span class="_ _3"></span>bers are </div><div class="t m0 xc hd yc6e ff77 fs7 fc3 sc0 ls1 ws1">within the provided toler<span class="_ _1"></span>ance and hence considers them equal.</div><div class="t m0 x1c hd yc6f ff77 fs7 fc3 sc0 ls1 ws1">It didn’t tak<span class="_ _3"></span>e that man<span class="_ _3"></span>y additions to start introducing r<span class="_ _1"></span>ounding errors </div><div class="t m0 xc hd yc70 ff77 fs7 fc3 sc0 ls1 ws1">into our sums<span class="_ _1"></span>. B<span class="_ _0"></span>e car<span class="_ _1"></span>eful when using floating point for this reason.</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf12d" class="pf w2 h6" data-page-no="12d"><div class="pc pc12d w2 h6"><div class="t m0 xd hd y3f ff77 fs7 fc3 sc0 ls1 ws1">288</div><div class="t m0 xd h15 y186 ff7b fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y187 ff77 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we learned the following:</div><div class="t m0 xa hd y1196 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>What floatin<span class="_ _3"></span>g-<span class="_ _3"></span>point numbers ar<span class="_ _3"></span>e and how they ar<span class="_ _3"></span>e </div><div class="t m0 x1e hd y1197 ff77 fs7 fc3 sc0 ls1 ws1">repr<span class="_ _3"></span>esented</div><div class="t m0 xa hd y1198 ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Normaliza<span class="_ _3"></span>tion, N<span class="_ _3"></span>aNs<span class="_ _1"></span>, and rounding error</div><div class="t m0 xa hd y1199 ff77 fs7 fc3 sc0 ls34 wsd8">• <span class="_ _c"> </span><span class="ws1">How to crea<span class="_ _3"></span>te floating-<span class="_ _1"></span>point numbers in our .<span class="ff7e ls19 wsbc">data</span> section</span></div><div class="t m0 xa hd y119a ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Discussed the bank of floating-<span class="_ _3"></span>point r<span class="_ _3"></span>egisters and </div><div class="t m0 x1e hd y119b ff77 fs7 fc3 sc0 ls1 ws1">how half<span class="_ _3"></span>-, single-, and double-<span class="_ _1"></span>precision values are </div><div class="t m0 x1e hd y895 ff77 fs7 fc3 sc0 ls1 ws1">contained in them</div><div class="t m0 xa hd y119c ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>How to load da<span class="_ _3"></span>ta into the floatin<span class="_ _3"></span>g-<span class="_ _3"></span>point registers and </div><div class="t m0 x1e hd y119d ff77 fs7 fc3 sc0 ls1 ws1">how to perform mathematic<span class="_ _3"></span>al operations and sa<span class="_ _1"></span>ve </div><div class="t m0 x1e hd y119e ff77 fs7 fc3 sc0 ls1 ws1">them back to memory</div><div class="t m0 xa hd y119f ff77 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>How to con<span class="_ _1"></span>ver<span class="_ _0"></span>t between differen<span class="_ _3"></span>t floating-<span class="_ _1"></span>point types, </div><div class="t m0 x1e hd y11a0 ff77 fs7 fc3 sc0 ls1 ws1">compare floa<span class="_ _3"></span>ting-<span class="_ _1"></span>p<span class="_ _0"></span>oint n<span class="_ _3"></span>umbers<span class="_ _3"></span>, and copy the r<span class="_ _3"></span>esult </div><div class="t m0 x1e hd y11a1 ff77 fs7 fc3 sc0 ls1 ws1">back to the ARM CPU<span class="_ _1"></span>, and the effect rounding err<span class="_ _3"></span>ors </div><div class="t m0 x1e hd y11a2 ff77 fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve on these comparisons</div><div class="t m0 xc hd y11a3 ff77 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">13</span>, “N<span class="_ _1"></span>eon Coprocessor<span class="_ _6"></span>,<span class="_ _8"></span>” we’ll look at how to perform </div><div class="t m0 xd hd y11a4 ff77 fs7 fc3 sc0 ls1 ws1">multiple floating-<span class="_ _1"></span>point operations in parallel.</div><div class="t m0 xd h15 y11a5 ff7b fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y11a6 ff77 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Create a pr<span class="_ _1"></span>ogram to load and add the following </div><div class="t m0 x1e hd y11a7 ff77 fs7 fc3 sc0 ls1 ws1">numbers:</div><div class="t m0 x1e hd y11a8 ff77 fs7 fc3 sc0 ls1 ws1">2.343 + 5.3</div><div class="t m0 x1e hd y11a9 ff77 fs7 fc3 sc0 ls1 ws1">3.5343425445 + 1.534443455</div><div class="t m0 x1e hd y11aa ff77 fs7 fc3 sc0 ls1 ws1">3.14e12 + 5.55e-10</div><div class="t m0 x1e hd y11ab ff77 fs7 fc3 sc0 ls1 ws1">How accur<span class="_ _1"></span>ate are the results?</div><div class="t m0 xd h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:265.090000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf12e" class="pf w2 h6" data-page-no="12e"><div class="pc pc12e w2 h6"><div class="t m0 x17 hd y3f ff77 fs7 fc3 sc0 ls1 ws1">289</div><div class="t m0 x1c hd y145 ff77 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Integer division by 0 r<span class="_ _1"></span>esulted in the incor<span class="_ _0"></span>r<span class="_ _3"></span>ect answer </div><div class="t m0 x9 hd y146 ff77 fs7 fc3 sc0 ls1 ws1">of 0. Crea<span class="_ _3"></span>te a progr<span class="_ _3"></span>am to perform a floating-poin<span class="_ _3"></span>t </div><div class="t m0 x9 hd y147 ff77 fs7 fc3 sc0 ls1 ws1">division by 0 and see what the r<span class="_ _1"></span>esult is.</div><div class="t m0 x1c hd y148 ff77 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>The ARM FPU has a square r<span class="_ _3"></span>oot function, but </div><div class="t m0 x9 hd y149 ff77 fs7 fc3 sc0 ls1 ws1">no trigonometric functions. Write a function to </div><div class="t m0 x9 hd y14a ff77 fs7 fc3 sc0 ls1 ws1">calculate the sine of an angle in r<span class="_ _1"></span>adians using the </div><div class="t m0 x9 hd y1cb ff77 fs7 fc3 sc0 ls1 ws1">appro<span class="_ _3"></span>ximate formula<span class="_ _0"></span>:</div><div class="t m0 x6c hd y58d ff77 fs7 fc3 sc0 ls1 ws1">sin x = x <span class="ff7f">−</span> x</div><div class="t m0 x62 h1b y11ac ff77 fsd fc3 sc0 ls1 ws1">3</div><div class="t m0 x6d hd y11ad ff77 fs7 fc3 sc0 ls1 ws1">/3! + x</div><div class="t m0 x38 h1b y11ac ff77 fsd fc3 sc0 ls1 ws1">5</div><div class="t m0 x30 hd y11ad ff77 fs7 fc3 sc0 ls1 ws1">/5! <span class="ff7f">−</span> x</div><div class="t m0 x69 h1b y11ac ff77 fsd fc3 sc0 ls1 ws1">7</div><div class="t m0 x40 hd y11ad ff77 fs7 fc3 sc0 ls1 ws1">/7!</div><div class="t m0 x9 hd y704 ff77 fs7 fc3 sc0 ls1 ws1">where ! stands for factorial and is calcula<span class="_ _3"></span>ted as  </div><div class="t m0 x9 h18 y11ae ff77 fs7 fc3 sc0 ls1 ws1">3! = 3 <span class="ff80">*</span> 2 <span class="ff80">*</span>1. Write a main progr<span class="_ _3"></span>am to call this </div><div class="t m0 x9 hd y11af ff77 fs7 fc3 sc0 ls1 ws1">function with several test values<span class="_ _3"></span>.</div><div class="t m0 x30 h12 y71 ff7c fsa fc3 sc0 ls1 ws1">CHAPTER 12 <span class="_ _f"> </span> FLOA<span class="_ _1"></span>TING-POINT OPERA<span class="_ _1"></span>TIONS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf12f" class="pf w2 h6" data-page-no="12f"><div class="pc pc12f w2 h6"><div class="t m0 x17 hd y16a ff82 fs7 fc7 sc0 ls1 ws1">291</div><div class="t m0 xc h17 y16b ff82 fsc fc7 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff82 fsc fc7 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff83">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff82">,  </span></span></div><div class="t m0 xc h17 y16d ff82 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_13</div><div class="t m0 xc ha y16e ff84 fs6 fc7 sc0 ls1 ws1">CHAPTER 13</div><div class="t m0 xc h8 y16f ff85 fs4 fc7 sc0 ls1 ws1">Neon Copr<span class="_ _3"></span>ocessor</div><div class="t m0 xc hd y170 ff82 fs7 fc7 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we will per<span class="_ _0"></span>form true parallel computing<span class="_ _3"></span>. The N<span class="_ _3"></span>eon </div><div class="t m0 xc hd y171 ff82 fs7 fc7 sc0 ls1 ws1">coprocessor shar<span class="_ _1"></span>es a lot of functionality with the FP<span class="_ _0"></span>U fr<span class="_ _3"></span>om Chapter <span class="fc5">12</span>, </div><div class="t m0 xc hd y172 ff82 fs7 fc7 sc0 ls1 ws1">“Floating-P<span class="_ _3"></span>oint Opera<span class="_ _3"></span>tions,<span class="_ _66"></span>” but can perform several operations at once<span class="_ _1"></span>. </div><div class="t m0 xc hd y173 ff82 fs7 fc7 sc0 ls1 ws1">For exam<span class="_ _3"></span>ple, yo<span class="_ _3"></span>u can achieve four 32-bit floatin<span class="_ _3"></span>g-poin<span class="_ _3"></span>t operations a<span class="_ _3"></span>t once </div><div class="t m0 xc hd y174 ff82 fs7 fc7 sc0 ls1 ws1">with one instruction. The type of parallel processing performed by the </div><div class="t m0 xc hd y175 ff82 fs7 fc7 sc0 ls1 ws1">Neon Copr<span class="_ _3"></span>ocessor is single instruction multiple data (<span class="ff86">SIMD</span>). I<span class="_ _3"></span>n SIMD </div><div class="t m0 xc hd y176 ff82 fs7 fc7 sc0 ls1 ws1">processing<span class="_ _3"></span>, each single instruction issued executes on multiple data items </div><div class="t m0 xc hd y177 ff82 fs7 fc7 sc0 ls1 ws1">in parallel.</div><div class="t m0 x1c hd y178 ff82 fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll examine how to arrange data<span class="_ _1"></span>, s<span class="_ _0"></span>o we can oper<span class="_ _3"></span>ate on it in parallel, </div><div class="t m0 xc hd y179 ff82 fs7 fc7 sc0 ls1 ws1">and study the instructions that do so<span class="_ _1"></span>. W<span class="_ _1"></span>e’ll then update our vector distance </div><div class="t m0 xc hd y17a ff82 fs7 fc7 sc0 ls1 ws1">and 3x3 matrix multiplica<span class="_ _3"></span>tion progr<span class="_ _3"></span>ams to use the Neon pr<span class="_ _3"></span>ocessor to see </div><div class="t m0 xc hd y17b ff82 fs7 fc7 sc0 ls1 ws1">how much of the work we can do in par<span class="_ _1"></span>allel.</div><div class="t m0 x1c hd y17c ff82 fs7 fc7 sc0 ls1 ws1">The Neon Copr<span class="_ _1"></span>ocessor shares the same register file we examined in </div><div class="t m0 xc hd y17d ff82 fs7 fc7 sc0 ls1 ws1">Chapter <span class="fc5">12</span>, “Floa<span class="_ _3"></span>ting-Poin<span class="_ _3"></span>t Operations<span class="_ _1"></span>,<span class="_ _10"></span>” except th<span class="_ _3"></span>at it can opera<span class="_ _3"></span>te on all </div><div class="t m0 xc hd y17e ff82 fs7 fc7 sc0 ls1 ws1">128 bits of each register<span class="_ _10"></span>. W<span class="_ _3"></span>e’ll learn ho<span class="_ _3"></span>w the bank of coprocessor r<span class="_ _3"></span>egisters </div><div class="t m0 xc hd y17f ff82 fs7 fc7 sc0 ls1 ws1">is intended to be used with Neon. Let’<span class="_ _1"></span>s look in more detail at the NEON </div><div class="t m0 xc hd y180 ff82 fs7 fc7 sc0 ls1 ws1">registers<span class="_ _1"></span>.</div><div class="t m0 xc h15 y11b0 ff87 fsb fc7 sc0 ls1 ws1"> <span class="_ _e"></span>About theNEON Registers</div><div class="t m0 xc hd y11b1 ff82 fs7 fc7 sc0 ls1 ws1">The NEON Coprocessor can oper<span class="_ _3"></span>ate on the 64-bit r<span class="_ _3"></span>egisters that we studied </div><div class="t m0 xc hd y11b2 ff82 fs7 fc7 sc0 ls1 ws1">in the previous ch<span class="_ _3"></span>apter and a set of 128-bit registers th<span class="_ _3"></span>at ar<span class="_ _3"></span>e new for </div><div class="t m0 xc hd y11b3 ff82 fs7 fc7 sc0 ls1 ws1">this chapter<span class="_ _10"></span>. Ha<span class="_ _3"></span>ving 128-bit registers doesn’t mean the NEON pr<span class="_ _1"></span>ocess<span class="_ _0"></span>or </div><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:168.835000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:369.321000px;bottom:441.802000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:94.259700px;bottom:249.802000px;width:11.000300px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf130" class="pf w2 h6" data-page-no="130"><div class="pc pc130 w2 h6"><img class="bi xd y11b4 we h55" alt="" src="bg130.png"/><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">292</div><div class="t m0 xd hd y145 ff82 fs7 fc7 sc0 ls1 ws1">performs 128-bit ar<span class="_ _0"></span>ithmetic. Ra<span class="_ _3"></span>ther<span class="_ _6"></span>, the Neon Copr<span class="_ _1"></span>ocessor s<span class="_ _0"></span>egments the </div><div class="t m0 xd hd y146 ff82 fs7 fc7 sc0 ls1 ws1">large register in<span class="_ _3"></span>to holding multiple smaller v<span class="_ _3"></span>alues at once<span class="_ _3"></span>. For ins<span class="_ _3"></span>tance, </div><div class="t m0 xd hd y147 ff82 fs7 fc7 sc0 ls1 ws1">one 128-bit register can fit fo<span class="_ _3"></span>ur 32-bit single-<span class="_ _3"></span>precision floa<span class="_ _3"></span>ting-<span class="_ _3"></span>point </div><div class="t m0 xd hd y1b0 ff82 fs7 fc7 sc0 ls1 ws1">numbers<span class="_ _3"></span>. If we multiply two such register<span class="_ _3"></span>s, all four 32-bit n<span class="_ _3"></span>umbers are </div><div class="t m0 xd hd y1b1 ff82 fs7 fc7 sc0 ls1 ws1">multiplied together at the same time r<span class="_ _3"></span>esulting in another 128-bit r<span class="_ _3"></span>egister </div><div class="t m0 xd hd y218 ff82 fs7 fc7 sc0 ls1 ws1">containing the four r<span class="_ _3"></span>esults<span class="_ _3"></span>.</div><div class="t m0 xc hd y219 ff82 fs7 fc7 sc0 ls1 ws1">The Neon Copr<span class="_ _1"></span>ocessor op<span class="_ _0"></span>er<span class="_ _3"></span>ates on both integers and floatin<span class="_ _3"></span>g-poin<span class="_ _3"></span>t </div><div class="t m0 xd hd y1b4 ff82 fs7 fc7 sc0 ls1 ws1">numbers<span class="_ _3"></span>. The gre<span class="_ _3"></span>atest parallelism is obtained usin<span class="_ _3"></span>g 8-bit integers where </div><div class="t m0 xd hd y1b5 ff82 fs7 fc7 sc0 ls1 ws1">16 operations can h<span class="_ _3"></span>appen at once<span class="_ _3"></span>.</div><div class="t m0 xc hd y1b6 ff82 fs7 fc7 sc0 ls1 ws1">The Neon copr<span class="_ _1"></span>ocess<span class="_ _0"></span>or can oper<span class="_ _3"></span>ate on 64-bit <span class="ff86">D</span> or 128-bit <span class="ff86">V</span> r<span class="_ _3"></span>egisters<span class="_ _0"></span>; </div><div class="t m0 xd hd y1b7 ff82 fs7 fc7 sc0 ls1 ws1">of course, if yo<span class="_ _3"></span>u use 64-bit <span class="ff86">D</span> registers<span class="_ _3"></span>, you only ha<span class="_ _1"></span>ve half the amount of </div><div class="t m0 xd hd y942 ff82 fs7 fc7 sc0 ls1 ws1">parallelism<span class="_ _3"></span>. In all instructions, we r<span class="_ _1"></span>efer to the <span class="ff86">V</span> register<span class="_ _6"></span>, but the number </div><div class="t m0 xd hd y943 ff82 fs7 fc7 sc0 ls1 ws1">of elements multiplied by the s<span class="_ _3"></span>ize of the element must alwa<span class="_ _1"></span>ys be either 64 </div><div class="t m0 xd hd y944 ff82 fs7 fc7 sc0 ls1 ws1">bits or 128 bits.</div><div class="t m0 xc hd y945 ff82 fs7 fc7 sc0 ls1 ws1">T<span class="_ _6"></span>able <span class="fc5">13-1</span> shows the num<span class="_ _3"></span>ber of elements that fit in each r<span class="_ _1"></span>egister type. </div><div class="t m0 xd hd ya1e ff82 fs7 fc7 sc0 ls1 ws1">Next<span class="_ _3"></span>, we’ll see how we perform arithmetic on these elements.</div><div class="t m0 xd h26 y11b5 ff88 fs3 fc7 sc0 ls1 ws1">T<span class="_ _1"></span>able 13-1. <span class="_ _15"> </span><span class="ff83">N<span class="_ _1"></span>umb<span class="_ _0"></span>er of elements in each r<span class="_ _3"></span>egister type b<span class="_ _0"></span>y size</span></div><div class="t m0 x5d h10 y11b6 ff87 fs7 fc7 sc0 ls1 ws1">8-Bit Elements<span class="_ _6f"> </span>16-Bit Elements<span class="_ _6f"> </span>32-Bit Elements</div><div class="t m0 xd h10 y11b7 ff89 fs7 fc7 sc0 ls1 ws1">64 bits<span class="_ _5a"> </span>8<span class="_ _7c"> </span>4<span class="_ _7d"> </span>2</div><div class="t m0 xd h10 y11b8 ff89 fs7 fc7 sc0 ls1 ws1">128 bits<span class="_ _6f"> </span>16<span class="_ _7e"> </span>8<span class="_ _7d"> </span>4</div><div class="t m0 xd h15 y11b9 ff87 fsb fc7 sc0 ls1 ws1"> <span class="_ _e"></span>Stay inY<span class="_ _8"></span>our Lane</div><div class="t m0 xd hd y11ba ff82 fs7 fc7 sc0 ls1 ws1">The NEON coprocessor uses the concept of lanes for all of its </div><div class="t m0 xd hd y11bb ff82 fs7 fc7 sc0 ls1 ws1">computations<span class="_ _1"></span>. When you choose your data type, the pr<span class="_ _3"></span>ocessor considers </div><div class="t m0 xd hd y11bc ff82 fs7 fc7 sc0 ls1 ws1">the register divided into the n<span class="_ _3"></span>umber of lanes—one lane for each da<span class="_ _3"></span>ta </div><div class="t m0 xd hd y11bd ff82 fs7 fc7 sc0 ls1 ws1">element. If we work on 32-bit int<span class="_ _3"></span>egers and use a 128-bit <span class="ff86">V</span> register<span class="_ _10"></span>, then </div><div class="t m0 xd hd y11be ff82 fs7 fc7 sc0 ls1 ws1">the register is consider<span class="_ _1"></span>e<span class="_ _0"></span>d divided into fo<span class="_ _3"></span>ur lanes, one for each in<span class="_ _3"></span>teger<span class="_ _6"></span>. W<span class="_ _1"></span>e </div><div class="t m0 xd hd y11bf ff82 fs7 fc7 sc0 ls1 ws1">designate the lane confi<span class="_ _3"></span>guration b<span class="_ _1"></span>y spe<span class="_ _0"></span>cifying the n<span class="_ _3"></span>umber of lanes and </div><div class="t m0 xd hd y11c0 ff82 fs7 fc7 sc0 ls1 ws1">the size of the data contained ther<span class="_ _1"></span>e. Even though these lane design<span class="_ _3"></span>ators </div><div class="t m0 xd h12 y668 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf130" data-dest-detail='[304,"XYZ",35,325,null]'><div class="d m1" style="border-style:none;position:absolute;left:81.730600px;bottom:353.362000px;width:20.548400px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf131" class="pf w2 h6" data-page-no="131"><div class="pc pc131 w2 h6"><img class="bi x2e y11c1 w6 h56" alt="" src="bg131.png"/><div class="t m0 x17 hd y3f ff82 fs7 fc7 sc0 ls1 ws1">293</div><div class="t m0 xc hd y145 ff82 fs7 fc7 sc0 ls1 ws1">appear to match floa<span class="_ _3"></span>ting-<span class="_ _1"></span>p<span class="_ _0"></span>oint r<span class="_ _1"></span>egisters, they only specify the size. The </div><div class="t m0 xc hd y146 ff82 fs7 fc7 sc0 ls1 ws1">data could be either integer or floatin<span class="_ _3"></span>g point. The size m<span class="_ _3"></span>ultiplied by the </div><div class="t m0 xc hd y147 ff82 fs7 fc7 sc0 ls1 ws1">number of lanes must be either 64 or 128 bits<span class="_ _1"></span>. T<span class="_ _6"></span>able<span class="fc5">13-2</span> shows the lane </div><div class="t m0 xc hd y1b0 ff82 fs7 fc7 sc0 ls1 ws1">designators we use and their sizes<span class="_ _1"></span>.</div><div class="t m0 xb h26 y11c2 ff88 fs3 fc7 sc0 ls1 ws1">T<span class="_ _1"></span>able 13-2. <span class="_ _15"> </span><span class="ff83">Designator and size for lanes</span></div><div class="t m0 xb h10 y11c3 ff87 fs7 fc7 sc0 ls1 ws1">Designator<span class="_ _7f"> </span>Size</div><div class="t m0 xb h10 y11c4 ff89 fs7 fc7 sc0 ls1 ws1">D<span class="_ _80"> </span>64 bits</div><div class="t m0 xb h10 y11c5 ff89 fs7 fc7 sc0 ls1 ws1">S<span class="_ _81"> </span>32 bits</div><div class="t m0 xb h10 y11c6 ff89 fs7 fc7 sc0 ls1 ws1">H<span class="_ _80"> </span>16 bits</div><div class="t m0 xb h10 y11c7 ff89 fs7 fc7 sc0 ls1 ws1">B<span class="_ _81"> </span>8 bits</div><div class="t m0 x1c hd y11c8 ff82 fs7 fc7 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">13-1</span> shows ho<span class="_ _3"></span>w register <span class="ff86">V1</span> c<span class="_ _3"></span>an be divided into lanes of various </div><div class="t m0 xc hd y11c9 ff82 fs7 fc7 sc0 ls1 ws1">sizes and how we specify them as arguments to instructions<span class="_ _1"></span>.</div><div class="t m0 xc h26 y11ca ff88 fs3 fc7 sc0 ls1 ws1">Figure 13-1. <span class="_ _15"> </span><span class="ff83">Ho<span class="_ _3"></span>w register V1 can be divided into lanes<span class="_ _3"></span>.  </span></div><div class="t m0 xc h26 y11cb ff83 fs3 fc7 sc0 ls1 ws1">These lanes just specif<span class="_ _0"></span>y the size and number of lanes<span class="_ _3"></span>, not the  </div><div class="t m0 xc h26 y11cc ff83 fs3 fc7 sc0 ls1 ws1">data type c<span class="_ _0"></span>on<span class="_ _3"></span>tained in them</div><div class="t m0 x1c hd y11cd ff82 fs7 fc7 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">13-2</span> shows ho<span class="_ _3"></span>w the <span class="ff86">V</span> registers ar<span class="_ _1"></span>e divided into four lanes, one </div><div class="t m0 xc hd y11ce ff82 fs7 fc7 sc0 ls1 ws1">for each 32-bit integer<span class="_ _10"></span>, and then how the arithmetic op<span class="_ _0"></span>er<span class="_ _3"></span>ation is applied </div><div class="t m0 xc hd y11cf ff82 fs7 fc7 sc0 ls1 ws1">to each lane independently. This wa<span class="_ _3"></span>y we accomplish four additions in one </div><div class="t m0 xc hd y11d0 ff82 fs7 fc7 sc0 ls1 ws1">instruction, and the NEON coprocessor performs them all at the same </div><div class="t m0 xc hd y11d1 ff82 fs7 fc7 sc0 ls1 ws1">time—in parallel.</div><div class="t m0 x40 h12 y11d2 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf131" data-dest-detail='[305,"XYZ",122,514,null]'><div class="d m1" style="border-style:none;position:absolute;left:296.173000px;bottom:545.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf131" data-dest-detail='[305,"XYZ",53,330,null]'><div class="d m1" style="border-style:none;position:absolute;left:104.032000px;bottom:358.746000px;width:20.547000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf132" data-dest-detail='[306,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:104.032000px;bottom:191.746000px;width:20.547000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf132" class="pf w2 h6" data-page-no="132"><div class="pc pc132 w2 h6"><img class="bi xd y11d3 w7 h57" alt="" src="bg132.png"/><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">294</div><div class="t m0 xd h15 y11d4 ff87 fsb fc7 sc0 ls1 ws1"> <span class="_ _e"></span>P<span class="_ _1"></span>erforming Arithmetic Operations</div><div class="t m0 xd hd y11d5 ff82 fs7 fc7 sc0 ls1 ws1">There ar<span class="_ _1"></span>e tw<span class="_ _0"></span>o forms of the add instruction, one for integer addition and </div><div class="t m0 xd hd y11d6 ff82 fs7 fc7 sc0 ls1 ws1">one for floating-<span class="_ _1"></span>point addition:</div><div class="t m0 xa hd y11d7 ff82 fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>ADD V<span class="_ _6"></span>d.<span class="_ _6"></span>T<span class="_ _10"></span>, Vn.<span class="_ _10"></span>T<span class="_ _10"></span>, Vm.<span class="_ _10"></span>T <span class="_ _82"> </span>// Integer addition</div><div class="t m0 xa hd y11d8 ff82 fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>F<span class="_ _6"></span>ADD V<span class="_ _1"></span>d.<span class="_ _10"></span>T<span class="_ _6"></span>, V<span class="_ _1"></span>n.<span class="_ _6"></span>T<span class="_ _10"></span>, Vm.<span class="_ _10"></span>T <span class="_ _5d"> </span>//  <span class="_ _b"></span>floating-poin<span class="_ _3"></span>t addition</div><div class="t m0 x38 hd y11d9 ff86 fs7 fc7 sc0 ls1 ws1">T<span class="ff82"> must be</span></div><div class="t m0 xa hd y11da ff82 fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>For ADD: 8B, 16B, 4H, 8H, 2S<span class="_ _1"></span>, 4S or 2D</div><div class="t m0 xa hd y11db ff82 fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>For F<span class="_ _6"></span>ADD: 4H, 8H, 2S<span class="_ _3"></span>, 4S or 2D</div><div class="t m0 x34 h1f y11dc ff87 fse fc7 sc0 ls1 ws1">Note<span class="ff89"> <span class="_ _17"> </span>We use the same instructions as we used for scalar integer </span></div><div class="t m0 x34 h1f y11dd ff89 fse fc7 sc0 ls1 ws1">and floating-point arithmetic.<span class="_ _1"></span> <span class="_ _3"></span>The <span class="_ _1"></span>Assembler knows to crea<span class="_ _0"></span>te code for </div><div class="t m0 x34 h1f y11de ff89 fse fc7 sc0 ls1 ws1">the NEON Coprocessor due to the use of <span class="ff8a">V</span> registers and the inc<span class="_ _3"></span>lusion </div><div class="t m0 x34 h1f y11df ff89 fse fc7 sc0 ls1 ws1">of the <span class="ff8a">T</span> specifier<span class="_ _6"></span>.</div><div class="t m0 xc hd y11e0 ff82 fs7 fc7 sc0 ls1 ws1">The trick to using NEON is arranging yo<span class="_ _3"></span>ur code, so tha<span class="_ _3"></span>t all the lanes </div><div class="t m0 xd hd y11e1 ff82 fs7 fc7 sc0 ls1 ws1">keep doing useful work.</div><div class="t m0 xd h26 y11e2 ff88 fs3 fc7 sc0 ls1 ws1">Figure 13-2. <span class="_ _15"> </span><span class="ff83">Example of the four lanes involved in doing 32-bit </span></div><div class="t m0 xd h26 y11e3 ff83 fs3 fc7 sc0 ls1 ws1">integer addition</div><div class="t m0 xd h12 yb21 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf133" class="pf w2 h6" data-page-no="133"><div class="pc pc133 w2 h6"><div class="t m0 x17 hd y3f ff82 fs7 fc7 sc0 ls1 ws1">295</div><div class="t m0 x1c hd y145 ff82 fs7 fc7 sc0 ls1 ws1">Since the NEON Processor supports integer opera<span class="_ _3"></span>tions, it supports all </div><div class="t m0 xc hd y146 ff82 fs7 fc7 sc0 ls1 ws1">the logical operations lik<span class="_ _3"></span>e <span class="ff86">AND</span>, <span class="ff86 ls1f wsc7">BIC,</span> and <span class="ff86">ORR</span>. There ar<span class="_ _3"></span>e also a selection </div><div class="t m0 xc hd y147 ff82 fs7 fc7 sc0 ls1 ws1">of comparison operations<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1b0 ff82 fs7 fc7 sc0 ls1 ws1">A look at the list of NEON instructions shows a lot of specialty </div><div class="t m0 xc hd y1b1 ff82 fs7 fc7 sc0 ls1 ws1">instructions pro<span class="_ _3"></span>vided to help with specific algorithms. For exam<span class="_ _3"></span>ple, ther<span class="_ _1"></span>e’<span class="_ _1"></span>s </div><div class="t m0 xc hd y218 ff82 fs7 fc7 sc0 ls1 ws1">direct support for polynomials ov<span class="_ _3"></span>er the binary ring to suppor<span class="_ _0"></span>t certain </div><div class="t m0 xc hd y219 ff82 fs7 fc7 sc0 ls1 ws1">classes of cryptographic algorithms.</div><div class="t m0 x1c hd y1b4 ff82 fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e will show you how to use a few of the instructions in working </div><div class="t m0 xc hd y1b5 ff82 fs7 fc7 sc0 ls1 ws1">examples. T<span class="_ _3"></span>his will give you enough knowledge to apply the gener<span class="_ _1"></span>al </div><div class="t m0 xc hd y1b6 ff82 fs7 fc7 sc0 ls1 ws1">principles of operations for the NEON Coprocessor; then you can peruse </div><div class="t m0 xc hd y1b7 ff82 fs7 fc7 sc0 ls1 ws1">all the instructions in the <span class="ff83">ARM Instruction Set Reference Gu<span class="_ _3"></span>ide<span class="ff82">.</span></span></div><div class="t m0 xc h15 y11e4 ff87 fsb fc7 sc0 ls1 ws1"> <span class="_ _e"></span>Calculating 4D V<span class="_ _1"></span>ector Distance</div><div class="t m0 xc hd y11e5 ff82 fs7 fc7 sc0 ls1 ws1">Let’<span class="_ _1"></span>s expand the distance calculation example fr<span class="_ _1"></span>om Chapter <span class="fc5">12</span>, “Floating- </div><div class="t m0 xc hd y11e6 ff82 fs7 fc7 sc0 ls1 ws1">Point Oper<span class="_ _3"></span>ations<span class="_ _3"></span>,<span class="_ _8"></span>” to calculate the distance between two four<span class="_ _1"></span>-dimensional </div><div class="t m0 xc hd y11e7 ff82 fs7 fc7 sc0 ls1 ws1">(4D) vectors. T<span class="_ _3"></span>he formula generalizes to any n<span class="_ _3"></span>umber of dimensions, </div><div class="t m0 xc hd yfc3 ff82 fs7 fc7 sc0 ls1 ws1">by just addin<span class="_ _3"></span>g the extra squar<span class="_ _3"></span>es of the differences for the addition<span class="_ _3"></span>al </div><div class="t m0 xc hd y11e8 ff82 fs7 fc7 sc0 ls1 ws1">dimensions under the square r<span class="_ _3"></span>oot.</div><div class="t m0 x1c hd y11e9 ff82 fs7 fc7 sc0 ls1 ws1">First<span class="_ _3"></span>, distance.s is sho<span class="_ _3"></span>wn in Listing <span class="fc5">13-1</span>, using the NEON Coprocessor<span class="_ _10"></span>.</div><div class="t m0 xc h20 y11ea ff88 fs3 fc7 sc0 ls1 ws1">Listing 13-1. <span class="_ _15"> </span><span class="ff82">Routine to calcula<span class="_ _3"></span>te the distance between two 4D </span></div><div class="t m0 xc h20 y11eb ff82 fs3 fc7 sc0 ls1 ws1">vectors using the NEON Coprocessor<span class="_ _10"></span>.</div><div class="t m0 xc h18 y11ec ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y11ed ff8b fs7 fc7 sc0 ls1 ws1">// Example function to calculate the distance</div><div class="t m0 xc h18 y11ee ff8b fs7 fc7 sc0 ls1 ws1">// between 4D two points in single precision</div><div class="t m0 xc h18 y11ef ff8b fs7 fc7 sc0 ls1 ws1">// floating-point using the NEON Processor</div><div class="t m0 xc h18 y11f0 ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y11f1 ff8b fs7 fc7 sc0 ls1 ws1">// Inputs:</div><div class="t m0 xc h18 y11f2 ff8b fs7 fc7 sc0 ls1 ws1">//    X0 - pointer to the 8 FP numbers</div><div class="t m0 xc h18 y11f3 ff8b fs7 fc7 sc0 ls1 ws1">//           they are (x1, x2, x3, x4),</div><div class="t m0 xc h18 y11f4 ff8b fs7 fc7 sc0 ls1 ws1">//                   (y1, y2, y3, y4)</div><div class="t m0 x40 h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:336.069000px;bottom:350.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf133" data-dest-detail='[307,"XYZ",53,257,null]'><div class="d m1" style="border-style:none;position:absolute;left:235.766000px;bottom:270.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf134" class="pf w2 h6" data-page-no="134"><div class="pc pc134 w2 h6"><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">296</div><div class="t m0 xd h18 y46b ff8b fs7 fc7 sc0 ls1 ws1">// Outputs:</div><div class="t m0 xd h18 y46c ff8b fs7 fc7 sc0 ls1 ws1">//    W0 - the length (as single precision FP)</div><div class="t m0 xd h18 ya17 ff8b fs7 fc7 sc0 ls1 ws1">.global distance // Allow function to be called by others</div><div class="t m0 xd h18 ye1b ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y910 ff8b fs7 fc7 sc0 ls1 ws1">distance:</div><div class="t m0 xd h18 y470 ff8b fs7 fc7 sc0 ls1 ws1">      // load all 4 numbers at once</div><div class="t m0 xd h18 y471 ff8b fs7 fc7 sc0 ls1 ws1">      LDP   Q2, Q3, [X0]</div><div class="t m0 xd h18 y911 ff8b fs7 fc7 sc0 ls1 ws1">      // calc V1 = V2 - V3</div><div class="t m0 xd h18 y912 ff8b fs7 fc7 sc0 ls1 ws1">      FSUB  V1.4S, V2.4S, V3.4S</div><div class="t m0 xd h18 y474 ff8b fs7 fc7 sc0 ls1 ws1">      // calc V1 = V1 * V1 = (xi-yi)^2</div><div class="t m0 xd h18 y475 ff8b fs7 fc7 sc0 ls1 ws1">      FMUL  V1.4S, V1.4S, V1.4S</div><div class="t m0 xd h18 y476 ff8b fs7 fc7 sc0 ls1 ws1">      // calc S0 = S0 + S1 + S2 + S3</div><div class="t m0 xd h18 ye1c ff8b fs7 fc7 sc0 ls1 ws1">      FADDP V0.4S, V1.4S, V1.4S</div><div class="t m0 xd h18 y62d ff8b fs7 fc7 sc0 ls1 ws1">      FADDP V0.4S, V0.4S, V0.4S</div><div class="t m0 xd h18 y84d ff8b fs7 fc7 sc0 ls1 ws1">      // calc sqrt(S0)</div><div class="t m0 xd h18 y1173 ff8b fs7 fc7 sc0 ls1 ws1">      FSQRT S4, S0</div><div class="t m0 xd h18 y1174 ff8b fs7 fc7 sc0 ls1 ws1">      // move result to W0 to be returned</div><div class="t m0 xd h18 y1175 ff8b fs7 fc7 sc0 ls1 ws1">      FMOV  W0, S4</div><div class="t m0 xd h18 y1176 ff8b fs7 fc7 sc0 ls1 ws1">      RET</div><div class="t m0 xc hd y1177 ff82 fs7 fc7 sc0 ls1 ws1">Next<span class="_ _3"></span>, main.s is shown in Listing <span class="fc5">13-2</span>, to test the r<span class="_ _1"></span>outine.</div><div class="t m0 xd h20 y11f5 ff88 fs3 fc7 sc0 ls1 ws1">Listing 13-2. <span class="_ _15"> </span><span class="ff82">The main pr<span class="_ _3"></span>ogram to test the 4D distance function.</span></div><div class="t m0 xd h18 y10e6 ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y11f6 ff8b fs7 fc7 sc0 ls1 ws1">// Main program to test our distance function</div><div class="t m0 xd h18 y11f7 ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y11f8 ff8b fs7 fc7 sc0 ls1 ws1">// W19 - loop counter</div><div class="t m0 xd h18 y11f9 ff8b fs7 fc7 sc0 ls1 ws1">// X20 - address to current set of points</div><div class="t m0 xd h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf134" data-dest-detail='[308,"XYZ",35,219,null]'><div class="d m1" style="border-style:none;position:absolute;left:203.576000px;bottom:233.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf135" class="pf w2 h6" data-page-no="135"><div class="pc pc135 w2 h6"><div class="t m0 x17 hd y3f ff82 fs7 fc7 sc0 ls1 ws1">297</div><div class="t m0 xc h18 y46b ff8b fs7 fc7 sc0 ls1 ws1">.global main // Provide program starting address to linker</div><div class="t m0 xc h18 ye19 ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y111c ff8b fs7 fc7 sc0 ls1 ws1">      .equ   N, 3   // Number of points.</div><div class="t m0 xc h18 y11fa ff8b fs7 fc7 sc0 ls1 ws1">main:</div><div class="t m0 xc h18 y11fb ff8b fs7 fc7 sc0 ls1 ws1">      STP    X19, X20, [SP, #-16]!</div><div class="t m0 xc h18 y111e ff8b fs7 fc7 sc0 ls1 ws1">      STR    LR, [SP, #-16]!</div><div class="t m0 xc h18 y111f ff8b fs7 fc7 sc0 ls1 ws1">      LDR    X20, =points // pointer to current points</div><div class="t m0 xc h18 y1120 ff8b fs7 fc7 sc0 ls1 ws1">      MOV    W19, #N      // number of loop iterations</div><div class="t m0 xc h18 y1121 ff8b fs7 fc7 sc0 ls1 ws1">loop:    MOV    X0, X20   // move pointer to parameter 1 (r0)</div><div class="t m0 xc h18 y1122 ff8b fs7 fc7 sc0 ls1 ws1">      BL     distance     // call distance function</div><div class="t m0 xc h18 y11fc ff8b fs7 fc7 sc0 ls1 ws1">// need to take the single precision return value</div><div class="t m0 xc h18 y11fd ff8b fs7 fc7 sc0 ls1 ws1">// and convert it to a double, because the C printf</div><div class="t m0 xc h18 y11fe ff8b fs7 fc7 sc0 ls1 ws1">// function can only print doubles.</div><div class="t m0 xc h18 y11ff ff8b fs7 fc7 sc0 ls1 ws1">      FMOV   S2, W0      // move back to fpu for conversion</div><div class="t m0 xc h18 y1200 ff8b fs7 fc7 sc0 ls1 ws1">      FCVT   D0, S2      // convert single to double</div><div class="t m0 xc h18 y1201 ff8b fs7 fc7 sc0 ls1 ws1">      FMOV   X1, D0      // return double to r2, r3</div><div class="t m0 xc h18 y631 ff8b fs7 fc7 sc0 ls1 ws1">      LDR    X0, =prtstr // load print string</div><div class="t m0 xc h18 y112a ff8b fs7 fc7 sc0 ls1 ws1">      BL     printf      // print the distance</div><div class="t m0 xc h18 y1202 ff8b fs7 fc7 sc0 ls1 ws1">      ADD    X20, X20, #(8*4) // 8 elements each 4 bytes</div><div class="t m0 xc h18 y1203 ff8b fs7 fc7 sc0 ls1 ws1">      SUBS   W19, W19, #1 // decrement loop counter</div><div class="t m0 xc h18 y112d ff8b fs7 fc7 sc0 ls1 ws1">      B.NE   loop         // loop if more points</div><div class="t m0 xc h18 y1204 ff8b fs7 fc7 sc0 ls1 ws1">      MOV    X0, #0       // return code</div><div class="t m0 xc h18 y1205 ff8b fs7 fc7 sc0 ls1 ws1">      LDR    LR, [SP], #16</div><div class="t m0 xc h18 y1206 ff8b fs7 fc7 sc0 ls1 ws1">      LDP    X19, X20, [SP], #16</div><div class="t m0 xc h18 y1207 ff8b fs7 fc7 sc0 ls1 ws1">      RET</div><div class="t m0 x40 h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf136" class="pf w2 h6" data-page-no="136"><div class="pc pc136 w2 h6"><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">298</div><div class="t m0 xd h18 y46b ff8b fs7 fc7 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y46c ff8b fs7 fc7 sc0 ls1 ws1">points: .single    0.0, 0.0, 0.0, 0.0, 17.0, 4.0, 2.0, 1.0</div><div class="t m0 xd h18 y46d ff8b fs7 fc7 sc0 ls1d wsb4">      .sing<span class="_ _0"></span>le      1.3, 5.4, 3.1, -1.5, <span class="_ _3"></span>-2.4, 0.323, 3.4, -0.232</div><div class="t m0 xd h18 y623 ff8b fs7 fc7 sc0 ls20 ws1"> .single 1.323e10, -1.2e-4, 34.55, 5454.234, 10.9, -3.6, 4.2, 1.3</div><div class="t m0 xd h18 y624 ff8b fs7 fc7 sc0 ls1 ws1">prtstr:      .asciz &quot;Distance = %f\n&quot;</div><div class="t m0 xc hd y85d ff82 fs7 fc7 sc0 ls1 ws1">The makefile is in Listing <span class="fc5">13-3</span>.</div><div class="t m0 xd h20 y1208 ff88 fs3 fc7 sc0 ls1 ws1">Listing 13-3. <span class="_ _15"> </span><span class="ff82">The makefile for the distance pr<span class="_ _1"></span>ogram</span></div><div class="t m0 xd h18 y1209 ff8b fs7 fc7 sc0 ls1 ws1">distance: distance.s main.s</div><div class="t m0 xd h18 y120a ff8b fs7 fc7 sc0 ls1 ws1">       gcc -g -o distance distance.s main.s</div><div class="t m0 xc hd y120b ff82 fs7 fc7 sc0 ls1 ws1">If we build and run the program<span class="_ _3"></span>, we see</div><div class="t m0 xd h18 y120c ff8b fs7 fc7 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 13$ make</div><div class="t m0 xd h18 y120d ff8b fs7 fc7 sc0 ls1 ws1">gcc -g -o distance distance.s main.s</div><div class="t m0 xd h18 y120e ff8b fs7 fc7 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 13$ ./distance</div><div class="t m0 xd h18 y120f ff8b fs7 fc7 sc0 ls1 ws1">Distance = 17.606817</div><div class="t m0 xd h18 y1210 ff8b fs7 fc7 sc0 ls1 ws1">Distance = 6.415898</div><div class="t m0 xd h18 y1211 ff8b fs7 fc7 sc0 ls1 ws1">Distance = 13230000128.000000</div><div class="t m0 xd h18 y1212 ff8b fs7 fc7 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 13$</div><div class="t m0 xc hd y1213 ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>W<span class="_ _1"></span>e load one vector into <span class="ff86">V2</span> and the other into <span class="ff86">V3</span>. </div><div class="t m0 x1e hd y1214 ff82 fs7 fc7 sc0 ls1 ws1">Each vector consists of four 32-bit floating-<span class="_ _1"></span>point </div><div class="t m0 x1e hd y1215 ff82 fs7 fc7 sc0 ls1 ws1">numbers<span class="_ _3"></span>, so each one can be placed in a 128-bit <span class="ff86">V</span> </div><div class="t m0 x1e hd y1216 ff82 fs7 fc7 sc0 ls1 ws1">register and tr<span class="_ _1"></span>eated as four lanes.</div><div class="t m0 xc hd y1217 ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Subtract all four componen<span class="_ _3"></span>ts at once using a single </div><div class="t m0 x1e hd y1218 ff86 fs7 fc7 sc0 ls1c wsbf">FSUB<span class="ff82 ls1 ws1"> instruction. We c<span class="_ _3"></span>alculate the squares all a<span class="_ _3"></span>t </span></div><div class="t m0 x1e hd y1219 ff82 fs7 fc7 sc0 ls1 ws1">once using a <span class="ff86">FMUL</span> instruction. Both instructions </div><div class="t m0 x1e hd y121a ff82 fs7 fc7 sc0 ls1 ws1">operate on all four lanes in p<span class="_ _3"></span>arallel.</div><div class="t m0 xd h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf136" data-dest-detail='[310,"XYZ",35,475,null]'><div class="d m1" style="border-style:none;position:absolute;left:172.567000px;bottom:489.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf137" class="pf w2 h6" data-page-no="137"><div class="pc pc137 w2 h6"><div class="t m0 x17 hd y3f ff82 fs7 fc7 sc0 ls1 ws1">299</div><div class="t m0 x1c hd y145 ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Add up all the sums which ar<span class="_ _3"></span>e all in <span class="ff86">V1</span>. This means </div><div class="t m0 x9 hd y146 ff82 fs7 fc7 sc0 ls1 ws1">all the numbers ar<span class="_ _3"></span>e in differen<span class="_ _3"></span>t lanes and we can’t </div><div class="t m0 x9 hd y147 ff82 fs7 fc7 sc0 ls1 ws1">add them in parallel. This is a common situa<span class="_ _3"></span>tion to </div><div class="t m0 x9 hd y1b0 ff82 fs7 fc7 sc0 ls1 ws1">get into; fortunately the NEON instruction set does </div><div class="t m0 x9 hd y1b1 ff82 fs7 fc7 sc0 ls1 ws1">give us some help<span class="_ _1"></span>. It won’t add up all the lanes in a </div><div class="t m0 x9 hd y218 ff82 fs7 fc7 sc0 ls1 ws1">register<span class="_ _10"></span>, but it will do pair<span class="_ _0"></span>wise additions in parallel. </div><div class="t m0 x9 hd y219 ff82 fs7 fc7 sc0 ls1 ws1">The following instruction</div><div class="t m0 x9 h18 y1e2 ff8b fs7 fc7 sc0 ls1 ws1">FADDP V0.4S, V1.4S, V1.4S</div><div class="t m0 x9 hd yf9d ff82 fs7 fc7 sc0 ls1 ws1">will pair<span class="_ _0"></span>wise add each pair of 32-bit floating-<span class="_ _1"></span>point </div><div class="t m0 x9 hd y2f3 ff82 fs7 fc7 sc0 ls1 ws1">numbers in the two arguments<span class="_ _1"></span>, putting all the sums </div><div class="t m0 x9 hd y2f4 ff82 fs7 fc7 sc0 ls1 ws1">in <span class="ff86">V0</span>. Since the res<span class="_ _3"></span>ults ha<span class="_ _3"></span>ve half the num<span class="_ _3"></span>ber of </div><div class="t m0 x9 hd y2f5 ff82 fs7 fc7 sc0 ls1 ws1">elements as the arguments<span class="_ _1"></span>, we can pair<span class="_ _0"></span>wise add </div><div class="t m0 x9 hd y1d0 ff82 fs7 fc7 sc0 ls1 ws1">four pairs in this case, whic<span class="_ _3"></span>h can be held in two <span class="ff86">V</span> </div><div class="t m0 x9 hd y94f ff82 fs7 fc7 sc0 ls1 ws1">registers<span class="_ _1"></span>. We only need the first two sums<span class="_ _1"></span>, so w<span class="_ _0"></span>e </div><div class="t m0 x9 hd y950 ff82 fs7 fc7 sc0 ls1 ws1">ignore the r<span class="_ _1"></span>esults from the second operand. This </div><div class="t m0 x9 hd y1d3 ff82 fs7 fc7 sc0 ls1 ws1">accomplishes two of the additions we need.</div><div class="t m0 x1c hd y6e5 ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Perform the third using another <span class="ff86">F<span class="_ _6"></span>ADDP<span class="ff82"> instr<span class="_ _0"></span>uction. </span></span></div><div class="t m0 x9 hd y294 ff82 fs7 fc7 sc0 ls1 ws1">This lea<span class="_ _3"></span>ves the result we wan<span class="_ _3"></span>t in lane 1 which </div><div class="t m0 x9 hd y295 ff82 fs7 fc7 sc0 ls1 ws1">happens to o<span class="_ _3"></span>verlap the r<span class="_ _3"></span>egular floating-<span class="_ _1"></span> <span class="_ _b"></span>p<span class="_ _0"></span>oin<span class="_ _3"></span>t </div><div class="t m0 x9 hd y296 ff82 fs7 fc7 sc0 ls1 ws1">register <span class="ff86">S0</span>.</div><div class="t m0 x1c hd y159 ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Once the numbers are added, use the FPU’<span class="_ _1"></span>s square </div><div class="t m0 x9 hd y15a ff82 fs7 fc7 sc0 ls1 ws1">root instruction to calcula<span class="_ _3"></span>te the final distance<span class="_ _3"></span>.</div><div class="t m0 x1c hd y121b ff82 fs7 fc7 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">13-3</span> shows ho<span class="_ _3"></span>w these operations flo<span class="_ _3"></span>w through the lanes in our </div><div class="t m0 xc hd y121c ff82 fs7 fc7 sc0 ls1 ws1">registers and ho<span class="_ _3"></span>w we build up our result with each step<span class="_ _1"></span>.</div><div class="t m0 x40 h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf138" data-dest-detail='[312,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:104.032000px;bottom:189.362000px;width:20.547000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf138" class="pf w2 h6" data-page-no="138"><div class="pc pc138 w2 h6"><img class="bi x2 y121d w6 h58" alt="" src="bg138.png"/><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">300</div><div class="t m0 xd h26 y121e ff88 fs3 fc7 sc0 ls1 ws1">Figure 13-3. <span class="_ _15"> </span><span class="ff83">Flow of the ca<span class="_ _3"></span>lculations thro<span class="_ _3"></span>ugh the registers sho<span class="_ _3"></span>wing </span></div><div class="t m0 xd h26 y121f ff83 fs3 fc7 sc0 ls1 ws1">the lanes. The last two lines ar<span class="_ _3"></span>en<span class="_ _1"></span>’t to scale and only show a sin<span class="_ _3"></span>gle lane</div><div class="t m0 xc hd y1220 ff82 fs7 fc7 sc0 ls1 ws1">This shows a nice featur<span class="_ _1"></span>e of having the NEON and FPU sharing </div><div class="t m0 xd hd y1221 ff82 fs7 fc7 sc0 ls1 ws1">registers<span class="_ _1"></span>, allowing intermixing of FPU and NE<span class="_ _0"></span>ON instructions without </div><div class="t m0 xd hd y1222 ff82 fs7 fc7 sc0 ls1 ws1">needing to move da<span class="_ _3"></span>ta around.</div><div class="t m0 xc hd y1223 ff82 fs7 fc7 sc0 ls1 ws1">The only change to the m<span class="_ _3"></span>ain progr<span class="_ _3"></span>am is making the vectors 4D and </div><div class="t m0 xd hd y1224 ff82 fs7 fc7 sc0 ls1 ws1">adjust the loop to use the new vector size<span class="_ _3"></span>.</div><div class="t m0 xd h15 y1225 ff87 fsb fc7 sc0 ls1 ws1"> <span class="_ _e"></span>Optimizing 3x3 Matrix Multiplication</div><div class="t m0 xd hd y1226 ff82 fs7 fc7 sc0 ls1 ws1">Let’<span class="_ _1"></span>s optimize the 3x3 matrix multiplica<span class="_ _3"></span>tion example progr<span class="_ _1"></span>am from </div><div class="t m0 xd hd y1227 ff82 fs7 fc7 sc0 ls1 ws1">Chapter <span class="fc5">11</span>, “M<span class="_ _1"></span>ultiply, Divide, and Accumula<span class="_ _3"></span>te,<span class="_ _66"></span>” by using the parallel </div><div class="t m0 xd hd y1228 ff82 fs7 fc7 sc0 ls1 ws1">processing a<span class="_ _3"></span>bilities of the NEON Coprocessor<span class="_ _10"></span>.</div><div class="t m0 xc hd y1229 ff82 fs7 fc7 sc0 ls1 ws1">The NEON Coprocessor has a dot pr<span class="_ _1"></span>oduct function <span class="ff86">SD<span class="_ _0"></span>OT</span>, but sadly it </div><div class="t m0 xd hd y122a ff82 fs7 fc7 sc0 ls1 ws1">only operates on in<span class="_ _3"></span>tegers and isn’t av<span class="_ _3"></span>ailable on all processors<span class="_ _1"></span>. Hence, we </div><div class="t m0 xd hd y122b ff82 fs7 fc7 sc0 ls1 ws1">won’t use it. As we saw in the last example<span class="_ _1"></span>, adding within one register is a </div><div class="t m0 xd hd y122c ff82 fs7 fc7 sc0 ls1 ws1">problem<span class="_ _3"></span>, and similarly there ar<span class="_ _1"></span>e problems with carr<span class="_ _0"></span>ying out multiply with </div><div class="t m0 xd hd y122d ff82 fs7 fc7 sc0 ls1 ws1">accumulates<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:76.259700px;bottom:198.000000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf139" class="pf w2 h6" data-page-no="139"><div class="pc pc139 w2 h6"><img class="bi x2e y122e w17 h59" alt="" src="bg139.png"/><div class="t m0 x17 hd y3f ff82 fs7 fc7 sc0 ls1 ws1">301</div><div class="t m0 x1c hd y145 ff82 fs7 fc7 sc0 ls1 ws1">The recommended solution is to r<span class="_ _3"></span>everse two of our loops from the </div><div class="t m0 xc hd y146 ff82 fs7 fc7 sc0 ls1 ws1">previous pr<span class="_ _1"></span>ogram. This way we do the multipl<span class="_ _3"></span>y with accumulates as </div><div class="t m0 xc hd y147 ff82 fs7 fc7 sc0 ls1 ws1">separate instructions<span class="_ _3"></span>, but we do it on three vectors a<span class="_ _3"></span>t a time. The r<span class="_ _1"></span>esult </div><div class="t m0 xc hd y1b0 ff82 fs7 fc7 sc0 ls1 ws1">is we eliminate one of our loops fr<span class="_ _3"></span>om the previous pr<span class="_ _1"></span>ogram and achieve </div><div class="t m0 xc hd y1b1 ff82 fs7 fc7 sc0 ls1 ws1">some level of parallel opera<span class="_ _3"></span>tion.</div><div class="t m0 x1c hd y218 ff82 fs7 fc7 sc0 ls1 ws1">The trick is to notice that one 3x3 m<span class="_ _3"></span>atrix multiplication is r<span class="_ _1"></span>eally three </div><div class="t m0 xc hd y219 ff82 fs7 fc7 sc0 ls1 ws1">matrices by vector c<span class="_ _3"></span>alculations<span class="_ _3"></span>, namely:</div><div class="t m0 x1e hd y1e2 ff82 fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>Ccol1 = A <span class="ff8c">∗</span> Bcol1</div><div class="t m0 x1e hd yf9d ff82 fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>Ccol2 = A <span class="ff8c">∗</span> Bcol2</div><div class="t m0 x1e hd y14e ff82 fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>Ccol3 = A <span class="ff8c">∗</span> Bcol3</div><div class="t m0 x1c hd y14f ff82 fs7 fc7 sc0 ls1 ws1">If we look at one of these matrices times a vector<span class="_ _6"></span>, for example:</div><div class="t m0 x59 hc y122f ff82 fs8 fc7 sc0 ls1 ws1"> </div><div class="t m0 x1c hd y1230 ff82 fs7 fc7 sc0 ls1 ws1">we see the calculation is</div><div class="t m0 x69 hc y1231 ff82 fs8 fc7 sc0 ls1 ws1"> </div><div class="t m0 x1c hd y1232 ff82 fs7 fc7 sc0 ls1 ws1">If we put a, d, and g in a r<span class="_ _3"></span>egister in separate lanes; b<span class="_ _3"></span>, e, and h in </div><div class="t m0 xc hd y1233 ff82 fs7 fc7 sc0 ls1 ws1">another register; and c, f, and i in a third r<span class="_ _3"></span>egister in the matchin<span class="_ _3"></span>g lanes, we </div><div class="t m0 xc hd y1234 ff82 fs7 fc7 sc0 ls1 ws1">can calculate a column in the r<span class="_ _1"></span>esult matrix<span class="_ _0"></span>, as shown in F<span class="_ _3"></span>igur<span class="_ _3"></span>e<span class="fc5">13-4</span>.</div><div class="t m0 xc h26 y1235 ff88 fs3 fc7 sc0 ls1 ws1">Figure 13-4. <span class="_ _15"> </span><span class="ff83">Showing how the calcula<span class="_ _3"></span>tions flow thr<span class="_ _3"></span>ough the lanes</span></div><div class="t m0 x40 h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf139" data-dest-detail='[313,"XYZ",53,174,null]'><div class="d m1" style="border-style:none;position:absolute;left:346.948000px;bottom:194.767000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf13a" class="pf w2 h6" data-page-no="13a"><div class="pc pc13a w2 h6"><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">302</div><div class="t m0 xc hd y145 ff82 fs7 fc7 sc0 ls1 ws1">This is the recommended algorithm for matrix multiplic<span class="_ _3"></span>ation on the </div><div class="t m0 xd hd y146 ff82 fs7 fc7 sc0 ls1 ws1">NEON coprocessor<span class="_ _10"></span>. We will use short integers to demonstra<span class="_ _3"></span>te integer </div><div class="t m0 xd hd y147 ff82 fs7 fc7 sc0 ls1 ws1">arithmetic this time. Since four 16-bit short integers fit in<span class="_ _3"></span>to 64 bits and we </div><div class="t m0 xd hd y1b0 ff82 fs7 fc7 sc0 ls1 ws1">only need three, we will use this lane configur<span class="_ _3"></span>ation.</div><div class="t m0 xc hd y1b1 ff82 fs7 fc7 sc0 ls1 ws1">What we did abo<span class="_ _3"></span>ve is for one column of the results m<span class="_ _3"></span>atrix, we then </div><div class="t m0 xd hd y218 ff82 fs7 fc7 sc0 ls1 ws1">need to do this for all the columns. W<span class="_ _1"></span>e will place this logic in a macro<span class="_ _1"></span>, </div><div class="t m0 xd hd y219 ff82 fs7 fc7 sc0 ls1 ws1">to repeat the c<span class="_ _3"></span>alculation thr<span class="_ _3"></span>ee times. Since the goal is as fas<span class="_ _3"></span>t matrix </div><div class="t m0 xd hd y1b4 ff82 fs7 fc7 sc0 ls1 ws1">multiplication as possible<span class="_ _1"></span>, it is wor<span class="_ _0"></span>th r<span class="_ _3"></span>emoving the loops<span class="_ _1"></span>, since it saves </div><div class="t m0 xd hd y1b5 ff82 fs7 fc7 sc0 ls1 ws1">extra logic. T<span class="_ _3"></span>his makes the pr<span class="_ _3"></span>ogram look much simpler<span class="_ _10"></span>.</div><div class="t m0 xc hd y1b6 ff82 fs7 fc7 sc0 ls1 ws1">Listing <span class="fc5">13-4</span> is the code for our NEON<span class="_ _1"></span>-enabled matrix multiplica<span class="_ _3"></span>tion.</div><div class="t m0 xd h20 ya99 ff88 fs3 fc7 sc0 ls1 ws1">Listing 13-4. <span class="_ _15"> </span><span class="ff82">Neon-ena<span class="_ _3"></span>bled 3x3 matrix multiplica<span class="_ _3"></span>tion example</span></div><div class="t m0 xd h18 ya9a ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 ya9b ff8b fs7 fc7 sc0 ls1 ws1">// Multiply 2 3x3 integer matrices</div><div class="t m0 xd h18 ya9c ff8b fs7 fc7 sc0 ls1 ws1">// Uses the NEON Coprocessor to do</div><div class="t m0 xd h18 ya9d ff8b fs7 fc7 sc0 ls1 ws1">// some operations in parallel.</div><div class="t m0 xd h18 ya9e ff8b fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 ya9f ff8b fs7 fc7 sc0 ls1 ws1">// Registers:</div><div class="t m0 xd h18 yaa0 ff8b fs7 fc7 sc0 ls1 ws1">//    D0 - first column of matrix A</div><div class="t m0 xd h18 yaa1 ff8b fs7 fc7 sc0 ls1 ws1">//    D1 - second column of matrix A</div><div class="t m0 xd h18 yaa2 ff8b fs7 fc7 sc0 ls1 ws1">//    D2 - third column of matrix A</div><div class="t m0 xd h18 yaa3 ff8b fs7 fc7 sc0 ls1 ws1">//    D3 - first column of matrix B</div><div class="t m0 xd h18 yaa4 ff8b fs7 fc7 sc0 ls1 ws1">//    D4 - second column of matrix B</div><div class="t m0 xd h18 yaa5 ff8b fs7 fc7 sc0 ls1 ws1">//    D5 - third column of matrix B</div><div class="t m0 xd h18 yaa6 ff8b fs7 fc7 sc0 ls1 ws1">//    D6 - first column of matrix C</div><div class="t m0 xd h18 y1236 ff8b fs7 fc7 sc0 ls1 ws1">//    D7 - second column of matrix C</div><div class="t m0 xd h18 y1237 ff8b fs7 fc7 sc0 ls1 ws1">//    D8 - third column of matrix C</div><div class="t m0 xd h18 yaa9 ff8b fs7 fc7 sc0 ls1 ws1">.global main // Provide program starting address to linker</div><div class="t m0 xd h18 y1238 ff8b fs7 fc7 sc0 ls1 ws1">main:</div><div class="t m0 xd h18 y1239 ff8b fs7 fc7 sc0 ls1 ws1">      STP    X19, X20, [SP, #-16]!</div><div class="t m0 xd h18 y123a ff8b fs7 fc7 sc0 ls1 ws1">      STR    LR, [SP, #-16]!</div><div class="t m0 xd h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf13a" data-dest-detail='[314,"XYZ",35,420,null]'><div class="d m1" style="border-style:none;position:absolute;left:88.055400px;bottom:433.362000px;width:20.547600px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf13b" class="pf w2 h6" data-page-no="13b"><div class="pc pc13b w2 h6"><div class="t m0 x17 hd y3f ff82 fs7 fc7 sc0 ls1 ws1">303</div><div class="t m0 xc h18 y46b ff8b fs7 fc7 sc0 ls1 ws1">// load matrix A into Neon registers D0, D1, D2</div><div class="t m0 xc h18 y46c ff8b fs7 fc7 sc0 ls1 ws1">      LDR    X0, =A        // Address of A</div><div class="t m0 xc h18 y46d ff8b fs7 fc7 sc0 ls1 ws1">      LDP    D0, D1, [X0], #16</div><div class="t m0 xc h18 y623 ff8b fs7 fc7 sc0 ls1 ws1">      LDR    D2, [X0]</div><div class="t m0 xc h18 y46f ff8b fs7 fc7 sc0 ls1 ws1">// load matrix B into Neon registers D3, D4, D5</div><div class="t m0 xc h18 y85d ff8b fs7 fc7 sc0 ls1 ws1">      LDR    X0, =B        // Address of B</div><div class="t m0 xc h18 y85e ff8b fs7 fc7 sc0 ls1 ws1">      LDP    D3, D4, [X0], #16</div><div class="t m0 xc h18 y847 ff8b fs7 fc7 sc0 ls1 ws1">      LDR    D5, [X0]</div><div class="t m0 xc h18 y848 ff8b fs7 fc7 sc0 ls1 ws1">.macro mulcol ccol bcol</div><div class="t m0 xc h18 y849 ff8b fs7 fc7 sc0 ls1 ws1">      MUL    \ccol\().4H, V0.4H, \bcol\().4H[0]</div><div class="t m0 xc h18 y84a ff8b fs7 fc7 sc0 ls1 ws1">      MLA    \ccol\().4H, V1.4H, \bcol\().4H[1]</div><div class="t m0 xc h18 y84b ff8b fs7 fc7 sc0 ls1 ws1">      MLA    \ccol\().4H, V2.4H, \bcol\().4H[2]</div><div class="t m0 xc h18 y62c ff8b fs7 fc7 sc0 ls1 ws1">.endm</div><div class="t m0 xc h18 y62d ff8b fs7 fc7 sc0 ls1 ws1">      mulcol V6, V3        // process first column</div><div class="t m0 xc h18 y84d ff8b fs7 fc7 sc0 ls1 ws1">      mulcol V7, V4        // process second column</div><div class="t m0 xc h18 y84e ff8b fs7 fc7 sc0 ls1 ws1">      mulcol V8, V5        // process third column</div><div class="t m0 xc h18 y123b ff8b fs7 fc7 sc0 ls1 ws1">      LDR    X1, =C        // Address of C</div><div class="t m0 xc h18 y862 ff8b fs7 fc7 sc0 ls1 ws1">      STP    D6, D7, [X1], #16</div><div class="t m0 xc h18 y1176 ff8b fs7 fc7 sc0 ls1 ws1">      STR    D8, [X1]</div><div class="t m0 xc h18 y864 ff8b fs7 fc7 sc0 ls1 ws1">// Print out matrix C</div><div class="t m0 xc h18 y865 ff8b fs7 fc7 sc0 ls1 ws1">// Loop through 3 rows printing 3 cols each time.</div><div class="t m0 xc h18 y866 ff8b fs7 fc7 sc0 ls1 ws1">      MOV    W19, #3              // Print 3 rows</div><div class="t m0 xc h18 y867 ff8b fs7 fc7 sc0 ls1 ws1">      LDR    X20, =C              // Addr of results matrix</div><div class="t m0 xc h18 y868 ff8b fs7 fc7 sc0 ls1 ws1">printloop:</div><div class="t m0 xc h18 y869 ff8b fs7 fc7 sc0 ls1 ws1">      LDR    X0, =prtstr    // printf format string</div><div class="t m0 xc h18 y86a ff8b fs7 fc7 sc0 ls1 ws1">// print transpose so matrix is in usual row column order.</div><div class="t m0 xc h18 y86b ff8b fs7 fc7 sc0 ls1 ws1">// first ldrh post-indexes by 2 for next row</div><div class="t m0 xc h18 ya1b ff8b fs7 fc7 sc0 ls1 ws1">// so second ldrh adds 6, so is ahead by 2+6=8=row size</div><div class="t m0 xc h18 yc45 ff8b fs7 fc7 sc0 ls1 ws1">// similarly for third ldh ahead by 2+14=16 = 2 x row size</div><div class="t m0 x40 h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf13c" class="pf w2 h6" data-page-no="13c"><div class="pc pc13c w2 h6"><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">304</div><div class="t m0 xd h18 y46b ff8b fs7 fc7 sc0 ls1 ws1">      LDRH   W1, [X20], #2  // first element in current row</div><div class="t m0 xd h18 y46c ff8b fs7 fc7 sc0 ls1 ws1">      LDRH   W2, [X20,#6]   // second element in current row</div><div class="t m0 xd h18 y46d ff8b fs7 fc7 sc0 ls1 ws1">      LDRH   W3, [X20,#14]  // third element in current row</div><div class="t m0 xd h18 y623 ff8b fs7 fc7 sc0 ls1 ws1">      BL     printf         // Call printf</div><div class="t m0 xd h18 y624 ff8b fs7 fc7 sc0 ls1 ws1">      SUBS   W19, W19, #1   // Dec loop counter</div><div class="t m0 xd h18 y625 ff8b fs7 fc7 sc0 ls1 ws1">      B.NE   printloop      // If not zero loop</div><div class="t m0 xd h18 y85e ff8b fs7 fc7 sc0 ls1 ws1">      MOV    X0, #0         // return code</div><div class="t m0 xd h18 y847 ff8b fs7 fc7 sc0 ls1 ws1">      LDR    LR, [SP], #16</div><div class="t m0 xd h18 y85f ff8b fs7 fc7 sc0 ls1 ws1">      LDP    X19, X20, [SP], #16</div><div class="t m0 xd h18 y629 ff8b fs7 fc7 sc0 ls1 ws1">      RET</div><div class="t m0 xd h18 y84a ff8b fs7 fc7 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y84b ff8b fs7 fc7 sc0 ls1 ws1">// First matrix in column major order</div><div class="t m0 xd h18 y62c ff8b fs7 fc7 sc0 ls1 ws1">A:    .short 1, 4, 7, 0</div><div class="t m0 xd h18 y860 ff8b fs7 fc7 sc0 ls1 ws1">      .short 2, 5, 8, 0</div><div class="t m0 xd h18 y861 ff8b fs7 fc7 sc0 ls1 ws1">      .short 3, 6, 9, 0</div><div class="t m0 xd h18 yc3f ff8b fs7 fc7 sc0 ls1 ws1">// Second matrix in column major order</div><div class="t m0 xd h18 yc40 ff8b fs7 fc7 sc0 ls1 ws1">B:    .short 9, 6, 3, 0</div><div class="t m0 xd h18 yc41 ff8b fs7 fc7 sc0 ls1 ws1">      .short 8, 5, 2, 0</div><div class="t m0 xd h18 yc42 ff8b fs7 fc7 sc0 ls1 ws1">      .short 7, 4, 1, 0</div><div class="t m0 xd h18 ya18 ff8b fs7 fc7 sc0 ls1 ws1">// Result matrix in column major order</div><div class="t m0 xd h18 ya01 ff8b fs7 fc7 sc0 ls1 ws1">C:    .fill  12, 2, 0</div><div class="t m0 xd h18 y854 ff8b fs7 fc7 sc0 ls1 ws1">prtstr: .asciz  &quot;%3d  %3d  %3d\n&quot;</div><div class="t m0 xc hd yefa ff82 fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e store both matrices in column ma<span class="_ _3"></span>jor order and the C m<span class="_ _3"></span>atrix </div><div class="t m0 xd hd yefb ff82 fs7 fc7 sc0 ls1 ws1">is produced in column ma<span class="_ _3"></span>jor order<span class="_ _10"></span>. This is to make setting up the </div><div class="t m0 xd hd yefc ff82 fs7 fc7 sc0 ls1 ws1">calculations easier<span class="_ _10"></span>, since ever<span class="_ _0"></span>ything is aligned pr<span class="_ _3"></span>operly to bulk load </div><div class="t m0 xd hd ya19 ff82 fs7 fc7 sc0 ls1 ws1">into our NEON r<span class="_ _3"></span>egisters. W<span class="_ _1"></span>e changed the print loop<span class="_ _1"></span>, so that it prints out </div><div class="t m0 xd hd yd70 ff82 fs7 fc7 sc0 ls1 ws1">the results m<span class="_ _3"></span>atrix in our usual ro<span class="_ _3"></span>w order form<span class="_ _3"></span>, basically doing a ma<span class="_ _3"></span>trix </div><div class="t m0 xd hd yd71 ff82 fs7 fc7 sc0 ls1 ws1">transpose as it loops thro<span class="_ _3"></span>ugh the C matrix.</div><div class="t m0 xd h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf13d" class="pf w2 h6" data-page-no="13d"><div class="pc pc13d w2 h6"><img class="bi xc y123c w7 h28" alt="" src="bg13d.png"/><div class="t m0 x17 hd y3f ff82 fs7 fc7 sc0 ls1 ws1">305</div><div class="t m0 x1c hd y3ce ff82 fs7 fc7 sc0 ls1 ws1">In the macr<span class="_ _1"></span>o, we do the scalar multiplica<span class="_ _3"></span>tion:</div><div class="t m0 xc h18 y123d ff8b fs7 fc7 sc0 ls1 ws1">MUL \ccol\().4H, V0.4H, \bcol\().4H[0]</div><div class="t m0 x1c hd y123e ff82 fs7 fc7 sc0 ls1 ws1">which translates t<span class="_ _3"></span>o something like the following:</div><div class="t m0 xc h18 y123f ff8b fs7 fc7 sc0 ls1 ws1">MUL V6.4H, V0.4H, V3.4H[0]</div><div class="t m0 x1c hd y1240 ff82 fs7 fc7 sc0 ls1 ws1">This is multiplying each lane in <span class="ff86">V0</span> b<span class="_ _1"></span>y the s<span class="_ _0"></span>calar con<span class="_ _3"></span>tained in a specific </div><div class="t m0 xc hd y1241 ff82 fs7 fc7 sc0 ls1 ws1">lane of <span class="ff86">V3</span>. This shows how we typically access a v<span class="_ _3"></span>alue in a specific lane </div><div class="t m0 xc hd y1242 ff82 fs7 fc7 sc0 ls1 ws1">by appending [lane n<span class="_ _3"></span>umber] to the end of the register specifier<span class="_ _1"></span>—counting </div><div class="t m0 xc hd y1243 ff82 fs7 fc7 sc0 ls1 ws1">lanes from zer<span class="_ _1"></span>o.</div><div class="t m0 x36 h1f y1244 ff87 fse fc7 sc0 ls1 ws1">Note<span class="ff89"> <span class="_ _17"> </span>We added \( <span class="_ _66"></span>) after the parameter name,<span class="_ _3"></span> since otherwise  </span></div><div class="t m0 x36 h1f y1245 ff89 fse fc7 sc0 ls1 ws1">the .4H will be inc<span class="_ _3"></span>luded and the parameter won’t expand correctly<span class="_ _6"></span>.<span class="_ _3"></span> </div><div class="t m0 x36 h1f y1246 ff89 fse fc7 sc0 ls1 ws1">The \( <span class="_ _8"></span>) is just a null expression to introduce a separa<span class="_ _0"></span>tor between the </div><div class="t m0 x36 h1f y1247 ff89 fse fc7 sc0 ls1 ws1">macro parameter name and the next characters.</div><div class="t m0 xc h15 y1248 ff87 fsb fc7 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xc hd y1249 ff82 fs7 fc7 sc0 ls1 ws1">This chapter is a quick o<span class="_ _1"></span>ver<span class="_ _0"></span>view of how the NEON Coprocessor wor<span class="_ _3"></span>ks </div><div class="t m0 xc hd y124a ff82 fs7 fc7 sc0 ls1 ws1">and how to write progr<span class="_ _3"></span>ams for it. W<span class="_ _1"></span>e explained how NEON uses lanes to </div><div class="t m0 xc hd y124b ff82 fs7 fc7 sc0 ls1 ws1">perform parallel computations and a selection of the instructions av<span class="_ _3"></span>ailable </div><div class="t m0 xc hd y124c ff82 fs7 fc7 sc0 ls1 ws1">for computations<span class="_ _1"></span>. We g<span class="_ _3"></span>av<span class="_ _3"></span>e two examples, one to calcul<span class="_ _3"></span>ate the distance </div><div class="t m0 xc hd y124d ff82 fs7 fc7 sc0 ls1 ws1">between two 4D vectors and one to perfor<span class="_ _0"></span>m 3x3 ma<span class="_ _3"></span>trix multiplication </div><div class="t m0 xc hd y124e ff82 fs7 fc7 sc0 ls1 ws1">to demonstrate ho<span class="_ _3"></span>w you can easily h<span class="_ _3"></span>arness the power of the NEON </div><div class="t m0 xc hd y124f ff82 fs7 fc7 sc0 ls1 ws1">Coprocessor<span class="_ _10"></span>.</div><div class="t m0 x1c hd y1250 ff82 fs7 fc7 sc0 ls1 ws1">In Chapter <span class="fc5">14</span>, “<span class="_ _1"></span>Optimizing Code,<span class="_ _66"></span>” we’ll look at specialized instructions </div><div class="t m0 xc hd y1251 ff82 fs7 fc7 sc0 ls1 ws1">to optimize conditional logic and show ho<span class="_ _3"></span>w to optimize our upper<span class="_ _1"></span>-case </div><div class="t m0 xc hd y1252 ff82 fs7 fc7 sc0 ls1 ws1">routine<span class="_ _1"></span>.</div><div class="t m0 x40 h12 y3e8 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.503000px;bottom:153.862000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf13e" class="pf w2 h6" data-page-no="13e"><div class="pc pc13e w2 h6"><div class="t m0 xd hd y3f ff82 fs7 fc7 sc0 ls1 ws1">306</div><div class="t m0 xd h15 y186 ff87 fsb fc7 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y355 ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Compute the absolute value of a 4D vector<span class="_ _10"></span>. A 4D </div><div class="t m0 x1e hd y356 ff82 fs7 fc7 sc0 ls1 ws1">vector v<span class="_ _6"></span>, given by (a, b<span class="_ _1"></span>, c, d), has an absolute value </div><div class="t m0 x1e hd ya48 ff82 fs7 fc7 sc0 ls1 ws1">square r<span class="_ _3"></span>oot (a</div><div class="t m0 x6e h1b y1253 ff82 fsd fc7 sc0 ls1 ws1">2</div><div class="t m0 x8 hd y1254 ff82 fs7 fc7 sc0 ls1 ws1"> + b</div><div class="t m0 x4 h1b y1253 ff82 fsd fc7 sc0 ls1 ws1">2</div><div class="t m0 x27 hd y1254 ff82 fs7 fc7 sc0 ls1 ws1"> + c</div><div class="t m0 x6f h1b y1253 ff82 fsd fc7 sc0 ls1 ws1">2</div><div class="t m0 x21 hd y1254 ff82 fs7 fc7 sc0 ls1 ws1"> + d</div><div class="t m0 x50 h1b y1253 ff82 fsd fc7 sc0 ls1 ws1">2</div><div class="t m0 x47 hd y1254 ff82 fs7 fc7 sc0 ls1 ws1">).</div><div class="t m0 xc hd y1255 ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>The length of a vector is its distance from the origin, </div><div class="t m0 x1e hd y1256 ff82 fs7 fc7 sc0 ls1 ws1">the vector of all zeros<span class="_ _1"></span>. A nor<span class="_ _0"></span>maliz<span class="_ _3"></span>ed vector is a </div><div class="t m0 x1e hd y1257 ff82 fs7 fc7 sc0 ls1 ws1">vector with length 1. Normalize a vector b<span class="_ _1"></span>y dividing </div><div class="t m0 x1e hd y1258 ff82 fs7 fc7 sc0 ls1 ws1">each of its components by its len<span class="_ _3"></span>gth. M<span class="_ _3"></span>odify the </div><div class="t m0 x1e hd y1259 ff82 fs7 fc7 sc0 ls1 ws1">distance progr<span class="_ _3"></span>am to compute the normalized form </div><div class="t m0 x1e hd y125a ff82 fs7 fc7 sc0 ls1 ws1">of a vector<span class="_ _6"></span>.</div><div class="t m0 xc hd y125b ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Write a routine to calcula<span class="_ _3"></span>te the dot product of two </div><div class="t m0 x1e hd y125c ff82 fs7 fc7 sc0 ls1 ws1">4D vectors.</div><div class="t m0 xc hd y125d ff82 fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Alter the 3x3 matrix progr<span class="_ _3"></span>am to multiply 4x4 </div><div class="t m0 x1e hd y125e ff82 fs7 fc7 sc0 ls1 ws1">matrices<span class="_ _3"></span>. Mak<span class="_ _3"></span>e sure y<span class="_ _3"></span>ou verify your res<span class="_ _3"></span>ult is correct.</div><div class="t m0 xd h12 y71 ff89 fsa fc7 sc0 ls1 ws1">CHAPTER 13 <span class="_ _f"> </span> NEON COPROCESSOR</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf13f" class="pf w2 h6" data-page-no="13f"><div class="pc pc13f w2 h6"><div class="t m0 x17 hd y16a ff8d fs7 fc7 sc0 ls1 ws1">307</div><div class="t m0 xc h17 y16b ff8d fsc fc7 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff8d fsc fc7 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff8e">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff8d">,  </span></span></div><div class="t m0 xc h17 y16d ff8d fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_14</div><div class="t m0 xc ha y16e ff8f fs6 fc7 sc0 ls1 ws1">CHAPTER 14</div><div class="t m0 xc h8 y16f ff90 fs4 fc7 sc0 ls1 ws1">Optimizing Code</div><div class="t m0 xc hd y170 ff8d fs7 fc7 sc0 lse ws1">In this chapter<span class="_ _10"></span>, we will look at ways to make our upper<span class="_ _1"></span>-case ro<span class="_ _3"></span>utine more </div><div class="t m0 xc hd y171 ff8d fs7 fc7 sc0 lse ws1">efficient. W<span class="_ _1"></span>e look at some design patterns for mor<span class="_ _1"></span>e efficient conditional<span class="_ _0"></span> </div><div class="t m0 xc hd y172 ff8d fs7 fc7 sc0 lse ws1">statements<span class="_ _1"></span>, as well as s<span class="_ _0"></span>ome new ARM instructions that c<span class="_ _3"></span>an simplify our code<span class="_ _3"></span>.</div><div class="t m0 x1c hd y173 ff8d fs7 fc7 sc0 ls1 ws1">Optimizing code often involves thinkin<span class="_ _3"></span>g outside the box and going </div><div class="t m0 xc hd y174 ff8d fs7 fc7 sc0 ls1 ws1">beyond finding ways to r<span class="_ _1"></span>emove one or two instructions in a loop; we’ll look </div><div class="t m0 xc hd y175 ff8d fs7 fc7 sc0 ls1 ws1">at a couple of no<span class="_ _3"></span>vel ways to gr<span class="_ _1"></span>eatly impro<span class="_ _3"></span>ve the upper<span class="_ _1"></span>-case routine.</div><div class="t m0 x1c hd y176 ff8d fs7 fc7 sc0 ls1 ws1">First of all, we<span class="_ _3"></span>’ll look at a trick to simplify the main if sta<span class="_ _3"></span>tement.</div><div class="t m0 xc h15 y125f ff91 fsb fc7 sc0 ls1 ws1"> <span class="_ _e"></span>Optimizing theUpper<span class="_ _6"></span>-Case Routine</div><div class="t m0 xc hd y1260 ff8d fs7 fc7 sc0 ls1 ws1">Our original upper<span class="_ _1"></span>-case routine implemen<span class="_ _3"></span>ts the pseudo-code:</div><div class="t m0 xc h18 y1261 ff92 fs7 fc7 sc0 ls1 ws1">IF (W5 &gt;= &apos;a&apos;) AND (W5 &lt;= &apos;z&apos;) THEN</div><div class="t m0 xc h18 y1262 ff92 fs7 fc7 sc0 ls1 ws1">     W5 = W5 - (&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xc h18 y1263 ff92 fs7 fc7 sc0 ls1 ws1">END IF</div><div class="t m0 x1c hd y1264 ff8d fs7 fc7 sc0 ls1 ws1">with the following Assembly code:</div><div class="t m0 xc h18 y1265 ff92 fs7 fc7 sc0 ls1 ws1">// If W5 &gt; &apos;z&apos; then goto cont</div><div class="t m0 xc h18 y1266 ff92 fs7 fc7 sc0 ls1 ws1">       CMP   W5, #&apos;z&apos;         // is letter &gt; &apos;z&apos;?</div><div class="t m0 xc h18 y1267 ff92 fs7 fc7 sc0 ls1 ws1">       B.GT  cont</div><div class="t m0 xc h18 y1268 ff92 fs7 fc7 sc0 ls1 ws1">// Else if W5 &lt; &apos;a&apos; then goto end if</div><div class="t m0 xc h18 y1269 ff92 fs7 fc7 sc0 ls1 ws1">       CMP   W5, #&apos;a&apos;</div><div class="t m0 xc h18 y126a ff92 fs7 fc7 sc0 ls1 ws1">       B.LT  cont   // goto to end if, if &lt; &apos;a&apos;</div><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:168.835000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf140" class="pf w2 h6" data-page-no="140"><div class="pc pc140 w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">308</div><div class="t m0 xd h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">// if we got here then the letter is lower case, so convert it.</div><div class="t m0 xd h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">       SUB   W5, W5, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xd h18 y46d ff92 fs7 fc7 sc0 ls1 ws1">cont:  // end if</div><div class="t m0 xc hd y46e ff8d fs7 fc7 sc0 ls1 ws1">This code implements the r<span class="_ _3"></span>everse logic of branching ar<span class="_ _1"></span>ound the <span class="ff93 ls1c wsbf">SUB</span> </div><div class="t m0 xd hd y46f ff8d fs7 fc7 sc0 ls1 ws1">instruction if <span class="ff93">W5</span> &lt; ‘<span class="_ _6"></span>a<span class="_ _1"></span>’ or <span class="ff93">W5</span> &gt; ‘z’<span class="_ _2d"></span>. This was fine for a chapter teaching </div><div class="t m0 xd hd y85d ff8d fs7 fc7 sc0 ls1 ws1">branch instructions<span class="_ _3"></span>, since it demonstrated two of them<span class="_ _3"></span>. However<span class="_ _10"></span>, in this </div><div class="t m0 xd hd y983 ff8d fs7 fc7 sc0 ls1 ws1">chapter<span class="_ _10"></span>, we look at eliminating branches entir<span class="_ _1"></span>ely, so let<span class="_ _0"></span>’<span class="_ _6"></span>s see how we can </div><div class="t m0 xd hd y984 ff8d fs7 fc7 sc0 ls1 ws1">impro<span class="_ _1"></span>ve this code one step at a time.</div><div class="t m0 xd ha ybca ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>Simplifying theRange Comparison</div><div class="t m0 xd hd y126b ff8d fs7 fc7 sc0 ls1 ws1">A common way to simplify r<span class="_ _1"></span>ange comparis<span class="_ _0"></span>ons is to shift the r<span class="_ _3"></span>ange, so we </div><div class="t m0 xd hd y126c ff8d fs7 fc7 sc0 ls1 ws1">don’t need a lower comparison. If we subtract ‘<span class="_ _6"></span>a<span class="_ _1"></span>’ from everything, then our </div><div class="t m0 xd hd y126d ff8d fs7 fc7 sc0 ls1 ws1">pseudo-code becomes</div><div class="t m0 xd h18 y126e ff92 fs7 fc7 sc0 ls1 ws1">W6 = W5 - &apos;a&apos;</div><div class="t m0 xd h18 y126f ff92 fs7 fc7 sc0 ls1 ws1">IF (W6 &gt;= 0) AND W6 &lt;= (&apos;z&apos;-&apos;a&apos;) THEN</div><div class="t m0 xd h18 y1270 ff92 fs7 fc7 sc0 ls1 ws1">     W5 = W5 - (&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xd h18 y1271 ff92 fs7 fc7 sc0 ls1 ws1">END IF</div><div class="t m0 xc hd y1272 ff8d fs7 fc7 sc0 ls1 ws1">If we treat <span class="ff93">W6</span> as an unsi<span class="_ _3"></span>gned integer<span class="_ _6"></span>, then the first comparison does </div><div class="t m0 xd hd y1273 ff8d fs7 fc7 sc0 ls1 ws1">nothing, since all unsigned integers ar<span class="_ _3"></span>e grea<span class="_ _3"></span>ter than 0. In this c<span class="_ _3"></span>ase, we </div><div class="t m0 xd hd y1274 ff8d fs7 fc7 sc0 ls1 ws1">simplified our range fr<span class="_ _1"></span>om tw<span class="_ _0"></span>o comparisons to one comparison that <span class="ff93">W6</span>  </div><div class="t m0 xd hd y1275 ff8d fs7 fc7 sc0 ls1 ws1">&lt;= (‘<span class="_ _1"></span>z<span class="_ _0"></span>’-’<span class="_ _10"></span>a<span class="_ _1"></span>’). T<span class="_ _1"></span>o understand why we use two r<span class="_ _3"></span>egisters here<span class="_ _1"></span>, s<span class="_ _0"></span>ee Exercise 1in </div><div class="t m0 xd hd y1276 ff8d fs7 fc7 sc0 ls1 ws1">this chapter<span class="_ _10"></span>.</div><div class="t m0 xc hd y1277 ff8d fs7 fc7 sc0 ls1 ws1">This leads us to the first impr<span class="_ _3"></span>oved version of o<span class="_ _3"></span>ur upper<span class="_ _6"></span>.s file. This new </div><div class="t m0 xd hd y1278 ff8d fs7 fc7 sc0 ls1 ws1">upper<span class="_ _6"></span>.s is shown in Listing <span class="fc5">14-1</span>.</div><div class="t m0 xd h20 yb63 ff94 fs3 fc7 sc0 ls1 ws1">Listing 14-1. <span class="_ _15"> </span><span class="ff8d">Upper<span class="_ _1"></span>-case routine with simplified r<span class="_ _3"></span>ange comparison</span></div><div class="t m0 xd h18 y1279 ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y127a ff92 fs7 fc7 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xd h18 y127b ff92 fs7 fc7 sc0 ls1 ws1">// all upper case.</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf140" data-dest-detail='[320,"XYZ",35,155,null]'><div class="d m1" style="border-style:none;position:absolute;left:161.904000px;bottom:169.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf141" class="pf w2 h6" data-page-no="141"><div class="pc pc141 w2 h6"><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">309</div><div class="t m0 xc h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xc h18 y46d ff92 fs7 fc7 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xc h18 y623 ff92 fs7 fc7 sc0 ls1 ws1">// X4 - original output string for length calc.</div><div class="t m0 xc h18 y624 ff92 fs7 fc7 sc0 ls1 ws1">// W5 - current character being processed</div><div class="t m0 xc h18 y625 ff92 fs7 fc7 sc0 ls1 ws1">// W6 - minus &apos;a&apos; to compare &lt; 26.</div><div class="t m0 xc h18 y626 ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y847 ff92 fs7 fc7 sc0 ls1 ws1">.global toupper      // Allow other files to call this routine</div><div class="t m0 xc h18 y912 ff92 fs7 fc7 sc0 ls1 ws1">toupper: MOV   X4, X1</div><div class="t m0 xc h18 yb68 ff92 fs7 fc7 sc0 ls1 ws1">// The loop is until byte pointed to by X1 is non-zero</div><div class="t m0 xc h18 yb69 ff92 fs7 fc7 sc0 ls1 ws1">loop:  LDRB    W5, [X0], #1     //  <span class="_ _20"></span>load char and increment </div><div class="t m0 x70 h18 y127c ff92 fs7 fc7 sc0 ls1 ws1">pointer</div><div class="t m0 xc h18 y84c ff92 fs7 fc7 sc0 ls1 ws1">// Want to know if &apos;a&apos; &lt;= W5 &lt;= &apos;z&apos;</div><div class="t m0 xc h18 y62d ff92 fs7 fc7 sc0 ls1 ws1">// First subtract &apos;a&apos;</div><div class="t m0 xc h18 y84d ff92 fs7 fc7 sc0 ls1 ws1">       SUB     W6, W5, #&apos;a&apos;</div><div class="t m0 xc h18 y84e ff92 fs7 fc7 sc0 ls1 ws1">// Now want to know if W6 &lt;= 25</div><div class="t m0 xc h18 y84f ff92 fs7 fc7 sc0 ls1 ws1">       CMP     W6, #25          // chars are 0-25 after shift</div><div class="t m0 xc h18 y850 ff92 fs7 fc7 sc0 ls1 ws1">       B.HI   cont</div><div class="t m0 xc h18 y851 ff92 fs7 fc7 sc0 ls1 ws1">// if we got here then the letter is lower case, so convert it.</div><div class="t m0 xc h18 y852 ff92 fs7 fc7 sc0 ls1 ws1">       SUB     W5, W5, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xc h18 y853 ff92 fs7 fc7 sc0 ls1 ws1">cont:  // end if</div><div class="t m0 xc h18 y854 ff92 fs7 fc7 sc0 ls12 ws1">       STRB    W5, [X1], #1     // store character to output str</div><div class="t m0 xc h18 y855 ff92 fs7 fc7 sc0 ls1 ws1">       CMP     W5, #0           //  <span class="_ _20"></span>stop on hitting a null </div><div class="t m0 x70 h18 y856 ff92 fs7 fc7 sc0 ls1 ws1">character</div><div class="t m0 xc h18 y857 ff92 fs7 fc7 sc0 ls1 ws1">       B.NE    loop             // loop if character isn&apos;t null</div><div class="t m0 xc h18 y858 ff92 fs7 fc7 sc0 ls1 ws1">       SUB     X0, X1, X4       //  <span class="_ _20"></span>get the len by sub&apos;ing the </div><div class="t m0 x70 h18 y859 ff92 fs7 fc7 sc0 ls1 ws1">pointers</div><div class="t m0 xc h18 y85a ff92 fs7 fc7 sc0 ls1 ws1">       RET                      // Return to caller</div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf142" class="pf w2 h6" data-page-no="142"><div class="pc pc142 w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">310</div><div class="t m0 xc hd y145 ff8d fs7 fc7 sc0 ls1 ws1">All the examples in this chapter use the same main.s fr<span class="_ _1"></span>om Listing <span class="fc5">6-3</span>,  </div><div class="t m0 xd hd y146 ff8d fs7 fc7 sc0 ls1 ws1">except the third one<span class="_ _1"></span>, which skips needing a main.s. Listing <span class="fc5">14-2</span> is a </div><div class="t m0 xd hd y147 ff8d fs7 fc7 sc0 ls1 ws1">makefile for all the code in this chapt<span class="_ _3"></span>er<span class="_ _6"></span>. Comment out any pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>ams that </div><div class="t m0 xd hd y1b0 ff8d fs7 fc7 sc0 ls1 ws1">you ha<span class="_ _1"></span>ven’t gotten to yet, or you will get a compile error<span class="_ _10"></span>.</div><div class="t m0 xd h20 y6cc ff94 fs3 fc7 sc0 ls1 ws1">Listing 14-2. <span class="_ _15"> </span><span class="ff8d">Mak<span class="_ _3"></span>efile for the upper<span class="_ _1"></span>-case routine version in this </span></div><div class="t m0 xd h20 y127d ff8d fs3 fc7 sc0 ls26 wsca">chapter</div><div class="t m0 xd h18 y127e ff92 fs7 fc7 sc0 ls1 ws1">UPPEROBJS = main.o upper.o</div><div class="t m0 xd h18 y127f ff92 fs7 fc7 sc0 ls1 ws1">UPPER2OBJS = main.o upper2.o</div><div class="t m0 xd h18 y1280 ff92 fs7 fc7 sc0 ls1 ws1">UPPER3OBJS = upper3.o</div><div class="t m0 xd h18 y1281 ff92 fs7 fc7 sc0 ls1 ws1">UPPER4OBJS = main.o upper4.o</div><div class="t m0 xd h18 y1282 ff92 fs7 fc7 sc0 ls1 ws1">ifdef DEBUG</div><div class="t m0 xd h18 y1283 ff92 fs7 fc7 sc0 ls1 ws1">DEBUGFLGS = -g</div><div class="t m0 xd h18 y1284 ff92 fs7 fc7 sc0 ls1 ws1">else</div><div class="t m0 xd h18 y1285 ff92 fs7 fc7 sc0 ls1 ws1">DEBUGFLGS =</div><div class="t m0 xd h18 y1286 ff92 fs7 fc7 sc0 ls1 ws1">endif</div><div class="t m0 xd h18 y1287 ff92 fs7 fc7 sc0 ls1 ws1">LSTFLGS =</div><div class="t m0 xd h18 y1288 ff92 fs7 fc7 sc0 ls1 ws1">all: upper upper2 upper3 upper4</div><div class="t m0 xd h18 y1289 ff92 fs7 fc7 sc0 ls1 ws1">%.o : %.s</div><div class="t m0 xd h18 y128a ff92 fs7 fc7 sc0 ls1 ws1">     as $(DEBUGFLGS) $(LSTFLGS) $&lt; -o $@</div><div class="t m0 xd h18 y128b ff92 fs7 fc7 sc0 ls1 ws1">upper: $(UPPEROBJS)</div><div class="t m0 xd h18 y128c ff92 fs7 fc7 sc0 ls1 ws1">     ld -o upper $(UPPEROBJS)</div><div class="t m0 xd h18 y128d ff92 fs7 fc7 sc0 ls1 ws1">upper2: $(UPPER2OBJS)</div><div class="t m0 xd h18 y128e ff92 fs7 fc7 sc0 ls1 ws1">     ld -o upper2 $(UPPER2OBJS)</div><div class="t m0 xd h18 y128f ff92 fs7 fc7 sc0 ls1 ws1">upper3: $(UPPER3OBJS)</div><div class="t m0 xd h18 y1290 ff92 fs7 fc7 sc0 ls1 ws1">     ld -o upper3 $(UPPER3OBJS)</div><div class="t m0 xd h18 y1291 ff92 fs7 fc7 sc0 ls1 ws1">upper4: $(UPPER4OBJS)</div><div class="t m0 xd h18 y1292 ff92 fs7 fc7 sc0 ls1 ws1">     ld -o upper4 $(UPPER4OBJS)</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pfa0" data-dest-detail='[160,"XYZ",35,238,null]'><div class="d m1" style="border-style:none;position:absolute;left:358.816000px;bottom:577.362000px;width:15.048000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf142" data-dest-detail='[322,"XYZ",35,516,null]'><div class="d m1" style="border-style:none;position:absolute;left:309.995000px;bottom:561.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf143" class="pf w2 h6" data-page-no="143"><div class="pc pc143 w2 h6"><img class="bi xc y1293 w7 h24" alt="" src="bg143.png"/><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">311</div><div class="t m0 x1c hd y38c ff8d fs7 fc7 sc0 ls1 ws1">This is an impr<span class="_ _3"></span>ovement and a gr<span class="_ _1"></span>eat optimization to use when you need </div><div class="t m0 xc hd y38d ff8d fs7 fc7 sc0 ls1 ws1">range comparisons<span class="_ _3"></span>. Let&apos;s use a conditional instruction to remove another </div><div class="t m0 xc hd y4ae ff8d fs7 fc7 sc0 ls1 ws1">branch<span class="_ _3"></span>.</div><div class="t m0 xc ha y1294 ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>Using aConditional Instruction</div><div class="t m0 xc hd y1295 ff8d fs7 fc7 sc0 ls1 ws1">The ARM processor has a h<span class="_ _3"></span>andful of instructions that help elimina<span class="_ _3"></span>te </div><div class="t m0 xc hd y1296 ff8d fs7 fc7 sc0 ls1 ws1">branch instructions<span class="_ _3"></span>. First of all, consider condition<span class="_ _3"></span>al select<span class="_ _0"></span>:</div><div class="t m0 x1e hd y1297 ff8d fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>CSEL Xd, Xn, Xm, cond</div><div class="t m0 x1c hd y1298 ff8d fs7 fc7 sc0 ls1 ws1">This statement im<span class="_ _3"></span>plements</div><div class="t m0 xc h18 y1299 ff92 fs7 fc7 sc0 ls1 ws1">IF cond is true then</div><div class="t m0 xc h18 y129a ff92 fs7 fc7 sc0 ls1 ws1">     Xd = Xn</div><div class="t m0 xc h18 y129b ff92 fs7 fc7 sc0 ls1 ws1">else</div><div class="t m0 xc h18 y129c ff92 fs7 fc7 sc0 ls1 ws1">     Xd = Xm</div><div class="t m0 x1c hd y129d ff8d fs7 fc7 sc0 ls1 ws1">This is like the C conditional oper<span class="_ _3"></span>ator<span class="_ _10"></span>, as follows<span class="_ _0"></span>:</div><div class="t m0 xc h18 y129e ff92 fs7 fc7 sc0 ls1 ws1">Xd = cond ? Xn : Xm</div><div class="t m0 x36 h5a y129f ff91 fse fc7 sc0 ls1 ws1">Note<span class="ff95"> <span class="_ _17"> </span>Y<span class="_ _6"></span>ou can use either <span class="ff96">W</span> or <span class="ff96">X</span> registers with the <span class="ff96">CSEL</span> </span></div><div class="t m0 x36 h1f y12a0 ff95 fse fc7 sc0 ls1 ws1">instruction,<span class="_ _1"></span> but all the registers must be the same type.</div><div class="t m0 x1c hd y12a1 ff8d fs7 fc7 sc0 lsb wsb4">The<span class="ls1 ws1">re are a few v<span class="_ _3"></span>ariations on this instruction; a typical one is </span></div><div class="t m0 xc hd y12a2 ff8d fs7 fc7 sc0 ls1 ws1">conditional select increment<span class="_ _0"></span>:</div><div class="t m0 x1e hd y12a3 ff8d fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>CSINC Xd, Xn, Xm, cond</div><div class="t m0 x1c hd y12a4 ff8d fs7 fc7 sc0 ls1 ws1">which implements</div><div class="t m0 xc h18 y12a5 ff92 fs7 fc7 sc0 ls1 ws1">IF condition is true then</div><div class="t m0 xc h18 y12a6 ff92 fs7 fc7 sc0 ls1 ws1">     Xd = Xn</div><div class="t m0 xc h18 y12a7 ff92 fs7 fc7 sc0 ls1 ws1">else</div><div class="t m0 xc h18 y12a8 ff92 fs7 fc7 sc0 ls1 ws1">     Xd = Xm + 1</div><div class="t m0 x1c hd y12a9 ff8d fs7 fc7 sc0 ls1 ws1">Next<span class="_ _3"></span>, we’ll use <span class="ff93">CSEL</span> to replace another branc<span class="_ _3"></span>h instruction.</div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf144" class="pf w2 h6" data-page-no="144"><div class="pc pc144 w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">312</div><div class="t m0 xd h2a y409 ff91 fsf fc7 sc0 ls1 wsbb"> Example <span class="_ _1b"> </span>withCSEL</div><div class="t m0 xd hd y40a ff8d fs7 fc7 sc0 ls1 ws1">Listing <span class="fc5">14-3</span> is our upper<span class="_ _1"></span>-case routine modified to use a <span class="ff93">CSEL</span> instruction, </div><div class="t m0 xd hd y40b ff8d fs7 fc7 sc0 ls1 ws1">eliminating another br<span class="_ _3"></span>anch instruction, which should be placed in the file </div><div class="t m0 xd hd y40c ff8d fs7 fc7 sc0 ls1 ws1">upper2.s.</div><div class="t m0 xd h20 y12aa ff94 fs3 fc7 sc0 ls1 ws1">Listing 14-3. <span class="_ _15"> </span><span class="ff8d">Upper<span class="_ _1"></span>-case routine us<span class="_ _3"></span>ing a conditional <span class="ff93">CSEL</span> </span></div><div class="t m0 xd h20 y12ab ff8d fs3 fc7 sc0 ls1 ws1">instruction</div><div class="t m0 xd h18 y12ac ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y12ad ff92 fs7 fc7 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xd h18 y12ae ff92 fs7 fc7 sc0 ls1 ws1">// all upper case.</div><div class="t m0 xd h18 y12af ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y12b0 ff92 fs7 fc7 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xd h18 y12b1 ff92 fs7 fc7 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xd h18 y12b2 ff92 fs7 fc7 sc0 ls1 ws1">// X4 - original output string for length calc.</div><div class="t m0 xd h18 y12b3 ff92 fs7 fc7 sc0 ls1 ws1">// W5 - current character being processed</div><div class="t m0 xd h18 y12b4 ff92 fs7 fc7 sc0 ls1 ws1">// W6 - minus &apos;a&apos; to compare &lt; 26.</div><div class="t m0 xd h18 y12b5 ff92 fs7 fc7 sc0 ls1 ws1">// W6 - char minus 0x20, potential upper-cased</div><div class="t m0 xd h18 y12b6 ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y12b7 ff92 fs7 fc7 sc0 ls1 ws1">.global toupper          //  <span class="_ _20"></span>Allow other files to call this </div><div class="t m0 x21 h18 y12b8 ff92 fs7 fc7 sc0 ls1 ws1">routine</div><div class="t m0 xd h18 y12b9 ff92 fs7 fc7 sc0 ls1 ws1">toupper:</div><div class="t m0 xd h18 y12ba ff92 fs7 fc7 sc0 ls1 ws1">       MOV   X4, X1</div><div class="t m0 xd h18 y12bb ff92 fs7 fc7 sc0 ls1 ws1">// The loop is until byte pointed to by R1 is non-zero</div><div class="t m0 xd h18 y12bc ff92 fs7 fc7 sc0 ls1 ws1">loop:  LDRB  W5, [X0], #1  // load char and increment pointer</div><div class="t m0 xd h18 y12bd ff92 fs7 fc7 sc0 ls1 ws1">// Want to know if &apos;a&apos; &lt;= W5 &lt;= &apos;z&apos;</div><div class="t m0 xd h18 y12be ff92 fs7 fc7 sc0 ls1 ws1">// First subtract &apos;a&apos;</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf144" data-dest-detail='[324,"XYZ",35,504,null]'><div class="d m1" style="border-style:none;position:absolute;left:70.055400px;bottom:549.759000px;width:20.548000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf145" class="pf w2 h6" data-page-no="145"><div class="pc pc145 w2 h6"><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">313</div><div class="t m0 xc h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">       SUB   W6, W5, #&apos;a&apos;</div><div class="t m0 xc h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">// Now want to know if W6 &lt;= 25</div><div class="t m0 xc h18 y46d ff92 fs7 fc7 sc0 ls1 ws1">       CMP   W6, #25           // chars are 0-25 after shift</div><div class="t m0 xc h18 y623 ff92 fs7 fc7 sc0 ls1 ws1">// perform lower case conversion to W6</div><div class="t m0 xc h18 y624 ff92 fs7 fc7 sc0 ls1 ws1">       SUB   W6, W5, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 xc h18 y625 ff92 fs7 fc7 sc0 ls1 ws1">// Use W6 if lower case, otherwise use original character in W5</div><div class="t m0 xc h18 y626 ff92 fs7 fc7 sc0 ls1 ws1">       CSEL   W5, W6, W5, LS</div><div class="t m0 xc h18 y627 ff92 fs7 fc7 sc0 ls1 ws1">       STRB  W5, [X1], #1      // store character to output str</div><div class="t m0 xc h18 y628 ff92 fs7 fc7 sc0 ls1 ws1">       CMP   W5, #0            //  <span class="_ _20"></span>stop on hitting a null </div><div class="t m0 x42 h18 y9f6 ff92 fs7 fc7 sc0 ls1 ws1">character</div><div class="t m0 xc h18 y9f7 ff92 fs7 fc7 sc0 ls1 ws1">       B.NE  loop              // loop if character isn&apos;t null</div><div class="t m0 xc h18 y9f8 ff92 fs7 fc7 sc0 ls1 ws1">       SUB   X0, X1, X4        //  <span class="_ _20"></span>get the len by sub&apos;ing the </div><div class="t m0 x42 h18 yb8d ff92 fs7 fc7 sc0 ls1 ws1">pointers</div><div class="t m0 xc h18 yb8e ff92 fs7 fc7 sc0 ls1 ws1">       RET                     // Return to caller</div><div class="t m0 x1c hd y9fb ff8d fs7 fc7 sc0 ls1 ws1">In this example<span class="_ _3"></span>, we perform</div><div class="t m0 xc h18 yc3f ff92 fs7 fc7 sc0 ls1 ws1">SUB   W6, W5, #(&apos;a&apos;-&apos;A&apos;)</div><div class="t m0 x1c hd y84f ff8d fs7 fc7 sc0 ls1 ws1">into a differ<span class="_ _3"></span>ent res<span class="_ _3"></span>ult register <span class="ff93">W6</span>. N<span class="_ _1"></span>ow, we have the original ch<span class="_ _3"></span>aracter </div><div class="t m0 xc hd y850 ff8d fs7 fc7 sc0 ls1 ws1">in <span class="ff93">W5</span> and the converted char<span class="_ _3"></span>acter in <span class="ff93">W6</span>. W<span class="_ _1"></span>e perfor<span class="_ _0"></span>m</div><div class="t m0 xc h18 y1176 ff92 fs7 fc7 sc0 ls1 ws1">CSEL   W5, W6, W5, LS</div><div class="t m0 x1c hd y864 ff8d fs7 fc7 sc0 ls1 ws1">This places <span class="ff93">W6</span> into <span class="ff93">W5</span> if the <span class="ff93 ls24 wsc2">LS</span> condition is true—the char<span class="_ _3"></span>acter is </div><div class="t m0 xc hd y865 ff8d fs7 fc7 sc0 ls1 ws1">an alphabetic lower<span class="_ _1"></span>-case character<span class="_ _10"></span>, else it puts <span class="ff93">W5</span> into <span class="ff93">W5</span>—the original </div><div class="t m0 xc hd y866 ff8d fs7 fc7 sc0 ls1 ws1">character<span class="_ _10"></span>.</div><div class="t m0 x1c hd y867 ff8d fs7 fc7 sc0 ls1 ws1">This code is more structur<span class="_ _1"></span>e<span class="_ _0"></span>d; it isn’t a spaghet<span class="_ _3"></span>ti of branch instructions<span class="_ _3"></span>. </div><div class="t m0 xc hd y868 ff8d fs7 fc7 sc0 ls1 ws1">Once you are used to using these opera<span class="_ _3"></span>tors, follo<span class="_ _3"></span>wing the logic is easier<span class="_ _6"></span>. </div><div class="t m0 xc hd y104d ff8d fs7 fc7 sc0 ls1 ws1">This sequence is easier on the execution pipeline, since br<span class="_ _3"></span>anch prediction </div><div class="t m0 xc hd yfb3 ff8d fs7 fc7 sc0 ls1 ws1">isn’t requir<span class="_ _3"></span>ed to keep things movin<span class="_ _3"></span>g.</div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf146" class="pf w2 h6" data-page-no="146"><div class="pc pc146 w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">314</div><div class="t m0 xd ha y248 ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>Restricting theProblem Domain</div><div class="t m0 xd hd y249 ff8d fs7 fc7 sc0 ls1 ws1">The best optimizations of code arise from r<span class="_ _3"></span>estricting the problem dom<span class="_ _3"></span>ain. </div><div class="t m0 xd hd y24a ff8d fs7 fc7 sc0 ls1 ws1">If we are only dealing with alphabetic ch<span class="_ _3"></span>aracters<span class="_ _1"></span>, w<span class="_ _0"></span>e can elimin<span class="_ _3"></span>ate the </div><div class="t m0 xd hd y24b ff8d fs7 fc7 sc0 ls1 ws1">range comparison entir<span class="_ _3"></span>ely. In A<span class="_ _3"></span>ppendix D<span class="_ _3"></span>, “<span class="_ _10"></span>ASCII Character Set,<span class="_ _66"></span>” the only </div><div class="t m0 xd hd y5ad ff8d fs7 fc7 sc0 ls1 ws1">difference between upper<span class="_ _1"></span>- and lower<span class="_ _1"></span>-case letters is that lower<span class="_ _1"></span>-case letters </div><div class="t m0 xd hd y5ae ff8d fs7 fc7 sc0 ls1 ws1">ha<span class="_ _3"></span>ve the 0x20 bit set, where<span class="_ _3"></span>as upper<span class="_ _1"></span>-case letters do not. This means we </div><div class="t m0 xd hd y7f6 ff8d fs7 fc7 sc0 ls1 ws1">convert a lower<span class="_ _1"></span>-case letter to upper<span class="_ _1"></span>-case by performing a bit clear (<span class="ff93 ls1f wsc7">BIC</span>) </div><div class="t m0 xd hd y805 ff8d fs7 fc7 sc0 ls1 ws1">operation on th<span class="_ _3"></span>at bit. If we do this to special char<span class="_ _3"></span>acters, it will corrupt the </div><div class="t m0 xd hd y45d ff8d fs7 fc7 sc0 ls1 ws1">bits of quite a few of them.</div><div class="t m0 xc hd y45e ff8d fs7 fc7 sc0 ls1 ws1">Often in computing, we wan<span class="_ _3"></span>t code to be case insensitive, meaning </div><div class="t m0 xd hd y109a ff8d fs7 fc7 sc0 ls1 ws1">that you c<span class="_ _3"></span>an enter any combin<span class="_ _3"></span>ation of case<span class="_ _3"></span>. The Assembler does this<span class="_ _3"></span>, so it </div><div class="t m0 xd hd y109b ff8d fs7 fc7 sc0 ls1 ws1">doesn’t care if we ent<span class="_ _3"></span>er <span class="ff93 lsb wsb4">MOV</span> or <span class="ff93 ls21 wsbe">mov</span>. Similarly, many computer l<span class="_ _3"></span>anguages </div><div class="t m0 xd hd y12bf ff8d fs7 fc7 sc0 ls1 ws1">are case insensitive<span class="_ _1"></span>, s<span class="_ _0"></span>o you c<span class="_ _3"></span>an enter variable names in an<span class="_ _3"></span>y combination </div><div class="t m0 xd hd y12c0 ff8d fs7 fc7 sc0 ls1 ws1">of upper<span class="_ _1"></span>- and lower<span class="_ _3"></span>-case and it means the same thing. M<span class="_ _1"></span>achine learning </div><div class="t m0 xd hd y12c1 ff8d fs7 fc7 sc0 ls1 ws1">algorithms that pr<span class="_ _3"></span>ocess text always con<span class="_ _1"></span>ver<span class="_ _0"></span>t them into a s<span class="_ _3"></span>tandard form, </div><div class="t m0 xd hd y12c2 ff8d fs7 fc7 sc0 ls1 ws1">usually thro<span class="_ _3"></span>wing awa<span class="_ _3"></span>y all punctuation and con<span class="_ _3"></span>verting them to all one case. </div><div class="t m0 xd hd y12c3 ff8d fs7 fc7 sc0 ls1 ws1">For<span class="_ _1"></span>cing this standardization sa<span class="_ _1"></span>ves a lot of extra processing la<span class="_ _3"></span>ter<span class="_ _6"></span>.</div><div class="t m0 xc hd y12c4 ff8d fs7 fc7 sc0 ls1 ws1">Let&apos;s look at an implementation of this for our code<span class="_ _3"></span>. Listing <span class="fc5">14-4</span> goes </div><div class="t m0 xd hd y12c5 ff8d fs7 fc7 sc0 ls1 ws1">in upper3.s.</div><div class="t m0 xd h20 y12c6 ff94 fs3 fc7 sc0 ls1 ws1">Listing 14-4. <span class="_ _15"> </span><span class="ff8d">Upper<span class="_ _1"></span>-case routine as a m<span class="_ _1"></span>acro<span class="_ _1"></span>, using BIC for </span></div><div class="t m0 xd h20 y12c7 ff8d fs3 fc7 sc0 ls1 ws1">alphabetic char<span class="_ _1"></span>acters only</div><div class="t m0 xd h18 y12c8 ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y12c9 ff92 fs7 fc7 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xd h18 y12ca ff92 fs7 fc7 sc0 ls1 ws1">// all upper case. Assumes only alphabetic</div><div class="t m0 xd h18 y12cb ff92 fs7 fc7 sc0 ls1 ws1">// characters. Uses bit clear blindly without</div><div class="t m0 xd h18 y12cc ff92 fs7 fc7 sc0 ls1 ws1">// checking if character is alphabetic or not.</div><div class="t m0 xd h18 y12cd ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xd h18 y12ce ff92 fs7 fc7 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xd h18 y12cf ff92 fs7 fc7 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf146" data-dest-detail='[326,"XYZ",35,263,null]'><div class="d m1" style="border-style:none;position:absolute;left:331.064000px;bottom:292.518000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf147" class="pf w2 h6" data-page-no="147"><div class="pc pc147 w2 h6"><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">315</div><div class="t m0 xc h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">// X2 - original output string for length calc.</div><div class="t m0 xc h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">// W3 - current character being processed</div><div class="t m0 xc h18 y46d ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y85c ff92 fs7 fc7 sc0 ls1 ws1">.global _start       // Provide program starting address</div><div class="t m0 xc h18 y11fb ff92 fs7 fc7 sc0 ls1 ws1">.MACRO toupper inputstr, outputstr</div><div class="t m0 xc h18 y12d0 ff92 fs7 fc7 sc0 ls1 ws1">      LDR    X0, =\inputstr       // start of input string</div><div class="t m0 xc h18 y12d1 ff92 fs7 fc7 sc0 ls1 ws1">      LDR    X1, =\outputstr      // address of output string</div><div class="t m0 xc h18 y911 ff92 fs7 fc7 sc0 ls1 ws1">      MOV    X2, X1</div><div class="t m0 xc h18 y912 ff92 fs7 fc7 sc0 ls1 ws1">// The loop is until byte pointed to by R1 is non-zero</div><div class="t m0 xc h18 yb68 ff92 fs7 fc7 sc0 ls1 ws1">loop:  LDRB  W3, [X0], #1         //  <span class="_ _20"></span>load char and increment </div><div class="t m0 x72 h18 yb69 ff92 fs7 fc7 sc0 ls1 ws1">pointer</div><div class="t m0 xc h18 y127c ff92 fs7 fc7 sc0 ls1 ws1">       BIC   W3, W3, #0x20        //  <span class="_ _20"></span>kill bit that makes it </div><div class="t m0 x72 h18 y84c ff92 fs7 fc7 sc0 ls1 ws1">lower case</div><div class="t m0 xc h18 y62d ff92 fs7 fc7 sc0 ls1 ws1">       STRB  W3, [X1], #1         //  <span class="_ _20"></span>store character to output </div><div class="t m0 x72 h18 y84d ff92 fs7 fc7 sc0 ls1 ws1">str</div><div class="t m0 xc h18 y84e ff92 fs7 fc7 sc0 ls1 ws1">       CMP   W3, #0               //  <span class="_ _20"></span>stop on hitting a null </div><div class="t m0 x72 h18 y84f ff92 fs7 fc7 sc0 ls1 ws1">character</div><div class="t m0 xc h18 y850 ff92 fs7 fc7 sc0 ls1 ws1">       B.NE  loop                 //  <span class="_ _20"></span>loop if character isn&apos;t </div><div class="t m0 x72 h18 y851 ff92 fs7 fc7 sc0 ls1 ws1">null</div><div class="t m0 xc h18 y852 ff92 fs7 fc7 sc0 ls1 ws1">       SUB   X0, X1, X2           //  <span class="_ _20"></span>get the len by sub&apos;ing the </div><div class="t m0 x72 h18 y853 ff92 fs7 fc7 sc0 ls1 ws1">pointers</div><div class="t m0 xc h18 y854 ff92 fs7 fc7 sc0 ls1 ws1">.ENDM</div><div class="t m0 xc h18 yefa ff92 fs7 fc7 sc0 ls1 ws1">_start:</div><div class="t m0 xc h18 yefb ff92 fs7 fc7 sc0 ls1 ws1">       toupper      instr, outstr</div><div class="t m0 xc h18 y104d ff92 fs7 fc7 sc0 ls1 ws1">// Setup the parameters to print our hex number</div><div class="t m0 xc h18 yfb3 ff92 fs7 fc7 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 ya1a ff92 fs7 fc7 sc0 ls1 ws1">      MOV    X2,X0           //  <span class="_ _20"></span>return code is the length of </div><div class="t m0 x30 h18 yfb4 ff92 fs7 fc7 sc0 ls1 ws1">the string</div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf148" class="pf w2 h6" data-page-no="148"><div class="pc pc148 w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">316</div><div class="t m0 xd h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">      MOV    X0, #1          // 1 = StdOut</div><div class="t m0 xd h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">      LDR    X1, =outstr     // string to print</div><div class="t m0 xd h18 y46d ff92 fs7 fc7 sc0 ls1 ws1">      MOV    X8, #64         // linux write system call</div><div class="t m0 xd h18 y623 ff92 fs7 fc7 sc0 ls1 ws1">      SVC    0               // Call linux to output the string</div><div class="t m0 xd h18 y46f ff92 fs7 fc7 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xd h18 y85d ff92 fs7 fc7 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y85e ff92 fs7 fc7 sc0 ls1 ws1">      MOV     X0,  #0        // Use 0 return code</div><div class="t m0 xd h18 y847 ff92 fs7 fc7 sc0 ls1 ws1">      MOV     X8,  #93       //  <span class="_ _20"></span>Service command code 96 </div><div class="t m0 x45 h18 y85f ff92 fs7 fc7 sc0 ls1 ws1">terminates</div><div class="t m0 xd h18 y629 ff92 fs7 fc7 sc0 ls1 ws1">      SVC     0              //  <span class="_ _20"></span>Call linux to terminate the </div><div class="t m0 x45 h18 y62a ff92 fs7 fc7 sc0 ls1 ws1">program</div><div class="t m0 xd h18 y84b ff92 fs7 fc7 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 y62c ff92 fs7 fc7 sc0 ls1 ws1">instr:  .asciz  &quot;ThisIsRatherALargeVariableNameAaZz//[`{\n&quot;</div><div class="t m0 xd h18 y860 ff92 fs7 fc7 sc0 ls1 ws1">       .align 4</div><div class="t m0 xd h18 y861 ff92 fs7 fc7 sc0 ls1 ws1">outstr:       .fill   255, 1, 0</div><div class="t m0 xc hd y84e ff8d fs7 fc7 sc0 ls1 ws1">This file contains the _start entry point and print Linux calls, so no </div><div class="t m0 xd hd y84f ff8d fs7 fc7 sc0 ls1 ws1">main.s is needed. Her<span class="_ _3"></span>e is the output of building and running this version:</div><div class="t m0 xd h18 y862 ff92 fs7 fc7 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 14$ make</div><div class="t m0 xd h18 y1176 ff92 fs7 fc7 sc0 ls1 ws1">as   upper3.s -o upper3.o</div><div class="t m0 xd h18 y12d2 ff92 fs7 fc7 sc0 ls1 ws1">ld -o upper3 upper3.o</div><div class="t m0 xd h18 yc43 ff92 fs7 fc7 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 14$ ./upper3</div><div class="t m0 xd h18 yc44 ff92 fs7 fc7 sc0 ls1 ws1">THISISRATHERALARGEVARIABLENAMEAAZZ[@[</div><div class="t m0 xd h18 yefa ff92 fs7 fc7 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 14$</div><div class="t m0 xc hd y868 ff8d fs7 fc7 sc0 ls1 ws1">There ar<span class="_ _1"></span>e a few special characters at the end of the string showing how </div><div class="t m0 xd hd y104d ff8d fs7 fc7 sc0 ls1 ws1">some are con<span class="_ _3"></span>verted correctly and some aren’t.</div><div class="t m0 xc hd yfb3 ff8d fs7 fc7 sc0 lse ws1">Besides using this <span class="ff93 ls25 wsd9">BIC</span> instruction to eliminate all conditional pr<span class="_ _1"></span>o<span class="_ _0"></span>cessin<span class="_ _3"></span>g, </div><div class="t m0 xd hd ya1a ff8d fs7 fc7 sc0 lse ws1">we implement the toupper r<span class="_ _3"></span>outine as a macr<span class="_ _3"></span>o to eliminate the o<span class="_ _1"></span>verhead of<span class="_ _0"></span> </div><div class="t m0 xd hd yfb4 ff8d fs7 fc7 sc0 lse ws1">calling a function. W<span class="_ _1"></span>e change the register us<span class="_ _3"></span>age, so we only use the first four </div><div class="t m0 xd hd y104c ff8d fs7 fc7 sc0 lse ws1">registers in the m<span class="_ _3"></span>acro<span class="_ _1"></span>, so we don’t need to save any r<span class="_ _3"></span>egisters aro<span class="_ _3"></span>und the call.</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf149" class="pf w2 h6" data-page-no="149"><div class="pc pc149 w2 h6"><img class="bi xc y86c w7 h24" alt="" src="bg149.png"/><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">317</div><div class="t m0 x1c hd y275 ff8d fs7 fc7 sc0 ls1 ws1">This is typical of many optimiza<span class="_ _3"></span>tions, sho<span class="_ _3"></span>wing how we can sa<span class="_ _3"></span>ve </div><div class="t m0 xc hd y276 ff8d fs7 fc7 sc0 ls1 ws1">instructions if we narrow our pr<span class="_ _1"></span>oblem domain, in this case to just working </div><div class="t m0 xc hd y277 ff8d fs7 fc7 sc0 ls1 ws1">on alphabetic char<span class="_ _3"></span>acters ra<span class="_ _3"></span>ther than all ASCII characters<span class="_ _3"></span>.</div><div class="t m0 xc ha y12d3 ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>Using P<span class="_ _1"></span>arallelism withSIMD</div><div class="t m0 xc hd y12d4 ff8d fs7 fc7 sc0 ls1 ws1">In Chapter <span class="fc5">13</span>, “N<span class="_ _1"></span>eon Coprocessor<span class="_ _6"></span>,<span class="_ _8"></span>” we looked at perfor<span class="_ _0"></span>ming oper<span class="_ _3"></span>ations in </div><div class="t m0 xc hd y12d5 ff8d fs7 fc7 sc0 ls1 ws1">parallel and mentioned th<span class="_ _3"></span>at this coprocessor pr<span class="_ _1"></span>o<span class="_ _0"></span>cesses char<span class="_ _1"></span>acters, as well </div><div class="t m0 xc hd y12d6 ff8d fs7 fc7 sc0 ls1 ws1">as integers and floats<span class="_ _3"></span>. Let’<span class="_ _1"></span>s see if we can use NEON instructions to process </div><div class="t m0 xc hd y12d7 ff8d fs7 fc7 sc0 ls1 ws1">16 characters a<span class="_ _3"></span>t a time (16 charact<span class="_ _3"></span>ers fit in a 128-bit <span class="ff93">V</span> register).</div><div class="t m0 x1c hd y12d8 ff8d fs7 fc7 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at the code in upper4.s shown in Listing <span class="fc5">14-5</span>.</div><div class="t m0 x36 h1f y875 ff91 fse fc7 sc0 ls1 ws1">Note<span class="ff95"> <span class="_ _17"> </span>This code won’t run until we make an adjustment to main.s at </span></div><div class="t m0 x36 h1f y876 ff95 fse fc7 sc0 ls1 ws1">the end of this section in Listing <span class="fc5">14-6</span>.</div><div class="t m0 xc h20 y12d9 ff94 fs3 fc7 sc0 ls1 ws1">Listing 14-5. <span class="_ _15"> </span><span class="ff8d">Upper<span class="_ _1"></span>-case routine us<span class="_ _3"></span>ing the NEON Coprocessor</span></div><div class="t m0 xc h18 y12da ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y12db ff92 fs7 fc7 sc0 ls1 ws1">// Assembler program to convert a string to</div><div class="t m0 xc h18 y12dc ff92 fs7 fc7 sc0 ls1 ws1">// all upper case.</div><div class="t m0 xc h18 y12dd ff92 fs7 fc7 sc0 ls1 ws1">//</div><div class="t m0 xc h18 y12de ff92 fs7 fc7 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xc h18 y12df ff92 fs7 fc7 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xc h18 y12e0 ff92 fs7 fc7 sc0 ls1 ws1">// X2 - use as indirection to load data</div><div class="t m0 xc h18 y12e1 ff92 fs7 fc7 sc0 ls1 ws1">// Q0 - 8 characters to be processed</div><div class="t m0 xc h18 y12e2 ff92 fs7 fc7 sc0 ls1 ws1">// V1 - contains all a&apos;s for comparison</div><div class="t m0 xc h18 y12e3 ff92 fs7 fc7 sc0 ls1 ws1">// V2 - result of comparison with &apos;a&apos;s</div><div class="t m0 xc h18 y12e4 ff92 fs7 fc7 sc0 ls1 ws1">// Q3 - all 25&apos;s for comp</div><div class="t m0 xc h18 y12e5 ff92 fs7 fc7 sc0 ls1 ws1">// Q8 - spaces for bic operation</div><div class="t m0 xc h18 y12e6 ff92 fs7 fc7 sc0 lse ws1">.global toupper          // Allow other files to call this routine</div><div class="t m0 x71 h12 y28b ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:481.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf149" data-dest-detail='[329,"XYZ",53,331,null]'><div class="d m1" style="border-style:none;position:absolute;left:306.363000px;bottom:417.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14c" data-dest-detail='[332,"XYZ",35,372,null]'><div class="d m1" style="border-style:none;position:absolute;left:217.213000px;bottom:361.878000px;width:23.296000px;height:14.872000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf14a" class="pf w2 h6" data-page-no="14a"><div class="pc pc14a w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">318</div><div class="t m0 xd h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">       .EQU   N, 4</div><div class="t m0 xd h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">toupper:</div><div class="t m0 xd h18 y46d ff92 fs7 fc7 sc0 ls1 ws1">       LDR X2, =aaas</div><div class="t m0 xd h18 y623 ff92 fs7 fc7 sc0 ls1 ws1">       LDR    Q1, [X2]   // Load Q1 with all as</div><div class="t m0 xd h18 y624 ff92 fs7 fc7 sc0 ls1 ws1">       LDR X2, =endch</div><div class="t m0 xd h18 y625 ff92 fs7 fc7 sc0 ls1 ws1">       LDR    Q3, [X2]   // Load Q3 with all 25&apos;s</div><div class="t m0 xd h18 y626 ff92 fs7 fc7 sc0 ls1 ws1">       LDR X2, =spaces</div><div class="t m0 xd h18 y627 ff92 fs7 fc7 sc0 ls1 ws1">       LDR    Q8, [X2]   // Load Q8 with all spaces</div><div class="t m0 xd h18 y628 ff92 fs7 fc7 sc0 ls1 ws1">       MOV    W3, #N</div><div class="t m0 xd h18 y9f6 ff92 fs7 fc7 sc0 ls1 ws1">// The loop is until byte pointed to by R1 is non-zero</div><div class="t m0 xd h18 y9f7 ff92 fs7 fc7 sc0 ls1 ws1">loop:  LDR   Q0, [X0], #16 // load 16 chars and incr pointer</div><div class="t m0 xd h18 y9f8 ff92 fs7 fc7 sc0 ls1 ws1">       SUB   V2.16B, V0.16B, V1.16B     // Subtract &apos;a&apos;s</div><div class="t m0 xd h18 yb8d ff92 fs7 fc7 sc0 ls1 ws1">       CMHI  V2.16B, V2.16B, V3.16B     //  <span class="_ _20"></span>compare chars to </div><div class="t m0 x6b h18 yb8e ff92 fs7 fc7 sc0 ls1 ws1">25&apos;s</div><div class="t m0 xd h18 yb8f ff92 fs7 fc7 sc0 ls1 ws1">       NOT   V2.16B, V2.16B             //  <span class="_ _20"></span>no CMLO so need to </div><div class="t m0 x6b h18 yb90 ff92 fs7 fc7 sc0 ls1 ws1">not</div><div class="t m0 xd h18 yb91 ff92 fs7 fc7 sc0 ls1 ws1">       AND   V2.16B, V2.16B, V8.16B     //  <span class="_ _20"></span>and result with </div><div class="t m0 x6b h18 yc1f ff92 fs7 fc7 sc0 ls1 ws1">spaces</div><div class="t m0 xd h18 yc20 ff92 fs7 fc7 sc0 ls1 ws1">       BIC   V0.16B, V0.16B, V2.16B     // kill lower-casebit</div><div class="t m0 xd h18 yc21 ff92 fs7 fc7 sc0 ls1 ws1">       STR   Q0, [X1], #16              //  <span class="_ _20"></span>store character to </div><div class="t m0 x6b h18 yc22 ff92 fs7 fc7 sc0 ls1 ws1">output str</div><div class="t m0 xd h18 yc23 ff92 fs7 fc7 sc0 ls1 ws1">       SUBS  W3, W3, #1                 //  <span class="_ _20"></span>dec loop counter and </div><div class="t m0 x6b h18 yc24 ff92 fs7 fc7 sc0 ls1 ws1">set flags</div><div class="t m0 xd h18 yc25 ff92 fs7 fc7 sc0 ls1 ws1">       B.NE  loop                       //  <span class="_ _20"></span>loop if character </div><div class="t m0 x6b h18 yc26 ff92 fs7 fc7 sc0 ls1 ws1">isn&apos;t null</div><div class="t m0 xd h18 yc27 ff92 fs7 fc7 sc0 ls1 ws1">       MOV   X0, #(N*16)                //  <span class="_ _20"></span>get the len by </div><div class="t m0 x6b h18 yc28 ff92 fs7 fc7 sc0 ls1 ws1">sub&apos;ing the pointers</div><div class="t m0 xd h18 yca9 ff92 fs7 fc7 sc0 ls1 ws1">       RET                              // Return to caller</div><div class="t m0 xd h18 yc2a ff92 fs7 fc7 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 yc2b ff92 fs7 fc7 sc0 ls1 ws1">aaas:        .fill  16, 1, &apos;a&apos;          // 16 a&apos;s</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf14b" class="pf w2 h6" data-page-no="14b"><div class="pc pc14b w2 h6"><img class="bi x2e ycbd w18 h5b" alt="" src="bg14b.png"/><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">319</div><div class="t m0 xc h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">endch:       .fill  16, 1, 25           //  <span class="_ _20"></span>after shift, chars </div><div class="t m0 x58 h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">are 0-25</div><div class="t m0 xc h18 y46d ff92 fs7 fc7 sc0 ls1 ws1">spaces:      .fill  16, 1, 0x20         // spaces for bic</div><div class="t m0 x1c hd y46e ff8d fs7 fc7 sc0 ls1 ws1">This ro<span class="_ _3"></span>utine uses 128-bit registers to pr<span class="_ _3"></span>ocess 16 charact<span class="_ _3"></span>ers at a time. </div><div class="t m0 xc hd y46f ff8d fs7 fc7 sc0 ls1 ws1">There ar<span class="_ _1"></span>e more instructions than some of our previous r<span class="_ _1"></span>outines, but the </div><div class="t m0 xc hd y85d ff8d fs7 fc7 sc0 ls1 ws1">parallelism mak<span class="_ _3"></span>es it worthwhile. W<span class="_ _1"></span>e start by loading our cons<span class="_ _3"></span>tants into </div><div class="t m0 xc hd y983 ff8d fs7 fc7 sc0 ls1 ws1">registers<span class="_ _1"></span>. Y<span class="_ _1"></span>ou can’t use immediate constants with NEON instructions, </div><div class="t m0 xc hd y984 ff8d fs7 fc7 sc0 ls1 ws1">so these must be in registers<span class="_ _1"></span>. Additionally, they need to be duplicated 16 </div><div class="t m0 xc hd yb7a ff8d fs7 fc7 sc0 ls1 ws1">times, so ther<span class="_ _3"></span>e is one for each of our 16 lanes<span class="_ _3"></span>.</div><div class="t m0 x1c hd yb7b ff8d fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e then load 16 characters to pr<span class="_ _3"></span>ocess into <span class="ff93">Q0</span> with an <span class="ff93">LDR</span> instruction. </div><div class="t m0 xc hd y62a ff8d fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e use post-indexed addr<span class="_ _3"></span>essing, so the pointer is left pointin<span class="_ _3"></span>g to the next </div><div class="t m0 xc hd y62b ff8d fs7 fc7 sc0 ls1 ws1">block of charact<span class="_ _3"></span>ers for when we loop<span class="_ _3"></span>.</div><div class="t m0 x1c hd y9f9 ff8d fs7 fc7 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure <span class="fc5">14-1</span> shows the pr<span class="_ _1"></span>ocessing through the NEON Coprocessor for </div><div class="t m0 xc hd yc53 ff8d fs7 fc7 sc0 ls1 ws1">the first four lanes<span class="_ _3"></span>. W<span class="_ _1"></span>e use <span class="ff93 ls1f wsc7">BIC</span>, but we could have just as e<span class="_ _3"></span>asily used <span class="ff93 ls1c wsbf">SUB</span> </div><div class="t m0 xc hd yc54 ff8d fs7 fc7 sc0 ls1 ws1">to do the conversion. W<span class="_ _1"></span>e test that the c<span class="_ _3"></span>haracter is lo<span class="_ _3"></span>wer<span class="_ _1"></span>-case alphabetic </div><div class="t m0 xc hd yc55 ff8d fs7 fc7 sc0 ls1 ws1">before doing this<span class="_ _1"></span>, so it is cor<span class="_ _0"></span>r<span class="_ _3"></span>ect for all ASCII characters.</div><div class="t m0 xc h1c y12e7 ff94 fs3 fc7 sc0 ls1 ws1">Figure 14-1. <span class="_ _15"> </span><span class="ff8e">The parallel processing s<span class="_ _3"></span>teps to convert to upper<span class="_ _3"></span>- <span class="_ _b"></span>case</span></div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf14b" data-dest-detail='[331,"XYZ",53,305,null]'><div class="d m1" style="border-style:none;position:absolute;left:104.032000px;bottom:377.186000px;width:20.547000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf14c" class="pf w2 h6" data-page-no="14c"><div class="pc pc14c w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">320</div><div class="t m0 xc hd y145 ff8d fs7 fc7 sc0 ls1 ws1">The <span class="ff93">CMHI</span> is our first encount<span class="_ _3"></span>er with a NEON comparison instr<span class="_ _0"></span>uction. </div><div class="t m0 xd hd y146 ff8d fs7 fc7 sc0 ls1 ws1">It comp<span class="_ _3"></span>ares all 16 lanes at once<span class="_ _1"></span>. It places all 1s in the destination lane if the </div><div class="t m0 xd hd y147 ff8d fs7 fc7 sc0 ls1 ws1">comparison is true, otherw<span class="_ _0"></span>ise 0. All 1s are 0xFF hex. W<span class="_ _1"></span>e really want <span class="ff93">CMLO</span>, </div><div class="t m0 xd hd y1b0 ff8d fs7 fc7 sc0 ls1 ws1">but there is no suc<span class="_ _3"></span>h instruction, so we need to do a <span class="ff93">CMHI</span> followed by a </div><div class="t m0 xd hd y1b1 ff93 fs7 fc7 sc0 ls1 ws1">NOT<span class="ff8d">. With this<span class="_ _3"></span>, we can <span class="ff93">AND</span> it with a register full of 0x20s<span class="_ _1"></span>. Any lanes that </span></div><div class="t m0 xd hd y218 ff8d fs7 fc7 sc0 ls1 ws1">don’t ha<span class="_ _3"></span>ve a lower<span class="_ _1"></span>-case alphabetic char<span class="_ _3"></span>acter will result in 0.</div><div class="t m0 xc hd y219 ff8d fs7 fc7 sc0 ls1 ws1">This means in lanes with 0, there ar<span class="_ _3"></span>e no bits for <span class="ff93 ls1f wsc7">BIC</span> to clear<span class="_ _6"></span>. Then the </div><div class="t m0 xd hd y1b4 ff8d fs7 fc7 sc0 ls1 ws1">lanes that still h<span class="_ _3"></span>ave 0x20 will clear th<span class="_ _3"></span>at one bit doing the conv<span class="_ _3"></span>ersion.</div><div class="t m0 xc hd y1b5 ff8d fs7 fc7 sc0 ls1 ws1">For this r<span class="_ _1"></span>outine to work, we need to make a change to main.s<span class="_ _1"></span>. We need </div><div class="t m0 xd hd y1b6 ff8d fs7 fc7 sc0 ls1 ws1">to add a “<span class="_ _b"></span>.<span class="ff93">alig<span class="_ _0"></span>n 4</span>” between the two strings. This is beca<span class="_ _3"></span>use we can only </div><div class="t m0 xd hd y1b7 ff8d fs7 fc7 sc0 ls1 ws1">load or store NEON da<span class="_ _3"></span>ta from or to wor<span class="_ _3"></span>d-aligned memory lo<span class="_ _0"></span>ca<span class="_ _3"></span>tions. If we </div><div class="t m0 xd hd y942 ff8d fs7 fc7 sc0 ls1 ws1">don’t do this, we get a “Bus E<span class="_ _3"></span>rror” when the program runs. T<span class="_ _3"></span>he updated </div><div class="t m0 xd hd y943 ff8d fs7 fc7 sc0 ls1 ws1">code is shown in Listing <span class="fc5">14-6</span>.</div><div class="t m0 xd h20 y12e8 ff94 fs3 fc7 sc0 ls1 ws1">Listing 14-6. <span class="_ _15"> </span><span class="ff8d">Changes r<span class="_ _3"></span>equired in main.s</span></div><div class="t m0 xd h18 y9a7 ff92 fs7 fc7 sc0 ls1 ws1">instr:  .asciz  &quot;This is our Test String that we will convert. </div><div class="t m0 xd h18 y12e9 ff92 fs7 fc7 sc0 ls1 ws1">AaZz@[`{\n&quot;</div><div class="t m0 xd h18 y12ea ff92 fs7 fc7 sc0 ls1 ws1">      .align 4</div><div class="t m0 xd h18 y12eb ff92 fs7 fc7 sc0 ls1 ws1">outstr:     .fill   255, 1, 0</div><div class="t m0 xc hd y12ec ff8d fs7 fc7 sc0 ls1 ws1">I also added edge case characters to the end of the string; this ensur<span class="_ _1"></span>es </div><div class="t m0 xd hd y12ed ff8d fs7 fc7 sc0 ls1 ws1">we don’t hav<span class="_ _3"></span>e any off-b<span class="_ _3"></span>y-one errors in our code<span class="_ _3"></span>.</div><div class="t m0 xc hd y12ee ff8d fs7 fc7 sc0 ls1 ws1">This code runs fine, but tha<span class="_ _3"></span>t’<span class="_ _6"></span>s par<span class="_ _0"></span>tly because of the wa<span class="_ _3"></span>y our .data </div><div class="t m0 xd hd y12ef ff8d fs7 fc7 sc0 ls1 ws1">section is set up<span class="_ _3"></span>. Notice ther<span class="_ _1"></span>e is no test for the str<span class="_ _0"></span>ing NULL terminator<span class="_ _10"></span>. </div><div class="t m0 xd hd y12f0 ff8d fs7 fc7 sc0 ls1 ws1">This ro<span class="_ _3"></span>utine just converts fixed length strings<span class="_ _1"></span>, and we s<span class="_ _0"></span>et the fixed length </div><div class="t m0 xd hd y12f1 ff8d fs7 fc7 sc0 ls18 wsc0">at 4<span class="ff97 ls1 ws1">∗<span class="ff8d">16 by making the loop perform four iterations<span class="_ _1"></span>. The NEON processor </span></span></div><div class="t m0 xd hd y12f2 ff8d fs7 fc7 sc0 ls1 ws1">has no easy wa<span class="_ _3"></span>y to detect a NULL terminator<span class="_ _6"></span>. If we looped through the </div><div class="t m0 xd hd y12f3 ff8d fs7 fc7 sc0 ls1 ws1">characters o<span class="_ _3"></span>utside of the NEON processor to look for the NULL<span class="_ _0"></span>, we do </div><div class="t m0 xd hd y12f4 ff8d fs7 fc7 sc0 ls1 ws1">nearly as much work as our las<span class="_ _3"></span>t toupper routine<span class="_ _1"></span>. T<span class="_ _1"></span>o do string processin<span class="_ _3"></span>g in </div><div class="t m0 xd hd y12f5 ff8d fs7 fc7 sc0 ls1 ws1">the NEON Coprocessor<span class="_ _10"></span>, here are some notes<span class="_ _0"></span>:</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf14c" data-dest-detail='[332,"XYZ",35,372,null]'><div class="d m1" style="border-style:none;position:absolute;left:150.068000px;bottom:385.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf14d" class="pf w2 h6" data-page-no="14d"><div class="pc pc14d w2 h6"><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">321</div><div class="t m0 x1e hd y145 ff8d fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>Don’t use NULL-ter<span class="_ _0"></span>mina<span class="_ _3"></span>ted strings. U<span class="_ _3"></span>se a length field </div><div class="t m0 x9 hd y146 ff8d fs7 fc7 sc0 ls1 ws1">followed by the string. Or use fixed length strings<span class="_ _1"></span>, </div><div class="t m0 x9 hd y147 ff8d fs7 fc7 sc0 ls1 ws1">for example, every string is just 256 char<span class="_ _3"></span>acters and </div><div class="t m0 x9 hd y1b0 ff8d fs7 fc7 sc0 ls1 ws1">contains spaces beyond the last char<span class="_ _1"></span>acter<span class="_ _6"></span>.</div><div class="t m0 x1e hd y149 ff8d fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>P<span class="_ _3"></span>ad all strings to use data storage in m<span class="_ _3"></span>ultiples of 16. </div><div class="t m0 x9 hd y14a ff8d fs7 fc7 sc0 ls1 ws1">This way yo<span class="_ _3"></span>u won’t ever ha<span class="_ _3"></span>ve to worr<span class="_ _0"></span>y about NEON </div><div class="t m0 x9 hd y1cb ff8d fs7 fc7 sc0 ls1 ws1">processing pas<span class="_ _3"></span>t the end of your buffer<span class="_ _10"></span>.</div><div class="t m0 x1e hd y58d ff8d fs7 fc7 sc0 ls1 ws1">• <span class="_ _c"> </span>Mak<span class="_ _3"></span>e sure all the strings ar<span class="_ _1"></span>e w<span class="_ _0"></span>or<span class="_ _1"></span>d aligne<span class="_ _0"></span>d.</div><div class="t m0 x1c hd y28e ff8d fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve look<span class="_ _3"></span>ed at several techniques to optimize our upper<span class="_ _1"></span>-case </div><div class="t m0 xc hd y28f ff8d fs7 fc7 sc0 ls1 ws1">routine; let’<span class="_ _6"></span>s look at why we concentr<span class="_ _3"></span>ate so much on elimina<span class="_ _3"></span>ting branch </div><div class="t m0 xc hd y264 ff8d fs7 fc7 sc0 ls1 ws1">instructions as well as provide a few other tips<span class="_ _1"></span>.</div><div class="t m0 xc h15 y437 ff91 fsb fc7 sc0 ls1 ws1"> <span class="_ _e"></span>T<span class="_ _1"></span>ips forOptimizing Code</div><div class="t m0 xc hd y12f6 ff8d fs7 fc7 sc0 ls1 ws1">The first rule of optimizing code is to time and test everything. The </div><div class="t m0 xc hd y12f7 ff8d fs7 fc7 sc0 ls1 ws1">designers of the ARM processor ar<span class="_ _1"></span>e always incorporating impr<span class="_ _1"></span>ovements </div><div class="t m0 xc hd y12f8 ff8d fs7 fc7 sc0 ls1 ws1">to their har<span class="_ _3"></span>dware designs<span class="_ _1"></span>. Each year<span class="_ _6"></span>, the ARM processors get faster and </div><div class="t m0 xc hd y12f9 ff8d fs7 fc7 sc0 ls1 ws1">more optimized. Impr<span class="_ _1"></span>oving performance though optimizing Assembly </div><div class="t m0 xc hd y12fa ff8d fs7 fc7 sc0 ls1 ws1">Language code isn’t alway<span class="_ _3"></span>s intuitive<span class="_ _3"></span>. The processor can be quite sm<span class="_ _3"></span>art at </div><div class="t m0 xc hd y12fb ff8d fs7 fc7 sc0 ls1 ws1">some things and quite dumb at others<span class="_ _1"></span>. If you don’t set up tests to measure </div><div class="t m0 xc hd y12fc ff8d fs7 fc7 sc0 ls1 ws1">the results of yo<span class="_ _3"></span>ur changes<span class="_ _3"></span>, you could well be making thin<span class="_ _3"></span>gs worse.</div><div class="t m0 x1c hd y12fd ff8d fs7 fc7 sc0 ls1 ws1">With tha<span class="_ _3"></span>t said, let’<span class="_ _6"></span>s lo<span class="_ _0"></span>ok at some gener<span class="_ _3"></span>al Assembly Language </div><div class="t m0 xc hd y12fe ff8d fs7 fc7 sc0 ls1 ws1">optimization techniques<span class="_ _3"></span>.</div><div class="t m0 xc ha yfa8 ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>A<span class="_ _3"></span>voiding Branch Instructions</div><div class="t m0 xc hd yfa9 ff8d fs7 fc7 sc0 ls1 wsbe">The ARM CPU works on several instructions at once<span class="_ _1"></span>, and if the instr<span class="_ _0"></span>uctions </div><div class="t m0 xc hd yfaa ff8d fs7 fc7 sc0 ls1 ws1">don’t involve a br<span class="_ _3"></span>anch, then everything works gre<span class="_ _3"></span>at. If the CPU hits a </div><div class="t m0 xc hd yfab ff8d fs7 fc7 sc0 ls1 ws1">branch instruction, it must do one of thr<span class="_ _1"></span>e<span class="_ _0"></span>e things:</div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf14e" class="pf w2 h6" data-page-no="14e"><div class="pc pc14e w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">322</div><div class="t m0 xc hd y145 ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Throw a<span class="_ _1"></span>way any work it has done on instructions </div><div class="t m0 x1e hd y146 ff8d fs7 fc7 sc0 ls1 ws1">after the branch instruction.</div><div class="t m0 xc hd y1fe ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Make an educ<span class="_ _3"></span>ated guess as to which wa<span class="_ _3"></span>y the branch </div><div class="t m0 x1e hd y148 ff8d fs7 fc7 sc0 ls1 ws1">is likely to go and proceed in tha<span class="_ _3"></span>t direction; then it </div><div class="t m0 x1e hd y149 ff8d fs7 fc7 sc0 ls1 ws1">only needs to discard the work if it guessed wr<span class="_ _1"></span>ong.</div><div class="t m0 xc hd y28c ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Start processing instructions in both dir<span class="_ _3"></span>ections of </div><div class="t m0 x1e hd y14b ff8d fs7 fc7 sc0 ls1 ws1">the branch at once; per<span class="_ _3"></span>haps it can’t do as much </div><div class="t m0 x1e hd y58d ff8d fs7 fc7 sc0 ls1 ws1">work, but it accomplishes something un<span class="_ _3"></span>til the </div><div class="t m0 x1e hd y58e ff8d fs7 fc7 sc0 ls1 ws1">direction of the conditional br<span class="_ _1"></span>anch is de<span class="_ _0"></span>cided.</div><div class="t m0 xc hd y28f ff8d fs7 fc7 sc0 ls1 ws1">CPUs were getting quit<span class="_ _3"></span>e good at predicting br<span class="_ _3"></span>anches and keeping their </div><div class="t m0 xd hd y264 ff8d fs7 fc7 sc0 ls1 ws1">pipelines busy. This was until the S<span class="_ _1"></span>pe<span class="_ _0"></span>ctr<span class="_ _3"></span>e and Meltdo<span class="_ _3"></span>wn security exploits </div><div class="t m0 xd hd y265 ff8d fs7 fc7 sc0 ls1 ws1">figured o<span class="_ _3"></span>ut how to access this work and exploit it. T<span class="_ _3"></span>hat ca<span class="_ _3"></span>used CPU </div><div class="t m0 xd hd y266 ff8d fs7 fc7 sc0 ls1 ws1">vendors, includin<span class="_ _3"></span>g ARM, to reduce some of this functionality.</div><div class="t m0 xc hd y1f2 ff8d fs7 fc7 sc0 ls1 ws1">As a result<span class="_ _3"></span>, conditional branch instructions can still be expensive<span class="_ _1"></span>. </div><div class="t m0 xd hd y1f3 ff8d fs7 fc7 sc0 ls1 ws1">They also lead to hard to m<span class="_ _3"></span>aintain spaghetti code th<span class="_ _3"></span>at should be a<span class="_ _3"></span>voided. </div><div class="t m0 xd hd ye80 ff8d fs7 fc7 sc0 ls1 ws1">So reducing conditional br<span class="_ _3"></span>anches helps performance and leads to more </div><div class="t m0 xd hd y269 ff8d fs7 fc7 sc0 ls1 ws1">maintaina<span class="_ _3"></span>ble code.</div><div class="t m0 xd ha y1022 ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>A<span class="_ _3"></span>voiding Expensive Instructions</div><div class="t m0 xd hd y12ff ff8d fs7 fc7 sc0 ls1 ws1">Instructions like multiplica<span class="_ _3"></span>tion and division take multiple clock cycles to </div><div class="t m0 xd hd y1300 ff8d fs7 fc7 sc0 ls1 ws1">execute. If yo<span class="_ _3"></span>u can accomplish them thr<span class="_ _3"></span>ough additions or subtractions </div><div class="t m0 xd hd y1301 ff8d fs7 fc7 sc0 ls1 ws1">in an existing loop<span class="_ _1"></span>, that can help<span class="_ _1"></span>. Als<span class="_ _0"></span>o<span class="_ _1"></span>, consider using bit manipulation </div><div class="t m0 xd hd y1302 ff8d fs7 fc7 sc0 ls1 ws1">instructions like shifting left to multiply b<span class="_ _3"></span>y 2. If these instructions are </div><div class="t m0 xd hd y1303 ff8d fs7 fc7 sc0 ls1 ws1">necessary for your algorithm, then there isn’t much yo<span class="_ _3"></span>u can do<span class="_ _1"></span>.</div><div class="t m0 xc hd y1304 ff8d fs7 fc7 sc0 ls1 ws1">One trick is to execute the multiplication or division on the FPU or </div><div class="t m0 xd hd y1305 ff8d fs7 fc7 sc0 ls1 ws1">NEON Coprocessor<span class="_ _0"></span>; this will allow other r<span class="_ _3"></span>egular ARM instructions to </div><div class="t m0 xd hd y1306 ff8d fs7 fc7 sc0 ls1 ws1">continue in par<span class="_ _3"></span>allel.</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf14f" class="pf w2 h6" data-page-no="14f"><div class="pc pc14f w2 h6"><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">323</div><div class="t m0 xc ha y248 ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>Don’t BeAfraid ofMacros</div><div class="t m0 xc hd y249 ff8d fs7 fc7 sc0 ls1 ws1">Calling a function can be costly if a lot of r<span class="_ _1"></span>egisters need to be saved to the </div><div class="t m0 xc hd y24a ff8d fs7 fc7 sc0 ls1 ws1">stack and then res<span class="_ _3"></span>tored befor<span class="_ _3"></span>e returnin<span class="_ _3"></span>g. Don’t be afraid of using macr<span class="_ _1"></span>os </div><div class="t m0 xc hd y24b ff8d fs7 fc7 sc0 ls1 ws1">to eliminate the function call and r<span class="_ _1"></span>eturn instructions along with all the </div><div class="t m0 xc hd y5ad ff8d fs7 fc7 sc0 ls1 ws1">register sa<span class="_ _1"></span>ving/restoring.</div><div class="t m0 xc ha y1307 ff91 fs6 fc7 sc0 ls1 wsb1"> Loop <span class="_ _14"> </span>Unrolling</div><div class="t m0 xc hd y1308 ff8d fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll see an example of loop unrolling in Cha<span class="_ _3"></span>pter <span class="fc5">15</span>, “Reading and </div><div class="t m0 xc hd y1309 ff8d fs7 fc7 sc0 ls1 ws1">Understanding Code<span class="_ _3"></span>.<span class="_ _8"></span>” This is repeatin<span class="_ _3"></span>g the code the number of times </div><div class="t m0 xc hd y130a ff8d fs7 fc7 sc0 ls1 ws1">of the loop<span class="_ _1"></span>, saving the over<span class="_ _3"></span>head of the instructions that do the looping. </div><div class="t m0 xc hd y130b ff8d fs7 fc7 sc0 ls1 ws1">W<span class="_ _1"></span>e did this in the NEON version of 3x3 matrix multiplication wher<span class="_ _3"></span>e we </div><div class="t m0 xc hd y130c ff8d fs7 fc7 sc0 ls1 ws1">inserted calls to a macro thr<span class="_ _1"></span>e<span class="_ _0"></span>e times r<span class="_ _3"></span>ather than write a loop<span class="_ _1"></span>.</div><div class="t m0 xc ha y130d ff91 fs6 fc7 sc0 ls1 ws1"> <span class="_ _13"></span>Keeping Data Small</div><div class="t m0 xc hd y130e ff8d fs7 fc7 sc0 ls1 ws1">Even tho<span class="_ _3"></span>ugh the ARM process can mostl<span class="_ _3"></span>y process instructions inv<span class="_ _3"></span>olving </div><div class="t m0 xc hd y130f ff8d fs7 fc7 sc0 ls1 ws1">the 64-bit <span class="ff93">X</span> registers in the same time as in<span class="_ _1"></span>volving the 32-bit <span class="ff93">W</span> registers, </div><div class="t m0 xc hd y1310 ff8d fs7 fc7 sc0 ls1 ws1">it puts strain on the memory bus moving all th<span class="_ _3"></span>at data<span class="_ _3"></span>. Remember the </div><div class="t m0 xc hd y1311 ff8d fs7 fc7 sc0 ls1 ws1">memory bus is moving your data<span class="_ _3"></span>, along with loading instructions to </div><div class="t m0 xc hd y1312 ff8d fs7 fc7 sc0 ls1 ws1">execute and doing all that for all the pr<span class="_ _1"></span>ocessing cores. R<span class="_ _3"></span>educing the </div><div class="t m0 xc hd y1313 ff8d fs7 fc7 sc0 ls1 ws1">quantity of data you mo<span class="_ _1"></span>ve to and from memory can help speed things up.</div><div class="t m0 xc ha y1314 ff91 fs6 fc7 sc0 ls1 wsb1"> Beware <span class="_ _14"> </span>ofOverheating</div><div class="t m0 xc hd y1315 ff8d fs7 fc7 sc0 ls1 ws1">A single ARM processor typically h<span class="_ _3"></span>as four or more pr<span class="_ _1"></span>ocessing cores, e<span class="_ _3"></span>ach </div><div class="t m0 xc hd y1316 ff8d fs7 fc7 sc0 ls1 ws1">of these with an FPU and NEON Coprocessor<span class="_ _6"></span>. If you work har<span class="_ _3"></span>d, you can </div><div class="t m0 xc hd y1317 ff8d fs7 fc7 sc0 ls1 ws1">get all these units working at once<span class="_ _3"></span>, theoretically pr<span class="_ _1"></span>ocessing a huge amount </div><div class="t m0 xc hd y1318 ff8d fs7 fc7 sc0 ls1 ws1">of data in parallel. T<span class="_ _3"></span>he gotcha is that the mor<span class="_ _1"></span>e circuitry you involve in </div><div class="t m0 xc hd y1319 ff8d fs7 fc7 sc0 ls1 ws1">processing<span class="_ _3"></span>, the more heat is pr<span class="_ _1"></span>oduced.</div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:286.163000px;bottom:436.518000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf150" class="pf w2 h6" data-page-no="150"><div class="pc pc150 w2 h6"><div class="t m0 xd hd y3f ff8d fs7 fc7 sc0 ls1 ws1">324</div><div class="t m0 xc hd y145 ff8d fs7 fc7 sc0 ls1 ws1">If you do this<span class="_ _3"></span>, beware th<span class="_ _3"></span>at a single boar<span class="_ _3"></span>d computer<span class="_ _10"></span>, like the Raspberr<span class="_ _0"></span>y </div><div class="t m0 xd hd y146 ff8d fs7 fc7 sc0 ls1 ws1">Pi, can over<span class="_ _3"></span>heat. S<span class="_ _3"></span>imilarly, smartphones over<span class="_ _3"></span>heat when they need to </div><div class="t m0 xd hd y147 ff8d fs7 fc7 sc0 ls1 ws1">sustain too much pr<span class="_ _3"></span>ocessing. Often ther<span class="_ _3"></span>e are guidelines as to ho<span class="_ _3"></span>w busy </div><div class="t m0 xd hd y1b0 ff8d fs7 fc7 sc0 ls1 ws1">you can keep the pr<span class="_ _1"></span>o<span class="_ _0"></span>cessor befor<span class="_ _3"></span>e it starts to overhea<span class="_ _3"></span>t.</div><div class="t m0 xc hd y1b1 ff8d fs7 fc7 sc0 ls1 ws1">Y<span class="_ _6"></span>ou won’t damage the processor<span class="_ _0"></span>; it will detect the overhea<span class="_ _3"></span>ting and </div><div class="t m0 xd hd y218 ff8d fs7 fc7 sc0 ls1 ws1">slow itself down, undoing all the gr<span class="_ _3"></span>eat work you’<span class="_ _1"></span>ve done.</div><div class="t m0 xd h15 y6b7 ff91 fsb fc7 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y6b8 ff8d fs7 fc7 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we perfor<span class="_ _0"></span>med several optimiza<span class="_ _3"></span>tions on our upper<span class="_ _1"></span>-case </div><div class="t m0 xd hd y6b9 ff8d fs7 fc7 sc0 ls1 ws1">function. W<span class="_ _1"></span>e looked at</div><div class="t m0 xc hd y201 ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Simplifying ran<span class="_ _3"></span>ge comparisons</div><div class="t m0 xc hd yda2 ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Using conditional instructions</div><div class="t m0 xc hd y131a ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Simplifying the domain and using bit m<span class="_ _3"></span>anipulations</div><div class="t m0 xc hd y131b ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Upper<span class="_ _1"></span>-casing 16 character<span class="_ _3"></span>s at once using the NEON </div><div class="t m0 x1e hd y131c ff8d fs7 fc7 sc0 ls1 ws1">Coprocessor</div><div class="t m0 xc hd y131d ff8d fs7 fc7 sc0 ls1 wsbe">W<span class="_ _1"></span>e then provided several hin<span class="_ _3"></span>ts to consider when optimizing your code<span class="_ _1"></span>.</div><div class="t m0 xc hd y131e ff8d fs7 fc7 sc0 ls1 ws1">In Chapter <span class="fc5">15</span>, “R<span class="_ _3"></span>eading and Understanding Code<span class="_ _1"></span>,<span class="_ _10"></span>” we will examine </div><div class="t m0 xd hd y131f ff8d fs7 fc7 sc0 ls1 ws1">how the C compiler genera<span class="_ _3"></span>tes code and talk about understanding </div><div class="t m0 xd hd y1320 ff8d fs7 fc7 sc0 ls1 ws1">compiled progr<span class="_ _3"></span>ams.</div><div class="t m0 xd h15 y210 ff91 fsb fc7 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y1321 ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>In our first optimization, consider this altern<span class="_ _3"></span>ate </div><div class="t m0 x1e hd y1322 ff8d fs7 fc7 sc0 ls1 ws1">pseudo-code:</div><div class="t m0 x1e h18 y1323 ff92 fs7 fc7 sc0 ls1 ws1">    W5 = W5 - &apos;a&apos;</div><div class="t m0 x1e h18 y1324 ff92 fs7 fc7 sc0 ls1 ws1">    IF (W5 &gt;= 0) AND W5 &lt;= (&apos;z&apos;-&apos;a&apos;) THEN</div><div class="t m0 xd h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.503000px;bottom:267.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf151" class="pf w2 h6" data-page-no="151"><div class="pc pc151 w2 h6"><div class="t m0 x17 hd y3f ff8d fs7 fc7 sc0 ls1 ws1">325</div><div class="t m0 x9 h18 y46b ff92 fs7 fc7 sc0 ls1 ws1">        W5 = W5 + &apos;A&apos;</div><div class="t m0 x9 h18 y46c ff92 fs7 fc7 sc0 ls1 ws1">    END IF</div><div class="t m0 x9 hd ya17 ff8d fs7 fc7 sc0 ls1 ws1">Why is this incorrect?</div><div class="t m0 x1c hd y1325 ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Think back to the loops we developed in Chapter <span class="fc5">4</span>, </div><div class="t m0 x9 hd y1326 ff8d fs7 fc7 sc0 ls1 ws1">“<span class="_ _3"></span>Conditional Pr<span class="_ _3"></span>ogram F<span class="_ _3"></span>low.<span class="_ _8"></span>” Construct a FOR loop </div><div class="t m0 x9 hd y1327 ff8d fs7 fc7 sc0 ls1 ws1">using a CSINC statement to do the incr<span class="_ _3"></span>ement and </div><div class="t m0 x9 hd y1328 ff8d fs7 fc7 sc0 ls1 ws1">test for loop end.</div><div class="t m0 x1c hd y1329 ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Each generation of ARM CPU adds a few mor<span class="_ _3"></span>e </div><div class="t m0 x9 hd y132a ff8d fs7 fc7 sc0 ls1 ws1">instructions, especially to the NEON Copr<span class="_ _3"></span>ocessor<span class="_ _6"></span>. </div><div class="t m0 x9 hd y132b ff8d fs7 fc7 sc0 ls1 ws1">List the pros and cons of utilizing newer instructions </div><div class="t m0 x9 hd y132c ff8d fs7 fc7 sc0 ls1 ws1">to optimize your code<span class="_ _3"></span>.</div><div class="t m0 x1c hd y132d ff8d fs7 fc7 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Set up a way to run each of the progr<span class="_ _3"></span>ams in this </div><div class="t m0 x9 hd y132e ff8d fs7 fc7 sc0 ls1 ws1">chapter in a large loop<span class="_ _1"></span>, and time how long each one </div><div class="t m0 x9 hd y132f ff8d fs7 fc7 sc0 ls1 ws1">takes. Which t<span class="_ _3"></span>echnique is fastest and why? Consider </div><div class="t m0 x9 hd y1330 ff8d fs7 fc7 sc0 ls1 ws1">using the Linux gettimeofday service.</div><div class="t m0 x71 h12 y71 ff95 fsa fc7 sc0 ls1 ws1">CHAPTER 14 <span class="_ _f"> </span> OPTIMIZING CODE</div><a class="l" href="#pf69" data-dest-detail='[105,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:331.153000px;bottom:515.186000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf152" class="pf w2 h6" data-page-no="152"><div class="pc pc152 w2 h6"><div class="t m0 x17 hd y16a ff98 fs7 fc3 sc0 ls1 ws1">327</div><div class="t m0 xc h17 y16b ff98 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ff98 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ff99">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ff98">,  </span></span></div><div class="t m0 xc h17 y16d ff98 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_15</div><div class="t m0 xc ha y16e ff9a fs6 fc3 sc0 ls1 ws1">CHAPTER 15</div><div class="t m0 xc h8 y16f ff9b fs4 fc3 sc0 ls1 ws1">R<span class="_ _1"></span>eading and </div><div class="t m0 xc h8 y747 ff9b fs4 fc3 sc0 ls1 ws1">Under<span class="_ _3"></span>standing Code</div><div class="t m0 xc hd y748 ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve no<span class="_ _3"></span>w learned quite a bit of ARM 64-bit Assembly Language; one of </div><div class="t m0 xc hd y749 ff98 fs7 fc3 sc0 ls1 ws1">the things we can do is read another pr<span class="_ _1"></span>ogrammer<span class="_ _0"></span>’<span class="_ _6"></span>s code. Reading another </div><div class="t m0 xc hd y74a ff98 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ammer’<span class="_ _1"></span>s code is a great w<span class="_ _3"></span>ay to not only add to our toolkit of tips and </div><div class="t m0 xc hd y74b ff98 fs7 fc3 sc0 ls1 ws1">tricks but also impro<span class="_ _1"></span>ve our own coding. W<span class="_ _1"></span>e’ll review some places where </div><div class="t m0 xc hd y74c ff98 fs7 fc3 sc0 ls1 ws1">you can find Assembly sour<span class="_ _1"></span>ce code for the ARM processor<span class="_ _6"></span>. W<span class="_ _3"></span>e’ll examine </div><div class="t m0 xc hd y74d ff98 fs7 fc3 sc0 ls1 ws1">one of the Assembly Language r<span class="_ _3"></span>outines from the Lin<span class="_ _3"></span>ux kernel to learn </div><div class="t m0 xc hd y74e ff98 fs7 fc3 sc0 ls1 ws1">some new optimization techniques. T<span class="_ _3"></span>hen we’ll look at how the GNU C </div><div class="t m0 xc hd y74f ff98 fs7 fc3 sc0 ls1 ws1">compiler writes Assembly code and how we can analyze it<span class="_ _3"></span>. W<span class="_ _1"></span>e’ll look at </div><div class="t m0 xc hd y8c6 ff98 fs7 fc3 sc0 ls1 ws1">the NSA<span class="_ _10"></span>’<span class="_ _1"></span>s Ghidr<span class="_ _3"></span>a hacking tool tha<span class="_ _3"></span>t converts Assembly Lang<span class="_ _3"></span>uage code back </div><div class="t m0 xc hd y8c7 ff98 fs7 fc3 sc0 ls1 ws1">into C code—at least appr<span class="_ _1"></span>oximately.</div><div class="t m0 x1c hd y8c8 ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll use our upper<span class="_ _1"></span>-case program to see how the C compiler writes </div><div class="t m0 xc hd y8c9 ff98 fs7 fc3 sc0 ls1 wsa9">Assembly Language code and then examine how G<span class="_ _3"></span>hidra can take th<span class="_ _3"></span>at code </div><div class="t m0 xc hd y8ca ff98 fs7 fc3 sc0 ls1 ws1">and reconstitute the C code<span class="_ _1"></span>.</div><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:168.835000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf153" class="pf w2 h6" data-page-no="153"><div class="pc pc153 w2 h6"><img class="bi xd y1331 w7 h5c" alt="" src="bg153.png"/><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">328</div><div class="t m0 xd h15 y1332 ff9c fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Browsing Linux andGCC Code</div><div class="t m0 xd hd y1333 ff98 fs7 fc3 sc0 ls1 ws1">One of the many nice things about workin<span class="_ _3"></span>g with Linux and the GNU </div><div class="t m0 xd hd y1334 ff98 fs7 fc3 sc0 ls1 ws1">Compiler Collection is that they ar<span class="_ _3"></span>e open source<span class="_ _1"></span>. That means you can </div><div class="t m0 xd hd y1335 ff98 fs7 fc3 sc0 ls1 ws1">browse thr<span class="_ _1"></span>ough the source code and peruse the Assembly parts contained </div><div class="t m0 xd hd y1336 ff98 fs7 fc3 sc0 ls1 ws1">there<span class="_ _3"></span>. They are a<span class="_ _1"></span>vailable in the following GitH<span class="_ _1"></span>ub repositories<span class="_ _0"></span>:</div><div class="t m0 xa h18 y1337 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Linux kernel: <span class="ff9d fc5">https://github.com/torvalds/linux</span></div><div class="t m0 xa h18 y1338 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>GCC source code: <span class="ff9d fc5">https://github.com/ </span></div><div class="t m0 x1e h18 y1339 ff9d fs7 fc5 sc0 ls1 ws1">gcc-mirror/gcc</div><div class="t m0 xc hd y133a ff98 fs7 fc3 sc0 ls1 ws1">Clicking the “<span class="_ _1"></span>Clone or download” button and choosing “Download </div><div class="t m0 xd hd y133b ff98 fs7 fc3 sc0 ls1 ws1">ZIP” is the easiest way to obtain them. W<span class="_ _1"></span>ithin all this s<span class="_ _0"></span>our<span class="_ _1"></span>ce code, a couple </div><div class="t m0 xd hd y133c ff98 fs7 fc3 sc0 ls1 ws1">of good folders to review ARM 64-bit Assembly Langua<span class="_ _3"></span>ge source code ar<span class="_ _3"></span>e</div><div class="t m0 xa hd y133d ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>Linux kernel</div><div class="t m0 x1e hd y133e ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>arch/arm64/lib</div><div class="t m0 x1e hd y133f ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>arch/arm64/kernel</div><div class="t m0 x1e hd y1340 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>arch/arm64/crypto</div><div class="t m0 xa hd y1341 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span><span class="ls8 ws9f">GCC</span></div><div class="t m0 x1e hd y1342 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>libgcc/config/aar<span class="_ _3"></span>ch64</div><div class="t m0 x34 h1f y1343 ff9c fse fc3 sc0 ls1 ws1">Note<span class="ff9e"> <span class="_ _17"> </span>The arch/arm64/crypto has several cr<span class="_ _0"></span>yptographic routines </span></div><div class="t m0 x34 h1f y1344 ff9e fse fc3 sc0 ls1 ws1">implemented on the NEON Coprocessor cryptogra<span class="_ _0"></span>phic extensions that </div><div class="t m0 x34 h1f y1345 ff9e fse fc3 sc0 ls1 ws1">won’t be implemented on all processors.</div><div class="t m0 x34 h1f y1346 ff9e fse fc3 sc0 ls1 ws1">The <span class="_ _1"></span>Assembly source code for these is in *.S files (note the upper<span class="_ _1"></span>-</div><div class="t m0 x34 h1f y1347 ff9e fse fc3 sc0 ls1 ws1">case S).<span class="_ _1"></span> <span class="_ _1"></span>This is so they can include C header files and utilize C </div><div class="t m0 x34 h1f y1348 ff9e fse fc3 sc0 ls1 ws1">preprocessor directives.</div><div class="t m0 xd h12 y3e8 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="https://github.com/torvalds/linux"><div class="d m1" style="border-style:none;position:absolute;left:146.450000px;bottom:477.046000px;width:181.500000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="https://github.com/gcc-mirror/gcc"><div class="d m1" style="border-style:none;position:absolute;left:168.648000px;bottom:455.046000px;width:110.000000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="https://github.com/gcc-mirror/gcc"><div class="d m1" style="border-style:none;position:absolute;left:82.772000px;bottom:439.046000px;width:77.000000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf154" class="pf w2 h6" data-page-no="154"><div class="pc pc154 w2 h6"><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">329</div><div class="t m0 x1c hd y145 ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can learn a lot by studying this code<span class="_ _3"></span>. F<span class="_ _3"></span>or example, we<span class="_ _3"></span>’ll now look at </div><div class="t m0 xc hd y146 ff98 fs7 fc3 sc0 ls1 ws1">how the Linux kernel copies pages of memory around.</div><div class="t m0 xc ha y1349 ff9c fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Copying aP<span class="_ _1"></span>age ofMemor<span class="_ _0"></span>y</div><div class="t m0 xc hd y163 ff98 fs7 fc3 sc0 ls1 ws1">The Linux kernel contains m<span class="_ _3"></span>achine-<span class="_ _3"></span>specific code to handle things like the </div><div class="t m0 xc hd y134a ff98 fs7 fc3 sc0 ls1 ws1">initialization of the CPU<span class="_ _1"></span>, handling interrupts and performing multitasking. </div><div class="t m0 xc hd y134b ff98 fs7 fc3 sc0 ls1 ws1">It also contains As<span class="_ _3"></span>sembly Language versions of man<span class="_ _3"></span>y C runtime </div><div class="t m0 xc hd y134c ff98 fs7 fc3 sc0 ls1 ws1">functions and other specialty functions that optimize the Linux kernel<span class="_ _1"></span>’<span class="_ _1"></span>s </div><div class="t m0 xc hd y134d ff98 fs7 fc3 sc0 ls1 ws1">performance.</div><div class="t m0 x1c hd y134e ff98 fs7 fc3 sc0 ls1 ws1">The Linux kernel does not use the C runtime library. That’<span class="_ _6"></span>s because </div><div class="t m0 xc hd y134f ff98 fs7 fc3 sc0 ls1 ws1">the C runtime library must be initialized once Linux is running; rather </div><div class="t m0 xc hd y1350 ff98 fs7 fc3 sc0 ls1 ws1">the Linux kernel has copies of some key runtime functions<span class="_ _3"></span>. F<span class="_ _3"></span>urthermore, </div><div class="t m0 xc hd y1351 ff98 fs7 fc3 sc0 ls1 ws1">special machine-<span class="_ _3"></span>specific, highly optimized versions ar<span class="_ _3"></span>e contained in the </div><div class="t m0 xc hd y1352 ff98 fs7 fc3 sc0 ls1 ws1">arch/arm64/lib folder<span class="_ _10"></span>. There is a lot we can learn from these functions<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1353 ff98 fs7 fc3 sc0 ls1 ws1">The Linux kernel’<span class="_ _10"></span>s vir<span class="_ _0"></span>tual memory manager deals with allocating </div><div class="t m0 xc hd y1354 ff98 fs7 fc3 sc0 ls1 ws1">memory to processes in 4K pages. M<span class="_ _1"></span>anipulating these pages efficiently </div><div class="t m0 xc hd y1355 ff98 fs7 fc3 sc0 ls1 ws1">is key to the Linux kernel performing well. W<span class="_ _1"></span>e w<span class="_ _0"></span>ill look at the k<span class="_ _3"></span>ernel’<span class="_ _6"></span>s </div><div class="t m0 xc hd y1356 ff98 fs7 fc3 sc0 ls1 ws1">implementation of cop<span class="_ _3"></span>ying a page fr<span class="_ _3"></span>om one location to another<span class="_ _10"></span>. This will </div><div class="t m0 xc hd y1357 ff98 fs7 fc3 sc0 ls1 ws1">teach us a little of how Linux kernel functions ar<span class="_ _1"></span>e implemented and learn </div><div class="t m0 xc hd y1358 ff98 fs7 fc3 sc0 ls1 ws1">a couple of new optimization techniques in the pr<span class="_ _3"></span>ocess. This particular </div><div class="t m0 xc hd y1359 ff98 fs7 fc3 sc0 ls1 ws1">function was implemented b<span class="_ _3"></span>y ARM Holdings and dona<span class="_ _3"></span>ted to the Linux </div><div class="t m0 xc hd y135a ff98 fs7 fc3 sc0 ls1 ws1">kernel, since it is in ARM’<span class="_ _6"></span>s inter<span class="_ _3"></span>est that Linux runs well on their processors<span class="_ _1"></span>.</div><div class="t m0 x1c hd y135b ff98 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">15-1</span> is the source code fr<span class="_ _1"></span>om the L<span class="_ _0"></span>inux 5.6 k<span class="_ _3"></span>ernel currently </div><div class="t m0 xc hd y135c ff98 fs7 fc3 sc0 ls1 ws1">under development<span class="_ _0"></span>; the file is arch/arm64/lib/copy_page<span class="_ _3"></span>.S<span class="_ _3"></span>.Linux kernel </div><div class="t m0 xc hd y135d ff98 fs7 fc3 sc0 ls1 ws1">source code uses both C and Assembler macr<span class="_ _1"></span>os<span class="_ _0"></span>; this routine contains </div><div class="t m0 xc hd y135e ff98 fs7 fc3 sc0 ls1 ws1">fewer than most, so this code should be largely familiar<span class="_ _10"></span>. Before you read </div><div class="t m0 xc hd y135f ff98 fs7 fc3 sc0 ls1 ws1">the following code, think of ho<span class="_ _3"></span>w you might implemen<span class="_ _3"></span>t an Assembly </div><div class="t m0 xc hd y1360 ff98 fs7 fc3 sc0 ls1 ws1">Language function to copy 4K of da<span class="_ _3"></span>ta from one place to another<span class="_ _10"></span>.</div><div class="t m0 x73 h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf155" data-dest-detail='[341,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:209.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf155" class="pf w2 h6" data-page-no="155"><div class="pc pc155 w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">330</div><div class="t m0 xd h20 y4c5 ff9f fs3 fc3 sc0 ls1 ws1">Listing 15-1. <span class="_ _15"> </span><span class="ff98">The Linux kernel<span class="_ _3"></span>’<span class="_ _6"></span>s copy page function</span></div><div class="t m0 xd h18 y4c6 ff9d fs7 fc3 sc0 ls1 ws1">/* SPDX-License-Identifier: GPL-2.0-only */</div><div class="t m0 xd h18 y4c7 ff9d fs7 fc3 sc0 ls1 ws1">/*</div><div class="t m0 xd h18 y4c8 ff9d fs7 fc3 sc0 ls1 ws1"> * Copyright (C) 2012 ARM Ltd.</div><div class="t m0 xd h18 y4c9 ff9d fs7 fc3 sc0 ls1 ws1"> */</div><div class="t m0 xd h18 y4ca ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;linux/linkage.h&gt;</div><div class="t m0 xd h18 y4cb ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;linux/const.h&gt;</div><div class="t m0 xd h18 y4cc ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;asm/assembler.h&gt;</div><div class="t m0 xd h18 y4cd ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;asm/page.h&gt;</div><div class="t m0 xd h18 y4ce ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;asm/cpufeature.h&gt;</div><div class="t m0 xd h18 y4f9 ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;asm/alternative.h&gt;</div><div class="t m0 xd h18 y4d0 ff9d fs7 fc3 sc0 ls1 ws1">/*</div><div class="t m0 xd h18 y55c ff9d fs7 fc3 sc0 ls1 ws1"> * Copy a page from src to dest (both are page aligned)</div><div class="t m0 xd h18 y55d ff9d fs7 fc3 sc0 ls1 ws1"> *</div><div class="t m0 xd h18 yafd ff9d fs7 fc3 sc0 ls1 ws1"> * Parameters:</div><div class="t m0 xd h18 yafe ff9d fs7 fc3 sc0 ls1 ws1"> *     x0 - dest</div><div class="t m0 xd h18 yaff ff9d fs7 fc3 sc0 ls1 ws1"> *     x1 - src</div><div class="t m0 xd h18 yb00 ff9d fs7 fc3 sc0 ls1 ws1"> */</div><div class="t m0 xd h18 yb01 ff9d fs7 fc3 sc0 ls1 ws1">SYM_FUNC_START(copy_page)</div><div class="t m0 xd h18 yb02 ff9d fs7 fc3 sc0 ls1 ws1">alternative_if ARM64_HAS_NO_HW_PREFETCH</div><div class="t m0 xd h18 yb03 ff9d fs7 fc3 sc0 ls1 ws1">       // Prefetch three cache lines ahead.</div><div class="t m0 xd h18 yb04 ff9d fs7 fc3 sc0 ls1 ws1">       prfm   pldl1strm, [x1, #128]</div><div class="t m0 xd h18 y505 ff9d fs7 fc3 sc0 ls1 ws1">       prfm   pldl1strm, [x1, #256]</div><div class="t m0 xd h18 y506 ff9d fs7 fc3 sc0 ls1 ws1">       prfm   pldl1strm, [x1, #384]</div><div class="t m0 xd h18 y507 ff9d fs7 fc3 sc0 ls1 ws1">alternative_else_nop_endif</div><div class="t m0 xd h18 y1049 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x2, x3, [x1]</div><div class="t m0 xd h18 y104a ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x4, x5, [x1, #16]</div><div class="t m0 xd h18 y104b ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x6, x7, [x1, #32]</div><div class="t m0 xd h18 yb05 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x8, x9, [x1, #48]</div><div class="t m0 xd h18 y1361 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x10, x11, [x1, #64]</div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf156" class="pf w2 h6" data-page-no="156"><div class="pc pc156 w2 h6"><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">331</div><div class="t m0 xc h18 y46b ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x12, x13, [x1, #80]</div><div class="t m0 xc h18 y46c ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x14, x15, [x1, #96]</div><div class="t m0 xc h18 y46d ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x16, x17, [x1, #112]</div><div class="t m0 xc h18 y85c ff9d fs7 fc3 sc0 ls1 ws1">       add    x0, x0, #256</div><div class="t m0 xc h18 y46f ff9d fs7 fc3 sc0 ls1 ws1">       add    x1, x1, #128</div><div class="t m0 xc h18 y85d ff9d fs7 fc3 sc0 ls1 ws1">1:</div><div class="t m0 xc h18 y85e ff9d fs7 fc3 sc0 ls1 ws1">       tst    x0, #(PAGE_SIZE - 1)</div><div class="t m0 xc h18 yb67 ff9d fs7 fc3 sc0 ls1 ws1">alternative_if ARM64_HAS_NO_HW_PREFETCH</div><div class="t m0 xc h18 y848 ff9d fs7 fc3 sc0 ls1 ws1">       prfm   pldl1strm, [x1, #384]</div><div class="t m0 xc h18 y849 ff9d fs7 fc3 sc0 ls1 ws1">alternative_else_nop_endif</div><div class="t m0 xc h18 yb69 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x2, x3, [x0, #-256]</div><div class="t m0 xc h18 y127c ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x2, x3, [x1]</div><div class="t m0 xc h18 y84c ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x4, x5, [x0, #16 - 256]</div><div class="t m0 xc h18 y62d ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x4, x5, [x1, #16]</div><div class="t m0 xc h18 y84d ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x6, x7, [x0, #32 - 256]</div><div class="t m0 xc h18 y84e ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x6, x7, [x1, #32]</div><div class="t m0 xc h18 y84f ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x8, x9, [x0, #48 - 256]</div><div class="t m0 xc h18 y850 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x8, x9, [x1, #48]</div><div class="t m0 xc h18 y851 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x10, x11, [x0, #64 - 256]</div><div class="t m0 xc h18 y852 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x10, x11, [x1, #64]</div><div class="t m0 xc h18 y853 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x12, x13, [x0, #80 - 256]</div><div class="t m0 xc h18 y854 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x12, x13, [x1, #80]</div><div class="t m0 xc h18 y855 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x14, x15, [x0, #96 - 256]</div><div class="t m0 xc h18 y856 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x14, x15, [x1, #96]</div><div class="t m0 xc h18 y857 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x16, x17, [x0, #112 - 256]</div><div class="t m0 xc h18 y858 ff9d fs7 fc3 sc0 ls1 ws1">       ldp    x16, x17, [x1, #112]</div><div class="t m0 xc h18 yd70 ff9d fs7 fc3 sc0 ls1 ws1">       add    x0, x0, #128</div><div class="t m0 xc h18 yd71 ff9d fs7 fc3 sc0 ls1 ws1">       add    x1, x1, #128</div><div class="t m0 xc h18 y104c ff9d fs7 fc3 sc0 ls1 ws1">       b.ne   1b</div><div class="t m0 x73 h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf157" class="pf w2 h6" data-page-no="157"><div class="pc pc157 w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">332</div><div class="t m0 xd h18 y46b ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x2, x3, [x0, #-256]</div><div class="t m0 xd h18 y46c ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x4, x5, [x0, #16 - 256]</div><div class="t m0 xd h18 y46d ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x6, x7, [x0, #32 - 256]</div><div class="t m0 xd h18 y623 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x8, x9, [x0, #48 - 256]</div><div class="t m0 xd h18 y624 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x10, x11, [x0, #64 - 256]</div><div class="t m0 xd h18 y625 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x12, x13, [x0, #80 - 256]</div><div class="t m0 xd h18 y626 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x14, x15, [x0, #96 - 256]</div><div class="t m0 xd h18 y627 ff9d fs7 fc3 sc0 ls1 ws1">       stnp   x16, x17, [x0, #112 - 256]</div><div class="t m0 xd h18 y85f ff9d fs7 fc3 sc0 ls1 ws1">       ret</div><div class="t m0 xd h18 y629 ff9d fs7 fc3 sc0 ls1 ws1">SYM_FUNC_END(copy_page)</div><div class="t m0 xd h18 y62a ff9d fs7 fc3 sc0 ls1 ws1">EXPORT_SYMBOL(copy_page)</div><div class="t m0 xc hd y84b ff98 fs7 fc3 sc0 ls1 ws1">I suspect this implementation isn’t wh<span class="_ _3"></span>at you’<span class="_ _10"></span>d expect to implement. </div><div class="t m0 xd hd y62c ff98 fs7 fc3 sc0 ls1 ws1">So<span class="_ _3"></span>, let’<span class="_ _6"></span>s go through how this function works and why it’<span class="_ _6"></span>s implemented the </div><div class="t m0 xd hd y860 ff98 fs7 fc3 sc0 ls1 ws1">way it is<span class="_ _1"></span>.</div><div class="t m0 xd h2a y478 ff9c fsf fc3 sc0 ls1 wsbb"> About <span class="_ _1b"> </span>theAlgorithm</div><div class="t m0 xd hd yb5b ff98 fs7 fc3 sc0 ls1 ws1">This ro<span class="_ _3"></span>utine copies 128 bytes at a time b<span class="_ _3"></span>y loading 16 64-bit (8-byte) </div><div class="t m0 xd hd y1362 ff98 fs7 fc3 sc0 ls1 ws1">registers with data<span class="_ _3"></span>. Why does it do this? Why not j<span class="_ _3"></span>ust copy 16 b<span class="_ _3"></span>ytes at a </div><div class="t m0 xd hd y1363 ff98 fs7 fc3 sc0 ls1 ws1">time using repea<span class="_ _3"></span>ted <span class="ffa0">LDP</span>/<span class="ffa0 ls1c wsbf">STP</span> instructions? There are two r<span class="_ _3"></span>easons for this<span class="_ _0"></span>:</div><div class="t m0 xc hd y1364 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Loop unrolling: The code only loops 31 times. </div><div class="t m0 x1e hd y1365 ff98 fs7 fc3 sc0 ls1 ws1">This reduces the n<span class="_ _3"></span>umber of times the loop-rela<span class="_ _3"></span>ted </div><div class="t m0 x1e hd y1366 ff98 fs7 fc3 sc0 ls1 ws1">instructions execute.</div><div class="t m0 xc hd y1367 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Par<span class="_ _1"></span>allel processing: Notice tha<span class="_ _3"></span>t the code does all </div><div class="t m0 x1e hd y1368 ff98 fs7 fc3 sc0 ls1 ws1">the <span class="ffa0">LDP</span> instruction ahead of the <span class="ffa0 ls1c wsbf">STP</span> instructions. </div><div class="t m0 x1e hd y1369 ff98 fs7 fc3 sc0 ls1 ws1">This way the instruction pipeline can execute quite </div><div class="t m0 x1e hd y136a ff98 fs7 fc3 sc0 ls1 ws1">a few of these instructions in parallel, since the data </div><div class="t m0 x1e hd y136b ff98 fs7 fc3 sc0 ls1 ws1">isn’t used until much later<span class="_ _10"></span>. If your particular ARM </div><div class="t m0 x1e hd y136c ff98 fs7 fc3 sc0 ls1 ws1">processor has a deep instruction pipeline<span class="_ _3"></span>, this can </div><div class="t m0 x1e hd y136d ff98 fs7 fc3 sc0 ls1 ws1">grea<span class="_ _3"></span>tly help<span class="_ _1"></span>.</div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf158" class="pf w2 h6" data-page-no="158"><div class="pc pc158 w2 h6"><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">333</div><div class="t m0 x1c hd y145 ff98 fs7 fc3 sc0 ls1 ws1">The loop is a bit strange<span class="_ _1"></span>. It uses a <span class="ffa0 ls1c wsbf">TST<span class="_ _0"></span></span> instruction ra<span class="_ _3"></span>ther than a <span class="ffa0">CMP</span> </div><div class="t m0 xc hd y146 ff98 fs7 fc3 sc0 ls1 ws1">instruction to test if we’r<span class="_ _3"></span>e done. <span class="ffa0 ls1c wsbf">TST</span> is just like <span class="ffa0">CMP</span>, except it uses <span class="ffa0">ANDS</span> </div><div class="t m0 xc hd y147 ff98 fs7 fc3 sc0 ls1 ws1">rather th<span class="_ _3"></span>an <span class="ffa0 ls1c wsbf">SUBS</span> to do the compar<span class="_ _0"></span>ison. I<span class="_ _3"></span>s this being clever for the sake of </div><div class="t m0 xc hd y1b0 ff98 fs7 fc3 sc0 ls1 ws1">being clever? Her<span class="_ _1"></span>e are a few points about this loop:</div><div class="t m0 x1c hd y149 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>It adds 256 right a<span class="_ _1"></span>way to <span class="ffa0">X0;</span> the destination pointer </div><div class="t m0 x9 hd y14a ff98 fs7 fc3 sc0 ls1 ws1">then must der<span class="_ _3"></span>eference the values with nega<span class="_ _3"></span>tive </div><div class="t m0 x9 hd y1cb ff98 fs7 fc3 sc0 ls1 ws1">offsets. This is necessary since the starting address </div><div class="t m0 x9 hd y1cc ff98 fs7 fc3 sc0 ls1 ws1">is on a page boundary, and the test would abort the </div><div class="t m0 x9 hd y1cd ff98 fs7 fc3 sc0 ls1 ws1">loop right awa<span class="_ _1"></span>y if w<span class="_ _0"></span>e didn’t add something first<span class="_ _3"></span>.  </div><div class="t m0 x9 hd y1ce ff98 fs7 fc3 sc0 ls1 ws1">It adds 256 r<span class="_ _3"></span>ather than 128, since the first set of </div><div class="t m0 x9 hd y1cf ffa0 fs7 fc3 sc0 ls1 ws1">LDP<span class="ff98">s are done befor<span class="_ _3"></span>e the loop and the last set of </span></div><div class="t m0 x9 hd y1b8 ffa0 fs7 fc3 sc0 ls1c wsbf">STP<span class="ff98 ls1 ws1">s are done after the loop<span class="_ _1"></span>. This gives the correct </span></div><div class="t m0 x9 hd y1b9 ff98 fs7 fc3 sc0 ls1 ws1">number of itera<span class="_ _3"></span>tions.</div><div class="t m0 x1c hd y1d1 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>This routine uses all the corruptible registers<span class="_ _1"></span>, except </div><div class="t m0 x9 hd y1d2 ff98 fs7 fc3 sc0 ls1 ws1">for one. This means it doesn’t need to push or pop </div><div class="t m0 x9 hd y1d3 ff98 fs7 fc3 sc0 ls1 ws1">any registers t<span class="_ _3"></span>o or from the stack<span class="_ _3"></span>. Register <span class="ffa0">X19</span> is </div><div class="t m0 x9 hd y1d4 ff98 fs7 fc3 sc0 ls1 ws1">still av<span class="_ _3"></span>ailable to use and this could stor<span class="_ _3"></span>e the original </div><div class="t m0 x9 hd y1d5 ff98 fs7 fc3 sc0 ls1 ws1">address<span class="_ _1"></span>, so w<span class="_ _0"></span>e can test with <span class="ffa0">CMP</span> to see when we hit </div><div class="t m0 x9 hd y136e ff98 fs7 fc3 sc0 ls1 ws1">the end of the page, or it could be used as a r<span class="_ _3"></span>egular </div><div class="t m0 x9 hd y136f ff98 fs7 fc3 sc0 ls1 ws1">counter<span class="_ _10"></span>. Perhaps<span class="_ _3"></span>, this would lead to more r<span class="_ _1"></span>eadable </div><div class="t m0 x9 hd y1c1 ff98 fs7 fc3 sc0 ls1 ws1">code, without r<span class="_ _3"></span>equiring extra o<span class="_ _3"></span>verhead.</div><div class="t m0 x1c hd y1d9 ff98 fs7 fc3 sc0 ls1 wscc"> <span class="_ _2"></span>3. The <span class="_ _54"></span><span class="ffa0 ls1c wsbf">TST<span class="ff98 ls1 ws1"> is a long distance in the code from the </span></span></div><div class="t m0 x9 hd y1da ffa0 fs7 fc3 sc0 ls1 ws1">B.NE<span class="ff98"> that uses the r<span class="_ _3"></span>esult. This can be confusing<span class="_ _3"></span>, </span></div><div class="t m0 x9 hd y1db ff98 fs7 fc3 sc0 ls1 ws1">since when you see the <span class="ffa0">B.NE</span>, it isn’t obvious who is </div><div class="t m0 x9 hd y1c5 ff98 fs7 fc3 sc0 ls1 ws1">setting the condition flags for it.</div><div class="t m0 x1c hd y1dd ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>It r<span class="_ _3"></span>elies on the pointers being page aligned (which </div><div class="t m0 x9 hd y1de ff98 fs7 fc3 sc0 ls1 ws1">they’re specified to be).</div><div class="t m0 x1c hd y160 ff98 fs7 fc3 sc0 ls1a ws1"> <span class="_ _16"> </span>5<span class="_ _0"></span>. <span class="_ _21"> </span>It uses 1b as the label r<span class="_ _3"></span>ather than something mor<span class="_ _1"></span>e<span class="_ _0"></span> </div><div class="t m0 x9 hd y161 ff98 fs7 fc3 sc0 ls1a ws1">descriptive. Per<span class="_ _3"></span>haps<span class="_ _3"></span>, this was a macr<span class="_ _3"></span>o at one time<span class="_ _3"></span>, but </div><div class="t m0 x9 hd y162 ff98 fs7 fc3 sc0 ls1a ws1">currently this is a function, so a descriptive label is okay.</div><div class="t m0 x73 h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf159" class="pf w2 h6" data-page-no="159"><div class="pc pc159 w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">334</div><div class="t m0 xc hd y145 ff98 fs7 fc3 sc0 ls1 ws1">I think the loop would’<span class="_ _3"></span>ve been better accomplished in a more typic<span class="_ _3"></span>al </div><div class="t m0 xd hd y146 ff98 fs7 fc3 sc0 ls1 ws1">fashion.</div><div class="t m0 xd h2a y6e7 ff9c fsf fc3 sc0 ls1 ws1"> <span class="_ _1a"></span>Macros andKernel Options</div><div class="t m0 xd hd y30e ff98 fs7 fc3 sc0 ls1 ws1">The macr<span class="_ _3"></span>os SYM_FUNC_ST<span class="_ _6"></span>ART<span class="_ _10"></span>, SYM_FUNC_END, and EXPORT_</div><div class="t m0 xd hd y1370 ff98 fs7 fc3 sc0 ls1 ws1">SYMBOL are defined in include/lin<span class="_ _3"></span>ux/linkage.h<span class="_ _3"></span>. They contain the GNU </div><div class="t m0 xd hd y1371 ff98 fs7 fc3 sc0 ls1 ws1">Assembler directives to ensur<span class="_ _1"></span>e the routine is aligned properly and the </div><div class="t m0 xd hd y1372 ff98 fs7 fc3 sc0 ls1 ws1">function name is global.</div><div class="t m0 xc hd y1373 ff98 fs7 fc3 sc0 lsf ws1">The macr<span class="_ _3"></span>os alternative_if and altern<span class="_ _3"></span>ative_else_nop_endif ar<span class="_ _3"></span>e defined </div><div class="t m0 xd hd y1374 ff98 fs7 fc3 sc0 lsf ws1">in arch/arm64/include/asm/alterna<span class="_ _3"></span>tive.h<span class="_ _3"></span>. They pro<span class="_ _1"></span>vide a configurable </div><div class="t m0 xd hd y1375 ff98 fs7 fc3 sc0 lsf ws1">mechanism to configur<span class="_ _3"></span>e the Linux kernel depending on the exact feat<span class="_ _3"></span>ures </div><div class="t m0 xd hd y1376 ff98 fs7 fc3 sc0 lsf ws1">that a given pr<span class="_ _1"></span>o<span class="_ _0"></span>cessor contains<span class="_ _1"></span>. The folder arch/arm64/include/asm has </div><div class="t m0 xd hd y1377 ff98 fs7 fc3 sc0 lsf wsa9">several inter<span class="_ _1"></span>esting Assembly Language include files that ar<span class="_ _1"></span>e w<span class="_ _0"></span>orth looking at<span class="_ _3"></span>.</div><div class="t m0 xc hd y1378 ff98 fs7 fc3 sc0 ls1 ws1">In this case if the ARM pr<span class="_ _3"></span>ocessor has memory prefetch, then we </div><div class="t m0 xd hd y1379 ff98 fs7 fc3 sc0 ls1 ws1">include instructions like</div><div class="t m0 xd h18 y137a ff9d fs7 fc3 sc0 ls1 ws1">prfm   pldl1strm, [x1, #128]</div><div class="t m0 xc hd y137b ff98 fs7 fc3 sc0 ls1 ws1">The preceding instruction asks the pr<span class="_ _3"></span>ocessor to load the data stor<span class="_ _3"></span>ed </div><div class="t m0 xd hd y137c ff98 fs7 fc3 sc0 ls1 ws1">at this addres<span class="_ _3"></span>s into the <span class="ffa0">L1</span> cache<span class="_ _3"></span>. The inten<span class="_ _3"></span>t being that when we get to the </div><div class="t m0 xd hd y137d ffa0 fs7 fc3 sc0 ls1 ws1">LDP<span class="ff98"> instructions, the data will alr<span class="_ _3"></span>eady be in the cache and execute faster<span class="_ _10"></span>. </span></div><div class="t m0 xd hd y137e ff98 fs7 fc3 sc0 ls1 ws1">The string <span class="ffa0">pldl1strm</span> means</div><div class="t m0 xc hd y137f ff98 fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ffa0 ws1">pld<span class="ff98">: Preload the data<span class="_ _3"></span>.</span></span></div><div class="t m0 xc hd y1380 ff98 fs7 fc3 sc0 ls1 wsad"> 2. <span class="_ _6"></span><span class="ffa0 ws1">l1<span class="ff98">: Load into the L1 cache.</span></span></div><div class="t m0 xc hd y1381 ff98 fs7 fc3 sc0 ls1 wsad"> 3. <span class="_ _6"></span><span class="ffa0 ws1">strm<span class="ff98">: Stream the da<span class="_ _3"></span>ta starting at the specified </span></span></div><div class="t m0 x1e hd y1382 ff98 fs7 fc3 sc0 ls1 ws1">address<span class="_ _1"></span>. It also implies the data will only be used </div><div class="t m0 x1e hd y1383 ff98 fs7 fc3 sc0 ls1 ws1">once; then it can be discarded.</div><div class="t m0 xc hd y1384 ff98 fs7 fc3 sc0 ls1 ws1">Similarly, the r<span class="_ _3"></span>outine uses <span class="ffa0">STNP</span> to store the r<span class="_ _1"></span>egister pair<span class="_ _6"></span>. This </div><div class="t m0 xd hd y1385 ff98 fs7 fc3 sc0 ls1 ws1">instruction is the same as <span class="ffa0 ls1c wsbf">STP</span>; the <span class="ffa0">N</span> is a non-temporal hint tha<span class="_ _3"></span>t we’r<span class="_ _3"></span>e </div><div class="t m0 xd hd y1386 ff98 fs7 fc3 sc0 ls1 ws1">done with the cache value. T<span class="_ _3"></span>he processor can also use this as a hint tha<span class="_ _3"></span>t </div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf15a" class="pf w2 h6" data-page-no="15a"><div class="pc pc15a w2 h6"><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">335</div><div class="t m0 xc hd y145 ff98 fs7 fc3 sc0 ls1 ws1">nearby memory addresses will be saved shortly, and it can ba<span class="_ _3"></span>tch the </div><div class="t m0 xc hd y146 ff98 fs7 fc3 sc0 ls1 ws1">memory op<span class="_ _0"></span>er<span class="_ _3"></span>ations together if that helps performance<span class="_ _3"></span>.</div><div class="t m0 x1c hd y147 ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ve s<span class="_ _3"></span>pent quite a bit of time writing our own Assembly Language; </div><div class="t m0 xc hd y1b0 ff98 fs7 fc3 sc0 ls1 ws1">let’<span class="_ _1"></span>s ha<span class="_ _1"></span>ve a look at how the GNU C compiler writes Assembly code.</div><div class="t m0 xc h15 y30f ff9c fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Code Created by GCC</div><div class="t m0 xc hd y57a ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll code our upper<span class="_ _1"></span>-case routine in C and compar<span class="_ _3"></span>e the generated code </div><div class="t m0 xc hd y57b ff98 fs7 fc3 sc0 ls1 ws1">to what we wr<span class="_ _3"></span>ote. F<span class="_ _1"></span>or this example, we want <span class="ffa0 ls7 ws6f">gcc</span> to do as good a job as </div><div class="t m0 xc hd y57c ff98 fs7 fc3 sc0 ls1 ws1">possible, so we’ll use the <span class="ffa0">-O3</span> option for m<span class="_ _3"></span>aximal optimization.</div><div class="t m0 x1c hd y57d ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e create upper<span class="_ _10"></span>.c from Listing <span class="fc5">15-2</span>.</div><div class="t m0 xc h20 ya9a ff9f fs3 fc3 sc0 ls1 ws1">Listing 15-2. <span class="_ _15"> </span><span class="ff98">C implementation of the m<span class="_ _3"></span>ytoupper r<span class="_ _3"></span>outine</span></div><div class="t m0 xc h18 y12e8 ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;stdio.h&gt;</div><div class="t m0 xc h18 y1387 ff9d fs7 fc3 sc0 ls1 ws1">int mytoupper(char *instr, char *outstr)</div><div class="t m0 xc h18 y1388 ff9d fs7 fc3 sc0 ls1 ws1">{</div><div class="t m0 xc h18 y1389 ff9d fs7 fc3 sc0 ls1 ws1">      char cur;</div><div class="t m0 xc h18 y138a ff9d fs7 fc3 sc0 ls1 ws1">      char *orig_outstr = outstr;</div><div class="t m0 xc h18 y138b ff9d fs7 fc3 sc0 ls1 ws1">      do</div><div class="t m0 xc h18 y138c ff9d fs7 fc3 sc0 ls1 ws1">      {</div><div class="t m0 xc h18 y138d ff9d fs7 fc3 sc0 ls1 ws1">            cur = *instr;</div><div class="t m0 xc h18 y138e ff9d fs7 fc3 sc0 ls1 ws1">            if ((cur &gt;= &apos;a&apos;) &amp;&amp; (cur &lt;=&apos;z&apos;))</div><div class="t m0 xc h18 y138f ff9d fs7 fc3 sc0 ls1 ws1">            {</div><div class="t m0 xc h18 y1390 ff9d fs7 fc3 sc0 ls1 ws1">                 cur = cur - (&apos;a&apos;-&apos;A&apos;);</div><div class="t m0 xc h18 y1391 ff9d fs7 fc3 sc0 ls1 ws1">            }</div><div class="t m0 xc h18 y1392 ff9d fs7 fc3 sc0 ls1 ws1">            *outstr++ = cur;</div><div class="t m0 xc h18 y1393 ff9d fs7 fc3 sc0 ls1 ws1">            instr++;</div><div class="t m0 xc h18 y1394 ff9d fs7 fc3 sc0 ls1 ws1">      } while (cur != &apos;\0&apos;);</div><div class="t m0 xc h18 y1395 ff9d fs7 fc3 sc0 ls1 ws1">      return( outstr - orig_outstr );</div><div class="t m0 xc h18 y1396 ff9d fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 x73 h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf15a" data-dest-detail='[346,"XYZ",53,396,null]'><div class="d m1" style="border-style:none;position:absolute;left:216.329000px;bottom:409.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf15b" class="pf w2 h6" data-page-no="15b"><div class="pc pc15b w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">336</div><div class="t m0 xd h18 y46b ff9d fs7 fc3 sc0 ls1 ws1">#define BUFFERSIZE 250</div><div class="t m0 xd h18 ye19 ff9d fs7 fc3 sc0 ls1 ws1">char *tstStr = &quot;This is a test!&quot;;</div><div class="t m0 xd h18 ya17 ff9d fs7 fc3 sc0 ls1 ws1">char outStr[BUFFERSIZE];</div><div class="t m0 xd h18 ye1b ff9d fs7 fc3 sc0 ls1 ws1">int main()</div><div class="t m0 xd h18 y910 ff9d fs7 fc3 sc0 ls1 ws1">{</div><div class="t m0 xd h18 y470 ff9d fs7 fc3 sc0 ls1 ws1">      mytoupper(tstStr, outStr);</div><div class="t m0 xd h18 y471 ff9d fs7 fc3 sc0 ls1 ws1">      printf(&quot;Input: %s\nOutput: %s\n&quot;, tstStr, outStr);</div><div class="t m0 xd h18 y911 ff9d fs7 fc3 sc0 ls1 ws1">      return(0);</div><div class="t m0 xd h18 y912 ff9d fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 xc hd yaee ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can compile this with</div><div class="t m0 xd h18 yaef ff9d fs7 fc3 sc0 ls1 ws1">gcc -O3 -o upper upper.c</div><div class="t m0 xc hd y1397 ff98 fs7 fc3 sc0 ls1 ws1">and then run objdump to see the generated code:</div><div class="t m0 xd h18 y1125 ff9d fs7 fc3 sc0 ls1 ws1">objdump -d upper &gt;od.txt</div><div class="t m0 xc hd y1398 ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e get Listing <span class="fc5">15-3</span>.</div><div class="t m0 xd h20 y1399 ff9f fs3 fc3 sc0 ls1 ws1">Listing 15-3. <span class="_ _15"> </span><span class="ff98">Assembly code generated b<span class="_ _3"></span>y the C compiler for our </span></div><div class="t m0 xd h20 y139a ff98 fs3 fc3 sc0 ls1 ws1">upper<span class="_ _1"></span>-case function</div><div class="t m0 xd h18 y139b ff9d fs7 fc3 sc0 ls1 ws1">0000000000000690 &lt;main&gt;:</div><div class="t m0 xd h18 y139c ff9d fs7 fc3 sc0 ls1 ws1"> 690:    a9bf7bfd    stp    x29, x30, [sp, #-16]!</div><div class="t m0 xd h18 y139d ff9d fs7 fc3 sc0 ls1 ws1"> 694:    b0000080    adrp   x0, 11000  <span class="_ _20"></span>&lt;__cxa_finalize </div><div class="t m0 x46 h18 y139e ff9d fs7 fc3 sc0 ls1 ws1">@GLIBC_2.17&gt;</div><div class="t m0 xd h18 y139f ff9d fs7 fc3 sc0 ls1 ws1"> 698:    90000082    adrp   x2, 10000 &lt;__FRAME_END__+0xf588&gt;</div><div class="t m0 xd h18 y13a0 ff9d fs7 fc3 sc0 ls1 ws1"> 69c:    910003fd    mov    x29, sp</div><div class="t m0 xd h18 y13a1 ff9d fs7 fc3 sc0 ls1 ws1"> 6a0:    f9401c01    ldr    x1, [x0, #56]</div><div class="t m0 xd h18 y13a2 ff9d fs7 fc3 sc0 ls1 ws1"> 6a4:    f947dc44    ldr    x4, [x2, #4024]</div><div class="t m0 xd h18 y13a3 ff9d fs7 fc3 sc0 ls1 ws1"> 6a8:    aa0103e5    mov    x5, x1</div><div class="t m0 xd h18 y13a4 ff9d fs7 fc3 sc0 ls1 ws1"> 6ac:    384014a0    ldrb   w0, [x5], #1</div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf15b" data-dest-detail='[347,"XYZ",35,291,null]'><div class="d m1" style="border-style:none;position:absolute;left:121.605000px;bottom:305.186000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf15c" class="pf w2 h6" data-page-no="15c"><div class="pc pc15c w2 h6"><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">337</div><div class="t m0 xc h18 y46b ff9d fs7 fc3 sc0 ls1 ws1"> 6b0:    91000484    add    x4, x4, #0x1</div><div class="t m0 xc h18 y46c ff9d fs7 fc3 sc0 ls1 ws1"> 6b4:    51018403    sub    w3, w0, #0x61</div><div class="t m0 xc h18 y46d ff9d fs7 fc3 sc0 ls1 ws1"> 6b8:    51008006    sub    w6, w0, #0x20</div><div class="t m0 xc h18 y623 ff9d fs7 fc3 sc0 ls1 ws1"> 6bc:    12001c63    and    w3, w3, #0xff</div><div class="t m0 xc h18 y624 ff9d fs7 fc3 sc0 ls1 ws1"> 6c0:    7100647f    cmp    w3, #0x19</div><div class="t m0 xc h18 y625 ff9d fs7 fc3 sc0 ls1 ws1"> 6c4:    54000128    b.hi   6e8 &lt;main+0x58&gt;  // b.pmore</div><div class="t m0 xc h18 y626 ff9d fs7 fc3 sc0 ls1 ws1"> 6c8:    381ff086    sturb  w6, [x4, #-1]</div><div class="t m0 xc h18 y627 ff9d fs7 fc3 sc0 ls1 ws1"> 6cc:    91000484    add    x4, x4, #0x1</div><div class="t m0 xc h18 y628 ff9d fs7 fc3 sc0 ls1 ws1"> 6d0:    384014a0    ldrb   w0, [x5], #1</div><div class="t m0 xc h18 y9f6 ff9d fs7 fc3 sc0 ls1 ws1"> 6d4:    51018403    sub    w3, w0, #0x61</div><div class="t m0 xc h18 y9f7 ff9d fs7 fc3 sc0 ls1 ws1"> 6d8:    51008006    sub    w6, w0, #0x20</div><div class="t m0 xc h18 y9f8 ff9d fs7 fc3 sc0 ls1 ws1"> 6dc:    12001c63    and    w3, w3, #0xff</div><div class="t m0 xc h18 yb8d ff9d fs7 fc3 sc0 ls1 ws1"> 6e0:    7100647f    cmp    w3, #0x19</div><div class="t m0 xc h18 yb8e ff9d fs7 fc3 sc0 ls1 ws1"> 6e4:    54ffff29    b.ls   6c8 &lt;main+0x38&gt;  // b.plast</div><div class="t m0 xc h18 yb8f ff9d fs7 fc3 sc0 ls1 ws1"> 6e8:    381ff080    sturb  w0, [x4, #-1]</div><div class="t m0 xc h18 yb90 ff9d fs7 fc3 sc0 ls1 ws1"> 6ec:    35fffe00    cbnz   w0, 6ac &lt;main+0x1c&gt;</div><div class="t m0 xc h18 yb91 ff9d fs7 fc3 sc0 ls1 ws1"> 6f0:    f947dc42    ldr    x2, [x2, #4024]</div><div class="t m0 xc h18 yc1f ff9d fs7 fc3 sc0 ls1 ws1"> 6f4:    90000000    adrp   x0, 0 &lt;_init-0x600&gt;</div><div class="t m0 xc h18 yc20 ff9d fs7 fc3 sc0 ls1 ws1"> 6f8:    91242000    add    x0, x0, #0x908</div><div class="t m0 xc h18 yc21 ff9d fs7 fc3 sc0 ls1 ws1"> 6fc:    97ffffe1    bl     680 &lt;printf@plt&gt;</div><div class="t m0 xc h18 yc22 ff9d fs7 fc3 sc0 ls1 ws1"> 700:    52800000    mov    w0, #0x0         // #0</div><div class="t m0 xc h18 yc23 ff9d fs7 fc3 sc0 ls1 ws1"> 704:    a8c17bfd    ldp    x29, x30, [sp], #16</div><div class="t m0 xc h18 yc24 ff9d fs7 fc3 sc0 ls1 ws1"> 708:    d65f03c0    ret</div><div class="t m0 x1c hd yd5d ff98 fs7 fc3 sc0 ls1 ws1">A few things to notice about this listing:</div><div class="t m0 x1e hd y13a5 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The compiler autom<span class="_ _3"></span>atically inlined the myto<span class="_ _3"></span>upper </div><div class="t m0 x9 hd y13a6 ff98 fs7 fc3 sc0 ls1 ws1">function like our macr<span class="_ _1"></span>o version. The mytoupper </div><div class="t m0 x9 hd y13a7 ff98 fs7 fc3 sc0 ls1 ws1">function is elsewhere in the listing, in c<span class="_ _3"></span>ase it’<span class="_ _1"></span>s called </div><div class="t m0 x9 hd y13a8 ff98 fs7 fc3 sc0 ls1 ws1">from another file<span class="_ _1"></span>.</div><div class="t m0 x73 h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf15d" class="pf w2 h6" data-page-no="15d"><div class="pc pc15d w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">338</div><div class="t m0 xa hd y145 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The compiler knows about the r<span class="_ _1"></span>ange optimization and </div><div class="t m0 x1e hd y146 ff98 fs7 fc3 sc0 ls1 ws1">shifted the range<span class="_ _3"></span>, so it only does one comparison. The </div><div class="t m0 x1e hd y147 ff98 fs7 fc3 sc0 ls1 ws1">shift is performed by</div><div class="t m0 x1e h18 y2d7 ff9d fs7 fc3 sc0 ls1 ws1">sub   w3, w0, #0x61</div><div class="t m0 xa hd y567 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The compiler sets up a stack frame<span class="_ _1"></span>, but doesn’t use it, </div><div class="t m0 x1e hd y2d9 ff98 fs7 fc3 sc0 ls1 ws1">because all the variables fit in the corruptible registers<span class="_ _3"></span>. </div><div class="t m0 x1e hd y2da ff98 fs7 fc3 sc0 ls1 ws1">As a result<span class="_ _3"></span>, it only sav<span class="_ _3"></span>es and restor<span class="_ _1"></span>es the <span class="ffa0 ls24 wsc2">LR</span> and <span class="ffa0">FP</span> </div><div class="t m0 x1e hd y231 ff98 fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>.</div><div class="t m0 xa hd y13a9 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The compiler uses the <span class="ffa0">ADRP</span> instruction to load the </div><div class="t m0 x1e hd y13aa ff98 fs7 fc3 sc0 ls1 ws1">values of pointers<span class="_ _3"></span>. W<span class="_ _1"></span>e cover<span class="_ _3"></span>ed <span class="ffa0">ADR</span> in Chapter <span class="fc5">5</span>, </div><div class="t m0 x1e hd y13ab ff98 fs7 fc3 sc0 ls1 ws1">“Thanks for the Memories<span class="_ _3"></span>”; <span class="ffa0">ADRP</span> works like <span class="ffa0">ADR</span>, </div><div class="t m0 x1e hd y2e6 ff98 fs7 fc3 sc0 ls1 ws1">except that it loads to a 4K pa<span class="_ _3"></span>ge boundary. This means </div><div class="t m0 x1e hd y13ac ff98 fs7 fc3 sc0 ls1 ws1">that it has a gr<span class="_ _1"></span>eater range than ADR, but for hum<span class="_ _3"></span>ans </div><div class="t m0 x1e hd y13ad ff98 fs7 fc3 sc0 ls1 ws1">it’<span class="_ _1"></span>s har<span class="_ _1"></span>der to us<span class="_ _0"></span>e<span class="_ _3"></span>. The compiler must set it to a page </div><div class="t m0 x1e hd y13ae ff98 fs7 fc3 sc0 ls1 ws1">boundary, which in this case points to C runtime </div><div class="t m0 x1e hd y13af ff98 fs7 fc3 sc0 ls1 ws1">data and then uses cumbersome offsets to get to the </div><div class="t m0 x1e hd y13b0 ff98 fs7 fc3 sc0 ls1 ws1">correct data<span class="_ _3"></span>. This is good for compilers, not so good for </div><div class="t m0 x1e hd y13b1 ff98 fs7 fc3 sc0 ls1 ws1">humans to code<span class="_ _3"></span>.</div><div class="t m0 xa hd y13b2 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The compiler uses the <span class="ffa0 ls1f wsc7">CBNZ</span> instruction, which we’ll </div><div class="t m0 x1e hd y952 ff98 fs7 fc3 sc0 ls1 ws1">discuss shortly.</div><div class="t m0 xa hd y13b3 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>There ar<span class="_ _1"></span>e a few occur<span class="_ _0"></span>r<span class="_ _3"></span>ences of</div><div class="t m0 x1e h18 y13b4 ff9d fs7 fc3 sc0 ls1 ws1">and   w3, w3, #0xff</div><div class="t m0 x1e hd y13b5 ff98 fs7 fc3 sc0 ls35 ws1">This is to maintain type corr<span class="_ _3"></span>ectness in C.A C char </div><div class="t m0 x1e hd y13b6 ff98 fs7 fc3 sc0 ls35 ws1">data type is an unsigned 8-bit number<span class="_ _10"></span>. When we </div><div class="t m0 x1e hd y13b7 ff98 fs7 fc3 sc0 ls35 ws1">subtract, it co<span class="_ _3"></span>uld go negative<span class="_ _3"></span>, resultin<span class="_ _3"></span>g in the </div><div class="t m0 x1e hd y13b8 ff98 fs7 fc3 sc0 ls35 ws1">upper 8 bits of <span class="ffa0 wsda">W3</span> being set to 1. This corrects it<span class="_ _3"></span> </div><div class="t m0 x1e hd y13b9 ff98 fs7 fc3 sc0 ls35 ws1">back to an unsigned quantity. W<span class="_ _1"></span>e never did this,<span class="_ _1"></span> </div><div class="t m0 x1e hd y13ba ff98 fs7 fc3 sc0 ls35 ws1">because we knew we’<span class="_ _6"></span>d only ever sa<span class="_ _3"></span>ve this as 8 bits </div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:303.210000px;bottom:411.175000px;width:5.500000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf15e" class="pf w2 h6" data-page-no="15e"><div class="pc pc15e w2 h6"><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">339</div><div class="t m0 x9 hd y145 ff98 fs7 fc3 sc0 ls35 wsda">using <span class="ffa0">STRB</span><span class="ws1">; therefore<span class="_ _1"></span>, we knew the upp<span class="_ _0"></span>er bits<span class="_ _1"></span> </span></div><div class="t m0 x9 hd y146 ff98 fs7 fc3 sc0 ls35 ws1">would be ignored wha<span class="_ _3"></span>tever they are<span class="_ _1"></span>.</div><div class="t m0 x1e hd yc78 ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>For com<span class="_ _3"></span>piler accesses outstr via register <span class="ffa0">X4</span>. S<span class="_ _1"></span>trangely, </div><div class="t m0 x9 hd yc8a ff98 fs7 fc3 sc0 ls1 ws1">it adds one to this first, then r<span class="_ _3"></span>eferences it with a -1 </div><div class="t m0 x9 hd y6e2 ff98 fs7 fc3 sc0 ls1 ws1">offset. This res<span class="_ _3"></span>ults in an unnecessary <span class="ffa0">ADD</span> instr<span class="_ _0"></span>uction.</div><div class="t m0 x1e hd yeef ff98 fs7 fc3 sc0 ls1 ws1">• <span class="_ _c"> </span>The compiler alway<span class="_ _3"></span>s performs the case conversion with</div><div class="t m0 x9 h18 y13bb ff9d fs7 fc3 sc0 ls1 ws1">sub   w6, w0, #0x20</div><div class="t m0 x9 hd yc7d ff98 fs7 fc3 sc0 ls1 ws1">Then based on the comparison, it either saves <span class="ffa0">W6</span> </div><div class="t m0 x9 hd yc7e ff98 fs7 fc3 sc0 ls1 ws1">or <span class="ffa0">W0</span> depending upon whether the conversion is </div><div class="t m0 x9 hd yc7f ff98 fs7 fc3 sc0 ls1 ws1">requir<span class="_ _3"></span>ed or not.</div><div class="t m0 x1c hd y23a ff98 fs7 fc3 sc0 ls1 ws1">Overall, the compiler did a r<span class="_ _3"></span>easonable job of compiling our code<span class="_ _1"></span>, but </div><div class="t m0 xc hd y23b ff98 fs7 fc3 sc0 ls1 ws1">there ar<span class="_ _3"></span>e a few instructions that can be r<span class="_ _1"></span>emoved. W<span class="_ _1"></span>e can certainly s<span class="_ _0"></span>ee how </div><div class="t m0 xc hd y23c ff98 fs7 fc3 sc0 ls1 ws1">some hand optimization will help<span class="_ _1"></span>.</div><div class="t m0 x1c hd y23d ff98 fs7 fc3 sc0 ls1 ws1">This is why man<span class="_ _3"></span>y Assembly Language pr<span class="_ _3"></span>ogrammers start with C code </div><div class="t m0 xc hd y23e ff98 fs7 fc3 sc0 ls1 ws1">and then remo<span class="_ _3"></span>ve any extr<span class="_ _3"></span>a instructions. The C code becomes less efficient </div><div class="t m0 xc hd y6aa ff98 fs7 fc3 sc0 ls1 ws1">once it can’t fit all the variables in r<span class="_ _3"></span>egisters and must start swapping da<span class="_ _3"></span>ta </div><div class="t m0 xc hd ya0a ff98 fs7 fc3 sc0 ls1 ws1">to and from the stac<span class="_ _3"></span>k. This usually happens when the complexity is higher </div><div class="t m0 xc hd ya0b ff98 fs7 fc3 sc0 ls1 ws1">and the need for speed is greater<span class="_ _10"></span>.</div><div class="t m0 x1c hd ya0c ff98 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">8</span>, “Pr<span class="_ _1"></span>ogramming GPIO Pins,<span class="_ _66"></span>” we looked at programming </div><div class="t m0 xc hd y13bc ff98 fs7 fc3 sc0 ls1 ws1">the GPIO pins using the GPIO contr<span class="_ _3"></span>oller’<span class="_ _1"></span>s memory registers. This sort of </div><div class="t m0 xc hd y13bd ff98 fs7 fc3 sc0 ls1 ws1">code confuses the optimizer<span class="_ _6"></span>. Often it needs to be turned off, or it optimizes </div><div class="t m0 xc hd y6af ff98 fs7 fc3 sc0 ls1 ws1">awa<span class="_ _3"></span>y the code that accesses these locations<span class="_ _1"></span>. This is because we write </div><div class="t m0 xc hd y6b0 ff98 fs7 fc3 sc0 ls1 ws1">to memory locations and never read them and also read memory we </div><div class="t m0 xc hd y13be ff98 fs7 fc3 sc0 ls1 ws1">never set. Ther<span class="_ _3"></span>e are keywor<span class="_ _3"></span>ds to help the optimizer<span class="_ _0"></span>; however<span class="_ _10"></span>, Assembly </div><div class="t m0 xc hd y13bf ff98 fs7 fc3 sc0 ls1 ws1">Language can r<span class="_ _3"></span>esult in quite a bit better code<span class="_ _3"></span>, because you’r<span class="_ _3"></span>e working </div><div class="t m0 xc hd y6b3 ff98 fs7 fc3 sc0 ls1 ws1">against the C optimizer th<span class="_ _3"></span>at doesn’t know wha<span class="_ _3"></span>t the GPIO contr<span class="_ _3"></span>oller is </div><div class="t m0 xc hd y13c0 ff98 fs7 fc3 sc0 ls1 ws1">doing with this memor<span class="_ _0"></span>y.</div><div class="t m0 x1c hd y13c1 ff98 fs7 fc3 sc0 ls1 ws1">The listing used the <span class="ffa0 ls1f wsc7">CBNZ</span> instruction that we haven’t seen befor<span class="_ _3"></span>e; let’<span class="_ _6"></span>s </div><div class="t m0 xc hd y13c2 ff98 fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve a look at this along with the matchin<span class="_ _3"></span>g <span class="ffa0">CBZ</span> instruction.</div><div class="t m0 x73 h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.503000px;bottom:249.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf15f" class="pf w2 h6" data-page-no="15f"><div class="pc pc15f w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">340</div><div class="t m0 xd ha y248 ff9c fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Using theCBNZ andCBZ Instructions</div><div class="t m0 xd hd y249 ff98 fs7 fc3 sc0 ls1 ws1">Consider the set of instructions<span class="_ _0"></span>:</div><div class="t m0 xd h18 y5eb ff9d fs7 fc3 sc0 ls1 ws1">SUB   W1, W1, #1</div><div class="t m0 xd h18 ybb0 ff9d fs7 fc3 sc0 ls1 ws1">CMP   W1, #0</div><div class="t m0 xd h18 yb9c ff9d fs7 fc3 sc0 ls1 ws1">B.NE  mylabel</div><div class="t m0 xc hd y324 ff98 fs7 fc3 sc0 ls1 ws1">This is typical code in many loops<span class="_ _1"></span>. We h<span class="_ _3"></span>av<span class="_ _3"></span>e been eliminating the CMP </div><div class="t m0 xd hd yb9d ff98 fs7 fc3 sc0 ls1 ws1">instruction by using SUBS:</div><div class="t m0 xd h18 y5f0 ff9d fs7 fc3 sc0 ls1 ws1">SUBS   W1, W1, #1</div><div class="t m0 xd h18 y5f1 ff9d fs7 fc3 sc0 ls1 ws1">B.NE   mylabel</div><div class="t m0 xc hd y5f2 ff98 fs7 fc3 sc0 ls1 ws1">Another way to optimize this is with</div><div class="t m0 xd h18 y13c3 ff9d fs7 fc3 sc0 ls1 ws1">SUB   W1, W1, #1</div><div class="t m0 xd h18 y13c4 ff9d fs7 fc3 sc0 ls1 ws1">CBNZ  W1, mylabel</div><div class="t m0 xc hd y13c5 ffa0 fs7 fc3 sc0 ls1f wsc7">CBNZ<span class="ff98 ls1 ws1"> is compare and branch on nonzer<span class="_ _1"></span>o. I<span class="_ _1"></span>t compares <span class="ffa0">W1</span> to 0, and </span></div><div class="t m0 xd hd y13c6 ff98 fs7 fc3 sc0 ls1 ws1">if it isn’t 0 yet, then it br<span class="_ _3"></span>anches. N<span class="_ _1"></span>ot all instr<span class="_ _0"></span>uctions ha<span class="_ _1"></span>ve an <span class="ffa0">S</span> version like </div><div class="t m0 xd hd y13c7 ffa0 fs7 fc3 sc0 ls1c wsbf">SUBS <span class="ff98 ls1 ws1">, and this instr<span class="_ _0"></span>uction can be used in those cases. <span class="ffa0">CBZ</span> is the r<span class="_ _1"></span>everse </span></div><div class="t m0 xd hd y13c8 ff98 fs7 fc3 sc0 ls1 ws1">and will branch when the register is 0. T<span class="_ _3"></span>hese are the only choices; there </div><div class="t m0 xd hd y13c9 ff98 fs7 fc3 sc0 ls1 ws1">aren’t versions for an<span class="_ _3"></span>y other condition flags<span class="_ _3"></span>.</div><div class="t m0 xc hd y13ca ff98 fs7 fc3 sc0 ls1 ws1">The compiler doesn’t seem to use <span class="ffa0 ls1c wsbf">SUB S<span class="_ _0"></span></span> instructions when it genera<span class="_ _3"></span>tes </div><div class="t m0 xd hd y13cb ff98 fs7 fc3 sc0 ls1 ws1">code. I<span class="_ _1"></span>t could have elimina<span class="_ _3"></span>ted the <span class="ffa0">CMP</span> instruction by putting an <span class="ffa0">S</span> on the </div><div class="t m0 xd hd y13cc ff98 fs7 fc3 sc0 ls1 ws1">end of one of the <span class="ffa0 ls1c wsbf">SUB</span> instructions.</div><div class="t m0 xd h15 y1315 ff9c fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Reverse Engineering andGhidra</div><div class="t m0 xd hd y13cd ff98 fs7 fc3 sc0 ls1 ws1">In the Linux world, most of the pr<span class="_ _3"></span>ograms you enco<span class="_ _3"></span>unter are open sour<span class="_ _1"></span>ce, </div><div class="t m0 xd hd y13ce ff98 fs7 fc3 sc0 ls1 ws1">from which yo<span class="_ _3"></span>u can easily download the sour<span class="_ _3"></span>ce code and study it. Ther<span class="_ _3"></span>e </div><div class="t m0 xd hd y13cf ff98 fs7 fc3 sc0 ls1 ws1">is documentation on how it wor<span class="_ _3"></span>ks, and yo<span class="_ _3"></span>u are actively enco<span class="_ _3"></span>uraged to </div><div class="t m0 xd hd y13d0 ff98 fs7 fc3 sc0 ls1 ws1">contribute to the progr<span class="_ _1"></span>am, perhaps fix bugs or add a new featur<span class="_ _1"></span>e.</div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf160" class="pf w2 h6" data-page-no="160"><div class="pc pc160 w2 h6"><img class="bi xc y13d1 w7 h5d" alt="" src="bg160.png"/><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">341</div><div class="t m0 x1c hd yb07 ff98 fs7 fc3 sc0 lsb ws1">Suppose we encounter a pr<span class="_ _3"></span>ogram tha<span class="_ _3"></span>t we don’t hav<span class="_ _3"></span>e the source code </div><div class="t m0 xc hd y13d2 ff98 fs7 fc3 sc0 lsb ws1">for<span class="_ _6"></span>, and we want to know how it wor<span class="_ _3"></span>ks. P<span class="_ _1"></span>erhaps, we want to st<span class="_ _3"></span>udy it, to see if </div><div class="t m0 xc hd y13d3 ff98 fs7 fc3 sc0 lsb ws1">it contains malwar<span class="_ _1"></span>e. It migh<span class="_ _3"></span>t be the case that we ar<span class="_ _3"></span>e worried about privac<span class="_ _0"></span>y </div><div class="t m0 xc hd y13d4 ff98 fs7 fc3 sc0 lsb ws1">concerns and want to know wh<span class="_ _3"></span>at information the pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>am sends on the </div><div class="t m0 xc hd y13d5 ff98 fs7 fc3 sc0 lsb ws1">Internet<span class="_ _3"></span>. Ma<span class="_ _1"></span>yb<span class="_ _0"></span>e<span class="_ _1"></span>, it&apos;s a game, and we want to know if ther<span class="_ _3"></span>e is a secret code </div><div class="t m0 xc hd y13d6 ff98 fs7 fc3 sc0 lsb ws1">we can enter to go into God mode. Wha<span class="_ _3"></span>t is the best way to go abo<span class="_ _3"></span>ut this?</div><div class="t m0 x1c hd y13d7 ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e can examine the Assembly code of any Linux executable using </div><div class="t m0 xc hd y13d8 ffa0 fs7 fc3 sc0 ls1 ws1">objdump<span class="ff98"> or </span>gdb<span class="ff98">. W<span class="_ _1"></span>e know enough about Assembly that we can m<span class="_ _3"></span>ake </span></div><div class="t m0 xc hd y13d9 ff98 fs7 fc3 sc0 ls1 ws1">sense of the instructions we encounter<span class="_ _6"></span>. However<span class="_ _10"></span>, this doesn’t help us for<span class="_ _0"></span>m </div><div class="t m0 xc hd y13da ff98 fs7 fc3 sc0 ls1 ws1">a big picture of ho<span class="_ _3"></span>w the progr<span class="_ _3"></span>am is structured and it’<span class="_ _6"></span>s time consuming.</div><div class="t m0 x1c hd y13db ff98 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e tools to help w<span class="_ _0"></span>ith this<span class="_ _3"></span>. Until r<span class="_ _1"></span>e<span class="_ _0"></span>centl<span class="_ _3"></span>y there wer<span class="_ _3"></span>e only </div><div class="t m0 xc hd y13dc ff98 fs7 fc3 sc0 ls1 ws1">expensive commercial pr<span class="_ _1"></span>oducts available; however<span class="_ _10"></span>, the Nation<span class="_ _3"></span>al Security </div><div class="t m0 xc hd y13dd ff98 fs7 fc3 sc0 ls1 ws1">Agency (NSA), yes, that NS<span class="_ _3"></span>A<span class="_ _0"></span>, r<span class="_ _3"></span>eleased a version of the tool that their </div><div class="t m0 xc hd y13de ff98 fs7 fc3 sc0 ls1 ws1">hackers use to anal<span class="_ _3"></span>yze code. I<span class="_ _1"></span>t is called Ghidra, named after the thr<span class="_ _3"></span>ee- </div><div class="t m0 xc hd y13df ff98 fs7 fc3 sc0 ls1 ws1">headed monster that Godzilla fights<span class="_ _3"></span>. This tool lets you an<span class="_ _3"></span>alyze compiled </div><div class="t m0 xc hd y13e0 ff98 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams and includes the ability to decompile a progr<span class="_ _1"></span>am back into C </div><div class="t m0 xc hd y13e1 ff98 fs7 fc3 sc0 ls1 ws1">code. I<span class="_ _1"></span>t includes tools to show you the graphs of function calls and the </div><div class="t m0 xc hd y13e2 ff98 fs7 fc3 sc0 ls1 ws1">ability to make annota<span class="_ _3"></span>tions as you learn things<span class="_ _3"></span>.</div><div class="t m0 x1c h18 y13e3 ff98 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou can download Ghidra from <span class="ff9d fc5">https://ghidra-sre.org/</span>. T<span class="_ _10"></span>o install </div><div class="t m0 xc hd y13e4 ff98 fs7 fc3 sc0 ls1 ws1">it, you unzip it, then run the <span class="ffa0">ghidraR<span class="_ _3"></span>un<span class="ff98"> script if you are on Linux. Ghidra </span></span></div><div class="t m0 xc hd y13e5 ff98 fs7 fc3 sc0 ls1 ws1">requir<span class="_ _3"></span>es the J<span class="_ _1"></span>ava runtime; if you don’t ha<span class="_ _1"></span>ve this already installed, you will </div><div class="t m0 xc hd y13e6 ff98 fs7 fc3 sc0 ls1 ws1">need to install it for your operatin<span class="_ _3"></span>g system.</div><div class="t m0 x36 h1f y13e7 ff9c fse fc3 sc0 ls1 ws1">Note<span class="ff9e"> <span class="_ _19"> </span>Ghidra requires the 64-bit version of Orac<span class="_ _3"></span>le Java.<span class="_ _1"></span> Some Linux </span></div><div class="t m0 x36 h1f y13e8 ff9e fse fc3 sc0 ls1 ws1">distributions,<span class="_ _1"></span> even though they are 64 bits,<span class="_ _1"></span> ha<span class="_ _0"></span>ve the 32-bit version of </div><div class="t m0 x36 h1f y13e9 ff9e fse fc3 sc0 ls1 ws1">Java installed.<span class="_ _1"></span> If you run Ghidra under 32-bit Ja<span class="_ _0"></span>va,<span class="_ _1"></span> it will work until </div><div class="t m0 x36 h1f y13ea ff9e fse fc3 sc0 ls1 ws1">you try to disassemble some code, at which point the disassembler </div><div class="t m0 x36 h1f y13eb ff9e fse fc3 sc0 ls1 ws1">will fail to run.<span class="_ _1"></span> <span class="_ _1"></span>There’<span class="_ _1"></span>s currently no 64-bit version of Java for <span class="_ _3"></span>ARM,<span class="_ _1"></span> so </div><div class="t m0 x36 h1f y13ec ff9e fse fc3 sc0 ls1 ws1">you need to do this on an Intel or <span class="_ _1"></span>AMD-based computer<span class="_ _6"></span>.</div><div class="t m0 x73 h12 yb21 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="https://ghidra-sre.org/"><div class="d m1" style="border-style:none;position:absolute;left:220.806000px;bottom:289.318000px;width:126.500000px;height:12.320000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf161" class="pf w2 h6" data-page-no="161"><div class="pc pc161 w2 h6"><img class="bi x2 y13ed w6 h5e" alt="" src="bg161.png"/><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">342</div><div class="t m0 xc hd y145 ff98 fs7 fc3 sc0 ls1 ws1">Decompiling an optimized C progr<span class="_ _3"></span>am is difficult. As we saw in the </div><div class="t m0 xd hd y146 ff98 fs7 fc3 sc0 ls1 ws1">last section, the <span class="ffa0">G<span class="_ _0"></span>CC</span> optimizer does some ma<span class="_ _3"></span>jor rewriting of our original </div><div class="t m0 xd hd y147 ff98 fs7 fc3 sc0 ls1 ws1">code as part of converting it to Assembly Language<span class="_ _1"></span>. L<span class="_ _0"></span>et’<span class="_ _6"></span>s take the upper </div><div class="t m0 xd hd y1b0 ff98 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am that we compiled fr<span class="_ _3"></span>om C in the last section, give it to Ghidra to </div><div class="t m0 xd hd y1b1 ff98 fs7 fc3 sc0 ls1 ws1">decompile, and see whether the r<span class="_ _3"></span>esult is like our starting sour<span class="_ _3"></span>ce code.</div><div class="t m0 xc hd y14a ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Create a pr<span class="_ _1"></span>oje<span class="_ _0"></span>ct in Ghidr<span class="_ _1"></span>a, import our upper </div><div class="t m0 x1e hd y1e1 ff98 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am, and we get an information dialog shown in </div><div class="t m0 x1e hd y1e2 ff98 fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure<span class="fc5">15-1</span>.</div><div class="t m0 xd h1c y13ee ff9f fs3 fc3 sc0 ls1 ws1">Figure 15-1. <span class="_ _15"> </span><span class="ff99">High-level information on the upper executable</span></div><div class="t m0 xc hd y13ef ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Another information window with more detailed </div><div class="t m0 x1e hd y13f0 ff98 fs7 fc3 sc0 ls1 ws1">data. Click OK to get the m<span class="_ _3"></span>ain Window.</div><div class="t m0 xc hd y13f1 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Right<span class="_ _1"></span>-click the upper executable and select “Open </div><div class="t m0 x1e hd y13f2 ff98 fs7 fc3 sc0 ls1 ws1">with default tool”<span class="_ _2d"></span>. This opens the code analysis </div><div class="t m0 x1e hd y13f3 ff98 fs7 fc3 sc0 ls1 ws1">window. Click Y<span class="_ _6"></span>es when asked if you want the code </div><div class="t m0 x1e hd y13f4 ff98 fs7 fc3 sc0 ls1 ws1">analyzed and accept the defaults at the nex<span class="_ _3"></span>t prompt<span class="_ _3"></span>. </div><div class="t m0 x1e hd y13f5 ff98 fs7 fc3 sc0 ls1 ws1">Fig<span class="_ _3"></span>ure<span class="fc5 ws9b">15- 2</span> is the r<span class="_ _3"></span>esulting code analysis window. </div><div class="t m0 x1e hd y13f6 ff98 fs7 fc3 sc0 ls1 ws1">Y<span class="_ _6"></span>ou need to click main in the symbol tree to get the </div><div class="t m0 x1e hd y13f7 ff98 fs7 fc3 sc0 ls1 ws1">source code to appear<span class="_ _10"></span>.</div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf161" data-dest-detail='[353,"XYZ",35,446,null]'><div class="d m1" style="border-style:none;position:absolute;left:114.803000px;bottom:459.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf162" data-dest-detail='[354,"XYZ",53,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:114.803000px;bottom:101.391000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf162" class="pf w2 h6" data-page-no="162"><div class="pc pc162 w2 h6"><img class="bi x2e y13f8 w6 h5f" alt="" src="bg162.png"/><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">343</div><div class="t m0 x1c hd y13f9 ff98 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">15-4</span> is the C code that Ghidr<span class="_ _1"></span>a g<span class="_ _0"></span>ener<span class="_ _3"></span>ates<span class="_ _3"></span>. The lines abov<span class="_ _3"></span>e the </div><div class="t m0 xc hd y13fa ff98 fs7 fc3 sc0 ls1 ws1">definition of the main ro<span class="_ _3"></span>utine were added, so the progr<span class="_ _1"></span>am w<span class="_ _0"></span>ill compile </div><div class="t m0 xc hd y13fb ff98 fs7 fc3 sc0 ls1 ws1">and run.</div><div class="t m0 xc h20 y13fc ff9f fs3 fc3 sc0 ls1 ws1">Listing 15-4. <span class="_ _15"> </span><span class="ff98">C code creat<span class="_ _3"></span>ed by Ghidr<span class="_ _3"></span>a for our upper C progr<span class="_ _3"></span>am</span></div><div class="t m0 xc h18 y13fd ff9d fs7 fc3 sc0 ls1 ws1">#include &lt;stdio.h&gt;</div><div class="t m0 xc h18 y13fe ff9d fs7 fc3 sc0 ls1 ws1">#define BUFFERSIZE 250</div><div class="t m0 xc h18 y13ff ff9d fs7 fc3 sc0 ls1 ws1">char *tstStr = &quot;This is a test!&quot;;</div><div class="t m0 xc h18 y1400 ff9d fs7 fc3 sc0 ls1 ws1">char outStr[BUFFERSIZE];</div><div class="t m0 xc h18 y1401 ff9d fs7 fc3 sc0 ls1 ws1">typedef unsigned char byte;</div><div class="t m0 xc h18 y1402 ff9d fs7 fc3 sc0 ls1 ws1">#define true 1</div><div class="t m0 xc h18 y1403 ff9d fs7 fc3 sc0 ls1 ws1">int main(void)</div><div class="t m0 xc h18 y1404 ff9d fs7 fc3 sc0 ls1 ws1">{</div><div class="t m0 xc h18 y1405 ff9d fs7 fc3 sc0 ls1 ws1">  char cVar1;</div><div class="t m0 xc h1c y1406 ff9f fs3 fc3 sc0 ls1 ws1">Figure 15-2. <span class="_ _15"> </span><span class="ff99">Ghidra ana<span class="_ _3"></span>lyzing our upper program</span></div><div class="t m0 x73 h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf162" data-dest-detail='[354,"XYZ",53,298,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:343.675000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf163" class="pf w2 h6" data-page-no="163"><div class="pc pc163 w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">344</div><div class="t m0 xd h18 y46b ff9d fs7 fc3 sc0 ls1 ws1">  char *pcVar2;</div><div class="t m0 xd h18 y46c ff9d fs7 fc3 sc0 ls1 ws1">  char *pcVar3;</div><div class="t m0 xd h18 y46d ff9d fs7 fc3 sc0 ls1 ws1">  char *pcVar4;</div><div class="t m0 xd h18 y623 ff9d fs7 fc3 sc0 ls1 ws1">  char *pcVar5;</div><div class="t m0 xd h18 y46f ff9d fs7 fc3 sc0 ls1 ws1">  pcVar2 = tstStr;</div><div class="t m0 xd h18 y85d ff9d fs7 fc3 sc0 ls1 ws1">  pcVar3 = outStr;</div><div class="t m0 xd h18 y85e ff9d fs7 fc3 sc0 ls1 ws1">  pcVar5 = tstStr;</div><div class="t m0 xd h18 y847 ff9d fs7 fc3 sc0 ls1 ws1">  do {</div><div class="t m0 xd h18 y85f ff9d fs7 fc3 sc0 ls1 ws1">    cVar1 = *pcVar5;</div><div class="t m0 xd h18 y629 ff9d fs7 fc3 sc0 ls1 ws1">    pcVar4 = pcVar3;</div><div class="t m0 xd h18 y62a ff9d fs7 fc3 sc0 ls1 ws1">    while( true ) {</div><div class="t m0 xd h18 y62b ff9d fs7 fc3 sc0 ls1 ws1">      pcVar3 = pcVar4 + 1;</div><div class="t m0 xd h18 y9f9 ff9d fs7 fc3 sc0 ls1 ws1">      pcVar5 = pcVar5 + 1;</div><div class="t m0 xd h18 y9fa ff9d fs7 fc3 sc0 ls1 ws1">      if (0x19 &lt; (byte)(cVar1 + 0x9fU)) break;</div><div class="t m0 xd h18 y9fb ff9d fs7 fc3 sc0 ls1 ws1">      *pcVar4 = cVar1 + -0x20;</div><div class="t m0 xd h18 y9fc ff9d fs7 fc3 sc0 ls1 ws1">      cVar1 = *pcVar5;</div><div class="t m0 xd h18 y9fd ff9d fs7 fc3 sc0 ls1 ws1">      pcVar4 = pcVar3;</div><div class="t m0 xd h18 y9fe ff9d fs7 fc3 sc0 ls1 ws1">    }</div><div class="t m0 xd h18 y9ff ff9d fs7 fc3 sc0 ls1 ws1">    *pcVar4 = cVar1;</div><div class="t m0 xd h18 ya00 ff9d fs7 fc3 sc0 ls1 ws1">  } while (cVar1 != &apos;\0&apos;);</div><div class="t m0 xd h18 yd5a ff9d fs7 fc3 sc0 ls1 ws1">  printf(&quot;Input: %s\nOutput: %s\n&quot;,pcVar2,outStr);</div><div class="t m0 xd h18 yd5b ff9d fs7 fc3 sc0 ls1 ws1">  return 0;</div><div class="t m0 xd h18 yd5c ff9d fs7 fc3 sc0 ls1 ws1">}</div><div class="t m0 xc hd y1407 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Run the pr<span class="_ _3"></span>ogram<span class="_ _3"></span>. The expected output is</div><div class="t m0 x1e h18 y1408 ff9d fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 15$ make</div><div class="t m0 x1e h18 y1409 ff9d fs7 fc3 sc0 ls1 ws1">gcc -O3 -o upperghidra upperghidra.c</div><div class="t m0 x1e h18 y140a ff9d fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 15$ ./upperghidra</div><div class="t m0 x1e h18 y140b ff9d fs7 fc3 sc0 ls1 ws1">Input: This is a test!</div><div class="t m0 x1e h18 y140c ff9d fs7 fc3 sc0 ls1 ws1">Output: THIS IS A TEST!</div><div class="t m0 x1e h18 y140d ff9d fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 15$</div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf164" class="pf w2 h6" data-page-no="164"><div class="pc pc164 w2 h6"><img class="bi xc y140e w7 h5d" alt="" src="bg164.png"/><div class="t m0 x17 hd y3f ff98 fs7 fc3 sc0 ls1 ws1">345</div><div class="t m0 x1c hd y3ce ff98 fs7 fc3 sc0 ls1 ws1">The code produced isn’t pr<span class="_ _3"></span>etty. The variable names ar<span class="_ _1"></span>e generated. It </div><div class="t m0 xc hd y3cf ff98 fs7 fc3 sc0 ls1 ws1">knows <span class="ffa0">tstStr</span> and <span class="ffa0">outStr</span>, because these ar<span class="_ _3"></span>e global variables. T<span class="_ _3"></span>he logic is </div><div class="t m0 xc hd y3d0 ff98 fs7 fc3 sc0 ls1 ws1">in smaller steps<span class="_ _3"></span>, often each C statement bein<span class="_ _3"></span>g the equivalent of a single </div><div class="t m0 xc hd y3d1 ff98 fs7 fc3 sc0 ls1 ws1">Assembly instruction. When tr<span class="_ _0"></span>ying to fi<span class="_ _3"></span>gure out a pr<span class="_ _1"></span>ogram you don’t ha<span class="_ _3"></span>ve </div><div class="t m0 xc hd y3d2 ff98 fs7 fc3 sc0 ls1 ws1">the source code for<span class="_ _10"></span>, having a couple of differ<span class="_ _1"></span>ent viewpoints is a great help<span class="_ _1"></span>.</div><div class="t m0 x36 h1f y757 ff9c fse fc3 sc0 ls1 ws1">Note<span class="ff9e"> <span class="_ _17"> </span>This technique only works for true compiled languages like </span></div><div class="t m0 x36 h1f y758 ff9e fse fc3 sc0 ls1 ws1">C,<span class="_ _1"></span> Fortran,<span class="_ _1"></span> or C++.<span class="_ _1"></span> It does not work for interpreted languages like </div><div class="t m0 x36 h1f y759 ff9e fse fc3 sc0 ls1 ws1">Python or JavaScript; it also doesn’t work for partially compiled </div><div class="t m0 x36 h1f y75a ff9e fse fc3 sc0 ls1 ws1">languages tha<span class="_ _0"></span>t use a virtual machine architecture like Java or C#.<span class="_ _1"></span> </div><div class="t m0 x36 h1f y75b ff9e fse fc3 sc0 ls1 ws1">There are other tools for these and often these are much more </div><div class="t m0 x36 h1f y140f ff9e fse fc3 sc0 ls1 ws1">effective,<span class="_ _1"></span> since the compile step doesn’t do as much.</div><div class="t m0 xc h15 y1410 ff9c fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xc hd y1411 ff98 fs7 fc3 sc0 ls1 ws1">In this chapter<span class="_ _10"></span>, we reviewed where we can find some sample Assembly </div><div class="t m0 xc hd y1412 ff98 fs7 fc3 sc0 ls1 ws1">source code in the Linux kernel and the GCC runtime library. W<span class="_ _1"></span>e looked </div><div class="t m0 xc hd y1413 ff98 fs7 fc3 sc0 ls1 ws1">at the Linux kernels cop<span class="_ _3"></span>y_page function to see how that wor<span class="_ _3"></span>ks. W<span class="_ _1"></span>e wrote a </div><div class="t m0 xc hd y1414 ff98 fs7 fc3 sc0 ls1 ws1">C version of our upper<span class="_ _1"></span>-case program<span class="_ _1"></span>, s<span class="_ _0"></span>o we could compar<span class="_ _1"></span>e the Assembly </div><div class="t m0 xc hd y1415 ff98 fs7 fc3 sc0 ls1 wsa9">code that the C compiler pr<span class="_ _1"></span>o<span class="_ _0"></span>duces and compar<span class="_ _1"></span>e it to what we have written.</div><div class="t m0 x1c hd y1416 ff98 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e then looked at the sophisticated Ghidra pr<span class="_ _1"></span>ogram for decompiling </div><div class="t m0 xc hd y1417 ff98 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams to reverse the pr<span class="_ _1"></span>o<span class="_ _0"></span>cess and see wha<span class="_ _3"></span>t it produces<span class="_ _3"></span>. Although it </div><div class="t m0 xc hd y1418 ff98 fs7 fc3 sc0 ls1 ws1">produces workin<span class="_ _3"></span>g C code from Assembly code<span class="_ _3"></span>, it isn’t that easy t<span class="_ _3"></span>o read.</div><div class="t m0 x1c hd y1419 ff98 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">16</span>, “H<span class="_ _1"></span>acking Code,<span class="_ _66"></span>” we’ll look how hackers use Assembly </div><div class="t m0 xc hd y141a ff98 fs7 fc3 sc0 ls1 ws1">Language knowledge to h<span class="_ _3"></span>ack our code and take contr<span class="_ _1"></span>ol of our computers.</div><div class="t m0 x73 h12 y3e8 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.503000px;bottom:183.862000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf165" class="pf w2 h6" data-page-no="165"><div class="pc pc165 w2 h6"><div class="t m0 xd hd y3f ff98 fs7 fc3 sc0 ls1 ws1">346</div><div class="t m0 xd h15 y186 ff9c fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 xc hd y355 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Man<span class="_ _3"></span>ually execute the instructions in Listing <span class="fc5">15-1</span> </div><div class="t m0 x1e hd y356 ff98 fs7 fc3 sc0 ls1 ws1">that perform the loop to ensure yo<span class="_ _3"></span>u understand how </div><div class="t m0 x1e hd y141b ff98 fs7 fc3 sc0 ls1 ws1">it works and that it performs the correct number of </div><div class="t m0 x1e hd ya49 ff98 fs7 fc3 sc0 ls1 ws1">iterations<span class="_ _1"></span>.</div><div class="t m0 xc hd y359 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Ha<span class="_ _1"></span>ve a look at the Linux kernel library function </div><div class="t m0 x1e hd ya4b ff98 fs7 fc3 sc0 ls1 ws1">memchr<span class="_ _6"></span>.S located in ar<span class="_ _3"></span>ch/arm64/lib<span class="_ _3"></span>. Can you eas<span class="_ _3"></span>ily </div><div class="t m0 x1e hd y141c ff98 fs7 fc3 sc0 ls1 ws1">follow this code?</div><div class="t m0 xc hd y141d ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>The copy_page r<span class="_ _3"></span>outine was simpler<span class="_ _10"></span>, because the </div><div class="t m0 x1e hd y141e ff98 fs7 fc3 sc0 ls1 ws1">pages were guar<span class="_ _3"></span>anteed to be aligned. Look at the </div><div class="t m0 x1e hd y141f ff98 fs7 fc3 sc0 ls1 ws1">memcmp<span class="_ _1"></span>.S file in arch/arm64/lib<span class="_ _3"></span>. This r<span class="_ _3"></span>outine </div><div class="t m0 x1e hd y1420 ff98 fs7 fc3 sc0 ls1 ws1">is more complic<span class="_ _3"></span>ated because it doesn’t assume </div><div class="t m0 x1e hd y1421 ff98 fs7 fc3 sc0 ls1 ws1">alignment, but w<span class="_ _3"></span>ants to use the same efficiencies </div><div class="t m0 x1e hd y1422 ff98 fs7 fc3 sc0 ls1 wsaa">alignment gives you. I<span class="_ _1"></span>t needs to handle the first non-</div><div class="t m0 x1e hd y1423 ff98 fs7 fc3 sc0 ls1 ws1">aligned bytes<span class="_ _3"></span>, then the main block tha<span class="_ _3"></span>t’<span class="_ _6"></span>s aligned, </div><div class="t m0 x1e hd y1424 ff98 fs7 fc3 sc0 ls1 ws1">and any leftov<span class="_ _3"></span>er bytes<span class="_ _3"></span>. Understanding this r<span class="_ _3"></span>outine is </div><div class="t m0 x1e hd y1425 ff98 fs7 fc3 sc0 ls1 ws1">more ch<span class="_ _3"></span>allenging.</div><div class="t m0 xc hd y1426 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Rewrite the loop in one of the versions of the upper<span class="_ _1"></span>-</div><div class="t m0 x1e hd y1427 ff98 fs7 fc3 sc0 ls1 ws1">case routine to use a <span class="ffa0 ls1f wsc7">CBNZ</span> or <span class="ffa0">CBZ</span> instruction for its </div><div class="t m0 x1e hd y1428 ff98 fs7 fc3 sc0 ls1 ws1">main loop<span class="_ _1"></span>.</div><div class="t m0 xc hd y1429 ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Compile the C code generated b<span class="_ _3"></span>y the Ghidra </div><div class="t m0 x1e hd y142a ff98 fs7 fc3 sc0 ls1 ws1">disassembler in Listing <span class="fc5">15-4</span>. Then run objdump on </div><div class="t m0 x1e hd y142b ff98 fs7 fc3 sc0 ls1 ws1">the output and compar<span class="_ _3"></span>e it to the original Assembly </div><div class="t m0 x1e hd y142c ff98 fs7 fc3 sc0 ls1 ws1">code in Listing <span class="fc5">15-3</span>. Is this wha<span class="_ _3"></span>t you expected?</div><div class="t m0 xc hd y142d ff98 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>6. <span class="_ _f"> </span>Examine one of the smaller executables from /usr/</div><div class="t m0 x1e hd y142e ff98 fs7 fc3 sc0 ls1 ws1">bin, such as <span class="ffa0 ls24 wsc2">head</span>, in Ghidr<span class="_ _1"></span>a. Can you figur<span class="_ _1"></span>e out how </div><div class="t m0 x1e hd y142f ff98 fs7 fc3 sc0 ls1 ws1">it works and find the main block of code?</div><div class="t m0 xd h12 y71 ff9e fsa fc3 sc0 ls1 ws1">CHAPTER 15 <span class="_ _f"> </span> READING <span class="_ _1"></span>AND UNDERST<span class="_ _1"></span>ANDING CODE</div><a class="l" href="#pf155" data-dest-detail='[341,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:289.305000px;bottom:541.090000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf162" data-dest-detail='[354,"XYZ",53,298,null]'><div class="d m1" style="border-style:none;position:absolute;left:192.583000px;bottom:197.090000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15b" data-dest-detail='[347,"XYZ",35,291,null]'><div class="d m1" style="border-style:none;position:absolute;left:153.567000px;bottom:165.090000px;width:20.547000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf166" class="pf w2 h6" data-page-no="166"><div class="pc pc166 w2 h6"><div class="t m0 x17 hd y16a ffa1 fs7 fc3 sc0 ls1 ws1">347</div><div class="t m0 xc h17 y16b ffa1 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ffa1 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ffa2">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ffa1">,  </span></span></div><div class="t m0 xc h17 y16d ffa1 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1_16</div><div class="t m0 xc ha y16e ffa3 fs6 fc3 sc0 ls1 ws1">CHAPTER 16</div><div class="t m0 xc h8 y16f ffa4 fs4 fc3 sc0 ls1 ws1">Hacking Code</div><div class="t m0 xc hd y170 ffa1 fs7 fc3 sc0 ls1 ws1">For the p<span class="_ _3"></span>urpose of this chapter<span class="_ _10"></span>, hacking means gaining illicit access </div><div class="t m0 xc hd y171 ffa1 fs7 fc3 sc0 ls1 ws1">to a computer or network b<span class="_ _3"></span>y various tricky means<span class="_ _3"></span>. This chapter offers </div><div class="t m0 xc hd y172 ffa1 fs7 fc3 sc0 ls1 ws1">techniques to hack pr<span class="_ _3"></span>ograms b<span class="_ _3"></span>y pro<span class="_ _3"></span>viding them with bad data. Another </div><div class="t m0 xc hd y173 ffa1 fs7 fc3 sc0 ls1 ws1">form of hacking is social engineering where yo<span class="_ _3"></span>u trick people into revealin<span class="_ _3"></span>g </div><div class="t m0 xc hd y174 ffa1 fs7 fc3 sc0 ls1 ws1">their passwords<span class="_ _1"></span>, or other pers<span class="_ _0"></span>onal da<span class="_ _3"></span>ta, o<span class="_ _3"></span>ver the phone<span class="_ _3"></span>, social media, or </div><div class="t m0 xc hd y175 ffa1 fs7 fc3 sc0 ls1 ws1">e-mail; however<span class="_ _10"></span>, that’<span class="_ _1"></span>s a topic for a differen<span class="_ _3"></span>t book.</div><div class="t m0 x1c hd y176 ffa1 fs7 fc3 sc0 ls1 ws1">Every progr<span class="_ _3"></span>ammer should know about h<span class="_ _3"></span>acking. If yo<span class="_ _3"></span>u don’t know </div><div class="t m0 xc hd y177 ffa1 fs7 fc3 sc0 ls1 ws1">how hack<span class="_ _3"></span>ers exploit security weaknesses in program code, then y<span class="_ _3"></span>ou will </div><div class="t m0 xc hd y178 ffa1 fs7 fc3 sc0 ls1 ws1">unknowingly pro<span class="_ _1"></span>vide these for them.</div><div class="t m0 xc h15 y1430 ffa5 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Buffer Overrun Hack</div><div class="t m0 xc hd y1431 ffa1 fs7 fc3 sc0 ls1 ws1">As an example, we<span class="_ _3"></span>’ll look at the classic buffer o<span class="_ _1"></span>ver<span class="_ _0"></span>run problem<span class="_ _1"></span>, how it </div><div class="t m0 xc hd y1432 ffa1 fs7 fc3 sc0 ls1 ws1">happens<span class="_ _3"></span>, how to exploit it, and then ho<span class="_ _3"></span>w to protect ag<span class="_ _3"></span>ainst it. Anyone with </div><div class="t m0 xc hd y1433 ffa1 fs7 fc3 sc0 ls1 ws1">security exper<span class="_ _0"></span>ience will notice that o<span class="_ _3"></span>ur upper<span class="_ _1"></span>-case routine is error<span class="_ _1"></span>-<span class="_ _3"></span>prone </div><div class="t m0 xc hd y1434 ffa1 fs7 fc3 sc0 ls1 ws1">and will likely lead to a buffer overrun vulnera<span class="_ _3"></span>bility in our code. Let’<span class="_ _6"></span>s look </div><div class="t m0 xc hd y1435 ffa1 fs7 fc3 sc0 ls1 ws1">at what b<span class="_ _3"></span>uffer overrun is and how it gets exploited.</div><div class="t m0 xc h15 y1436 ffa5 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Causes ofBuffer Overrun</div><div class="t m0 xc hd y1437 ffa1 fs7 fc3 sc0 ls1 ws1">Our upper<span class="_ _1"></span>-case routine ha<span class="_ _3"></span>ppily converts text to upper<span class="_ _1"></span>-case until it hits a </div><div class="t m0 xc hd y1438 ffa1 fs7 fc3 sc0 ls1 ws1">NULL (0) character<span class="_ _10"></span>. If the provided text is bigger th<span class="_ _3"></span>an the output buffer the </div><div class="t m0 xc hd y1439 ffa1 fs7 fc3 sc0 ls1 ws1">caller pro<span class="_ _1"></span>vides, then this routine o<span class="_ _1"></span>ver<span class="_ _0"></span>writes whatever is in memory after </div><div class="t m0 xc hd y143a ffa1 fs7 fc3 sc0 ls1 ws1">it. Depending on where the b<span class="_ _3"></span>uffer is located, this affects the type of attack </div><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:168.835000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf167" class="pf w2 h6" data-page-no="167"><div class="pc pc167 w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">348</div><div class="t m0 xd hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">that’<span class="_ _6"></span>s possible. W<span class="_ _1"></span>e’re goin<span class="_ _3"></span>g to look at this buffer being located on the stac<span class="_ _3"></span>k. </div><div class="t m0 xd hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">The weakness of the stack is tha<span class="_ _3"></span>t this is where function r<span class="_ _3"></span>eturn addr<span class="_ _3"></span>esses </div><div class="t m0 xd hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">get stored when we nest function calls<span class="_ _1"></span>. If w<span class="_ _0"></span>e arran<span class="_ _3"></span>ge our code exactly, we </div><div class="t m0 xd hd y1b0 ffa1 fs7 fc3 sc0 ls1 ws1">can overwrite a function return addr<span class="_ _3"></span>ess and cause the function to r<span class="_ _3"></span>eturn to </div><div class="t m0 xd hd y1b1 ffa1 fs7 fc3 sc0 ls1 ws1">a place of our choosing.</div><div class="t m0 xc hd y1b2 ffa1 fs7 fc3 sc0 ls1 ws1">There ar<span class="_ _1"></span>e other for<span class="_ _0"></span>ms of buffer o<span class="_ _1"></span>ver<span class="_ _0"></span>run attacks if the d<span class="_ _3"></span>ata is stor<span class="_ _3"></span>ed in </div><div class="t m0 xd hd y1b3 ffa1 fs7 fc3 sc0 ls1 ws1">the C runtime heap<span class="_ _1"></span>, or in the program<span class="_ _6"></span>’<span class="_ _1"></span>s data segment. These attac<span class="_ _3"></span>ks are </div><div class="t m0 xd hd y1b4 ffa1 fs7 fc3 sc0 ls1 ws1">like what we will explor<span class="_ _3"></span>e for the stack.</div><div class="t m0 xc hd y1b5 ffa1 fs7 fc3 sc0 ls1 ws1">If you enter too muc<span class="_ _3"></span>h data into such a tex<span class="_ _3"></span>t field, the progr<span class="_ _3"></span>am typically </div><div class="t m0 xd hd y1b6 ffa1 fs7 fc3 sc0 ls1 ws1">crashes<span class="_ _3"></span>, since you’<span class="_ _1"></span>ve over<span class="_ _0"></span>written important pr<span class="_ _3"></span>ogram data and corrupted </div><div class="t m0 xd hd y1b7 ffa1 fs7 fc3 sc0 ls1 ws1">pointers<span class="_ _3"></span>. Even tho<span class="_ _3"></span>ugh the hacker won’t get any pr<span class="_ _1"></span>opr<span class="_ _0"></span>ietary data this way, </div><div class="t m0 xd hd ya1c ffa1 fs7 fc3 sc0 ls1 ws1">this is still a good foundation for a <span class="ffa6">denial of ser<span class="_ _0"></span>vice</span> (DoS) attack. If this </div><div class="t m0 xd hd ya1d ffa1 fs7 fc3 sc0 ls1 ws1">is a web ser<span class="_ _0"></span>ver and yo<span class="_ _3"></span>u cause it to crash<span class="_ _1"></span>, then it ne<span class="_ _0"></span>eds to be r<span class="_ _3"></span>estarted and </div><div class="t m0 xd hd y944 ffa1 fs7 fc3 sc0 ls1 ws1">re- <span class="_ _b"></span>initialized. This typically tak<span class="_ _3"></span>es several seconds. T<span class="_ _3"></span>his means we can send </div><div class="t m0 xd hd y945 ffa1 fs7 fc3 sc0 ls1 ws1">a message to the web server ever<span class="_ _0"></span>y few seconds to keep it offline.</div><div class="t m0 xd h15 y143b ffa5 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Stealing Credit Card Numbers</div><div class="t m0 xd hd y37f ffa1 fs7 fc3 sc0 ls1 ws1">Imagine a cr<span class="_ _3"></span>edit card comp<span class="_ _3"></span>any’<span class="_ _6"></span>s web ser<span class="_ _0"></span>ver running a web application </div><div class="t m0 xd hd y143c ffa1 fs7 fc3 sc0 ls1 ws1">that uses our upper<span class="_ _1"></span>-case progr<span class="_ _3"></span>am, because it needs to conv<span class="_ _3"></span>ert names to </div><div class="t m0 xd hd y143d ffa1 fs7 fc3 sc0 ls1 ws1">upper<span class="_ _1"></span>-case super fast, so that its web pages ar<span class="_ _3"></span>e exceptionally r<span class="_ _3"></span>esponsive. </div><div class="t m0 xd hd y143e ffa1 fs7 fc3 sc0 ls1 ws1">Suppose there<span class="_ _3"></span>’<span class="_ _6"></span>s a page on the web site where you en<span class="_ _3"></span>ter your name<span class="_ _1"></span>, and </div><div class="t m0 xd hd y143f ffa1 fs7 fc3 sc0 ls1 ws1">the web application con<span class="_ _3"></span>verts it to upper<span class="_ _1"></span>-case; but the web page wasn’t </div><div class="t m0 xd hd y2fe ffa1 fs7 fc3 sc0 ls1 ws1">error checking for the length of da<span class="_ _3"></span>ta and passed it to our upper<span class="_ _1"></span>-case </div><div class="t m0 xd hd y2ff ffa1 fs7 fc3 sc0 ls1 ws1">routine as is<span class="_ _1"></span>. Furthermore, for con<span class="_ _1"></span>venience this w<span class="_ _0"></span>eb a<span class="_ _3"></span>pplication pr<span class="_ _3"></span>ovides </div><div class="t m0 xd hd y1440 ffa1 fs7 fc3 sc0 ls1 ws1">several administra<span class="_ _3"></span>tive utilities<span class="_ _3"></span>, such as a facility to download all the credit </div><div class="t m0 xd hd y1441 ffa1 fs7 fc3 sc0 ls1 ws1">card da<span class="_ _3"></span>ta, so it can be back<span class="_ _3"></span>ed up<span class="_ _1"></span>. These utilities are only availa<span class="_ _3"></span>ble to </div><div class="t m0 xd hd y1442 ffa1 fs7 fc3 sc0 ls1 ws1">administrativ<span class="_ _3"></span>e users with special clearance and requir<span class="_ _3"></span>e a digital certificate </div><div class="t m0 xd hd y1443 ffa1 fs7 fc3 sc0 ls1 ws1">to access. As a h<span class="_ _3"></span>acker<span class="_ _10"></span>, we want to dupe the customer facing part of the web </div><div class="t m0 xd hd y1444 ffa1 fs7 fc3 sc0 ls1 ws1">site into giving us access to the administr<span class="_ _1"></span>ative part w<span class="_ _0"></span>ithout r<span class="_ _1"></span>e<span class="_ _0"></span>quiring extr<span class="_ _3"></span>a </div><div class="t m0 xd hd y1445 ffa1 fs7 fc3 sc0 ls1 ws1">authentica<span class="_ _3"></span>tion.</div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf168" class="pf w2 h6" data-page-no="168"><div class="pc pc168 w2 h6"><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">349</div><div class="t m0 x1c hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">In Chapter <span class="fc5">6</span>, “F<span class="_ _1"></span>unctions and the Stack,<span class="_ _8"></span>” we learned that if a function </div><div class="t m0 xc hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">calls another function, it must stor<span class="_ _1"></span>e the <span class="ffa6 ls24 wsc2">LR</span> register to the stack, so that it </div><div class="t m0 xc hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">won’t be lost. W<span class="_ _1"></span>e’ll modify our main pr<span class="_ _3"></span>ogram and upper<span class="_ _1"></span>-case routine to </div><div class="t m0 xc hd y1b0 ffa1 fs7 fc3 sc0 ls1 ws1">ha<span class="_ _3"></span>ve an intermediate r<span class="_ _3"></span>outine, so <span class="ffa6 ls24 wsc2">LR</span> is s<span class="_ _3"></span>tored to the stack and alloca<span class="_ _3"></span>tes the </div><div class="t m0 xc hd y1b1 ffa1 fs7 fc3 sc0 ls1 ws1">output buffer on the stack.</div><div class="t m0 x1c hd y218 ffa1 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">16-1</span> contains thr<span class="_ _3"></span>ee routines: O<span class="_ _0"></span>ne is the skeleton of the </div><div class="t m0 xc hd y219 ffa1 fs7 fc3 sc0 ls1 ws1">credit car<span class="_ _1"></span>d company’<span class="_ _1"></span>s web application. I<span class="_ _1"></span>t has the usual _start entry </div><div class="t m0 xc hd y1b4 ffa1 fs7 fc3 sc0 ls1 ws1">point that c<span class="_ _3"></span>alls the routine <span class="ffa6">calltoupper</span>. This r<span class="_ _3"></span>outine pushes <span class="ffa6 ls24 wsc2">LR</span> to the </div><div class="t m0 xc hd y1b5 ffa1 fs7 fc3 sc0 ls1 ws1">stack and allocates 16 b<span class="_ _3"></span>ytes for the output buffer<span class="_ _10"></span>. The second is the </div><div class="t m0 xc hd y1b6 ffa1 fs7 fc3 sc0 ls1 ws1">DownloadCreditCar<span class="_ _1"></span>dNumbers r<span class="_ _3"></span>outine that we shouldn’t be able t<span class="_ _3"></span>o access. </div><div class="t m0 xc hd y1b7 ffa1 fs7 fc3 sc0 ls1 ws1">And the third is the specially constructed input da<span class="_ _3"></span>ta that if we enter in a </div><div class="t m0 xc hd y942 ffa1 fs7 fc3 sc0 ls1 ws1">text box will cause nefarious things to ha<span class="_ _3"></span>ppen.</div><div class="t m0 xc h20 y669 ffa8 fs3 fc3 sc0 ls1 ws1">Listing 16-1. <span class="_ _15"> </span><span class="ffa1">Main we<span class="_ _3"></span>b application for the cr<span class="_ _1"></span>e<span class="_ _0"></span>dit car<span class="_ _1"></span>d company</span></div><div class="t m0 xc h18 y66a ffa9 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 ya8c ffa9 fs7 fc3 sc0 ls1 ws1">// Assembler program to demonstrate a buffer</div><div class="t m0 xc h18 ya8d ffa9 fs7 fc3 sc0 ls1 ws1">// overrun hacking attack.</div><div class="t m0 xc h18 ya8e ffa9 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 ya8f ffa9 fs7 fc3 sc0 ls1 ws1">// X0-X2 - parameters to Linux function services</div><div class="t m0 xc h18 ya90 ffa9 fs7 fc3 sc0 ls1 ws1">// X1 - address of output string</div><div class="t m0 xc h18 ya91 ffa9 fs7 fc3 sc0 ls1 ws1">// X0 - address of input string</div><div class="t m0 xc h18 y1446 ffa9 fs7 fc3 sc0 ls1 ws1">// X8 - Linux function number</div><div class="t m0 xc h18 y1447 ffa9 fs7 fc3 sc0 ls1 ws1">//</div><div class="t m0 xc h18 ya94 ffa9 fs7 fc3 sc0 ls1 ws1">.global _start            // Provide program starting address</div><div class="t m0 xc h18 y1448 ffa9 fs7 fc3 sc0 ls1 ws1">DownloadCreditCardNumbers:</div><div class="t m0 xc h18 y1449 ffa9 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to print hello world</div><div class="t m0 xc h18 y144a ffa9 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xc h18 y144b ffa9 fs7 fc3 sc0 ls1 ws1">      MOV    X0, #1     // 1 = StdOut</div><div class="t m0 xc h18 y144c ffa9 fs7 fc3 sc0 ls1 ws1">      LDR    X1, =getcreditcards // string to print</div><div class="t m0 xc h18 y144d ffa9 fs7 fc3 sc0 ls1 ws1">      MOV    X2, #30             // length of our string</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.503000px;bottom:577.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf168" data-dest-detail='[360,"XYZ",53,388,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:497.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf169" class="pf w2 h6" data-page-no="169"><div class="pc pc169 w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">350</div><div class="t m0 xd h18 y46b ffa9 fs7 fc3 sc0 ls1 ws1">      MOV    X8, #64             // Linux write system call</div><div class="t m0 xd h18 y46c ffa9 fs7 fc3 sc0 ls1 ws1">      SVC    0          // Call linux to output the string</div><div class="t m0 xd h18 y46d ffa9 fs7 fc3 sc0 ls1 ws1">      RET</div><div class="t m0 xd h18 y85c ffa9 fs7 fc3 sc0 ls1 ws1">calltoupper:</div><div class="t m0 xd h18 y46f ffa9 fs7 fc3 sc0 ls1 ws1">       STR   LR, [SP, #-16]!     // Put LR on the stack</div><div class="t m0 xd h18 y85d ffa9 fs7 fc3 sc0 ls1 ws1">       SUB   SP, SP, #16         // 16 bytes for outstr</div><div class="t m0 xd h18 y85e ffa9 fs7 fc3 sc0 ls1 ws1">       LDR   X0, =instr          // start of input string</div><div class="t m0 xd h18 y847 ffa9 fs7 fc3 sc0 ls1 ws1">       MOV   X1, SP              // address of output string</div><div class="t m0 xd h18 y848 ffa9 fs7 fc3 sc0 ls1 ws1">       BL    toupper</div><div class="t m0 xd h18 yb68 ffa9 fs7 fc3 sc0 ls1 ws1">aftertoupper:       // convenient label to use as a breakpoint</div><div class="t m0 xd h18 yb69 ffa9 fs7 fc3 sc0 ls1 ws1">       ADD   SP, SP, #16   // Free outstr</div><div class="t m0 xd h18 y127c ffa9 fs7 fc3 sc0 ls1 ws1">       LDR   LR, [SP], #16</div><div class="t m0 xd h18 y84c ffa9 fs7 fc3 sc0 ls1 ws1">       RET</div><div class="t m0 xd h18 yb6c ffa9 fs7 fc3 sc0 ls1 ws1">_start:</div><div class="t m0 xd h18 yb6d ffa9 fs7 fc3 sc0 ls1 ws1">       BL   calltoupper</div><div class="t m0 xd h18 yaf2 ffa9 fs7 fc3 sc0 ls1 ws1">// Setup the parameters to exit the program</div><div class="t m0 xd h18 y1182 ffa9 fs7 fc3 sc0 ls1 ws1">// and then call Linux to do it.</div><div class="t m0 xd h18 y1183 ffa9 fs7 fc3 sc0 ls1 ws1">      MOV     X0, #0      // Use 0 return code</div><div class="t m0 xd h18 yb71 ffa9 fs7 fc3 sc0 ls1 ws1">      MOV     X8, #93     // Service command code 93 terminates</div><div class="t m0 xd h18 yb72 ffa9 fs7 fc3 sc0 ls1 ws1">      SVC     0           // Call Linux to terminate the </div><div class="t m0 xd h18 y1184 ffa9 fs7 fc3 sc0 ls1 ws1">program</div><div class="t m0 xd h18 yb74 ffa9 fs7 fc3 sc0 ls1 ws1">.data</div><div class="t m0 xd h18 yb75 ffa9 fs7 fc3 sc0 ls1 ws1">instr:  .ascii  &quot;This is our Test&quot;     // Correct length string</div><div class="t m0 xd h18 yf56 ffa9 fs7 fc3 sc0 ls1 ws1">        .dword 0x00000000004000b0      // overwrite for LR</div><div class="t m0 xd h18 y144e ffa9 fs7 fc3 sc0 ls1 ws1">getcreditcards:       .asciz  &quot;Downloading Credit Card Data!\n&quot;</div><div class="t m0 xd h18 y1187 ffa9 fs7 fc3 sc0 ls1 ws1">        .align 4</div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf16a" class="pf w2 h6" data-page-no="16a"><div class="pc pc16a w2 h6"><img class="bi x2e y144f w18 h60" alt="" src="bg16a.png"/><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">351</div><div class="t m0 x1c hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">For this exam<span class="_ _3"></span>ple, we use the first optimized example of the upper<span class="_ _1"></span>-case </div><div class="t m0 xc hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">routine<span class="_ _1"></span>, <span class="ffa6">upp<span class="_ _0"></span>er<span class="_ _6"></span>.s<span class="ffa1">, from Chapter <span class="fc5">14</span>, “<span class="_ _1"></span>Optimizing Code,<span class="_ _66"></span>” that uses the range </span></span></div><div class="t m0 xc hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">shift optimization. When this progr<span class="_ _1"></span>am is compiled and r<span class="_ _0"></span>un, you get</div><div class="t m0 xc h18 y2d7 ffa9 fs7 fc3 sc0 ls1 ws1">Downloading Credit Card Data!</div><div class="t m0 xc hd y567 ffa1 fs7 fc3 sc0 ls1 ws1">repeated o<span class="_ _1"></span>ver and over until you hit Ctrl+C.This is in spite of the r<span class="_ _3"></span>outine </div><div class="t m0 xc hd y2d9 ffa1 fs7 fc3 sc0 ls1 ws1">DownloadCreditCar<span class="_ _1"></span>dNumbers never being called within the pr<span class="_ _3"></span>ogram. </div><div class="t m0 xc hd y2da ffa1 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e’ll see why the progr<span class="_ _3"></span>am is put in an infinite loop shortly.</div><div class="t m0 x1c hd y231 ffa1 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e won’t include the code for the user interface; w<span class="_ _0"></span>e<span class="_ _3"></span>’ll just pr<span class="_ _3"></span>ovide the </div><div class="t m0 xc hd y232 ffa1 fs7 fc3 sc0 ls1 ws1">data in our .data section. W<span class="_ _1"></span>e want to keep things sim<span class="_ _3"></span>ple and easy to follow.</div><div class="t m0 x1c hd y233 ffa1 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s look at what h<span class="_ _3"></span>appens to the stack thr<span class="_ _3"></span>ough the process as this </div><div class="t m0 xc hd y2e5 ffa1 fs7 fc3 sc0 ls1 ws1">function runs.</div><div class="t m0 xc ha y1450 ffa5 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Stepping Through theStack</div><div class="t m0 xc hd y1451 ffa1 fs7 fc3 sc0 ls1 ws1">The stack is set up in the calltoupper function. F<span class="_ _1"></span>igure<span class="fc5">16-1</span> shows the </div><div class="t m0 xc hd y33d ffa1 fs7 fc3 sc0 ls1 ws1">values of <span class="ffa6">SP</span> and what is stor<span class="_ _1"></span>ed in each 16-byte block. Remember tha<span class="_ _3"></span>t <span class="ffa6">SP</span> </div><div class="t m0 xc hd y33e ffa1 fs7 fc3 sc0 ls1 ws1">must alwa<span class="_ _3"></span>ys be 16-byte aligned.</div><div class="t m0 xc h1c y1452 ffa8 fs3 fc3 sc0 ls1 ws1">Figure 16-1. <span class="_ _15"> </span><span class="ffa2">The contents of the stack inside the callto<span class="_ _3"></span>upper function</span></div><div class="t m0 x1c hd y1453 ffa1 fs7 fc3 sc0 ls1 ws1">Remember that the s<span class="_ _3"></span>tack gro<span class="_ _3"></span>ws downwar<span class="_ _3"></span>d, so when we push </div><div class="t m0 xc hd y1454 ffa1 fs7 fc3 sc0 ls1 ws1">something onto the stack, we decr<span class="_ _3"></span>ement <span class="ffa6">SP</span>. The pointer we pass for </div><div class="t m0 xc hd y1455 ffa1 fs7 fc3 sc0 ls1 ws1">outstr will be 0x7ffffff1f0, and since our loop in the upper<span class="_ _1"></span>-case routine </div><div class="t m0 xc hd y1456 ffa1 fs7 fc3 sc0 ls1 ws1">increments<span class="_ _1"></span>, if it overflows its buffer<span class="_ _10"></span>, it over<span class="_ _0"></span>writes the stor<span class="_ _3"></span>ed value for <span class="ffa6 ls24 wsc2">LR</span> </div><div class="t m0 xc hd y1457 ffa1 fs7 fc3 sc0 ls1 ws1">located at memory address 0x7ffffff200. The str<span class="_ _3"></span>ategy is to ov<span class="_ _3"></span>er<span class="_ _0"></span>write <span class="ffa6 ls24 wsc2">LR</span> with </div><div class="t m0 xc hd y1458 ffa1 fs7 fc3 sc0 ls1 ws1">an address ca<span class="_ _3"></span>using the pr<span class="_ _3"></span>ogram to do our bidding<span class="_ _3"></span>.</div><div class="t m0 x1c hd y1459 ffa1 fs7 fc3 sc0 ls1 ws1">Listing <span class="fc5">16-2</span> shows the memory addresses of the key instructions we </div><div class="t m0 xc hd y145a ffa1 fs7 fc3 sc0 ls1 ws1">will consider<span class="_ _6"></span>. W<span class="_ _1"></span>e want to overwrite the <span class="ffa6 ls24 wsc2">LR</span> register with 0x4000b0; that’<span class="_ _6"></span>s </div><div class="t m0 xc hd y145b ffa1 fs7 fc3 sc0 ls1 ws1">the address of the DownloadCr<span class="_ _3"></span>editCar<span class="_ _3"></span>dN<span class="_ _3"></span>umbers ro<span class="_ _3"></span>utine.</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:199.968000px;bottom:561.175000px;width:11.000000px;height:12.914000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16a" data-dest-detail='[362,"XYZ",53,300,null]'><div class="d m1" style="border-style:none;position:absolute;left:303.235000px;bottom:342.362000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16b" data-dest-detail='[363,"XYZ",35,591,null]'><div class="d m1" style="border-style:none;position:absolute;left:106.055000px;bottom:108.824000px;width:20.548000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf16b" class="pf w2 h6" data-page-no="16b"><div class="pc pc16b w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">352</div><div class="t m0 xd h20 y4c5 ffa8 fs3 fc3 sc0 ls1 ws1">Listing 16-2. <span class="_ _15"> </span><span class="ffa1">Excerpts of the objdump output of the progr<span class="_ _3"></span>am in </span></div><div class="t m0 xd h20 y9dd ffa1 fs3 fc3 sc0 ls1 ws1">Listing <span class="fc5">16-1</span></div><div class="t m0 xd h18 y9de ffa9 fs7 fc3 sc0 ls1 ws1">00000000004000b0 &lt;DownloadCreditCardNumbers&gt;:</div><div class="t m0 xd h18 y9df ffa9 fs7 fc3 sc0 ls1 ws1">  4000b0:   d2800020   mov   x0, #0x1</div><div class="t m0 xd h18 y9e0 ffa9 fs7 fc3 sc0 ls1 ws1">...</div><div class="t m0 xd h18 y9e1 ffa9 fs7 fc3 sc0 ls1 ws1">00000000004000c8 &lt;calltoupper&gt;:</div><div class="t m0 xd h18 y145c ffa9 fs7 fc3 sc0 ls1 ws1">  4000c8:   f81f0ffe   str   x30, [sp, #-16]!</div><div class="t m0 xd h18 y145d ffa9 fs7 fc3 sc0 ls1 ws1">...</div><div class="t m0 xd h18 y145e ffa9 fs7 fc3 sc0 ls1 ws1">00000000004000e8 &lt;_start&gt;:</div><div class="t m0 xd h18 y145f ffa9 fs7 fc3 sc0 ls1 ws1">  4000e8:   97fffff8   bl   4000c8 &lt;calltoupper&gt;</div><div class="t m0 xd h18 y1460 ffa9 fs7 fc3 sc0 ls1 ws1">  4000ec:   d2800000   mov  x0, #0x0</div><div class="t m0 xc hd y1461 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>In _start we do the <span class="ffa6 ls1f wsc7">BL</span> to the calltoupper routine<span class="_ _1"></span>. </div><div class="t m0 x1e hd y1462 ffa1 fs7 fc3 sc0 ls1 ws1">This places the address of the nex<span class="_ _3"></span>t instruction into </div><div class="t m0 x1e hd y1463 ffa6 fs7 fc3 sc0 ls24 wsc2">LR<span class="ffa1 ls1 ws1"> and jumps to callto<span class="_ _3"></span>upper<span class="_ _6"></span>. This means <span class="ffa6 ls24 wsc2">LR</span> has the </span></div><div class="t m0 x1e hd y1464 ffa1 fs7 fc3 sc0 ls1 ws1">value 0x4000ec at this point.</div><div class="t m0 xc hd y1465 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>On entering calltoupper<span class="_ _6"></span>, <span class="ffa6">SP</span> contains 0x7ffffff210. </div><div class="t m0 x1e hd y1466 ffa1 fs7 fc3 sc0 ls1 ws1">Execute the</div><div class="t m0 x1e h18 y1467 ffa9 fs7 fc3 sc0 ls1 ws1">STR   LR, [sp, #-16]!</div><div class="t m0 x1e hd y1468 ffa1 fs7 fc3 sc0 ls1 ws1">instruction which decrements <span class="ffa6">SP</span> b<span class="_ _3"></span>y 16 and </div><div class="t m0 x1e hd y1469 ffa1 fs7 fc3 sc0 ls1 ws1">copies <span class="ffa6 ls24 wsc2">LR</span> to this memory location. This makes <span class="ffa6">SP</span> </div><div class="t m0 x1e hd y146a ffa1 fs7 fc3 sc0 ls1 ws1">0x7ffffff200 and the 16 bytes ther<span class="_ _3"></span>e contain</div><div class="t m0 x1e h18 y146b ffa9 fs7 fc3 sc0 ls19 ws1">0x7ffffff200: 0x004000ec 0x00000000 0x00000000 0x00000000</div><div class="t m0 x1e hd y146c ffa1 fs7 fc3 sc0 ls1 ws1">showing that <span class="ffa6 ls24 wsc2">LR</span> w<span class="_ _3"></span>as pushed to the stack.</div><div class="t m0 xc hd y146d ffa1 fs7 fc3 sc0 ls1 wscc"> <span class="_ _2"></span>3. Execute</div><div class="t m0 x1e h18 y146e ffa9 fs7 fc3 sc0 ls1 ws1">SUB   SP, SP, #16</div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div><a class="l" href="#pf168" data-dest-detail='[360,"XYZ",53,388,null]'><div class="d m1" style="border-style:none;position:absolute;left:73.151400px;bottom:559.382000px;width:22.415900px;height:13.392000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf16c" class="pf w2 h6" data-page-no="16c"><div class="pc pc16c w2 h6"><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">353</div><div class="t m0 x9 hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">This allocates 16 b<span class="_ _3"></span>ytes for our output buffer<span class="_ _10"></span>. This </div><div class="t m0 x9 hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">reduces the stack poin<span class="_ _3"></span>ter to 0x7ffffff1f0 and the </div><div class="t m0 x9 hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">contents of the stack ar<span class="_ _1"></span>e</div><div class="t m0 x9 h18 y2d7 ffa9 fs7 fc3 sc0 ls2e ws37">0x7ffffff1f0: 0x00000000 0x00000000 0x00000000  0x00000000</div><div class="t m0 x9 h18 y2e2 ffa9 fs7 fc3 sc0 ls2e ws37">0x7ffffff200: 0x004000ec 0x00000000 0x00000000  0x00000000</div><div class="t m0 x1c hd y2d9 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>The function toupper converts our string to upper<span class="_ _1"></span>-</div><div class="t m0 x9 hd y2da ffa1 fs7 fc3 sc0 ls1 ws1">case. I<span class="_ _1"></span>t does this cor<span class="_ _0"></span>r<span class="_ _3"></span>ectly for the first part of the </div><div class="t m0 x9 hd y231 ffa1 fs7 fc3 sc0 ls1 ws1">string “This is our T<span class="_ _6"></span>est<span class="_ _0"></span>” (16 b<span class="_ _3"></span>ytes). Since there is no </div><div class="t m0 x9 hd y2e3 ffa1 fs7 fc3 sc0 ls1 ws1">NULL (0) terminator<span class="_ _6"></span>, it will also process the next </div><div class="t m0 x9 hd y2e4 ffa1 fs7 fc3 sc0 ls1 ws1">byte 0xb0 tha<span class="_ _3"></span>t isn’t lower<span class="_ _1"></span>-case, so will be copied </div><div class="t m0 x9 hd y2e5 ffa1 fs7 fc3 sc0 ls1 ws1">as is. The nex<span class="_ _3"></span>t byte is a NULL (0), so it stops<span class="_ _3"></span>. <span class="ffa6">SP</span> </div><div class="t m0 x9 hd yb30 ffa1 fs7 fc3 sc0 ls1 ws1">isn’t affected by this series of operations<span class="_ _3"></span>, but on </div><div class="t m0 x9 hd yb31 ffa1 fs7 fc3 sc0 ls1 ws1">returning fr<span class="_ _1"></span>om toupper<span class="_ _6"></span>, the stack contains</div><div class="t m0 x9 h18 y1192 ffa9 fs7 fc3 sc0 ls36 wsc2">0x7ffffff1f0: 0x53494854  0x20534920  0x2052554f 0x54534554</div><div class="t m0 x9 h18 y1193 ffa9 fs7 fc3 sc0 ls36 wsc2">0x7ffffff200: 0x004000b0  0x00000000  0x00000000 0x00000000</div><div class="t m0 x9 hd y552 ffa1 fs7 fc3 sc0 ls1 ws1">The first line is our string, con<span class="_ _3"></span>verted to upper<span class="_ _1"></span>-</div><div class="t m0 x9 hd y1194 ffa1 fs7 fc3 sc0 ls1 ws1">case. B<span class="_ _3"></span>ut notice the return addr<span class="_ _1"></span>ess at 0x7ffffff200 </div><div class="t m0 x9 hd yb35 ffa1 fs7 fc3 sc0 ls1 ws1">has changed fr<span class="_ _3"></span>om 0x004000ec to 0x004000b0. This </div><div class="t m0 x9 hd yf11 ffa1 fs7 fc3 sc0 ls1 ws1">means the return addr<span class="_ _1"></span>ess is the address of the </div><div class="t m0 x9 hd y1195 ffa1 fs7 fc3 sc0 ls1 ws1">DownloadCreditCar<span class="_ _1"></span>dNumbers r<span class="_ _3"></span>outine.</div><div class="t m0 x1c hd y146f ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>The calltoupper cleans up the stack and r<span class="_ _1"></span>eturns</div><div class="t m0 x9 h18 ye82 ffa9 fs7 fc3 sc0 ls1 ws1">ADD   SP, SP, #16   // Free outstr</div><div class="t m0 x9 h18 y15c ffa9 fs7 fc3 sc0 ls1 ws1">LDR   LR, [SP], #16</div><div class="t m0 x9 h18 ye83 ffa9 fs7 fc3 sc0 ls1 ws1">RET</div><div class="t m0 x9 hd y1470 ffa1 fs7 fc3 sc0 ls1 ws1">The key point is tha<span class="_ _3"></span>t the <span class="ffa6">LDR</span> instruction loads the </div><div class="t m0 x9 hd y1471 ffa1 fs7 fc3 sc0 ls1 ws1">address of DownloadCr<span class="_ _3"></span>editCar<span class="_ _3"></span>dN<span class="_ _3"></span>umbers into <span class="ffa6 ls24 wsc2">LR,</span> </div><div class="t m0 x9 hd y1472 ffa1 fs7 fc3 sc0 ls1 ws1">then the <span class="ffa6 ls1c wsbf">RET</span> instruction branches to that r<span class="_ _1"></span>outine </div><div class="t m0 x9 hd y1473 ffa1 fs7 fc3 sc0 ls1 ws1">causing a m<span class="_ _3"></span>ajor data br<span class="_ _1"></span>each.</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf16d" class="pf w2 h6" data-page-no="16d"><div class="pc pc16d w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">354</div><div class="t m0 xc hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">In performing this hack, we ar<span class="_ _3"></span>e lucky on a couple of points:</div><div class="t m0 xc hd y58c ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>W<span class="_ _1"></span>e only need to copy one byte to get the address </div><div class="t m0 x1e hd y1fe ffa1 fs7 fc3 sc0 ls1 ws1">changed to what we wan<span class="_ _3"></span>t, since the next b<span class="_ _3"></span>yte of the </div><div class="t m0 x1e hd y148 ffa1 fs7 fc3 sc0 ls1 ws1">address is NULL (0).</div><div class="t m0 xc hd y6e2 ffa1 fs7 fc3 sc0 ls12 ws1"> <span class="_ _16"> </span>2.<span class="_ _0"></span> <span class="_ _f"> </span>The byte we needed to copy wasn’t one for a lower<span class="_ _1"></span>-case </div><div class="t m0 x1e hd y28c ffa1 fs7 fc3 sc0 ls12 ws1">letter<span class="_ _6"></span>, so it was left alone by the toupper r<span class="_ _1"></span>outine.</div><div class="t m0 xc hd y6e3 ffa1 fs7 fc3 sc0 ls1 ws1">A successful hack usually r<span class="_ _1"></span>equires some luck and fortuitous </div><div class="t m0 xd hd y28d ffa1 fs7 fc3 sc0 ls1 ws1">circumstances<span class="_ _1"></span>. If this wasn’t the case, we still ha<span class="_ _3"></span>ve some </div><div class="t m0 xd hd y28e ffa1 fs7 fc3 sc0 ls1 ws1">options. F<span class="_ _1"></span>or example, we could jump in<span class="_ _3"></span>to the middle of the </div><div class="t m0 xd hd y28f ffa1 fs7 fc3 sc0 ls1 ws1">DownloadCreditCar<span class="_ _1"></span>dNumbers r<span class="_ _3"></span>outine. T<span class="_ _3"></span>he start of a function usually </div><div class="t m0 xd hd y264 ffa1 fs7 fc3 sc0 ls1 ws1">contains function prolog<span class="_ _3"></span>ue that, if we never in<span class="_ _3"></span>tend to successfully r<span class="_ _3"></span>eturn </div><div class="t m0 xd hd y265 ffa1 fs7 fc3 sc0 ls1 ws1">from<span class="_ _3"></span>, can be skipped. After all, we don’t care if the pr<span class="_ _1"></span>ogram continues to </div><div class="t m0 xd hd y266 ffa1 fs7 fc3 sc0 ls1 ws1">work correctly, only tha<span class="_ _3"></span>t we get our downloaded credit car<span class="_ _3"></span>d numbers<span class="_ _1"></span>.</div><div class="t m0 xc hd y1f2 ffa1 fs7 fc3 sc0 ls1 ws1">The reason the pr<span class="_ _1"></span>ogram goes into an infinite loop is because we don’t </div><div class="t m0 xd hd y1f3 ffa1 fs7 fc3 sc0 ls1 ws1">do a <span class="ffa6 ls1f wsc7">BL</span> to call DownloadCreditCar<span class="_ _1"></span>dNumbers; we us<span class="_ _0"></span>e a <span class="ffa6 ls1c wsbf">RET</span> instruction. </div><div class="t m0 xd hd ye80 ffa1 fs7 fc3 sc0 ls1 ws1">So nothing updates <span class="ffa6 ls24 wsc2">LR</span> to a new value; ther<span class="_ _1"></span>efore, the <span class="ffa6 ls1c wsbf">RET</span> at the end of </div><div class="t m0 xd hd y269 ffa1 fs7 fc3 sc0 ls1 ws1">DownloadCreditCar<span class="_ _1"></span>dNumbers jumps to the s<span class="_ _3"></span>ame address ag<span class="_ _3"></span>ain.</div><div class="t m0 xc hd y26a ffa1 fs7 fc3 sc0 ls1 ws1">This was an example of one particular buffer o<span class="_ _3"></span>verrun exploit<span class="_ _2"></span>; however<span class="_ _10"></span>, </div><div class="t m0 xd hd y1d6 ffa1 fs7 fc3 sc0 ls1 ws1">hackers h<span class="_ _3"></span>ave m<span class="_ _3"></span>any wa<span class="_ _3"></span>ys to exploit buffer overruns<span class="_ _3"></span>, whether the data is </div><div class="t m0 xd hd y1d7 ffa1 fs7 fc3 sc0 ls1 ws1">on the stack, in the C memory heap<span class="_ _3"></span>, or in our data segment<span class="_ _3"></span>. Let’<span class="_ _1"></span>s look at </div><div class="t m0 xd hd y1d8 ffa1 fs7 fc3 sc0 ls1 ws1">several wa<span class="_ _3"></span>ys to avoid b<span class="_ _3"></span>uffer overrun problems<span class="_ _1"></span>.</div><div class="t m0 xd h15 y2ec ffa5 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>Mitigating Buffer Overrun V<span class="_ _1"></span>ulnerabilities</div><div class="t m0 xd hd y211 ffa1 fs7 fc3 sc0 ls1 ws1">T<span class="_ _6"></span>o combat buffer o<span class="_ _3"></span>verrun problems, ther<span class="_ _1"></span>e are techniques we can use in </div><div class="t m0 xd hd y212 ffa1 fs7 fc3 sc0 ls1 ws1">our code and that our tools c<span class="_ _3"></span>an pro<span class="_ _3"></span>vide to help us. I<span class="_ _1"></span>n this s<span class="_ _0"></span>ection, we’ll </div><div class="t m0 xd hd y213 ffa1 fs7 fc3 sc0 ls1 ws1">look at both. F<span class="_ _1"></span>irst of all, let<span class="_ _0"></span>’<span class="_ _6"></span>s consider the bad design of the function </div><div class="t m0 xd hd y1474 ffa1 fs7 fc3 sc0 ls1 ws1">parameters to our upper<span class="_ _1"></span>-case ro<span class="_ _3"></span>utine. Befor<span class="_ _3"></span>e we consider a solution, let’<span class="_ _1"></span>s </div><div class="t m0 xd hd y1475 ffa1 fs7 fc3 sc0 ls1 ws1">look at the root c<span class="_ _3"></span>ause of many buffer o<span class="_ _1"></span>ver<span class="_ _0"></span>run problems<span class="_ _1"></span>, the C runtime’<span class="_ _6"></span>s </div><div class="t m0 xd hd y1476 ffa6 fs7 fc3 sc0 ls1 ws1">strcpy<span class="ffa1"> function, and the various solutions proposed to fix this design.</span></div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf16e" class="pf w2 h6" data-page-no="16e"><div class="pc pc16e w2 h6"><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">355</div><div class="t m0 xc ha y248 ffa5 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Don’t Use strcpy</div><div class="t m0 xc hd y249 ffa1 fs7 fc3 sc0 ls1 ws1">The C runtime’<span class="_ _6"></span>s <span class="ffa6">strcpy</span> ro<span class="_ _3"></span>utine has the following pr<span class="_ _3"></span>ototype:</div><div class="t m0 xc h18 y5eb ffa9 fs7 fc3 sc0 ls1 ws1">char * strcpy ( char * destination,</div><div class="t m0 xc h18 ybb0 ffa9 fs7 fc3 sc0 ls1 ws1">      const char * source );</div><div class="t m0 x1c hd ybb1 ffa1 fs7 fc3 sc0 ls1 ws1">It copies ch<span class="_ _3"></span>aracters fr<span class="_ _3"></span>om source to des<span class="_ _3"></span>tination, until a NULL (0) </div><div class="t m0 xc hd y324 ffa1 fs7 fc3 sc0 ls1 ws1">character is enco<span class="_ _3"></span>untered. T<span class="_ _3"></span>his results in buffer o<span class="_ _1"></span>verr<span class="_ _0"></span>un vulnera<span class="_ _3"></span>bilities like </div><div class="t m0 xc hd yb9d ffa1 fs7 fc3 sc0 ls1 ws1">we just encounter<span class="_ _1"></span>e<span class="_ _0"></span>d. The origin<span class="_ _3"></span>al suggested solution was to replace all </div><div class="t m0 xc hd yb9e ffa1 fs7 fc3 sc0 ls1 ws1">occurrences of <span class="ffa6">strcpy</span> with <span class="ffa6">strncpy</span>:</div><div class="t m0 xc h18 y5f1 ffa9 fs7 fc3 sc0 ls1 ws1">char * strncpy ( char * destination,</div><div class="t m0 xc h18 y1477 ffa9 fs7 fc3 sc0 ls1 ws1">      const char * source, size_t num );</div><div class="t m0 x1c hd yb9f ffa1 fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e you place the size of the destin<span class="_ _3"></span>ation in num<span class="_ _3"></span>, and it stops copying </div><div class="t m0 xc hd yba0 ffa1 fs7 fc3 sc0 ls1 ws1">at that poin<span class="_ _3"></span>t. Tha<span class="_ _3"></span>t stops the buffer o<span class="_ _3"></span>verrun at this point, but now the </div><div class="t m0 xc hd y1478 ffa1 fs7 fc3 sc0 ls1 ws1">destination string is not NULL (0) terminated, and this leads to a buffer </div><div class="t m0 xc hd y1479 ffa1 fs7 fc3 sc0 ls1 ws1">overrun later in the code<span class="_ _3"></span>. One suggestion is to always do the following:</div><div class="t m0 x1c h18 y147a ffa9 fs7 fc3 sc0 ls1 ws1">strncpy( dest, source, num );</div><div class="t m0 x1c h18 y460 ffa9 fs7 fc3 sc0 ls1 ws1">dest[num-1] = ‘\0’;</div><div class="t m0 x1c hd y13c9 ffa1 fs7 fc3 sc0 ls1 ws1">This NULL terminates the string, but it r<span class="_ _3"></span>equires the pr<span class="_ _1"></span>o<span class="_ _0"></span>gr<span class="_ _3"></span>ammer to </div><div class="t m0 xc hd y13ca ffa1 fs7 fc3 sc0 ls1 ws1">remember to alw<span class="_ _3"></span>ays do this<span class="_ _3"></span>. Perh<span class="_ _3"></span>aps, under de<span class="_ _3"></span>adline pressur<span class="_ _1"></span>e, this may be </div><div class="t m0 xc hd y13cb ffa1 fs7 fc3 sc0 ls1 ws1">forgotten.</div><div class="t m0 x1c hd y13cc ffa1 fs7 fc3 sc0 ls1 ws1">A new function was then intr<span class="_ _3"></span>oduced to the BSD C runtime, strlcp<span class="_ _3"></span>y, that </div><div class="t m0 xc hd y147b ffa1 fs7 fc3 sc0 ls1 ws1">always NULL terminates the destin<span class="_ _3"></span>ation string:</div><div class="t m0 xc h18 y147c ffa9 fs7 fc3 sc0 ls1 ws1">size_t strlcpy(char *destination,</div><div class="t m0 xc h18 y147d ffa9 fs7 fc3 sc0 ls1 ws1">      const char *source, size_t size);</div><div class="t m0 x1c hd y147e ffa1 fs7 fc3 sc0 ls1 ws1">This function eliminates th<span class="_ _3"></span>at pr<span class="_ _3"></span>oblem, as the destina<span class="_ _3"></span>tion is always </div><div class="t m0 xc hd y147f ffa1 fs7 fc3 sc0 ls1 ws1">NULL (0) terminated, but this function is nonstandard and not part of the </div><div class="t m0 xc hd y1480 ffa1 fs7 fc3 sc0 ls1 ws1">GNU C library.</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf16f" class="pf w2 h6" data-page-no="16f"><div class="pc pc16f w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">356</div><div class="t m0 xc hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">A criticism of both strncpy and strlcpy type functions is tha<span class="_ _3"></span>t they </div><div class="t m0 xd hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">eliminate the ability to nest these functions to quic<span class="_ _3"></span>kly build larger mor<span class="_ _3"></span>e </div><div class="t m0 xd hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">complicated strings<span class="_ _1"></span>. This is be<span class="_ _0"></span>ca<span class="_ _3"></span>use you don’t easily know the r<span class="_ _1"></span>emaining </div><div class="t m0 xd hd y1b0 ffa1 fs7 fc3 sc0 ls1 ws1">buffer length if you’r<span class="_ _1"></span>e concatenating strings together<span class="_ _10"></span>. Another suggested </div><div class="t m0 xd hd y1b1 ffa1 fs7 fc3 sc0 ls1 ws1">solution is the following:</div><div class="t m0 xd h18 y60e ffa9 fs7 fc3 sc0 ls1 ws1">char * strecpy ( char * destination,</div><div class="t m0 xd h18 y230 ffa9 fs7 fc3 sc0 ls1 ws1">      const char * source, char * end );</div><div class="t m0 xc hd y231 ffa1 fs7 fc3 sc0 ls1 ws1">This <span class="ffa6">strecpy</span> passes in a pointer to the end of the destination b<span class="_ _3"></span>uffer<span class="_ _6"></span>. </div><div class="t m0 xd hd y2e3 ffa1 fs7 fc3 sc0 ls1 ws1">This is handy when you nest c<span class="_ _3"></span>alls, since <span class="ffa6">end</span> sta<span class="_ _3"></span>ys constant, unlik<span class="_ _3"></span>e a </div><div class="t m0 xd hd y2e4 ffa1 fs7 fc3 sc0 ls1 ws1">remainin<span class="_ _3"></span>g length that shrinks as you b<span class="_ _3"></span>uild the string. Again, this is a </div><div class="t m0 xd hd y2e5 ffa1 fs7 fc3 sc0 ls1 ws1">nonstandard function and not part of the C runtime<span class="_ _3"></span>.</div><div class="t m0 xc hd yb30 ffa1 fs7 fc3 sc0 ls1 ws1">These functions all stop overwriting the destination buffer and pr<span class="_ _3"></span>event </div><div class="t m0 xd hd yb31 ffa1 fs7 fc3 sc0 ls1 ws1">data corruption. However<span class="_ _10"></span>, they all have a pr<span class="_ _3"></span>oblem that they could allow </div><div class="t m0 xd hd y63e ffa1 fs7 fc3 sc0 ls1 ws1">the leakage of sensitive data<span class="_ _3"></span>. Suppose the source isn’t NULL (0) terminated </div><div class="t m0 xd hd yb32 ffa1 fs7 fc3 sc0 ls1 ws1">and the source buffer is sm<span class="_ _3"></span>aller than the destina<span class="_ _3"></span>tion buffer<span class="_ _0"></span>; then the </div><div class="t m0 xd hd ydaf ffa1 fs7 fc3 sc0 ls1 ws1">function will copy data until the destin<span class="_ _3"></span>ation buffer is full. This means we<span class="_ _3"></span>’<span class="_ _3"></span>ve </div><div class="t m0 xd hd y641 ffa1 fs7 fc3 sc0 ls1 ws1">copied some possibly sensitive data from past the end of the sour<span class="_ _1"></span>ce buffer </div><div class="t m0 xd hd y642 ffa1 fs7 fc3 sc0 ls1 ws1">into the destina<span class="_ _3"></span>tion buffer<span class="_ _6"></span>. If this is displayed la<span class="_ _3"></span>ter<span class="_ _6"></span>, it might give a<span class="_ _1"></span>way some </div><div class="t m0 xd hd y643 ffa1 fs7 fc3 sc0 ls1 ws1">sort of sensitive or helpful information to hackers<span class="_ _1"></span>. This leads to another </div><div class="t m0 xd hd y946 ffa1 fs7 fc3 sc0 ls1 ws1">form<span class="_ _0"></span>:</div><div class="t m0 xd h18 y1481 ffa9 fs7 fc3 sc0 ls1 ws1">errno_t strncpy_s(char * destination, size_t destmax,</div><div class="t m0 xd h18 y1482 ffa9 fs7 fc3 sc0 ls1 ws1">    const char * source, size_t srcmax);</div><div class="t m0 xc hd yc70 ffa1 fs7 fc3 sc0 lsc wsc8">In <span class="ffa6 ls1 ws1">strncpy_s<span class="ffa1"> we provide the size of both buffers and the function </span></span></div><div class="t m0 xd hd y1483 ffa1 fs7 fc3 sc0 ls1 ws1">returns an err<span class="_ _3"></span>or code to tell us what ha<span class="_ _3"></span>ppened.</div><div class="t m0 xc hd y1484 ffa1 fs7 fc3 sc0 ls1 ws1">I went through this discussion t<span class="_ _3"></span>o point out that ther<span class="_ _1"></span>e are a lot of  </div><div class="t m0 xd hd y1485 ffa1 fs7 fc3 sc0 ls1 ws1">trade- <span class="_ _b"></span>offs in fixing API designs<span class="_ _3"></span>. When making the upper<span class="_ _1"></span>-case routine mor<span class="_ _1"></span>e </div><div class="t m0 xd hd y1486 ffa1 fs7 fc3 sc0 ls1 ws1">secure<span class="_ _3"></span>, there ar<span class="_ _3"></span>e quite a few trade-offs to consider<span class="_ _10"></span>. W<span class="_ _1"></span>e’ll present a list of </div><div class="t m0 xd hd y1487 ffa1 fs7 fc3 sc0 ls1 ws1">recommendations to<span class="_ _3"></span>ward the end of this c<span class="_ _3"></span>hapter<span class="_ _10"></span>, but first let’<span class="_ _1"></span>s see what </div><div class="t m0 xd hd y1488 ffa1 fs7 fc3 sc0 ls1 ws1">the operating sy<span class="_ _3"></span>stem and GNU compiler can do to help us<span class="_ _3"></span>.</div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf170" class="pf w2 h6" data-page-no="170"><div class="pc pc170 w2 h6"><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">357</div><div class="t m0 xc ha y248 ffa5 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>PIE Is Good</div><div class="t m0 xc hd y249 ffa1 fs7 fc3 sc0 ls1 ws1">The exploit we performed previously relied upon us knowing the addr<span class="_ _1"></span>ess </div><div class="t m0 xc hd y24a ffa1 fs7 fc3 sc0 ls1 ws1">of the DownloadCreditCar<span class="_ _1"></span>dNumbers r<span class="_ _3"></span>outine. T<span class="_ _3"></span>he assumption is that we </div><div class="t m0 xc hd y24b ffa1 fs7 fc3 sc0 ls1 ws1">learned this from somewher<span class="_ _3"></span>e else, perha<span class="_ _3"></span>ps obtaining an illicit copy of the </div><div class="t m0 xc hd y24c ffa1 fs7 fc3 sc0 ls1 ws1">application’<span class="_ _6"></span>s source code<span class="_ _3"></span>, or the build map file fr<span class="_ _1"></span>om the dark web<span class="_ _3"></span>.</div><div class="t m0 x1c hd y24d ffa1 fs7 fc3 sc0 ls1 ws1">With modern virtual memory systems, the opera<span class="_ _3"></span>ting system can </div><div class="t m0 xc hd y24e ffa1 fs7 fc3 sc0 ls1 ws1">give a process an<span class="_ _3"></span>y memory addresses it likes<span class="_ _0"></span>; they don’t need to hav<span class="_ _3"></span>e </div><div class="t m0 xc hd y24f ffa1 fs7 fc3 sc0 ls1 ws1">any rela<span class="_ _3"></span>tion to real memory addresses<span class="_ _3"></span>. This ga<span class="_ _1"></span>ve ris<span class="_ _0"></span>e to a feat<span class="_ _3"></span>ure called </div><div class="t m0 xc hd y45d ffa1 fs7 fc3 sc0 ls1 ws1">position- <span class="_ _b"></span>independent executables (<span class="ffa6">PIE</span>) intr<span class="_ _3"></span>oduced to Linux around </div><div class="t m0 xc hd y45e ffa1 fs7 fc3 sc0 ls1 ws1">2005. With this featur<span class="_ _1"></span>e, an executable is loaded with a different base </div><div class="t m0 xc hd y109a ffa1 fs7 fc3 sc0 ls1 ws1">address each time it is run. This is a special case of addr<span class="_ _1"></span>ess space layout </div><div class="t m0 xc hd y109b ffa1 fs7 fc3 sc0 ls1 ws1">randomization (<span class="ffa6 ls8 ws9f">ASLR</span>), and you often see it r<span class="_ _3"></span>eferred to by either n<span class="_ _3"></span>ame.</div><div class="t m0 x1c hd y109c ffa1 fs7 fc3 sc0 ls1 ws1">This sounds good, so why did our pr<span class="_ _3"></span>eceding exploit work? Why didn’t </div><div class="t m0 xc hd y109d ffa1 fs7 fc3 sc0 ls1 ws1">PIE defeat us? The r<span class="_ _3"></span>eason is that you need to turn on PIE in the comm<span class="_ _3"></span>and </div><div class="t m0 xc hd y12c1 ffa1 fs7 fc3 sc0 ls1 ws1">line for the <span class="ffa6">ld</span> command. This is a conservative approach<span class="_ _1"></span>, whereby turning </div><div class="t m0 xc hd y12c2 ffa1 fs7 fc3 sc0 ls1 ws1">it on, you’r<span class="_ _3"></span>e acknowledging th<span class="_ _3"></span>at you don’t ha<span class="_ _1"></span>ve any code that can’t be </div><div class="t m0 xc hd y12c3 ffa1 fs7 fc3 sc0 ls1 ws1">reloca<span class="_ _3"></span>ted. Furthermore<span class="_ _1"></span>, none of the shared libraries you’r<span class="_ _3"></span>e using ar<span class="_ _3"></span>en’t </div><div class="t m0 xc hd y12c4 ffa1 fs7 fc3 sc0 ls1 ws1">reloca<span class="_ _3"></span>table. T<span class="_ _10"></span>o turn on PIE, we nee<span class="_ _0"></span>d to add <span class="ffa6">-pie</span> to the list of options for the </div><div class="t m0 xc hd y12c5 ffa6 fs7 fc3 sc0 ls1 ws1">ld<span class="ffa1"> command. If we do this, we get the following:</span></div><div class="t m0 xc h18 y1489 ffa9 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 16$ make</div><div class="t m0 xc h18 y148a ffa9 fs7 fc3 sc0 ls1 ws1">as   main.s -o main.o</div><div class="t m0 xc h18 y148b ffa9 fs7 fc3 sc0 ls1 ws1">as   upper.s -o upper.o</div><div class="t m0 xc h18 y148c ffa9 fs7 fc3 sc0 ls1 ws1">ld -pie -o upperpie main.o upper.o</div><div class="t m0 xc h18 y148d ffa9 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 16$ ./upperpie</div><div class="t m0 xc h18 y148e ffa9 fs7 fc3 sc0 ls1 ws1">Segmentation fault</div><div class="t m0 xc h18 y148f ffa9 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 16$</div><div class="t m0 x1c hd y1490 ffa1 fs7 fc3 sc0 ls1 ws1">If we debug this with <span class="ffa6">gdb</span>, we’ll see it runs as before, but all the </div><div class="t m0 xc hd y1491 ffa1 fs7 fc3 sc0 ls1 ws1">addresses ar<span class="_ _3"></span>e changed. Often when debuggin<span class="_ _3"></span>g, we turn off PIE and only </div><div class="t m0 xc hd y1492 ffa1 fs7 fc3 sc0 ls1 ws1">enable it for r<span class="_ _3"></span>elease to make decoding wha<span class="_ _3"></span>t is going on easier<span class="_ _6"></span>.</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf171" class="pf w2 h6" data-page-no="171"><div class="pc pc171 w2 h6"><img class="bi xd y7ca w7 h24" alt="" src="bg171.png"/><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">358</div><div class="t m0 x34 h1f y7cb ffa5 fse fc3 sc0 ls1 ws1">Note<span class="ffa7"> <span class="_ _17"> </span>Apple’<span class="_ _1"></span>s iOS operating system turns on PIE by default.<span class="_ _1"></span> If your </span></div><div class="t m0 x34 h1f y7cc ffa7 fse fc3 sc0 ls1 ws1">program can’t handle it,<span class="_ _1"></span> then you need to deliberately turn it off.</div><div class="t m0 xc hd y1493 ffa1 fs7 fc3 sc0 ls1 ws1">This still isn’t ideal; it’<span class="_ _6"></span>s better since the credit card n<span class="_ _3"></span>umbers didn’t get </div><div class="t m0 xd hd y1494 ffa1 fs7 fc3 sc0 ls1 ws1">stolen, but the progr<span class="_ _1"></span>am still crashed. This can lead to an easy DoS attack </div><div class="t m0 xd hd y1495 ffa1 fs7 fc3 sc0 ls1 ws1">for hackers to m<span class="_ _3"></span>ake our applica<span class="_ _3"></span>tion una<span class="_ _3"></span>vailable<span class="_ _3"></span>.</div><div class="t m0 xc hd y1496 ffa1 fs7 fc3 sc0 ls1 ws1">W<span class="_ _1"></span>e mentioned that the progr<span class="_ _1"></span>am ne<span class="_ _0"></span>eds to be r<span class="_ _3"></span>elocatable<span class="_ _3"></span>. What stops </div><div class="t m0 xd hd y1497 ffa1 fs7 fc3 sc0 ls1 ws1">your pr<span class="_ _3"></span>ogram being r<span class="_ _3"></span>elocatable? M<span class="_ _3"></span>ostly har<span class="_ _3"></span>d-coding memory addresses </div><div class="t m0 xd hd y1498 ffa1 fs7 fc3 sc0 ls1 ws1">in your data section tha<span class="_ _3"></span>t the linker doesn’t know about<span class="_ _3"></span>. For exam<span class="_ _3"></span>ple, when </div><div class="t m0 xd hd y1499 ffa1 fs7 fc3 sc0 ls1 ws1">we use <span class="ffa6">LDR<span class="_ _0"></span>,</span> it creates an addr<span class="_ _1"></span>ess in memor<span class="_ _0"></span>y to use, but it also cr<span class="_ _3"></span>eates a </div><div class="t m0 xd hd y149a ffa1 fs7 fc3 sc0 ls1 ws1">reloca<span class="_ _3"></span>tion recor<span class="_ _3"></span>d so the loader can fix up the address<span class="_ _1"></span>.</div><div class="t m0 xc hd y149b ffa1 fs7 fc3 sc0 ls1 ws1">Apple enfor<span class="_ _3"></span>ces using <span class="ffa6">ADR</span> instead of <span class="ffa6">LDR</span> to r<span class="_ _3"></span>educe the number of </div><div class="t m0 xd hd y149c ffa1 fs7 fc3 sc0 ls1 ws1">reloca<span class="_ _3"></span>tion recor<span class="_ _3"></span>ds that need to be pr<span class="_ _3"></span>ocessed. In Chapter <span class="fc5">2</span>, “Loading and </div><div class="t m0 xd hd y149d ffa1 fs7 fc3 sc0 ls1 ws1">Adding,<span class="_ _66"></span>” we showed how to load a register with a <span class="ffa6 lsb wsb4">MOV</span> and three <span class="ffa6 ls16 wsb9">MOVK<span class="_ _0"></span></span> </div><div class="t m0 xd hd y149e ffa1 fs7 fc3 sc0 ls1 ws1">instructions. If you use this technique to load a memory address<span class="_ _3"></span>, then your </div><div class="t m0 xd hd y149f ffa1 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>am won’t be relocata<span class="_ _3"></span>ble as the loader has no idea wha<span class="_ _3"></span>t you’re doin<span class="_ _3"></span>g </div><div class="t m0 xd hd y14a0 ffa1 fs7 fc3 sc0 ls1 ws1">and can’t fix up the address<span class="_ _1"></span>.</div><div class="t m0 xc hd y14a1 ffa1 fs7 fc3 sc0 ls1 ws1">It’<span class="_ _6"></span>s a good practice to enable PIE for any C or Assembly Lan<span class="_ _3"></span>guage </div><div class="t m0 xd hd y14a2 ffa1 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams. PIE isn’t perfect<span class="_ _0"></span>; therefore<span class="_ _1"></span>, hackers ha<span class="_ _3"></span>ve found wa<span class="_ _3"></span>ys around </div><div class="t m0 xd hd y14a3 ffa1 fs7 fc3 sc0 ls1 ws1">it. But it intr<span class="_ _1"></span>oduces a s<span class="_ _0"></span>econd step; h<span class="_ _3"></span>ackers usually r<span class="_ _3"></span>equire a second </div><div class="t m0 xd hd y14a4 ffa1 fs7 fc3 sc0 ls1 ws1">vulnerability in addition to the buffer o<span class="_ _1"></span>ver<span class="_ _0"></span>run to hack y<span class="_ _3"></span>our progr<span class="_ _1"></span>am.</div><div class="t m0 xd ha y14a5 ffa5 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>P<span class="_ _1"></span>oor Stack Canaries Are theFirst toGo</div><div class="t m0 xd hd y14a6 ffa1 fs7 fc3 sc0 ls1 ws1">The GNU C compiler has a feat<span class="_ _3"></span>ure to detect buffer o<span class="_ _1"></span>ver<span class="_ _0"></span>runs. T<span class="_ _3"></span>he idea is, </div><div class="t m0 xd hd y14a7 ffa1 fs7 fc3 sc0 ls1 ws1">in any ro<span class="_ _3"></span>utine that contains a string b<span class="_ _3"></span>uffer located on the stack, to add </div><div class="t m0 xd hd y14a8 ffa1 fs7 fc3 sc0 ls1 ws1">extra code to place a secr<span class="_ _3"></span>et random value next to the s<span class="_ _3"></span>tored function </div><div class="t m0 xd hd y14a9 ffa1 fs7 fc3 sc0 ls1 ws1">return addr<span class="_ _1"></span>ess. Then this value is tested before the function r<span class="_ _1"></span>eturns, and </div><div class="t m0 xd hd y14aa ffa1 fs7 fc3 sc0 ls1 ws1">if corrupted, then a buffer overrun has occurred, and the progr<span class="_ _3"></span>am is </div><div class="t m0 xd hd y14ab ffa1 fs7 fc3 sc0 ls1 ws1">terminated. These stack can<span class="_ _3"></span>aries are like the pr<span class="_ _3"></span>overbi<span class="_ _3"></span>al canaries in a coal </div><div class="t m0 xd hd y14ac ffa1 fs7 fc3 sc0 ls1 ws1">mine, because when something goes wr<span class="_ _3"></span>ong, they’r<span class="_ _3"></span>e the first to go and </div><div class="t m0 xd hd y14ad ffa1 fs7 fc3 sc0 ls1 ws1">warn us that something bad is h<span class="_ _3"></span>appening.</div><div class="t m0 xd h12 y28b ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:300.096000px;bottom:373.270000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf172" class="pf w2 h6" data-page-no="172"><div class="pc pc172 w2 h6"><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">359</div><div class="t m0 x1c hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">The source code th<span class="_ _3"></span>at accompanies this book has a version of <span class="ffa6">upper<span class="_ _6"></span>.c<span class="ffa1"> </span></span></div><div class="t m0 xc hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">from Ch<span class="_ _3"></span>apter <span class="fc5">15</span>, “Reading and Understandin<span class="_ _3"></span>g Code,<span class="_ _66"></span>” that introduces a </div><div class="t m0 xc hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">buffer overrun. Like PIE, this is an optional feat<span class="_ _3"></span>ure and we need to enable </div><div class="t m0 xc hd y1b0 ffa1 fs7 fc3 sc0 ls1 ws1">it with a <span class="ffa6 ls7 ws6f">gcc</span> command line option. Her<span class="_ _1"></span>e w<span class="_ _0"></span>e use <span class="ffa6">-fstack<span class="_ _6"></span>-protector<span class="_ _3"></span>-all<span class="ffa1">, </span></span></div><div class="t m0 xc hd y1b1 ffa1 fs7 fc3 sc0 ls1 ws1">which is the most aggres<span class="_ _3"></span>sive form of this feature<span class="_ _1"></span>. If we add this, compile, </div><div class="t m0 xc hd y218 ffa1 fs7 fc3 sc0 ls1 ws1">and run, we get the following:</div><div class="t m0 xc h18 y230 ffa9 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 16$ make</div><div class="t m0 xc h18 y60f ffa9 fs7 fc3 sc0 ls1 ws1">gcc -o uppercanary -fstack-protector-all -O3 upper.c</div><div class="t m0 xc h18 y610 ffa9 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 16$ ./uppercanary</div><div class="t m0 xc h18 y63b ffa9 fs7 fc3 sc0 ls1 ws1">Input: This is a test!xxxxxxxxxxxxxxxxxxxxyyyyyyandevenlongeran</div><div class="t m0 xc h18 y63c ffa9 fs7 fc3 sc0 ls1 ws1">dlongerandlonger</div><div class="t m0 xc h18 y63d ffa9 fs7 fc3 sc0 ls1 ws1">Output: THIS IS A TEST!XXXXXXXXXXXXXXXXXXXYYYYYYANDEVENLONGERAN</div><div class="t m0 xc h18 y614 ffa9 fs7 fc3 sc0 ls1 ws1">DLONGERANDLONGER</div><div class="t m0 xc h18 y615 ffa9 fs7 fc3 sc0 ls1 ws1">*** stack smashing detected ***: &lt;unknown&gt; terminated</div><div class="t m0 xc h18 y616 ffa9 fs7 fc3 sc0 ls1 ws1">Aborted</div><div class="t m0 xc h18 y617 ffa9 fs7 fc3 sc0 ls1 ws1">smist08@kali:~/asm64/Chapter 16$</div><div class="t m0 x1c hd y641 ffa1 fs7 fc3 sc0 ls1 ws1">This is grea<span class="_ _3"></span>t, as it pr<span class="_ _3"></span>evented our buffer o<span class="_ _3"></span>verrun, but it is quite </div><div class="t m0 xc hd y642 ffa1 fs7 fc3 sc0 ls1 ws1">expensive since it adds quite a few instructions to every function. L<span class="_ _0"></span>et’<span class="_ _6"></span>s look </div><div class="t m0 xc hd y643 ffa1 fs7 fc3 sc0 ls1 ws1">at the code that’<span class="_ _6"></span>s generated inside our functions<span class="_ _1"></span>. The following is extracted </div><div class="t m0 xc hd y946 ffa1 fs7 fc3 sc0 ls1 ws1">from and <span class="ffa6">objdump</span> of this pr<span class="_ _3"></span>ogram:</div><div class="t m0 xc h18 y14ae ffa9 fs7 fc3 sc0 ls1 ws1">00000000000008e8 &lt;routine&gt;:</div><div class="t m0 xc h18 y14af ffa9 fs7 fc3 sc0 ls1 ws1"> 8e8:   a9be7bfd    stp   x29, x30, [sp, #-32]!</div><div class="t m0 xc h18 y14b0 ffa9 fs7 fc3 sc0 ls1 ws1"> 8ec:   90000080    adrp  x0, 10000 &lt;__FRAME_END__+0xf3c0&gt;</div><div class="t m0 xc h18 y14b1 ffa9 fs7 fc3 sc0 ls1 ws1"> 8f0:   910003fd    mov   x29, sp</div><div class="t m0 xc h18 y14b2 ffa9 fs7 fc3 sc0 ls1 ws1"> 8f4:   f947e400    ldr   x0, [x0, #4040]</div><div class="t m0 xc h18 y14b3 ffa9 fs7 fc3 sc0 ls1 ws1"> 8f8:   f9400001    ldr   x1, [x0]</div><div class="t m0 xc h18 y14b4 ffa9 fs7 fc3 sc0 ls1 ws1"> 8fc:   f9000fe1    str   x1, [sp, #24]</div><div class="t m0 xc h18 y14b5 ffa9 fs7 fc3 sc0 ls1 ws1"> 900:   d2800001    mov   x1, #0x0                  // #0</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:119.108000px;bottom:561.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf173" class="pf w2 h6" data-page-no="173"><div class="pc pc173 w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">360</div><div class="t m0 xd h18 y46b ffa9 fs7 fc3 sc0 ls1 ws1">// body of routine ...</div><div class="t m0 xd h18 ye19 ffa9 fs7 fc3 sc0 ls1 ws1"> 904:   f9400fe1    ldr   x1, [sp, #24]</div><div class="t m0 xd h18 ya17 ffa9 fs7 fc3 sc0 ls1 ws1"> 908:   f9400000    ldr   x0, [x0]</div><div class="t m0 xd h18 y85c ffa9 fs7 fc3 sc0 ls1 ws1"> 90c:   ca000020    eor   x0, x1, x0</div><div class="t m0 xd h18 y46f ffa9 fs7 fc3 sc0 ls1 ws1"> 910:   b5000080    cbnz  x0, 920 &lt;routine+0x38&gt;</div><div class="t m0 xd h18 y85d ffa9 fs7 fc3 sc0 ls1 ws1"> 918:   a8c27bfd    ldp   x29, x30, [sp], #32</div><div class="t m0 xd h18 y85e ffa9 fs7 fc3 sc0 ls1 ws1"> 91c:   d65f03c0    ret</div><div class="t m0 xd h18 y847 ffa9 fs7 fc3 sc0 ls1 ws1"> 920:   97ffff74    bl    6f0 &lt;__stack_chk_fail@plt&gt;</div><div class="t m0 xc hd y848 ffa1 fs7 fc3 sc0 ls1 wsaa">W<span class="_ _1"></span>e add four instructions to the function prologue and four instructions </div><div class="t m0 xd hd y849 ffa1 fs7 fc3 sc0 ls1 ws1">to the function epilogue.</div><div class="t m0 xc hd y84a ffa1 fs7 fc3 sc0 ls1 ws1">Let’<span class="_ _1"></span>s go through the instructions in the function pr<span class="_ _3"></span>ologue one by one:</div><div class="t m0 xc hd y14b6 ffa1 fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ffa6 ls1c wsbf">STP<span class="ffa1 ls1 ws1">: Standard instruction to stor<span class="_ _3"></span>e the <span class="ffa6 ls24 wsc2">LR</span> and <span class="ffa6">FP</span><span class="ls8 ws9f"> to </span></span></span></div><div class="t m0 x1e hd y14b7 ffa1 fs7 fc3 sc0 ls1 ws1">the stack. I<span class="_ _3"></span>t subtracts 32 fr<span class="_ _1"></span>om the stack, rather than </div><div class="t m0 x1e hd y14b8 ffa1 fs7 fc3 sc0 ls1 ws1">16 to make r<span class="_ _3"></span>oom for the stack canary.</div><div class="t m0 xc hd y14b9 ffa1 fs7 fc3 sc0 ls1 wsad"> 2. <span class="_ _6"></span><span class="ffa6 ws1">ADRP<span class="ffa1">: Standard instruction to load a pointer to the </span></span></div><div class="t m0 x1e hd y14ba ffa1 fs7 fc3 sc0 ls1 ws1">page that con<span class="_ _3"></span>tains our data segment. H<span class="_ _1"></span>ere we’re </div><div class="t m0 x1e hd y14bb ffa1 fs7 fc3 sc0 ls1 ws1">only inter<span class="_ _3"></span>ested in the stack canary value, but mos<span class="_ _3"></span>t </div><div class="t m0 x1e hd y14bc ffa1 fs7 fc3 sc0 ls1 ws1">routines will use this for other purposes as well.</div><div class="t m0 xc hd y14bd ffa1 fs7 fc3 sc0 ls1 wsad"> 3. <span class="_ _6"></span><span class="ffa6 lsb wsb4">MOV<span class="ffa1 ls1 ws1">: Move <span class="ffa6">SP</span><span class="ls8 ws9f"> to </span><span class="ffa6">FP</span>, standar<span class="_ _3"></span>d instruction to set up </span></span></div><div class="t m0 x1e hd y14be ffa1 fs7 fc3 sc0 ls1 ws1">the C stack frame<span class="_ _1"></span>.</div><div class="t m0 xc hd y14bf ffa1 fs7 fc3 sc0 ls1 wsad"> 4. <span class="_ _6"></span><span class="ffa6 ws1">LDR<span class="ffa1">: Form the address of the stac<span class="_ _3"></span>k canary. Offset </span></span></div><div class="t m0 x1e hd yb73 ffa1 fs7 fc3 sc0 ls1 ws1">4040 is where the stack c<span class="_ _3"></span>anary is stored. This </div><div class="t m0 x1e hd yb74 ffa1 fs7 fc3 sc0 ls1 ws1">is a random value gener<span class="_ _3"></span>ated by the C runtime </div><div class="t m0 x1e hd yb75 ffa1 fs7 fc3 sc0 ls1 ws1">initialization code.</div><div class="t m0 xc hd y14c0 ffa1 fs7 fc3 sc0 ls1 wsad"> 5. <span class="_ _6"></span><span class="ffa6 ws1">LDR<span class="ffa1">: L<span class="_ _0"></span>oad the value of the stac<span class="_ _3"></span>k canary into register <span class="ffa6">X1</span>.</span></span></div><div class="t m0 xc hd y14c1 ffa1 fs7 fc3 sc0 ls1 wsad"> 6. <span class="_ _6"></span><span class="ffa6 ls1c wsbf">STR<span class="ffa1 ls1 ws1">: Store the stack c<span class="_ _3"></span>anary to the correct place </span></span></div><div class="t m0 x1e hd y14c2 ffa1 fs7 fc3 sc0 ls1 ws1">on the stack to guar<span class="_ _3"></span>d the function return poin<span class="_ _3"></span>ter </div><div class="t m0 x1e hd y14c3 ffa1 fs7 fc3 sc0 ls1 ws1">(pushed <span class="ffa6 ls24 wsc2">LR</span>).</div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf174" class="pf w2 h6" data-page-no="174"><div class="pc pc174 w2 h6"><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">361</div><div class="t m0 x1c hd y145 ffa1 fs7 fc3 sc0 ls1 wsad"> 7. <span class="_ _6"></span><span class="ffa6 lsb wsb4">MOV<span class="ffa1 ls1 ws1">: O<span class="_ _0"></span>verwrite the stack canary with zero<span class="_ _1"></span>, s<span class="_ _0"></span>o it </span></span></div><div class="t m0 x9 hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">isn’t left lying aro<span class="_ _3"></span>und. This is to try and prevent data </div><div class="t m0 x9 hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">leakage.</div><div class="t m0 x1c hd y148 ffa1 fs7 fc3 sc0 ls1 ws1">Next<span class="_ _3"></span>, let’<span class="_ _6"></span>s go through the instructions in the function epilogue:</div><div class="t m0 x1c hd y6e2 ffa1 fs7 fc3 sc0 ls1 wsad"> 1. <span class="_ _6"></span><span class="ffa6 ws1">LDR<span class="ffa1">: L<span class="_ _0"></span>oad the stack c<span class="_ _3"></span>anary from the stack into </span></span></div><div class="t m0 x9 hd y28c ffa1 fs7 fc3 sc0 ls1 ws1">register <span class="ffa6">X1</span>.</div><div class="t m0 x1c hd y6e3 ffa1 fs7 fc3 sc0 ls1 wsad"> 2. <span class="_ _6"></span><span class="ffa6 ws1">LDR<span class="ffa1">: L<span class="_ _0"></span>oad the original stac<span class="_ _3"></span>k canary value from </span></span></div><div class="t m0 x9 hd y28d ffa1 fs7 fc3 sc0 ls1 ws1">the C runtime’<span class="_ _6"></span>s data segment. In this c<span class="_ _3"></span>ase, <span class="ffa6">X0</span> still </div><div class="t m0 x9 hd y28e ffa1 fs7 fc3 sc0 ls1 ws1">contains the pointer<span class="_ _10"></span>, so w<span class="_ _0"></span>e don’t need to r<span class="_ _3"></span>ebuild it.</div><div class="t m0 x1c hd y6a8 ffa1 fs7 fc3 sc0 ls1 wsad"> 3. <span class="_ _6"></span><span class="ffa6 ws1">EOR<span class="ffa1">: Compare the two values. Exclusive OR<span class="_ _1"></span>’ing two </span></span></div><div class="t m0 x9 hd y601 ffa1 fs7 fc3 sc0 ls1 ws1">registers h<span class="_ _3"></span>as the same effect as subtracting them<span class="_ _3"></span>, </div><div class="t m0 x9 hd y150 ffa1 fs7 fc3 sc0 ls1 ws1">in that the r<span class="_ _3"></span>esult is zer<span class="_ _3"></span>o if they are the same (see </div><div class="t m0 x9 hd y6a9 ffa2 fs7 fc3 sc0 ls1 ws1">Exercise 1in this chapter<span class="ffa1">).</span></div><div class="t m0 x1c hd y152 ffa1 fs7 fc3 sc0 ls1 wsad"> 4. <span class="_ _6"></span><span class="ffa6 ls1f wsc7">CBN<span class="_ _0"></span>Z<span class="ffa1 ls1 ws1">: If the values ar<span class="_ _1"></span>e not e<span class="_ _0"></span>qual (<span class="ffa6">Z</span> flag not set), </span></span></div><div class="t m0 x9 hd y153 ffa1 fs7 fc3 sc0 ls1 ws1">then we hav<span class="_ _3"></span>e a problem and jum<span class="_ _3"></span>p to the <span class="ffa6 ls1f wsc7">BL</span> </div><div class="t m0 x9 hd y154 ffa1 fs7 fc3 sc0 ls1 ws1">instruction after the <span class="ffa6 ls1c wsbf">RET</span> instruction.</div><div class="t m0 x1c hd y14c4 ffa1 fs7 fc3 sc0 ls1 wsad"> 5. <span class="_ _6"></span><span class="ffa6 ws1">LDP<span class="ffa1">: L<span class="_ _0"></span>oad </span><span class="ls24 wsc2">LR</span><span class="ffa1"> and </span>FP<span class="ffa1"> bac<span class="_ _3"></span>k from the stac<span class="_ _3"></span>k. If we got </span></span></div><div class="t m0 x9 hd y14c5 ffa1 fs7 fc3 sc0 ls1 ws1">this far<span class="_ _6"></span>, we are r<span class="_ _3"></span>easonably confident th<span class="_ _3"></span>at LR hasn’t </div><div class="t m0 x9 hd y14c6 ffa1 fs7 fc3 sc0 ls1 ws1">been overwritten because the stack canary sur<span class="_ _0"></span>vived.</div><div class="t m0 x1c hd yfa5 ffa1 fs7 fc3 sc0 ls1 wsad"> 6. <span class="_ _6"></span><span class="ffa6 ls1c wsbf">RET<span class="ffa1 ls1 ws1">: Normal subro<span class="_ _3"></span>utine return.</span></span></div><div class="t m0 x1c hd y14c7 ffa1 fs7 fc3 sc0 ls1 wsad"> 7. <span class="_ _6"></span><span class="ffa6 ls1f wsc7">BL<span class="ffa1 ls1 ws1">: Call to error r<span class="_ _3"></span>eporting routine<span class="_ _3"></span>. This ro<span class="_ _3"></span>utine </span></span></div><div class="t m0 x9 hd y14c8 ffa1 fs7 fc3 sc0 ls1 ws1">terminates the pr<span class="_ _3"></span>ogram ra<span class="_ _3"></span>ther than r<span class="_ _3"></span>eturning.</div><div class="t m0 x1c hd y14c9 ffa1 fs7 fc3 sc0 ls1 ws1">Stack can<span class="_ _3"></span>aries are quite effective<span class="_ _3"></span>, but if a hack<span class="_ _3"></span>er discovers the value </div><div class="t m0 xc hd y14ca ffa1 fs7 fc3 sc0 ls1 ws1">used in a running process, they c<span class="_ _3"></span>an construct a buffer overrun exploit. </div><div class="t m0 xc hd y14cb ffa1 fs7 fc3 sc0 ls1 ws1">Plus, the fact th<span class="_ _3"></span>at ha<span class="_ _1"></span>ving your process terminate lik<span class="_ _3"></span>e this is never a good </div><div class="t m0 xc hd y14cc ffa1 fs7 fc3 sc0 ls1 ws1">thing.</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf175" class="pf w2 h6" data-page-no="175"><div class="pc pc175 w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">362</div><div class="t m0 xd ha y248 ffa5 fs6 fc3 sc0 ls1 ws1"> <span class="_ _13"></span>Preventing Code Running ontheStack</div><div class="t m0 xd hd y249 ffa1 fs7 fc3 sc0 ls1 ws1">Originally stack o<span class="_ _3"></span>verflow exploits would copy a h<span class="_ _3"></span>acker’<span class="_ _1"></span>s Assembly </div><div class="t m0 xd hd y24a ffa1 fs7 fc3 sc0 ls1 ws1">Language pr<span class="_ _3"></span>ogram as a r<span class="_ _3"></span>egular part of the buffer<span class="_ _6"></span>, then overwrite the </div><div class="t m0 xd hd y24b ffa1 fs7 fc3 sc0 ls1 ws1">function’<span class="_ _6"></span>s return address to c<span class="_ _3"></span>ause this code to execute. T<span class="_ _3"></span>he ARM CPU’<span class="_ _1"></span>s </div><div class="t m0 xd hd y24c ffa1 fs7 fc3 sc0 ls1 ws1">hardw<span class="_ _3"></span>are security marks pa<span class="_ _3"></span>ges of memory as readable, writable<span class="_ _3"></span>, and </div><div class="t m0 xd hd y24d ffa1 fs7 fc3 sc0 ls1 ws1">executable. T<span class="_ _10"></span>o prevent code running from the stac<span class="_ _3"></span>k, Linux r<span class="_ _3"></span>emoved the </div><div class="t m0 xd hd y24e ffa1 fs7 fc3 sc0 ls1 ws1">bit allowing code to execute there and m<span class="_ _3"></span>ade the stack r<span class="_ _3"></span>ead and write only. </div><div class="t m0 xd hd y24f ffa1 fs7 fc3 sc0 ls1 ws1">With a simple example lik<span class="_ _3"></span>e this one, it’<span class="_ _6"></span>s hard to do without adding a lot of </div><div class="t m0 xd hd y45d ffa1 fs7 fc3 sc0 ls1 ws1">extra compile and link switches to en<span class="_ _3"></span>able stack code execution, since it’<span class="_ _6"></span>s </div><div class="t m0 xd hd y45e ffa1 fs7 fc3 sc0 ls1 ws1">firmly off by default.</div><div class="t m0 xc hd y109a ffa1 fs7 fc3 sc0 ls1 ws1">This doesn’t make executing code on the stac<span class="_ _3"></span>k impossible, b<span class="_ _3"></span>ut it </div><div class="t m0 xd hd y109b ffa1 fs7 fc3 sc0 ls1 ws1">makes it much mor<span class="_ _1"></span>e difficult, requiring an extra exploit to disa<span class="_ _3"></span>ble this </div><div class="t m0 xd hd y109c ffa1 fs7 fc3 sc0 ls1 ws1">featur<span class="_ _3"></span>e. The other dan<span class="_ _3"></span>ger is that a shar<span class="_ _1"></span>ed librar<span class="_ _0"></span>y you’r<span class="_ _1"></span>e using disables this </div><div class="t m0 xd hd y109d ffa1 fs7 fc3 sc0 ls1 ws1">featur<span class="_ _3"></span>e and you’r<span class="_ _3"></span>e unaw<span class="_ _3"></span>are of it<span class="_ _3"></span>.</div><div class="t m0 xd h15 y130e ffa5 fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>T<span class="_ _8"></span>rade-offs ofBuffer Overflow Mitigation </div><div class="t m0 xd h15 y14cd ffa5 fsb fc3 sc0 ls1 ws1">T<span class="_ _8"></span>echniques</div><div class="t m0 xd hd y14ce ffa1 fs7 fc3 sc0 ls1 ws1">Car<span class="_ _3"></span>e needs to be taken when designing our API<span class="_ _3"></span>s to preven<span class="_ _3"></span>t security </div><div class="t m0 xd hd y14cf ffa1 fs7 fc3 sc0 ls1 ws1">vulnerabilities<span class="_ _1"></span>. We sho<span class="_ _3"></span>uld only use routines th<span class="_ _3"></span>at pro<span class="_ _1"></span>vide some protection </div><div class="t m0 xd hd y14d0 ffa1 fs7 fc3 sc0 ls1 ws1">against buffer o<span class="_ _1"></span>ver<span class="_ _0"></span>run, for example<span class="_ _3"></span>, using strncpy o<span class="_ _1"></span>ver strcpy. Enfor<span class="_ _3"></span>ce </div><div class="t m0 xd hd y14d1 ffa1 fs7 fc3 sc0 ls1 ws1">this by adding checks to the code check<span class="_ _6"></span>-in process in your sour<span class="_ _3"></span>ce control </div><div class="t m0 xd hd y14d2 ffa1 fs7 fc3 sc0 ls1 ws1">system. B<span class="_ _3"></span>ut as pointed out previo<span class="_ _3"></span>usly, there ar<span class="_ _1"></span>e still trade-offs and </div><div class="t m0 xd hd y14d3 ffa1 fs7 fc3 sc0 ls1 ws1">weaknesses in these approaches<span class="_ _3"></span>. Ultimately the best pr<span class="_ _3"></span>otection from </div><div class="t m0 xd hd y14d4 ffa1 fs7 fc3 sc0 ls1 ws1">buffer overruns is to not ha<span class="_ _1"></span>ve them in the first place, but bewar<span class="_ _3"></span>e that no </div><div class="t m0 xd hd y14d5 ffa1 fs7 fc3 sc0 ls1 ws1">matter ho<span class="_ _3"></span>w careful y<span class="_ _3"></span>ou are<span class="_ _1"></span>, mistakes and bugs happen.</div><div class="t m0 xc hd y14d6 ffa1 fs7 fc3 sc0 ls1 ws1">Beware of da<span class="_ _3"></span>ta leakages. If y<span class="_ _3"></span>ou include a memory address in an error </div><div class="t m0 xd hd y14d7 ffa1 fs7 fc3 sc0 ls1 ws1">message, then a h<span class="_ _3"></span>acker can use this to determine wha<span class="_ _3"></span>t the PIE offset is. </div><div class="t m0 xd hd y14d8 ffa1 fs7 fc3 sc0 ls1 ws1">This might sound unlikely, b<span class="_ _3"></span>ut there ar<span class="_ _1"></span>e cases where programmers h<span class="_ _3"></span>av<span class="_ _3"></span>e </div><div class="t m0 xd hd y14d9 ffa1 fs7 fc3 sc0 ls1 ws1">a general error r<span class="_ _1"></span>epor<span class="_ _0"></span>ting mechanism th<span class="_ _3"></span>at includes the conten<span class="_ _3"></span>ts of all the </div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf176" class="pf w2 h6" data-page-no="176"><div class="pc pc176 w2 h6"><img class="bi xc y10dc w7 h61" alt="" src="bg176.png"/><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">363</div><div class="t m0 xc hd y38c ffa1 fs7 fc3 sc0 ls1 ws1">registers<span class="_ _1"></span>. S<span class="_ _0"></span>ome of these likely con<span class="_ _3"></span>tain memory addresses. CPU exploits </div><div class="t m0 xc hd y38d ffa1 fs7 fc3 sc0 ls1 ws1">like Spectr<span class="_ _3"></span>e and Meltdo<span class="_ _3"></span>wn show how to access bits of memory contained </div><div class="t m0 xc hd y4ae ffa1 fs7 fc3 sc0 ls1 ws1">in the CPU cache. I<span class="_ _1"></span>t is unlikely a hacker will find a password this wa<span class="_ _3"></span>y, but </div><div class="t m0 xc hd y4af ffa1 fs7 fc3 sc0 ls1 ws1">very likely they’ll find a memor<span class="_ _0"></span>y address or a stac<span class="_ _3"></span>k canary.</div><div class="t m0 x1c hd y4b0 ffa1 fs7 fc3 sc0 ls1 ws1">If we turn on and incorporate every buffer overflow pr<span class="_ _1"></span>otection </div><div class="t m0 xc hd y4b1 ffa1 fs7 fc3 sc0 ls1 ws1">technique and tool avail<span class="_ _3"></span>able, then ch<span class="_ _3"></span>ances are th<span class="_ _3"></span>at our code will run as </div><div class="t m0 xc hd y4b2 ffa1 fs7 fc3 sc0 ls1 ws1">much as 50% slower<span class="_ _10"></span>. This might be acceptable in some applications<span class="_ _1"></span>, or </div><div class="t m0 xc hd y4b3 ffa1 fs7 fc3 sc0 ls1 ws1">parts of applications; however<span class="_ _6"></span>, there are going to be parts of an applica<span class="_ _3"></span>tion </div><div class="t m0 xc hd y14da ffa1 fs7 fc3 sc0 ls1 ws1">that need high performance in order to be competitive or ev<span class="_ _3"></span>en usable.</div><div class="t m0 x1c hd y14db ffa1 fs7 fc3 sc0 ls1 ws1">If we hav<span class="_ _3"></span>e a section of code that needs to be heavily optimiz<span class="_ _3"></span>ed, we </div><div class="t m0 xc hd y14dc ffa1 fs7 fc3 sc0 ls1 ws1">need to ensure ther<span class="_ _3"></span>e is a layer or module outside of this code th<span class="_ _3"></span>at sanitizes </div><div class="t m0 xc hd y14dd ffa1 fs7 fc3 sc0 ls1 ws1">and ensures the corr<span class="_ _3"></span>ectness of the data tha<span class="_ _3"></span>t is passed to the optimized </div><div class="t m0 xc hd y14de ffa1 fs7 fc3 sc0 ls1 ws1">routine<span class="_ _1"></span>. It needs to be ensured that this da<span class="_ _3"></span>ta checking can’t be b<span class="_ _3"></span>ypassed </div><div class="t m0 xc hd y14df ffa1 fs7 fc3 sc0 ls1 ws1">and that it ensur<span class="_ _1"></span>es that the data passes any assumptions in the optimized </div><div class="t m0 xc hd y14e0 ffa1 fs7 fc3 sc0 ls1 ws1">routines<span class="_ _1"></span>. Code and se<span class="_ _0"></span>curity reviews c<span class="_ _3"></span>an help with this to ensure sever<span class="_ _3"></span>al </div><div class="t m0 xc hd y14e1 ffa1 fs7 fc3 sc0 ls1 ws1">sets of eyes hav<span class="_ _3"></span>e looked for potential problems<span class="_ _1"></span>. The reviewers must ha<span class="_ _1"></span>ve </div><div class="t m0 xc hd y14e2 ffa1 fs7 fc3 sc0 ls1 ws1">security and hacking expertise, so they know what to look out for<span class="_ _10"></span>.</div><div class="t m0 x36 h1f y14e3 ffa5 fse fc3 sc0 ls1 ws1">Note<span class="ffa7"> <span class="_ _19"> </span>Placing this code in the user interface module is often a </span></div><div class="t m0 x36 h1f y14e4 ffa7 fse fc3 sc0 ls1 ws1">mistake.<span class="_ _1"></span> For example,<span class="_ _1"></span> if you’re writing a web application,<span class="_ _3"></span> then the </div><div class="t m0 x36 h1f y14e5 ffa7 fse fc3 sc0 ls1 ws1">UI is typically written in JavaScript and runs in the bro<span class="_ _0"></span>wser<span class="_ _10"></span>.<span class="_ _1"></span> Since </div><div class="t m0 x36 h1f y14e6 ffa7 fse fc3 sc0 ls1 ws1">JavaScript is an interpreted langua<span class="_ _0"></span>ge,<span class="_ _1"></span> hackers can modify the </div><div class="t m0 x36 h1f y14e7 ffa7 fse fc3 sc0 ls1 ws1">JavaScript to bypass an<span class="_ _0"></span>y error checking.<span class="_ _1"></span> Hackers may dispense with </div><div class="t m0 x36 h1f y14e8 ffa7 fse fc3 sc0 ls1 ws1">the JavaScript entirely and send bad messa<span class="_ _0"></span>ges to the web server<span class="_ _6"></span>.<span class="_ _1"></span> </div><div class="t m0 x36 h1f y14e9 ffa7 fse fc3 sc0 ls1 ws1">The same is true for all c<span class="_ _3"></span>lient/server a<span class="_ _0"></span>pplications.<span class="_ _1"></span> <span class="_ _3"></span>The server must </div><div class="t m0 x36 h1f y14ea ffa7 fse fc3 sc0 ls1 ws1">validate its da<span class="_ _0"></span>ta and not rely on the UI layer<span class="_ _10"></span>.</div><div class="t m0 x1c hd y14eb ffa1 fs7 fc3 sc0 ls1 ws1">A weakness with the Linux facilities like PIE is that if yo<span class="_ _3"></span>u link any </div><div class="t m0 xc hd y14ec ffa1 fs7 fc3 sc0 ls1 ws1">shared libr<span class="_ _1"></span>ar<span class="_ _0"></span>y that disables PIE, then PIE is disabled for the en<span class="_ _3"></span>tire </div><div class="t m0 xc hd y14ed ffa1 fs7 fc3 sc0 ls1 ws1">application. I<span class="_ _1"></span>t<span class="_ _0"></span>’<span class="_ _6"></span>s critical to ensure the completed executable s<span class="_ _3"></span>till has PIE </div><div class="t m0 xc hd y14ee ffa1 fs7 fc3 sc0 ls1 ws1">enabled; otherwis<span class="_ _0"></span>e you need to find the offending libr<span class="_ _1"></span>ar<span class="_ _0"></span>ies and r<span class="_ _3"></span>eplace </div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf177" class="pf w2 h6" data-page-no="177"><div class="pc pc177 w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">364</div><div class="t m0 xd hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">them. The same is true for disabling s<span class="_ _3"></span>tack execution. Ther<span class="_ _3"></span>e isn’t any </div><div class="t m0 xd hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">good reason to not use PIE, or preven<span class="_ _3"></span>t stack execution, since these don’t </div><div class="t m0 xd hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">degrade the performance of your applica<span class="_ _3"></span>tion.</div><div class="t m0 xc hd y1b0 ffa1 fs7 fc3 sc0 ls1 ws1">Similarly, you migh<span class="_ _3"></span>t ha<span class="_ _3"></span>ve stack can<span class="_ _3"></span>aries enabled in your code<span class="_ _3"></span>, but </div><div class="t m0 xd hd y1b1 ffa1 fs7 fc3 sc0 ls1 ws1">the shared libr<span class="_ _1"></span>ar<span class="_ _0"></span>ies you’r<span class="_ _1"></span>e using may not be compiled with this option. </div><div class="t m0 xd hd y1b2 ffa1 fs7 fc3 sc0 ls1 wsaa">Therefor<span class="_ _1"></span>e, your code is all protected, but if h<span class="_ _3"></span>ackers find a buffer o<span class="_ _1"></span>verflow in </div><div class="t m0 xd hd y1b3 ffa1 fs7 fc3 sc0 ls1 ws1">a routine in a sh<span class="_ _3"></span>ared libr<span class="_ _3"></span>ary, then the<span class="_ _0"></span>y will likely be able to exploit it<span class="_ _3"></span>. Stack </div><div class="t m0 xd hd y1b4 ffa1 fs7 fc3 sc0 ls1 ws1">canaries are expensive t<span class="_ _3"></span>o use, so often progr<span class="_ _1"></span>ammers us<span class="_ _0"></span>e these sparingly or </div><div class="t m0 xd hd y1b5 ffa1 fs7 fc3 sc0 ls1 ws1">not at all.</div><div class="t m0 xc hd y1b6 ffa1 fs7 fc3 sc0 ls1 ws1">Hac<span class="_ _3"></span>kers are c<span class="_ _3"></span>lever and look for small chinks in an applica<span class="_ _3"></span>tion’<span class="_ _6"></span>s ar<span class="_ _0"></span>mor </div><div class="t m0 xd hd y1b7 ffa1 fs7 fc3 sc0 ls1 ws1">that they can exploit. H<span class="_ _1"></span>ackers are pa<span class="_ _3"></span>tient, and if they find one chink tha<span class="_ _3"></span>t </div><div class="t m0 xd hd ya1c ffa1 fs7 fc3 sc0 ls1 ws1">isn’t quite enough to use, they keep looking<span class="_ _3"></span>. By combining sever<span class="_ _3"></span>al bits </div><div class="t m0 xd hd ya1d ffa1 fs7 fc3 sc0 ls1 ws1">of information and holes<span class="_ _3"></span>, they can work out how to cr<span class="_ _3"></span>ack your pr<span class="_ _1"></span>ogram<span class="_ _1"></span>’<span class="_ _1"></span>s </div><div class="t m0 xd hd y944 ffa1 fs7 fc3 sc0 ls1 ws1">security.</div><div class="t m0 xd h15 ybfc ffa5 fsb fc3 sc0 ls1 wsaf"> Summar<span class="_ _0"></span>y</div><div class="t m0 xd hd y14ef ffa1 fs7 fc3 sc0 ls1 ws1">This chapter was a sm<span class="_ _3"></span>all glimpse into the world of hackin<span class="_ _3"></span>g. W<span class="_ _1"></span>e showed </div><div class="t m0 xd hd y14f0 ffa1 fs7 fc3 sc0 ls1 ws1">how one of the most famous exploits works<span class="_ _1"></span>, namely, exploiting buffer </div><div class="t m0 xd hd y14f1 ffa1 fs7 fc3 sc0 ls1 ws1">overrun. W<span class="_ _1"></span>e then looked at various solutions to the problem, t<span class="_ _3"></span>o make our </div><div class="t m0 xd hd y14f2 ffa1 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams more bulletpr<span class="_ _1"></span>oof, and also how to fix our own code and use the </div><div class="t m0 xd hd y14f3 ffa1 fs7 fc3 sc0 ls1 ws1">various tools pro<span class="_ _1"></span>vide<span class="_ _0"></span>d b<span class="_ _3"></span>y Linux and GNU C.</div><div class="t m0 xc hd y14f4 ffa1 fs7 fc3 sc0 ls1 ws1">The occurrence of ma<span class="_ _3"></span>jor data br<span class="_ _3"></span>eaches at banks<span class="_ _3"></span>, credit agencies<span class="_ _1"></span>, and </div><div class="t m0 xd hd y14f5 ffa1 fs7 fc3 sc0 ls1 ws1">other online corporate syst<span class="_ _3"></span>ems happens r<span class="_ _3"></span>egularly. Large corporations h<span class="_ _3"></span>a<span class="_ _3"></span>ve </div><div class="t m0 xd hd y14f6 ffa1 fs7 fc3 sc0 ls1 ws1">the money to hire the best security consultants and use the best tools, y<span class="_ _3"></span>et </div><div class="t m0 xd hd y14f7 ffa1 fs7 fc3 sc0 ls1 ws1">they’re exploited time and again. T<span class="_ _10"></span>ake this as a warning to be diligent and </div><div class="t m0 xd hd y14f8 ffa1 fs7 fc3 sc0 ls1 ws1">conscious of hacking issues in y<span class="_ _3"></span>our own progr<span class="_ _1"></span>amming.</div><div class="t m0 xc hd y14f9 ffa1 fs7 fc3 sc0 ls1 ws1">If you’<span class="_ _3"></span>ve read this far<span class="_ _10"></span>, you should ha<span class="_ _1"></span>ve a goo<span class="_ _0"></span>d idea of how t<span class="_ _3"></span>o write 64- </div><div class="t m0 xd hd y14fa ffa1 fs7 fc3 sc0 ls1 ws1">bit Assembly Language pr<span class="_ _3"></span>ograms for Andr<span class="_ _3"></span>oid, iOS<span class="_ _3"></span>, and Linux. Y<span class="_ _1"></span>ou know </div><div class="t m0 xd hd y14fb ffa1 fs7 fc3 sc0 ls1 ws1">how to write basic progr<span class="_ _3"></span>ams, as well as use the FPU and the advanced </div><div class="t m0 xd hd y14fc ffa1 fs7 fc3 sc0 ls1 ws1">NEON processor to execute SIMD instructions<span class="_ _3"></span>.</div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf178" class="pf w2 h6" data-page-no="178"><div class="pc pc178 w2 h6"><div class="t m0 x17 hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">365</div><div class="t m0 x1c hd y145 ffa1 fs7 fc3 sc0 ls1 ws1">No<span class="_ _3"></span>w it&apos;s up to you to go forth and experiment. The only wa<span class="_ _3"></span>y to learn </div><div class="t m0 xc hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>amming is by doing<span class="_ _3"></span>. Think up your own Assembly Langua<span class="_ _3"></span>ge projects<span class="_ _3"></span>, </div><div class="t m0 xc hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">for example:</div><div class="t m0 x1c hd y148 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>Control a r<span class="_ _1"></span>obot conne<span class="_ _0"></span>cted to the GPIO pins of an </div><div class="t m0 x9 hd y149 ffa1 fs7 fc3 sc0 ls1 ws1">NVidia J<span class="_ _3"></span>etson Nano<span class="_ _1"></span>.</div><div class="t m0 x1c hd y28c ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Optimize an AI object recognition algorithm with </div><div class="t m0 x9 hd y14b ffa1 fs7 fc3 sc0 ls1 ws1">Assembly Language code<span class="_ _3"></span>, even using the NEON </div><div class="t m0 x9 hd y58d ffa1 fs7 fc3 sc0 ls1 ws1">processor<span class="_ _10"></span>.</div><div class="t m0 x1c hd y28e ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>Contribute to the ARM<span class="_ _1"></span>-specific parts of the </div><div class="t m0 x9 hd y28f ffa1 fs7 fc3 sc0 ls1 ws1">Linux kernel to impr<span class="_ _3"></span>ove the oper<span class="_ _3"></span>ating system<span class="_ _6"></span>’<span class="_ _1"></span>s </div><div class="t m0 x9 hd y264 ffa1 fs7 fc3 sc0 ls1 ws1">performance.</div><div class="t m0 x1c hd y150 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>Enhance GCC to generate mor<span class="_ _3"></span>e efficient ARM code<span class="_ _3"></span>.</div><div class="t m0 x1c hd y151 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Think of something original that migh<span class="_ _3"></span>t be the next </div><div class="t m0 x9 hd y152 ffa1 fs7 fc3 sc0 ls1 ws1">killer application.</div><div class="t m0 xc h15 y14fd ffa5 fsb fc3 sc0 ls1 wsaf"> Exercises</div><div class="t m0 x1c hd yc8b ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>1. <span class="_ _f"> </span>In the discussion of the epilogue code when stack </div><div class="t m0 x9 hd y14fe ffa1 fs7 fc3 sc0 ls1 ws1">canaries are en<span class="_ _3"></span>abled, we mentioned that the </div><div class="t m0 x9 hd y14ff ffa1 fs7 fc3 sc0 ls1 ws1">instruction</div><div class="t m0 x1 h18 y1301 ffa9 fs7 fc3 sc0 ls1 ws1">eor x0, x1, x0</div><div class="t m0 x9 hd ye29 ffa1 fs7 fc3 sc0 ls1 ws1">will set X0 to zero if X0 and X1 ar<span class="_ _3"></span>e equal. Look up </div><div class="t m0 x9 hd y1500 ffa1 fs7 fc3 sc0 ls1 ws1">the logic rules for the exclusive or instruction and </div><div class="t m0 x9 hd y1501 ffa1 fs7 fc3 sc0 ls1 ws1">show how this works<span class="_ _1"></span>.</div><div class="t m0 x1c hd y1502 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>2. <span class="_ _f"> </span>Consider the various APIs for str<span class="_ _1"></span>cpy. Choose one </div><div class="t m0 x9 hd y1503 ffa1 fs7 fc3 sc0 ls1 ws1">for toupper and implement it to pr<span class="_ _1"></span>e<span class="_ _0"></span>ven<span class="_ _3"></span>t a buffer </div><div class="t m0 x9 hd y1504 ffa1 fs7 fc3 sc0 ls1 ws1">overrun.</div><div class="t m0 x74 h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf179" class="pf w2 h6" data-page-no="179"><div class="pc pc179 w2 h6"><div class="t m0 xd hd y3f ffa1 fs7 fc3 sc0 ls1 ws1">366</div><div class="t m0 xc hd y145 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>3. <span class="_ _f"> </span>T<span class="_ _1"></span>urn on stack canaries for the upper<span class="_ _6"></span>.c program fr<span class="_ _1"></span>om </div><div class="t m0 x1e hd y146 ffa1 fs7 fc3 sc0 ls1 ws1">Chapter <span class="fc5">15</span>, “Reading and U<span class="_ _3"></span>nderstanding Code.<span class="_ _66"></span>” </div><div class="t m0 x1e hd y147 ffa1 fs7 fc3 sc0 ls1 ws1">Play with it to see it working correctly and a stac<span class="_ _3"></span>k </div><div class="t m0 x1e hd y1b0 ffa1 fs7 fc3 sc0 ls1 ws1">overrun being caugh<span class="_ _3"></span>t.</div><div class="t m0 xc hd y149 ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>4. <span class="_ _f"> </span>T<span class="_ _1"></span>urn on PIE with s<span class="_ _0"></span>ome of the existing sample </div><div class="t m0 x1e hd y14a ffa1 fs7 fc3 sc0 ls1 ws1">progr<span class="_ _3"></span>ams to ensure they work oka<span class="_ _1"></span>y.</div><div class="t m0 xc hd y14b ffa1 fs7 fc3 sc0 ls1 ws1"> <span class="_ _16"> </span>5. <span class="_ _f"> </span>Do you think that alwa<span class="_ _3"></span>ys turning on maximum </div><div class="t m0 x1e hd y14c ffa1 fs7 fc3 sc0 ls1 ws1">protection and living with the performance hit is the </div><div class="t m0 x1e hd yf9d ffa1 fs7 fc3 sc0 ls1 ws1">safest appr<span class="_ _3"></span>oach?</div><div class="t m0 xd h12 y71 ffa7 fsa fc3 sc0 ls1 ws1">CHAPTER 16 <span class="_ _f"> </span> HACKING CODE</div><a class="l" href="#pf152" data-dest-detail='[338,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:123.031000px;bottom:561.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf17a" class="pf w2 h6" data-page-no="17a"><div class="pc pc17a w2 h6"><img class="bi xc y1505 w7 h62" alt="" src="bg17a.png"/><div class="t m0 x17 hd y16a ffaa fs7 fc3 sc0 ls1 ws1">367</div><div class="t m0 xc h17 y16b ffaa fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ffaa fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ffab">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ffaa">,  </span></span></div><div class="t m0 xc h17 y16d ffaa fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1</div><div class="t m0 xc h63 y1506 ffac fs6 fc3 sc0 ls1 wsdb"> APPENDIX <span class="_ _14"> </span>A</div><div class="t m0 xc h8 y1507 ffad fs4 fc3 sc0 ls1 ws1">The ARM  </div><div class="t m0 xc h8 y1508 ffad fs4 fc3 sc0 ls1 ws1">Instruction Set</div><div class="t m0 xc hd y1509 ffaa fs7 fc3 sc0 ls1 ws1">This appendix lists the ARM 64-bit instruction in two sections<span class="_ _0"></span>: first, the </div><div class="t m0 xc hd y150a ffaa fs7 fc3 sc0 ls1 ws1">core instruction set, then the NEON and FPU instructions. Ther<span class="_ _1"></span>e is a br<span class="_ _0"></span>ief </div><div class="t m0 xc hd y150b ffaa fs7 fc3 sc0 ls1 ws1">description of each instruction:</div><div class="t m0 x1c hd y150c ffaa fs7 fc3 sc0 ls37 ws1">{S} after an instruction indicates you can option<span class="_ _3"></span>ally set the </div><div class="t m0 xc hd y150d ffaa fs7 fc3 sc0 ls37 ws1">condition flags.</div><div class="t m0 x1c hd y150e ffaa fs7 fc3 sc0 ls1 ws1">† means the instruction is an alias.</div><div class="t m0 xc h15 y150f ffae fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>ARM 64-Bit Core Instructions</div><div class="t m0 xc h10 y1510 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y1511 ffaf fs7 fc3 sc0 ls1 ws1">ADC{S}<span class="_ _84"> </span>Add with carry</div><div class="t m0 xc h10 y1512 ffaf fs7 fc3 sc0 ls1 ws1">ADD{S}<span class="_ _1c"> </span>Add</div><div class="t m0 xc h10 y1513 ffaf fs7 fc3 sc0 ls1 ws1">ADDG<span class="_ _85"> </span>Add with tag</div><div class="t m0 xc h10 y1514 ffaf fs7 fc3 sc0 ls1 ws1">ADR<span class="_ _86"> </span>Form PC relative address</div><div class="t m0 xc h10 y1515 ffaf fs7 fc3 sc0 ls1 ws1">ADRP<span class="_ _87"> </span>Form PC relative address to 4KB page</div><div class="t m0 xc h10 y1516 ffaf fs7 fc3 sc0 ls1 ws1">AND{S}<span class="_ _1c"> </span><span class="wsa">Bitwise AND</span></div><div class="t m0 x5 h20 y1517 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><a class="l" href="https://doi.org/10.1007/978-1-4842-5881-1"><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:156.340000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf17b" class="pf w2 h6" data-page-no="17b"><div class="pc pc17b w2 h6"><img class="bi xd y1518 w7 h64" alt="" src="bg17b.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">368</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">ASR†<span class="_ _88"> </span>Arithmetic shift right</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">ASRV<span class="_ _88"> </span>Arithmetic shift right variable</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls38 wsdc">AT<span class="_ _0"></span>†<span class="_ _89"> </span><span class="ls1 ws1">Address translate</span></div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 wsa">AUTDA,<span class="_ _1"></span> AUTDZA<span class="_ _8a"> </span><span class="ws1">Authenticate data address, using key <span class="_ _1"></span>A</span></div><div class="t m0 xd h10 y151e ffaf fs7 fc3 sc0 ls1 wsa">AUTDB,<span class="_ _1"></span> AUTDZB<span class="_ _8b"> </span><span class="ws1">Authenticate data address, using key B</span></div><div class="t m0 xd h10 y151f ffaf fs7 fc3 sc0 ls1 wsa">AUTIA,<span class="_ _1"></span> AUTIA1716<span class="_ _82"> </span><span class="ws1">Authentica<span class="_ _0"></span>te instruction address,<span class="_ _1"></span> using key <span class="_ _1"></span>A</span></div><div class="t m0 xd h10 y1520 ffaf fs7 fc3 sc0 ls1 wsa">AUTIASP<span class="_ _10"></span>,<span class="_ _1"></span> AUTIAZ<span class="_ _8c"> </span><span class="ws1">Authenticate instruction address,<span class="_ _3"></span> using key <span class="_ _1"></span>A</span></div><div class="t m0 xd h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">AUTIZA<span class="_ _8d"> </span>Authenticate instruction address,<span class="_ _3"></span> using key <span class="_ _1"></span>A</div><div class="t m0 xd h10 y1522 ffaf fs7 fc3 sc0 ls1 wsa">AUTIB,<span class="_ _1"></span> AUTIB1716<span class="_ _6b"> </span><span class="ws1">Authenticate instruction address,<span class="_ _3"></span> using key B</span></div><div class="t m0 xd h10 y1523 ffaf fs7 fc3 sc0 ls1 wsa">AUTIBSP<span class="_ _10"></span>,<span class="_ _1"></span> AUTIBZ<span class="_ _8e"> </span><span class="ws1">Authenticate instruction address,<span class="_ _3"></span> using key B</span></div><div class="t m0 xd h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">AUTIZB<span class="_ _8d"> </span>Authenticate instruction address,<span class="_ _1"></span> using key B</div><div class="t m0 xd h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">AXFlag<span class="_ _8f"> </span>Convert floating-point condition flags</div><div class="t m0 xd h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">B<span class="_ _90"> </span>Branch</div><div class="t m0 xd h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">B.cond<span class="_ _1e"> </span>Branch conditionally</div><div class="t m0 xd h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">BFC†<span class="_ _91"> </span>Bitfield clear</div><div class="t m0 xd h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">BFI†<span class="_ _7c"> </span>Bitfield insert</div><div class="t m0 xd h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">BFM<span class="_ _7c"> </span>Bitfield move</div><div class="t m0 xd h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">BFXIL†<span class="_ _84"> </span>Bitfield extract and insert a<span class="_ _0"></span>t low end</div><div class="t m0 xd h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">BIC{S}<span class="_ _92"> </span>Bitwise bit clear</div><div class="t m0 xd h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">BL<span class="_ _93"> </span>Branch with link</div><div class="t m0 xd h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">BLR<span class="_ _94"> </span>Branch with link to register</div><div class="t m0 xd h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">BLRAA,<span class="_ _1"></span> BLRAAZ<span class="_ _95"> </span>Branch with link to register<span class="_ _6"></span>,<span class="_ _3"></span> with pointer authentication</div><div class="t m0 x75 h20 y1530 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf17c" class="pf w2 h6" data-page-no="17c"><div class="pc pc17c w2 h6"><img class="bi xc y1531 w7 h65" alt="" src="bg17c.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">369</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y1533 ffaf fs7 fc3 sc0 ls1 ws1">BLRAB,<span class="_ _1"></span> BLRABZ<span class="_ _96"> </span>Branch with link to register<span class="_ _6"></span>,<span class="_ _3"></span> with pointer authentication</div><div class="t m0 xc h10 y1534 ffaf fs7 fc3 sc0 ls1 ws1">BR<span class="_ _97"> </span>Branch to register</div><div class="t m0 xc h10 y1535 ffaf fs7 fc3 sc0 ls1 ws1">BRAA,<span class="_ _1"></span> BRAAZ<span class="_ _98"> </span>Branch to register<span class="_ _6"></span>,<span class="_ _3"></span> with pointer authentication</div><div class="t m0 xc h10 y1536 ffaf fs7 fc3 sc0 ls1 ws1">BRAB,<span class="_ _1"></span> BRABZ<span class="_ _99"> </span>Branch to register<span class="_ _6"></span>,<span class="_ _3"></span> with pointer authentication</div><div class="t m0 xc h10 y1537 ffaf fs7 fc3 sc0 ls1 ws1">BRK<span class="_ _9a"> </span>Breakpoint instruction</div><div class="t m0 xc h10 y1538 ffaf fs7 fc3 sc0 ls1 ws1">BTI<span class="_ _7d"> </span>Branch target identification</div><div class="t m0 xc h10 y1539 ffaf fs7 fc3 sc0 ls1 ws1">CAS,<span class="_ _1"></span> CASA<span class="_ _9b"> </span>Compare and swap word or doubleword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y153a ffaf fs7 fc3 sc0 ls1 ws1">CASAL,<span class="_ _1"></span> CASL<span class="_ _6d"> </span>Compare and swap word or doubleword in memory</div><div class="t m0 xc h10 y153b ffaf fs7 fc3 sc0 ls1 ws1">CASB,<span class="_ _1"></span> CASAB<span class="_ _99"> </span>Compare and swap byte in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y153c ffaf fs7 fc3 sc0 ls1 ws1">CASALB,<span class="_ _1"></span> CASLB<span class="_ _96"> </span>Compare and swap byte in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y153d ffaf fs7 fc3 sc0 ls1 ws1">CASH,<span class="_ _1"></span> CASAH<span class="_ _9c"> </span>Compare and swap halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y153e ffaf fs7 fc3 sc0 ls1 ws1">CASALH,<span class="_ _1"></span> CASLH<span class="_ _8a"> </span>Compare and swap halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y153f ffaf fs7 fc3 sc0 ls1 ws1">CASP<span class="_ _10"></span>,<span class="_ _1"></span> CASP<span class="_ _1"></span>A<span class="_ _3b"> </span>Compare and swap pair of words or doublewords in </div><div class="t m0 x76 h10 y1540 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc h10 y1541 ffaf fs7 fc3 sc0 ls1 ws1">CASP<span class="_ _1"></span>AL, CASPL<span class="_ _9d"> </span>Compare and swap pair of words or doublewords in </div><div class="t m0 x76 h10 y1542 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc h10 y1543 ffaf fs7 fc3 sc0 ls1 ws1">CBNZ<span class="_ _87"> </span>Compare and branch on nonzero</div><div class="t m0 xc h10 y1544 ffaf fs7 fc3 sc0 ls1 ws1">CBZ<span class="_ _94"> </span>Compare and branch on zero</div><div class="t m0 xc h10 y1545 ffaf fs7 fc3 sc0 ls1 ws1">CCMN<span class="_ _9e"> </span>Conditional compare negative</div><div class="t m0 xc h10 y1546 ffaf fs7 fc3 sc0 ls1 ws1">CCMP<span class="_ _9f"> </span>Conditional compare</div><div class="t m0 xc h10 y1547 ffaf fs7 fc3 sc0 ls1 ws1">CFINV<span class="_ _a0"> </span>Invert carry fla<span class="_ _0"></span>g</div><div class="t m0 xc h10 y1548 ffaf fs7 fc3 sc0 ls1 ws1">CFP†<span class="_ _a1"> </span>Control flow prediction restriction by context</div><div class="t m0 x5 h20 y1549 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf17d" class="pf w2 h6" data-page-no="17d"><div class="pc pc17d w2 h6"><img class="bi xd y154a w7 h66" alt="" src="bg17d.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">370</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">CINC†<span class="_ _9e"> </span>Conditional increment</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">CINV†<span class="_ _9f"> </span>Conditional invert</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">CLREX<span class="_ _a2"> </span>Clear exclusive</div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">CLS<span class="_ _94"> </span>Count leading sign bits</div><div class="t m0 xd h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">CLZ<span class="_ _a3"> </span>Count leading zeros</div><div class="t m0 xd h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">CMN†<span class="_ _92"> </span>Compare negative</div><div class="t m0 xd h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">CMP†<span class="_ _a0"> </span>Compare</div><div class="t m0 xd h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">CMPP†<span class="_ _8d"> </span>Compare with tag</div><div class="t m0 xd h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">CNEG†<span class="_ _1e"> </span>Conditional negate</div><div class="t m0 xd h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">CPP†<span class="_ _91"> </span>Cache prefetch prediction restriction by context</div><div class="t m0 xd h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">CRC32B,<span class="_ _1"></span> CRC32H<span class="_ _5a"> </span>CRC32 checksum</div><div class="t m0 xd h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">CRC32W<span class="_ _6"></span>,<span class="_ _3"></span> CRC32X<span class="_ _65"> </span>CRC32 checksum</div><div class="t m0 xd h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">CRC32CB<span class="_ _3e"> </span>CRC32C checksum</div><div class="t m0 xd h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">CRC32CH<span class="_ _3e"> </span>CRC32C checksum</div><div class="t m0 xd h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">CRC32CW<span class="_ _a4"> </span>CRC32C checksum</div><div class="t m0 xd h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">CRC32CX<span class="_ _a5"> </span>CRC32C checksum</div><div class="t m0 xd h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">CSDB<span class="_ _a6"> </span>Consumption of speculative data barrier</div><div class="t m0 xd h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">CSEL<span class="_ _a1"> </span>Conditional select</div><div class="t m0 xd h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">CSET†<span class="_ _a2"> </span>Conditional set</div><div class="t m0 xd h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">CSETM†<span class="_ _a7"> </span>Conditional set mask</div><div class="t m0 xd h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">CSINC<span class="_ _9e"> </span>Conditional select increment</div><div class="t m0 xd h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">CSINV<span class="_ _92"> </span>Conditional select invert</div><div class="t m0 xd h10 y154b ffaf fs7 fc3 sc0 ls1 ws1">CSNEG<span class="_ _84"> </span>Conditional select nega<span class="_ _0"></span>tion</div><div class="t m0 x75 h20 y154c ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf17e" class="pf w2 h6" data-page-no="17e"><div class="pc pc17e w2 h6"><img class="bi xc y154a w7 h66" alt="" src="bg17e.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">371</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">DC†<span class="_ _86"> </span>Da<span class="_ _0"></span>ta cache operation</div><div class="t m0 xc h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">DCPS1<span class="_ _8f"> </span>Debug change PE state to EL1</div><div class="t m0 xc h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">DCPS2<span class="_ _8f"> </span>Debug change PE state to EL2</div><div class="t m0 xc h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">DCPS3<span class="_ _8f"> </span>Debug change PE state to EL3</div><div class="t m0 xc h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">DMB<span class="_ _29"> </span>Data memory barrier</div><div class="t m0 xc h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">DRPS<span class="_ _87"> </span>Debug restore process state</div><div class="t m0 xc h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">DSB<span class="_ _86"> </span>Data synchronization barrier</div><div class="t m0 xc h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">DVP†<span class="_ _88"> </span>Da<span class="_ _0"></span>ta value prediction restriction by context</div><div class="t m0 xc h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">EON<span class="_ _86"> </span>Bitwise exclusive OR NOT</div><div class="t m0 xc h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">EOR<span class="_ _9a"> </span>Bitwise exclusive OR</div><div class="t m0 xc h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">ERET<span class="_ _a1"> </span>Exception return</div><div class="t m0 xc h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">ERET<span class="_ _1"></span>AA,<span class="_ _1"></span> ERET<span class="_ _1"></span>AB<span class="_ _a8"> </span>Exception return,<span class="_ _1"></span> with pointer authentica<span class="_ _0"></span>tion</div><div class="t m0 xc h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">ESB<span class="_ _94"> </span>Error synchronization barrier</div><div class="t m0 xc h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">EXTR<span class="_ _a1"> </span>Extract register</div><div class="t m0 xc h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">GMI<span class="_ _a3"> </span>T<span class="_ _10"></span>a<span class="_ _0"></span>g mask insert</div><div class="t m0 xc h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">HINT<span class="_ _29"> </span>Hint instruction</div><div class="t m0 xc h10 y152a ffaf fs7 fc3 sc0 ls39 wsdd">H<span class="_ _2"></span>LT<span class="_ _a9"> </span><span class="ls1 ws1">Halt instruction</span></div><div class="t m0 xc h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">HVC<span class="_ _9a"> </span>Hyper<span class="_ _0"></span>visor call</div><div class="t m0 xc h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">IC†<span class="_ _aa"> </span>Instruction cache operation</div><div class="t m0 xc h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">IRG<span class="_ _ab"> </span>Insert random tag</div><div class="t m0 xc h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">ISB<span class="_ _a9"> </span>Instruction synchronization barrier</div><div class="t m0 xc h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">LDADD,<span class="_ _1"></span> LDADDA<span class="_ _a8"> </span>Atomic add on word or doubleword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y154b ffaf fs7 fc3 sc0 ls1 ws1">LDADDAL,<span class="_ _1"></span> LDADDL<span class="_ _ac"> </span>Atomic add on word or doubleword in memory</div><div class="t m0 x5 h20 y154d ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf17f" class="pf w2 h6" data-page-no="17f"><div class="pc pc17f w2 h6"><img class="bi xd y1518 w7 h64" alt="" src="bg17f.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">372</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">LDADDB,<span class="_ _1"></span> LDADDAB<span class="_ _5f"> </span>Atomic add on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">LDADDALB<span class="_ _ad"> </span>Atomic add on byte in memory</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">LDADDLB<span class="_ _3e"> </span>Atomic add on byte in memory</div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">LDADDH<span class="_ _a7"> </span>Atomic add on halfword in memory</div><div class="t m0 xd h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">LDADDAH<span class="_ _30"> </span>Atomic add on halfword in memory</div><div class="t m0 xd h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">LDADDALH<span class="_ _44"> </span>Atomic add on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">LDADDLH<span class="_ _37"> </span>Atomic add on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">LDAPR<span class="_ _ae"> </span>Load-acquire RCpc register</div><div class="t m0 xd h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">LDAPRB<span class="_ _af"> </span>Load-acquire RCpc register byte</div><div class="t m0 xd h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">LDAPRH<span class="_ _af"> </span>Load-acquire RCpc register halfword</div><div class="t m0 xd h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">LDAPUR<span class="_ _af"> </span>Load-acquire RCpc register (unscaled)</div><div class="t m0 xd h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">LDAPURB<span class="_ _3e"> </span>Load-acquire RCpc register byte (unscaled)</div><div class="t m0 xd h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">LDAPURH<span class="_ _3e"> </span>Load-acquire RCpc register halfword (unscaled)</div><div class="t m0 xd h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">LDAPURSB<span class="_ _b0"> </span>Load-acquire RCpc register signed byte (unscaled)</div><div class="t m0 xd h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">LDAPURSH<span class="_ _ad"> </span>Load-acquire RCpc register signed halfword (unscaled)</div><div class="t m0 xd h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">LDAPURSW<span class="_ _b1"> </span>Load-acquire RCpc register signed word (unscaled)</div><div class="t m0 xd h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">LDAR<span class="_ _88"> </span>Load-acquire register</div><div class="t m0 xd h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">LDARB<span class="_ _8f"> </span>Load-acquire register byte</div><div class="t m0 xd h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">LDARH<span class="_ _1e"> </span>Load-acquire register halfword</div><div class="t m0 xd h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">LDAXP<span class="_ _b2"> </span>Load-acquire exclusive pair of registers</div><div class="t m0 xd h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">LDAXR<span class="_ _ae"> </span>Load-acquire exclusive register</div><div class="t m0 xd h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">LDAXRB<span class="_ _af"> </span>Load-acquire exclusive register byte</div><div class="t m0 x75 h20 y154e ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf180" class="pf w2 h6" data-page-no="180"><div class="pc pc180 w2 h6"><img class="bi xc y154a w7 h66" alt="" src="bg180.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">373</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">LDAXRH<span class="_ _af"> </span>Load-acquire exc<span class="_ _1"></span>lusive register halfword</div><div class="t m0 xc h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">LDCLR,<span class="_ _1"></span> LDCLRA<span class="_ _96"> </span>Atomic bit clear on word or doubleword in memory</div><div class="t m0 xc h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">LDCLRAL,<span class="_ _1"></span> LDCLRL<span class="_ _71"> </span>Atomic bit clear on word or doubleword in memory</div><div class="t m0 xc h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">LDCLRB,<span class="_ _1"></span> LDCLRAB<span class="_ _2e"> </span>Atomic bit clear on byte in memory</div><div class="t m0 xc h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">LDCLRALB<span class="_ _9b"> </span>Atomic bit clear on byte in memory</div><div class="t m0 xc h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">LDCLRLB<span class="_ _39"> </span>Atomic bit c<span class="_ _1"></span>lear on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">LDCLRH,<span class="_ _1"></span> LDCLRAH<span class="_ _b3"> </span>Atomic bit clear on halfword in memory</div><div class="t m0 xc h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">LDCLRALH<span class="_ _9b"> </span>Atomic bit clear on halfword in memory</div><div class="t m0 xc h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">LDCLRLH<span class="_ _b4"> </span>Atomic bit clear on halfword in memory</div><div class="t m0 xc h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">LDEOR,<span class="_ _1"></span> LDEORA<span class="_ _35"> </span>Atomic exc<span class="_ _3"></span>lusive OR on word or doubleword in memory</div><div class="t m0 xc h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">LDEORAL,<span class="_ _1"></span> LDEORL<span class="_ _5b"> </span>Atomic exc<span class="_ _1"></span>lusive OR on word or doubleword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">LDEORB,<span class="_ _1"></span> LDEORAB<span class="_ _ac"> </span>Atomic exclusive OR on byte in memory</div><div class="t m0 xc h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">LDEORALB<span class="_ _b5"> </span>Atomic exclusive OR on byte in memory</div><div class="t m0 xc h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">LDEORLB<span class="_ _a5"> </span>Atomic exclusive OR on byte in memory</div><div class="t m0 xc h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">LDEORH,<span class="_ _1"></span> LDEORAH<span class="_ _b6"> </span>Atomic exclusive OR on halfword in memory</div><div class="t m0 xc h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">LDEORALH<span class="_ _b0"> </span>Atomic exclusive OR on halfword in memory</div><div class="t m0 xc h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">LDEORLH<span class="_ _a5"> </span>Atomic exclusive OR on halfword in memory</div><div class="t m0 xc h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">LDG<span class="_ _9a"> </span>Load allocation tag</div><div class="t m0 xc h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">LDGV<span class="_ _88"> </span>Load allocation tag</div><div class="t m0 xc h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">LDLAR<span class="_ _b2"> </span>Load LOAcquire register</div><div class="t m0 xc h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">LDLARB<span class="_ _55"> </span>Load LOAcquire register byte</div><div class="t m0 xc h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">LDLARH<span class="_ _af"> </span>Load LOAcquire register halfword</div><div class="t m0 xc h10 y154b ffaf fs7 fc3 sc0 ls1 ws1">LDNP<span class="_ _87"> </span>Load pair of registers, with non-temporal hint</div><div class="t m0 x5 h20 y154f ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf181" class="pf w2 h6" data-page-no="181"><div class="pc pc181 w2 h6"><img class="bi xd y1550 w7 h67" alt="" src="bg181.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">374</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">LDP<span class="_ _94"> </span>Load pair of registers</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">LDPSW<span class="_ _b7"> </span>Load pair of registers signed word</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">LDR<span class="_ _9a"> </span>Load register</div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">LDRAA,<span class="_ _1"></span> LDRAB<span class="_ _b8"> </span>Load register<span class="_ _6"></span>,<span class="_ _3"></span> with pointer authentication</div><div class="t m0 xd h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">LDRB<span class="_ _87"> </span>Load register byte</div><div class="t m0 xd h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">LDRH<span class="_ _87"> </span>Load register halfword</div><div class="t m0 xd h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">LDRSB<span class="_ _8f"> </span>Load register signed byte</div><div class="t m0 xd h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">LDRSH<span class="_ _1e"> </span>Load register signed halfword</div><div class="t m0 xd h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">LDRSW<span class="_ _1f"> </span>Load register signed word</div><div class="t m0 xd h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">LDSET<span class="_ _10"></span>, LDSET<span class="_ _6"></span>A<span class="_ _b9"> </span>Atomic bit set on word or doubleword in memory</div><div class="t m0 xd h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">LDSET<span class="_ _1"></span>AL,<span class="_ _1"></span> LDSETL<span class="_ _65"> </span>Atomic bit set on word or doubleword in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">LDSETB,<span class="_ _1"></span> LDSET<span class="_ _1"></span>AB<span class="_ _ba"> </span>Atomic bit set on byte in memory</div><div class="t m0 xd h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">LDSET<span class="_ _1"></span>ALB<span class="_ _58"> </span>Atomic bit set on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">LDSETLB<span class="_ _bb"> </span>Atomic bit set on byte in memory</div><div class="t m0 xd h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">LDSETH,<span class="_ _1"></span> LDSET<span class="_ _1"></span>AH<span class="_ _71"> </span>Atomic bit set on halfword in memory</div><div class="t m0 xd h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">LDSET<span class="_ _1"></span>ALH<span class="_ _58"> </span>Atomic bit set on halfword in memory</div><div class="t m0 xd h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">LDSETLH<span class="_ _39"> </span>Atomic bit set on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">LDSMAX<span class="_ _bc"> </span>Atomic signed maximum on word or doubleword in </div><div class="t m0 x6c h10 y1551 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y1552 ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXA<span class="_ _57"> </span>Atomic signed maximum on word or doubleword in </div><div class="t m0 x6c h10 y1553 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y1554 ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXAL<span class="_ _bd"> </span>Atomic signed maximum on word or doubleword in </div><div class="t m0 x6c h10 y1555 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 x75 h20 y1556 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf182" class="pf w2 h6" data-page-no="182"><div class="pc pc182 w2 h6"><img class="bi xc y154a w7 h66" alt="" src="bg182.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">375</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXL<span class="_ _30"> </span><span class="ls12">Atomic signed maximum on word or doubleword in memor<span class="_ _0"></span>y</span></div><div class="t m0 xc h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXB<span class="_ _be"> </span>Atomic signed maximum on byte in memory</div><div class="t m0 xc h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXAB<span class="_ _46"> </span>Atomic signed maximum on byte in memory</div><div class="t m0 xc h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXALB<span class="_ _49"> </span>Atomic signed maximum on byte in memory</div><div class="t m0 xc h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXLB<span class="_ _bd"> </span>Atomic signed maximum on byte in memory</div><div class="t m0 xc h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXH<span class="_ _be"> </span>Atomic signed maximum on halfword in memory</div><div class="t m0 xc h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXAH<span class="_ _b1"> </span>Atomic signed maximum on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXALH<span class="_ _bf"> </span>Atomic signed maximum on halfword in memory</div><div class="t m0 xc h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">LDSMAXLH<span class="_ _c0"> </span>Atomic signed maximum on halfword in memory</div><div class="t m0 xc h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">LDSMIN,<span class="_ _1"></span> LDSMINA<span class="_ _5b"> </span><span class="lsd">Atomic signed minimum on word or doubleword in memor<span class="_ _0"></span>y</span></div><div class="t m0 xc h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">LDSMINAL<span class="_ _c1"> </span><span class="lsd">Atomic signed minimum on word or doubleword in memory</span></div><div class="t m0 xc h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">LDSMINL<span class="_ _39"> </span><span class="ls12">Atomic signed minimum on word or doubleword in memor<span class="_ _0"></span>y</span></div><div class="t m0 xc h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">LDSMINB<span class="_ _b4"> </span>Atomic signed minimum on byte in memory</div><div class="t m0 xc h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">LDSMINAB<span class="_ _b5"> </span>Atomic signed minimum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">LDSMINALB<span class="_ _48"> </span>Atomic signed minimum on byte in memory</div><div class="t m0 xc h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">LDSMINLB<span class="_ _c1"> </span>Atomic signed minimum on byte in memory</div><div class="t m0 xc h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">LDSMINH<span class="_ _a5"> </span>Atomic signed minimum on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">LDSMINAH<span class="_ _b5"> </span>Atomic signed minimum on halfword in memory</div><div class="t m0 xc h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">LDSMINALH<span class="_ _43"> </span>Atomic signed minimum on halfword in memory</div><div class="t m0 xc h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">LDSMINLH<span class="_ _9b"> </span>Atomic signed minimum on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">LDTR<span class="_ _88"> </span>Load register (unprivileged)</div><div class="t m0 xc h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">LDTRB<span class="_ _ae"> </span>Load register byte (unprivileged)</div><div class="t m0 xc h10 y154b ffaf fs7 fc3 sc0 ls1 ws1">LDTRH<span class="_ _8f"> </span>Load register halfword (unprivileged)</div><div class="t m0 x5 h20 y154d ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf183" class="pf w2 h6" data-page-no="183"><div class="pc pc183 w2 h6"><img class="bi xd y1557 w7 h68" alt="" src="bg183.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">376</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">LDTRSB<span class="_ _af"> </span>Load register signed byte (unprivileged)</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">LDTRSH<span class="_ _af"> </span>Load register signed halfword (unprivileged)</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">LDTRSW<span class="_ _bc"> </span>Load register signed word (unprivileged)</div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">LDUMAX<span class="_ _bc"> </span>Atomic unsigned maximum on word or doubleword in </div><div class="t m0 x6c h10 y1558 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y1559 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXA<span class="_ _be"> </span>Atomic unsigned maximum on word or doubleword in </div><div class="t m0 x6c h10 y155a ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y155b ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXAL<span class="_ _c0"> </span>Atomic unsigned maximum on word or doubleword in </div><div class="t m0 x6c h10 y155c ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y155d ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXL<span class="_ _30"> </span>Atomic unsigned maximum on word or doubleword in </div><div class="t m0 x6c h10 y155e ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y155f ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXB<span class="_ _be"> </span>Atomic unsigned maximum on byte in memory</div><div class="t m0 xd h10 y1560 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXAB<span class="_ _b1"> </span>Atomic unsigned maximum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y1561 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXALB<span class="_ _bf"> </span>Atomic unsigned maximum on byte in memory</div><div class="t m0 xd h10 y1562 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXLB<span class="_ _46"> </span>Atomic unsigned maximum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y1563 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXH<span class="_ _a4"> </span>Atomic unsigned maximum on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y1564 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXAH<span class="_ _b1"> </span>Atomic unsigned maximum on halfword in memory</div><div class="t m0 xd h10 y1565 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXALH<span class="_ _bf"> </span>Atomic unsigned maximum on halfword in memory</div><div class="t m0 xd h10 y1566 ffaf fs7 fc3 sc0 ls1 ws1">LDUMAXLH<span class="_ _46"> </span>Atomic unsigned maximum on halfword in memory</div><div class="t m0 xd h10 y1567 ffaf fs7 fc3 sc0 ls1 ws1">LDUMIN<span class="_ _55"> </span>Atomic unsigned minimum on word or doubleword in </div><div class="t m0 x6c h10 y1568 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y1569 ffaf fs7 fc3 sc0 ls1 ws1">LDUMINA<span class="_ _b4"> </span>Atomic unsigned minimum on word or doubleword in </div><div class="t m0 x6c h10 y156a ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 x75 h20 y156b ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf184" class="pf w2 h6" data-page-no="184"><div class="pc pc184 w2 h6"><img class="bi xc y156c w7 h69" alt="" src="bg184.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">377</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">LDUMINAL<span class="_ _c1"> </span>Atomic unsigned minimum on word or doubleword in </div><div class="t m0 x76 h10 y156d ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc h10 y156e ffaf fs7 fc3 sc0 ls1 ws1">LDUMINL<span class="_ _39"> </span>Atomic unsigned minimum on word or doubleword in </div><div class="t m0 x76 h10 y156f ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc h10 y1570 ffaf fs7 fc3 sc0 ls1 ws1">LDUMINB<span class="_ _a5"> </span>Atomic unsigned minimum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y1571 ffaf fs7 fc3 sc0 ls1 ws1">LDUMINAB<span class="_ _b5"> </span>Atomic unsigned minimum on byte in memory</div><div class="t m0 xc h10 y155a ffaf fs7 fc3 sc0 ls1 ws1">LDUMINALB<span class="_ _43"> </span>Atomic unsigned minimum on byte in memory</div><div class="t m0 xc h10 y155b ffaf fs7 fc3 sc0 ls1 ws1">LDUMINLB<span class="_ _9b"> </span>Atomic unsigned minimum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y1572 ffaf fs7 fc3 sc0 ls1 ws1">LDUMINH<span class="_ _a5"> </span>Atomic unsigned minimum on halfword in memory</div><div class="t m0 xc h10 y1573 ffaf fs7 fc3 sc0 ls1 ws1">LDUMINAH<span class="_ _b0"> </span>Atomic unsigned minimum on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y1574 ffaf fs7 fc3 sc0 ls1 ws1">LDUMINALH<span class="_ _43"> </span>Atomic unsigned minimum on halfword in memory</div><div class="t m0 xc h10 y1575 ffaf fs7 fc3 sc0 ls1 ws1">LDUMINLH<span class="_ _9b"> </span>Atomic unsigned minimum on halfword in memory</div><div class="t m0 xc h10 y1576 ffaf fs7 fc3 sc0 ls1 ws1">LDUR<span class="_ _87"> </span>Load register (unscaled)</div><div class="t m0 xc h10 y1577 ffaf fs7 fc3 sc0 ls1 ws1">LDURB<span class="_ _1e"> </span>Load register byte (unscaled)</div><div class="t m0 xc h10 y1578 ffaf fs7 fc3 sc0 ls1 ws1">LDURH<span class="_ _84"> </span>Load register halfword (unscaled)</div><div class="t m0 xc h10 y1579 ffaf fs7 fc3 sc0 ls1 ws1">LDURSB<span class="_ _c2"> </span>Load register signed byte (unscaled)</div><div class="t m0 xc h10 y157a ffaf fs7 fc3 sc0 ls1 ws1">LDURSH<span class="_ _c2"> </span>Load register signed halfword (unscaled)</div><div class="t m0 xc h10 y157b ffaf fs7 fc3 sc0 ls1 ws1">LDURSW<span class="_ _c3"> </span>Load register signed word (unscaled)</div><div class="t m0 xc h10 y157c ffaf fs7 fc3 sc0 ls1 ws1">LDXP<span class="_ _91"> </span>Load exclusive pair of registers</div><div class="t m0 xc h10 y157d ffaf fs7 fc3 sc0 ls1 ws1">LDXR<span class="_ _88"> </span>Load exclusive register</div><div class="t m0 xc h10 y1553 ffaf fs7 fc3 sc0 ls1 ws1">LDXRB<span class="_ _8f"> </span>Load exclusive register byte</div><div class="t m0 xc h10 y1554 ffaf fs7 fc3 sc0 ls1 ws1">LDXRH<span class="_ _8f"> </span>Load exclusive register halfword</div><div class="t m0 xc h10 y157e ffaf fs7 fc3 sc0 ls1 ws1">LSL†<span class="_ _c4"> </span>Logical shift left</div><div class="t m0 x5 h20 y157f ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf185" class="pf w2 h6" data-page-no="185"><div class="pc pc185 w2 h6"><img class="bi xd y1518 w7 h64" alt="" src="bg185.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">378</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">LSL<span class="_ _6"></span>V<span class="_ _29"> </span>Logical shift left variable</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">LSR†<span class="_ _91"> </span>Logical shift right</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">LSRV<span class="_ _a1"> </span>Logical shift right variable</div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">MADD<span class="_ _9e"> </span>Multiply-add</div><div class="t m0 xd h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">MNEG†<span class="_ _1f"> </span>Multiply-negate</div><div class="t m0 xd h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">MOV†<span class="_ _9f"> </span>Move</div><div class="t m0 xd h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">MOVK<span class="_ _9f"> </span>Move wide with keep</div><div class="t m0 xd h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">MOVN<span class="_ _9e"> </span>Move wide with NOT</div><div class="t m0 xd h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">MOVZ<span class="_ _a0"> </span>Move wide with zero</div><div class="t m0 xd h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">MRS<span class="_ _c5"> </span>Move system register</div><div class="t m0 xd h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">MSR<span class="_ _c5"> </span>Move value to special register</div><div class="t m0 xd h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">MSUB<span class="_ _92"> </span>Multiply-subtract</div><div class="t m0 xd h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">MUL†<span class="_ _85"> </span>Multiply</div><div class="t m0 xd h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">MVN†<span class="_ _9f"> </span>Bitwise NOT</div><div class="t m0 xd h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">NEG{S}†<span class="_ _c2"> </span>Negate</div><div class="t m0 xd h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">NGC{S}†<span class="_ _a7"> </span>Nega<span class="_ _0"></span>te with carry</div><div class="t m0 xd h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">NOP<span class="_ _86"> </span>No operation</div><div class="t m0 xd h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">ORN<span class="_ _7c"> </span>Bitwise OR NOT</div><div class="t m0 xd h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">ORR<span class="_ _86"> </span>Bitwise OR</div><div class="t m0 xd h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACDA, P<span class="_ _1"></span>ACDZA<span class="_ _8b"> </span>Pointer authentication code for data address, using key <span class="_ _1"></span>A</div><div class="t m0 xd h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACDB, P<span class="_ _1"></span>ACDZB<span class="_ _35"> </span>Pointer authentication code for data address,<span class="_ _3"></span> using key B</div><div class="t m0 xd h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACGA<span class="_ _ae"> </span>Pointer authentication code,<span class="_ _3"></span> using generic key</div><div class="t m0 x75 h20 y1580 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf186" class="pf w2 h6" data-page-no="186"><div class="pc pc186 w2 h6"><img class="bi xc y122e w7 h6a" alt="" src="bg186.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">379</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACIA, P<span class="_ _1"></span>ACIA1716<span class="_ _6b"> </span>Pointer authentication code for instruction address,<span class="_ _3"></span>  </div><div class="t m0 x76 h10 y156d ffaf fs7 fc3 sc0 ls1 wsa">using <span class="_ _0"></span>key A</div><div class="t m0 xc h10 y156e ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACIASP<span class="_ _10"></span>,<span class="_ _1"></span> PACIAZ<span class="_ _8e"> </span>Pointer authentication code for instruction address,<span class="_ _3"></span>  </div><div class="t m0 x76 h10 y156f ffaf fs7 fc3 sc0 ls1 wsa">using <span class="_ _0"></span>key A</div><div class="t m0 xc h10 y1570 ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACIZA<span class="_ _1c"> </span>Pointer authentication code for instruction address,<span class="_ _1"></span>  </div><div class="t m0 x76 h10 y1581 ffaf fs7 fc3 sc0 ls1 wsa">using <span class="_ _0"></span>key A</div><div class="t m0 xc h10 y1582 ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACIB, P<span class="_ _1"></span>ACIB1716<span class="_ _6b"> </span>P<span class="_ _1"></span>ointer authentica<span class="_ _0"></span>tion code for instruction address,<span class="_ _1"></span>  </div><div class="t m0 x76 h10 y1583 ffaf fs7 fc3 sc0 ls1 ws1">using key B</div><div class="t m0 xc h10 y1584 ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACIBSP<span class="_ _10"></span>,<span class="_ _1"></span> PACIBZ<span class="_ _a8"> </span>Pointer authentication code for instruction address,<span class="_ _1"></span>  </div><div class="t m0 x76 h10 y1585 ffaf fs7 fc3 sc0 ls1 ws1">using key B</div><div class="t m0 xc h10 y1586 ffaf fs7 fc3 sc0 ls1 ws1">P<span class="_ _1"></span>ACIZ<span class="_ _7e"> </span>Pointer authentication code for instruction address,<span class="_ _1"></span>  </div><div class="t m0 x76 h10 y1587 ffaf fs7 fc3 sc0 ls1 ws1">using key B</div><div class="t m0 xc h10 y1588 ffaf fs7 fc3 sc0 ls1 ws1">PRFM<span class="_ _85"> </span>Prefetch memory</div><div class="t m0 xc h10 y1589 ffaf fs7 fc3 sc0 ls1 ws1">PSB CSYNC<span class="_ _83"> </span>Profiling synchroniza<span class="_ _0"></span>tion barrier</div><div class="t m0 xc h10 y158a ffaf fs7 fc3 sc0 ls1 ws1">PSSBB<span class="_ _8f"> </span>Physical specula<span class="_ _0"></span>tive store bypass barrier</div><div class="t m0 xc h10 y158b ffaf fs7 fc3 sc0 ls1 ws1">RBIT<span class="_ _c5"> </span>Reverse bits</div><div class="t m0 xc h10 y158c ffaf fs7 fc3 sc0 ls1 ws1">RET<span class="_ _a3"> </span>Return from subroutine</div><div class="t m0 xc h10 y158d ffaf fs7 fc3 sc0 ls1 ws1">RET<span class="_ _1"></span>AA,<span class="_ _1"></span> RET<span class="_ _1"></span>AB<span class="_ _c6"> </span>Return from subroutine,<span class="_ _1"></span> with pointer authentica<span class="_ _0"></span>tion</div><div class="t m0 xc h10 y158e ffaf fs7 fc3 sc0 ls1 ws1">REV<span class="_ _a3"> </span>Reverse bytes</div><div class="t m0 xc h10 y158f ffaf fs7 fc3 sc0 ls1 ws1">REV16<span class="_ _a2"> </span>Reverse bytes in 16-bit halfwords</div><div class="t m0 xc h10 y1590 ffaf fs7 fc3 sc0 ls1 ws1">REV32<span class="_ _a2"> </span>Reverse bytes in 32-bit words</div><div class="t m0 xc h10 y1591 ffaf fs7 fc3 sc0 ls1 ws1">REV64†<span class="_ _c7"> </span>Reverse bytes</div><div class="t m0 xc h10 y156a ffaf fs7 fc3 sc0 ls1 ws1">RMIF<span class="_ _c4"> </span>Rotate,<span class="_ _3"></span> mask insert flags</div><div class="t m0 xc h10 y1592 ffaf fs7 fc3 sc0 ls1 ws1">ROR†<span class="_ _a6"> </span>Rota<span class="_ _0"></span>te right</div><div class="t m0 x5 h20 y1593 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf187" class="pf w2 h6" data-page-no="187"><div class="pc pc187 w2 h6"><img class="bi xd y122e w7 h6a" alt="" src="bg187.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">380</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">RORV<span class="_ _87"> </span>Rotate right variable</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">SB<span class="_ _97"> </span>Specula<span class="_ _0"></span>tion barrier</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">SBC{S}<span class="_ _1e"> </span>Subtract with carr<span class="_ _0"></span>y</div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">SBFIZ†<span class="_ _1c"> </span>Signed bitfield insert in zero</div><div class="t m0 xd h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">SBFM<span class="_ _a0"> </span>Signed bitfield move</div><div class="t m0 xd h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">SBFX†<span class="_ _a2"> </span>Signed bitfield extract</div><div class="t m0 xd h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">SDIV<span class="_ _c5"> </span>Signed divide</div><div class="t m0 xd h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">SETF8,<span class="_ _1"></span> SETF16<span class="_ _c8"> </span>Evaluation of 8- or 16-bit flag values</div><div class="t m0 xd h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">SEV<span class="_ _a3"> </span>Send event</div><div class="t m0 xd h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">SEVL<span class="_ _c4"> </span>Send event local</div><div class="t m0 xd h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">SMADDL<span class="_ _c3"> </span>Signed multiply-add long</div><div class="t m0 xd h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">SMC<span class="_ _c5"> </span>Secure monitor call</div><div class="t m0 xd h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">SMNEGL†<span class="_ _be"> </span>Signed multiply-nega<span class="_ _0"></span>te long</div><div class="t m0 xd h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">SMSUBL<span class="_ _bc"> </span>Signed multiply-subtract long</div><div class="t m0 xd h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">SMULH<span class="_ _b7"> </span>Signed multiply high</div><div class="t m0 xd h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">SMULL<span class="_ _1c"> </span>Signed multiply long:<span class="_ _3"></span> an alias of SMADDL</div><div class="t m0 xd h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">SSBB<span class="_ _87"> </span>Specula<span class="_ _0"></span>tive store bypass barrier</div><div class="t m0 xd h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">ST2G<span class="_ _88"> </span>Store alloca<span class="_ _0"></span>tion tags</div><div class="t m0 xd h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">ST<span class="_ _1"></span>ADD,<span class="_ _1"></span> ST<span class="_ _1"></span>ADDL†<span class="_ _c9"> </span>Atomic add on word or doubleword in memory<span class="_ _1"></span>, without </div><div class="t m0 x6c h10 y1552 ffaf fs7 fc3 sc0 ls1 ws1">return</div><div class="t m0 xd h10 y1594 ffaf fs7 fc3 sc0 ls1 ws1">ST<span class="_ _1"></span>ADDB†<span class="_ _a5"> </span>Atomic add on byte in memory<span class="_ _1"></span>,<span class="_ _3"></span> without return</div><div class="t m0 xd h10 y1595 ffaf fs7 fc3 sc0 ls1 ws1">ST<span class="_ _1"></span>ADDLB†<span class="_ _9b"> </span>Atomic add on byte in memory<span class="_ _1"></span>,<span class="_ _3"></span> without return</div><div class="t m0 xd h10 y1596 ffaf fs7 fc3 sc0 ls1 ws1">ST<span class="_ _1"></span>ADDH†<span class="_ _3e"> </span>Atomic add on halfword in memor<span class="_ _0"></span>y<span class="_ _1"></span>,<span class="_ _1"></span> without return</div><div class="t m0 x75 h20 y1597 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf188" class="pf w2 h6" data-page-no="188"><div class="pc pc188 w2 h6"><img class="bi xc y156c w7 h69" alt="" src="bg188.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">381</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">ST<span class="_ _1"></span>ADDLH†<span class="_ _b5"> </span>Atomic add on halfword in memor<span class="_ _0"></span>y<span class="_ _1"></span>,<span class="_ _1"></span> without return</div><div class="t m0 xc h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">STCLR,<span class="_ _1"></span> STCLRL†<span class="_ _ca"> </span>Atomic bit clear on word or doubleword in memory<span class="_ _1"></span>,<span class="_ _1"></span> </div><div class="t m0 x76 h10 y156e ffaf fs7 fc3 sc0 ls1 ws1">without return</div><div class="t m0 xc h10 y1598 ffaf fs7 fc3 sc0 ls1 ws1">STCLRB,<span class="_ _1"></span> STCLRLB†<span class="_ _cb"> </span>Atomic bit clear on byte in memory<span class="_ _1"></span>,<span class="_ _1"></span> without return</div><div class="t m0 xc h10 y1558 ffaf fs7 fc3 sc0 ls1 ws1">STCLRH,<span class="_ _1"></span> STCLRLH†<span class="_ _cc"> </span>Atomic bit clear on halfword in memory<span class="_ _1"></span>,<span class="_ _1"></span> without return</div><div class="t m0 xc h10 y1559 ffaf fs7 fc3 sc0 ls1 ws1">STEOR,<span class="_ _1"></span> STEORL†<span class="_ _cd"> </span>Atomic exclusive OR on word or doubleword in memory<span class="_ _1"></span>,<span class="_ _1"></span> </div><div class="t m0 x76 h10 y155a ffaf fs7 fc3 sc0 ls1 ws1">without return</div><div class="t m0 xc h10 y155b ffaf fs7 fc3 sc0 ls1 ws1">STEORB,<span class="_ _1"></span> STEORLB†<span class="_ _77"> </span>Atomic exc<span class="_ _1"></span>lusive OR on byte in memor<span class="_ _0"></span>y<span class="_ _1"></span>,<span class="_ _1"></span> without return</div><div class="t m0 xc h10 y1572 ffaf fs7 fc3 sc0 ls1 ws1">STEORH,<span class="_ _1"></span> STEORLH†<span class="_ _60"> </span><span class="ls14">Atomic exclusive OR on halfword in memory<span class="_ _1"></span>,<span class="_ _1"></span> without return</span></div><div class="t m0 xc h10 y1573 ffaf fs7 fc3 sc0 ls1 ws1">STG<span class="_ _94"> </span>Store allocation tag</div><div class="t m0 xc h10 y1574 ffaf fs7 fc3 sc0 ls1 ws1">STGP<span class="_ _88"> </span>Store alloca<span class="_ _0"></span>tion tag and pair of registers</div><div class="t m0 xc h10 y1575 ffaf fs7 fc3 sc0 ls1 ws1">STGV<span class="_ _91"> </span>Store tag vector</div><div class="t m0 xc h10 y1576 ffaf fs7 fc3 sc0 ls1 ws1">STLLR<span class="_ _ce"> </span>Store LORelease register</div><div class="t m0 xc h10 y1577 ffaf fs7 fc3 sc0 ls1 ws1">STLLRB<span class="_ _c7"> </span>Store LORelease register byte</div><div class="t m0 xc h10 y1578 ffaf fs7 fc3 sc0 ls1 ws1">STLLRH<span class="_ _c7"> </span>Store LORelease register halfword</div><div class="t m0 xc h10 y1579 ffaf fs7 fc3 sc0 ls1 ws1">STLR<span class="_ _a1"> </span>Store-release register</div><div class="t m0 xc h10 y157a ffaf fs7 fc3 sc0 ls1 ws1">STLRB<span class="_ _b2"> </span>Store-release register byte</div><div class="t m0 xc h10 y157b ffaf fs7 fc3 sc0 ls1 ws1">STLRH<span class="_ _b2"> </span>Store-release register halfword</div><div class="t m0 xc h10 y157c ffaf fs7 fc3 sc0 ls1 ws1">STLUR<span class="_ _b2"> </span>Store-release register (unscaled)</div><div class="t m0 xc h10 y157d ffaf fs7 fc3 sc0 ls1 ws1">STLURB<span class="_ _55"> </span>Store-release register byte (unscaled)</div><div class="t m0 xc h10 y1553 ffaf fs7 fc3 sc0 ls1 ws1">STLURH<span class="_ _55"> </span>Store-release register halfword (unscaled)</div><div class="t m0 xc h10 y1554 ffaf fs7 fc3 sc0 ls1 ws1">STLXP<span class="_ _ce"> </span>Store-release exclusive pair of registers</div><div class="t m0 xc h10 y157e ffaf fs7 fc3 sc0 ls1 ws1">STLXR<span class="_ _a2"> </span>Store-release exclusive register</div><div class="t m0 x5 h20 y1599 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf189" class="pf w2 h6" data-page-no="189"><div class="pc pc189 w2 h6"><img class="bi xd y1531 w7 h65" alt="" src="bg189.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">382</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y1533 ffaf fs7 fc3 sc0 ls1 ws1">STLXRB<span class="_ _cf"> </span>Store-release exclusive register byte</div><div class="t m0 xd h10 y1534 ffaf fs7 fc3 sc0 ls1 ws1">STLXRH<span class="_ _cf"> </span>Store-release exc<span class="_ _1"></span>lusive register halfword</div><div class="t m0 xd h10 y1535 ffaf fs7 fc3 sc0 ls1 ws1">STNP<span class="_ _88"> </span>Store pair of registers,<span class="_ _1"></span> with non-temporal hint</div><div class="t m0 xd h10 y1536 ffaf fs7 fc3 sc0 ls1 ws1">STP<span class="_ _a3"> </span>Store pair of registers</div><div class="t m0 xd h10 y1537 ffaf fs7 fc3 sc0 ls1 ws1">STR<span class="_ _94"> </span>Store register</div><div class="t m0 xd h10 y1538 ffaf fs7 fc3 sc0 ls1 ws1">STRB<span class="_ _88"> </span>Store register byte</div><div class="t m0 xd h10 y1539 ffaf fs7 fc3 sc0 ls1 ws1">STRH<span class="_ _88"> </span>Store register halfword</div><div class="t m0 xd h10 y153a ffaf fs7 fc3 sc0 ls1 ws1">STSET<span class="_ _10"></span>, STSETL†<span class="_ _8c"> </span>Atomic bit set on word or doubleword in memor<span class="_ _0"></span>y<span class="_ _1"></span>,<span class="_ _1"></span>  </div><div class="t m0 x6c h10 y159a ffaf fs7 fc3 sc0 ls1 ws1">without return</div><div class="t m0 xd h10 y159b ffaf fs7 fc3 sc0 ls1 ws1">STSETB,<span class="_ _1"></span> STSETLB†<span class="_ _5d"> </span>Atomic bit set on byte in memor<span class="_ _0"></span>y<span class="_ _6"></span>, without return</div><div class="t m0 xd h10 y159c ffaf fs7 fc3 sc0 ls1 ws1">STSETH,<span class="_ _1"></span> STSETLH†<span class="_ _5f"> </span>Atomic bit set on halfword in memory<span class="_ _1"></span>, without return</div><div class="t m0 xd h10 y159d ffaf fs7 fc3 sc0 ls1 ws1">STSMAX†<span class="_ _30"> </span>Atomic signed maximum on word or doubleword in </div><div class="t m0 x6c h10 y159e ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y159f ffaf fs7 fc3 sc0 ls1 ws1">STSMAXL†<span class="_ _ad"> </span>Atomic signed maximum on word or doubleword in </div><div class="t m0 x6c h10 y15a0 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xd h10 y15a1 ffaf fs7 fc3 sc0 ls1 ws1">STSMAXB†<span class="_ _c0"> </span>Atomic signed maximum on byte in memor<span class="_ _0"></span>y<span class="_ _1"></span>,<span class="_ _1"></span> without </div><div class="t m0 x6c h10 y15a2 ffaf fs7 fc3 sc0 ls1 ws1">return</div><div class="t m0 xd h10 y15a3 ffaf fs7 fc3 sc0 ls1 ws1">STSMAXLB†<span class="_ _d0"> </span>Atomic signed maximum on byte in memory<span class="_ _1"></span>, without </div><div class="t m0 x6c h10 y15a4 ffaf fs7 fc3 sc0 ls1 ws1">return</div><div class="t m0 xd h10 y15a5 ffaf fs7 fc3 sc0 ls1 ws1">STSMAXH†<span class="_ _46"> </span>Atomic signed maximum on halfword in memor<span class="_ _0"></span>y<span class="_ _1"></span>,<span class="_ _1"></span> without </div><div class="t m0 x6c h10 y15a6 ffaf fs7 fc3 sc0 ls1 ws1">return</div><div class="t m0 xd h10 y15a7 ffaf fs7 fc3 sc0 ls1 ws1">STSMAXLH†<span class="_ _d0"> </span>Atomic signed maximum on halfword in memory<span class="_ _1"></span>,<span class="_ _1"></span>  </div><div class="t m0 x6c h10 y15a8 ffaf fs7 fc3 sc0 ls1 ws1">without return</div><div class="t m0 x75 h20 y15a9 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf18a" class="pf w2 h6" data-page-no="18a"><div class="pc pc18a w2 h6"><img class="bi xc y15aa w7 h6b" alt="" src="bg18a.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">383</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">STSMIN,<span class="_ _1"></span> STSMINL†<span class="_ _5f"> </span>Atomic signed minimum on word or doubleword in </div><div class="t m0 x76 h10 y156d ffaf fs7 fc3 sc0 ls1 ws1">memory<span class="_ _1"></span>, without return</div><div class="t m0 xc h10 y156e ffaf fs7 fc3 sc0 ls1 ws1">STSMINB†<span class="_ _c1"> </span>Atomic signed minimum on byte in memory<span class="_ _1"></span>,<span class="_ _1"></span> without </div><div class="t m0 x76 h10 y156f ffaf fs7 fc3 sc0 ls1 ws1">return</div><div class="t m0 xc h10 y1570 ffaf fs7 fc3 sc0 ls1 ws1">STSMINLB†<span class="_ _47"> </span>Atomic signed minimum on byte in memory<span class="_ _1"></span>, without </div><div class="t m0 x76 h10 y1581 ffaf fs7 fc3 sc0 ls1 ws1">return</div><div class="t m0 xc h10 y1582 ffaf fs7 fc3 sc0 ls1 ws1">STSMINH†<span class="_ _9b"> </span>Atomic signed minimum on halfword in memor<span class="_ _0"></span>y<span class="_ _1"></span>,<span class="_ _1"></span>  </div><div class="t m0 x76 h10 y1583 ffaf fs7 fc3 sc0 ls1 ws1">without return</div><div class="t m0 xc h10 y1584 ffaf fs7 fc3 sc0 ls1 ws1">STSMINLH†<span class="_ _47"> </span>Atomic signed minimum on halfword in memory<span class="_ _1"></span>,<span class="_ _1"></span>  </div><div class="t m0 x76 h10 y1585 ffaf fs7 fc3 sc0 ls1 ws1">without return</div><div class="t m0 xc h10 y1586 ffaf fs7 fc3 sc0 ls1 ws1">STTR<span class="_ _91"> </span>Store register (unprivileged)</div><div class="t m0 xc h10 y15ab ffaf fs7 fc3 sc0 ls1 ws1">STTRB<span class="_ _b2"> </span>Store register byte (unprivileged)</div><div class="t m0 xc h10 y15ac ffaf fs7 fc3 sc0 ls1 ws1">STTRH<span class="_ _ae"> </span>Store register halfword (unprivileged)</div><div class="t m0 xc h10 y15ad ffaf fs7 fc3 sc0 ls1 ws1">STUMAX†<span class="_ _30"> </span>Atomic unsigned maximum on word or doubleword in </div><div class="t m0 x76 h10 y158a ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc h10 y158b ffaf fs7 fc3 sc0 ls1 ws1">STUMAXL†<span class="_ _44"> </span>Atomic unsigned maximum on word or doubleword in </div><div class="t m0 x76 h10 y15ae ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc h10 y15af ffaf fs7 fc3 sc0 ls1 ws1">STUMAXB†<span class="_ _46"> </span>Atomic unsigned maximum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y15b0 ffaf fs7 fc3 sc0 ls1 ws1">STUMAXLB†<span class="_ _d0"> </span>Atomic unsigned maximum on byte in memory</div><div class="t m0 xc h10 y15b1 ffaf fs7 fc3 sc0 ls1 ws1">STUMAXH†<span class="_ _46"> </span>Atomic unsigned maximum on halfword in memory</div><div class="t m0 xc h10 y15b2 ffaf fs7 fc3 sc0 ls1 ws1">STUMAXLH†<span class="_ _49"> </span>Atomic unsigned maximum on halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xc h10 y15b3 ffaf fs7 fc3 sc0 ls1 ws1">STUMIN†<span class="_ _39"> </span>Atomic unsigned minimum on word or doubleword in </div><div class="t m0 x76 h10 y15b4 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 xc h10 y15b5 ffaf fs7 fc3 sc0 ls1 ws1">STUMINL†<span class="_ _58"> </span>Atomic unsigned minimum on word or doubleword in </div><div class="t m0 x76 h10 y15b6 ffaf fs7 fc3 sc0 ls1 ws1">memory</div><div class="t m0 x5 h20 y15b7 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf18b" class="pf w2 h6" data-page-no="18b"><div class="pc pc18b w2 h6"><img class="bi xd y154a w7 h66" alt="" src="bg18b.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">384</div><div class="t m0 xd h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">STUMINB†<span class="_ _9b"> </span>Atomic unsigned minimum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">STUMINLB†<span class="_ _48"> </span>Atomic unsigned minimum on byte in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">STUMINH†<span class="_ _9b"> </span>Atomic unsigned minimum on halfword in memory</div><div class="t m0 xd h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">STUMINLH†<span class="_ _48"> </span>Atomic unsigned minimum on halfword in memory</div><div class="t m0 xd h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">STUR<span class="_ _88"> </span>Store register (unscaled)</div><div class="t m0 xd h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">STURB<span class="_ _8f"> </span>Store register byte (unscaled)</div><div class="t m0 xd h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">STURH<span class="_ _8f"> </span>Store register halfword (unscaled)</div><div class="t m0 xd h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">STXP<span class="_ _a1"> </span>Store exclusive pair of registers</div><div class="t m0 xd h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">STXR<span class="_ _91"> </span>Store exclusive register</div><div class="t m0 xd h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">STXRB<span class="_ _ae"> </span>Store exclusive register byte</div><div class="t m0 xd h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">STXRH<span class="_ _ae"> </span>Store exclusive register halfword</div><div class="t m0 xd h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">STZ2G<span class="_ _b2"> </span>Store alloca<span class="_ _0"></span>tion tags,<span class="_ _1"></span> zeroing</div><div class="t m0 xd h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">STZG<span class="_ _91"> </span>Store allocation tag, zeroing</div><div class="t m0 xd h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">SUB{S}<span class="_ _1e"> </span>Subtract</div><div class="t m0 xd h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">SUBG<span class="_ _a6"> </span>Subtract with ta<span class="_ _0"></span>g</div><div class="t m0 xd h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">SUBP{S}<span class="_ _c2"> </span>Subtract pointer</div><div class="t m0 xd h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">SVC<span class="_ _94"> </span>Supervisor call</div><div class="t m0 xd h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">SWP<span class="_ _10"></span>,<span class="_ _1"></span> SWP<span class="_ _1"></span>A<span class="_ _46"> </span>Swa<span class="_ _0"></span>p word or doubleword in memory</div><div class="t m0 xd h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">SWP<span class="_ _1"></span>AL, SWPL<span class="_ _c6"> </span>Swap word or doubleword in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">SWPB,<span class="_ _1"></span> SWPAB<span class="_ _d1"> </span>Swap byte in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">SWP<span class="_ _1"></span>ALB, SWPLB<span class="_ _ca"> </span>Swap byte in memory</div><div class="t m0 xd h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">SWPH,<span class="_ _1"></span> SWPAH<span class="_ _d2"> </span>Swap halfword in memor<span class="_ _0"></span>y</div><div class="t m0 xd h10 y154b ffaf fs7 fc3 sc0 ls1 ws1">SWP<span class="_ _1"></span>ALH, SWPLH<span class="_ _d3"> </span>Swap halfword in memor<span class="_ _0"></span>y</div><div class="t m0 x75 h20 y15b8 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf18c" class="pf w2 h6" data-page-no="18c"><div class="pc pc18c w2 h6"><img class="bi xc y154a w7 h66" alt="" src="bg18c.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">385</div><div class="t m0 xc h10 y1519 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y151a ffaf fs7 fc3 sc0 ls1 ws1">SXTB†<span class="_ _b2"> </span>Signed extend byte</div><div class="t m0 xc h10 y151b ffaf fs7 fc3 sc0 ls1 ws1">SXTH†<span class="_ _b2"> </span>Sign extend halfword</div><div class="t m0 xc h10 y151c ffaf fs7 fc3 sc0 ls1 ws1">SXTW†<span class="_ _8d"> </span>Sign extend word</div><div class="t m0 xc h10 y151d ffaf fs7 fc3 sc0 ls1 ws1">SYS<span class="_ _94"> </span>System instruction</div><div class="t m0 xc h10 y151e ffaf fs7 fc3 sc0 ls1 ws1">SYSL<span class="_ _a1"> </span>System instruction with result</div><div class="t m0 xc h10 y151f ffaf fs7 fc3 sc0 ls1 ws1">TBNZ<span class="_ _88"> </span>T<span class="_ _6"></span>est bit and branch if nonzero</div><div class="t m0 xc h10 y1520 ffaf fs7 fc3 sc0 ls1 ws1">TBZ<span class="_ _a3"> </span>T<span class="_ _10"></span>est bit and branch if zero</div><div class="t m0 xc h10 y1521 ffaf fs7 fc3 sc0 ls1 ws1">TLBI†<span class="_ _7e"> </span>TLB invalidate opera<span class="_ _0"></span>tion</div><div class="t m0 xc h10 y1522 ffaf fs7 fc3 sc0 ls1 ws1">TSB CSYNC<span class="_ _42"> </span>T<span class="_ _6"></span>race synchronization barrier</div><div class="t m0 xc h10 y1523 ffaf fs7 fc3 sc0 ls1 ws1">TST†<span class="_ _a1"> </span>T<span class="_ _1"></span>est bits</div><div class="t m0 xc h10 y1524 ffaf fs7 fc3 sc0 ls1 ws1">UBFIZ†<span class="_ _8d"> </span>Unsigned bitfield insert in zero</div><div class="t m0 xc h10 y1525 ffaf fs7 fc3 sc0 ls1 ws1">UBFM<span class="_ _a0"> </span>Unsigned bitfield move</div><div class="t m0 xc h10 y1526 ffaf fs7 fc3 sc0 ls1 ws1">UBFX†<span class="_ _b2"> </span>Unsigned bitfield extract</div><div class="t m0 xc h10 y1527 ffaf fs7 fc3 sc0 ls1 ws1">UDF<span class="_ _9a"> </span>Permanently undefined</div><div class="t m0 xc h10 y1528 ffaf fs7 fc3 sc0 ls1 ws1">UDIV<span class="_ _c5"> </span>Unsigned divide</div><div class="t m0 xc h10 y1529 ffaf fs7 fc3 sc0 ls1 ws1">UMADDL<span class="_ _3c"> </span>Unsigned multiply-add long</div><div class="t m0 xc h10 y152a ffaf fs7 fc3 sc0 ls1 ws1">UMNEGL†<span class="_ _be"> </span>Unsigned multiply-negate long</div><div class="t m0 xc h10 y152b ffaf fs7 fc3 sc0 ls1 ws1">UMSUBL<span class="_ _bc"> </span>Unsigned multiply-subtract long</div><div class="t m0 xc h10 y152c ffaf fs7 fc3 sc0 ls1 ws1">UMULH<span class="_ _b7"> </span>Unsigned multiply high</div><div class="t m0 xc h10 y152d ffaf fs7 fc3 sc0 ls1 ws1">UMULL†<span class="_ _a7"> </span>Unsigned multiply long</div><div class="t m0 xc h10 y152e ffaf fs7 fc3 sc0 ls1 ws1">UXTB†<span class="_ _b2"> </span>Unsigned extend byte</div><div class="t m0 xc h10 y152f ffaf fs7 fc3 sc0 ls1 ws1">UXTH†<span class="_ _ae"> </span>Unsigned extend halfword</div><div class="t m0 xc h10 y154b ffaf fs7 fc3 sc0 ls1 ws1">WFE<span class="_ _7c"> </span>Wait for event</div><div class="t m0 x5 h20 y15b8 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y484 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf18d" class="pf w2 h6" data-page-no="18d"><div class="pc pc18d w2 h6"><img class="bi xd y15b9 w7 h6c" alt="" src="bg18d.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">386</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y1533 ffaf fs7 fc3 sc0 ls1 ws1">WFI<span class="_ _d4"> </span>Wait for interrupt</div><div class="t m0 xd h10 y1534 ffaf fs7 fc3 sc0 ls1 ws1">XAFlag<span class="_ _8f"> </span>Convert floating-point condition flags from external  </div><div class="t m0 x6c h10 y15ba ffaf fs7 fc3 sc0 ls1 ws1">format to <span class="_ _3"></span>ARM format</div><div class="t m0 xd h10 y15bb ffaf fs7 fc3 sc0 ls1 ws1">XP<span class="_ _1"></span>ACD, XP<span class="_ _1"></span>ACI<span class="_ _45"> </span>Strip pointer authentication code</div><div class="t m0 xd h10 y15bc ffaf fs7 fc3 sc0 ls1 ws1">XP<span class="_ _1"></span>ACLRI<span class="_ _d5"> </span>Strip pointer authentication code</div><div class="t m0 xd h10 y15bd ffaf fs7 fc3 sc0 ls1 ws1">YIELD<span class="_ _85"> </span>Yield</div><div class="t m0 xd h15 y15be ffae fsb fc3 sc0 ls1 ws1"> <span class="_ _e"></span>ARM 64-Bit NEON andFPU Instructions</div><div class="t m0 xd h10 y15bf ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y15c0 ffaf fs7 fc3 sc0 ls1 ws1">ABS<span class="_ _9a"> </span>Absolute value</div><div class="t m0 xd h10 y15c1 ffaf fs7 fc3 sc0 ls1 ws1">ADD<span class="_ _d6"> </span>Add</div><div class="t m0 xd h10 y15c2 ffaf fs7 fc3 sc0 ls1 wsa">ADDHN,<span class="_ _1"></span> ADDHN2<span class="_ _d3"> </span><span class="ws1">Add returning high narro<span class="_ _0"></span>w</span></div><div class="t m0 xd h10 y15c3 ffaf fs7 fc3 sc0 ls1 ws1">ADDP<span class="_ _a6"> </span>Add pair of elements</div><div class="t m0 xd h10 y15c4 ffaf fs7 fc3 sc0 ls1 ws1">ADDV<span class="_ _a6"> </span>Add across vector</div><div class="t m0 xd h10 y15c5 ffaf fs7 fc3 sc0 ls1 ws1">AESD<span class="_ _88"> </span>AES single round decryption</div><div class="t m0 xd h10 y15c6 ffaf fs7 fc3 sc0 ls1 ws1">AESE<span class="_ _a1"> </span>AES single round encryption</div><div class="t m0 xd h10 y15c7 ffaf fs7 fc3 sc0 ls1 ws1">AESIMC<span class="_ _c7"> </span>AES inverse mix columns</div><div class="t m0 xd h10 y15c8 ffaf fs7 fc3 sc0 ls1 ws1">AESMC<span class="_ _b7"> </span>AES mix columns</div><div class="t m0 xd h10 y15c9 ffaf fs7 fc3 sc0 ls1 ws1">AND<span class="_ _d6"> </span><span class="wsa">Bitwise AND</span></div><div class="t m0 xd h10 y15ca ffaf fs7 fc3 sc0 ls1 ws1">BCAX<span class="_ _88"> </span>Bit c<span class="_ _1"></span>lear and XOR</div><div class="t m0 xd h10 y15cb ffaf fs7 fc3 sc0 ls1 ws1">BIC<span class="_ _ab"> </span>Bitwise bit clear</div><div class="t m0 x75 h20 y15cc ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 yd28 ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf18e" class="pf w2 h6" data-page-no="18e"><div class="pc pc18e w2 h6"><img class="bi xc y15cd w7 h6d" alt="" src="bg18e.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">387</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">BIF<span class="_ _7d"> </span>Bitwise insert if false</div><div class="t m0 xc h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">BIT<span class="_ _aa"> </span>Bitwise insert if true</div><div class="t m0 xc h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">BSL<span class="_ _94"> </span>Bitwise select</div><div class="t m0 xc h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">CLS<span class="_ _94"> </span>Count leading sign bits</div><div class="t m0 xc h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">CLZ<span class="_ _a3"> </span>Count leading zero bits</div><div class="t m0 xc h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">CMEQ<span class="_ _92"> </span>Compare bitwise equal</div><div class="t m0 xc h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">CMGE<span class="_ _9f"> </span>Compare signed greater than or equal</div><div class="t m0 xc h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">CMGT<span class="_ _9f"> </span>Compare signed greater than</div><div class="t m0 xc h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">CMHI<span class="_ _91"> </span>Compare unsigned higher</div><div class="t m0 xc h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">CMHS<span class="_ _92"> </span>Compare unsigned higher or same</div><div class="t m0 xc h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">CMLE<span class="_ _85"> </span>Compare signed less than or equal to zero</div><div class="t m0 xc h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">CML<span class="_ _10"></span>T<span class="_ _88"> </span>Compare signed less than zero</div><div class="t m0 xc h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">CMTST<span class="_ _8d"> </span>Compare bitwise test bits nonzero</div><div class="t m0 xc h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">CNT<span class="_ _9a"> </span>Population count per byte</div><div class="t m0 xc h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">DUP<span class="_ _86"> </span>Duplica<span class="_ _0"></span>te vector element to vector or scalar</div><div class="t m0 xc h10 y15dd ffaf fs7 fc3 sc0 ls1 ws1">EOR<span class="_ _9a"> </span>Bitwise exclusive OR</div><div class="t m0 xc h10 y15de ffaf fs7 fc3 sc0 ls1 ws1">EOR3<span class="_ _88"> </span>Three-way exc<span class="_ _1"></span>lusive OR</div><div class="t m0 xc h10 y15df ffaf fs7 fc3 sc0 ls1 ws1">EXT<span class="_ _a3"> </span>Extract vector from pair of vectors</div><div class="t m0 xc h10 y15e0 ffaf fs7 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>ABD<span class="_ _91"> </span>Floating-point absolute difference</div><div class="t m0 xc h10 y15e1 ffaf fs7 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>ABS<span class="_ _a1"> </span>Floa<span class="_ _0"></span>ting-point absolute value</div><div class="t m0 xc h10 y15e2 ffaf fs7 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>ACGE<span class="_ _a2"> </span>Floa<span class="_ _0"></span>ting-point absolute compare greater than or equal</div><div class="t m0 xc h10 y15e3 ffaf fs7 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>ACGT<span class="_ _a2"> </span>Floa<span class="_ _0"></span>ting-point absolute compare greater than</div><div class="t m0 xc h10 y15e4 ffaf fs7 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>ADD<span class="_ _88"> </span>Floating-point add</div><div class="t m0 x5 h20 y15e5 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf18f" class="pf w2 h6" data-page-no="18f"><div class="pc pc18f w2 h6"><img class="bi xd y15e6 w7 h6e" alt="" src="bg18f.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">388</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">F<span class="_ _1"></span>ADDP<span class="_ _ae"> </span>Floa<span class="_ _0"></span>ting-point add pair of elements</div><div class="t m0 xd h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">FCADD<span class="_ _84"> </span>Floa<span class="_ _0"></span>ting-point complex add</div><div class="t m0 xd h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">FCCMP<span class="_ _8d"> </span>Floating-point conditional quiet compare</div><div class="t m0 xd h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">FCCMPE<span class="_ _a7"> </span>Floating-point conditional signaling compare</div><div class="t m0 xd h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">FCMEQ<span class="_ _b7"> </span>Floa<span class="_ _0"></span>ting-point compare equal</div><div class="t m0 xd h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">FCMGE<span class="_ _8d"> </span>Floating-point compare greater than or equal</div><div class="t m0 xd h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">FCMGT<span class="_ _8d"> </span>Floating-point compare greater than</div><div class="t m0 xd h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">FCMLA<span class="_ _1c"> </span>Floa<span class="_ _0"></span>ting-point complex multiply accumulate</div><div class="t m0 xd h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">FCMLE<span class="_ _84"> </span>Floa<span class="_ _0"></span>ting-point compare less than or equal to zero</div><div class="t m0 xd h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">FCML<span class="_ _10"></span>T<span class="_ _b2"> </span>Floating-point compare less than zero</div><div class="t m0 xd h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">FCMP<span class="_ _85"> </span>Floating-point quiet compare</div><div class="t m0 xd h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">FCMPE<span class="_ _1c"> </span>Floa<span class="_ _0"></span>ting-point signaling compare</div><div class="t m0 xd h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">FCSEL<span class="_ _ce"> </span>Floating-point conditional select</div><div class="t m0 xd h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">FCVT<span class="_ _2c"> </span>Floating-point convert precision</div><div class="t m0 xd h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">FCVT<span class="_ _1"></span>AS<span class="_ _d7"> </span>Floating-point convert to signed integer<span class="_ _6"></span>, rounding to </div><div class="t m0 x6c h10 y15e7 ffaf fs7 fc3 sc0 ls1 ws1">nearest</div><div class="t m0 xd h10 y15e8 ffaf fs7 fc3 sc0 ls1 ws1">FCVT<span class="_ _1"></span>AU<span class="_ _d7"> </span>Floating-point convert to unsigned integer<span class="_ _6"></span>,<span class="_ _1"></span> rounding to </div><div class="t m0 x6c h10 y15e9 ffaf fs7 fc3 sc0 ls1 ws1">nearest</div><div class="t m0 xd h10 y15ea ffaf fs7 fc3 sc0 ls1 ws1">FCVTL,<span class="_ _1"></span> FCVTL2<span class="_ _d8"> </span>Floating-point convert to higher precision long</div><div class="t m0 xd h10 y15eb ffaf fs7 fc3 sc0 ls1 ws1">FCVTMS<span class="_ _d5"> </span>Floating-point convert to signed integer<span class="_ _1"></span>,<span class="_ _1"></span> rounding toward </div><div class="t m0 x6c h10 y15ec ffaf fs7 fc3 sc0 ls1 ws1">minus infinity</div><div class="t m0 xd h10 y15ed ffaf fs7 fc3 sc0 ls1 ws1">FCVTMU<span class="_ _a7"> </span>Floa<span class="_ _0"></span>ting-point convert to unsigned integer<span class="_ _6"></span>,<span class="_ _1"></span> rounding </div><div class="t m0 x6c h10 y15ee ffaf fs7 fc3 sc0 ls1 ws1">toward minus infinity</div><div class="t m0 xd h10 y15ef ffaf fs7 fc3 sc0 ls1 ws1">FCVTN,<span class="_ _1"></span> FCVTN2<span class="_ _9d"> </span>Floa<span class="_ _0"></span>ting-point convert to lower precision narrow</div><div class="t m0 x75 h20 y15f0 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf190" class="pf w2 h6" data-page-no="190"><div class="pc pc190 w2 h6"><img class="bi xc y90f w7 h6f" alt="" src="bg190.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">389</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">FCVTNS<span class="_ _cf"> </span>Floating-point convert to signed integer<span class="_ _6"></span>,<span class="_ _1"></span> rounding to </div><div class="t m0 x76 h10 y15f1 ffaf fs7 fc3 sc0 ls1 ws1">nearest</div><div class="t m0 xc h10 y15f2 ffaf fs7 fc3 sc0 ls1 ws1">FCVTNU<span class="_ _55"> </span>Floating-point convert to unsigned integer<span class="_ _1"></span>,<span class="_ _1"></span> rounding to </div><div class="t m0 x76 h10 y15f3 ffaf fs7 fc3 sc0 ls1 ws1">nearest</div><div class="t m0 xc h10 y15f4 ffaf fs7 fc3 sc0 ls1 ws1">FCVTPS<span class="_ _c7"> </span><span class="ls37">Floa<span class="_ _0"></span>ting-point convert to signed integer<span class="_ _6"></span>,<span class="_ _1"></span> rounding </span></div><div class="t m0 x76 h10 y15f5 ffaf fs7 fc3 sc0 ls37 ws1">toward plus infinity</div><div class="t m0 xc h10 y15f6 ffaf fs7 fc3 sc0 ls1 ws1">FCVTPU<span class="_ _c7"> </span><span class="ls37">Floating-point convert to unsigned integer<span class="_ _6"></span>, rounding<span class="_ _1"></span> </span></div><div class="t m0 x76 h10 y15f7 ffaf fs7 fc3 sc0 ls37 ws1">toward plus infinity</div><div class="t m0 xc h10 y15f8 ffaf fs7 fc3 sc0 ls1 ws1">FCVTXN,<span class="_ _1"></span> FCVTXN2<span class="_ _ba"> </span><span class="ls12">Floating-point convert to lo<span class="_ _0"></span>wer precision narrow<span class="_ _1"></span>, rounding </span></div><div class="t m0 x76 h10 y15f9 ffaf fs7 fc3 sc0 ls12 ws1">to odd</div><div class="t m0 xc h10 y15fa ffaf fs7 fc3 sc0 ls1 ws1">FCVTZS<span class="_ _d7"> </span><span class="ls12">Floating-point convert to signed fixed point,<span class="_ _1"></span> rounding </span></div><div class="t m0 x76 h10 y15fb ffaf fs7 fc3 sc0 ls12 ws1">toward zero</div><div class="t m0 xc h10 y15fc ffaf fs7 fc3 sc0 ls1 ws1">FCVTZU<span class="_ _c7"> </span><span class="ls37">Floa<span class="_ _0"></span>ting-point convert to unsigned fixed point,<span class="_ _1"></span> rounding </span></div><div class="t m0 x76 h10 y15fd ffaf fs7 fc3 sc0 ls37 ws1">toward zero</div><div class="t m0 xc h10 y15fe ffaf fs7 fc3 sc0 ls1 ws1">FDIV<span class="_ _7c"> </span>Floating-point divide</div><div class="t m0 xc h10 y15ff ffaf fs7 fc3 sc0 ls1 ws1">FJCVTZS<span class="_ _3c"> </span>Floating-point Ja<span class="_ _0"></span>vaScript convert to signed fixed point</div><div class="t m0 xc h10 y1600 ffaf fs7 fc3 sc0 ls1 ws1">FMADD<span class="_ _1f"> </span>Floating-point fused multiply-add</div><div class="t m0 xc h10 y1601 ffaf fs7 fc3 sc0 ls1 ws1">FMAX<span class="_ _85"> </span>Floa<span class="_ _0"></span>ting-point maximum</div><div class="t m0 xc h10 y1602 ffaf fs7 fc3 sc0 ls1 ws1">FMAXNM<span class="_ _bb"> </span>Floating-point maximum number</div><div class="t m0 xc h10 y1603 ffaf fs7 fc3 sc0 ls1 ws1">FMAXNMP<span class="_ _58"> </span>Floating-point maximum number of pair of elements</div><div class="t m0 xc h10 y1604 ffaf fs7 fc3 sc0 ls1 ws1">FMAXNMV<span class="_ _58"> </span>Floating-point maximum number across vector</div><div class="t m0 xc h10 y1605 ffaf fs7 fc3 sc0 ls1 ws1">FMAXP<span class="_ _1c"> </span>Floa<span class="_ _0"></span>ting-point maximum of pair of elements</div><div class="t m0 xc h10 y1606 ffaf fs7 fc3 sc0 ls1 ws1">FMAXV<span class="_ _84"> </span>Floating-point maximum across vector</div><div class="t m0 xc h10 y1607 ffaf fs7 fc3 sc0 ls1 ws1">FMIN<span class="_ _a1"> </span>Floa<span class="_ _0"></span>ting-point minimum</div><div class="t m0 x5 h20 y1608 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf191" class="pf w2 h6" data-page-no="191"><div class="pc pc191 w2 h6"><img class="bi xd y1609 w7 h70" alt="" src="bg191.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">390</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">FMINNM<span class="_ _bc"> </span>Floa<span class="_ _0"></span>ting-point minimum number</div><div class="t m0 xd h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">FMINNMP<span class="_ _30"> </span>Floating-point minimum number of pair of elements</div><div class="t m0 xd h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">FMINNMV<span class="_ _30"> </span>Floa<span class="_ _0"></span>ting-point minimum number across vector</div><div class="t m0 xd h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">FMINP<span class="_ _ce"> </span>Floating-point minimum of pair of elements</div><div class="t m0 xd h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">FMINV<span class="_ _ce"> </span>Floating-point minimum across vector</div><div class="t m0 xd h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">FMLA<span class="_ _a6"> </span>Floating-point fused multiply-add to accumulator</div><div class="t m0 xd h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">FMLAL,<span class="_ _1"></span> FMLAL2<span class="_ _35"> </span>Floa<span class="_ _0"></span>ting-point fused multiply-add long to accumulator</div><div class="t m0 xd h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">FMLS<span class="_ _a6"> </span>Floating-point fused multiply-subtract from accumulator</div><div class="t m0 xd h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">FMLSL,<span class="_ _1"></span> FMLSL2<span class="_ _35"> </span>Floa<span class="_ _0"></span>ting-point fused multiply-subtract long from </div><div class="t m0 x6c h10 y160a ffaf fs7 fc3 sc0 ls1 ws1">accumulator</div><div class="t m0 xd h10 y160b ffaf fs7 fc3 sc0 ls1 ws1">FMOV<span class="_ _a0"> </span>Floa<span class="_ _0"></span>ting-point move to or from general-purpose register</div><div class="t m0 xd h10 y160c ffaf fs7 fc3 sc0 ls1 ws1">FMSUB<span class="_ _b7"> </span>Floa<span class="_ _0"></span>ting-point fused multiply-subtract</div><div class="t m0 xd h10 y160d ffaf fs7 fc3 sc0 ls1 ws1">FMUL<span class="_ _7e"> </span>Floating-point multiply</div><div class="t m0 xd h10 y160e ffaf fs7 fc3 sc0 ls1 ws1">FMULX<span class="_ _84"> </span>Floating-point multiply extended</div><div class="t m0 xd h10 y160f ffaf fs7 fc3 sc0 ls1 ws1">FNEG<span class="_ _88"> </span>Floating-point negate</div><div class="t m0 xd h10 y15e7 ffaf fs7 fc3 sc0 ls1 ws1">FNMADD<span class="_ _d9"> </span>Floating-point negated fused multiply-add</div><div class="t m0 xd h10 y15e8 ffaf fs7 fc3 sc0 ls1 ws1">FNMSUB<span class="_ _c3"> </span>Floa<span class="_ _0"></span>ting-point negated fused multiply-subtract</div><div class="t m0 xd h10 y1610 ffaf fs7 fc3 sc0 ls1 ws1">FNMUL<span class="_ _8d"> </span>Floating-point multiply-negate</div><div class="t m0 xd h10 y1611 ffaf fs7 fc3 sc0 ls1 ws1">FRECPE<span class="_ _c7"> </span>Floating-point reciprocal estimate</div><div class="t m0 xd h10 y1612 ffaf fs7 fc3 sc0 ls1 ws1">FRECPS<span class="_ _cf"> </span>Floating-point reciprocal step</div><div class="t m0 xd h10 y1613 ffaf fs7 fc3 sc0 ls1 ws1">FRECPX<span class="_ _cf"> </span>Floa<span class="_ _0"></span>ting-point reciprocal exponent</div><div class="t m0 xd h10 y1614 ffaf fs7 fc3 sc0 ls1 ws1">FRINT32X<span class="_ _37"> </span><span class="lse">Floating-point round to 32-bit integer<span class="_ _6"></span>,<span class="_ _1"></span> using current rounding<span class="_ _0"></span> </span></div><div class="t m0 x6c h10 y1615 ffaf fs7 fc3 sc0 lse wsb2">mode</div><div class="t m0 x75 h20 y1616 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf192" class="pf w2 h6" data-page-no="192"><div class="pc pc192 w2 h6"><img class="bi xc y1617 w7 h71" alt="" src="bg192.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">391</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">FRINT32Z<span class="_ _37"> </span>Floating-point round to 32-bit integer toward zero</div><div class="t m0 xc h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">FRINT64X<span class="_ _37"> </span>Floating-point round to 64-bit integer<span class="_ _6"></span>,<span class="_ _1"></span> using current </div><div class="t m0 x76 h10 y15f2 ffaf fs7 fc3 sc0 ls1 ws1">rounding mode</div><div class="t m0 xc h10 y1618 ffaf fs7 fc3 sc0 ls1 ws1">FRINT64Z<span class="_ _37"> </span>Floating-point round to 64-bit integer toward zero</div><div class="t m0 xc h10 y1619 ffaf fs7 fc3 sc0 ls1 ws1">FRINT<span class="_ _1"></span>A<span class="_ _8d"> </span><span class="lsd">Floa<span class="_ _0"></span>ting-point round to integral,<span class="_ _1"></span> to nearest with ties to away</span></div><div class="t m0 xc h10 y161a ffaf fs7 fc3 sc0 ls1 ws1">FRINTI<span class="_ _ce"> </span>Floating-point round to integral,<span class="_ _1"></span> using current rounding </div><div class="t m0 x76 h10 y161b ffaf fs7 fc3 sc0 ls1 ws1">mode</div><div class="t m0 xc h10 y161c ffaf fs7 fc3 sc0 ls1 ws1">FRINTM<span class="_ _c7"> </span>Floating-point round to integral,<span class="_ _1"></span> to<span class="_ _0"></span>ward minus infinity</div><div class="t m0 xc h10 y161d ffaf fs7 fc3 sc0 ls1 ws1">FRINTN<span class="_ _1f"> </span><span class="lsc">Floating-point round to integral, to nearest with ties to even</span></div><div class="t m0 xc h10 y161e ffaf fs7 fc3 sc0 ls1 ws1">FRINTP<span class="_ _8d"> </span>Floating-point round to integral,<span class="_ _1"></span> toward plus infinity</div><div class="t m0 xc h10 y161f ffaf fs7 fc3 sc0 ls1 ws1">FRINTX<span class="_ _8d"> </span><span class="ls3a">Floating-point round to integral exact,<span class="_ _1"></span> using current </span></div><div class="t m0 x76 h10 y1620 ffaf fs7 fc3 sc0 ls3a ws1">rounding mode</div><div class="t m0 xc h10 y1621 ffaf fs7 fc3 sc0 ls1 ws1">FRINTZ<span class="_ _8d"> </span>Floating-point round to integral,<span class="_ _3"></span> toward zero</div><div class="t m0 xc h10 y1622 ffaf fs7 fc3 sc0 ls1 ws1">FRSQRTE<span class="_ _b4"> </span>Floating-point reciprocal square root estimate</div><div class="t m0 xc h10 y1623 ffaf fs7 fc3 sc0 ls1 ws1">FRSQRTS<span class="_ _a5"> </span>Floa<span class="_ _0"></span>ting-point reciprocal square root step</div><div class="t m0 xc h10 y1624 ffaf fs7 fc3 sc0 ls1 ws1">FSQRT<span class="_ _ae"> </span>Floa<span class="_ _0"></span>ting-point square root</div><div class="t m0 xc h10 y1625 ffaf fs7 fc3 sc0 ls1 ws1">FSUB<span class="_ _88"> </span>Floa<span class="_ _0"></span>ting-point subtract</div><div class="t m0 xc h10 y1626 ffaf fs7 fc3 sc0 ls1 ws1">INS<span class="_ _ab"> </span>Insert vector element from another vector element</div><div class="t m0 xc h10 y1627 ffaf fs7 fc3 sc0 ls1 ws1">LD1<span class="_ _94"> </span>Load multiple single-element structures to one,<span class="_ _1"></span> two, three,<span class="_ _1"></span> </div><div class="t m0 x76 h10 y1628 ffaf fs7 fc3 sc0 ls1 ws1">or four registers</div><div class="t m0 xc h10 y1629 ffaf fs7 fc3 sc0 ls1 ws1">LD1R<span class="_ _88"> </span><span class="ls12">Load one single-element structure and replicate to all lanes</span></div><div class="t m0 xc h10 y162a ffaf fs7 fc3 sc0 ls1 ws1">LD2<span class="_ _94"> </span>Load multiple 2-element structures to two registers</div><div class="t m0 xc h10 y15ee ffaf fs7 fc3 sc0 ls1 ws1">LD2R<span class="_ _88"> </span>Load single 2-element structure and replicate to all lanes </div><div class="t m0 x76 h10 y162b ffaf fs7 fc3 sc0 ls1 ws1">of two registers</div><div class="t m0 x5 h20 y162c ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf193" class="pf w2 h6" data-page-no="193"><div class="pc pc193 w2 h6"><img class="bi xd y13d1 w7 h72" alt="" src="bg193.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">392</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">LD3<span class="_ _94"> </span>Load multiple 3-element structures to three registers</div><div class="t m0 xd h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">LD3R<span class="_ _88"> </span>Load single 3-element structure and replicate to all lanes </div><div class="t m0 x6c h10 y15f2 ffaf fs7 fc3 sc0 ls1 ws1">of three registers</div><div class="t m0 xd h10 y1618 ffaf fs7 fc3 sc0 ls1 ws1">LD4<span class="_ _94"> </span>Load multiple 4-element structures to four registers</div><div class="t m0 xd h10 y1619 ffaf fs7 fc3 sc0 ls1 ws1">LD4R<span class="_ _88"> </span>Load single 4-element structure and replicate to all lanes </div><div class="t m0 x6c h10 y162d ffaf fs7 fc3 sc0 ls1 ws1">of four registers</div><div class="t m0 xd h10 y161b ffaf fs7 fc3 sc0 ls1 ws1">LDNP<span class="_ _87"> </span>Load pair of SIMD&amp;FP registers, with non-temporal hint</div><div class="t m0 xd h10 y161c ffaf fs7 fc3 sc0 ls1 ws1">LDP<span class="_ _94"> </span>Load pair of SIMD&amp;FP registers</div><div class="t m0 xd h10 y161d ffaf fs7 fc3 sc0 ls1 ws1">LDR<span class="_ _9a"> </span>Load SIMD&amp;FP register</div><div class="t m0 xd h10 y161e ffaf fs7 fc3 sc0 ls1 ws1">LDUR<span class="_ _87"> </span>Load SIMD&amp;FP register</div><div class="t m0 xd h10 y161f ffaf fs7 fc3 sc0 ls1 ws1">MLA<span class="_ _7c"> </span>Multiply-add to accumulator</div><div class="t m0 xd h10 y162e ffaf fs7 fc3 sc0 ls1 ws1">MLS<span class="_ _7c"> </span>Multiply-subtract from accumulator</div><div class="t m0 xd h10 y162f ffaf fs7 fc3 sc0 ls1 ws1">MOV†<span class="_ _9f"> </span>Move vector element to another vector element</div><div class="t m0 xd h10 y1630 ffaf fs7 fc3 sc0 ls1 ws1">MOVI<span class="_ _a1"> </span>Move immediate</div><div class="t m0 xd h10 y1631 ffaf fs7 fc3 sc0 ls1 ws1">MUL<span class="_ _7c"> </span>Multiply</div><div class="t m0 xd h10 y1632 ffaf fs7 fc3 sc0 ls1 ws1">MVN†<span class="_ _9f"> </span>Bitwise NOT</div><div class="t m0 xd h10 y1633 ffaf fs7 fc3 sc0 ls1 ws1">MVNI<span class="_ _a1"> </span>Move inverted immediate</div><div class="t m0 xd h10 y15e9 ffaf fs7 fc3 sc0 ls1 ws1">NEG<span class="_ _86"> </span>Nega<span class="_ _0"></span>te</div><div class="t m0 xd h10 y15ea ffaf fs7 fc3 sc0 ls1 ws1">NOT<span class="_ _86"> </span>Bitwise NOT</div><div class="t m0 xd h10 y15eb ffaf fs7 fc3 sc0 ls1 ws1">ORN<span class="_ _7c"> </span>Bitwise inclusive OR NOT</div><div class="t m0 xd h10 y1634 ffaf fs7 fc3 sc0 ls1 ws1">ORR<span class="_ _d6"> </span>Bitwise inclusive OR</div><div class="t m0 xd h10 y1635 ffaf fs7 fc3 sc0 ls1 ws1">PMUL<span class="_ _85"> </span>Polynomial multiply</div><div class="t m0 xd h10 y1615 ffaf fs7 fc3 sc0 ls1 ws1">PMULL,<span class="_ _1"></span> PMULL2<span class="_ _8c"> </span>Polynomial multiply long</div><div class="t m0 x75 h20 y1636 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf194" class="pf w2 h6" data-page-no="194"><div class="pc pc194 w2 h6"><img class="bi xc y154a w7 h66" alt="" src="bg194.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">393</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">RADDHN<span class="_ _da"> </span>Rounding add returning high narrow</div><div class="t m0 xc h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">RADDHN2<span class="_ _be"> </span>Rounding add returning high narrow</div><div class="t m0 xc h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">RAX1<span class="_ _88"> </span>Rota<span class="_ _0"></span>te and exc<span class="_ _3"></span>lusive OR</div><div class="t m0 xc h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">RBIT<span class="_ _c5"> </span>Reverse bit order</div><div class="t m0 xc h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">REV16<span class="_ _a2"> </span>Reverse elements in 16-bit halfwords</div><div class="t m0 xc h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">REV32<span class="_ _a2"> </span>Reverse elements in 32-bit words</div><div class="t m0 xc h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">REV64<span class="_ _a2"> </span>Reverse elements in 64-bit doublewords</div><div class="t m0 xc h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">RSHRN,<span class="_ _1"></span> RSHRN2<span class="_ _a8"> </span>Rounding shift right narrow</div><div class="t m0 xc h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">RSUBHN,<span class="_ _1"></span> RSUBHN2<span class="_ _5f"> </span>Rounding subtract returning high narrow</div><div class="t m0 xc h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">SABA<span class="_ _88"> </span>Signed absolute difference and accumulate</div><div class="t m0 xc h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">SABAL,<span class="_ _1"></span> SABAL2<span class="_ _95"> </span>Signed absolute difference and accumula<span class="_ _0"></span>te long</div><div class="t m0 xc h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">SABD<span class="_ _a6"> </span>Signed absolute difference</div><div class="t m0 xc h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">SABDL,<span class="_ _1"></span> SABDL2<span class="_ _8b"> </span>Signed absolute difference long</div><div class="t m0 xc h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">SADALP<span class="_ _55"> </span>Signed add and accumulate long pairwise</div><div class="t m0 xc h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">SADDL,<span class="_ _1"></span> SADDL2<span class="_ _33"> </span>Signed add long</div><div class="t m0 xc h10 y15dd ffaf fs7 fc3 sc0 ls1 ws1">SADDLP<span class="_ _c2"> </span>Signed add long pairwise</div><div class="t m0 xc h10 y15de ffaf fs7 fc3 sc0 ls1 ws1">SADDL<span class="_ _6"></span>V<span class="_ _cf"> </span>Signed add long across vector</div><div class="t m0 xc h10 y15df ffaf fs7 fc3 sc0 ls1 ws1">SADDW<span class="_ _6"></span>,<span class="_ _3"></span> SADDW2<span class="_ _5a"> </span>Signed add wide</div><div class="t m0 xc h10 y15e0 ffaf fs7 fc3 sc0 ls1 ws1">SCVTF<span class="_ _ce"> </span>Signed fixed point convert to floating point</div><div class="t m0 xc h10 y15e1 ffaf fs7 fc3 sc0 ls1 ws1">SDOT<span class="_ _a6"> </span>Dot product signed arithmetic</div><div class="t m0 xc h10 y15e2 ffaf fs7 fc3 sc0 ls1 ws1">SHA1C<span class="_ _8f"> </span>SHA1 hash update (choose)</div><div class="t m0 xc h10 y15e3 ffaf fs7 fc3 sc0 ls1 ws1">SHA1H<span class="_ _1e"> </span>SHA1 fixed rota<span class="_ _0"></span>te</div><div class="t m0 xc h10 y15e4 ffaf fs7 fc3 sc0 ls1 ws1">SHA1M<span class="_ _b7"> </span>SHA1 hash update (majority)</div><div class="t m0 x5 h20 y1637 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf195" class="pf w2 h6" data-page-no="195"><div class="pc pc195 w2 h6"><img class="bi xd y154a w7 h66" alt="" src="bg195.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">394</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">SHA1P<span class="_ _ae"> </span>SHA1 hash update (parity)</div><div class="t m0 xd h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">SHA1SU0<span class="_ _a5"> </span>SHA1 schedule update 0</div><div class="t m0 xd h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">SHA1SU1<span class="_ _a5"> </span>SHA1 schedule update 1</div><div class="t m0 xd h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">SHA256H<span class="_ _a5"> </span>SHA256 hash update (part 1)</div><div class="t m0 xd h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">SHA256H2<span class="_ _b5"> </span>SHA256 hash update (part 2)</div><div class="t m0 xd h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">SHA256SU0<span class="_ _db"> </span>SHA256 schedule update 0</div><div class="t m0 xd h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">SHA256SU1<span class="_ _db"> </span>SHA256 schedule update 1</div><div class="t m0 xd h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">SHA512H<span class="_ _a5"> </span>SHA512 hash update part 1</div><div class="t m0 xd h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">SHA512H2<span class="_ _b5"> </span>SHA512 hash update part 2</div><div class="t m0 xd h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">SHA512SU0<span class="_ _db"> </span>SHA512 schedule update 0</div><div class="t m0 xd h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">SHA512SU1<span class="_ _db"> </span>SHA512 schedule update 1</div><div class="t m0 xd h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">SHADD<span class="_ _8d"> </span>Signed halving add</div><div class="t m0 xd h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">SHL<span class="_ _94"> </span>Shift left</div><div class="t m0 xd h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">SHLL,<span class="_ _1"></span> SHLL2<span class="_ _3b"> </span>Shift left long</div><div class="t m0 xd h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">SHRN,<span class="_ _1"></span> SHRN2<span class="_ _6e"> </span>Shift right narrow</div><div class="t m0 xd h10 y15dd ffaf fs7 fc3 sc0 ls1 ws1">SHSUB<span class="_ _84"> </span>Signed halving subtract</div><div class="t m0 xd h10 y15de ffaf fs7 fc3 sc0 ls1 ws1">SLI<span class="_ _dc"> </span>Shift left and insert</div><div class="t m0 xd h10 y15df ffaf fs7 fc3 sc0 ls1 ws1">SM4E<span class="_ _85"> </span>SM4 encode</div><div class="t m0 xd h10 y15e0 ffaf fs7 fc3 sc0 ls1 ws1">SM4EKEY<span class="_ _3e"> </span>SM4 key</div><div class="t m0 xd h10 y15e1 ffaf fs7 fc3 sc0 ls1 ws1">SMAX<span class="_ _a0"> </span>Signed maximum</div><div class="t m0 xd h10 y15e2 ffaf fs7 fc3 sc0 ls1 ws1">SMAXP<span class="_ _8d"> </span>Signed maximum pairwise</div><div class="t m0 xd h10 y15e3 ffaf fs7 fc3 sc0 ls1 ws1">SMAXV<span class="_ _8d"> </span>Signed maximum across vector</div><div class="t m0 xd h10 y15e4 ffaf fs7 fc3 sc0 ls1 ws1">SMIN<span class="_ _91"> </span>Signed minimum</div><div class="t m0 x75 h20 y1638 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf196" class="pf w2 h6" data-page-no="196"><div class="pc pc196 w2 h6"><img class="bi xc y156c w7 h69" alt="" src="bg196.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">395</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">SMINP<span class="_ _b2"> </span>Signed minimum pairwise</div><div class="t m0 xc h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">SMINV<span class="_ _a2"> </span>Signed minimum across vector</div><div class="t m0 xc h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">SMLAL,<span class="_ _1"></span> SMLAL2<span class="_ _8c"> </span>Signed multiply-add long</div><div class="t m0 xc h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">SMLSL,<span class="_ _1"></span> SMLSL2<span class="_ _8c"> </span>Signed multiply-subtract long</div><div class="t m0 xc h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">SMOV<span class="_ _9f"> </span>Signed move vector element to general-purpose register</div><div class="t m0 xc h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">SMULL,<span class="_ _1"></span> SMULL2<span class="_ _8e"> </span>Signed multiply long</div><div class="t m0 xc h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">SQABS<span class="_ _84"> </span>Signed sa<span class="_ _0"></span>turating absolute value</div><div class="t m0 xc h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">SQADD<span class="_ _8d"> </span>Signed saturating add</div><div class="t m0 xc h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">SQDMLAL<span class="_ _be"> </span>Signed saturating doubling multiply-add long</div><div class="t m0 xc h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">SQDMLAL2<span class="_ _46"> </span>Signed satura<span class="_ _0"></span>ting doubling multiply-add long</div><div class="t m0 xc h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">SQDMLSL<span class="_ _be"> </span>Signed saturating doubling multiply-subtract long</div><div class="t m0 xc h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">SQDMLSL2<span class="_ _46"> </span>Signed satura<span class="_ _0"></span>ting doubling multiply-subtract long</div><div class="t m0 xc h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">SQDMULH<span class="_ _56"> </span>Signed satura<span class="_ _0"></span>ting doubling multiply returning high half</div><div class="t m0 xc h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">SQDMULL<span class="_ _be"> </span>Signed saturating doubling multiply long</div><div class="t m0 xc h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">SQDMULL2<span class="_ _46"> </span>Signed saturating doubling multiply long</div><div class="t m0 xc h10 y15dd ffaf fs7 fc3 sc0 ls1 ws1">SQNEG<span class="_ _1c"> </span>Signed sa<span class="_ _0"></span>turating negate</div><div class="t m0 xc h10 y15de ffaf fs7 fc3 sc0 ls1 ws1">SQRDMLAH<span class="_ _83"> </span>Signed saturating rounding doubling multiply accumula<span class="_ _0"></span>te</div><div class="t m0 xc h10 y15df ffaf fs7 fc3 sc0 ls1 ws1">SQRDMLSH<span class="_ _83"> </span>Signed saturating rounding doubling multiply subtract </div><div class="t m0 x76 h10 y1611 ffaf fs7 fc3 sc0 ls1 ws1">returning high half</div><div class="t m0 xc h10 y1612 ffaf fs7 fc3 sc0 ls1 ws1">SQRDMULH<span class="_ _dd"> </span>Signed saturating rounding doubling multiply returning </div><div class="t m0 x76 h10 y1634 ffaf fs7 fc3 sc0 ls1 ws1">high half</div><div class="t m0 xc h10 y1635 ffaf fs7 fc3 sc0 ls1 ws1">SQRSHL<span class="_ _c2"> </span>Signed saturating rounding shift left</div><div class="t m0 xc h10 y1615 ffaf fs7 fc3 sc0 ls1 ws1">SQRSHRN<span class="_ _be"> </span>Signed sa<span class="_ _0"></span>turating rounded shift right narrow</div><div class="t m0 x5 h20 y1639 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf197" class="pf w2 h6" data-page-no="197"><div class="pc pc197 w2 h6"><img class="bi xd y163a w7 h73" alt="" src="bg197.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">396</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">SQRSHRN2<span class="_ _46"> </span>Signed sa<span class="_ _0"></span>turating rounded shift right narrow</div><div class="t m0 xd h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">SQRSHRUN<span class="_ _46"> </span>Signed saturating rounded shift right unsigned narrow</div><div class="t m0 xd h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">SQRSHRUN2<span class="_ _bf"> </span>Signed saturating rounded shift right unsigned narrow</div><div class="t m0 xd h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">SQSHL<span class="_ _8f"> </span>Signed saturating shift left</div><div class="t m0 xd h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">SQSHLU<span class="_ _c2"> </span>Signed saturating shift left unsigned</div><div class="t m0 xd h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">SQSHRN,<span class="_ _1"></span> SQSHRN2<span class="_ _5e"> </span>Signed saturating shift right narrow</div><div class="t m0 xd h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">SQSHRUN<span class="_ _be"> </span>Signed sa<span class="_ _0"></span>turating shift right unsigned narrow</div><div class="t m0 xd h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">SQSHRUN2<span class="_ _46"> </span>Signed sa<span class="_ _0"></span>turating shift right unsigned narrow</div><div class="t m0 xd h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">SQSUB<span class="_ _84"> </span>Signed saturating subtract</div><div class="t m0 xd h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">SQXTN,<span class="_ _1"></span> SQXTN2<span class="_ _33"> </span>Signed sa<span class="_ _0"></span>turating extract narrow</div><div class="t m0 xd h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">SQXTUN,<span class="_ _1"></span> SQXTUN2<span class="_ _b6"> </span>Signed sa<span class="_ _0"></span>turating extract unsigned narrow</div><div class="t m0 xd h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">SRHADD<span class="_ _bc"> </span>Signed rounding halving add</div><div class="t m0 xd h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">SRI<span class="_ _a9"> </span>Shift right and insert</div><div class="t m0 xd h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">SRSHL<span class="_ _ae"> </span>Signed rounding shift left</div><div class="t m0 xd h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">SRSHR<span class="_ _84"> </span>Signed rounding shift right</div><div class="t m0 xd h10 y15dd ffaf fs7 fc3 sc0 ls1 ws1">SRSRA<span class="_ _8f"> </span>Signed rounding shift right and accumulate</div><div class="t m0 xd h10 y15de ffaf fs7 fc3 sc0 ls1 ws1">SSHL<span class="_ _88"> </span>Signed shift left</div><div class="t m0 xd h10 y15df ffaf fs7 fc3 sc0 ls1 ws1">SSHLL,<span class="_ _1"></span> SSHLL2<span class="_ _de"> </span>Signed shift left long</div><div class="t m0 xd h10 y15e0 ffaf fs7 fc3 sc0 ls1 ws1">SSHR<span class="_ _87"> </span>Signed shift right</div><div class="t m0 xd h10 y15e1 ffaf fs7 fc3 sc0 ls1 ws1">SSRA<span class="_ _88"> </span>Signed shift right and accumulate</div><div class="t m0 xd h10 y15e2 ffaf fs7 fc3 sc0 ls1 ws1">SSUBL,<span class="_ _1"></span> SSUBL2<span class="_ _96"> </span>Signed subtract long</div><div class="t m0 xd h10 y15e3 ffaf fs7 fc3 sc0 ls1 ws1">SSUBW<span class="_ _6"></span>,<span class="_ _3"></span> SSUBW2<span class="_ _cd"> </span>Signed subtract wide</div><div class="t m0 x75 h20 y163b ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf198" class="pf w2 h6" data-page-no="198"><div class="pc pc198 w2 h6"><img class="bi xc y15b9 w7 h6c" alt="" src="bg198.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">397</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">ST1<span class="_ _a3"> </span>Store multiple single-element structures from one to four </div><div class="t m0 x76 h10 y15f1 ffaf fs7 fc3 sc0 ls1 ws1">registers</div><div class="t m0 xc h10 y15f2 ffaf fs7 fc3 sc0 ls1 ws1">ST2<span class="_ _a3"> </span>Store multiple 2-element structures from two registers</div><div class="t m0 xc h10 y1618 ffaf fs7 fc3 sc0 ls1 ws1">ST3<span class="_ _a3"> </span>Store multiple 3-element structures from three registers</div><div class="t m0 xc h10 y1619 ffaf fs7 fc3 sc0 ls1 ws1">ST4<span class="_ _a3"> </span>Store multiple 4-element structures from four registers</div><div class="t m0 xc h10 y161a ffaf fs7 fc3 sc0 ls1 ws1">STNP<span class="_ _88"> </span>Store pair of SIMD&amp;FP registers,<span class="_ _1"></span> with non-temporal hint</div><div class="t m0 xc h10 y163c ffaf fs7 fc3 sc0 ls1 ws1">STP<span class="_ _a3"> </span>Store pair of SIMD&amp;FP registers</div><div class="t m0 xc h10 y163d ffaf fs7 fc3 sc0 ls1 ws1">STR<span class="_ _94"> </span>Store SIMD&amp;FP register</div><div class="t m0 xc h10 y163e ffaf fs7 fc3 sc0 ls1 ws1">STUR<span class="_ _88"> </span>Store SIMD&amp;FP register (unscaled offset)</div><div class="t m0 xc h10 y160a ffaf fs7 fc3 sc0 ls1 ws1">SUB<span class="_ _9a"> </span>Subtract</div><div class="t m0 xc h10 y160b ffaf fs7 fc3 sc0 ls1 ws1">SUBHN,<span class="_ _1"></span> SUBHN2<span class="_ _a8"> </span>Subtract returning high narrow</div><div class="t m0 xc h10 y160c ffaf fs7 fc3 sc0 ls1 ws1">SUQADD<span class="_ _bc"> </span>Signed saturating accumula<span class="_ _0"></span>te of unsigned value</div><div class="t m0 xc h10 y160d ffaf fs7 fc3 sc0 ls1 ws1">SXTL,<span class="_ _1"></span> SXTL2†<span class="_ _df"> </span>Signed extend long</div><div class="t m0 xc h10 y160e ffaf fs7 fc3 sc0 ls1 ws1">TBL<span class="_ _a3"> </span>T<span class="_ _6"></span>able vector lookup</div><div class="t m0 xc h10 y160f ffaf fs7 fc3 sc0 ls1 ws1">TBX<span class="_ _94"> </span>T<span class="_ _1"></span>able vector lookup extension</div><div class="t m0 xc h10 y15e7 ffaf fs7 fc3 sc0 ls1 ws1">TRN1<span class="_ _88"> </span>T<span class="_ _10"></span>ranspose vectors (primar<span class="_ _0"></span>y)</div><div class="t m0 xc h10 y15e8 ffaf fs7 fc3 sc0 ls1 ws1">TRN2<span class="_ _88"> </span>T<span class="_ _10"></span>ranspose vectors (secondar<span class="_ _0"></span>y)</div><div class="t m0 xc h10 y1610 ffaf fs7 fc3 sc0 ls1 ws1">UABA<span class="_ _87"> </span>Unsigned absolute difference and accumula<span class="_ _0"></span>te</div><div class="t m0 xc h10 y1611 ffaf fs7 fc3 sc0 ls1 ws1">UABAL,<span class="_ _1"></span> UABAL2<span class="_ _96"> </span>Unsigned absolute difference and accumula<span class="_ _0"></span>te long</div><div class="t m0 xc h10 y1612 ffaf fs7 fc3 sc0 ls1 ws1">UABD<span class="_ _a6"> </span>Unsigned absolute difference</div><div class="t m0 xc h10 y1613 ffaf fs7 fc3 sc0 ls1 ws1">UABDL,<span class="_ _1"></span> UABDL2<span class="_ _35"> </span>Unsigned absolute difference long</div><div class="t m0 xc h10 y1614 ffaf fs7 fc3 sc0 ls1 ws1">UADALP<span class="_ _af"> </span>Unsigned add and accumula<span class="_ _0"></span>te long pairwise</div><div class="t m0 xc h10 y163f ffaf fs7 fc3 sc0 ls1 ws1">UADDL,<span class="_ _1"></span> UADDL2<span class="_ _33"> </span>Unsigned add long</div><div class="t m0 x5 h20 y1640 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf199" class="pf w2 h6" data-page-no="199"><div class="pc pc199 w2 h6"><img class="bi xd y1641 w7 h74" alt="" src="bg199.png"/><div class="t m0 xd hd y3f ffaa fs7 fc3 sc0 ls1 ws1">398</div><div class="t m0 xd h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xd h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">UADDLP<span class="_ _c2"> </span>Unsigned add long pairwise</div><div class="t m0 xd h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">UADDL<span class="_ _6"></span>V<span class="_ _55"> </span>Unsigned sum long across vector</div><div class="t m0 xd h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">UADDW<span class="_ _6"></span>,<span class="_ _3"></span> UADDW2<span class="_ _6c"> </span>Unsigned add wide</div><div class="t m0 xd h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">UCVTF<span class="_ _a2"> </span>Unsigned fixed point convert to floa<span class="_ _0"></span>ting point</div><div class="t m0 xd h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">UDOT<span class="_ _a6"> </span>Dot product unsigned arithmetic</div><div class="t m0 xd h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">UHADD<span class="_ _8d"> </span>Unsigned halving add</div><div class="t m0 xd h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">UHSUB<span class="_ _84"> </span>Unsigned halving subtract</div><div class="t m0 xd h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">UMAX<span class="_ _9f"> </span>Unsigned maximum</div><div class="t m0 xd h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">UMAXP<span class="_ _b7"> </span>Unsigned maximum pairwise</div><div class="t m0 xd h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">UMAXV<span class="_ _8d"> </span>Unsigned maximum across vector</div><div class="t m0 xd h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">UMIN<span class="_ _88"> </span>Unsigned minimum</div><div class="t m0 xd h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">UMINP<span class="_ _b2"> </span>Unsigned minimum pairwise</div><div class="t m0 xd h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">UMINV<span class="_ _b2"> </span>Unsigned minimum across vector</div><div class="t m0 xd h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">UMLAL,<span class="_ _1"></span> UMLAL2<span class="_ _8e"> </span>Unsigned multiply-add long</div><div class="t m0 xd h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">UMLSL,<span class="_ _1"></span> UMLSL2<span class="_ _8e"> </span>Unsigned multiply-subtract long</div><div class="t m0 xd h10 y15dd ffaf fs7 fc3 sc0 ls1 ws1">UMOV<span class="_ _92"> </span><span class="ls14">Unsigned move vector element to general-purpose register</span></div><div class="t m0 xd h10 y15de ffaf fs7 fc3 sc0 ls1 ws1">UMULL,<span class="_ _1"></span> UMULL2<span class="_ _a8"> </span>Unsigned multiply long</div><div class="t m0 xd h10 y15df ffaf fs7 fc3 sc0 ls1 ws1">UQADD<span class="_ _b7"> </span>Unsigned sa<span class="_ _0"></span>turating add</div><div class="t m0 xd h10 y15e0 ffaf fs7 fc3 sc0 ls1 ws1">UQRSHL<span class="_ _d5"> </span>Unsigned sa<span class="_ _0"></span>turating rounding shift left</div><div class="t m0 xd h10 y15e1 ffaf fs7 fc3 sc0 ls1 ws1">UQRSHRN<span class="_ _be"> </span>Unsigned saturating rounded shift right narro<span class="_ _0"></span>w</div><div class="t m0 xd h10 y15e2 ffaf fs7 fc3 sc0 ls1 ws1">UQRSHRN2<span class="_ _46"> </span>Unsigned satura<span class="_ _0"></span>ting rounded shift right narrow</div><div class="t m0 xd h10 y15e3 ffaf fs7 fc3 sc0 ls1 ws1">UQSHL<span class="_ _1e"> </span>Unsigned sa<span class="_ _0"></span>turating shift left</div><div class="t m0 xd h10 y15e4 ffaf fs7 fc3 sc0 ls1 ws1">UQSHRN<span class="_ _bc"> </span>Unsigned saturating shift right narro<span class="_ _0"></span>w</div><div class="t m0 x75 h20 y1642 ffaa fs3 fc3 sc0 ls1 ws1">(<span class="ffab">continued</span>)</div><div class="t m0 xd h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf19a" class="pf w2 h6" data-page-no="19a"><div class="pc pc19a w2 h6"><img class="bi xc y1643 w7 h75" alt="" src="bg19a.png"/><div class="t m0 x17 hd y3f ffaa fs7 fc3 sc0 ls1 ws1">399</div><div class="t m0 xc h10 y1532 ffae fs7 fc3 sc0 ls1 ws1">Instruction<span class="_ _83"> </span>Description</div><div class="t m0 xc h10 y15ce ffaf fs7 fc3 sc0 ls1 ws1">UQSHRN2<span class="_ _57"> </span>Unsigned satura<span class="_ _0"></span>ting shift right narrow</div><div class="t m0 xc h10 y15cf ffaf fs7 fc3 sc0 ls1 ws1">UQSUB<span class="_ _1c"> </span>Unsigned satura<span class="_ _0"></span>ting subtract</div><div class="t m0 xc h10 y15d0 ffaf fs7 fc3 sc0 ls1 ws1">UQXTN,<span class="_ _1"></span> UQXTN2<span class="_ _33"> </span>Unsigned saturating extract narrow</div><div class="t m0 xc h10 y15d1 ffaf fs7 fc3 sc0 ls1 ws1">URECPE<span class="_ _55"> </span>Unsigned reciprocal estimate</div><div class="t m0 xc h10 y15d2 ffaf fs7 fc3 sc0 ls1 ws1">URHADD<span class="_ _bc"> </span>Unsigned rounding halving add</div><div class="t m0 xc h10 y15d3 ffaf fs7 fc3 sc0 ls1 ws1">URSHL<span class="_ _8f"> </span>Unsigned rounding shift left</div><div class="t m0 xc h10 y15d4 ffaf fs7 fc3 sc0 ls1 ws1">URSHR<span class="_ _84"> </span>Unsigned rounding shift right</div><div class="t m0 xc h10 y15d5 ffaf fs7 fc3 sc0 ls1 ws1">URSQRTE<span class="_ _3e"> </span>Unsigned reciprocal square root estima<span class="_ _0"></span>te</div><div class="t m0 xc h10 y15d6 ffaf fs7 fc3 sc0 ls1 ws1">URSRA<span class="_ _1e"> </span>Unsigned rounding shift right and accumulate</div><div class="t m0 xc h10 y15d7 ffaf fs7 fc3 sc0 ls1 ws1">USHL<span class="_ _88"> </span>Unsigned shift left</div><div class="t m0 xc h10 y15d8 ffaf fs7 fc3 sc0 ls1 ws1">USHLL,<span class="_ _1"></span> USHLL2<span class="_ _9d"> </span>Unsigned shift left long</div><div class="t m0 xc h10 y15d9 ffaf fs7 fc3 sc0 ls1 ws1">USHR<span class="_ _a6"> </span>Unsigned shift right</div><div class="t m0 xc h10 y15da ffaf fs7 fc3 sc0 ls1 ws1">USQADD<span class="_ _bc"> </span>Unsigned saturating accumula<span class="_ _0"></span>te of signed value</div><div class="t m0 xc h10 y15db ffaf fs7 fc3 sc0 ls1 ws1">USRA<span class="_ _87"> </span>Unsigned shift right and accumula<span class="_ _0"></span>te</div><div class="t m0 xc h10 y15dc ffaf fs7 fc3 sc0 ls1 ws1">USUBL,<span class="_ _1"></span> USUBL2<span class="_ _8a"> </span>Unsigned subtract long</div><div class="t m0 xc h10 y15dd ffaf fs7 fc3 sc0 ls1 ws1">USUBW<span class="_ _6"></span>,<span class="_ _3"></span> USUBW2<span class="_ _c9"> </span>Unsigned subtract wide</div><div class="t m0 xc h10 y15de ffaf fs7 fc3 sc0 ls1 ws1">UXTL,<span class="_ _1"></span> UXTL2†<span class="_ _e0"> </span>Unsigned extend long</div><div class="t m0 xc h10 y15df ffaf fs7 fc3 sc0 ls1 ws1">UZP2<span class="_ _91"> </span>Unzip vectors</div><div class="t m0 xc h10 y15e0 ffaf fs7 fc3 sc0 ls1 ws1">XAR<span class="_ _94"> </span>Exc<span class="_ _1"></span>lusive OR and rota<span class="_ _0"></span>te</div><div class="t m0 xc h10 y15e1 ffaf fs7 fc3 sc0 ls1 ws1">XTN,<span class="_ _1"></span> XTN2<span class="_ _c1"> </span>Extract narrow</div><div class="t m0 xc h10 y15e2 ffaf fs7 fc3 sc0 ls1 ws1">ZIP1,<span class="_ _1"></span> ZIP2<span class="_ _be"> </span>Zip vectors</div><div class="t m0 x46 h12 y28b ffaf fsa fc3 sc0 ls1 wsb7">APPENDIX A <span class="_ _21"> </span> THE ARM <span class="_ _0"></span>INSTRUCTION <span class="_ _0"></span>SET </div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf19b" class="pf w2 h6" data-page-no="19b"><div class="pc pc19b w2 h6"><img class="bi xc y1644 w7 h76" alt="" src="bg19b.png"/><div class="t m0 x17 hd y16a ffb0 fs7 fc3 sc0 ls1 ws1">401</div><div class="t m0 xc h17 y16b ffb0 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ffb0 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ffb1">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ffb0">,  </span></span></div><div class="t m0 xc h17 y16d ffb0 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1</div><div class="t m0 xc h63 y1506 ffb2 fs6 fc3 sc0 ls1 wsdb"> APPENDIX <span class="_ _12"> </span>B</div><div class="t m0 xc h23 y1507 ffb3 fs4 fc3 sc0 ls1 ws1">Binar<span class="_ _7"></span>y F<span class="_ _8"></span>or<span class="_ _7"></span>ma<span class="_ _0"></span>ts</div><div class="t m0 xc hd y1645 ffb0 fs7 fc3 sc0 ls1 ws1">This appendix describes the basic characteristics of the data types we ha<span class="_ _1"></span>ve </div><div class="t m0 xc hd y1646 ffb0 fs7 fc3 sc0 ls1 ws1">been working with.</div><div class="t m0 xc h15 y1647 ffb4 fsb fc3 sc0 ls1 wsaf"> Integers</div><div class="t m0 xc hd y1648 ffb0 fs7 fc3 sc0 ls1 ws1">The following table pr<span class="_ _3"></span>ovides the basic in<span class="_ _3"></span>teger data types we ha<span class="_ _3"></span>ve used. </div><div class="t m0 xc hd y1649 ffb0 fs7 fc3 sc0 ls1 ws1">Signed integers ar<span class="_ _3"></span>e repr<span class="_ _1"></span>es<span class="_ _0"></span>ented in two<span class="_ _1"></span>’<span class="_ _6"></span>s complement form.</div><div class="t m0 xc h1c y164a ffb5 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able B-1. <span class="_ _15"> </span><span class="ffb1">Size, a<span class="_ _3"></span>lignment, r<span class="_ _1"></span>ang<span class="_ _0"></span>e<span class="_ _1"></span>, and C t<span class="_ _0"></span>ype for the b<span class="_ _0"></span>asic  </span></div><div class="t m0 xc h1c y164b ffb1 fs3 fc3 sc0 ls1 ws1">integer typ<span class="_ _0"></span>es</div><div class="t m0 xc h10 y164c ffb4 fs7 fc3 sc0 ls1 ws1">Size<span class="_ _59"> </span>T<span class="_ _1"></span>ype<span class="_ _cd"> </span>Alignment </div><div class="t m0 x6e h10 y164d ffb4 fs7 fc3 sc0 ls1 ws1">in Bytes</div><div class="t m0 x50 h10 y164c ffb4 fs7 fc3 sc0 ls1 ws1">Range<span class="_ _27"> </span>C T<span class="_ _6"></span>ype</div><div class="t m0 xc h10 y164e ffb6 fs7 fc3 sc0 ls1 ws1">8<span class="_ _5a"> </span>Signed<span class="_ _b6"> </span>1<span class="_ _bf"> </span>–128 to 127<span class="_ _c4"> </span>signed char</div><div class="t m0 xc h10 y164f ffb6 fs7 fc3 sc0 ls1 ws1">8<span class="_ _5a"> </span>Unsigned<span class="_ _7b"> </span>1<span class="_ _bf"> </span>0 to 255<span class="_ _2f"> </span>char</div><div class="t m0 xc h10 y1650 ffb6 fs7 fc3 sc0 ls1 ws1">16<span class="_ _6f"> </span>Signed<span class="_ _ac"> </span>2<span class="_ _bf"> </span>–32,768 to 32,767<span class="_ _83"> </span>short</div><div class="t m0 xc h10 y1651 ffb6 fs7 fc3 sc0 ls1 ws1">16<span class="_ _6f"> </span>Unsigned<span class="_ _e1"> </span>2<span class="_ _bf"> </span>0 to 65,535<span class="_ _d6"> </span>unsigned </div><div class="t m0 x60 h10 y1652 ffb6 fs7 fc3 sc0 ls1 ws1">short</div><div class="t m0 xc h10 y1653 ffb6 fs7 fc3 sc0 ls1 ws1">32<span class="_ _6f"> </span>Signed<span class="_ _ac"> </span>4<span class="_ _bf"> </span>–2,147,483,648 to </div><div class="t m0 x50 h10 y1654 ffb6 fs7 fc3 sc0 ls1 ws1">2,147,483,647</div><div class="t m0 x60 h10 y1653 ffb6 fs7 fc3 sc0 ls1 ws1">int</div><div class="t m0 x5 h20 y1655 ffb0 fs3 fc3 sc0 ls1 ws1">(<span class="ffb1">continued<span class="ffb7">)</span></span></div><a class="l" href="https://doi.org/10.1007/978-1-4842-5881-1"><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:156.340000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf19c" class="pf w2 h6" data-page-no="19c"><div class="pc pc19c w2 h6"><img class="bi xd y1656 we h77" alt="" src="bg19c.png"/><div class="t m0 xd hd y3f ffb0 fs7 fc3 sc0 ls1 ws1">402</div><div class="t m0 xd h15 y1657 ffb4 fsb fc3 sc0 ls1 wsaf"> Floating <span class="_ _11"> </span>P<span class="_ _1"></span>oint</div><div class="t m0 xd hd y1658 ffb0 fs7 fc3 sc0 ls1 ws1">The ARM floating point and NEON copr<span class="_ _1"></span>ocess<span class="_ _0"></span>ors use the IEEE-754 </div><div class="t m0 xd hd y1659 ffb0 fs7 fc3 sc0 ls1 ws1">standard for r<span class="_ _1"></span>epresenting floating-<span class="_ _1"></span>point numbers. All floa<span class="_ _3"></span>ting-<span class="_ _3"></span>point </div><div class="t m0 xd hd y165a ffb0 fs7 fc3 sc0 ls1 ws1">numbers ar<span class="_ _3"></span>e signed.</div><div class="t m0 x34 h1f y165b ffb4 fse fc3 sc0 ls1 ws1">Note<span class="ffb6"> <span class="_ _17"> </span>The <span class="_ _1"></span>ARM implementation of 16-bit half-precision floa<span class="_ _0"></span>ting </span></div><div class="t m0 x34 h1f y165c ffb6 fse fc3 sc0 ls1 ws1">point differs from the standard by not supporting infinity or NaNs.</div><div class="t m0 xd h10 y165d ffb4 fs7 fc3 sc0 ls1 ws1">Size<span class="_ _59"> </span>T<span class="_ _1"></span>ype<span class="_ _cd"> </span>Alignment </div><div class="t m0 x77 h10 y165e ffb4 fs7 fc3 sc0 ls1 ws1">in Bytes</div><div class="t m0 x21 h10 y165d ffb4 fs7 fc3 sc0 ls1 ws1">Range<span class="_ _27"> </span>C T<span class="_ _6"></span>ype</div><div class="t m0 xd h10 y165f ffb6 fs7 fc3 sc0 ls1 ws1">32<span class="_ _6f"> </span>Unsigned<span class="_ _e1"> </span>4<span class="_ _bf"> </span>0 to 4,294,967,295<span class="_ _3a"> </span>unsigned int</div><div class="t m0 xd h10 y1660 ffb6 fs7 fc3 sc0 ls1 ws1">64<span class="_ _6f"> </span>Signed<span class="_ _ac"> </span>8<span class="_ _bf"> </span>–9,223,372,036,854,775,808 </div><div class="t m0 x21 h10 y1661 ffb6 fs7 fc3 sc0 ls1 ws1">to 9,223,372,036,854,775,807</div><div class="t m0 x13 h10 y1660 ffb6 fs7 fc3 sc0 ls1 ws1">long long</div><div class="t m0 xd h10 y1662 ffb6 fs7 fc3 sc0 ls1 ws1">64<span class="_ _6f"> </span>Unsigned<span class="_ _e1"> </span>8<span class="_ _bf"> </span>0 to </div><div class="t m0 x21 h10 y1663 ffb6 fs7 fc3 sc0 ls1 ws1">18,446,744,073,709,551,615</div><div class="t m0 x13 h10 y1662 ffb6 fs7 fc3 sc0 ls1 ws1">unsigned </div><div class="t m0 x13 h10 y1663 ffb6 fs7 fc3 sc0 ls1 ws1">long long</div><div class="t m0 xd h20 y1664 ffb5 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able B-1. <span class="_ _15"> </span><span class="ffb0">(<span class="ffb1">continued</span>)</span></div><div class="t m0 xd h1c y1665 ffb5 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able B-2. <span class="_ _15"> </span><span class="ffb1">Size, a<span class="_ _3"></span>lignment, positive r<span class="_ _3"></span>ange, and C type for  </span></div><div class="t m0 xd h1c y1666 ffb1 fs3 fc3 sc0 ls1 wsde">floating-<span class="_ _3"></span> point <span class="_ _e2"> </span>numbers</div><div class="t m0 xd h10 y1667 ffb4 fs7 fc3 sc0 ls1 ws1">Size<span class="_ _e3"> </span>Alignment in Bytes<span class="_ _e4"> </span>Range<span class="_ _e5"> </span>C T<span class="_ _1"></span>ype</div><div class="t m0 xd h10 y1668 ffb6 fs7 fc3 sc0 ls1 ws1">16<span class="_ _e6"> </span>2<span class="_ _ab"> </span>0.000061035 to 65504<span class="_ _87"> </span>half</div><div class="t m0 xd h10 y1669 ffb6 fs7 fc3 sc0 ls1 ws1">32<span class="_ _e6"> </span>4<span class="_ _ab"> </span>1.175494351e-38 to 3.40282347e+38<span class="_ _7b"> </span>float</div><div class="t m0 xd h10 y166a ffb6 fs7 fc3 sc0 ls1 ws1">64<span class="_ _e6"> </span>8<span class="_ _ab"> </span>2.22507385850720138e-308 to </div><div class="t m0 x4 h10 y166b ffb6 fs7 fc3 sc0 ls1 ws1">1.79769313486231571e+308</div><div class="t m0 x5 h10 y166a ffb6 fs7 fc3 sc0 ls1 ws1">double</div><div class="t m0 xd h12 y166c ffb6 fsa fc3 sc0 ls1 ws1">APPENDIX B <span class="_ _f"> </span> BINARY FORMA<span class="_ _6"></span>TS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf19d" class="pf w2 h6" data-page-no="19d"><div class="pc pc19d w2 h6"><img class="bi xc y166d w7 h78" alt="" src="bg19d.png"/><div class="t m0 x17 hd y3f ffb0 fs7 fc3 sc0 ls1 ws1">403</div><div class="t m0 x36 h1f y71a ffb4 fse fc3 sc0 ls1 ws1">Note<span class="ffb6"> <span class="_ _19"> </span>Not all C compilers support 16-bit floating-point numbers.</span></div><div class="t m0 x36 h1f y166e ffb6 fse fc3 sc0 ls1 ws1">These ranges are for normalized values; the <span class="_ _1"></span>ARM processor will allow </div><div class="t m0 x36 h1f y166f ffb6 fse fc3 sc0 ls1 ws1">floats to become unnormalized to a<span class="_ _0"></span>void underflow<span class="_ _1"></span>.</div><div class="t m0 xc h15 y1670 ffb4 fsb fc3 sc0 ls1 wsaf"> Addresses</div><div class="t m0 xc hd y1671 ffb0 fs7 fc3 sc0 ls1 ws1">All addresses or pointers ar<span class="_ _1"></span>e 64 bits. They point to memory in the </div><div class="t m0 xc hd y1672 ffb0 fs7 fc3 sc0 ls1 ws1">processes virtual addres<span class="_ _3"></span>s space. They do not poin<span class="_ _3"></span>t directly to phy<span class="_ _3"></span>sical </div><div class="t m0 xc hd y1673 ffb0 fs7 fc3 sc0 ls1 ws1">memory.</div><div class="t m0 x78 h1c y1674 ffb5 fs3 fc3 sc0 ls1 ws1">T<span class="_ _1"></span>able B-3. <span class="_ _15"> </span><span class="ffb1">Size, r<span class="_ _1"></span>ang<span class="_ _0"></span>e<span class="_ _3"></span>, and C type of a p<span class="_ _0"></span>ointer</span></div><div class="t m0 x78 h10 y1675 ffb4 fs7 fc3 sc0 ls1 ws1">Size<span class="_ _79"> </span>Range<span class="_ _e7"> </span>C T<span class="_ _1"></span>ype</div><div class="t m0 x78 h10 y1676 ffb6 fs7 fc3 sc0 ls1 ws1">64<span class="_ _5f"> </span>0 to 18,446,744,073,709,551,615<span class="_ _72"> </span>void <span class="ffb8">∗</span></div><div class="t m0 x57 h12 y668 ffb6 fsa fc3 sc0 ls1 ws1">APPENDIX B <span class="_ _f"> </span> BINARY FORMA<span class="_ _6"></span>TS</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf19e" class="pf w2 h6" data-page-no="19e"><div class="pc pc19e w2 h6"><img class="bi xc y1677 w7 h4e" alt="" src="bg19e.png"/><div class="t m0 x17 hd y16a ffb9 fs7 fc3 sc0 ls1 ws1">405</div><div class="t m0 xc h17 y16b ffb9 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ffb9 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ffba">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ffb9">,  </span></span></div><div class="t m0 xc h17 y16d ffb9 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1</div><div class="t m0 xc ha y16e ffbb fs6 fc3 sc0 ls1 wsdb"> APPENDIX <span class="_ _12"> </span>C</div><div class="t m0 xc h23 y16f ffbc fs4 fc3 sc0 ls1 ws1">Assembler Dir<span class="_ _3"></span>ecti<span class="_ _1"></span>v<span class="_ _1"></span>es</div><div class="t m0 xc hd y1508 ffb9 fs7 fc3 sc0 ls1 ws1">This appendix lists a useful selection of GNU Assembler directives<span class="_ _3"></span>.  </div><div class="t m0 xc hd y1678 ffb9 fs7 fc3 sc0 ls1 ws1">It includes all the dir<span class="_ _1"></span>ectives use<span class="_ _0"></span>d in this book and a few mor<span class="_ _3"></span>e that ar<span class="_ _3"></span>e </div><div class="t m0 xc hd y1679 ffb9 fs7 fc3 sc0 ls1 ws1">commonly used.</div><div class="t m0 xc h79 y167a ffbd fs7 fc3 sc0 ls1 ws1">Directive<span class="_ _53"> </span>Description</div><div class="t m0 xc h10 y167b ffbe fs7 fc3 sc0 ls1 ws1">.align<span class="_ _9b"> </span>Pad the location counter to a particular storage boundar<span class="_ _0"></span>y</div><div class="t m0 xc h10 y167c ffbe fs7 fc3 sc0 ls1 ws1">.ascii<span class="_ _58"> </span>Defines memory for an <span class="_ _3"></span>ASCII string with no NULL terminator</div><div class="t m0 xc h10 y167d ffbe fs7 fc3 sc0 ls1 ws1">.asciz<span class="_ _ad"> </span>Defines memor<span class="_ _0"></span>y for an <span class="_ _1"></span>ASCII string and adds a NULL termina<span class="_ _0"></span>tor</div><div class="t m0 xc h10 y167e ffbe fs7 fc3 sc0 ls1 ws1">.byte<span class="_ _a4"> </span>Defines memory for bytes</div><div class="t m0 xc h10 y167f ffbe fs7 fc3 sc0 ls1 ws1">.data<span class="_ _e8"> </span>Assembles following code to the end of the data subsection</div><div class="t m0 xc h10 y1680 ffbe fs7 fc3 sc0 ls1 ws1">.double<span class="_ _bf"> </span>Defines memory for double floa<span class="_ _0"></span>ting-point data</div><div class="t m0 xc h10 y1681 ffbe fs7 fc3 sc0 ls1 ws1">.dword<span class="_ _3a"> </span>Defines storage for 64-bit integers</div><div class="t m0 xc h10 y1682 ffbe fs7 fc3 sc0 ls1 ws1">.else<span class="_ _be"> </span>Part of conditional assembly</div><div class="t m0 xc h10 y1683 ffbe fs7 fc3 sc0 ls1 ws1">.elseif<span class="_ _c0"> </span>Part of conditional assembly</div><div class="t m0 xc h10 y1684 ffbe fs7 fc3 sc0 ls1 ws1">.endif<span class="_ _b0"> </span>Part of conditional assembly</div><div class="t m0 xc h10 y1685 ffbe fs7 fc3 sc0 ls1 ws1">.endm<span class="_ _42"> </span>End of a macro definition</div><div class="t m0 xc h10 y1686 ffbe fs7 fc3 sc0 ls1 ws1">.endr<span class="_ _58"> </span>End of a repeat block</div><div class="t m0 xc h10 y1687 ffbe fs7 fc3 sc0 ls1 ws1">.equ<span class="_ _3e"> </span>Defines values for symbols</div><div class="t m0 x5 h20 y1688 ffb9 fs3 fc3 sc0 ls1 ws1">(<span class="ffba">continued</span>)</div><a class="l" href="https://doi.org/10.1007/978-1-4842-5881-1"><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:156.340000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf19f" class="pf w2 h6" data-page-no="19f"><div class="pc pc19f w2 h6"><img class="bi xd y1689 w7 h7a" alt="" src="bg19f.png"/><div class="t m0 xd hd y3f ffb9 fs7 fc3 sc0 ls1 ws1">406</div><div class="t m0 xd h79 y1532 ffbd fs7 fc3 sc0 ls1 ws1">Directive<span class="_ _53"> </span>Description</div><div class="t m0 xd h10 y15ce ffbe fs7 fc3 sc0 ls1 ws1">.fill<span class="_ _c2"> </span>Defines and fills some memory</div><div class="t m0 xd h10 y15cf ffbe fs7 fc3 sc0 ls1 ws1">.float<span class="_ _e8"> </span>Defines memory for single-precision floa<span class="_ _0"></span>ting-point data</div><div class="t m0 xd h10 y15d0 ffbe fs7 fc3 sc0 ls1 ws1">.global<span class="_ _48"> </span>Makes a symbol global,<span class="_ _3"></span> needed if reference from other files</div><div class="t m0 xd h10 y15d1 ffbe fs7 fc3 sc0 ls1 ws1">.hword<span class="_ _3a"> </span>Defines memor<span class="_ _0"></span>y for 16-bit integers</div><div class="t m0 xd h10 y15d2 ffbe fs7 fc3 sc0 ls1 ws1">.if<span class="_ _8d"> </span>Marks the beginning of code to be conditionally assembled</div><div class="t m0 xd h10 y15d3 ffbe fs7 fc3 sc0 ls1 ws1">.include<span class="_ _6d"> </span>Merges a file into the current file</div><div class="t m0 xd h10 y15d4 ffbe fs7 fc3 sc0 ls1 ws1"> .int<span class="_ _7f"> </span>Defines storage for 32-bit integers</div><div class="t m0 xd h10 y15d5 ffbe fs7 fc3 sc0 ls1 ws1">.long<span class="_ _a4"> </span>Defines storage for 32-bit integers (same as  .int)</div><div class="t m0 xd h10 y15d6 ffbe fs7 fc3 sc0 ls1 ws1">.macro<span class="_ _3a"> </span>Defines a macro</div><div class="t m0 xd h10 y15d7 ffbe fs7 fc3 sc0 ls1 ws1">.octa<span class="_ _a4"> </span>Defines storage for 64-bit integers</div><div class="t m0 xd h10 y15d8 ffbe fs7 fc3 sc0 ls1 ws1">.quad<span class="_ _b0"> </span>Same as  .octa</div><div class="t m0 xd h10 y15d9 ffbe fs7 fc3 sc0 ls1 ws1">.rept<span class="_ _30"> </span>Repeats a block of code multiple times</div><div class="t m0 xd h10 y15da ffbe fs7 fc3 sc0 ls1 ws1">.set<span class="_ _3c"> </span>Sets the value of a symbol to an expression</div><div class="t m0 xd h10 y15db ffbe fs7 fc3 sc0 ls1 ws1">.short<span class="_ _b0"> </span>Same as  .hword</div><div class="t m0 xd h10 y15dc ffbe fs7 fc3 sc0 ls1 ws1">.single<span class="_ _47"> </span>Same as  .float</div><div class="t m0 xd h10 y15dd ffbe fs7 fc3 sc0 ls1 ws1">.text<span class="_ _3e"> </span>Generates follo<span class="_ _0"></span>wing instructions into the code section</div><div class="t m0 xd h10 y15de ffbe fs7 fc3 sc0 ls1 ws1">.word<span class="_ _b0"> </span>Same as  .int</div><div class="t m0 xd h12 y28b ffbe fsa fc3 sc0 ls1 ws1">APPENDIX C <span class="_ _f"> </span><span class="wsb7"> ASSEMBLER <span class="_ _0"></span>DIRECTIVES</span></div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a0" class="pf w2 h6" data-page-no="1a0"><div class="pc pc1a0 w2 h6"><img class="bi x44 y1331 w19 h7b" alt="" src="bg1a0.png"/><div class="t m0 x17 hd y16a ffbf fs7 fc3 sc0 ls1 ws1">407</div><div class="t m0 xc h17 y16b ffbf fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ffbf fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ffc0">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ffbf">,  </span></span></div><div class="t m0 xc h17 y16d ffbf fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1</div><div class="t m0 xc h63 y16e ffc1 fs6 fc3 sc0 ls1 wsdb"> APPENDIX <span class="_ _12"> </span>D</div><div class="t m0 xc h8 y16f ffc2 fs4 fc3 sc0 ls1 ws1">ASCII Char<span class="_ _3"></span>acter Set</div><div class="t m0 xc hd y1508 ffbf fs7 fc3 sc0 ls1 ws1">Her<span class="_ _3"></span>e is the ASCII Character Set. The char<span class="_ _1"></span>acters from 0 to 127 are standar<span class="_ _3"></span>d. </div><div class="t m0 xc hd y1678 ffbf fs7 fc3 sc0 ls1 ws1">The char<span class="_ _3"></span>acters from 128 to 255 ar<span class="_ _1"></span>e taken from code page 437, which is the </div><div class="t m0 xc hd y1679 ffbf fs7 fc3 sc0 ls1 ws1">character set of the original IB<span class="_ _3"></span>M PC.</div><div class="t m0 x79 h20 y168a ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 x44 h10 y168b ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x44 h7c y168c ffc4 fs7 fc3 sc0 ls1 ws1"> 0<span class="_ _3a"> </span>00<span class="_ _eb"> </span>NUL<span class="_ _49"> </span>Null</div><div class="t m0 x44 h7c y168d ffc4 fs7 fc3 sc0 ls1 ws1"> 1<span class="_ _3a"> </span>01<span class="_ _eb"> </span>SOH<span class="_ _23"> </span>Start of header</div><div class="t m0 x44 h7c y168e ffc4 fs7 fc3 sc0 ls1 ws1"> 2<span class="_ _3a"> </span>02<span class="_ _eb"> </span>STX<span class="_ _ec"> </span>Start of text</div><div class="t m0 x44 h7c y168f ffc4 fs7 fc3 sc0 ls1 ws1"> 3<span class="_ _3a"> </span>03<span class="_ _eb"> </span>ETX<span class="_ _3a"> </span>End of text</div><div class="t m0 x44 h7c y1690 ffc4 fs7 fc3 sc0 ls1 ws1"> 4<span class="_ _3a"> </span>04<span class="_ _eb"> </span>EOT<span class="_ _d0"> </span>End of transmission</div><div class="t m0 x44 h7c y1691 ffc4 fs7 fc3 sc0 ls1 ws1"> 5<span class="_ _3a"> </span>05<span class="_ _eb"> </span>ENQ<span class="_ _ed"> </span>Enquiry</div><div class="t m0 x44 h7c y1692 ffc4 fs7 fc3 sc0 ls1 ws1"> 6<span class="_ _3a"> </span>06<span class="_ _eb"> </span>ACK<span class="_ _49"> </span>Acknowledge</div><div class="t m0 x44 h7c y1693 ffc4 fs7 fc3 sc0 ls1 ws1"> 7<span class="_ _3a"> </span>07<span class="_ _eb"> </span>BEL<span class="_ _ec"> </span>Bell</div><div class="t m0 x44 h7c y1694 ffc4 fs7 fc3 sc0 ls1 ws1"> 8<span class="_ _3a"> </span>08<span class="_ _eb"> </span>BS<span class="_ _bd"> </span>Backspace</div><div class="t m0 x44 h7c y1695 ffc4 fs7 fc3 sc0 ls1 ws1"> 9<span class="_ _3a"> </span>09<span class="_ _eb"> </span>HT<span class="_ _bd"> </span>Horizontal tab</div><div class="t m0 x44 h7c y1696 ffc4 fs7 fc3 sc0 ls1 ws1">10<span class="_ _3b"> </span>0A<span class="_ _6d"> </span>LF<span class="_ _b5"> </span>Line feed</div><div class="t m0 x44 h7c y1697 ffc4 fs7 fc3 sc0 ls1 ws1">11<span class="_ _3b"> </span>0B<span class="_ _6d"> </span>VT<span class="_ _ad"> </span>Vertical tab</div><div class="t m0 x44 h7c y1698 ffc4 fs7 fc3 sc0 ls1 ws1">12<span class="_ _3b"> </span>0C<span class="_ _6d"> </span>FF<span class="_ _b0"> </span>Form feed</div><a class="l" href="https://doi.org/10.1007/978-1-4842-5881-1"><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:156.340000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a1" class="pf w2 h6" data-page-no="1a1"><div class="pc pc1a1 w2 h6"><img class="bi x7a y1699 w19 h7d" alt="" src="bg1a1.png"/><div class="t m0 xd hd y3f ffbf fs7 fc3 sc0 ls1 ws1">408</div><div class="t m0 x7a h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x7a h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">13<span class="_ _3b"> </span>0D<span class="_ _ee"> </span>CR<span class="_ _c0"> </span>Carriage return</div><div class="t m0 x7a h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">14<span class="_ _3b"> </span>0E<span class="_ _eb"> </span>SO<span class="_ _c0"> </span>Shift out</div><div class="t m0 x7a h7c y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">15<span class="_ _3b"> </span>0F<span class="_ _3b"> </span>SI<span class="_ _58"> </span>Shift in</div><div class="t m0 x7a h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">16<span class="_ _3b"> </span>10<span class="_ _eb"> </span>DLE<span class="_ _d0"> </span>Data link esca<span class="_ _0"></span>pe</div><div class="t m0 x7a h7c y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">17<span class="_ _3b"> </span>11<span class="_ _eb"> </span>DC1<span class="_ _ed"> </span>Device control 1</div><div class="t m0 x7a h7c y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">18<span class="_ _3b"> </span>12<span class="_ _eb"> </span>DC2<span class="_ _ed"> </span>Device control 2</div><div class="t m0 x7a h7c y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">19<span class="_ _3b"> </span>13<span class="_ _eb"> </span>DC3<span class="_ _ed"> </span>Device control 3</div><div class="t m0 x7a h7c y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">20<span class="_ _3b"> </span>14<span class="_ _eb"> </span>DC4<span class="_ _ed"> </span>Device control 4</div><div class="t m0 x7a h7c y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">21<span class="_ _3b"> </span>15<span class="_ _eb"> </span>NAK<span class="_ _ed"> </span>Nega<span class="_ _0"></span>tive acknowledge</div><div class="t m0 x7a h7c y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">22<span class="_ _3b"> </span>16<span class="_ _eb"> </span>SYN<span class="_ _49"> </span>Synchronize</div><div class="t m0 x7a h7c y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">23<span class="_ _3b"> </span>17<span class="_ _eb"> </span>ETB<span class="_ _ec"> </span>End of transmission block</div><div class="t m0 x7a h7c y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">24<span class="_ _3b"> </span>18<span class="_ _eb"> </span>CAN<span class="_ _ed"> </span>Cancel</div><div class="t m0 x7a h7c y15da ffc4 fs7 fc3 sc0 ls1 ws1">25<span class="_ _3b"> </span>19<span class="_ _eb"> </span>EM<span class="_ _ef"> </span>End of medium</div><div class="t m0 x7a h7c y15db ffc4 fs7 fc3 sc0 ls1 ws1">26<span class="_ _3b"> </span>1A<span class="_ _6d"> </span>SUB<span class="_ _bf"> </span>Substitute</div><div class="t m0 x7a h7c y15dc ffc4 fs7 fc3 sc0 ls1 ws1">27<span class="_ _3b"> </span>1B<span class="_ _6d"> </span>ESC<span class="_ _d0"> </span>Escape</div><div class="t m0 x7a h7c y15dd ffc4 fs7 fc3 sc0 ls1 ws1">28<span class="_ _3b"> </span>1C<span class="_ _6d"> </span>FS<span class="_ _ad"> </span>File separator</div><div class="t m0 x7a h7c y15de ffc4 fs7 fc3 sc0 ls1 ws1">29<span class="_ _3b"> </span>1D<span class="_ _ee"> </span>GS<span class="_ _c0"> </span>Group separator</div><div class="t m0 x7a h7c y15df ffc4 fs7 fc3 sc0 ls1 ws1">30<span class="_ _3b"> </span>1E<span class="_ _eb"> </span>RS<span class="_ _bd"> </span>Record separator</div><div class="t m0 x7a h7c y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">31<span class="_ _3b"> </span>1F<span class="_ _3b"> </span>US<span class="_ _c0"> </span>Unit separator</div><div class="t m0 x7a h7c y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">32<span class="_ _3b"> </span>20<span class="_ _eb"> </span>space<span class="_ _e9"> </span>Space</div><div class="t m0 x7a h7c y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">33<span class="_ _3b"> </span>21<span class="_ _eb"> </span>!<span class="_ _bb"> </span>Exclamation mark</div><div class="t m0 x7a h7c y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">34<span class="_ _3b"> </span>22<span class="_ _eb"> </span>&quot;<span class="_ _a5"> </span>Double quote</div><div class="t m0 x7a h7c y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">35<span class="_ _3b"> </span>23<span class="_ _eb"> </span>#<span class="_ _37"> </span>Number</div><div class="t m0 x7b h20 y169a ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 xd h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a2" class="pf w2 h6" data-page-no="1a2"><div class="pc pc1a2 w2 h6"><img class="bi x44 y169b w19 h7f" alt="" src="bg1a2.png"/><div class="t m0 x17 hd y3f ffbf fs7 fc3 sc0 ls1 ws1">409</div><div class="t m0 x44 h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x44 h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">36<span class="_ _3b"> </span>24<span class="_ _eb"> </span>$<span class="_ _37"> </span>Dollar sign</div><div class="t m0 x44 h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">37<span class="_ _3b"> </span>25<span class="_ _eb"> </span>%<span class="_ _58"> </span>P<span class="_ _1"></span>ercent</div><div class="t m0 x44 h7c y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">38<span class="_ _3b"> </span>26<span class="_ _eb"> </span>&amp;<span class="_ _57"> </span>Ampersand</div><div class="t m0 x44 h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">39<span class="_ _3b"> </span>27<span class="_ _eb"> </span>&apos;<span class="_ _7f"> </span>Single quote</div><div class="t m0 x44 h7c y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">40<span class="_ _3b"> </span>28<span class="_ _eb"> </span>(<span class="_ _7f"> </span>Left parenthesis</div><div class="t m0 x44 h7c y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">41<span class="_ _3b"> </span>29<span class="_ _eb"> </span>)<span class="_ _7f"> </span>Right parenthesis</div><div class="t m0 x44 h80 y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">42<span class="_ _3b"> </span>2A<span class="_ _6d"> </span><span class="ffc5">∗<span class="_ _30"> </span></span>Asterisk</div><div class="t m0 x44 h7c y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">43<span class="_ _3b"> </span>2B<span class="_ _6d"> </span>+<span class="_ _f0"> </span>Plus</div><div class="t m0 x44 h7c y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">44<span class="_ _3b"> </span>2C<span class="_ _6d"> </span>,<span class="_ _bb"> </span>Comma</div><div class="t m0 x44 h7c y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">45<span class="_ _3b"> </span>2D<span class="_ _ee"> </span>-<span class="_ _b4"> </span>Minus</div><div class="t m0 x44 h7c y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">46<span class="_ _3b"> </span>2E<span class="_ _eb"> </span>.<span class="_ _7f"> </span>Period</div><div class="t m0 x44 h7c y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">47<span class="_ _3b"> </span>2F<span class="_ _3b"> </span>/<span class="_ _39"> </span>Slash</div><div class="t m0 x44 h7c y15da ffc4 fs7 fc3 sc0 ls1 ws1">48<span class="_ _3b"> </span>30<span class="_ _eb"> </span>0<span class="_ _37"> </span>Zero</div><div class="t m0 x44 h7c y15db ffc4 fs7 fc3 sc0 ls1 ws1">49<span class="_ _3b"> </span>31<span class="_ _eb"> </span>1<span class="_ _37"> </span>One</div><div class="t m0 x44 h7c y15dc ffc4 fs7 fc3 sc0 ls1 ws1">50<span class="_ _3b"> </span>32<span class="_ _eb"> </span>2<span class="_ _37"> </span><span class="ls22 wsc5">Tw<span class="_ _2"></span>o</span></div><div class="t m0 x44 h7c y15dd ffc4 fs7 fc3 sc0 ls1 ws1">51<span class="_ _3b"> </span>33<span class="_ _eb"> </span>3<span class="_ _37"> </span>Three</div><div class="t m0 x44 h7c y15de ffc4 fs7 fc3 sc0 ls1 ws1">52<span class="_ _3b"> </span>34<span class="_ _eb"> </span>4<span class="_ _37"> </span>Four</div><div class="t m0 x44 h7c y15df ffc4 fs7 fc3 sc0 ls1 ws1">53<span class="_ _3b"> </span>35<span class="_ _eb"> </span>5<span class="_ _37"> </span>Five</div><div class="t m0 x44 h7c y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">54<span class="_ _3b"> </span>36<span class="_ _eb"> </span>6<span class="_ _37"> </span>Six</div><div class="t m0 x44 h7c y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">55<span class="_ _3b"> </span>37<span class="_ _eb"> </span>7<span class="_ _37"> </span>Seven</div><div class="t m0 x44 h7c y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">56<span class="_ _3b"> </span>38<span class="_ _eb"> </span>8<span class="_ _37"> </span>Eight</div><div class="t m0 x44 h7c y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">57<span class="_ _3b"> </span>39<span class="_ _eb"> </span>9<span class="_ _37"> </span>Nine</div><div class="t m0 x44 h7c y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">58<span class="_ _3b"> </span>3A<span class="_ _6d"> </span>:<span class="_ _7f"> </span>Colon</div><div class="t m0 x79 h20 y169c ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 x40 h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a3" class="pf w2 h6" data-page-no="1a3"><div class="pc pc1a3 w2 h6"><img class="bi x7a y169b w19 h7f" alt="" src="bg1a3.png"/><div class="t m0 xd hd y3f ffbf fs7 fc3 sc0 ls1 ws1">410</div><div class="t m0 x7a h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x7a h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">59<span class="_ _3b"> </span>3B<span class="_ _6d"> </span>;<span class="_ _bb"> </span>Semicolon</div><div class="t m0 x7a h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">60<span class="_ _3b"> </span>3C<span class="_ _6d"> </span>&lt;<span class="_ _f0"> </span>Less than</div><div class="t m0 x7a h7c y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">61<span class="_ _3b"> </span>3D<span class="_ _ee"> </span>=<span class="_ _f0"> </span>Equality sign</div><div class="t m0 x7a h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">62<span class="_ _3b"> </span>3E<span class="_ _eb"> </span>&gt;<span class="_ _be"> </span>Greater than</div><div class="t m0 x7a h7c y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">63<span class="_ _3b"> </span>3F<span class="_ _3b"> </span>?<span class="_ _f1"> </span>Question mark</div><div class="t m0 x7a h7c y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">64<span class="_ _3b"> </span>40<span class="_ _eb"> </span>@<span class="_ _c1"> </span>At sign</div><div class="t m0 x7a h7c y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">65<span class="_ _3b"> </span>41<span class="_ _eb"> </span>A<span class="_ _37"> </span><span class="wsa">Capital A</span></div><div class="t m0 x7a h7c y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">66<span class="_ _3b"> </span>42<span class="_ _eb"> </span>B<span class="_ _30"> </span>Capital B</div><div class="t m0 x7a h7c y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">67<span class="_ _3b"> </span>43<span class="_ _eb"> </span>C<span class="_ _30"> </span>Capital C</div><div class="t m0 x7a h7c y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">68<span class="_ _3b"> </span>44<span class="_ _eb"> </span>D<span class="_ _57"> </span>Capital D</div><div class="t m0 x7a h7c y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">69<span class="_ _3b"> </span>45<span class="_ _eb"> </span>E<span class="_ _f1"> </span>Capital E</div><div class="t m0 x7a h7c y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">70<span class="_ _3b"> </span>46<span class="_ _eb"> </span>F<span class="_ _f1"> </span>Ca<span class="_ _0"></span>pital F</div><div class="t m0 x7a h7c y15da ffc4 fs7 fc3 sc0 ls1 ws1">71<span class="_ _3b"> </span>47<span class="_ _eb"> </span>G<span class="_ _57"> </span>Ca<span class="_ _0"></span>pital G</div><div class="t m0 x7a h7c y15db ffc4 fs7 fc3 sc0 ls1 ws1">72<span class="_ _3b"> </span>48<span class="_ _eb"> </span>H<span class="_ _57"> </span>Ca<span class="_ _0"></span>pital H</div><div class="t m0 x7a h7c y15dc ffc4 fs7 fc3 sc0 ls1 ws1">73<span class="_ _3b"> </span>49<span class="_ _eb"> </span>I<span class="_ _d9"> </span>Capital I</div><div class="t m0 x7a h7c y15dd ffc4 fs7 fc3 sc0 ls1 ws1">74<span class="_ _3b"> </span>4A<span class="_ _6d"> </span>J<span class="_ _3e"> </span>Ca<span class="_ _0"></span>pital J</div><div class="t m0 x7a h7c y15de ffc4 fs7 fc3 sc0 ls1 ws1">75<span class="_ _3b"> </span>4B<span class="_ _6d"> </span>K<span class="_ _30"> </span>Ca<span class="_ _0"></span>pital K</div><div class="t m0 x7a h7c y15df ffc4 fs7 fc3 sc0 ls1 ws1">76<span class="_ _3b"> </span>4C<span class="_ _6d"> </span>L<span class="_ _f1"> </span>Capital L</div><div class="t m0 x7a h7c y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">77<span class="_ _3b"> </span>4D<span class="_ _ee"> </span>M<span class="_ _56"> </span>Capital M</div><div class="t m0 x7a h7c y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">78<span class="_ _3b"> </span>4E<span class="_ _eb"> </span>N<span class="_ _57"> </span>Ca<span class="_ _0"></span>pital N</div><div class="t m0 x7a h7c y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">79<span class="_ _3b"> </span>4F<span class="_ _3b"> </span>O<span class="_ _be"> </span>Capital O</div><div class="t m0 x7a h7c y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">80<span class="_ _3b"> </span>50<span class="_ _eb"> </span>P<span class="_ _37"> </span>Capital P</div><div class="t m0 x7a h7c y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">81<span class="_ _3b"> </span>51<span class="_ _eb"> </span>Q<span class="_ _57"> </span>Capital Q</div><div class="t m0 x7b h20 y169d ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 xd h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a4" class="pf w2 h6" data-page-no="1a4"><div class="pc pc1a4 w2 h6"><img class="bi x44 y169b w19 h7f" alt="" src="bg1a4.png"/><div class="t m0 x17 hd y3f ffbf fs7 fc3 sc0 ls1 ws1">411</div><div class="t m0 x44 h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x44 h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">82<span class="_ _3b"> </span>52<span class="_ _eb"> </span>R<span class="_ _30"> </span>Capital R</div><div class="t m0 x44 h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">83<span class="_ _3b"> </span>53<span class="_ _eb"> </span>S<span class="_ _37"> </span>Capital S</div><div class="t m0 x44 h7c y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">84<span class="_ _3b"> </span>54<span class="_ _eb"> </span>T<span class="_ _f1"> </span><span class="wsa">Capital T</span></div><div class="t m0 x44 h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">85<span class="_ _3b"> </span>55<span class="_ _eb"> </span>U<span class="_ _30"> </span>Capital U</div><div class="t m0 x44 h7c y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">86<span class="_ _3b"> </span>56<span class="_ _eb"> </span>V<span class="_ _f1"> </span><span class="wsa">Capital V</span></div><div class="t m0 x44 h7c y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">87<span class="_ _3b"> </span>57<span class="_ _eb"> </span>W<span class="_ _58"> </span><span class="wsa">Ca<span class="_ _0"></span>pital W</span></div><div class="t m0 x44 h7c y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">88<span class="_ _3b"> </span>58<span class="_ _eb"> </span>X<span class="_ _37"> </span>Capital X</div><div class="t m0 x44 h7c y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">89<span class="_ _3b"> </span>59<span class="_ _eb"> </span>Y<span class="_ _f1"> </span><span class="wsa">Capital Y</span></div><div class="t m0 x44 h7c y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">90<span class="_ _3b"> </span>5A<span class="_ _6d"> </span>Z<span class="_ _f1"> </span>Capital Z</div><div class="t m0 x44 h7c y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">91<span class="_ _3b"> </span>5B<span class="_ _6d"> </span>[<span class="_ _bb"> </span>Left square bracket</div><div class="t m0 x44 h7c y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">92<span class="_ _3b"> </span>5C<span class="_ _6d"> </span>\<span class="_ _39"> </span>Backslash</div><div class="t m0 x44 h7c y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">93<span class="_ _3b"> </span>5D<span class="_ _ee"> </span>]<span class="_ _bb"> </span>Right square bracket</div><div class="t m0 x44 h7c y15da ffc4 fs7 fc3 sc0 ls1 ws1">94<span class="_ _3b"> </span>5E<span class="_ _eb"> </span>^<span class="_ _be"> </span>Caret/circumflex</div><div class="t m0 x44 h7c y15db ffc4 fs7 fc3 sc0 ls1 ws1">95<span class="_ _3b"> </span>5F<span class="_ _3b"> </span>_<span class="_ _30"> </span>Underscore</div><div class="t m0 x44 h7c y15dc ffc4 fs7 fc3 sc0 ls1 ws1">96<span class="_ _3b"> </span>60<span class="_ _eb"> </span>`<span class="_ _d9"> </span>Grave/accent</div><div class="t m0 x44 h7c y15dd ffc4 fs7 fc3 sc0 ls1 ws1"> 97<span class="_ _99"> </span>61<span class="_ _eb"> </span>a<span class="_ _3e"> </span>Small a</div><div class="t m0 x44 h7c y15de ffc4 fs7 fc3 sc0 ls1 ws1"> 98<span class="_ _99"> </span>62<span class="_ _eb"> </span>b<span class="_ _f1"> </span>Small b</div><div class="t m0 x44 h7c y15df ffc4 fs7 fc3 sc0 ls1 ws1"> 99<span class="_ _99"> </span>63<span class="_ _eb"> </span>c<span class="_ _a5"> </span>Small c</div><div class="t m0 x44 h7c y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">100<span class="_ _c6"> </span>64<span class="_ _eb"> </span>d<span class="_ _f1"> </span>Small d</div><div class="t m0 x44 h7c y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">101<span class="_ _c6"> </span>65<span class="_ _eb"> </span>e<span class="_ _f1"> </span>Small e</div><div class="t m0 x44 h7c y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">102<span class="_ _c6"> </span>66<span class="_ _eb"> </span>f<span class="_ _bb"> </span>Small f</div><div class="t m0 x44 h7c y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">103<span class="_ _c6"> </span>67<span class="_ _eb"> </span>g<span class="_ _f1"> </span>Small g</div><div class="t m0 x44 h7c y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">104<span class="_ _c6"> </span>68<span class="_ _eb"> </span>h<span class="_ _f1"> </span>Small h</div><div class="t m0 x79 h20 y169c ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 x40 h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a5" class="pf w2 h6" data-page-no="1a5"><div class="pc pc1a5 w2 h6"><img class="bi x7a y169b w19 h7f" alt="" src="bg1a5.png"/><div class="t m0 xd hd y3f ffbf fs7 fc3 sc0 ls1 ws1">412</div><div class="t m0 x7a h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x7a h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">105<span class="_ _c6"> </span>69<span class="_ _eb"> </span>i<span class="_ _d9"> </span>Small i</div><div class="t m0 x7a h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">106<span class="_ _c6"> </span>6A<span class="_ _6d"> </span>j<span class="_ _d9"> </span>Small j</div><div class="t m0 x7a h7c y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">107<span class="_ _c6"> </span>6B<span class="_ _6d"> </span>k<span class="_ _f1"> </span>Small k</div><div class="t m0 x7a h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">108<span class="_ _c6"> </span>6C<span class="_ _6d"> </span>l<span class="_ _7f"> </span>Small l</div><div class="t m0 x7a h7c y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">109<span class="_ _c6"> </span>6D<span class="_ _ee"> </span>m<span class="_ _58"> </span>Small m</div><div class="t m0 x7a h7c y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">110<span class="_ _c6"> </span>6E<span class="_ _eb"> </span>n<span class="_ _f1"> </span>Small n</div><div class="t m0 x7a h7c y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">111<span class="_ _c6"> </span>6F<span class="_ _3b"> </span>o<span class="_ _f1"> </span>Small o</div><div class="t m0 x7a h7c y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">112<span class="_ _c6"> </span>70<span class="_ _eb"> </span>p<span class="_ _f1"> </span>Small p</div><div class="t m0 x7a h7c y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">113<span class="_ _c6"> </span>71<span class="_ _eb"> </span>q<span class="_ _f1"> </span>Small q</div><div class="t m0 x7a h7c y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">114<span class="_ _c6"> </span>72<span class="_ _eb"> </span>r<span class="_ _39"> </span>Small r</div><div class="t m0 x7a h7c y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">115<span class="_ _c6"> </span>73<span class="_ _eb"> </span>s<span class="_ _a5"> </span>Small s</div><div class="t m0 x7a h7c y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">116<span class="_ _c6"> </span>74<span class="_ _eb"> </span>t<span class="_ _bb"> </span>Small t</div><div class="t m0 x7a h7c y15da ffc4 fs7 fc3 sc0 ls1 ws1">117<span class="_ _c6"> </span>75<span class="_ _eb"> </span>u<span class="_ _f1"> </span>Small u</div><div class="t m0 x7a h7c y15db ffc4 fs7 fc3 sc0 ls1 ws1">118<span class="_ _c6"> </span>76<span class="_ _eb"> </span>v<span class="_ _a5"> </span>Small v</div><div class="t m0 x7a h7c y15dc ffc4 fs7 fc3 sc0 ls1 ws1">119<span class="_ _c6"> </span>77<span class="_ _eb"> </span>w<span class="_ _a4"> </span>Small w</div><div class="t m0 x7a h7c y15dd ffc4 fs7 fc3 sc0 ls1 ws1">120<span class="_ _c6"> </span>78<span class="_ _eb"> </span>x<span class="_ _a5"> </span>Small x</div><div class="t m0 x7a h7c y15de ffc4 fs7 fc3 sc0 ls1 ws1">121<span class="_ _c6"> </span>79<span class="_ _eb"> </span>y<span class="_ _a5"> </span>Small y</div><div class="t m0 x7a h7c y15df ffc4 fs7 fc3 sc0 ls1 ws1">122<span class="_ _c6"> </span>7A<span class="_ _6d"> </span>z<span class="_ _a5"> </span>Small z</div><div class="t m0 x7a h7c y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">123<span class="_ _c6"> </span>7B<span class="_ _6d"> </span>{<span class="_ _bb"> </span>Left curly bracket</div><div class="t m0 x7a h7c y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">124<span class="_ _c6"> </span>7C<span class="_ _6d"> </span>|<span class="_ _7f"> </span>Vertical bar</div><div class="t m0 x7a h7c y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">125<span class="_ _c6"> </span>7D<span class="_ _ee"> </span>}<span class="_ _bb"> </span>Right curly bracket</div><div class="t m0 x7a h7c y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">126<span class="_ _c6"> </span>7E<span class="_ _eb"> </span>~<span class="_ _be"> </span>Tilde</div><div class="t m0 x7a h7c y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">127<span class="_ _c6"> </span>7F<span class="_ _3b"> </span>DEL<span class="_ _d0"> </span>Delete</div><div class="t m0 x7b h20 y169d ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 xd h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a6" class="pf w2 h6" data-page-no="1a6"><div class="pc pc1a6 w2 h6"><img class="bi x44 y169b w19 h7f" alt="" src="bg1a6.png"/><div class="t m0 x17 hd y3f ffbf fs7 fc3 sc0 ls1 ws1">413</div><div class="t m0 x44 h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x44 h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">128<span class="_ _c6"> </span>80<span class="_ _eb"> </span>Ç</div><div class="t m0 x44 h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">129<span class="_ _c6"> </span>81<span class="_ _eb"> </span>ü</div><div class="t m0 x44 h7c y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">130<span class="_ _c6"> </span>82<span class="_ _eb"> </span>é</div><div class="t m0 x44 h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">131<span class="_ _c6"> </span>83<span class="_ _eb"> </span>â</div><div class="t m0 x44 h7c y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">132<span class="_ _c6"> </span>84<span class="_ _eb"> </span>ä</div><div class="t m0 x44 h7c y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">133<span class="_ _c6"> </span>85<span class="_ _eb"> </span>à</div><div class="t m0 x44 h7c y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">134<span class="_ _c6"> </span>86<span class="_ _eb"> </span>å</div><div class="t m0 x44 h7c y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">135<span class="_ _c6"> </span>87<span class="_ _eb"> </span>ç</div><div class="t m0 x44 h7c y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">136<span class="_ _c6"> </span>88<span class="_ _eb"> </span>ê</div><div class="t m0 x44 h7c y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">137<span class="_ _c6"> </span>89<span class="_ _eb"> </span>ë</div><div class="t m0 x44 h7c y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">138<span class="_ _c6"> </span>8A<span class="_ _6d"> </span>è</div><div class="t m0 x44 h7c y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">139<span class="_ _c6"> </span>8B<span class="_ _6d"> </span>ï</div><div class="t m0 x44 h7c y15da ffc4 fs7 fc3 sc0 ls1 ws1">140<span class="_ _c6"> </span>8C<span class="_ _6d"> </span>î</div><div class="t m0 x44 h7c y15db ffc4 fs7 fc3 sc0 ls1 ws1">141<span class="_ _c6"> </span>8D<span class="_ _ee"> </span>ì</div><div class="t m0 x44 h7c y15dc ffc4 fs7 fc3 sc0 ls1 ws1">142<span class="_ _c6"> </span>8E<span class="_ _eb"> </span>Ä</div><div class="t m0 x44 h7c y15dd ffc4 fs7 fc3 sc0 ls1 ws1">143<span class="_ _c6"> </span>8F<span class="_ _3b"> </span>Å</div><div class="t m0 x44 h7c y15de ffc4 fs7 fc3 sc0 ls1 ws1">144<span class="_ _c6"> </span>90<span class="_ _eb"> </span>É</div><div class="t m0 x44 h7c y15df ffc4 fs7 fc3 sc0 ls1 ws1">145<span class="_ _c6"> </span>91<span class="_ _eb"> </span>æ</div><div class="t m0 x44 h7c y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">146<span class="_ _c6"> </span>92<span class="_ _eb"> </span>Æ</div><div class="t m0 x44 h7c y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">147<span class="_ _c6"> </span>93<span class="_ _eb"> </span>ô</div><div class="t m0 x44 h7c y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">148<span class="_ _c6"> </span>94<span class="_ _eb"> </span>ö</div><div class="t m0 x44 h7c y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">149<span class="_ _c6"> </span>95<span class="_ _eb"> </span>ò</div><div class="t m0 x44 h7c y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">150<span class="_ _c6"> </span>96<span class="_ _eb"> </span>û</div><div class="t m0 x79 h20 y169c ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 x40 h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a7" class="pf w2 h6" data-page-no="1a7"><div class="pc pc1a7 w2 h6"><img class="bi x7a y169b w19 h7f" alt="" src="bg1a7.png"/><div class="t m0 xd hd y3f ffbf fs7 fc3 sc0 ls1 ws1">414</div><div class="t m0 x7a h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x7a h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">151<span class="_ _c6"> </span>97<span class="_ _eb"> </span>ù</div><div class="t m0 x7a h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">152<span class="_ _c6"> </span>98<span class="_ _eb"> </span>ÿ</div><div class="t m0 x7a h7c y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">153<span class="_ _c6"> </span>99<span class="_ _eb"> </span>Ö</div><div class="t m0 x7a h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">154<span class="_ _c6"> </span>9A<span class="_ _6d"> </span>Ü</div><div class="t m0 x7a h7c y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">155<span class="_ _c6"> </span>9B<span class="_ _6d"> </span>¢</div><div class="t m0 x7a h7c y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">156<span class="_ _c6"> </span>9C<span class="_ _6d"> </span>£</div><div class="t m0 x7a h7c y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">157<span class="_ _c6"> </span>9D<span class="_ _ee"> </span>¥</div><div class="t m0 x7a h80 y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">158<span class="_ _c6"> </span>9E<span class="_ _eb"> </span><span class="ffc5">₧</span></div><div class="t m0 x7a h7c y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">159<span class="_ _c6"> </span>9F<span class="_ _3b"> </span>ƒ</div><div class="t m0 x7a h7c y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">160<span class="_ _c6"> </span>A0<span class="_ _6d"> </span>á</div><div class="t m0 x7a h7c y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">161<span class="_ _c6"> </span>A1<span class="_ _6d"> </span>í</div><div class="t m0 x7a h7c y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">162<span class="_ _c6"> </span>A2<span class="_ _6d"> </span>ó</div><div class="t m0 x7a h7c y15da ffc4 fs7 fc3 sc0 ls1 ws1">163<span class="_ _c6"> </span>A3<span class="_ _6d"> </span>ú</div><div class="t m0 x7a h7c y15db ffc4 fs7 fc3 sc0 ls1 ws1">164<span class="_ _c6"> </span>A4<span class="_ _6d"> </span>ñ</div><div class="t m0 x7a h7c y15dc ffc4 fs7 fc3 sc0 ls1 ws1">165<span class="_ _c6"> </span>A5<span class="_ _6d"> </span>Ñ</div><div class="t m0 x7a h7c y15dd ffc4 fs7 fc3 sc0 ls1 ws1">166<span class="_ _c6"> </span>A6<span class="_ _6d"> </span>ª</div><div class="t m0 x7a h7c y15de ffc4 fs7 fc3 sc0 ls1 ws1">167<span class="_ _c6"> </span>A7<span class="_ _6d"> </span>°</div><div class="t m0 x7a h7c y15df ffc4 fs7 fc3 sc0 ls1 ws1">168<span class="_ _c6"> </span>A8<span class="_ _6d"> </span>¿</div><div class="t m0 x7a h80 y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">169<span class="_ _c6"> </span>A9<span class="_ _6d"> </span><span class="ffc5">⌐</span></div><div class="t m0 x7a h7c y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">170<span class="_ _c6"> </span>AA<span class="_ _6d"> </span>¬</div><div class="t m0 x7a h7c y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">171<span class="_ _c6"> </span>AB<span class="_ _ee"> </span>½</div><div class="t m0 x7a h7c y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">172<span class="_ _c6"> </span>AC<span class="_ _ee"> </span>¼</div><div class="t m0 x7a h7c y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">173<span class="_ _c6"> </span>AD<span class="_ _ee"> </span>¡</div><div class="t m0 x7b h20 y169d ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 xd h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a8" class="pf w2 h6" data-page-no="1a8"><div class="pc pc1a8 w2 h6"><img class="bi x44 y169e w19 h81" alt="" src="bg1a8.png"/><div class="t m0 x17 hd y3f ffbf fs7 fc3 sc0 ls1 ws1">415</div><div class="t m0 x44 h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x44 h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">174<span class="_ _c6"> </span>AE<span class="_ _eb"> </span>«</div><div class="t m0 x44 h7c y15cf ffc4 fs7 fc3 sc0 ls1 ws1">175<span class="_ _c6"> </span>AF<span class="_ _eb"> </span>»</div><div class="t m0 x44 h7c y169f ffc4 fs7 fc3 sc0 ls1 ws1">176<span class="_ _c6"> </span>B0</div><div class="t m0 x29 h7c y16a0 ffc4 fs7 fc3 sc0 ls1 ws1"> </div><div class="t m0 x44 h7c y16a1 ffc4 fs7 fc3 sc0 ls1 ws1">177<span class="_ _c6"> </span>B1</div><div class="t m0 x29 h7c y16a2 ffc4 fs7 fc3 sc0 ls1 ws1"> </div><div class="t m0 x44 h7c y16a3 ffc4 fs7 fc3 sc0 ls1 ws1">178<span class="_ _c6"> </span>B2</div><div class="t m0 x29 h7c y16a4 ffc4 fs7 fc3 sc0 ls1 ws1"> </div><div class="t m0 x44 h80 y16a5 ffc4 fs7 fc3 sc0 ls1 ws1">179<span class="_ _c6"> </span>B3<span class="_ _6d"> </span><span class="ffc5">│</span></div><div class="t m0 x44 h80 y16a6 ffc4 fs7 fc3 sc0 ls1 ws1">180<span class="_ _c6"> </span>B4<span class="_ _6d"> </span><span class="ffc5">┤</span></div><div class="t m0 x44 h80 y16a7 ffc4 fs7 fc3 sc0 ls1 ws1">181<span class="_ _c6"> </span>B5<span class="_ _6d"> </span><span class="ffc5">╡</span></div><div class="t m0 x44 h80 y16a8 ffc4 fs7 fc3 sc0 ls1 ws1">182<span class="_ _c6"> </span>B6<span class="_ _6d"> </span><span class="ffc5">╢</span></div><div class="t m0 x44 h80 y16a9 ffc4 fs7 fc3 sc0 ls1 ws1">183<span class="_ _c6"> </span>B7<span class="_ _6d"> </span><span class="ffc5">╖</span></div><div class="t m0 x44 h80 y16aa ffc4 fs7 fc3 sc0 ls1 ws1">184<span class="_ _c6"> </span>B8<span class="_ _6d"> </span><span class="ffc5">╕</span></div><div class="t m0 x44 h80 y16ab ffc4 fs7 fc3 sc0 ls1 ws1">185<span class="_ _c6"> </span>B9<span class="_ _6d"> </span><span class="ffc5">╣</span></div><div class="t m0 x44 h80 y16ac ffc4 fs7 fc3 sc0 ls1 ws1">186<span class="_ _c6"> </span>BA<span class="_ _ee"> </span><span class="ffc5">║</span></div><div class="t m0 x44 h80 y16ad ffc4 fs7 fc3 sc0 ls1 ws1">187<span class="_ _c6"> </span>BB<span class="_ _ee"> </span><span class="ffc5">╗</span></div><div class="t m0 x44 h80 y16ae ffc4 fs7 fc3 sc0 ls1 ws1">188<span class="_ _c6"> </span>BC<span class="_ _ee"> </span><span class="ffc5">╝</span></div><div class="t m0 x44 h80 y16af ffc4 fs7 fc3 sc0 ls1 ws1">189<span class="_ _c6"> </span>BD<span class="_ _52"> </span><span class="ffc5">╜</span></div><div class="t m0 x44 h80 y16b0 ffc4 fs7 fc3 sc0 ls1 ws1">190<span class="_ _c6"> </span>BE<span class="_ _6d"> </span><span class="ffc5">╛</span></div><div class="t m0 x44 h80 y16b1 ffc4 fs7 fc3 sc0 ls1 ws1">191<span class="_ _c6"> </span>BF<span class="_ _eb"> </span><span class="ffc5">┐</span></div><div class="t m0 x44 h80 y16b2 ffc4 fs7 fc3 sc0 ls1 ws1">192<span class="_ _c6"> </span>C0<span class="_ _6d"> </span><span class="ffc5">└</span></div><div class="t m0 x44 h80 y16b3 ffc4 fs7 fc3 sc0 ls1 ws1">193<span class="_ _c6"> </span>C1<span class="_ _6d"> </span><span class="ffc5">┴</span></div><div class="t m0 x44 h80 y16b4 ffc4 fs7 fc3 sc0 ls1 ws1">194<span class="_ _c6"> </span>C2<span class="_ _6d"> </span><span class="ffc5">┬</span></div><div class="t m0 x79 h20 y16b5 ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 x40 h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1a9" class="pf w2 h6" data-page-no="1a9"><div class="pc pc1a9 w2 h6"><img class="bi x7a y169b w19 h7f" alt="" src="bg1a9.png"/><div class="t m0 xd hd y3f ffbf fs7 fc3 sc0 ls1 ws1">416</div><div class="t m0 x7a h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x7a h80 y15ce ffc4 fs7 fc3 sc0 ls1 ws1">195<span class="_ _c6"> </span>C3<span class="_ _6d"> </span><span class="ffc5">├</span></div><div class="t m0 x7a h80 y15cf ffc4 fs7 fc3 sc0 ls1 ws1">196<span class="_ _c6"> </span>C4<span class="_ _6d"> </span><span class="ffc5">─</span></div><div class="t m0 x7a h80 y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">197<span class="_ _c6"> </span>C5<span class="_ _6d"> </span><span class="ffc5">┼</span></div><div class="t m0 x7a h80 y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">198<span class="_ _c6"> </span>C6<span class="_ _6d"> </span><span class="ffc5">╞</span></div><div class="t m0 x7a h80 y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">199<span class="_ _c6"> </span>C7<span class="_ _6d"> </span><span class="ffc5">╟</span></div><div class="t m0 x7a h80 y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">200<span class="_ _c6"> </span>C8<span class="_ _6d"> </span><span class="ffc5">╚</span></div><div class="t m0 x7a h80 y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">201<span class="_ _c6"> </span>C9<span class="_ _6d"> </span><span class="ffc5">╔</span></div><div class="t m0 x7a h80 y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">202<span class="_ _c6"> </span>CA<span class="_ _ee"> </span><span class="ffc5">╩</span></div><div class="t m0 x7a h80 y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">203<span class="_ _c6"> </span>CB<span class="_ _ee"> </span><span class="ffc5">╦</span></div><div class="t m0 x7a h80 y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">204<span class="_ _c6"> </span>CC<span class="_ _ee"> </span><span class="ffc5">╠</span></div><div class="t m0 x7a h80 y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">205<span class="_ _c6"> </span>CD<span class="_ _52"> </span><span class="ffc5">═</span></div><div class="t m0 x7a h80 y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">206<span class="_ _c6"> </span>CE<span class="_ _6d"> </span><span class="ffc5">╬</span></div><div class="t m0 x7a h80 y15da ffc4 fs7 fc3 sc0 ls1 ws1">207<span class="_ _c6"> </span>CF<span class="_ _eb"> </span><span class="ffc5">╧</span></div><div class="t m0 x7a h80 y15db ffc4 fs7 fc3 sc0 ls1 ws1">208<span class="_ _c6"> </span>D0<span class="_ _ee"> </span><span class="ffc5">╨</span></div><div class="t m0 x7a h80 y15dc ffc4 fs7 fc3 sc0 ls1 ws1">209<span class="_ _c6"> </span>D1<span class="_ _ee"> </span><span class="ffc5">╤</span></div><div class="t m0 x7a h80 y15dd ffc4 fs7 fc3 sc0 ls1 ws1">210<span class="_ _c6"> </span>D2<span class="_ _ee"> </span><span class="ffc5">╥</span></div><div class="t m0 x7a h80 y15de ffc4 fs7 fc3 sc0 ls1 ws1">211<span class="_ _c6"> </span>D3<span class="_ _ee"> </span><span class="ffc5">╙</span></div><div class="t m0 x7a h80 y15df ffc4 fs7 fc3 sc0 ls1 ws1">212<span class="_ _c6"> </span>D4<span class="_ _ee"> </span><span class="ffc5">╘</span></div><div class="t m0 x7a h80 y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">213<span class="_ _c6"> </span>D5<span class="_ _ee"> </span><span class="ffc5">╒</span></div><div class="t m0 x7a h80 y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">214<span class="_ _c6"> </span>D6<span class="_ _ee"> </span><span class="ffc5">╓</span></div><div class="t m0 x7a h80 y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">215<span class="_ _c6"> </span>D7<span class="_ _ee"> </span><span class="ffc5">╫</span></div><div class="t m0 x7a h80 y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">216<span class="_ _c6"> </span>D8<span class="_ _ee"> </span><span class="ffc5">╪</span></div><div class="t m0 x7a h80 y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">217<span class="_ _c6"> </span>D9<span class="_ _ee"> </span><span class="ffc5">┘</span></div><div class="t m0 x7b h20 y169d ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 xd h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1aa" class="pf w2 h6" data-page-no="1aa"><div class="pc pc1aa w2 h6"><img class="bi x44 y169b w19 h7f" alt="" src="bg1aa.png"/><div class="t m0 x17 hd y3f ffbf fs7 fc3 sc0 ls1 ws1">417</div><div class="t m0 x44 h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x44 h80 y15ce ffc4 fs7 fc3 sc0 ls1 ws1">218<span class="_ _c6"> </span>DA<span class="_ _ee"> </span><span class="ffc5">┌</span></div><div class="t m0 x44 h80 y15cf ffc4 fs7 fc3 sc0 ls1 ws1">219<span class="_ _c6"> </span>DB<span class="_ _52"> </span><span class="ffc5">█</span></div><div class="t m0 x44 h80 y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">220<span class="_ _c6"> </span>DC<span class="_ _52"> </span><span class="ffc5">▄</span></div><div class="t m0 x44 h80 y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">221<span class="_ _c6"> </span>DD<span class="_ _98"> </span><span class="ffc5">▌</span></div><div class="t m0 x44 h80 y15d2 ffc4 fs7 fc3 sc0 ls1 ws1">222<span class="_ _c6"> </span>DE<span class="_ _ee"> </span><span class="ffc5">▐</span></div><div class="t m0 x44 h80 y15d3 ffc4 fs7 fc3 sc0 ls1 ws1">223<span class="_ _c6"> </span>DF<span class="_ _6d"> </span><span class="ffc5">▀</span></div><div class="t m0 x44 h80 y15d4 ffc4 fs7 fc3 sc0 ls1 ws1">224<span class="_ _c6"> </span>E0<span class="_ _eb"> </span><span class="ffc5">α</span></div><div class="t m0 x44 h7c y15d5 ffc4 fs7 fc3 sc0 ls1 ws1">225<span class="_ _c6"> </span>E1<span class="_ _eb"> </span>ß</div><div class="t m0 x44 h80 y15d6 ffc4 fs7 fc3 sc0 ls1 ws1">226<span class="_ _c6"> </span>E2<span class="_ _eb"> </span><span class="ffc5">Γ</span></div><div class="t m0 x44 h80 y15d7 ffc4 fs7 fc3 sc0 ls1 ws1">227<span class="_ _c6"> </span>E3<span class="_ _eb"> </span><span class="ffc5">π</span></div><div class="t m0 x44 h80 y15d8 ffc4 fs7 fc3 sc0 ls1 ws1">228<span class="_ _c6"> </span>E4<span class="_ _eb"> </span><span class="ffc5">Σ</span></div><div class="t m0 x44 h80 y15d9 ffc4 fs7 fc3 sc0 ls1 ws1">229<span class="_ _c6"> </span>E5<span class="_ _eb"> </span><span class="ffc5">σ</span></div><div class="t m0 x44 h80 y15da ffc4 fs7 fc3 sc0 ls1 ws1">230<span class="_ _c6"> </span>E6<span class="_ _eb"> </span><span class="ffc5">μ</span></div><div class="t m0 x44 h80 y15db ffc4 fs7 fc3 sc0 ls1 ws1">231<span class="_ _c6"> </span>E7<span class="_ _eb"> </span><span class="ffc5">τ</span></div><div class="t m0 x44 h80 y15dc ffc4 fs7 fc3 sc0 ls1 ws1">232<span class="_ _c6"> </span>E8<span class="_ _eb"> </span><span class="ffc5">Φ</span></div><div class="t m0 x44 h80 y15dd ffc4 fs7 fc3 sc0 ls1 ws1">233<span class="_ _c6"> </span>E9<span class="_ _eb"> </span><span class="ffc5">Θ</span></div><div class="t m0 x44 h80 y15de ffc4 fs7 fc3 sc0 ls1 ws1">234<span class="_ _c6"> </span>EA<span class="_ _eb"> </span><span class="ffc5">Ω</span></div><div class="t m0 x44 h80 y15df ffc4 fs7 fc3 sc0 ls1 ws1">235<span class="_ _c6"> </span>EB<span class="_ _6d"> </span><span class="ffc5">δ</span></div><div class="t m0 x44 h80 y15e0 ffc4 fs7 fc3 sc0 ls1 ws1">236<span class="_ _c6"> </span>EC<span class="_ _6d"> </span><span class="ffc5">∞</span></div><div class="t m0 x44 h80 y15e1 ffc4 fs7 fc3 sc0 ls1 ws1">237<span class="_ _c6"> </span>ED<span class="_ _ee"> </span><span class="ffc5">φ</span></div><div class="t m0 x44 h80 y15e2 ffc4 fs7 fc3 sc0 ls1 ws1">238<span class="_ _c6"> </span>EE<span class="_ _3b"> </span><span class="ffc5">ε</span></div><div class="t m0 x44 h80 y15e3 ffc4 fs7 fc3 sc0 ls1 ws1">239<span class="_ _c6"> </span>EF<span class="_ _3b"> </span><span class="ffc5">∩</span></div><div class="t m0 x44 h80 y15e4 ffc4 fs7 fc3 sc0 ls1 ws1">240<span class="_ _c6"> </span>F0<span class="_ _3b"> </span><span class="ffc5">≡</span></div><div class="t m0 x79 h20 y169c ffbf fs3 fc3 sc0 ls1 ws1">(<span class="ffc0">continued</span>)</div><div class="t m0 x40 h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1ab" class="pf w2 h6" data-page-no="1ab"><div class="pc pc1ab w2 h6"><img class="bi x7a y16b6 w19 h82" alt="" src="bg1ab.png"/><div class="t m0 xd hd y3f ffbf fs7 fc3 sc0 ls1 ws1">418</div><div class="t m0 x7a h10 y1532 ffc3 fs7 fc3 sc0 ls1 ws1">Dec<span class="_ _e9"> </span><span class="ls12 wsc9">Hex<span class="_ _ea"> </span></span>Char<span class="_ _98"> </span>Description</div><div class="t m0 x7a h7c y15ce ffc4 fs7 fc3 sc0 ls1 ws1">241<span class="_ _c6"> </span>F1<span class="_ _3b"> </span>±</div><div class="t m0 x7a h80 y15cf ffc4 fs7 fc3 sc0 ls1 ws1">242<span class="_ _c6"> </span>F2<span class="_ _3b"> </span><span class="ffc5">≥</span></div><div class="t m0 x7a h80 y15d0 ffc4 fs7 fc3 sc0 ls1 ws1">243<span class="_ _c6"> </span>F3<span class="_ _3b"> </span><span class="ffc5">≤</span></div><div class="t m0 x7a h7c y15d1 ffc4 fs7 fc3 sc0 ls1 ws1">244<span class="_ _c6"> </span>F4</div><div class="t m0 x64 h83 y16b7 ffc6 fs7 fc3 sc0 ls1 ws1">⌠</div><div class="t m0 x7a h7c y16b8 ffc4 fs7 fc3 sc0 ls1 ws1">245<span class="_ _c6"> </span>F5</div><div class="t m0 x64 h84 y16b9 ffc7 fs7 fc3 sc0 ls1 ws1">⌡</div><div class="t m0 x7a h7c y16ba ffc4 fs7 fc3 sc0 ls1 ws1">246<span class="_ _c6"> </span>F6<span class="_ _3b"> </span>÷</div><div class="t m0 x7a h80 y16bb ffc4 fs7 fc3 sc0 ls1 ws1">247<span class="_ _c6"> </span>F7<span class="_ _3b"> </span><span class="ffc5">≈</span></div><div class="t m0 x7a h7c y16bc ffc4 fs7 fc3 sc0 ls1 ws1">248<span class="_ _c6"> </span>F8<span class="_ _3b"> </span>°</div><div class="t m0 x7a h80 y16bd ffc4 fs7 fc3 sc0 ls1 ws1">249<span class="_ _c6"> </span>F9<span class="_ _3b"> </span><span class="ffc5">∙</span></div><div class="t m0 x7a h7c y16be ffc4 fs7 fc3 sc0 ls1 ws1">250<span class="_ _c6"> </span><span class="ls28 wscb">FA<span class="_ _ed"> </span></span>·</div><div class="t m0 x7a h80 y16bf ffc4 fs7 fc3 sc0 ls1 ws1">251<span class="_ _c6"> </span>FB<span class="_ _eb"> </span><span class="ffc5">√</span></div><div class="t m0 x7a h80 y16c0 ffc4 fs7 fc3 sc0 ls1 ws1">252<span class="_ _c6"> </span>FC<span class="_ _eb"> </span><span class="ffc5">ⁿ</span></div><div class="t m0 x7a h7c y16c1 ffc4 fs7 fc3 sc0 ls1 ws1">253<span class="_ _c6"> </span>FD</div><div class="t m0 x64 h85 y16c2 ffc4 fsd fc3 sc0 ls1 ws1">2</div><div class="t m0 x7a h80 y16c3 ffc4 fs7 fc3 sc0 ls1 ws1">254<span class="_ _c6"> </span>FE<span class="_ _3b"> </span><span class="ffc5">■</span></div><div class="t m0 x7a h7c y16c4 ffc4 fs7 fc3 sc0 ls1 ws1">255<span class="_ _c6"> </span>FF</div><div class="t m0 xd h7e y28b ffc4 fsa fc3 sc0 ls1 ws1">APPENDIX D <span class="_ _f"> </span> <span class="_ _1"></span>ASCII CHARACTER SET</div></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1ac" class="pf w2 h6" data-page-no="1ac"><div class="pc pc1ac w2 h6"><div class="t m0 x17 h86 y16a ffc8 fs7 fc3 sc0 ls1 ws1">419</div><div class="t m0 xc h87 y16b ffc8 fsc fc3 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h87 y16c ffc8 fsc fc3 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ffc9">Programmin<span class="_ _3"></span>g with 64-Bit ARM Assembly Language<span class="ffc8">,  </span></span></div><div class="t m0 xc h87 y16d ffc8 fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1</div><div class="t m0 xc h88 y12a ffca fs9 fc3 sc0 ls1 wsdf"> Ans<span class="_ _1"></span>w<span class="_ _1"></span>ers <span class="_ _f2"> </span>toEx<span class="_ _1"></span>er<span class="_ _3"></span>cises</div><div class="t m0 xc h86 y16c5 ffc8 fs7 fc3 sc0 ls1 ws1">This appendix has answers to selected exer<span class="_ _3"></span>cises. F<span class="_ _1"></span>or program code, check </div><div class="t m0 xc h86 y16c6 ffc8 fs7 fc3 sc0 ls1 ws1">the online source code at the A<span class="_ _1"></span>press GitH<span class="_ _3"></span>ub site.</div><div class="t m0 xc h15 y16c7 ffcb fsb fc3 sc0 ls1 wsaf"> Chapter <span class="_ _11"> </span><span class="fc5 ws1">1</span></div><div class="t m0 xc h18 y16c8 ffcc fs7 fc3 sc0 ls1 ws1">1-1. 0100 1101 0010, 0x4d2</div><div class="t m0 xc h86 y16c9 ffc8 fs7 fc3 sc0 ls1 ws1">1-6. 8192 instructions, 1,336,934 instructions</div><div class="t m0 xc h15 y16ca ffcb fsb fc3 sc0 ls1 wsaf"> Chapter <span class="_ _11"> </span><span class="fc5 ws1">2</span></div><div class="t m0 xc h18 y16cb ffcc fs7 fc3 sc0 ls1 ws1">2-1. 177 (0xb1), 233 (0xe9)</div><div class="t m0 xc h18 y16cc ffcc fs7 fc3 sc0 ls1 ws1">2-2. -14, -125</div><div class="t m0 xc h18 y16cd ffcc fs7 fc3 sc0 ls1 ws1">2-3. 0x78563412</div><div class="t m0 xc h18 y16ce ffcc fs7 fc3 sc0 ls1 ws1">2-4. 0x118</div><div class="t m0 xc h18 y16cf ffcc fs7 fc3 sc0 ls1 ws1">2-5. 0x218</div><div class="t m0 xc h18 y16d0 ffcc fs7 fc3 sc0 ls1 ws1">2-6. ADDS    X1, X3, X5    // Lower order 64-bits</div><div class="t m0 xc h18 y16d1 ffcc fs7 fc3 sc0 ls1 ws1">     ADCS    X6, X7, X8    // Middle order 64-bits</div><div class="t m0 xc h18 y16d2 ffcc fs7 fc3 sc0 ls1 ws1">     ADC     X0, X2, X4    // Higher order 64-bits</div><div class="t m0 xc h18 y16d3 ffcc fs7 fc3 sc0 ls1 ws1">2-7. SUBS    X1, X3, X5    // Lower order 64-bits</div><div class="t m0 xc h18 y16d4 ffcc fs7 fc3 sc0 ls1 ws1">     SBC     X0, X2, X4    // Higher order 64-bits</div><a class="l" href="https://doi.org/10.1007/978-1-4842-5881-1"><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:156.340000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:120.999000px;bottom:426.830000px;width:9.600000px;height:23.700000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf31" data-dest-detail='[49,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:120.999000px;bottom:330.830000px;width:9.600000px;height:23.700000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1ad" class="pf w2 h6" data-page-no="1ad"><div class="pc pc1ad w2 h6"><div class="t m0 xd h86 y3f ffc8 fs7 fc3 sc0 ls1 ws1">420</div><div class="t m0 xd h15 y186 ffcb fsb fc3 sc0 ls1 wsaf"> Chapter <span class="_ _11"> </span><span class="fc5 ws1">5</span></div><div class="t m0 xd h86 y187 ffc8 fs7 fc3 sc0 ls1 ws1">5-2. The <span class="ffcd">LDR</span> instruction either pro<span class="_ _3"></span>vides an offset to the <span class="ffcd ls10 ws37">PC</span> dir<span class="_ _3"></span>ectly from </div><div class="t m0 xd h86 y188 ffc8 fs7 fc3 sc0 ls1 ws1">the address or cr<span class="_ _1"></span>eates the address in the code section using indirection </div><div class="t m0 xd h86 y2be ffc8 fs7 fc3 sc0 ls1 ws1">from the <span class="ffcd ls10 ws37">PC<span class="_ _3"></span><span class="ffc8 ls1 ws1"> to load this value<span class="_ _3"></span>.</span></span></div><div class="t m0 xd h15 y16d5 ffcb fsb fc3 sc0 ls1 wsaf"> Chapter <span class="_ _11"> </span><span class="fc5 ws1">6</span></div><div class="t m0 xd h18 y16d6 ffcc fs7 fc3 sc0 ls1 ws1">6-1.   STP   X0, X1, [SP, #16]!</div><div class="t m0 xd h18 y16d7 ffcc fs7 fc3 sc0 ls1 ws1">       STR   X2, [SP, #16]!</div><div class="t m0 xd h18 y16d8 ffcc fs7 fc3 sc0 ls1 ws1">       LDR   X2, [SP], #-16</div><div class="t m0 xd h18 y16d9 ffcc fs7 fc3 sc0 ls1 ws1">       LDP   X0, X1, [SP], #-16</div><div class="t m0 xd h18 y16da ffcc fs7 fc3 sc0 ls1 ws1">6-2.   STP   X20, X23, [SP, #-16]!</div><div class="t m0 xd h18 y16db ffcc fs7 fc3 sc0 ls1 ws1">       STP   X27, LR, [SP, #-16]!</div><div class="t m0 xd h18 y16dc ffcc fs7 fc3 sc0 ls1 ws1">       ...</div><div class="t m0 xd h18 y16dd ffcc fs7 fc3 sc0 ls1 ws1">       LDP   X27, LR, [SP], #16</div><div class="t m0 xd h18 y16de ffcc fs7 fc3 sc0 ls1 ws1">       LDP   X20, X23, [SP], #16</div><div class="t m0 xd h86 y16df ffc8 fs7 fc3 sc0 ls1 ws1">6-5. This allows clever r<span class="_ _3"></span>egister usage to a<span class="_ _3"></span>void fr<span class="_ _3"></span>equent pushing and </div><div class="t m0 xd h86 y16e0 ffc8 fs7 fc3 sc0 ls1 ws1">popping to and from the stac<span class="_ _3"></span>k.</div><div class="t m0 xd h15 y16e1 ffcb fsb fc3 sc0 ls1 wsaf"> Chapter <span class="_ _11"> </span><span class="fc5 ws1">8</span></div><div class="t m0 xd h86 y16e2 ffc8 fs7 fc3 sc0 ls1 ws1">8-1. Get/set the IP address, and config<span class="_ _3"></span>ure various T<span class="_ _3"></span>CP/IP network options </div><div class="t m0 xd h86 y16e3 ffc8 fs7 fc3 sc0 ls1 ws1">like whether you wan<span class="_ _3"></span>t to receive br<span class="_ _1"></span>oadcast packets.</div><div class="t m0 xd h86 y16e4 ffc8 fs7 fc3 sc0 ls1 ws1">8-2. The main constr<span class="_ _3"></span>aint is usually making the electr<span class="_ _1"></span>onics inexpensive, </div><div class="t m0 xd h86 y16e5 ffc8 fs7 fc3 sc0 ls1 ws1">and this is done at the expense of ease of progr<span class="_ _3"></span>amming.</div><div class="t m0 xd h86 y16e6 ffc8 fs7 fc3 sc0 ls1 ws1">8-3. Any access to physic<span class="_ _3"></span>al memory and hardware r<span class="_ _1"></span>egisters is dangerous </div><div class="t m0 xd h86 y16e7 ffc8 fs7 fc3 sc0 ls1 ws1">and discouraged. Safe access is alw<span class="_ _3"></span>ays thr<span class="_ _3"></span>ough a device driver that </div><div class="t m0 xd h86 y16e8 ffc8 fs7 fc3 sc0 ls1 ws1">enforces Linux security.</div><div class="t m0 xd h12 y71 ffce fsa fc3 sc0 ls1 wsb7">ANSWERS TOEXERCISES</div><a class="l" href="#pf7e" data-dest-detail='[126,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:102.999000px;bottom:569.382000px;width:9.600000px;height:23.700000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf97" data-dest-detail='[151,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:102.999000px;bottom:465.382000px;width:9.600000px;height:23.700000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:102.999000px;bottom:225.382000px;width:9.600000px;height:23.700000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1ae" class="pf w2 h6" data-page-no="1ae"><div class="pc pc1ae w2 h6"><div class="t m0 x17 h86 y3f ffc8 fs7 fc3 sc0 ls1 ws1">421</div><div class="t m0 xc h15 y186 ffcb fsb fc3 sc0 ls1 wsaf"> Chapter <span class="_ _11"> </span><span class="fc5 ws1">14</span></div><div class="t m0 xc h86 y187 ffc8 fs7 fc3 sc0 ls1 ws1">14-1. <span class="ffcd">W5</span> is still shifted for all non-lower<span class="_ _1"></span>-case letters<span class="_ _0"></span>; these need to be </div><div class="t m0 xc h86 y188 ffc8 fs7 fc3 sc0 ls1 ws1">shifted back in an else clause adding complexity again.</div><div class="t m0 xc h86 y2be ffc8 fs7 fc3 sc0 ls1 ws1">14-3. If you use instructions added in a newer version of the ARM </div><div class="t m0 xc h86 y18a ffc8 fs7 fc3 sc0 ls1 ws1">architectur<span class="_ _1"></span>e, then you will get an illegal instruction exception if you </div><div class="t m0 xc h86 y18b ffc8 fs7 fc3 sc0 ls1 ws1">run your progr<span class="_ _3"></span>am on any ARM processor using an e<span class="_ _3"></span>arlier version of the </div><div class="t m0 xc h86 y732 ffc8 fs7 fc3 sc0 ls1 ws1">architectur<span class="_ _1"></span>e. Make s<span class="_ _3"></span>ure you don’t limit y<span class="_ _3"></span>our target audience b<span class="_ _3"></span>y eliminating </div><div class="t m0 xc h86 y733 ffc8 fs7 fc3 sc0 ls1 ws1">too many customers<span class="_ _1"></span>. O<span class="_ _0"></span>n the pr<span class="_ _3"></span>o side, yo<span class="_ _3"></span>u could get better performance </div><div class="t m0 xc h86 y734 ffc8 fs7 fc3 sc0 ls1 ws1">and more compact code<span class="_ _1"></span>.</div><div class="t m0 x7c h12 y71 ffce fsa fc3 sc0 ls1 wsb7">ANSWERS TOEXERCISES</div><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",53,607,null]'><div class="d m1" style="border-style:none;position:absolute;left:120.999000px;bottom:569.382000px;width:19.200000px;height:23.700000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1af" class="pf w2 h6" data-page-no="1af"><div class="pc pc1af w2 h6"><div class="t m0 x17 hd y16a ffcf fs7 fc7 sc0 ls1 ws1">423</div><div class="t m0 xc h17 y16b ffcf fsc fc7 sc0 ls1 ws1">© Stephen Smith 2020 </div><div class="t m0 xc h17 y16c ffcf fsc fc7 sc0 ls1 ws1">S. Smith<span class="_ _3"></span>, <span class="ffd0">Programmin<span class="_ _3"></span>g with <span class="fc8">64<span class="fc5">-</span></span>Bit ARM Assembly Language<span class="ffcf">,  </span></span></div><div class="t m0 xc h17 y16d ffcf fsc fc5 sc0 ls1 ws1">https://doi.org/10.1007/978-1-4842-5881-1</div><div class="t m0 xc h88 y12a ffd1 fs9 fc7 sc0 ls1 ws1">Inde<span class="_ _6"></span>x</div><div class="t m0 xc h2a y16e9 ffd2 fsf fc7 sc0 ls1 ws1">A</div><div class="t m0 xc hd y16ea ffcf fs7 fc7 sc0 ls1 ws1">Acorn computer<span class="_ _10"></span>, <span class="fc5">1</span></div><div class="t m0 xc hd y16eb ffcf fs7 fc7 sc0 ls1 ws1">Addr<span class="_ _3"></span>ess space layo<span class="_ _3"></span>ut </div><div class="t m0 x7d hd y16ec ffcf fs7 fc7 sc0 ls1 ws1">randomization (ASLR), <span class="fc5">357</span></div><div class="t m0 xc hd y16ed ffcf fs7 fc7 sc0 ls1 ws1">ADRP instruction, <span class="fc5">338</span></div><div class="t m0 xc hd y16ee ffcf fs7 fc7 sc0 ls1 ws1">Android applic<span class="_ _3"></span>ation</div><div class="t m0 x7e hd y16ef ffcf fs7 fc7 sc0 ls1 ws1">building pr<span class="_ _3"></span>oject, <span class="fc5">236,</span> <span class="fc5">237,</span> <span class="fc5">239</span></div><div class="t m0 x7e hd y16f0 ffcf fs7 fc7 sc0 ls1d ws1">C/Assembly Language code<span class="_ _3"></span>, <span class="fc5">247</span></div><div class="t m0 x7e hd y16f1 ffcf fs7 fc7 sc0 ls1 ws1">C++ wrapper<span class="_ _10"></span>, <span class="fc5">235,</span> <span class="fc5">236</span></div><div class="t m0 x7e hd y16f2 ffcf fs7 fc7 sc0 ls1 ws1">Gradle build system<span class="_ _1"></span>, <span class="fc5">227</span></div><div class="t m0 x7e hd y16f3 ffcf fs7 fc7 sc0 ls1 ws1">J<span class="_ _1"></span>ava/K<span class="_ _3"></span>otlin progr<span class="_ _3"></span>amming </div><div class="t m0 x7f hd y16f4 ffcf fs7 fc7 sc0 ls1 ws1">languages<span class="_ _3"></span>, <span class="fc5">226</span></div><div class="t m0 x7e hd y16f5 ffcf fs7 fc7 sc0 ls1 ws1">Kotlin pr<span class="_ _1"></span>ogram, <span class="fc5">233,</span> <span class="fc5">235</span></div><div class="t m0 x7e hd y16f6 ffcf fs7 fc7 sc0 ls1 ws1">progr<span class="_ _3"></span>amming framework<span class="_ _3"></span>, <span class="fc5">226</span></div><div class="t m0 x7e hd y16f7 ffcf fs7 fc7 sc0 ls1 ws1">project cr<span class="_ _3"></span>eation, <span class="fc5">227–230</span></div><div class="t m0 x7e hd y16f8 ffcf fs7 fc7 sc0 ls1 ws1">wrapper la<span class="_ _3"></span>yer<span class="_ _6"></span>, <span class="fc5">227</span></div><div class="t m0 x7e hd y16f9 ffcf fs7 fc7 sc0 ls1 ws1">xml screen definition,  </div><div class="t m0 x7f hd y16fa ffcf fs7 fc5 sc0 ls1 ws1">230,<span class="fc7"> </span>232,<span class="fc7"> </span>233</div><div class="t m0 xc hd y16fb ffcf fs7 fc7 sc0 ls1 ws1">ARM processor<span class="_ _10"></span>, <span class="fc5">1</span></div><div class="t m0 x7e hd y16fc ffcf fs7 fc7 sc0 ls1 ws1">assembly instructions  </div><div class="t m0 x7f hd y16fd ffcf fs7 fc7 sc0 ls1 ws1">(<span class="ffd0">see </span>Assembly instructions)</div><div class="t m0 x7e hd y16fe ffcf fs7 fc7 sc0 ls1 ws1">assembly language<span class="_ _3"></span>, <span class="fc5">4,</span> <span class="fc5">6</span></div><div class="t m0 x7e hd y16ff ffcf fs7 fc7 sc0 ls1 ws1">building/executing, <span class="fc5">19</span></div><div class="t m0 x7e hd y1700 ffcf fs7 fc7 sc0 ls1 ws1">common convention, <span class="fc5">20</span></div><div class="t m0 x7e hd y1701 ffcf fs7 fc7 sc0 ls1 ws1">data, <span class="fc5">22</span></div><div class="t m0 x7e hd y1702 ffcf fs7 fc7 sc0 ls1 ws1">Gnome calculator<span class="_ _10"></span>, <span class="fc5">10,</span> <span class="fc5">11</span></div><div class="t m0 x7e hd y1703 ffcf fs7 fc7 sc0 ls1 ws1">Hello W<span class="_ _1"></span>orld progr<span class="_ _3"></span>am, <span class="fc5">18,</span> <span class="fc5">19</span></div><div class="t m0 x7e hd y1704 ffcf fs7 fc7 sc0 ls1 ws1">hexadecimal digits<span class="_ _3"></span>, <span class="fc5">9</span></div><div class="t m0 x80 hd y1705 ffcf fs7 fc7 sc0 ls1 ws1">Linux shell, <span class="fc5">23</span></div><div class="t m0 x80 hd y1706 ffcf fs7 fc7 sc0 ls1 ws1">MOV<span class="_ _8"></span>, <span class="fc5">22</span></div><div class="t m0 x80 hd y1707 ffcf fs7 fc7 sc0 ls1 ws1">numbers<span class="_ _3"></span>, <span class="fc5">8</span></div><div class="t m0 x80 hd y1708 ffcf fs7 fc7 sc0 ls1 ws1">RISC-<span class="_ _1"></span>V architecture<span class="_ _1"></span>, <span class="fc5">3</span></div><div class="t m0 x80 hd y1709 ffcf fs7 fc7 sc0 ls1 ws1">64 bits, <span class="fc5">2</span></div><div class="t m0 x80 hd y170a ffcf fs7 fc7 sc0 ls1 ws1">specialty programs<span class="_ _1"></span>, <span class="fc5">7</span></div><div class="t m0 x80 hd y170b ffcf fs7 fc7 sc0 ls1 ws1">starting point, <span class="fc5">21</span></div><div class="t m0 x80 hd y170c ffcf fs7 fc7 sc0 ls1 ws1">text editor<span class="_ _6"></span>, <span class="fc5">7</span></div><div class="t m0 x68 hd y170d ffcf fs7 fc7 sc0 ls1 ws1">ARM 64-bit instruction,  </div><div class="t m0 x6b hd y170e ffcf fs7 fc5 sc0 ls1 ws1">367–381,<span class="fc7"> </span>383–386</div><div class="t m0 x68 hd y170f ffcf fs7 fc7 sc0 ls1 ws1">ARM 64-bit NEON/FPU </div><div class="t m0 x6b hd y1710 ffcf fs7 fc7 sc0 ls1 ws1">instructions, <span class="fc5">386–399</span></div><div class="t m0 x68 hd y1711 ffcf fs7 fc7 sc0 ls1 ws1">ASCII character set, <span class="fc5">407–418</span></div><div class="t m0 x68 hd y1712 ffcf fs7 fc7 sc0 ls1 ws1">asm statement<span class="_ _3"></span>, <span class="fc5">219,</span> <span class="fc5">221,</span> <span class="fc5">224</span></div><div class="t m0 x68 hd y1713 ffcf fs7 fc7 sc0 ls1 ws1">Assembly instructions</div><div class="t m0 x80 hd y1714 ffcf fs7 fc7 sc0 ls1 ws1">CPU register<span class="_ _10"></span>, <span class="fc5">12,</span> <span class="fc5">13</span></div><div class="t m0 x80 hd y1715 ffcf fs7 fc7 sc0 ls1 ws1">data pr<span class="_ _3"></span>ocessing format, <span class="fc5">14</span></div><div class="t m0 x80 hd y1716 ffcf fs7 fc7 sc0 ls1 ws1">execution pipeline, <span class="fc5">15</span></div><div class="t m0 x80 hd y1717 ffcf fs7 fc7 sc0 ls1 ws1">format, <span class="fc5">13</span></div><div class="t m0 x68 h2a y1718 ffd2 fsf fc7 sc0 ls1 ws1">B</div><div class="t m0 x68 hd y1719 ffcf fs7 fc7 sc0 ls1 ws1">Binary formats</div><div class="t m0 x80 hd y171a ffcf fs7 fc7 sc0 ls1 ws1">addresses<span class="_ _3"></span>, <span class="fc5">403</span></div><div class="t m0 x80 hd y171b ffcf fs7 fc7 sc0 ls1 ws1">floating point<span class="_ _3"></span>, <span class="fc5">402</span></div><div class="t m0 x80 hd y171c ffcf fs7 fc7 sc0 ls1 ws1">integer<span class="_ _6"></span>, <span class="fc5">401,</span> <span class="fc5">402</span></div><div class="t m0 x68 hd y171d ffcf fs7 fc7 sc0 ls1 ws1">Bit clear (BIC) opera<span class="_ _3"></span>tion, <span class="fc5">314</span></div><div class="t m0 x68 hd y171e ffcf fs7 fc7 sc0 ls1 ws1">Branch instruction, <span class="fc5">90,</span> <span class="fc5">91,</span> <span class="fc5">104,</span> <span class="fc5">105</span></div><a class="l" href="https://doi.org/10.1007/978-1-4842-5881-1"><div class="d m1" style="border-style:none;position:absolute;left:54.000000px;bottom:44.705800px;width:156.340000px;height:9.485900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:134.795000px;bottom:471.290000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf170" data-dest-detail='[368,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:199.110000px;bottom:441.700000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15d" data-dest-detail='[349,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:141.250000px;bottom:426.905000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffa" data-dest-detail='[250,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.698000px;bottom:397.315000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffb" data-dest-detail='[251,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:170.213000px;bottom:397.315000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffd" data-dest-detail='[253,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:191.729000px;bottom:397.315000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf105" data-dest-detail='[261,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:202.588000px;bottom:382.520000px;width:16.390000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff9" data-dest-detail='[249,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:133.782000px;bottom:367.725000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffa" data-dest-detail='[250,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:155.298000px;bottom:367.725000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff1" data-dest-detail='[241,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:167.420000px;bottom:352.930000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff0" data-dest-detail='[240,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:143.539000px;bottom:323.340000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff7" data-dest-detail='[247,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:145.299000px;bottom:308.545000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff9" data-dest-detail='[249,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:166.815000px;bottom:308.545000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff0" data-dest-detail='[240,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:191.993000px;bottom:293.750000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff1" data-dest-detail='[241,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:147.961000px;bottom:278.955000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff4" data-dest-detail='[244,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:169.631000px;bottom:278.955000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff1" data-dest-detail='[241,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:137.522000px;bottom:264.160000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff4" data-dest-detail='[244,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:91.499000px;bottom:234.570000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff6" data-dest-detail='[246,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:113.015000px;bottom:234.570000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff7" data-dest-detail='[247,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:134.531000px;bottom:234.570000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:129.690000px;bottom:219.775000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19" data-dest-detail='[25,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:162.536000px;bottom:175.390000px;width:8.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1b" data-dest-detail='[27,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:173.052000px;bottom:175.390000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf28" data-dest-detail='[40,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:163.503000px;bottom:160.595000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf29" data-dest-detail='[41,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:172.017000px;bottom:145.800000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2b" data-dest-detail='[43,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:94.424900px;bottom:131.005000px;width:11.000100px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1f" data-dest-detail='[31,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:157.245000px;bottom:116.210000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf20" data-dest-detail='[32,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:173.261000px;bottom:116.210000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf27" data-dest-detail='[39,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:173.030000px;bottom:101.415000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf28" data-dest-detail='[40,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:189.046000px;bottom:101.415000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1e" data-dest-detail='[30,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:161.677000px;bottom:86.410600px;width:5.500000px;height:12.275900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2c" data-dest-detail='[44,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:308.925000px;bottom:493.488000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2b" data-dest-detail='[43,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:280.831000px;bottom:478.484000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1d" data-dest-detail='[29,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:299.817000px;bottom:463.480000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18" data-dest-detail='[24,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:350.372000px;bottom:448.476000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf17" data-dest-detail='[23,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:287.915000px;bottom:433.472000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1c" data-dest-detail='[28,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:346.170000px;bottom:418.468000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2a" data-dest-detail='[42,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:320.627000px;bottom:403.464000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1c" data-dest-detail='[28,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:304.349000px;bottom:388.460000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf17a" data-dest-detail='[378,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:272.394000px;bottom:358.452000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf188" data-dest-detail='[392,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:294.064000px;bottom:358.452000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18a" data-dest-detail='[394,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:315.580000px;bottom:358.452000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18d" data-dest-detail='[397,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:337.250000px;bottom:358.452000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18d" data-dest-detail='[397,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:333.486000px;bottom:328.444000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19a" data-dest-detail='[410,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:355.156000px;bottom:328.444000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1a0" data-dest-detail='[416,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:332.111000px;bottom:313.440000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1ab" data-dest-detail='[427,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:353.781000px;bottom:313.440000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe9" data-dest-detail='[233,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:311.245000px;bottom:298.436000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfeb" data-dest-detail='[235,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:332.761000px;bottom:298.436000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfee" data-dest-detail='[238,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:354.277000px;bottom:298.436000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf21" data-dest-detail='[33,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:315.458000px;bottom:268.428000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf22" data-dest-detail='[34,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:331.474000px;bottom:268.428000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf23" data-dest-detail='[35,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:364.705000px;bottom:253.424000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf24" data-dest-detail='[36,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:344.585000px;bottom:238.420000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf22" data-dest-detail='[34,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:289.191000px;bottom:223.416000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19d" data-dest-detail='[413,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:303.750000px;bottom:146.359000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19c" data-dest-detail='[412,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:320.581000px;bottom:131.355000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19b" data-dest-detail='[411,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:289.803000px;bottom:116.351000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19c" data-dest-detail='[412,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:311.319000px;bottom:116.351000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf146" data-dest-detail='[326,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:356.857000px;bottom:101.347000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6c" data-dest-detail='[108,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:330.765000px;bottom:86.342700px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6d" data-dest-detail='[109,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:346.781000px;bottom:86.342700px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7a" data-dest-detail='[122,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:362.797000px;bottom:86.342700px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7b" data-dest-detail='[123,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:384.313000px;bottom:86.342700px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1b0" class="pf w2 h6" data-page-no="1b0"><div class="pc pc1b0 w2 h6"><div class="t m0 xd hd y3f ffcf fs7 fc7 sc0 ls1 ws1">424</div><div class="t m0 xd hd y145 ffcf fs7 fc7 sc0 ls1 ws1">Buffer ov<span class="_ _3"></span>erflow hack</div><div class="t m0 x7a hd y171f ffcf fs7 fc7 sc0 ls1 ws1">causes<span class="_ _3"></span>, <span class="fc5">347</span></div><div class="t m0 x7a hd y1720 ffcf fs7 fc7 sc0 ls1 ws1">C runtime’<span class="_ _6"></span>s strcp<span class="_ _3"></span>y, <span class="fc5">355,</span> <span class="fc5">356</span></div><div class="t m0 x7a hd y1721 ffcf fs7 fc7 sc0 ls1 ws1">data leakages<span class="_ _3"></span>, <span class="fc5">362</span></div><div class="t m0 x7a hd y1722 ffcf fs7 fc7 sc0 ls1 ws1">DOS, <span class="fc5">348</span></div><div class="t m0 x7a hd y1723 ffcf fs7 fc7 sc0 ls1 ws1">PIE, <span class="fc5">357,</span> <span class="fc5">358,</span> <span class="fc5">363</span></div><div class="t m0 x7a hd y1724 ffcf fs7 fc7 sc0 ls1 ws1">protection technique<span class="_ _3"></span>, <span class="fc5">363</span></div><div class="t m0 x7a hd y1725 ffcf fs7 fc7 sc0 ls1 ws1">stack canaries<span class="_ _3"></span>, <span class="fc5">358–361,</span> <span class="fc5">364</span></div><div class="t m0 x7a hd y60f ffcf fs7 fc7 sc0 ls1 ws1">user interface module, <span class="fc5">363</span></div><div class="t m0 xd h2a y1726 ffd2 fsf fc7 sc0 ls1 ws1">C</div><div class="t m0 xd hd y1727 ffcf fs7 fc7 sc0 ls1 ws1">CBNZ instruction, <span class="fc5">338</span></div><div class="t m0 xd hd y1728 ffcf fs7 fc7 sc0 ls1 ws1">C functions</div><div class="t m0 x7a hd y1729 ffcf fs7 fc7 sc0 ls1 ws1">Assembly Language fr<span class="_ _3"></span>om </div><div class="t m0 x81 hd y172a ffcf fs7 fc7 sc0 ls1 ws1">python, calling<span class="_ _3"></span>, <span class="fc5">221–224</span></div><div class="t m0 x7a hd y172b ffcf fs7 fc7 sc0 ls1 ws1">Assembly Language r<span class="_ _3"></span>outines<span class="_ _3"></span>, </div><div class="t m0 x81 hd y172c ffcf fs7 fc7 sc0 ls1 ws1">calling, <span class="fc5">211,</span> <span class="fc5">213</span></div><div class="t m0 x7a hd y172d ffcf fs7 fc7 sc0 ls1 ws1">embedded Assembly  </div><div class="t m0 x81 hd y172e ffcf fs7 fc7 sc0 ls1 ws1">code, <span class="fc5">218–220</span></div><div class="t m0 x7a hd y172f ffcf fs7 fc7 sc0 ls1 ws1">print debug information, <span class="fc5">204</span></div><div class="t m0 x1b hd y1730 ffcf fs7 fc7 sc0 ls1 ws1">ADDS/ADC  </div><div class="t m0 x81 hd y241 ffcf fs7 fc7 sc0 ls1 ws1">instructions, <span class="fc5">209,</span> <span class="fc5">210</span></div><div class="t m0 x1b hd y1731 ffcf fs7 fc7 sc0 ls1 ws1">calling printf<span class="_ _3"></span>, <span class="fc5">208</span></div><div class="t m0 x1b hd y1732 ffcf fs7 fc7 sc0 ls1 ws1">C printf function, <span class="fc5">205,</span> <span class="fc5">206</span></div><div class="t m0 x1b hd y1733 ffcf fs7 fc7 sc0 ls1 ws1">passing string, <span class="fc5">208</span></div><div class="t m0 x1b hd yfa2 ffcf fs7 fc7 sc0 ls1 ws1">preserving state, <span class="fc5">207</span></div><div class="t m0 x7a hd y1734 ffcf fs7 fc7 sc0 ls1 ws1">runtime, <span class="fc5">203,</span> <span class="fc5">204</span></div><div class="t m0 xd hd y1735 ffcf fs7 fc7 sc0 ls1 ws1">C library’<span class="_ _1"></span>s strlen() function, <span class="fc5">174</span></div><div class="t m0 xd hd y1736 ffcf fs7 fc7 sc0 lse wsa9">CMP instruction, <span class="fc5">90,</span> <span class="fc5">91,</span> <span class="fc5">105,</span> <span class="fc5">283,</span> <span class="fc5">340</span></div><div class="t m0 xd hd y1737 ffcf fs7 fc7 sc0 ls1 ws1">Complex instruction set computer </div><div class="t m0 x82 hd y1738 ffcf fs7 fc7 sc0 ls1 ws1">(CISC<span class="_ _0"></span>), <span class="fc5">1</span></div><div class="t m0 xd hd y1739 ffcf fs7 fc7 sc0 ls1 ws1">Condition flags<span class="_ _3"></span>, <span class="fc5">88,</span> <span class="fc5">89</span></div><div class="t m0 xd hd y173a ffcf fs7 fc7 sc0 ls1 ws1">C printf function, <span class="fc5">205</span></div><div class="t m0 x83 h2a y173b ffd2 fsf fc7 sc0 ls1 ws1">D, E</div><div class="t m0 x83 hd y173c ffcf fs7 fc7 sc0 ls1 ws1">Data br<span class="_ _3"></span>eaches, <span class="fc5">364</span></div><div class="t m0 x83 hd y173d ffcf fs7 fc7 sc0 ls1 ws1">Denial of ser<span class="_ _0"></span>vice (DoS), <span class="fc5">348</span></div><div class="t m0 x83 hd y173e ffcf fs7 fc7 sc0 ls1 ws1">Division</div><div class="t m0 x31 hd y173f ffcf fs7 fc7 sc0 ls1 ws1">instructions, <span class="fc5">255,</span> <span class="fc5">267</span></div><div class="t m0 x31 hd y1740 ffcf fs7 fc7 sc0 ls1 ws1">MUL/SMULH, <span class="fc5">255–258</span></div><div class="t m0 x83 h2a y1741 ffd2 fsf fc7 sc0 ls1 ws1">F</div><div class="t m0 x83 hd y1742 ffcf fs7 fc7 sc0 ls1 ws1">F<span class="_ _6"></span>ADDP instr<span class="_ _0"></span>uction, <span class="fc5">299</span></div><div class="t m0 x83 hd y1743 ffcf fs7 fc7 sc0 ls1 ws1">Floating-<span class="_ _1"></span>point  </div><div class="t m0 x84 hd y1744 ffcf fs7 fc7 sc0 ls1 ws1">numbers<span class="_ _3"></span>, <span class="fc5">269,</span> <span class="fc5">270</span></div><div class="t m0 x31 hd y1745 ffcf fs7 fc7 sc0 ls1 ws1">comparison routine<span class="_ _3"></span>,  </div><div class="t m0 x3f hd y1746 ffcf fs7 fc5 sc0 ls1 ws1">282–284,<span class="fc7"> </span>286</div><div class="t m0 x31 hd y1747 ffcf fs7 fc7 sc0 ls1 ws1">conversions<span class="_ _1"></span>, <span class="fc5">281,</span> <span class="fc5">282</span></div><div class="t m0 x31 hd y1748 ffcf fs7 fc7 sc0 ls1 ws1">distance points<span class="_ _3"></span>, <span class="fc5">277–280</span></div><div class="t m0 x31 hd y1749 ffcf fs7 fc7 sc0 ls1 ws1">FCMP instructions, <span class="fc5">283</span></div><div class="t m0 x31 hd y174a ffcf fs7 fc7 sc0 ls1 ws1">FCV<span class="_ _0"></span>T instructions, <span class="fc5">281</span></div><div class="t m0 x31 hd y174b ffcf fs7 fc7 sc0 ls1 ws1">LDP instructions, <span class="fc5">280</span></div><div class="t m0 x31 hd y174c ffcf fs7 fc7 sc0 ls1 ws1">N<span class="_ _3"></span>aNs<span class="_ _1"></span>, <span class="fc5">271</span></div><div class="t m0 x31 hd y174d ffcf fs7 fc7 sc0 ls1 ws1">normalization, <span class="fc5">271</span></div><div class="t m0 x31 hd y174e ffcf fs7 fc7 sc0 ls1 ws1">roundin<span class="_ _3"></span>g error<span class="_ _10"></span>, <span class="fc5">271,</span> <span class="fc5">272</span></div><div class="t m0 x31 hd y174f ffcf fs7 fc7 sc0 ls1 ws1">single-/double- </div><div class="t m0 x3f hd y1750 ffcf fs7 fc7 sc0 ls1 ws1">precision, <span class="fc5">272</span></div><div class="t m0 x83 hd y1751 ffcf fs7 fc7 sc0 ls1 ws1">Floating-<span class="_ _1"></span>point unit (FPU), <span class="fc5">269</span></div><div class="t m0 x83 hd y1752 ffcf fs7 fc7 sc0 ls1 ws1">FMUL instruction, <span class="fc5">298</span></div><div class="t m0 x83 hd y1753 ffcf fs7 fc7 sc0 ls1 ws1">For loops<span class="_ _1"></span>, <span class="fc5">92,</span> <span class="fc5">93</span></div><div class="t m0 x83 hd y1754 ffcf fs7 fc7 sc0 ls1 ws1">fpcomp routine<span class="_ _1"></span>, <span class="fc5">287</span></div><div class="t m0 x83 hd y1755 ffcf fs7 fc7 sc0 ls1 ws1">FPU registers</div><div class="t m0 x31 hd y1756 ffcf fs7 fc7 sc0 ls1 ws1">arithmetic operations<span class="_ _3"></span>, <span class="fc5">276</span></div><div class="t m0 x31 hd y1757 ffcf fs7 fc7 sc0 ls1 ws1">FMOV instructions<span class="_ _3"></span>, <span class="fc5">275</span></div><div class="t m0 x31 hd y1758 ffcf fs7 fc7 sc0 ls1 ws1">LDR/STR instructions, <span class="fc5">274</span></div><div class="t m0 x83 hd y1759 ffcf fs7 fc7 sc0 ls1 ws1">FSUB instruction, <span class="fc5">298</span></div><div class="t m0 x83 hd y175a ffcf fs7 fc7 sc0 ls1 ws1">Function c<span class="_ _3"></span>all protocol, <span class="fc5">274</span></div><div class="t m0 xd h89 y71 ffd3 fsa fc7 sc0 ls1 ws1">INDEX</div><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:87.094800px;bottom:562.362000px;width:16.500200px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16e" data-dest-detail='[366,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:140.652000px;bottom:547.358000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16f" data-dest-detail='[367,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:162.168000px;bottom:547.358000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf175" data-dest-detail='[373,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:118.642000px;bottom:532.354000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf167" data-dest-detail='[359,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:77.722900px;bottom:517.350000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf170" data-dest-detail='[368,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:72.409800px;bottom:502.346000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf171" data-dest-detail='[369,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:93.925700px;bottom:502.346000px;width:19.250300px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf176" data-dest-detail='[374,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:115.442000px;bottom:502.346000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf176" data-dest-detail='[374,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:154.611000px;bottom:487.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf171" data-dest-detail='[369,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:121.479000px;bottom:472.338000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf174" data-dest-detail='[372,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:143.149000px;bottom:472.338000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf177" data-dest-detail='[375,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:164.665000px;bottom:472.338000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf176" data-dest-detail='[374,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:158.605000px;bottom:457.334000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15d" data-dest-detail='[349,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:123.448000px;bottom:397.362000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfeb" data-dest-detail='[235,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.187000px;bottom:352.350000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfee" data-dest-detail='[238,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:169.857000px;bottom:352.350000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe1" data-dest-detail='[225,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:109.733000px;bottom:322.342000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe3" data-dest-detail='[227,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:131.249000px;bottom:322.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe8" data-dest-detail='[232,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:101.120000px;bottom:292.334000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfea" data-dest-detail='[234,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:122.790000px;bottom:292.334000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfda" data-dest-detail='[218,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:169.516000px;bottom:277.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfdf" data-dest-detail='[223,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:134.602000px;bottom:247.322000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe0" data-dest-detail='[224,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:156.118000px;bottom:247.322000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfde" data-dest-detail='[222,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:130.708000px;bottom:232.318000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfdb" data-dest-detail='[219,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.903000px;bottom:217.314000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfdc" data-dest-detail='[220,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:170.419000px;bottom:217.314000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfde" data-dest-detail='[222,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:135.581000px;bottom:202.310000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfdd" data-dest-detail='[221,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:145.009000px;bottom:187.306000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd9" data-dest-detail='[217,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:94.012800px;bottom:172.302000px;width:19.250200px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfda" data-dest-detail='[218,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:115.529000px;bottom:172.302000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6c" data-dest-detail='[108,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:114.627000px;bottom:142.294000px;width:13.310000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6d" data-dest-detail='[109,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:129.741000px;bottom:142.294000px;width:13.310000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7b" data-dest-detail='[123,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:144.854000px;bottom:142.294000px;width:18.590000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf128" data-dest-detail='[296,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:165.248000px;bottom:142.294000px;width:18.590000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15f" data-dest-detail='[351,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:185.642000px;bottom:142.294000px;width:16.060000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:107.544000px;bottom:112.286000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6a" data-dest-detail='[106,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:112.217000px;bottom:97.281800px;width:13.750000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6b" data-dest-detail='[107,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:128.233000px;bottom:97.281800px;width:11.000000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfdb" data-dest-detail='[219,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:118.895000px;bottom:82.277800px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf177" data-dest-detail='[375,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:291.448000px;bottom:555.754000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf167" data-dest-detail='[359,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:332.729000px;bottom:540.750000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf10d" data-dest-detail='[269,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:295.781000px;bottom:510.742000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf119" data-dest-detail='[281,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:317.297000px;bottom:510.742000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf10d" data-dest-detail='[269,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:305.594000px;bottom:495.738000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf110" data-dest-detail='[272,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:327.264000px;bottom:495.738000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf137" data-dest-detail='[311,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:313.612000px;bottom:442.754000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:301.514000px;bottom:412.746000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11b" data-dest-detail='[283,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:323.030000px;bottom:412.746000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf127" data-dest-detail='[295,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:257.184000px;bottom:382.738000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf129" data-dest-detail='[297,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:278.854000px;bottom:382.738000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12b" data-dest-detail='[299,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:300.370000px;bottom:382.738000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf126" data-dest-detail='[294,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:295.970000px;bottom:367.734000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf127" data-dest-detail='[295,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:317.486000px;bottom:367.734000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf122" data-dest-detail='[290,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:310.917000px;bottom:352.730000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf125" data-dest-detail='[293,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:332.587000px;bottom:352.730000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf128" data-dest-detail='[296,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:327.417000px;bottom:337.726000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf126" data-dest-detail='[294,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:325.097000px;bottom:322.722000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf125" data-dest-detail='[293,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:318.595000px;bottom:307.718000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11c" data-dest-detail='[284,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:265.159000px;bottom:292.714000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11c" data-dest-detail='[284,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:306.364000px;bottom:277.710000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11c" data-dest-detail='[284,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:308.058000px;bottom:262.706000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11d" data-dest-detail='[285,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:329.574000px;bottom:262.706000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11d" data-dest-detail='[285,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:305.848000px;bottom:232.698000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:343.807000px;bottom:217.694000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf136" data-dest-detail='[310,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:308.365000px;bottom:202.690000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6e" data-dest-detail='[110,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:268.294000px;bottom:187.686000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6f" data-dest-detail='[111,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:284.310000px;bottom:187.686000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12c" data-dest-detail='[300,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:297.465000px;bottom:172.682000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf121" data-dest-detail='[289,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:341.014000px;bottom:142.674000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf120" data-dest-detail='[288,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:328.628000px;bottom:127.670000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11f" data-dest-detail='[287,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:342.499000px;bottom:112.666000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf136" data-dest-detail='[310,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:304.856000px;bottom:97.661800px;width:16.500000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11f" data-dest-detail='[287,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:327.780000px;bottom:82.657900px;width:16.500000px;height:12.275900px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbd" data-dest-detail='[189,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:166.911000px;bottom:158.537000px;width:18.654000px;height:10.800000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1b1" class="pf w2 h6" data-page-no="1b1"><div class="pc pc1b1 w2 h6"><div class="t m0 x17 hd y3f ffcf fs7 fc7 sc0 ls1 ws1">425</div><div class="t m0 xc h2a y173b ffd2 fsf fc7 sc0 ls1 ws1">G</div><div class="t m0 xc hd y173c ffcf fs7 fc7 sc0 ls1 ws1">GNC Compiler Collection (GCC), <span class="fc5">7</span></div><div class="t m0 x7e hd y173d ffcf fs7 fc7 sc0 ls1 ws1">ADD instruction, <span class="fc5">339</span></div><div class="t m0 x7e hd y173e ffcf fs7 fc7 sc0 ls1 ws1">ADRP instruction, <span class="fc5">338</span></div><div class="t m0 x7e hd y173f ffcf fs7 fc7 sc0 ls1 ws1">assembler<span class="_ _6"></span>, <span class="fc5">17</span></div><div class="t m0 x7e hd y1740 ffcf fs7 fc7 sc0 ls1 ws1">assembly code, <span class="fc5">336</span></div><div class="t m0 x7e hd y175b ffcf fs7 fc7 sc0 ls1 ws1">CBNZ instruction, <span class="fc5">338,</span> <span class="fc5">340</span></div><div class="t m0 x7e hd y175c ffcf fs7 fc7 sc0 ls1 ws1">C compiler<span class="_ _6"></span>, <span class="fc5">337</span></div><div class="t m0 x7e hd y175d ffcf fs7 fc7 sc0 ls1 ws1">mytoupper r<span class="_ _3"></span>outine, <span class="fc5">335,</span> <span class="fc5">336</span></div><div class="t m0 xc hd y175e ffcf fs7 fc7 sc0 ls1 ws1">General-p<span class="_ _3"></span>urpose I/O (GPIO) pins</div><div class="t m0 x7e hd y175f ffcf fs7 fc7 sc0 ls1 ws1">Assembly language<span class="_ _3"></span>, <span class="fc5">185</span></div><div class="t m0 x7e hd y1760 ffcf fs7 fc7 sc0 ls1 ws1">flashing LEDs, <span class="fc5">180,</span> <span class="fc5">181,</span> <span class="fc5">183,</span> <span class="fc5">184</span></div><div class="t m0 x5b hd y1761 ffcf fs7 fc7 sc0 ls1 ws1">mapped memory, <span class="fc5">191,</span> <span class="fc5">193,</span> </div><div class="t m0 x7f hd y1762 ffcf fs7 fc5 sc0 ls1 ws1">195,<span class="fc7"> </span>196</div><div class="t m0 x5b hd y1763 ffcf fs7 fc7 sc0 ls16 ws1">pin direction, setting, <span class="fc5">198,</span> <span class="fc5">199</span></div><div class="t m0 x5b hd y1764 ffcf fs7 fc7 sc0 ls1 ws1">Raspberr<span class="_ _0"></span>y Pi, <span class="fc5">200</span></div><div class="t m0 x5b hd y1765 ffcf fs7 fc7 sc0 ls1 ws1">root access<span class="_ _1"></span>, <span class="fc5">197</span></div><div class="t m0 x5b hd y1766 ffcf fs7 fc7 sc0 ls20 ws1">setting/clearing pins, <span class="fc5">199,</span> <span class="fc5">200</span></div><div class="t m0 x5b hd y1767 ffcf fs7 fc7 sc0 ls1 ws1">table driven, <span class="fc5">197,</span> <span class="fc5">198</span></div><div class="t m0 x7e hd y1768 ffcf fs7 fc7 sc0 ls1 ws1">Linux, <span class="fc5">178,</span> <span class="fc5">179</span></div><div class="t m0 x7e hd y1769 ffcf fs7 fc7 sc0 ls1 ws1">memory lo<span class="_ _0"></span>ca<span class="_ _3"></span>tions, <span class="fc5">187,</span> <span class="fc5">188</span></div><div class="t m0 x7e hd y176a ffcf fs7 fc7 sc0 ls1 ws1">Raspberr<span class="_ _0"></span>y Pi 1, <span class="fc5">177</span></div><div class="t m0 x7e hd y176b ffcf fs7 fc7 sc0 ls1 ws1">registers<span class="_ _1"></span>, in bits</div><div class="t m0 x5b hd y176c ffcf fs7 fc7 sc0 ls1 ws1">Broadcom<span class="_ _3"></span>, <span class="fc5">188</span></div><div class="t m0 x5b hd y176d ffcf fs7 fc7 sc0 ls1 ws1">function select registers<span class="_ _3"></span>, <span class="fc5">189</span></div><div class="t m0 x5b hd y176e ffcf fs7 fc7 sc0 ls1 ws1">set/clear pin, <span class="fc5">191</span></div><div class="t m0 x7e hd y176f ffcf fs7 fc7 sc0 ls1 ws1">resisters<span class="_ _1"></span>, <span class="fc5">186,</span> <span class="fc5">187</span></div><div class="t m0 x7e hd y1770 ffcf fs7 fc7 sc0 ls1 ws1">virtual memor<span class="_ _0"></span>y addr<span class="_ _3"></span>esses, <span class="fc5">185,</span> </div><div class="t m0 x7f hd y1771 ffcf fs7 fc5 sc0 ls1 ws1">186</div><div class="t m0 xc hd y1772 ffcf fs7 fc7 sc0 ls1 ws1">Ghidra<span class="_ _3"></span>, <span class="fc5">341,</span> <span class="fc5">345</span></div><div class="t m0 x7e hd y1773 ffcf fs7 fc7 sc0 ls1 ws1">GCC optimizer<span class="_ _6"></span>, <span class="fc5">342</span></div><div class="t m0 x7e hd y1774 ffcf fs7 fc7 sc0 ls1 ws1">high-level information, <span class="fc5">342</span></div><div class="t m0 x7e hd y1775 ffcf fs7 fc7 sc0 ls1 ws1">tstStr/outS<span class="_ _3"></span>tr<span class="_ _6"></span>, <span class="fc5">345</span></div><div class="t m0 x7e hd y1776 ffcf fs7 fc7 sc0 ls1 ws1">upper C progr<span class="_ _3"></span>am, <span class="fc5">343,</span> <span class="fc5">344</span></div><div class="t m0 x68 hd y1777 ffcf fs7 fc7 sc0 ls1 ws1">ghidraR<span class="_ _3"></span>un script, <span class="fc5">341</span></div><div class="t m0 x68 hd y1778 ffcf fs7 fc7 sc0 ls1 ws1">Gnome calculator<span class="_ _10"></span>, <span class="fc5">10</span></div><div class="t m0 x68 hd y1779 ffcf fs7 fc7 sc0 ls1 wsbe">GNU Assembler directives<span class="_ _1"></span>, <span class="fc5">405,</span> <span class="fc5">406</span></div><div class="t m0 x68 hd y177a ffcf fs7 fc7 sc0 ls1 ws1">GNU Debugger (GDB), <span class="fc5">7,</span> <span class="fc5">48,</span> <span class="fc5">59,</span> <span class="fc5">63</span></div><div class="t m0 x68 hd y177b ffcf fs7 fc7 sc0 ls1 ws1">goto statement<span class="_ _3"></span>, <span class="fc5">105</span></div><div class="t m0 x68 hd y177c ffcf fs7 fc7 sc0 ls1 ws1">GPIO pins, <span class="fc5">365</span></div><div class="t m0 x68 h2a y57a ffd2 fsf fc7 sc0 ls1 ws1">H</div><div class="t m0 x68 hd y68a ffcf fs7 fc7 sc0 ls1 ws1">Hac<span class="_ _3"></span>king</div><div class="t m0 x80 hd y177d ffcf fs7 fc7 sc0 ls1 ws1">buffer overflow (<span class="ffd0">see </span>Buffer </div><div class="t m0 x56 hd y177e ffcf fs7 fc7 sc0 ls1 ws1">overflow h<span class="_ _3"></span>ack)</div><div class="t m0 x80 hd y177f ffcf fs7 fc7 sc0 ls1 ws1">NULL (0) terminator<span class="_ _6"></span>, <span class="fc5">353</span></div><div class="t m0 x80 hd y1780 ffcf fs7 fc7 sc0 ls1 ws1">objdump output, <span class="fc5">352</span></div><div class="t m0 x80 hd y1781 ffcf fs7 fc7 sc0 ls1 ws1">RET instruction, <span class="fc5">353,</span> <span class="fc5">354</span></div><div class="t m0 x80 hd y1782 ffcf fs7 fc7 sc0 ls1 ws1">stack, calltoupper function, <span class="fc5">351</span></div><div class="t m0 x80 hd y1783 ffcf fs7 fc7 sc0 ls1 ws1">stealing cr<span class="_ _3"></span>edit card  </div><div class="t m0 x56 hd y1784 ffcf fs7 fc7 sc0 ls1 ws1">numbers<span class="_ _3"></span>, <span class="fc5">348–351</span></div><div class="t m0 x68 h2a y1785 ffd2 fsf fc7 sc0 ls1 ws1">I</div><div class="t m0 x68 hd y1786 ffcf fs7 fc7 sc0 ls1 ws1">If/then/else statement, <span class="fc5">94,</span> <span class="fc5">95</span></div><div class="t m0 x68 hd y1787 ffcf fs7 fc7 sc0 ls1 ws1">imm26 operand, <span class="fc5">88</span></div><div class="t m0 x68 hd y1788 ffcf fs7 fc7 sc0 ls1 ws1">Integers to ASCII, conversion</div><div class="t m0 x80 hd y1789 ffcf fs7 fc7 sc0 ls1 ws1">compiling/execution,  </div><div class="t m0 x56 hd y178a ffcf fs7 fc7 sc0 ls1 ws1">progr<span class="_ _3"></span>am, <span class="fc5">101</span></div><div class="t m0 x80 hd y178b ffcf fs7 fc7 sc0 ls1 ws1">GNU assembler<span class="_ _6"></span>, <span class="fc5">102,</span> <span class="fc5">103</span></div><div class="t m0 x80 hd y178c ffcf fs7 fc7 sc0 ls1 ws1">printing, r<span class="_ _3"></span>egister<span class="_ _6"></span>, <span class="fc5">99</span></div><div class="t m0 x80 hd y178d ffcf fs7 fc7 sc0 ls1 ws1">pseudo-code, r<span class="_ _3"></span>egister<span class="_ _6"></span>, <span class="fc5">99</span></div><div class="t m0 x80 hd y178e ffcf fs7 fc7 sc0 ls1 ws1">STRB, <span class="fc5">103</span></div><div class="t m0 x68 hd y178f ffcf fs7 fc7 sc0 ls1 ws1">iOS application</div><div class="t m0 x80 hd y1790 ffcf fs7 fc7 sc0 ls1 ws1">Assembly Language code<span class="_ _3"></span>, </div><div class="t m0 x56 hd y1791 ffcf fs7 fc7 sc0 ls1 ws1">adding, <span class="fc5">244</span></div><div class="t m0 x80 hd y1792 ffcf fs7 fc7 sc0 ls1 ws1">bridge, cr<span class="_ _3"></span>eating, <span class="fc5">245</span></div><div class="t m0 x85 h89 y71 ffd3 fsa fc7 sc0 ls1 ws1">INDEX</div><a class="l" href="#pf1c" data-dest-detail='[28,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:212.024000px;bottom:555.754000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15e" data-dest-detail='[350,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:151.271000px;bottom:540.750000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15d" data-dest-detail='[349,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:156.254000px;bottom:525.746000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf26" data-dest-detail='[38,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:121.099000px;bottom:510.742000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15b" data-dest-detail='[347,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:142.615000px;bottom:495.738000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15d" data-dest-detail='[349,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:156.452000px;bottom:480.734000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15f" data-dest-detail='[351,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:177.968000px;bottom:480.734000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15c" data-dest-detail='[348,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.861000px;bottom:465.730000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15a" data-dest-detail='[346,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:162.701000px;bottom:450.726000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf15b" data-dest-detail='[347,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:184.217000px;bottom:450.726000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc8" data-dest-detail='[200,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:164.043000px;bottom:420.718000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc3" data-dest-detail='[195,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:138.402000px;bottom:405.714000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc4" data-dest-detail='[196,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:159.917000px;bottom:405.714000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc6" data-dest-detail='[198,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:181.433000px;bottom:405.714000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc7" data-dest-detail='[199,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:202.949000px;bottom:405.714000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfce" data-dest-detail='[206,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:170.335000px;bottom:390.710000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd0" data-dest-detail='[208,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:191.851000px;bottom:390.710000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd2" data-dest-detail='[210,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:91.510000px;bottom:375.706000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd3" data-dest-detail='[211,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:113.026000px;bottom:375.706000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd5" data-dest-detail='[213,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:182.325000px;bottom:360.702000px;width:18.788000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd6" data-dest-detail='[214,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:203.070000px;bottom:360.702000px;width:16.192000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd7" data-dest-detail='[215,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.797000px;bottom:345.698000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd4" data-dest-detail='[212,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:140.536000px;bottom:330.694000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd6" data-dest-detail='[214,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:182.313000px;bottom:315.690000px;width:18.855000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd7" data-dest-detail='[215,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:203.170000px;bottom:315.690000px;width:16.236000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd4" data-dest-detail='[212,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:145.035000px;bottom:300.686000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfd5" data-dest-detail='[213,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:166.551000px;bottom:300.686000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc1" data-dest-detail='[193,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:101.003000px;bottom:285.682000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc2" data-dest-detail='[194,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:122.519000px;bottom:285.682000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfca" data-dest-detail='[202,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:158.818000px;bottom:270.678000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfcb" data-dest-detail='[203,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:180.334000px;bottom:270.678000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc0" data-dest-detail='[192,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:141.559000px;bottom:255.674000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfcb" data-dest-detail='[203,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:137.908000px;bottom:225.666000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfcc" data-dest-detail='[204,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:199.660000px;bottom:210.662000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfce" data-dest-detail='[206,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:147.995000px;bottom:195.658000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc9" data-dest-detail='[201,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:112.509000px;bottom:180.654000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfca" data-dest-detail='[202,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:134.025000px;bottom:180.654000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc8" data-dest-detail='[200,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:195.029000px;bottom:165.650000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc9" data-dest-detail='[201,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:91.499000px;bottom:150.646000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf160" data-dest-detail='[352,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:91.685900px;bottom:135.642000px;width:19.250100px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf164" data-dest-detail='[356,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:113.202000px;bottom:135.642000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf161" data-dest-detail='[353,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:143.319000px;bottom:120.638000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf161" data-dest-detail='[353,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:179.695000px;bottom:105.634000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf164" data-dest-detail='[356,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:130.681000px;bottom:90.629800px;width:16.500000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf162" data-dest-detail='[354,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:154.396000px;bottom:75.625800px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf163" data-dest-detail='[355,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:175.912000px;bottom:75.625800px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf160" data-dest-detail='[352,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:321.133000px;bottom:577.237000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1f" data-dest-detail='[31,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:325.931000px;bottom:562.233000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19e" data-dest-detail='[414,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:365.404000px;bottom:547.229000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf19f" data-dest-detail='[415,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:386.887000px;bottom:547.229000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1c" data-dest-detail='[28,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:347.666000px;bottom:532.225000px;width:8.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf44" data-dest-detail='[68,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:358.182000px;bottom:532.225000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf4e" data-dest-detail='[78,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:374.198000px;bottom:532.225000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf52" data-dest-detail='[82,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:390.214000px;bottom:532.225000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7b" data-dest-detail='[123,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:312.445000px;bottom:517.221000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf178" data-dest-detail='[376,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:290.775000px;bottom:502.217000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16c" data-dest-detail='[364,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:353.305000px;bottom:394.350000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16b" data-dest-detail='[363,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:334.869000px;bottom:379.346000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16c" data-dest-detail='[364,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:331.293000px;bottom:364.342000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16d" data-dest-detail='[365,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:352.809000px;bottom:364.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16a" data-dest-detail='[362,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:382.796000px;bottom:349.338000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf167" data-dest-detail='[359,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:322.308000px;bottom:319.330000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16a" data-dest-detail='[362,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:343.978000px;bottom:319.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf70" data-dest-detail='[112,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:347.673000px;bottom:256.362000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf71" data-dest-detail='[113,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:363.689000px;bottom:256.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6a" data-dest-detail='[106,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:317.819000px;bottom:241.358000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf77" data-dest-detail='[119,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:320.569000px;bottom:196.346000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf78" data-dest-detail='[120,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:330.733000px;bottom:181.342000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf79" data-dest-detail='[121,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:352.249000px;bottom:181.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf75" data-dest-detail='[117,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:334.748000px;bottom:166.338000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf75" data-dest-detail='[117,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:358.233000px;bottom:151.334000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf79" data-dest-detail='[121,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:283.313000px;bottom:136.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf102" data-dest-detail='[258,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:312.914000px;bottom:91.317800px;width:16.500000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf103" data-dest-detail='[259,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:330.854000px;bottom:76.313800px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1b2" class="pf w2 h6" data-page-no="1b2"><div class="pc pc1b2 w2 h6"><div class="t m0 xd hd y3f ffcf fs7 fc7 sc0 ls1 ws1">426</div><div class="t m0 x7a hd y1793 ffcf fs7 fc7 sc0 ls1 ws1">building/running, pr<span class="_ _3"></span>oject, <span class="fc5">246</span></div><div class="t m0 x7a hd y1794 ffcf fs7 fc7 sc0 ls1 ws1">crea<span class="_ _3"></span>ting project, <span class="fc5">240</span></div><div class="t m0 x7a hd y1795 ffcf fs7 fc7 sc0 ls1 ws1">Swift code, adding<span class="_ _3"></span>, <span class="fc5">241,</span> <span class="fc5">243</span></div><div class="t m0 x7a hd y1796 ffcf fs7 fc7 sc0 ls1 ws1">UI elements to main  </div><div class="t m0 x81 hd y1797 ffcf fs7 fc7 sc0 ls1 ws1">storyboard, <span class="fc5">240,</span> <span class="fc5">241</span></div><div class="t m0 x7a hd y1798 ffcf fs7 fc7 sc0 ls1 ws1">Xcode, <span class="fc5">239</span></div><div class="t m0 xd h2a y1799 ffd2 fsf fc7 sc0 ls1 ws1">J</div><div class="t m0 xd hd y179a ffcf fs7 fc7 sc0 ls1 ws1">J<span class="_ _1"></span>ava N<span class="_ _1"></span>ative Interface (<span class="_ _0"></span>JNI), <span class="fc5">235</span></div><div class="t m0 xd h2a y179b ffd2 fsf fc7 sc0 ls1 ws1">K</div><div class="t m0 xd hd y1729 ffcf fs7 fc7 sc0 ls1 ws1">Kotlin, <span class="ffd0">see </span>Andr<span class="_ _3"></span>oid application</div><div class="t m0 xd h2a y179c ffd2 fsf fc7 sc0 ls1 ws1">L</div><div class="t m0 xd hd y179d ffcf fs7 fc7 sc0 ls1 ws1">ld command, <span class="fc5">357</span></div><div class="t m0 xd hd y179e ffcf fs7 fc7 sc0 ls1 ws1">Linux/GCC code</div><div class="t m0 x7a hd y179f ffcf fs7 fc7 sc0 ls1 ws1">GitH<span class="_ _3"></span>ub repositories<span class="_ _1"></span>, <span class="fc5">328</span></div><div class="t m0 x7a hd y17a0 ffcf fs7 fc7 sc0 ls1 ws1">64-bit Assembly Language </div><div class="t m0 x81 hd y17a1 ffcf fs7 fc7 sc0 ls1 ws1">source code<span class="_ _3"></span>, <span class="fc5">328</span></div><div class="t m0 xd hd y17a2 ffcf fs7 fc7 sc0 ls1 ws1">Linux kernel</div><div class="t m0 x7a hd y17a3 ffcf fs7 fc7 sc0 ls1 ws1">copy page function, <span class="fc5">330–331</span></div><div class="t m0 x7a hd y17a4 ffcf fs7 fc7 sc0 ls1 ws1">C runtime functions, <span class="fc5">329</span></div><div class="t m0 x7a hd y17a5 ffcf fs7 fc7 sc0 ls1 ws1">loop unrolling, <span class="fc5">332</span></div><div class="t m0 x7a hd y17a6 ffcf fs7 fc7 sc0 ls1 ws1">parallel pr<span class="_ _3"></span>ocessing, <span class="fc5">332</span></div><div class="t m0 x7a hd y17a7 ffcf fs7 fc7 sc0 ls1 ws1">pldl1strm string, <span class="fc5">334</span></div><div class="t m0 x7a hd y17a8 ffcf fs7 fc7 sc0 ls1 ws1">TST instruction, <span class="fc5">333</span></div><div class="t m0 x7a hd y17a9 ffcf fs7 fc7 sc0 ls1 ws1">virtual memor<span class="_ _0"></span>y man<span class="_ _3"></span>ager<span class="_ _6"></span>, <span class="fc5">329</span></div><div class="t m0 xd hd y17aa ffcf fs7 fc7 sc0 ls1 ws1">Linux openat service, <span class="fc5">172</span></div><div class="t m0 xd hd y17ab ffcf fs7 fc7 sc0 ls1 ws1">Linux operatin<span class="_ _3"></span>g system services</div><div class="t m0 x7a hd y17ac ffcf fs7 fc7 sc0 ls1 ws1">calling conv<span class="_ _3"></span>ention</div><div class="t m0 x86 hd y17ad ffcf fs7 fc7 sc0 ls1 ws1">call numbers<span class="_ _1"></span>, <span class="fc5">163</span></div><div class="t m0 x86 hd y17ae ffcf fs7 fc7 sc0 ls1 ws1">definition, <span class="fc5">162</span></div><div class="t m0 x86 hd y17af ffcf fs7 fc7 sc0 ls1 ws1">return code<span class="_ _1"></span>, <span class="fc5">163,</span> <span class="fc5">164</span></div><div class="t m0 x86 hd y17b0 ffcf fs7 fc7 sc0 ls1 ws1">structures<span class="_ _1"></span>, <span class="fc5">164,</span> <span class="_ _0"></span><span class="fc5">165</span></div><div class="t m0 x31 hd y17b1 ffcf fs7 fc7 sc0 ls1 ws1">converting file to upper<span class="_ _1"></span>-case</div><div class="t m0 x86 hd y17b2 ffcf fs7 fc7 sc0 ls1 ws1">build S files, <span class="fc5">170,</span> <span class="fc5">171,</span> <span class="fc5">176</span></div><div class="t m0 x86 hd y17b3 ffcf fs7 fc7 sc0 ls1 ws1">case conversion pr<span class="_ _1"></span>ogram, </div><div class="t m0 x3f hd y17b4 ffcf fs7 fc5 sc0 ls1 ws1">168,<span class="fc7"> </span>169</div><div class="t m0 x86 hd y17b5 ffcf fs7 fc7 sc0 ls1 ws1">error checking, <span class="fc5">172,</span> <span class="fc5">174</span></div><div class="t m0 x86 hd y17b6 ffcf fs7 fc7 sc0 ls1 ws1">file I/O routines<span class="_ _1"></span>, <span class="fc5">166,</span> <span class="fc5">167</span></div><div class="t m0 x86 hd y17b7 ffcf fs7 fc7 sc0 ls1 ws1">loop<span class="_ _1"></span>, <span class="fc5">174,</span> <span class="fc5">175</span></div><div class="t m0 x86 hd y17b8 ffcf fs7 fc7 sc0 ls1 ws1">openat service, <span class="fc5">172</span></div><div class="t m0 x31 hd y17b9 ffcf fs7 fc7 sc0 ls1 ws1">function call wrappers<span class="_ _1"></span>, <span class="fc5">165</span></div><div class="t m0 x83 hd y17ba ffcf fs7 fc7 sc0 ls1 ws1">Little-endian, <span class="fc5">26</span></div><div class="t m0 x83 hd y17bb ffcf fs7 fc7 sc0 ls1 ws1">Logical operators</div><div class="t m0 x31 hd y17bc ffcf fs7 fc7 sc0 ls1 ws1">AND<span class="_ _3"></span>, <span class="fc5">96</span></div><div class="t m0 x31 hd y17bd ffcf fs7 fc7 sc0 ls1 ws1">EOR, <span class="fc5">96</span></div><div class="t m0 x31 hd y17be ffcf fs7 fc7 sc0 ls1 ws1">ORR, <span class="fc5">96</span></div><div class="t m0 x83 h2a y17bf ffd2 fsf fc7 sc0 ls1 ws1">M</div><div class="t m0 x83 hd y17c0 ffcf fs7 fc7 sc0 ls1 ws1">MUL/SMULH, <span class="fc5">255</span></div><div class="t m0 x83 hd y17c1 ffcf fs7 fc7 sc0 ls1 ws1">MUL instruction, <span class="fc5">267</span></div><div class="t m0 x83 hd y17c2 ffcf fs7 fc7 sc0 ls1 ws1">M<span class="_ _3"></span>ultiplication</div><div class="t m0 x31 hd y17c3 ffcf fs7 fc7 sc0 ls1 ws1">examples instruction, <span class="fc5">251–254</span></div><div class="t m0 x31 hd y17c4 ffcf fs7 fc7 sc0 ls1 ws1">functions, <span class="fc5">251</span></div><div class="t m0 x31 hd y17c5 ffcf fs7 fc7 sc0 ls1 ws1">instruction, <span class="fc5">249,</span> <span class="fc5">250</span></div><div class="t m0 x31 hd y17c6 ffcf fs7 fc7 sc0 ls1 ws1">SMULL/UMULL<span class="_ _0"></span>, <span class="fc5">250,</span> <span class="fc5">251</span></div><div class="t m0 x83 hd y17c7 ffcf fs7 fc7 sc0 ls1 ws1">M<span class="_ _3"></span>ultiply/accumulate oper<span class="_ _1"></span>ation</div><div class="t m0 x31 hd y17c8 ffcf fs7 fc7 sc0 ls1 ws1">instruction, accumulate<span class="_ _3"></span>, <span class="fc5">260</span></div><div class="t m0 x31 hd y17c9 ffcf fs7 fc7 sc0 ls1 ws1">matrix elements<span class="_ _1"></span>, <span class="fc5">259,</span> <span class="fc5">265</span></div><div class="t m0 x31 hd y17ca ffcf fs7 fc7 sc0 ls1 ws1">matrix multiplica<span class="_ _3"></span>tion  </div><div class="t m0 x3f hd y17cb ffcf fs7 fc7 sc0 ls1 ws1">progr<span class="_ _3"></span>am, <span class="fc5">261–264</span></div><div class="t m0 x31 hd y17cc ffcf fs7 fc7 sc0 ls1 ws1">registers<span class="_ _1"></span>, <span class="fc5">266</span></div><div class="t m0 xd hd y17cd ffcf fs7 fc7 sc0 ls1 ws1">iOS application (<span class="ffd0 ls18 wsc0">cont</span>.)</div><div class="t m0 xd h89 y71 ffd3 fsa fc7 sc0 ls1 ws1">INDEX</div><a class="l" href="#pf104" data-dest-detail='[260,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:176.104000px;bottom:562.351000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffe" data-dest-detail='[254,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:129.257000px;bottom:547.347000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfff" data-dest-detail='[255,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:141.741000px;bottom:532.343000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf101" data-dest-detail='[257,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:163.257000px;bottom:532.343000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffe" data-dest-detail='[254,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:129.610000px;bottom:502.335000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfff" data-dest-detail='[255,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:151.126000px;bottom:502.335000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pffd" data-dest-detail='[253,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:85.389800px;bottom:487.331000px;width:16.500200px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pff9" data-dest-detail='[249,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:162.652000px;bottom:427.354000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf170" data-dest-detail='[368,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:100.779000px;bottom:307.354000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf153" data-dest-detail='[339,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.309000px;bottom:277.346000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf153" data-dest-detail='[339,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:134.603000px;bottom:247.338000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf155" data-dest-detail='[341,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:145.262000px;bottom:217.330000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf156" data-dest-detail='[342,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:166.932000px;bottom:217.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf154" data-dest-detail='[340,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:150.079000px;bottom:202.326000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf157" data-dest-detail='[343,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:122.700000px;bottom:187.322000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf157" data-dest-detail='[343,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:144.095000px;bottom:172.318000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf159" data-dest-detail='[345,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:130.587000px;bottom:157.314000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf158" data-dest-detail='[344,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:128.585000px;bottom:142.310000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf154" data-dest-detail='[340,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:171.639000px;bottom:127.306000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbb" data-dest-detail='[187,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:137.957000px;bottom:112.302000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb2" data-dest-detail='[178,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:315.553000px;bottom:577.305000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb1" data-dest-detail='[177,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:300.781000px;bottom:562.301000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb2" data-dest-detail='[178,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:309.008000px;bottom:547.297000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb3" data-dest-detail='[179,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:330.524000px;bottom:547.297000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb3" data-dest-detail='[179,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:301.485000px;bottom:532.293000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb4" data-dest-detail='[180,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:323.001000px;bottom:532.293000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb9" data-dest-detail='[185,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:308.391000px;bottom:502.285000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfba" data-dest-detail='[186,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:329.907000px;bottom:502.285000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbf" data-dest-detail='[191,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:351.423000px;bottom:502.285000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb7" data-dest-detail='[183,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:257.188000px;bottom:472.277000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb8" data-dest-detail='[184,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:278.704000px;bottom:472.277000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbb" data-dest-detail='[187,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:322.593000px;bottom:457.273000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbd" data-dest-detail='[189,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:344.109000px;bottom:457.273000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb5" data-dest-detail='[181,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:328.753000px;bottom:442.269000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb6" data-dest-detail='[182,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:350.268000px;bottom:442.269000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbd" data-dest-detail='[189,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:275.503000px;bottom:427.265000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbe" data-dest-detail='[190,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:297.019000px;bottom:427.265000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfbb" data-dest-detail='[187,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:322.604000px;bottom:412.261000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfb4" data-dest-detail='[180,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:344.141000px;bottom:397.257000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2f" data-dest-detail='[47,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:285.930000px;bottom:382.253000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf72" data-dest-detail='[114,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:262.622000px;bottom:352.245000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf72" data-dest-detail='[114,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:260.873000px;bottom:337.241000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf72" data-dest-detail='[114,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:261.247000px;bottom:322.237000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf10d" data-dest-detail='[269,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:290.590000px;bottom:262.362000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf119" data-dest-detail='[281,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:302.337000px;bottom:247.358000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf109" data-dest-detail='[265,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:338.252000px;bottom:217.350000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf10c" data-dest-detail='[268,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:359.922000px;bottom:217.350000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf109" data-dest-detail='[265,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:283.869000px;bottom:202.346000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf107" data-dest-detail='[263,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:291.449000px;bottom:187.342000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf108" data-dest-detail='[264,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:312.965000px;bottom:187.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf108" data-dest-detail='[264,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:317.419000px;bottom:172.338000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf109" data-dest-detail='[265,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:338.935000px;bottom:172.338000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf112" data-dest-detail='[274,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:351.265000px;bottom:142.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf111" data-dest-detail='[273,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:315.230000px;bottom:127.326000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf117" data-dest-detail='[279,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:336.746000px;bottom:127.326000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf113" data-dest-detail='[275,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:302.569000px;bottom:97.317800px;width:21.670000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf116" data-dest-detail='[278,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:324.239000px;bottom:97.317800px;width:16.500000px;height:12.276200px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf118" data-dest-detail='[280,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:279.095000px;bottom:82.313800px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1b3" class="pf w2 h6" data-page-no="1b3"><div class="pc pc1b3 w2 h6"><div class="t m0 x17 hd y3f ffcf fs7 fc7 sc0 ls1 ws1">427</div><div class="t m0 x7e hd y145 ffcf fs7 fc7 sc0 ls1 ws1">SMADDL instruction, <span class="fc5">266</span></div><div class="t m0 x7e hd y171f ffcf fs7 fc7 sc0 ls1 ws1">vector<span class="_ _6"></span>, <span class="fc5">258</span></div><div class="t m0 xc h2a y17ce ffd2 fsf fc7 sc0 ls1 ws1">N</div><div class="t m0 xc hd y17cf ffcf fs7 fc7 sc0 ls16 ws1">N<span class="_ _3"></span>ational Security Agency (NSA), <span class="fc5">341</span></div><div class="t m0 xc hd y17d0 ffcf fs7 fc7 sc0 ls1 ws1">NEON coprocessor<span class="_ _10"></span>, <span class="fc5">273,</span> <span class="fc5">328</span></div><div class="t m0 x7e hd y17d1 ffcf fs7 fc7 sc0 ls1 ws1">arithmetic operations<span class="_ _3"></span>, <span class="fc5">294,</span> <span class="fc5">295</span></div><div class="t m0 x7e hd y17d2 ffcf fs7 fc7 sc0 ls1 ws1">4D vector distance  </div><div class="t m0 x7f hd y17d3 ffcf fs7 fc7 sc0 ls1 ws1">calculation, <span class="fc5">295–300</span></div><div class="t m0 x7e hd y17d4 ffcf fs7 fc7 sc0 ls1 ws1">lanes, <span class="fc5">292,</span> <span class="fc5">293</span></div><div class="t m0 x7e hd y17d5 ffcf fs7 fc7 sc0 ls1 ws1">registers<span class="_ _1"></span>, <span class="fc5">291,</span> <span class="fc5">292</span></div><div class="t m0 x7e hd y17d6 ffcf fs7 fc7 sc0 ls1 ws1">3x3 matrix multiplica<span class="_ _3"></span>tion, </div><div class="t m0 x7f hd y17d7 ffcf fs7 fc5 sc0 ls1 ws1">300–305</div><div class="t m0 xc hd y17d8 ffcf fs7 fc7 sc0 ls1 ws1">Not a N<span class="_ _1"></span>umber (NaN), <span class="fc5">271</span></div><div class="t m0 xc hd y17d9 ffcf fs7 fc7 sc0 ls1 ws1">NULL (0) character<span class="_ _10"></span>, <span class="fc5">347</span></div><div class="t m0 xc hd y17da ffcf fs7 fc7 sc0 ls1 ws1">NVidia J<span class="_ _3"></span>etson Nano<span class="_ _1"></span>, <span class="fc5">7</span></div><div class="t m0 xc hd y17db ffcf fs7 fc7 sc0 ls1 ws1">NZCV system register<span class="_ _10"></span>, <span class="fc5">89</span></div><div class="t m0 xc h2a y17bf ffd2 fsf fc7 sc0 ls1 ws1">O</div><div class="t m0 xc hd y17c0 ffcf fs7 fc7 sc0 ls1 ws1">objdump command line  </div><div class="t m0 x7d hd y17c1 ffcf fs7 fc7 sc0 ls1 ws1">progr<span class="_ _3"></span>am, <span class="fc5">24</span></div><div class="t m0 xc hd y17c2 ffcf fs7 fc7 sc0 ls1 ws1">objdump/gdb<span class="_ _1"></span>, <span class="fc5">341</span></div><div class="t m0 xc hd y17c3 ffcf fs7 fc7 sc0 ls1 ws1">Optimizing code</div><div class="t m0 x7e hd y17c4 ffcf fs7 fc7 sc0 ls1 ws1">avoidin<span class="_ _3"></span>g expensive  </div><div class="t m0 x7f hd y17c5 ffcf fs7 fc7 sc0 ls1 ws1">instruction, <span class="fc5">322</span></div><div class="t m0 x7e hd y17c6 ffcf fs7 fc7 sc0 ls1 ws1">branch instruction, <span class="fc5">321,</span> <span class="fc5">322</span></div><div class="t m0 x7e hd y17c7 ffcf fs7 fc7 sc0 ls1 ws1">loop unrolling, <span class="fc5">323</span></div><div class="t m0 x7e hd y17c8 ffcf fs7 fc7 sc0 ls1 ws1">macros<span class="_ _1"></span>, <span class="fc5">323</span></div><div class="t m0 x7e hd y17c9 ffcf fs7 fc7 sc0 ls1 ws1">over<span class="_ _3"></span>heating, <span class="fc5">323</span></div><div class="t m0 x7e hd y17ca ffcf fs7 fc7 sc0 ls1 ws1">reducing da<span class="_ _3"></span>ta quantity, <span class="fc5">323</span></div><div class="t m0 x7e hd y17cb ffcf fs7 fc7 sc0 ls1 ws1">upper<span class="_ _1"></span>-case routine  </div><div class="t m0 x7f hd y17cc ffcf fs7 fc7 sc0 ls1 ws1">(<span class="ffd0">see </span>Upper<span class="_ _1"></span>-case routine)</div><div class="t m0 x68 hd y17cd ffcf fs7 fc7 sc0 ls1 ws1">Out<span class="_ _1"></span>-of-order execution, <span class="fc5">15</span></div><div class="t m0 x68 hd y17dc ffcf fs7 fc7 sc0 ls1 ws1">OV<span class="_ _6"></span>erflow, <span class="fc5">89</span></div><div class="t m0 x68 h2a y17dd ffd2 fsf fc7 sc0 ls3b wse0">P,<span class="_ _9"> </span> Q</div><div class="t m0 x68 hd y17de ffcf fs7 fc7 sc0 ls1 ws1">pldl1strm string, <span class="fc5">334</span></div><div class="t m0 x68 hd y17df ffcf fs7 fc7 sc0 ls1 ws1">Position-independent executa<span class="_ _3"></span>bles </div><div class="t m0 x6b hd y17e0 ffcf fs7 fc7 sc0 ls1 ws1">(PIE), <span class="fc5">357</span></div><div class="t m0 x68 hd y17e1 ffcf fs7 fc7 sc0 ls1 ws1">Progr<span class="_ _3"></span>am counter (PC), <span class="fc5">17</span></div><div class="t m0 x68 hd y17e2 ffcf fs7 fc7 sc0 ls1 ws1">Pulse-<span class="_ _3"></span>position modulation  </div><div class="t m0 x6b hd y17e3 ffcf fs7 fc7 sc0 ls1 ws1">(PPM), <span class="fc5">178</span></div><div class="t m0 x68 hd y17e4 ffcf fs7 fc7 sc0 ls1 ws1">Pulse width modulation  </div><div class="t m0 x6b hd y17e5 ffcf fs7 fc7 sc0 ls1 ws1">(PWM), <span class="fc5">178</span></div><div class="t m0 x68 h2a y1e3 ffd2 fsf fc7 sc0 ls1 ws1">R</div><div class="t m0 x68 hd y2b0 ffcf fs7 fc7 sc0 ls1 ws1">Raspberr<span class="_ _0"></span>y Pi 4, <span class="fc5">6</span></div><div class="t m0 x68 hd y17e6 ffcf fs7 fc7 sc0 ls1 ws1">Reduced instruction set computer </div><div class="t m0 x6b hd y17e7 ffcf fs7 fc7 sc0 ls1 ws1">(RISC<span class="_ _0"></span>), <span class="fc5">1,</span> <span class="fc5">3,</span> <span class="fc5">11,</span> <span class="fc5">119,</span> <span class="fc5">258</span></div><div class="t m0 x68 h2a y17e8 ffd2 fsf fc7 sc0 ls1 ws1">S</div><div class="t m0 x68 hd y17e9 ffcf fs7 fc7 sc0 ls1 ws1">Shar<span class="_ _3"></span>ed library, <span class="fc5">215–218</span></div><div class="t m0 x68 hd y17ea ffcf fs7 fc7 sc0 ls1 ws1">SIMD instructions, <span class="fc5">364</span></div><div class="t m0 x68 hd y17eb ffcf fs7 fc7 sc0 ls1 ws1">Single boar<span class="_ _3"></span>d computer (SBC), <span class="fc5">6</span></div><div class="t m0 x68 hd y17ec ffcf fs7 fc7 sc0 ls1 ws1">single instruction multiple data </div><div class="t m0 x6b hd y17ed ffcf fs7 fc7 sc0 ls1 ws1">(SIMD), <span class="fc5">291</span></div><div class="t m0 x68 hd y17ee ffcf fs7 fc7 sc0 ls1 ws1">SMADDL instruction, <span class="fc5">266</span></div><div class="t m0 x68 hd y17ef ffcf fs7 fc7 sc0 ls1 ws1">SMULL/UMULL<span class="_ _0"></span>, <span class="fc5">250</span></div><div class="t m0 x68 hd y17f0 ffcf fs7 fc7 sc0 ls1 ws1">Spaghetti code<span class="_ _1"></span>, <span class="fc5">104</span></div><div class="t m0 x68 hd y17f1 ffcf fs7 fc7 sc0 ls1 ws1">Static libr<span class="_ _3"></span>ary, <span class="fc5">214,</span> <span class="fc5">215</span></div><div class="t m0 x68 hd y17f2 ffcf fs7 fc7 sc0 ls1 ws1">Stor<span class="_ _3"></span>e byte (STRB) instruction, <span class="fc5">103</span></div><div class="t m0 x68 hd yc94 ffcf fs7 fc7 sc0 ls1 ws1">SUB instruction, <span class="fc5">308</span></div><div class="t m0 x68 hd y17f3 ffcf fs7 fc7 sc0 ls1 ws1">Swift, <span class="ffd0">see </span>iOS application</div><div class="t m0 x68 hd y17f4 ffcf fs7 fc7 sc0 ls1 ws1">System on a chip (SoC), <span class="fc5">186</span></div><div class="t m0 x85 h89 y71 ffd3 fsa fc7 sc0 ls1 ws1">INDEX</div><a class="l" href="#pf118" data-dest-detail='[280,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:172.753000px;bottom:577.366000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf110" data-dest-detail='[272,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:102.256000px;bottom:562.362000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf160" data-dest-detail='[352,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:202.719000px;bottom:502.362000px;width:16.191000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11e" data-dest-detail='[286,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:147.729000px;bottom:487.358000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf153" data-dest-detail='[339,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:169.245000px;bottom:487.358000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf132" data-dest-detail='[306,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:175.328000px;bottom:472.354000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf133" data-dest-detail='[307,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:196.844000px;bottom:472.354000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf133" data-dest-detail='[307,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.633000px;bottom:442.346000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf138" data-dest-detail='[312,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:170.303000px;bottom:442.346000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf130" data-dest-detail='[304,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:98.582800px;bottom:427.342000px;width:19.250200px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf131" data-dest-detail='[305,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:120.099000px;bottom:427.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:113.410000px;bottom:412.338000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf130" data-dest-detail='[304,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:134.926000px;bottom:412.338000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf138" data-dest-detail='[312,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:91.499000px;bottom:382.330000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13d" data-dest-detail='[317,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:113.169000px;bottom:382.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11c" data-dest-detail='[284,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:157.134000px;bottom:367.326000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf166" data-dest-detail='[358,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.214000px;bottom:352.322000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1c" data-dest-detail='[28,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:150.677000px;bottom:337.318000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6b" data-dest-detail='[107,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:158.840000px;bottom:322.314000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf2d" data-dest-detail='[45,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:134.090000px;bottom:247.358000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf160" data-dest-detail='[352,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:124.542000px;bottom:232.354000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14e" data-dest-detail='[334,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:148.258000px;bottom:187.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14d" data-dest-detail='[333,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:161.501000px;bottom:172.338000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14e" data-dest-detail='[334,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:183.017000px;bottom:172.338000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:140.700000px;bottom:157.334000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:108.318000px;bottom:142.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:129.680000px;bottom:127.326000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14f" data-dest-detail='[335,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:180.179000px;bottom:112.322000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf24" data-dest-detail='[36,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:351.010000px;bottom:577.314000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6b" data-dest-detail='[107,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:286.210000px;bottom:562.310000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf159" data-dest-detail='[345,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:317.268000px;bottom:506.362000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf170" data-dest-detail='[368,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:301.606000px;bottom:476.354000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf26" data-dest-detail='[38,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:345.979000px;bottom:461.350000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc1" data-dest-detail='[193,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:307.766000px;bottom:431.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc1" data-dest-detail='[193,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:311.418000px;bottom:401.334000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1b" data-dest-detail='[27,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:310.240000px;bottom:345.362000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf16" data-dest-detail='[22,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:308.789000px;bottom:315.354000px;width:8.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf18" data-dest-detail='[24,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:319.305000px;bottom:315.354000px;width:8.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf20" data-dest-detail='[32,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:329.821000px;bottom:315.354000px;width:13.750000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf88" data-dest-detail='[136,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:345.836000px;bottom:315.354000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf110" data-dest-detail='[272,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:367.352000px;bottom:315.354000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe5" data-dest-detail='[229,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:308.876000px;bottom:259.362000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe8" data-dest-detail='[232,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:330.546000px;bottom:259.362000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf177" data-dest-detail='[375,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:328.290000px;bottom:244.358000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf1b" data-dest-detail='[27,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:379.506000px;bottom:229.354000px;width:5.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf12f" data-dest-detail='[303,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:312.507000px;bottom:199.346000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf118" data-dest-detail='[280,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:341.435000px;bottom:184.342000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf108" data-dest-detail='[264,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:320.415000px;bottom:169.338000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf7a" data-dest-detail='[122,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:311.658000px;bottom:154.334000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe4" data-dest-detail='[228,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:301.902000px;bottom:139.330000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfe5" data-dest-detail='[229,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:323.417000px;bottom:139.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf79" data-dest-detail='[121,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:378.868000px;bottom:124.326000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf140" data-dest-detail='[320,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:316.839000px;bottom:109.322000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pfc9" data-dest-detail='[201,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:350.730000px;bottom:79.313800px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
<div id="pf1b4" class="pf w2 h6" data-page-no="1b4"><div class="pc pc1b4 w2 h6"><div class="t m0 xd hd y3f ffcf fs7 fc7 sc0 ls1 ws1">428</div><div class="t m0 xd h2a y173b ffd2 fsf fc7 sc0 ls1 ws1">T</div><div class="t m0 xd hd y173c ffcf fs7 fc7 sc0 ls1 ws1">tstStr/outS<span class="_ _3"></span>tr<span class="_ _6"></span>, <span class="fc5">345</span></div><div class="t m0 xd h2a y17f5 ffd2 fsf fc7 sc0 ls1 ws1">U</div><div class="t m0 xd hd y17f6 ffcf fs7 fc7 sc0 ls1 ws1">Unconditional br<span class="_ _3"></span>anch, <span class="fc5">88</span></div><div class="t m0 xd hd y17f7 ffcf fs7 fc7 sc0 ls1 ws1">Upper<span class="_ _1"></span>-case routine<span class="_ _1"></span>, <span class="fc5">346</span></div><div class="t m0 x7a hd y17f8 ffcf fs7 fc7 sc0 ls1 ws1">BIC instruction, <span class="fc5">316</span></div><div class="t m0 x7a hd y17f9 ffcf fs7 fc7 sc0 ls1 ws1">CMHI, <span class="fc5">320</span></div><div class="t m0 x7a hd y17fa ffcf fs7 fc7 sc0 ls1 ws1">conditional instruction, <span class="fc5">311</span></div><div class="t m0 x7a hd y17fb ffcf fs7 fc7 sc0 ls1 ws1">CSEL instruction, <span class="fc5">312,</span> <span class="fc5">313</span></div><div class="t m0 x7a hd y17fc ffcf fs7 fc7 sc0 ls1 ws1">Neon Copr<span class="_ _3"></span>ocessor<span class="_ _6"></span>, <span class="fc5">317–319</span></div><div class="t m0 x7a hd y17fd ffcf fs7 fc7 sc0 ls1 ws1">NULL terminator<span class="_ _6"></span>, <span class="fc5">320</span></div><div class="t m0 x31 hd y17fe ffcf fs7 fc7 sc0 ls1 ws1">problem domain, <span class="fc5">314,</span> <span class="fc5">316</span></div><div class="t m0 x31 hd y17ff ffcf fs7 fc7 sc0 ls1 ws1">pseudo-code, <span class="fc5">307</span></div><div class="t m0 x31 hd y1800 ffcf fs7 fc7 sc0 ls1 ws1">range comparisons<span class="_ _3"></span>,  </div><div class="t m0 x3f hd y1801 ffcf fs7 fc5 sc0 ls1 ws1">308,<span class="fc7"> </span>310,<span class="fc7"> </span>311</div><div class="t m0 x31 hd y1802 ffcf fs7 fc7 sc0 ls1 ws1">string processing<span class="_ _3"></span>, <span class="fc5">320</span></div><div class="t m0 x83 h2a y1803 ffd2 fsf fc7 sc0 ls1 ws1">V</div><div class="t m0 x83 hd y1804 ffcf fs7 fc7 sc0 ls1 ws1">V<span class="_ _6"></span>e<span class="_ _0"></span>ctor floatin<span class="_ _3"></span>g-<span class="_ _3"></span>point  </div><div class="t m0 x84 hd y1297 ffcf fs7 fc7 sc0 ls1 ws1">(VFP), <span class="fc5">269</span></div><div class="t m0 x83 h2a y1805 ffd2 fsf fc7 sc0 ls1 ws1">W<span class="_ _6"></span>, X, Y<span class="_ _66"></span>, Z</div><div class="t m0 x83 hd y1806 ffcf fs7 fc7 sc0 ls1 ws1">While loops, <span class="fc5">93</span></div><div class="t m0 xd h89 y71 ffd3 fsa fc7 sc0 ls1 ws1">INDEX</div><a class="l" href="#pf164" data-dest-detail='[356,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:97.676700px;bottom:555.754000px;width:16.500300px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6a" data-dest-detail='[106,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:144.733000px;bottom:495.754000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf165" data-dest-detail='[357,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:131.203000px;bottom:480.750000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14c" data-dest-detail='[332,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:85.037800px;bottom:450.742000px;width:16.500200px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf143" data-dest-detail='[323,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:164.005000px;bottom:435.738000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf144" data-dest-detail='[324,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:135.350000px;bottom:420.734000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf145" data-dest-detail='[325,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:156.866000px;bottom:420.734000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf149" data-dest-detail='[329,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:141.973000px;bottom:405.730000px;width:21.670000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14b" data-dest-detail='[331,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:163.643000px;bottom:405.730000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14c" data-dest-detail='[332,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:136.000000px;bottom:390.726000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf146" data-dest-detail='[326,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:318.787000px;bottom:577.330000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf148" data-dest-detail='[328,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:340.303000px;bottom:577.330000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13f" data-dest-detail='[319,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:301.088000px;bottom:562.326000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf140" data-dest-detail='[320,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:257.188000px;bottom:532.318000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf142" data-dest-detail='[322,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:278.704000px;bottom:532.318000px;width:19.250000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf143" data-dest-detail='[323,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:300.220000px;bottom:532.318000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf14c" data-dest-detail='[332,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:319.215000px;bottom:517.314000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf11a" data-dest-detail='[282,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:286.741000px;bottom:446.358000px;width:16.500000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf6f" data-dest-detail='[111,"XYZ",0,666,null]'><div class="d m1" style="border-style:none;position:absolute;left:280.063000px;bottom:390.362000px;width:11.000000px;height:12.276000px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf148" data-dest-detail='[328,"Fit"]'><div class="d m1" style="border-style:none;position:absolute;left:127.637000px;bottom:467.814000px;width:17.018000px;height:8.509000px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div></div>
</div>
<div class="loading-indicator">

</div>
</body>
</html>
